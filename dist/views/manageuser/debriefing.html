<div class="centre_align_boxes2 courses">

    <div class="home_upper">
          <div class="back-box" ui-sref="dashboard.my_account({reload: true})">
              <i class="fa fa-arrow-circle-left"></i> BACK
            </div>
          <div class="welcome_title">
            <h2>DEBRIEFING</h2> 
            <h4 class="capitalise">
              Debrief {{ vm.student.first_name }} {{ vm.student.last_name }}
            </h4>
          </div>
    </div>
 
    <!-- Lesson switch overlay -->
    <div class="lesson-switch-overlay" ng-if="vm.show_lesson_switcher" ng-click="vm.cancel_debrief_lesson_change()">
      <div class="lesson-switch-modal" ng-click="$event.stopPropagation()">
        <div class="lesson-switch-modal-header">
          <h3>Switch Lesson</h3>
          <i class="fa fa-times lesson-switch-close" ng-click="vm.cancel_debrief_lesson_change()"></i>
        </div>
        <div class="lesson-switch-modal-body">
          <div class="form-group">
            <label>Select a different lesson</label>
            <ui-select ng-model="vm.pending_debrief_lesson_obj" theme="bootstrap" style="width: 100%;" title="Lesson" append-to-body="true">
              <ui-select-match placeholder="Search for a lesson...">
                Lesson {{ vm.pending_debrief_lesson_obj.organise }}: {{ vm.pending_debrief_lesson_obj.title }}
              </ui-select-match>
              <ui-select-choices repeat="lesson in vm.all_lessons | propsFilterA: {title: $select.search, organise: $select.search}">
                <div ng-bind-html="('Lesson ' + lesson.organise + ': ' + lesson.title) | highlight: $select.search"></div>
              </ui-select-choices>
            </ui-select>
          </div>
          <p style="color: #d9534f; margin: 10px 0;"><i class="fa fa-exclamation-triangle"></i> Changing the lesson will clear any details entered below.</p>
        </div>
        <div class="lesson-switch-modal-footer">
          <button class="btn btn-primary" ng-click="vm.confirm_debrief_lesson_change()" ng-disabled="!vm.pending_debrief_lesson_obj">Confirm</button>
          <button class="btn btn-default" ng-click="vm.cancel_debrief_lesson_change()">Cancel</button>
        </div>
      </div>
    </div>

    <div class="club_docs_all" ng-if="vm.show_whole_lesson">
        <h2 style="display: flex; align-items: center;">Lesson {{ vm.lesson.organise }}: {{ vm.lesson.title }} <i class="fas fa-exchange-alt pointer" style="font-size: 0.7em; color: #f0ad4e; margin-left: auto; padding: 6px 8px; background: rgba(240,173,78,0.15); border-radius: 6px; transition: background 0.2s;" uib-tooltip="Taught a different lesson?" tooltip-placement="left" ng-click="vm.show_lesson_switcher = true"></i></h2>

       
        <div class="course_intro">
          <label for="aim">Aim</label>
          {{ vm.lesson.aim }}
        </div>
         <div class="course_intro">
          <label for="course_reference">Course Reference</label>
          {{ vm.lesson.course_reference }}
        </div>
         <div class="course_intro">
          <label for="description">Description</label>
          {{ vm.lesson.description }}
        </div>


      </div>


      <!-- ═══════════════════════════════════════════ -->
      <!-- LESSON CONTENT FILES VIEWER (Images / PDFs) -->
      <!-- ═══════════════════════════════════════════ -->
      <div class="club_docs_all lcf-viewer-section" ng-if="vm.show_whole_lesson && vm.hasContentFiles()">

        <div class="lcf-viewer-loading" ng-if="vm.contentFilesLoading">
          <i class="fa fa-spinner fa-spin"></i> Loading lesson content&hellip;
        </div>

        <div class="lcf-viewer-container" ng-if="!vm.contentFilesLoading">

          <div class="lcf-viewer-main">
            <div class="lcf-viewer-placeholder" ng-if="!vm.activeContentFile">
              <i class="fa fa-images"></i>
              <p>Select a file below to view</p>
            </div>

            <div class="lcf-viewer-image-wrap" ng-if="vm.activeContentFile && vm.activeContentFile.file_type !== 'pdf' && vm.activeContentFile.mime_type !== 'application/pdf'">
              <img ng-src="{{ vm.activeContentFile.data_uri }}" alt="{{ vm.activeContentFile.original_name }}" class="lcf-viewer-image" />
            </div>

            <div class="lcf-viewer-pdf-wrap" ng-if="vm.activeContentFile && (vm.activeContentFile.file_type === 'pdf' || vm.activeContentFile.mime_type === 'application/pdf')">
              <object ng-attr-data="{{ vm.activeContentFile.data_uri }}" type="application/pdf" class="lcf-viewer-pdf">
                <p>Your browser does not support inline PDF viewing. <a ng-href="{{ vm.activeContentFile.data_uri }}" target="_blank">Open PDF</a></p>
              </object>
            </div>

            <div class="lcf-viewer-file-loading" ng-if="vm.activeContentFile && vm.activeContentFile._loading">
              <i class="fa fa-spinner fa-spin"></i> Loading&hellip;
            </div>

            <div class="lcf-viewer-file-error" ng-if="vm.activeContentFile && vm.activeContentFile._loadError">
              <i class="fa fa-exclamation-triangle"></i> Could not load this file.
            </div>
          </div>

          <div class="lcf-viewer-thumbnails" ng-if="vm.contentFiles.length > 1">
            <div class="lcf-viewer-thumb"
                 ng-repeat="file in vm.contentFiles"
                 ng-class="{'lcf-viewer-thumb-active': vm.activeContentFile.id === file.id}"
                 ng-click="vm.selectContentFile(file)">

              <img ng-if="file.data_uri && file.file_type !== 'pdf' && file.mime_type !== 'application/pdf'"
                   ng-src="{{ file.data_uri }}" alt="{{ file.original_name }}" />

              <div class="lcf-thumb-pdf-icon" ng-if="file.file_type === 'pdf' || file.mime_type === 'application/pdf'">
                <i class="fa fa-file-pdf"></i>
              </div>

              <div class="lcf-thumb-loading" ng-if="file._loading">
                <i class="fa fa-spinner fa-spin"></i>
              </div>

              <div class="lcf-thumb-error" ng-if="file._loadError">
                <i class="fa fa-exclamation-triangle"></i>
              </div>

              <span class="lcf-thumb-label">{{ file.original_name }}</span>
            </div>
          </div>

        </div>
      </div>


      <!-- ═══════════════════════════════════════════ -->
      <!-- TRADITIONAL LESSON SECTIONS (hidden if empty) -->
      <!-- ═══════════════════════════════════════════ -->

       <div class="club_docs_all" ng-if="vm.show_whole_lesson && vm.hasSectionContent('tem')">
        <h2 uib-tooltip="Threat and Error Management">TEM</h2>

            <div class="card" ng-if="vm.lesson.tem.length > 0">
                <table>
                    <tr>
                        <th>Threat / Error</th>
                        <th>Consequence</th>
                        <th>Mitigation</th>
                    </tr>
                      <tr ng-repeat="tem in vm.lesson.tem">
                        <td>
                          <span ng-if="!tem.edit_me">{{ tem.threat }}</span> 
                          <input ng-if="tem.edit_me" type="text" class="form-control inputtext" name="title" id="title" ng-model="tem.threat" />
                        </td>
                        <td>
                          <span ng-if="!tem.edit_me">{{ tem.consequence }}</span> 
                          <input ng-if="tem.edit_me" type="text" class="form-control inputtext" name="consequence" id="consequence" ng-model="tem.consequence" />
                        </td>
                        <td>
                          <span ng-if="!tem.edit_me">{{ tem.mitigation }}</span> 
                          <input ng-if="tem.edit_me" type="text" class="form-control inputtext" name="mitigation" id="mitigation" ng-model="tem.mitigation" />
                        </td>
                    </tr>
                     
                </table>

            </div>

      </div>


      <div class="club_docs_all" ng-if="vm.show_whole_lesson && vm.hasSectionContent('preflight')">
        <h2>Pre-Flight</h2>

            <div class="card" ng-if="vm.lesson.bullets.preflight.length > 0">
                <table class="lesson_display">
                   
                      <tr ng-repeat="preflight in vm.lesson.bullets.preflight">
                          <td>
                            <span ng-if="!preflight.edit_me" class='{{ (preflight.bullet_format == "0") ? "bullet" : "heading" }}'>{{ preflight.title }}</span> 
                            <input ng-if="preflight.edit_me" type="text" class="form-control inputtext" name="title" id="title" ng-model="preflight.title" />
                          </td>
                         
                      </tr>
                     
                    
                </table>

            </div>

             

      </div>


      <div class="club_docs_all" ng-if="vm.show_whole_lesson && vm.hasSectionContent('airex')">
        <h2>Air Exercises</h2>

            <div class="card" ng-if="vm.lesson.bullets.airex.length > 0">
                <table class="lesson_display">

                      <tr ng-repeat="airex in vm.lesson.bullets.airex">
                          <td>
                            <span ng-if="!airex.edit_me" ng-if="!airex.edit_me" class='{{ (airex.bullet_format == "0") ? "bullet" : "heading" }}'>{{ airex.title }}</span> 
                            <input ng-if="airex.edit_me" type="text" class="form-control inputtext" name="title" id="title" ng-model="airex.title" />
                          </td>
                           
                      </tr>
                      

                </table>

            </div>

          

      </div>


     <div class="club_docs_all" ng-if="vm.hasSectionContent('debrief')">
        <h2>DEBRIEF</h2>

            <div class="card" ng-if="vm.lesson.bullets.debrief.length > 0">
                <table class="lesson_display">

                      <tr ng-repeat="debrief in vm.lesson.bullets.debrief">
                          <td>
                            <span class='{{ (debrief.bullet_format == "0") ? "bullet" : "heading" }}'>{{ debrief.title }}</span> 
                          </td>
                           
                      </tr>
                      

                </table>

            </div>

      </div>

       <div class="club_docs_all">
        <h2>Student Progress</h2>
          
            <div class="card centre_me" ng-if="vm.lesson.items.length == 0 && !vm.show_all_lessons">
             There are no student progress tasks for this lesson
            </div>

            <div class="card">
                <input type="button" class="btn btn-primary btn_centre_card" ng-click="vm.show_whole_course()" value="{{ (vm.show_all_lessons) ? 'SHOW THIS LESSON ONLY': 'SHOW WHOLE COURSE ITEMS'}}" />
                <input type="search" placeholder="Search Student Progress" ng-model="vm.my_search2" ng-change="vm.set_updated_search()" class="form-control searchbar smaller_search" uib-tooltip="Using the search function will automatically search the whole course, and not just the lesson already shown, to return to show only this lesson, remove any searched items" />
            </div>

            <div class="card" ng-if="vm.lesson.items.length > 0 || vm.show_all_lessons">
                <table class="competence-table competence-table-highlight-all" >
                    <thead>
                        <tr>
                            <th>Key Learning Objective</th>
                            <th class="competences_header competence_same_width" ng-repeat="competence in vm.competences">
                                {{ competence.title }}
                            </th>
                            <th class="competences_header">
                                Remarks
                            </th>

                        </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat="item in vm.all_items | propsFilterA: {title: vm.my_search, lesson_id: vm.my_search }">
                          <td class="competence_title">
                            <!-- uib-tooltip="{{ item.description }}" -->
<!--                             <span uib-popover="{{ item.description }}" popover-trigger="mouseenter" popover-placement="right" >{{ item.title }}</span> 
 -->                            <span uib-tooltip="{{ item.description }}" tooltip-placement="right" >{{ item.title }}</span> 

                          </td>
                          <td class="competences_marking competence_same_width" ng-repeat="competence in vm.competences">
                                
                                <input class="form-control" type="radio" name="{{ item.id }}" value="{{competence.id}}" ng-model="item.result" />

                          </td>
                          <td class="competences_marking remarks">
                            <textarea class="form-control inputtext" ng-model="item.remarks"></textarea>
                          </td>

                        
                      </tr>
                    </tbody>
                </table>

            </div>

           

      </div>
     <div class="club_docs_all">
        <h2>General Remarks</h2>
        <div class="card centre_me">
            <textarea class="form-control inputtext gen_remarks" ng-model="vm.general_remarks" uib-tooltip="Type any general remarks that may be useful or required to be kept in the student records."></textarea>
        </div>

    </div>


<div class="bookingout_wrapper no_padding">

    <div class="club_docs_all">
        <h2>Lesson Tagging</h2>
      <div class="center_if_large2 left_al">

            <!-- <div class="form-group">
              <label for="card-number">This flight included times that need to coun</label>
              <div class="check_box_in_form">
                <input type="checkbox" class="form-control inputtext" ng-model="vm.lesson_completed">
              </div>
            </div> -->

            <div class="form-group">
                <div class="card centre_me" ng-if="vm.selected_flight_tags.length == 0">
                  There are no tags for this lesson (yet)
                </div>

            <div class="card" ng-if="vm.selected_flight_tags.length > 0">
                <table>
                    <tr>
                        <th>Tag name</th>
                        <th>Tag Logged Time</th>
                        <th>Functions</th>
                    </tr>
                      <tr ng-repeat="tag in vm.selected_flight_tags">
                        <td>
                          <span>{{ tag.title | myToUpperCase }}</span> 
                        </td>
                        <td>
                          <span>{{ tag.logging_time }} [mins]</span> 
                        </td>
                        <td>
                          <a ng-click="vm.delete_tag(tag, $index)" uib-tooltip="Delete"><i class="fa fa-trash-alt list_icons"></i></a>
                        </td>
                    </tr>
                     
                </table>
            </div>

            <div class="form-group">
                <label for="instructor">Add Flight Tag</label>
                <ui-select ng-model="vm.flight_tag" theme="bootstrap" ng-disabled="disabled" title="Please select the flight tag for this flight" append-to-body="true" ng-change="vm.update_flight_tag()">
                    <ui-select-match placeholder="Please select the flight tag for this flight">
                       {{ vm.flight_tag.title | myToUpperCase }} 
                    </ui-select-match>
                    <ui-select-choices repeat="tag in vm.all_tags | propsFilterA: {title: $select.search, id: $select.search}">
                      <!-- {{ tag.title }} --> 
                      <div ng-bind-html="tag.title | myToUpperCase | highlight: $select.search"></div>
                    </ui-select-choices>
                </ui-select>

                <div class="form-group" ng-if="vm.flight_tag">
                  <label for="card-number">This tag is for full flight time</label>
                  <div class="check_box_in_form">
                    <input type="checkbox" class="form-control inputtext" ng-model="vm.tag_full_flight" ng-change="vm.update_flight_full_flight()">
                  </div>
                </div>

                <div class="form-group" ng-if="vm.flight_tag && !vm.tag_full_flight">
                  <label for="card-number">{{ vm.flight_tag.title }} Tag Flight Time:</label>
                  <div class="check_box_in_form">
                    <input type="number" class="form-control inputtext" step="5" ng-keyup="vm.tag_time_to_five()" ng-model="vm.tag_flight_time">
                  </div>
                </div>



            </div>
            <div class="form-group">
                 <input type="button" class="btn btn-primary btn_centre_card" ng-click="vm.add_tag()" value="ADD FLIGHT TAG" />
            </div>
        </div>

    </div>
</div>


<div class="bookingout_wrapper no_padding">

    <div class="club_docs_all">
        <h2>Lesson Status</h2>
      <div class="center_if_large2 left_al">

            <div class="form-group">
              <label for="card-number">This lesson was completed</label>
              <div class="check_box_in_form">
                <input type="checkbox" class="form-control inputtext" ng-model="vm.lesson_completed">
              </div>
            </div>

            <div class="form-group" ng-if="vm.lesson_completed">
            <label for="instructor">Select Next Lesson</label>
            <ui-select ng-model="vm.next_lesson" theme="bootstrap" ng-disabled="disabled" title="Please select the next lesson" append-to-body="true">
                <ui-select-match placeholder="Please select the next lesson">
                  Lesson {{ vm.next_lesson.organise }} - {{ vm.next_lesson.title }}
                </ui-select-match>
                <ui-select-choices repeat="lesson in vm.all_lessons | propsFilterA: {title: $select.search, organise: $select.search, id: $select.search}">
                  Lesson {{ lesson.organise }} 
                  <div ng-bind-html="lesson.title | highlight: $select.search"></div>
                </ui-select-choices>
            </ui-select>

            </div>

        </div>

    </div>
</div>

   <div class="club_docs">
           <!--  {{ vm.show_split }} -->
            <input type="button" class="btn btn-primary btn_centre_card" ng-click="vm.save_progress()" value="SAVE PROGRESS" />

        </div>
</div>



<!-- BELOW IS THE APPROVAL OF BOOKINGS - DOES NOT BELOW HERE -->




<!-- 
<div ng-if="vm.bookings.length == 0">
    <h5>You have no new bookings to approve...</h5>
</div>
       

<div ng-if="vm.bookings.length > 0">
    <h5>Bookings To Approve</h5>
    <table>
        <tr>
            <td>
                BOOKING DETAILS
            </td>
            <td>
                OPTIONS
            </td>
        </tr>
        <tr ng-repeat="booking in vm.bookings">
            <td>
                {{ booking.registration }} - {{ booking.plane_type }}
                <br />
                {{ booking.start | asDate | date:"dd/MM/yyyy HH:mm"}} to {{ booking.end | asDate | date:"dd/MM/yyyy HH:mm" : "UTC" }}
                <br />
                With {{ booking.first_name }} {{ booking.last_name }}
                <br />
                Contact: {{ booking.phone_number }} | {{ booking.email }}
            </td>
            <td>
                <input type="button" class="btn btn-primary" ng-click="approve_booking(booking.id)" value="APPROVE" />
                <input type="button" class="btn btn-danger" ng-click="decline_booking(booking.id)" value="DECLINE" />
                <input type="button" class="btn btn-warning" ng-click="view_booking(booking.id, booking.start)" value="VIEW" />
            </td>
        </tr>
    </table>
</div> -->