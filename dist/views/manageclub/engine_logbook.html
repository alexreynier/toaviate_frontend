<div class="centre_align_boxes2">


    <div class="home_upper">
       <!--  <div class="back-box" ui-sref="dashboard.my_account">
          <i class="fa fa-arrow-circle-left"></i> BACK
        </div> -->
        
        <div class="welcome_title">
          <h2>{{ vm.aircraft.registration }} ENGINE {{ vm.multiple }} LOGBOOK</h2> 
          <h4 class="capitalise">
            See your engine logbook
          </h4>
        </div>
    </div>

                 
</div>
<div class="sub_section2 superwide">

    <div class="logbook-hero-grid">

        <div class="logbook-hero-card">
            <div class="logbook-hero-card__header">
                <i class="fa fa-cog logbook-hero-card__icon"></i>
                <h4>Engine Details</h4>
            </div>
            <div class="logbook-hero-card__body">
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Manufacturer</span>
                    <span class="logbook-hero-value">{{ vm.engine.make }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Model</span>
                    <span class="logbook-hero-value">{{ vm.engine.model }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Serial No.</span>
                    <span class="logbook-hero-value">{{ vm.engine.serial_no }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">TBO Hours</span>
                    <span class="logbook-hero-value logbook-hero-value--bold">{{ vm.engine.tbo_hours }}</span>
                </div>
            </div>
        </div>

        <div class="logbook-hero-card">
            <div class="logbook-hero-card__header">
                <i class="fa fa-clock logbook-hero-card__icon"></i>
                <h4>Engine Stats</h4>
            </div>
            <div class="logbook-hero-card__body">
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Hours Remaining</span>
                    <span class="logbook-hero-value logbook-hero-value--highlight">{{ vm.engine.hours_remaining | number:2 }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Total Hours</span>
                    <span class="logbook-hero-value logbook-hero-value--highlight">{{ vm.engine.total_hours | number:2 }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Hours STEO</span>
                    <span class="logbook-hero-value">{{ vm.engine.steo_hours | number:2 }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Overhaul Date</span>
                    <span class="logbook-hero-value">{{ vm.engine.tbo_date | asDate | date:"dd MMM yyyy" }}</span>
                </div>
            </div>
        </div>

        <div class="logbook-hero-card">
            <div class="logbook-hero-card__header">
                <i class="fa fa-wrench logbook-hero-card__icon"></i>
                <h4>Engine Fitting</h4>
            </div>
            <div class="logbook-hero-card__body">
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Date Fitted</span>
                    <span class="logbook-hero-value">{{ vm.engine.date_fitted | asDate | date:"dd MMM yyyy" }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">Hours at Fit</span>
                    <span class="logbook-hero-value">{{ vm.engine.total_hours_at_start | number:2 }}</span>
                </div>
                <div class="logbook-hero-row">
                    <span class="logbook-hero-label">STEO at Fit</span>
                    <span class="logbook-hero-value">{{ vm.engine.steo_hours_at_start | number:2 }}</span>
                </div>
            </div>
        </div>

    </div>

    <div class="logbook-hero-actions">
        <button class="btn btn-danger view_journey_logs" ng-click="vm.update_logbooks()">FORCE RECHECK LOGBOOK</button>
    </div>


    <div class="search_bar2">

        <input type="search" placeholder="Search Engine Logs" ng-model="my_search2" class="form-control fifty_wide centre_me searching_logs" />

    </div>

                  <div class="card">

                    <div class="plane_docs_none centre_me" ng-if="vm.logs.length < 1">
                        There are presently no engine log entries for this aircraft.
                    </div>



                    <div class="" ng-if="vm.logs.length > 0">
                        <table class="logbook-table">
                            <tr>
                                <td class="bold_text">
                                    Date
                                </td>
                                <td class="bold_text centre_me">
                                    Type
                                </td>
                                <td class="bold_text centre_me">
                                    Flights
                                </td>
                                <td class="bold_text centre_me">
                                    Cycles
                                </td>
                                 <td class="bold_text centre_me">
                                    Hours Flown
                                </td>
                                <td class="bold_text centre_me">
                                    Total Time
                                </td>
                                 <td class="bold_text centre_me">
                                    Total STEO
                                </td>
                                <td class="bold_text centre_me">
                                    Hours to Check
                                </td>
                                <td class="bold_text centre_me">
                                    Details
                                </td>
                                
                            </tr>
                            <tr ng-repeat="log in vm.logs | filter: search2" vertical-align="middle"
                                ng-class="{'maintenance-row': vm.isMaintenanceEntry(log), 'flight-row': !vm.isMaintenanceEntry(log)}"
                                ng-click="vm.isMaintenanceEntry(log) && vm.viewMaintenanceCheck(log)"
                                data-entry-position="{{ vm.getEntryPosition(log) }}">
                            
                                 <td class="log_no_break">
                                    {{ log.entry_date | asDate | date:"dd MMM yyyy" }}
                                </td>

                                <!-- Type column -->
                                <td class="centre_me">
                                    <span ng-if="!vm.isMaintenanceEntry(log)">Flight</span>
                                    <span ng-if="vm.isMaintenanceEntry(log)" class="maintenance-type-badge">
                                        &#x1f527; {{ vm.formatMaintenanceType(log.maintenance_check.maintenance_type) }}
                                    </span>
                                </td>

                                <!-- Flights column -->
                                <td class="centre_me">
                                    <span ng-if="!vm.isMaintenanceEntry(log)">{{ log.flights }}</span>
                                    <span ng-if="vm.isMaintenanceEntry(log)">-</span>
                                </td>

                                <!-- Cycles column -->
                                <td class="centre_me">
                                    <span ng-if="!vm.isMaintenanceEntry(log)">{{ log.cycles }}</span>
                                    <span ng-if="vm.isMaintenanceEntry(log)">-</span>
                                </td>

                                <!-- Hours Flown column -->
                                <td class="centre_me">
                                    <span ng-if="!vm.isMaintenanceEntry(log)" uib-tooltip="{{ get_hours_from_decimal(log.hours_flown) }} HH:mm">{{ log.hours_flown | number:2 }}</span>
                                    <span ng-if="vm.isMaintenanceEntry(log)">-</span>
                                </td>

                                <!-- Total Time column -->
                                <td class="centre_me">
                                    <span uib-tooltip="{{ get_hours_from_decimal(log.total_hours) }} HH:mm">{{ log.total_hours | number:2 }}</span>
                                </td>

                                <!-- STEO column -->
                                <td class="centre_me">
                                    <span ng-if="!vm.isMaintenanceEntry(log)">{{ log.steo_hours | number:2 }}</span>
                                    <span ng-if="vm.isMaintenanceEntry(log)">{{ log.steo_hours | number:2 }}</span>
                                </td>

                                <!-- Hours Remaining to Next Check -->
                                <td class="centre_me" ng-class="vm.getHoursRemainingClass(log.hours_remaining_to_next_check)">
                                    <span uib-tooltip="{{ get_hours_from_decimal(log.hours_remaining_to_next_check) }} HH:mm">{{ vm.formatHoursRemaining(log.hours_remaining_to_next_check) }}</span>
                                </td>

                                <!-- Details column -->
                                <td class="centre_me">
                                    <span ng-if="!vm.isMaintenanceEntry(log)">
                                        {{ log.created_at | asDate | date:"dd MMM yyyy" }}
                                    </span>
                                    <span ng-if="vm.isMaintenanceEntry(log)">
                                        <span ng-if="log.maintenance_check.description">{{ log.maintenance_check.description }}</span>
                                        <br ng-if="log.maintenance_check.first_name" />
                                        <small ng-if="log.maintenance_check.first_name">By: {{ log.maintenance_check.first_name }} {{ log.maintenance_check.last_name }}</small>
                                        <br ng-if="log.maintenance_check.linked_workpack_number" />
                                        <small ng-if="log.maintenance_check.linked_workpack_number">WP: {{ log.maintenance_check.linked_workpack_number }} ({{ log.maintenance_check.linked_workpack_status }})</small>
                                    </span>
                                </td>
                               

                            </tr>
                        </table>

                        <button class="btn btn-primary view_journey_logs" ng-if="!vm.all_loaded" ng-click="vm.load_more()">LOAD MORE</button>  
                        <p class="centre_me" ng-if="vm.all_loaded">You have loaded all the engine logs...</p>

                    </div>



                </div>


    <!-- ═══ Maintenance Check Detail — slide-in right panel ═══ -->
    <div class="wp-overlay-backdrop" ng-class="{'active': vm.show_check_detail}" ng-click="vm.closeMaintenanceCheck()"></div>
    <div class="wp-overlay-panel" ng-class="{'open': vm.show_check_detail}">
      <div class="wp-panel-inner" ng-if="vm.selected_check">

        <!-- Header -->
        <div class="wp-panel-header">
          <div class="wp-panel-header-left">
            <span class="wp-panel-badge wp-status-open">
              <i class="fa" ng-class="vm.getCheckTypeIcon(vm.selected_check.maintenance_check.maintenance_type)"></i>
              {{ vm.formatMaintenanceType(vm.selected_check.maintenance_check.maintenance_type) }}
            </span>
            <h2 class="wp-panel-title">Maintenance Check Details</h2>
            <p class="wp-panel-subtitle">{{ vm.engine.make }} {{ vm.engine.model }} &middot; {{ vm.selected_check.entry_date | asDate | date:'dd MMM yyyy' }}</p>
          </div>
          <button class="wp-panel-close" ng-click="vm.closeMaintenanceCheck()" title="Close">
            <i class="fa fa-times"></i>
          </button>
        </div>

        <!-- Scrollable Body -->
        <div class="wp-panel-body">

          <!-- Check Details -->
          <div class="wp-section">
            <h3 class="wp-section-title"><i class="fa fa-wrench"></i> Check Details</h3>
            <div class="wp-info-grid">
              <div class="wp-info-item">
                <span class="wp-info-label">Maintenance Type</span>
                <span class="wp-info-value">{{ vm.formatMaintenanceType(vm.selected_check.maintenance_check.maintenance_type) }}</span>
              </div>
              <div class="wp-info-item">
                <span class="wp-info-label">Check Date</span>
                <span class="wp-info-value">{{ vm.selected_check.entry_date | asDate | date:'dd MMM yyyy' }}</span>
              </div>
              <div class="wp-info-item" ng-if="vm.selected_check.maintenance_check.hours_remaining !== undefined">
                <span class="wp-info-label">Hours Remaining</span>
                <span class="wp-info-value">{{ vm.formatHoursRemaining(vm.selected_check.maintenance_check.hours_remaining) }}</span>
              </div>
              <div class="wp-info-item" ng-if="vm.selected_check.maintenance_check.expiry_date">
                <span class="wp-info-label">Next Due</span>
                <span class="wp-info-value">{{ vm.selected_check.maintenance_check.expiry_date | asDate | date:'dd MMM yyyy' }}</span>
              </div>
            </div>
          </div>

          <!-- Description -->
          <div class="wp-section" ng-if="vm.selected_check.maintenance_check.description">
            <h3 class="wp-section-title"><i class="fa fa-file-text-o"></i> Description</h3>
            <p style="font-size: 14px; color: #1a2a3a; line-height: 1.6; margin: 0;">{{ vm.selected_check.maintenance_check.description }}</p>
          </div>

          <!-- Personnel -->
          <div class="wp-section" ng-if="vm.selected_check.maintenance_check.first_name || vm.selected_check.maintenance_check.checked_by">
            <h3 class="wp-section-title"><i class="fa fa-user"></i> Personnel</h3>
            <div class="wp-info-grid">
              <div class="wp-info-item" ng-if="vm.selected_check.maintenance_check.checked_by">
                <span class="wp-info-label">Checked By</span>
                <span class="wp-info-value">{{ vm.selected_check.maintenance_check.checked_by }}</span>
              </div>
              <div class="wp-info-item" ng-if="vm.selected_check.maintenance_check.first_name">
                <span class="wp-info-label">Recorded By</span>
                <span class="wp-info-value">{{ vm.selected_check.maintenance_check.first_name }} {{ vm.selected_check.maintenance_check.last_name }}</span>
              </div>
            </div>
          </div>

          <!-- Event Summary -->
          <div class="wp-section">
            <h3 class="wp-section-title"><i class="fa fa-info-circle"></i> Event Summary</h3>
            <div class="wp-info-grid">
              <div class="wp-info-item">
                <span class="wp-info-label">Type</span>
                <span class="wp-info-value">{{ vm.formatMaintenanceType(vm.selected_check.maintenance_check.maintenance_type) }}</span>
              </div>
              <div class="wp-info-item">
                <span class="wp-info-label">Check Date</span>
                <span class="wp-info-value">{{ vm.selected_check.maintenance_check.check_date | asDate | date:'dd/MM/yyyy' }}</span>
              </div>
              <div class="wp-info-item">
                <span class="wp-info-label">Next Due</span>
                <span class="wp-info-value">{{ (vm.selected_check.maintenance_check.expiry_date | asDate | date:'dd/MM/yyyy') || '—' }}</span>
              </div>
              <div class="wp-info-item">
                <span class="wp-info-label">Hours Remaining</span>
                <span class="wp-info-value">{{ vm.selected_check.maintenance_check.hours_remaining || '—' }}</span>
              </div>
              <div class="wp-info-item">
                <span class="wp-info-label">Total Hours at Check</span>
                <span class="wp-info-value">{{ vm.selected_check.total_hours | number:2 }}</span>
              </div>
              <div class="wp-info-item">
                <span class="wp-info-label">Hours to Next Check</span>
                <span class="wp-info-value" ng-class="vm.getHoursRemainingClass(vm.selected_check.hours_remaining_to_next_check)">{{ vm.formatHoursRemaining(vm.selected_check.hours_remaining_to_next_check) }}</span>
              </div>
            </div>
          </div>

          <!-- Logbook Associations -->
          <div class="wp-section">
            <h3 class="wp-section-title"><i class="fa fa-book"></i> Logbook Associations</h3>

            <div ng-if="vm.check_logbook_loading" class="lb-loading">
              <i class="fa fa-spinner fa-spin"></i> Loading logbook associations...
            </div>

            <div ng-if="vm.check_logbook_error" class="lb-error">
              <i class="fa fa-exclamation-triangle"></i> Unable to load logbook associations.
              <a href ng-click="vm.loadCheckLogbookLinks(vm.selected_check.maintenance_check.id)">Retry</a>
            </div>

            <div ng-if="!vm.check_logbook_loading && !vm.check_logbook_error && vm.check_logbook_links.length === 0">
              <p class="wp-empty-text">Loading associations...</p>
            </div>

            <div class="lb-checkbox-list" ng-if="vm.check_logbook_links.length > 0">
              <div class="lb-checkbox-item" ng-repeat="link in vm.check_logbook_links" ng-if="link.isLinked" style="cursor: default;">
                <div class="lb-checkbox-info">
                  <i class="fa" ng-class="vm.getLogbookIcon(link.logbook_type)"></i>
                  <span class="lb-checkbox-label">{{ link.label || (link.logbook_type | uppercase) }}</span>
                  <span class="lb-checkbox-position" ng-if="link.position">#{{ link.position }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Linked Workpack -->
          <div class="wp-section" ng-if="vm.selected_check.maintenance_check.linked_workpack_number || vm.selected_check.maintenance_check.linked_workpack_id || vm.selected_check.maintenance_check.workpack_id || vm.selected_check.maintenance_check.maintenance_type === 'workpack' || vm.check_workpack">
            <h3 class="wp-section-title"><i class="fa fa-briefcase"></i> Linked Workpack</h3>

            <div ng-if="vm.check_workpack_loading" class="lb-loading">
              <i class="fa fa-spinner fa-spin"></i> Loading workpack...
            </div>

            <!-- Summary from log data (always show) -->
            <div class="wp-info-grid">
              <div class="wp-info-item" ng-if="vm.selected_check.maintenance_check.linked_workpack_number">
                <span class="wp-info-label">Workpack Number</span>
                <span class="wp-info-value">{{ vm.selected_check.maintenance_check.linked_workpack_number }}</span>
              </div>
              <div class="wp-info-item" ng-if="vm.selected_check.maintenance_check.linked_workpack_status">
                <span class="wp-info-label">Status</span>
                <span class="wp-info-value">
                  <span class="wp-status-chip" ng-class="{'wp-chip-open': vm.selected_check.maintenance_check.linked_workpack_status === 'open', 'wp-chip-resolved': vm.selected_check.maintenance_check.linked_workpack_status === 'completed'}">
                    {{ vm.selected_check.maintenance_check.linked_workpack_status }}
                  </span>
                </span>
              </div>
            </div>

            <!-- Full workpack details (loaded from API) -->
            <div ng-if="vm.check_workpack" style="margin-top: 14px;">
              <div class="wp-info-grid">
                <div class="wp-info-item" ng-if="vm.check_workpack.description">
                  <span class="wp-info-label">Description</span>
                  <span class="wp-info-value">{{ vm.check_workpack.description }}</span>
                </div>
                <div class="wp-info-item" ng-if="vm.check_workpack.authorised_signatory">
                  <span class="wp-info-label">Authorised Signatory</span>
                  <span class="wp-info-value">{{ vm.check_workpack.authorised_signatory }}</span>
                </div>
                <div class="wp-info-item" ng-if="vm.check_workpack.first_name">
                  <span class="wp-info-label">Created By</span>
                  <span class="wp-info-value">{{ vm.check_workpack.first_name }} {{ vm.check_workpack.last_name }}</span>
                </div>
                <div class="wp-info-item" ng-if="vm.check_workpack.created_at">
                  <span class="wp-info-label">Created</span>
                  <span class="wp-info-value">{{ vm.check_workpack.created_at | myDateTime }}</span>
                </div>
                <div class="wp-info-item" ng-if="vm.check_workpack.completed_at">
                  <span class="wp-info-label">Completed</span>
                  <span class="wp-info-value">{{ vm.check_workpack.completed_at | myDateTime }}</span>
                </div>
              </div>

              <!-- Workpack document -->
              <div ng-if="vm.check_workpack.document" class="wp-document-row" style="margin-top: 12px;">
                <div class="wp-document-info">
                  <i class="fa fa-file-pdf-o wp-doc-icon"></i>
                  <span>{{ vm.check_workpack.document_original_name || vm.check_workpack.document }}</span>
                </div>
                <div class="wp-document-actions">
                  <button class="wp-btn wp-btn-primary" ng-click="vm.downloadWorkpackDocument(vm.check_workpack.document)">
                    <i class="fa fa-download"></i> Download
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>


</div>