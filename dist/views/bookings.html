


         <div class="form-group" ng-if="vm.hide_dropdown">
                <label for="change_club">Change Club</label>
                <br />
                <ui-select ng-model="vm.change_club" theme="bootstrap" ng-change="update_club()" ng-disabled="disabled" style="min-width: 500px;" title="Which club would you like to book for?" append-to-body="true" required>

                  <ui-select-match placeholder="Which club would you like to book for?">
                    {{ vm.change_club.title }}
                  </ui-select-match>
                  <ui-select-choices repeat="club in vm.clubs | propsFilter: {title: $select.search, id: $select.search}">
                    <div ng-bind-html="club.title | highlight: $select.search"></div>
                     <small>
                        <span ng-bind-html="club.address | highlight: $select.search"></span>
                    </small>
                  </ui-select-choices>
                </ui-select>             
            </div>








<script>

    var all_resources, all_events, calView, number_of_resources;
    var init_failsafe = 0;

      var calView = $('#calendar').fullCalendar('getView');

        function collapseLocations() {
            for (x = 0; x < calView.rowHierarchy.children.length; x++) {
                thisRow = calView.rowHierarchy.children[x];
                if (thisRow.groupValue != 'Resource A') {
                    thisRow.collapse();
                }
            }
        }
    
        //below is the update of the field...
        angular.element(document.getElementById('calendar')).scope().$watch('vm.default_date', function(newValue, oldValue) {
            //console.log("DATE CHANGE", newValue);

        
        //
        
        date = newValue;
        //console.log("now", newValue);

        $("#calendar").fullCalendar("gotoDate", newValue);

        // setTimeout(function(){
        //         collapseLocations();
        // }, 100);

    }, true);


    $(function() { // document ready

        all_resources = angular.element(document.getElementById('calendar')).scope().all_resources;
        all_events = angular.element(document.getElementById('calendar')).scope().all_events;

        $('#calendar').fullCalendar({
            theme: true,
            timezone: 'UTC',
            now: new Date(),
            editable: true, // enable draggable events
            aspectRatio: 1.5,
            scrollTime: '07:00', // undo default 6am scrollTime
            header: {
                left: 'today prev,next',
                center: 'title',
                right: 'timelineDay,timelineThreeDays,timelineSevenDays,month'
            },
            defaultView: 'timelineDay',
            views: {
                timelineThreeDays: {
                    type: 'timeline',
                    duration: { days: 3 },
                    timeFormat: "HH:mm",
                    dateFormat: "DD mm YYYY",
                    headerFormats: "HH:mm",
                    slotLabelFormat: ["dddd D MMMM YYYY", "HH:mm"], 
                    eventOrder: ["order","title"]
                },
                timelineSevenDays: {
                    type: 'timeline',
                    duration: { days: 7 },
                    timeFormat: "H:mm",
                    slotLabelFormat: ["dddd D MMMM YYYY", "HH:mm"]
                }
            },
            firstDay: 1,
            resourceOrder: 'rOrder',
            resourceLabelText: 'Planes',
            height: 800,
            resourceColumns: [
                {
                    labelText: 'Registration',
                    field: 'title'
                },
                {
                    labelText: 'Type',
                    field: 'plane_type'
                }
            ]
            ,
            resourceRender: function(resourceObj, labelTds, bodyTds) {
              //  labelTds.css('background', 'blue');
              
             // console.log("RSOBJ", resourceObj);

              if(resourceObj.waiting == 1){
                  //console.log("RESOURCE OBJ", resourceObj.waiting);
                  labelTds.addClass("waiting_list");
                  bodyTds.addClass("waiting_list");
              }
            },
            resources: function(callback) {
                        var one = angular.element(document.getElementById('calendar')).scope().all_resources;
                        if(one){
                            callback(one);
                        } else {
                            angular.element(document.getElementById('calendar')).scope().$watch('all_resources', function(newValue, oldValue) {
                                // console.log("RESOURCES", newValue);
                                $('#calendar').fullCalendar('removeEventSources');
                                //angular.element(document.getElementById('calendar')).scope().all_resources

                                if(newValue){
                                    all_resources = newValue;
                                    number_of_resources = (newValue.length * 65) + 75;
                                    console.log("NEW VAL: ", number_of_resources);

                                    
                                    $("#calendar").fullCalendar('option', 'height', number_of_resources);


                                    all_events = angular.element(document.getElementById('calendar')).scope().all_events;
                                    console.log("now", newValue);
                                    callback(newValue);
                                }

                                
                            }, true);
                        }

                        
             },
            events: function(start, end, timezone, callback) {
                console.log("EVENT CHANGE");
                // setTimeout(function(){
                //     console.log("start", start);
                //     console.log("end", end);
                //     var events = angular.element(document.getElementById('calendar')).scope().updateEvents(moment(start).format("Y-M-D"), (end) ? moment(end).format("Y-M-D") : "");
                //     callback(events);
                // }, 1000);
            },
             dayClick: function(date, jsEvent, view, resourceObj) {

                var now = new Date().getTime();
                // alert(now);
                var click = new Date(date.format()).getTime();
                //alert(click);

                if(click < now){
                    alert('You cannot create a new booking in the past - please choose a booking start time in the future.');
                } else {

                    // I think we can throw this into Angular to check the rest - ie: attempt to create a booking? 

                    // options here relate to ---->

                    //if there is a booking within an hour of the start time of the booking within this particular resource (aircraft) - if more than 30mins, then give error but prompt to confirm booking

                    //if there isn't a booking then open up the booking form with the start date-time pre-filled -- this is done to ensure that the user is required to fill out all the required parts of the booking to prep the book-out.

                    angular.element(document.getElementById('calendar')).scope().addOne(click, resourceObj.id);



                }


                // alert('Date: ' + date.format());
                // alert('Resource ID: ' + resourceObj.id);

              },
            eventSources: all_events,
            timeFormat: 'HH:mm',
            titleFormat: 'D MMM YYYY',
            dateFormat: "DD mm YYYY",
            headerFormats: "HH:mm",
            slotDuration: '00:30', 
            eventOverlap: false,
            nowIndicator: true,
            businessHours: {
                dow: [0,1,2,3,4,5,6],
                start: '07:00',
                end: '21:00'
            },
            eventClick: function(calEvent, jsEvent, view){
                angular.element(document.getElementById('calendar')).scope().alertOnClicked(calEvent, jsEvent, view);
            },
            eventResize: function(event, delta, revertFunc, jsEvent, ui, view ) {
                angular.element(document.getElementById('calendar')).scope().alertOnResize(event, delta, revertFunc, jsEvent, ui, view);
            },
            eventDrop: function(event, delta, revertFunc, jsEvent, ui, view){
                angular.element(document.getElementById('calendar')).scope().alertOnDrop(event, delta, revertFunc, jsEvent, ui, view);
            },
            eventAfterAllRender: function(view){
                calView = view;
                collapseLocations();
            },
            viewRender: function(){
                
                //alert('The new title of the view is ' + view);
                if(init_failsafe > 0){

                    var view = $('#calendar').fullCalendar('getView');
                    // console.log("VIEW IS : ", view.start);
                    // console.log("VIEW IS : ", view.end);
                    // console.log("VIEW NAME : ", view.name);

                    // console.log("UPDATE CONTENT");
                    setTimeout(function(){
                            //console.log("start", view.start);
                            //console.log("end", end);
                            //
                            var events = angular.element(document.getElementById('calendar')).scope().updateEvents(moment(view.start).format("Y-M-D"), (view.end) ? moment(view.end).format("Y-M-D") : "");
                            //callback(events);
                        }, 1000);
                    // angular.element(document.getElementById('calendar')).scope().all_resources;
                } else {
                    init_failsafe++;
                }


            }

            //$scope.alertOnResize = function(event, delta, revertFunc, jsEvent, ui, view )        
            //$scope.alertOnDrop = function(event, delta, revertFunc, jsEvent, ui, view)
        });
        
        
        angular.element(document.getElementById('calendar')).scope().$watch('all_events', function(newValue, oldValue) {
            // console.log("UPDATED", angular.element(document.getElementById('calendar')).scope().all_events);
            all_events = newValue;
            $('#calendar').fullCalendar('removeEvents');
            $('#calendar').fullCalendar('removeEventSources');
            $('#calendar').fullCalendar('addEventSource', all_events);
        }, true);


          
            // setTimeout(function(){
            //     collapseLocations();
            // }, 500);






    });

</script>

<style>

    body {
        margin: 0;
        padding: 0;
        font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
        font-size: 14px;
    }

    #calendar {
/*        max-width: 900px;
*/        
/*    margin: 50px auto;
*/    }

</style>


<div id="booking_wrapper" class="clearfix">
    <ui-view id="mini_view_left" templateUrl="views/bookings/make_booking.html">
        <button class="btn btn-primary" ng-click="addOne()">MAKE BOOKING</button>
     </ui-view>


    <div id="calendar_wrapper">

            <label for="bookingDate"> GO TO DATE:</label>

            <p class="input-group">
                <input type="text" id="bookingDate" class="form-control" uib-datepicker-popup="{{format}}" ng-model="vm.default_date" is-open="popup2.opened" datepicker-options="vm.datepickerOptions"  close-text="Close" ng-click="open2()" />
                <span class="input-group-btn">
                    <button type="button" class="btn btn-default" ng-click="open2()"><i class="glyphicon glyphicon-calendar"></i></button>
                </span>
            </p>


        <div id='calendar'></div>
    </div>

</div>

<!-- public bits //-->
<div class="overlay_information" ng-if="vm.see_booking.visible">




<div class="popup_bg" ng-if="vm.see_booking.visible" ng-click="close_details()">
    <div class="popup_box" ng-click="null">

    <h3 class="popup_title">Booking</h3>

    <table>
        <tr>
            <td>
                <span>Booked By:</span>
            </td>
            <td>
                {{ vm.see_booking.title }}
            </td>
        </tr>
        <tr>
            <td>
                <span>Plane:</span>
            </td>
            <td>
                {{ vm.see_booking.plane.registration }}
            </td>
        </tr>
        <tr>
            <td>
                <span>From:</span>
            </td>
            <td>
               {{ vm.see_booking.start_datetime | date:"dd/MM/yyyy HH:mm" : "UTC"}}
            </td>
        </tr>
        <tr>
            <td>
                <span>to:</span>
            </td>
            <td>
                {{ vm.see_booking.end_datetime | date:'dd/MM/yyyy HH:mm' : "UTC" }}
            </td>
        </tr>
        <tr ng-if="vm.see_booking.instructor && vm.see_booking.instructor.id > 0">
            <td>
                <span>Instructor:</span>
            </td>
            <td>
                {{ vm.see_booking.instructor.display_name }}
            </td>
        </tr>
        <tr ng-if="vm.see_booking.instructor && vm.see_booking.instructor.id > 0">
            <td>
                <span>Tuition:</span>
            </td>
            <td>
                {{ vm.see_booking.tuition_required.title }}
            </td>
        </tr>
       <!--  <tr>
            <td>
                <span>Free places:</span>
            </td>
            <td>
                {{ vm.see_booking.free_seats }}
            </td>
        </tr> -->
        <tr>
            <td>
                <span>Notes:</span>
            </td>
            <td>
                {{ vm.see_booking.description }}
            </td>
        </tr>
        <tr class="sub_table" ng-if="vm.see_booking.editable && !vm.see_booking.can_be_edited && vm.see_booking.passengers.length > 0">
            <td>
                <span>Passengers:</span>
            </td>
            <td class="sub_table2">
                <table>
                    <tr class="table_header">
                        <td>
                            Passenger
                        </td>
                        <td>
                            Status
                        </td>               
                    </tr>
                    <tr ng-repeat="pax in vm.see_booking.passengers">
                        <td>{{ pax.first_name }} {{ pax.last_name }}<br />{{ pax.email }}</td>
                        <td>{{ pax.status }}</td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr ng-if="vm.see_booking.editable && !vm.see_booking.can_be_edited && vm.see_booking.rental_items.length > 0">
            <td>
                <span>Additional Items:</span>
            </td>
            <td>
                <table>
                    <tr class="table_header">
                        <td>
                            Name
                        </td>
                        <td>
                            Description
                        </td>
                        <td>
                            Number of Items
                        </td>
                        <td>
                            Expiry
                        </td>
                       
                    </tr>
                    <tr ng-repeat="item in vm.see_booking.rental_items">
                        <td>{{ item.title }}</td>
                        <td>{{ item.description }}</td>
                        <td>
                            {{item.number_to_book}}
                           <!--  <select class="form-control" ng-model="vm.new_booking.rental_items[$index].number_to_book" ng-init="vm.new_booking.rental_items[$index].number_to_book = 1" ng-options="n for n in [] | range:1:(item.number_available - item.bookings)"></select> -->
                         </td>
                        <td>{{ item.expiry }}</td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="bottom_btn_popup">
            <td colspan="2" >
                  <div class="bottom_btn_popup_btns" ng-if="vm.see_booking.editable && !vm.see_booking.can_be_edited">
                    <button class="btn btn-primary" ng-click="close_details()" >Close</button>
                    <button class="btn btn-danger" ng-click="cancel_booking(vm.see_booking.id)" >Cancel Booking</button>
                    <button class="btn btn-primary" ui-sref="dashboard.bookings.edit({booking_id: vm.see_booking.id})">Edit Booking</button>
                </div>
            </td>
        </tr>
    </table>

     
 <!--    <br />
    <span>Plane:</span> 
    <br />
    <span>From:</span> 
    <br />
    <span>To:</span> 
    <br />
    <span>Instructor:</span> {{ vm.see_booking.instructor.display_name }}
    <br />
    <span>Tuition:</span> {{ vm.see_booking.tuition_required.title }}
    <br />
    <span>Free places:</span> {{ vm.see_booking.free_seats }}
    <br />
    <span>Notes:</span> {{ vm.see_booking.description }}
    <br /> -->
  <!--   <div ng-if="vm.see_booking.editable && !vm.see_booking.can_be_edited && vm.see_booking.passengers.length > 0">

        <span>Passengers:</span>
        <table>
            <tr class="table_header">
                <td>
                    Passenger
                </td>
                <td>
                    Status
                </td>               
            </tr>
            <tr ng-repeat="pax in vm.see_booking.passengers">
                <td>{{ pax.first_name }} {{ pax.last_name }}<br />{{ pax.email }}</td>
                <td>{{ pax.status }}</td>
            </tr>
        </table>

    </div>

    <br /> -->

   <!--  <div ng-if="vm.see_booking.editable && !vm.see_booking.can_be_edited && vm.see_booking.rental_items.length > 0">

        <span>Additional Items:</span>
        <table>
            <tr class="table_header">
                <td>
                    Name
                </td>
                <td>
                    Description
                </td>
                <td>
                    Number of Items
                </td>
                <td>
                    Expiry
                </td>
               
            </tr>
            <tr ng-repeat="item in vm.see_booking.rental_items">
                <td>{{ item.title }}</td>
                <td>{{ item.description }}</td>
                <td>
                    {{item.number_to_book}}
                    <select class="form-control" ng-model="vm.new_booking.rental_items[$index].number_to_book" ng-init="vm.new_booking.rental_items[$index].number_to_book = 1" ng-options="n for n in [] | range:1:(item.number_available - item.bookings)"></select> 
                 </td>
                <td>{{ item.expiry }}</td>
            </tr>
        </table>

    </div> -->

  <!--   <div class="bottom_btn" ng-if="vm.see_booking.editable && !vm.see_booking.can_be_edited">
        <button class="btn btn-primary" ng-click="close_details()" >Close</button>
        <button class="btn btn-danger" ng-click="cancel_booking(vm.see_booking.id)" >Cancel Booking</button>
        <button class="btn btn-primary" ui-sref="dashboard.bookings.edit({booking_id: vm.see_booking.id})">Edit Booking</button>
    </div> -->



</div>
</div>
</div>

<!--  ng-if="vm.booking_errors.length > 0" //-->

<div class="popup_bg" ng-if="vm.booking_errors.length > 0"  ng-click="decline_booking_change()">
    <div class="popup_box" ng-repeat="error in vm.booking_errors">

        <h3> Booking Error </h3>
        <br />

        <p>{{ error.message }}</p>

        <div ng-if="error.type == 'rental_items'">
            <span ng-repeat="rental in error.api">
            {{ rental.rental_item_title }} : you requested <b>{{ rental.required_number }}</b> but there is only <b>{{ rental.number_available }}</b> available.</b>
            </span>
        </div>

      

      <div class="bottom_btn">

        <button ng-click="decline_booking_change()" class="btn btn-warning">Cancel Change</button>
        <button ng-if="error.button !== ''" ng-click="override_booking_change(error.override)" class="btn btn-primary" ng-click="">{{error.button}}</button>

    </div>

    </div>
</div>

