"use strict";function asyncGeneratorStep(e,t,n,o,i,r,a){try{var s=e[r](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(o,i)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(t,n){var o=s.apply(e,a);function i(e){asyncGeneratorStep(o,t,n,i,r,"next",e)}function r(e){asyncGeneratorStep(o,t,n,i,r,"throw",e)}i(void 0)})}}function AccountController(e,t,n){this.user=t.globals.currentUser}function AddLicenceController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var k=this;k.licence_images=[],k.licence={images:[],ratings:[]},b.GetLicenceTypes().then(function(e){k.licence_types=e}),b.GetRatings().then(function(e){k.ratings=e;for(var t=0;t<k.ratings.length;t++)if(7==k.ratings[t].id){k.selected_rating=k.ratings[t],s.add_rating();break}}),b.GetAuthority().then(function(e){k.authority=e}),s.add_rating=function(){k.ratings=$.grep(k.ratings,function(e){return e.id!=k.selected_rating.id}),k.licence.ratings.push(k.selected_rating),delete k.selected_rating},s.remove_rating=function(e){k.ratings.push(k.licence.ratings[e]),k.licence.ratings.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(k.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,k.licence_images.push(e[t].file)}},s.save_licence=function(e){return k.licence_images.length<1&&k.licence.images.length<1?($(".drop").focus(),h.warning("Image Required","You must at least have 1 image of your licence!"),!1):k.licence.licence_type?k.licence.state_of_issue?k.licence.ratings.length<1?($("#ratings").focus(),h.warning("Rating Required","You must at least have 1 rating!"),!1):void(k.licence.id||(k.licence.images=k.licence_images,k.licence.licence_id=k.licence.licence_type.id,k.licence.authority_id=k.licence.state_of_issue.id,k.licence.user_id=k.user_id,delete k.licence.licence_type,delete k.licence.state_of_issue,b.Create(k.licence).then(function(e){e.success||h.error("Create Failed","Something went terribly wrong: "+e.message)}))):($("#state_of_issue").focus(),h.warning("State Required","You must select a licence state of issue"),!1):($("#licence_type").focus(),h.warning("Licence Type Required","You must select a licence type"),!1)}}function AircraftJourneyLogsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C){var S=this;function x(e,t,n){t=t.toLowerCase(),n=n.toLowerCase(),e=e.toLowerCase();return 2<e.length&&-1<t.indexOf(e)||2<e.length&&-1<n.indexOf(e)}function O(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}S.clubs=[],S.user=r.globals.currentUser,S.user_id=S.user.id,S.looking_for=l.registration,S.looking_for&&(s.my_search2=S.looking_for),S.defect_severity,S.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],v.GetAircraftJourneyLogs(l.plane_id,0,25).then(function(e){S.logs=e.logs,S.aircraft=e.aircraft}),S.current_offset=0,S.loaded_per_batch=25,S.all_loaded=!1,S.load_more=function(){S.current_offset=S.current_offset+S.loaded_per_batch,v.GetAircraftJourneyLogs(l.plane_id,S.current_offset,S.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return S.logs.push(e)}):S.all_loaded=!0})},S.get_initial=function(e){return e?e.charAt(0):""},S.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},S.round_brake_times=function(e,t,n){},S.round_brake_times_end=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,60*parseInt(i)+parseInt(t)<n&&(60==(r=parseInt(r)+5)?(o[0]++,r="00"):60<r&&(o[0]++,(r-=60)<10&&(r="0"+r)))),o[0]+":"+r}return e}return""},S.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},s.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},S.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return!s.my_search2||""==s.my_search2||(!!function(e,t){if(!(e.length<2)){if(e&&e.length<=3)return-1<t.indexOf(e);var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return 1;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return 1}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return 1}}}(s.my_search2,e.flight_date)||(t=e.first_name,n=e.last_name,o=s.my_search2,i=o.toLowerCase(),n=(n=t+" "+n).toLowerCase(),2<o.length&&-1<n.indexOf(i)||(!!x(s.my_search2,e.departure_airport,e.departure_airport_code)||!!x(s.my_search2,e.destination_airport,e.destination_airport_code))));var t,n,o,i},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},s.downloadDocument=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){O(e,n)}).error(function(e,t){C.error("Download Failed","There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){O(e,n)}).error(function(e,t){C.error("Download Failed","There was an error downloading the selected document(s).")})},S.list_pilots=function(e){var t="",n="",t="PIC: "+S.get_pic(e),n=S.get_put(e);return w.getTrustedHtml("<div>"+(t=t&&""==t?"No PIC set yet!":t)+" "+(n=n&&""!==n?"<br />PUT: "+n:n)+"</div>")},S.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=S.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=S.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=S.get_initial(e.first_name)+". "+e.last_name),t},S.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=S.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=S.get_initial(e.first_name)+". "+e.last_name),t},s.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function AircraftStatusController(e,t,n,o,i,r,a,s,c,l,d,_,u,p,m,f,g,b,h,k,y,v,w){var C=this;function S(e,t){var n,o="application/octet-stream",i=!1,r=(t=t())["x-filename"]||"download.zip",t=t["content-type"]||o;try{_.info("first try");var a=new Blob([e],{type:"application/pdf"}),s=URL.createObjectURL(a);c=s,n="Secure Documents",(l=window.open()).document.write("<html><head><title>"+n+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+c+'" type="application/pdf" internalinstanceid="21"></body></html>'),l.document.close(),i=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!i){var c=window.URL||window.webkitURL||window.mozURL||window.msURL;if(c){var l=document.createElement("a");if("download"in l)try{_.info("second try");var a=new Blob([e],{type:t}),d=c.createObjectURL(a);l.setAttribute("href",d),l.setAttribute("download",r);var u=document.createEvent("MouseEvents");u.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(u),i=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!i)try{_.info("third try");a=new Blob([e],{type:o}),d=c.createObjectURL(a);window.location=d,i=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}return i||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),r}C.clubs=[],C.user=r.globals.currentUser,C.user_id=C.user.id,C.looking_for=l.registration,C.looking_for&&(s.my_search2=C.looking_for),C.defect_severity,C.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],v.GetByUserMaintenance(C.user.id).then(function(e){C.clubs=e.clubs}),C.get_initial=function(e){return e.charAt(0)},C.list_pilots=function(e){var t="",n="",t="PIC: "+C.get_pic(e);return(n=C.get_put(e))&&""!==n&&(n="<br />PUT: "+n),t&&""==t&&(t="No PIC set yet!"),$sce.getTrustedHtml("<div>"+t+" "+n+"</div>")},C.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=C.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=C.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=C.get_initial(e.first_name)+". "+e.last_name),t},C.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=C.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=C.get_initial(e.first_name)+". "+e.last_name),t},C.clean_times=function(e){return e.substring(0,5)},C.add_defect=function(t,n){var e={club_id:n,user_id:C.user_id,plane_id:t,defect:C.defect,severity:C.defect_severity.title,status:"open"};v.AddDefect(e).then(function(e){e.item.can_delete=!0,C.clubs.find(function(e){return e.id===n}).planes.find(function(e){return e.plane_id===t}).defects.push(e.item),C.defect="",C.defect_severity=""})},C.delete_defect=function(e){v.DeleteDefect(e).then(function(e){v.GetOpenIssues(C.bookout.plane_id).then(function(e){C.reported_defects=e})})},s.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},s.count_defects=function(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=0,o=0;o<e.length;o++)(1==t||"open"==e[o].status)&&n++;return n},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},C.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},C.show_receipt_image=function(e){C.show_receipt=!0,C.receipt_image=e.image},C.get_icon3=function(e){var e=e.split(";")[0],t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return-1!==angular.lowercase(e.registration).indexOf(angular.lowercase(s.my_search2)||"")},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},s.downloadDocument=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){S(e,n)}).error(function(e,t){w.error("Download Failed","There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){S(e,n)}).error(function(e,t){w.error("Download Failed","There was an error downloading the selected document(s).")})},C.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},C.round_brake_times_end=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,60*parseInt(i)+parseInt(t)<n&&(60==(r=parseInt(r)+5)?(o[0]++,r="00"):60<r&&(o[0]++,(r-=60)<10&&(r="0"+r)))),o[0]+":"+r}return e}return""},s.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function AllDocumentsController(e,t,n,o,i,r,a,s,c,l,d,_,u,p,m,f,g,b,h,k,y,v){var w=this;function C(e,t){var n,o="application/octet-stream",i=!1,r=(t=t())["x-filename"]||"download.zip",t=t["content-type"]||o;try{var a=new Blob([e],{type:"application/pdf"}),s=URL.createObjectURL(a);c=s,n="Secure Documents",(l=window.open()).document.write("<html><head><title>"+n+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+c+'" type="application/pdf" internalinstanceid="21"></body></html>'),l.document.close(),i=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!i){var c=window.URL||window.webkitURL||window.mozURL||window.msURL;if(c){var l=document.createElement("a");if("download"in l)try{var a=new Blob([e],{type:t}),d=c.createObjectURL(a);l.setAttribute("href",d),l.setAttribute("download",r);var u=document.createEvent("MouseEvents");u.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(u),i=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!i)try{a=new Blob([e],{type:o}),d=c.createObjectURL(a);window.location=d,i=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}return i||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),r}w.clubs=[],w.user=r.globals.currentUser,w.user_id=w.user.id,h.GetByUserId(w.user.id).then(function(e){w.clubs=e.clubs;for(var t=0;t<w.clubs.length;t++)""!==w.clubs[t].membership_terms&&w.clubs[t].documents.push({title:"Membership Terms & Conditions",document:w.clubs[t].membership_terms,updated_at:w.clubs[t].membership_updated}),""!==w.clubs[t].privacy_terms&&w.clubs[t].documents.push({title:"Privacy Terms",document:w.clubs[t].privacy_terms,updated_at:w.clubs[t].privacy_updated}),""!==w.clubs[t].passenger_terms&&w.clubs[t].documents.push({title:"Passenger Terms & Conditions",document:w.clubs[t].passenger_terms,updated_at:w.clubs[t].passenger_updated})}),s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},w.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search3=function(e){return-1!==angular.lowercase(e.membership_name).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return-1!==angular.lowercase(e.registration).indexOf(angular.lowercase(s.my_search2)||"")},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){C(e,n)}).error(function(e,t){v.error("Download Failed","There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){C(e,n)}).error(function(e,t){v.error("Download Failed","There was an error downloading the selected document(s).")})}}function AllInvoicesController(e,n,o,t,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C){var S=this;S.clubs=[],S.user=s.globals.currentUser,S.user_id=S.user.id,S.show_pay_now=!1,S.show_loading=!1,S.last_invoice_opened={};function x(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){p.info("!!saveBlob method failed with the following exception:"),p.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){p.info("Download link method with simulated click failed with the following exception:"),p.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){p.info("Download link method with window.location failed with the following exception:"),p.info(e)}}}return o||(p.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}S.donConfirm=function(e,t){S.complete_invoice(e,t)},S.default_payment="direct-debit",S.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],S.savedCards=[],S.complete_invoice=function(e,t){e={user_id:S.user.id,club_id:S.last_invoice_opened.club_id,paymentIntent:t,invoice_id:S.last_invoice_opened.id,method:e};n.ProcessPayment(e).then(function(e){e.success&&o.GetInvoices(S.user.id).then(function(e){S.invoices=e.invoices,S.show_pay_now=!1,S.show_loading=!1})})},S.close_pay_now=function(){S.show_pay_now=!1,S.show_loading=!1},S.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},S.show_payment_option=function(e){e=e.status;return"pending_submission"==e||"issued"==e},S.info,S.show_payment=function(e){S.last_invoice_opened=e,S.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.id},t.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(S.info=e.info,S.savedCards=e.cards,0<S.savedCards.length?S.methods[1].visible=!0:S.methods[1].visible=!1,S.machine=e.machine,S.machine.success?S.methods[3].visible=!0:S.methods[3].visible=!1,S.show_pay_now=!0)})},S.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(t=1==t?"":"-")+n+":"+e},o.GetInvoices(S.user.id).then(function(e){S.invoices=e.invoices}),o.GetUpcoming(S.user.id).then(function(e){S.upcoming=e.upcoming}),l.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},S.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},l.search=function(e){return-1!==angular.lowercase(e.invoice_number).indexOf(angular.lowercase(l.my_search)||"")||!!e.plane_registration&&-1!==angular.lowercase(e.plane_registration).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(e.club_title).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(parseFloat(e.total).toFixed(2).toString()).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(l.my_search)||"")},l.show_more=function(e){S.invoices[e].show_more=!S.invoices[e].show_more},l.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},l.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");w.get("/api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){x(e,n)}).error(function(e,t){C.error("Download Failed","There was an error downloading the selected document(s).")})},l.downloadInvoice=function(e){w.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){x(e,n)}).error(function(e,t){C.error("Download Failed","There was an error downloading the selected document(s).")})}}function AllPaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v){var w=this;function C(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}w.clubs=[],w.user=r.globals.currentUser,w.user_id=w.user.id,w.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},w.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(1==t?"":"-")+n+":"+e},e.GetPayments(w.user.id).then(function(e){w.payments=e.payments}),e.GetUpcoming(w.user.id).then(function(e){w.upcoming=e.upcoming}),s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},w.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.id.toString()).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.club_title).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.amount.toString()).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(s.my_search)||"")},s.show_more=function(e){w.invoices[e].show_more=!w.invoices[e].show_more},s.get_human_method=function(e){var t;switch(e){case"GoCardless":t="Direct Debit";break;case"Credit":t="Credit";break;case"GoCardless + Credit":t="Direct Debit + Credit";break;case"Equilibrium":t="Not Required "}return t},s.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"toaviate_ready":case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":case"paid":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},s.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("/api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){C(e,n)}).error(function(e,t){v.error("Download Failed","There was an error downloading the selected document(s).")})},s.downloadInvoice=function(e){y.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){C(e,n)}).error(function(e,t){v.error("Download Failed","There was an error downloading the selected document(s).")})}}function ArtpiecesController(e,n,o,t,i,r,a,s,c){var l=this;l.artpiece={},l.artpiece.categories=[],n.GetAll().then(function(e){l.categories=e,""!==a.artpieceId&&o.GetById(a.artpieceId).then(function(e){if(l.artpiece=e,l.artpiece.categories)for(var t=0;t<l.artpiece.categories.length;t++)l.categories=$.grep(l.categories,function(e){return e.id!=l.artpiece.categories[t].category_id})})}),o.GetAll().then(function(e){l.artpieces=e}),s.tempAddCategory=function(e){var t=JSON.parse(e);l.artpiece.categories.push(t),l.categories=$.grep(l.categories,function(e){return e.id!=t.id})},s.tempDeleteCategory=function(t){l.artpiece.categories=$.grep(l.artpiece.categories,function(e){return e.id!=t.id}),l.categories.push(t)},s.AddCategory=function(e){var t=JSON.parse(e);o.AddCategory({category_id:t.id,artpiece_id:l.artpiece.id}).then(function(e){l.artpiece.categories.push(t),l.categories=$.grep(l.categories,function(e){return e.id!=t.id})})},s.DeleteCategory=function(t){o.DeleteCategory({category_id:t.category_id,artpiece_id:l.artpiece.id}).then(function(e){l.artpiece.categories=$.grep(l.artpiece.categories,function(e){return e.id!=t.id}),l.categories.push(t)})},s.addArtpiece=function(){if(!l.artpiece.title||""===l.artpiece.title.trim())return c.highlightField("artpiece_title"),void c.warning("Title Required","Please enter a title for the artpiece.");o.Create(l.artpiece).then(function(e){!1!==e.success?(c.success("Artpiece Created","Your artpiece has been added."),t.path("/artpieces"),l.artpiece={}):c.error("Create Failed",e.message||"Something went wrong.")})},s.editArtpiece=function(){if(!l.artpiece.title||""===l.artpiece.title.trim())return c.highlightField("artpiece_title"),void c.warning("Title Required","Please enter a title for the artpiece.");o.Update(l.artpiece).then(function(e){!1!==e.success?(c.success("Artpiece Updated","Your changes have been saved."),t.path("/artpieces"),l.artpiece={}):c.error("Update Failed",e.message||"Something went wrong.")})},s.deleteArtpiece=function(t){o.Delete(t).then(function(e){l.artpieces=$.grep(l.artpieces,function(e){return e.id!=t})})},s.addCategory=function(){var e={title:l.new_category};n.Create(e).then(function(e){l.cats.push(e),l.new_category=""})},s.deleteCategory=function(t){n.Delete(t).then(function(e){l.cats=$.grep(l.cats,function(e){return e.id!=t})})}}function BookinController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C,S,x,O,D,M,I,P,A,T){var U=this;U.user=s.globals.currentUser,U.user_id=U.user.id,U.club_id=0,U.booking={},U.wgs_n="51.51",U.wgs_e="0.12",U.split_flight=0,U.show_takeoff_landing_times=!1,U.change_booking={},U.show_change_plane=!1,U.bookout={start:!0,passengers:[],pic:{id:U.user_id},plane:{}},U.this_pls_id_raw=0,U.instructors=[],U.pics=[],U.instructor_charges=[],U.club_courses=[],U.can_authorise=!1,U.dateFormat="date:HH:mm 'on' dd/MM/yyyy",U.flight_times_complete=!1,U.calculated_invoice=!1,U.show_loading=!0,U.reported_defects=[],U.scroll=!0,U.previous_invoice,U.defect_severity,U.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],U.claim_a_flight=[],U.claimed_flight={},U.auto_claim=0,U.ignore_next_tuition_change=!1,U.get_currency=function(t){return $.grep(U.currencies,function(e){return e.iso_code==t})[0]},l.get_airfields=function(t){var e;2<t.length&&t.length<5&&v.GetAirfieldsByCode(t).then(function(e){e.success&&(U.airfields=e.airfields,0==U.airfields.length&&(U.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}),4<t.length&&(e=t.replace(/\s/g,"_"),v.GetAirfields(e).then(function(e){e.success&&(U.airfields=e.airfields,0==U.airfields.length&&(U.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}))},U.original_bookout={},l.reset_claim_my_flight=function(){U.bookout=U.original_bookout,U.different_date_warning=!1,U.claimed_flight={},U.calculate_invoice_for_flight(),U.flight_times_complete=!1},U.different_date_warning=!1,U.has_used_claimed_flight=!1;function E(e,n,t){var o=2<arguments.length&&void 0!==t?t:null,i=new Date;if(U.bookout&&U.bookout.brakes_off){var r=new Date(o),t=U.bookout.brakes_off.time.split(":");r.setHours(t[0]),r.setMinutes(t[1]),r.setSeconds(0),(i=new Date(o)).setHours(0),i.setMinutes(0),i.setSeconds(0)}else switch(e){case"today":case"past":case"future":r=new Date("1990-07-26");break;case"after":r=new Date(o),i=new Date(o);break;case"before":r=new Date(o)}U[n].forEach(function(e,t){e=e.time.split(":");i.setHours(e[0]),i.setMinutes(e[1]),i.setSeconds(0),moment(i).isAfter(moment(r))?U[n][t].disabled=0:U[n][t].disabled=1})}U.donConfirm=function(e,t){var n="home";U.user.id===U.bookout.payer_id||U.user.id!=U.bookout.pic_id&&U.user.id!=U.bookout.instructor_id?U.split_flight_confirmation:n="debrief",U.book_in_flight(n,e,t)},U.default_payment="direct-debit",U.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],U.savedCards=[],l.claim_my_flight=function(){var e;if(U.bookout.flight_date!==U.claimed_flight.flight_date&&!1===(0<arguments.length&&void 0!==arguments[0]&&arguments[0]))return T.warning("Date Mismatch","The bookout date and the flight you are claiming do not match - are you absolutely sure that this is your flight?"),!(U.different_date_warning=!0);1==U.this_claim_was_instructional&&U.this_was_instructional_claim(),U.this_pls_id_raw=Object.assign({},U.bookout),U.has_used_claimed_flight=!0,U.bookout.from_airfield=U.claimed_flight.from_airport,U.bookout.to_airfield=U.claimed_flight.to_airport,e=U.claimed_flight.from_airport.id==U.claimed_flight.to_airport.id?2<U.claimed_flight.touch_and_go?U.flight_types.find(function(e){return 3===e.id}):U.flight_types.find(function(e){return 1===e.id}):U.flight_types.find(function(e){return 2===e.id}),U.bookout.flight_type=e,U.bookout.flight_date=U.claimed_flight.flight_date,U.bookout.brakes_off_rounded=U.claimed_flight.brakes_off_rounded,U.bookout.brakes_on_rounded=U.claimed_flight.brakes_on_rounded,U.bookout.brakes_off={time:U.claimed_flight.brakes_off},U.bookout.brakes_on={time:U.claimed_flight.brakes_on},U.bookout.touch_and_go=U.claimed_flight.touch_and_go,U.bookout.landings=U.claimed_flight.full_stop_landings,U.bookout.stops=U.claimed_flight.stops,U.bookout.fox_log_id=U.claimed_flight.fox_log_id,U.bookout.fox_claimed=1,U.bookout.takeoff_time=U.claimed_flight.takeoff_time,U.bookout.landing_time=U.claimed_flight.landing_time,U.bookout.takeoff_rounded=U.claimed_flight.takeoff_rounded,U.bookout.landing_rounded=U.claimed_flight.landing_rounded,U.bookout.claimed_fox_plane_log_sheet_id=U.claimed_flight.id,U.flight_units.brakes_to_brakes=U.claimed_flight.brakes_time,U.flight_units.airborne_times=U.claimed_flight.airborne_time,U.flight_units.flight_time=U.claimed_flight.flight_time,U.flight_units.brakes_times_rounded=U.bookout.brakes_times_rounded,U.calculate_invoice_for_flight(),U.flight_times_complete=!0,"tacho"==U.bookout.plane_charges.charge_type||U.bookout.plane_charges.charge_type},l.update_pic=function(){var e=U.pics.find(function(e){return e.user_id===U.bookout.pic.user_id});U.bookout.pic=e,U.bookout.pic_id=U.bookout.pic.user_id,U.this_claim_was_instructional&&0!=U.this_claim_was_instructional?1==U.bookout.pic.instructor||(U.this_claim_was_instructional=!1,U.bookout.put_id=0,U.bookout.put={},((U.bookout.instructor_id=0)<U.bookout.pic_id||0<U.bookout.user_id)&&(U.bookout.payer_id=U.bookout.pic_id),U.calculate_invoice_for_flight()):D.GetPackagesByUserId(U.bookout.pic_id).then(function(e){U.packages=e.items,C.GetUpdatedCharges(U.bookout.club_id,U.bookout.plane_id,U.bookout.pic_id).then(function(e){U.bookout.plane_charges=e.plane_charges,U.bookout.put_id=0,U.bookout.put={},((U.bookout.instructor_id=0)<U.bookout.pic_id||0<U.bookout.user_id)&&(U.bookout.payer_id=U.bookout.pic_id),U.calculate_invoice_for_flight()})}),U.complete_flight=!1,U.bookout.pic.user_id==U.user.id&&(U.can_authorise=!1),U.bookout.booking&&0!=U.bookout.booking.user_id&&0!=U.bookout.user_id||(U.bookout.user_id=U.bookout.pic.user_id),0==U.bookout.put_id&&0==U.bookout.instructor_id&&(U.bookout.payer_id=U.bookout.pic_id),U.bookout.payer_id,U.complete_flight&&U.complete_this_flight()},l.update_put=function(){if(U.bookout.put.user_id==U.bookout.pic.user_id)return T.warning("Selection Error","Please select a different PIC to the PUT"),!(U.bookout.put={});U.complete_flight=!1;var e=U.pics.find(function(e){return e.user_id===U.bookout.put.user_id});U.bookout.put=e,U.bookout.put_id=e.user_id,0<U.bookout.put_id&&(U.bookout.instructor_id=U.bookout.pic_id,U.bookout.instructor=U.bookout.pic,l.update_pic()),D.GetPackagesByUserId(U.bookout.put_id).then(function(e){U.packages=e.items,C.GetUpdatedCharges(U.bookout.club_id,U.bookout.plane_id,U.bookout.put_id).then(function(e){U.bookout.plane_charges=e.plane_charges,U.calculate_invoice_for_flight()})}),0!==U.bookout.pic_id&&U.bookout.pic_id!==U.bookout.instructor_id?U.bookout.payer_id=U.bookout.pic_id:0<U.bookout.instructor_id&&0<U.bookout.put_id||0<U.bookout.instructor_id&&0<U.bookout.user_id?U.bookout.payer_id=0<U.bookout.put_id?U.bookout.put_id:U.bookout.user_id:0<U.bookout.put_id?U.bookout.payer_id=U.bookout.put_id:0==U.bookout.put_id&&0==U.bookout.user_id?U.bookout.payer_id=U.bookout.pic_id:(0==U.bookout.instructor_id&&(U.bookout.payer_id=U.bookout.pic_id),0==U.bookout.payer_id&&T.warning("Payer Required","Please select a student or person paying for this flight")),U.complete_flight&&U.complete_this_flight()},l.update_instructor=function(){var e=U.instructors.find(function(e){return e.user_id===U.bookout.instructor.user_id});e&&0<e.user_id?(U.bookout.instructor=e,U.bookout.instructor_id=e.user_id,0!==U.bookout.pic_id&&U.bookout.pic_id!==U.bookout.instructor_id?U.bookout.payer_id=U.bookout.pic_id:0<U.bookout.instructor_id&&0<U.bookout.put_id||0<U.bookout.instructor_id&&0<U.bookout.user_id?U.bookout.payer_id=0<U.bookout.put_id?U.bookout.put_id:U.bookout.user_id:0<U.bookout.put_id?U.bookout.payer_id=U.bookout.put_id:0==U.bookout.put_id&&0==U.bookout.user_id?U.bookout.payer_id=U.bookout.pic_id:(0==U.bookout.instructor_id&&(U.bookout.payer_id=U.bookout.pic_id),0==U.bookout.payer_id&&T.warning("Payer Required","Please select a student or person paying for this flight"))):(U.bookout.instructor={},U.bookout.instructor_id=0,U.bookout.payer_id=U.bookout.pic_id),U.complete_flight&&U.complete_this_flight()},U.flight_types=[{id:1,title:"Local"},{id:2,title:"Departure"},{id:3,title:"Circuits"},{id:4,title:"Other"}],U.biggin_hill={routes:[{id:1,title:"Kenley"},{id:2,title:"Sevenoaks"},{id:3,title:"Swanley"},{id:4,title:"Other"}],parking:""},U.flight_rules=[{id:1,title:"VFR"},{id:2,title:"IFR"}],U.split_flight_confirmation=0,U.split_this_flight=function(){U.split_flight=1;var e=U.split_flight_time;e.booking_id=U.bookout.booking_id,e.this_pls_id=U.bookout.id,C.HypotheticalFlightSplit(U.bookout.id,e).then(function(e){U.split_one=e.first_flight,U.split_flight=1,U.split_two=e.second_flight,U.split_two.brakes_off={time:U.split_two.brakes_off},U.split_two.brakes_on={time:U.split_two.brakes_on}})},U.cancel_split=function(){U.bookout=U.original_bookout,U.split_one={},U.split_two={},U.split_flight=0,U.split_flight_confirmation=0,Z(U.bookout)},U.update_split=function(){var e=U.bookout.id;e&&null!=e&&0!=e||(e=U.this_pls_id_raw),U.has_used_claimed_flight&&0<U.claimed_flight.id&&(e=U.claimed_flight.id);var t=U.split_flight_time;t.booking_id=U.bookout.booking_id,t.this_pls_id=U.bookout.id,C.HypotheticalFlightSplit(e,t).then(function(e){U.split_one=e.first_flight,U.split_flight=1,U.split_two=e.second_flight,U.split_two.brakes_off={time:U.split_two.brakes_off},U.split_two.brakes_on={time:U.split_two.brakes_on}})},U.start_times=[],U.all_times=[];for(var B=0;B<24;B++){for(var L=0;L<12;L++)U.start_times.push({time:B+":"+(F=((F=5*L)<10?"0":"")+F),disabled:!1});for(var F,L=0;L<6;L++)U.all_times.push({time:B+":"+(F=((F=10*L)<10?"0":"")+F),disabled:!1})}function G(e,t,n){var o=1<arguments.length&&void 0!==t?t:null,i=2<arguments.length&&void 0!==n?n:0,o=parseInt(o);e=parseInt(e);var r=0;return U.options.business_hours&&(t=U.options.business_hours.from.split(":"),n=U.options.business_hours.to.split(":"),0==i||(n[0]=parseInt(n[0])-1),o||0==o?((e<parseInt(t[0])||e==parseInt(t[0])&&o<parseInt(t[1]))&&(r=1),(e>parseInt(n[0])||e==parseInt(n[0])&&o>parseInt(n[1]))&&(r=1)):(parseInt(t[0])<e&&(r=1),parseInt(n[0])>e&&(r=1))),r}function R(e){var t=moment.duration(e).days(),n=moment.duration(e).hours(),o=moment.duration(e).minutes();59==o&&(n++,o=0);e="";return 0<t&&(e=e+" "+t+" day",e=1<t?e+"s":e),0<n&&(e=e+" "+n+" hour",e=1<n?e+"s":e),0<o&&(e=e+" "+o+" minute",e=1<o?e+"s":e),e}function j(){var o,e;U.bookout.start_date&&U.bookout.start_time&&(o=new Date(U.bookout.start_date),e=U.bookout.start_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),U.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(U.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=R(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?U.end_times[t].disabled=1:U.end_times[t].duration="( "+n+" )"):U.end_times[t].duration=""}),U.show_takeoff_landing_times&&angular.copy(U.end_times,U.takeoff_times))}function Y(e,t){var n=1<arguments.length&&void 0!==t?t:"start",t="today";return moment(moment(e).format("YYYY/MM/DD")).isAfter(moment().format("YYYY/MM/DD"))?(t="future",U.bookout.start_date&&U.bookout.end_date&&"end"==n&&moment(U.bookout.start_date).isSame(moment(U.bookout.end_date))&&(t="after")):t=moment(e).format("YYYY/MM/DD")==moment().format("YYYY/MM/DD")?"start"==n?"today":"after":"past",t}function N(){var e=new Date,t=U.bookout.start_time?U.bookout.start_time.time.split(":"):[e.getHours(),e.getMinutes()],e=new Date(U.bookout.start_date);e.setHours(t[0]),e.setMinutes(t[1]),e.setSeconds(0);var n,o=moment(e).add(1,"hour").format();q()||!U.bookout.end_time?(E(Y(U.bookout.end_date,"end"),"end_times",e),U.end_times.some(function(e,t){if(e.time==moment(o).format("H:mm"))return n=t}),U.bookout.end_time={},U.bookout.end_time=U.end_times[n]):E(Y(U.bookout.end_date,"end"),"end_times",e),U.bookout.end_time&&1==U.bookout.end_time.disabled&&(U.end_times.some(function(e,t){if(e.time==moment(o).format("H:mm"))return n=t}),U.bookout.end_time={},U.bookout.end_time=U.end_times[n]),U.bookout.start_time&&1==U.bookout.start_time.disabled&&(U.start_times.some(function(e,t){if(0==e.disabled)return n=t}),U.bookout.start_time={},U.bookout.start_time=U.start_times[n],j())}function H(){var e,t;moment(U.bookout.start_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")?E("today","start_times"):moment(U.bookout.start_date).isAfter(moment())&&E("future","start_times"),moment(U.bookout.end_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(U.bookout.start_time&&add_hour_to_end(),E(Y(U.bookout.start_date),"end_times")),U.bookout.end_date==U.bookout.start_date&&U.bookout.start_time&&(e=U.bookout.start_time.time.split(":"),(t=new Date(U.bookout.start_date)).setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0),q()?(E(Y(U.bookout.start_date),"start_times"),E(Y(U.bookout.end_date,"end"),"end_times",t),add_hour_to_end()):E(Y(U.bookout.end_date,"end"),"end_times",t))}function q(){var e,t,n,o=!1;return U.bookout.end_time&&(e=new Date(U.bookout.start_date),n=U.bookout.start_time.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date(U.bookout.end_date),n=U.bookout.end_time.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),(moment(e).isAfter(moment(t))||moment(e).isSame(t)||t==e)&&(o=!0)),o}E("future","all_times"),U.currency_days=28,U.dateTimeRangePickerOptions={hour_step:1,minute_step:30,min_date:new Date,business_hours:{from:"09:00",to:"22:30"}},U.dateTimeRangePickerOptions2={hour_step:1,minute_step:5,min_date:new Date,business_hours:{from:"00:00",to:"23:55"}},U.options={hour_step:1,minute_step:5,min_date:new Date,business_hours:{from:"00:00",to:"23:55"}},U.lubricant_type=[{title:"Fuel"},{title:"Oil"}],U.who_paid=[{title:"Me"},{title:"Club"}],U.receipt={image:"",quantity:0,price:0,reimbursement:!1,item:{title:"Fuel"}},l.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,U.receipt_image=e[t].file,U.receipt.image=U.receipt_image.temp_path}},U.update_course=function(){U.bookout.course&&0<U.bookout.course.id?S.GetByCourseId(U.bookout.course.id).then(function(e){U.instructor_charges=e.items,1==U.instructor_charges.length&&(U.bookout.tuition_required=U.instructor_charges[0]),U.ignore_next_tuition_change=!0,U.update_tuition_charges()}):S.GetByClubId(U.bookout.club_id).then(function(e){U.instructor_charges=e.items,1==U.instructor_charges.length&&(U.bookout.tuition_required=U.instructor_charges[0]),U.ignore_next_tuition_change=!0,U.update_tuition_charges()})},U.update_tuition_charges=function(){U.bookout.tuition_required&&0<U.bookout.tuition_required.id?S.GetUpdatedCharges(U.bookout.tuition_required.id).then(function(e){U.bookout.tuition_charges=e.tuition_charges,U.bookout.tuition_required=e.tuition_required,U.bookout.tuition_id=e.tuition_required.id,U.calculate_invoice_for_flight(),U.complete_flight&&U.complete_this_flight(),U.ignore_next_tuition_change=!1}):U.ignore_next_tuition_change||(0<U.bookout.instructor_id&&T.warning("Tuition Required","Please select a tuition type for this flight."),U.ignore_next_tuition_change=!1)},U.delete_receipt=function(e){C.DeleteReceipt(e).then(function(e){C.GetAllSheetReceipts(U.bookout.id).then(function(e){U.lubricant_receipts=e,U.calculate_invoice_for_flight()})})},U.check_reimbursement=function(){if(U.receipt.price<.01||""==U.receipt.currency)return!1;var e={price:U.receipt.price,currency:U.receipt.currency.iso_code,club_id:U.bookout.club_id};C.CheckReimbursement(e).then(function(e){U.receipt.reimbursed_amount=e.reimburse.reimbursed_amount,U.receipt.reimbursed_currency=e.reimburse.reimbursed_currency,U.receipt.reimbursed_rate=e.reimburse.rate,U.receipt.reimbursed_datetime=e.reimburse.datetime})},U.add_receipt=function(){if(U.receipt.reimbursement&&!U.receipt.image)return T.warning("Receipt Required","You must upload a copy of your receipt if you wish to be reimbursed."),!1;var e={plane_id:U.bookout.plane_id,club_id:U.bookout.club_id,user_id:U.user.id,plane_log_sheet_id:U.bookout.id,reimbursement:U.receipt.reimbursement,image:U.receipt.image,currency:U.receipt.currency.iso_code,item:U.receipt.item.title,quantity:U.receipt.quantity,price:U.receipt.price};C.AddReceipt(e).then(function(e){U.lubricant_receipts.push(e.item),U.receipt={image:"",quantity:0,price:0,reimbursement:!1,item:{title:"Fuel"}},U.calculate_invoice_for_flight()})},U.options={},U.start_times=[],U.end_times=[],U.takeoff_times=[],U.landing_times=[],U.calculate_my_brakes_duration=function(){var o,e;U.bookout.start_date&&U.bookout.brakes_off&&(o=new Date(U.bookout.start_date),e=U.bookout.brakes_off.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),U.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(U.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=R(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?U.end_times[t].disabled=1:U.end_times[t].duration="( "+n+" )"):U.end_times[t].duration=""}),U.show_takeoff_landing_times&&angular.copy(U.end_times,U.takeoff_times))},U.calculate_airborne_duration=function(){var o,e;U.bookout.takeoff_time&&(o=new Date(U.bookout.start_date),e=U.bookout.takeoff_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),U.landing_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(U.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=R(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?U.landing_times[t].disabled=1:U.landing_times[t].duration="( "+n+" )"):U.landing_times[t].duration=""}))},U.calculate_after_landing_duration=function(){var o,e;U.show_takeoff_landing_times&&U.bookout.start_date&&U.bookout.landing_time&&(o=new Date(U.bookout.start_date),e=U.bookout.landing_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),U.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(U.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=R(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?U.end_times[t].disabled=1:U.end_times[t].duration="( "+n+" )"):U.end_times[t].duration=""}))},U.flight_units={brakes_to_brakes:0,airborne_times:0,flight_time:0,meter_units:U.bookout.end_tacho-U.bookout.start_tacho},U.cancel_split=function(){U.bookout=U.original_bookout,U.bookout.brakes_off=U.bookout.brakes_off.time,U.bookout.brakes_on=U.bookout.brakes_on.time,U.split_flight_confirmation=0,U.split_flight=0,Z(U.bookout)},U.confirm_split=function(){U.try_split=!0,U.before_split_bookout=U.bookout,U.split_flight_confirmation=1,U.original_bookout=U.bookout,U.split_one.touch_and_go=U.bookout.touch_and_go,U.split_one.tng=U.bookout.tng,U.split_one.full_stop_landings=U.bookout.full_stop_landings,U.split_one.landings=U.bookout.landings,U.split_one.remote_landings=U.bookout.remote_landings,U.split_one.pic=U.bookout.pic,U.split_one.pic_id=U.bookout.pic_id,U.split_one.put=U.bookout.put,U.split_one.put_id=U.bookout.put_id,U.split_one.payer_id=U.bookout.payer_id,U.split_one.instructor=U.bookout.instructor,U.split_one.instructor_id=U.bookout.instructor_id,U.split_one.booking=U.bookout.booking,U.split_one.booking_id=U.bookout.booking_id,U.bookout.course&&U.bookout.course.id&&(U.split_one.course_id=U.bookout.course.id),U.split_one.course=U.bookout.course,U.split_one.tuition_required=U.bookout.tuition_required,U.split_one.authorised_solo=U.bookout.authorised_solo,U.flight_units.brakes_to_brakes=U.split_one.brakes_times,U.flight_units.airborne_times=U.split_one.airborne_time,U.flight_units.flight_time=U.split_one.flight_time,U.flight_units.brakes_times_rounded=U.split_one.brakes_times_rounded,U.bookout=U.split_one,Z(U.bookout)},U.calculate_my_airborne_duration=function(){var e,t,n,o;U.has_used_claimed_flight?(U.flight_units.brakes_to_brakes=U.claimed_flight.brakes_time,U.flight_units.airborne_times=U.claimed_flight.airborne_time,U.flight_units.flight_time=U.claimed_flight.flight_time,U.flight_units.brakes_times_rounded=U.claimed_flight.brakes_times_rounded,U.calculate_invoice_for_flight()):(U.bookout.takeoff_time&&U.bookout.takeoff_time.time&&U.bookout.landing_time&&U.bookout.landing_time.time&&(t=new Date,o=U.bookout.takeoff_time.time.split(":"),t.setHours(o[0]),t.setMinutes(o[1]),t.setSeconds(0),n=new Date,e=U.bookout.landing_time.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),o=moment(moment(n).startOf("minute")).diff(moment(t).startOf("minute")),U.flight_units.airborne_times=moment.duration(o).asHours(),U.calculate_invoice_for_flight()),U.bookout.brakes_off&&""!==U.bookout.brakes_off.time&&U.bookout.brakes_on&&""!==U.bookout.brakes_on.time&&(e=new Date,n=U.bookout.brakes_off.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date,U.bookout.brakes_on&&U.bookout.brakes_on.time&&(n=U.bookout.brakes_on.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),o=moment(moment(t).startOf("minute")).diff(moment(e).startOf("minute")),U.flight_units.brakes_to_brakes=moment.duration(o).asHours(),U.calculate_invoice_for_flight()))),U.flight_times_complete=!0},U.update_dateTime=function(){var e,t,n;U.has_used_claimed_flight?(U.flight_units.brakes_to_brakes=U.claimed_flight.brakes_time,U.flight_units.airborne_times=U.claimed_flight.airborne_time,U.flight_units.flight_time=U.claimed_flight.flight_time,U.calculate_invoice_for_flight()):U.bookout.brakes_off&&U.bookout.brakes_off.time&&U.bookout.brakes_on&&U.bookout.brakes_on.time&&(n=new Date,t=U.bookout.brakes_off.time.split(":"),n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(0),e=new Date,t=U.bookout.brakes_on.time.split(":"),e.setHours(t[0]),e.setMinutes(t[1]),e.setSeconds(0),n=moment(moment(e).startOf("minute")).diff(moment(n).startOf("minute")),U.flight_units.brakes_to_brakes=moment.duration(n).asHours(),U.calculate_invoice_for_flight()),U.flight_times_complete=!0},H(),l.update_dateTime=function(e){switch(e){case"start_time":H(),N(),j();break;case"end_time":N();break;case"edit":H(),E(Y(U.bookout.start_date),"start_times"),N(),j(),setTimeout(function(){pre_select_value_id()},500)}},function(){U.options=U.dateTimeRangePickerOptions2;for(var e=0;e<24;e+=U.options.hour_step)if(U.options.minute_step&&0<U.options.minute_step)for(var t=0;t<60/U.options.minute_step;t++){var n=U.options.minute_step*t;U.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:G(e,n)}),U.end_times.push({time:e+":"+n,disabled:G(e,n),duration:""})}else U.start_times.push({time:e+":00",disabled:G(e)}),U.end_times.push({time:e+":00",disabled:G(e),duration:""});angular.copy(U.start_times,U.takeoff_times),angular.copy(U.end_times,U.landing_times)}(),function(){for(var e=0;e<24;e+=U.options.hour_step)if(U.options.minute_step&&0<U.options.minute_step)for(var t=0;t<60/U.options.minute_step;t++){var n=U.options.minute_step*t;U.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:G(e,n)}),U.end_times.push({time:e+":"+n,disabled:G(e,n),duration:""})}else U.start_times.push({time:e+":00",disabled:G(e)}),U.end_times.push({time:e+":00",disabled:G(e),duration:""});angular.copy(U.start_times,U.takeoff_times),angular.copy(U.end_times,U.landing_times)}(),"add"===d.current.data.action&&k.GetForBookIn(u.id).then(function(t){t.success&&(1==t.bookout.booked_in&&(T.warning("Already Booked","It appears that you have already booked this flight back in."),d.go("dashboard.my_account",{},{reload:!0})),U.original_bookout=t.bookout,U.bookout=t.bookout,U.claim_a_flight=t.unclaimed,U.bookout.start_date=new Date("2100/07/26"),U.bookout.end_date=new Date("2100/07/26"),n.GetAllByPicsBookinout(U.bookout.booking_id,U.bookout.club_id,U.user.id,1).then(function(e){U.pics=e,Z(t.bookout)}),n.GetAllByClubInstructor(U.bookout.club_id,U.user.id).then(function(e){U.instructors=e.instructors}),D.GetPackagesForBookout(U.bookout.id).then(function(e){U.packages=e.packages}),0==U.bookout.payer_id&&(0!==U.bookout.pic_id&&U.bookout.pic_id!==U.bookout.instructor_id?U.bookout.payer_id=U.bookout.pic_id:0<U.bookout.instructor_id&&0<U.bookout.put_id||0<U.bookout.instructor_id&&0<U.bookout.user_id?U.bookout.payer_id=0<U.bookout.put_id?U.bookout.put_id:U.bookout.user_id:0<U.bookout.put_id?U.bookout.payer_id=U.bookout.put_id:0==U.bookout.put_id&&0==U.bookout.user_id?U.bookout.payer_id=U.bookout.pic_id:(0==U.bookout.instructor_id&&(U.bookout.payer_id=U.bookout.pic_id),0==U.bookout.payer_id&&T.warning("Payer Required","Please select a student or person paying for this flight"))))}),U.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},U.this_was_a_supervised_solo=function(){U.this_was_supervised_solo=!U.this_was_supervised_solo,U.this_was_supervised_solo?U.bookout.payer_id=U.bookout.pic_id:0<U.bookout.put_id?U.bookout.payer_id=U.bookout.put_id:0<U.bookout.user_id&&(U.bookout.payer_id=U.bookout.user_id)},U.this_was_instructional_claim=function(){U.this_claim_was_instructional=!U.this_claim_was_instructional,U.complete_flight=!1,U.this_claim_was_instructional?(U.ignore_next_tuition_change=!0,U.bookout.payer_id=U.bookout.put_id,0==U.bookout.instructor_id&&U.bookout.pic&&0<U.bookout.pic.user_id&&(U.bookout.instructor_id=U.bookout.pic.user_id),J()):(U.bookout.put_id=0,U.bookout.put={},(U.bookout.instructor_id=0)<U.bookout.pic_id?U.bookout.payer_id=U.bookout.pic_id:0<U.bookout.user_id&&(U.bookout.payer_id=U.bookout.user_id)),U.calculate_invoice_for_flight()},l.applyFilter=function(e,t){if(t){var n=t.split(":"),o=n[0],t=[e];return 1<n.length?"date"==o.toLowerCase()&&t.push(n.slice(1).join(":")):t=t.concat(n.slice(1)),w(o).apply(this,t)}return e},U.add_defect=function(){var e={club_id:U.bookout.club_id,user_id:U.bookout.user_id,plane_id:U.bookout.plane_id,defect:U.defect,severity:U.defect_severity.title,status:"open"};C.AddDefect(e).then(function(e){e.item.can_delete=!0,U.reported_defects.push(e.item),U.defect="",U.defect_severity=""})},U.delete_defect=function(e){C.DeleteDefect(e).then(function(e){C.GetOpenIssues(U.bookout.plane_id).then(function(e){U.reported_defects=e})})},U.tacho_error_highlight=!1,U.check_tacho_bigger=function(){U.bookout.start_tacho>=U.bookout.end_tacho?(T.warning("Tacho Error","Please check start and end tacho. You cannot end on a smaller tacho."),U.tacho_error_highlight=!0):U.tacho_error_highlight=!1},U.calculate_invoice_for_flight=function(){U.free_flight&&(U.bookout.plane_charges&&(U.bookout.plane_charges.charge_rate_unit=0,U.bookout.plane_charges.surcharge_fee=0,U.bookout.plane_charges.landing_fee=0,U.bookout.plane_charges.touch_and_go_fee=0),U.bookout.tuition_charges&&(U.bookout.tuition_charges.price=0));var e=0;if(U.claimed_flight&&null!==U.claimed_flight?U.bookout.plane_charges.tpc_aircraft_surchages?e=U.bookout.tpc_flight_time:"flight"==U.bookout.plane_charges.charge_type||"airborne"==U.bookout.plane_charges.charge_type?e=U.flight_units.airborne_times:"brakes"==U.bookout.plane_charges.charge_type?(!U.flight_units.brakes_to_brakes||0==U.flight_units.brakes_to_brakes)&&U.bookout.brakes_times&&0<U.bookout.brakes_times?(e=U.bookout.brakes_times,U.flight_units.brakes_to_brakes=U.bookout.brakes_times):e=U.flight_units.brakes_to_brakes:e="brakes_rounded"==U.bookout.plane_charges.charge_type?U.flight_units.brakes_to_brakes:U.bookout.end_tacho-U.bookout.start_tacho:U.bookout.plane_charges.tpc_aircraft_surchages?e=U.bookout.tpc_flight_time:"flight"==U.bookout.plane_charges.charge_type?e=U.flight_units.flight_time:"airborne"==U.bookout.plane_charges.charge_type?e=U.flight_units.airborne_times:"brakes"==U.bookout.plane_charges.charge_type?(!U.flight_units.brakes_to_brakes||0==U.flight_units.brakes_to_brakes)&&U.bookout.brakes_times&&0<U.bookout.brakes_times?(e=U.bookout.brakes_times,U.flight_units.brakes_to_brakes=U.bookout.brakes_times):e=U.flight_units.brakes_to_brakes:e="brakes_rounded"==U.bookout.plane_charges.charge_type?U.flight_units.brakes_times_rounded:U.bookout.end_tacho-U.bookout.start_tacho,(!U.flight_units.brakes_to_brakes||0==U.flight_units.brakes_to_brakes)&&U.bookout.brakes_times&&0<U.bookout.brakes_times&&(U.flight_units.brakes_to_brakes=U.bookout.brakes_times),U.package_removed=[],U.package_used=!1,U.packages&&0<U.packages.length)for(var t=0;t<U.packages.length;t++)if(U.package_used=!0,U.bookout.instructor_id&&0<U.bookout.instructor_id){if(U.packages[t].remaining_hours_dual&&0<U.packages[t].remaining_hours_dual){if(e<U.packages[t].remaining_hours_dual){var n=U.packages[t].remaining_hours_dual-e;U.package_removed.push({solo_dual:"dual",title:U.packages[t].title,member_packages_id:U.packages[t].id,hours_dual_before:U.packages[t].remaining_hours_dual,hours_dual_spent:e,hours_dual_remaining_after:n,hours_solo_remaining_after:U.packages[t].remaining_hours_solo,package_id:U.packages[t].package_id}),e=0;break}U.package_removed.push({solo_dual:"dual",title:U.packages[t].title,member_packages_id:U.packages[t].id,hours_dual_before:U.packages[t].remaining_hours_dual,hours_dual_spent:U.packages[t].remaining_hours_dual,hours_dual_remaining_after:0,hours_solo_remaining_after:U.packages[t].remaining_hours_solo,package_id:U.packages[t].package_id}),e-=U.packages[t].remaining_hours_dual}}else if(U.packages[t].remaining_hours_solo&&0<U.packages[t].remaining_hours_solo){if(e<U.packages[t].remaining_hours_solo){n=U.packages[t].remaining_hours_solo-e;U.package_removed.push({solo_dual:"solo",title:U.packages[t].title,member_packages_id:U.packages[t].id,hours_solo_before:U.packages[t].remaining_hours_solo,hours_solo_spent:e,hours_solo_remaining_after:n,hours_dual_remaining_after:U.packages[t].remaining_hours_dual,package_id:U.packages[t].package_id}),e=0;break}U.package_removed.push({solo_dual:"solo",title:U.packages[t].title,member_packages_id:U.packages[t].id,hours_solo_before:U.packages[t].remaining_hours_solo,hours_solo_spent:U.packages[t].remaining_hours_solo,hours_solo_remaining_after:0,hours_dual_remaining_after:U.packages[t].remaining_hours_dual,package_id:U.packages[t].package_id}),e-=U.packages[t].remaining_hours_solo}var o=U.bookout.plane_charges.charge_rate_unit*e,i=0;"flight"==U.bookout.plane_charges.surcharge_type||"taxi"==U.bookout.plane_charges.surcharge_type?i=1:"none"!==U.bookout.plane_charges.surcharge_type&&(i=e);var r=U.bookout.plane_charges.surcharge_fee*i;U.bookout.landings<0&&(U.bookout.landings=1);var a=0|U.bookout.landings,s=a*U.bookout.plane_charges.landing_fee;U.bookout.tng<0&&(U.bookout.tng=1);var c=0|U.bookout.tng,l=c*U.bookout.plane_charges.touch_and_go_fee,d="none",u=0,_=0,p=0;(!U.packages||0==U.packages.length||0<e)&&0<U.bookout.instructor_id&&0<U.bookout.tuition_id&&U.bookout.tuition_charges&&(d=U.bookout.tuition_charges.charge_type,u=U.bookout.tuition_charges.price,"brakes"==d?(p=U.flight_units.brakes_to_brakes,d="brakes off to brakes on hours"):"brakes_rounded"==d?(p=U.flight_units.brakes_times_rounded,d="rounded brakes off to brakes on hours"):"plane"==d?(p=e,d="plane units"):"session"==d&&(p=1,d="session"),_=p*u);var m=0,f=[];if(U.lubricant_receipts&&0<U.lubricant_receipts.length)for(t=0;t<U.lubricant_receipts.length;t++)1==U.lubricant_receipts[t].reimbursement&&(f.push(U.lubricant_receipts[t]),m=Number.parseFloat(Number.parseFloat(m)+Number.parseFloat(U.lubricant_receipts[t].reimbursed_amount)));var g=o+r+s+l+_-m;U.invoice_totals=U.previous_total+g,U.send.amount=100*U.invoice_totals,U.plane_charges={plane_charge_type:U.bookout.plane_charges.charge_type,plane_unit_price:U.bookout.plane_charges.charge_rate_unit,plane_units:e,plane_total:o,surcharge_charge_type:U.bookout.plane_charges.surcharge_type,surcharge_unit_price:U.bookout.plane_charges.surcharge_fee,surcharge_units:i,surcharge_total:r,landing_units:a,landing_unit_price:U.bookout.plane_charges.landing_fee,landing_total:s,tng_units:c,tng_unit_price:U.bookout.plane_charges.touch_and_go_fee,tng_total:l,tuition_charge_type:d,tuition_unit_price:u,tuition_units:p,tuition_total:_,receipts:f,total:g},U.calculated_invoice=!0},U.instructor_charges=[],U.complete_flight=!1,U.complete_this_flight=function(){if(U.tacho_error_highlight)return T.highlightField("tacho_end"),T.error("Meter Error","You cannot complete a flight where the last meter reading is greater than the start meter reading!"),!1;if(U.this_claim_was_instructional&&(0==U.bookout.instructor_id||0==U.bookout.tuition_id))return T.highlightField("instructor_id"),T.warning("Missing Details","You need to add an instructor and tuition type if this flight was instructional."),!1;if(0<U.bookout.instructor_id&&0==U.bookout.tuition_id)return T.highlightField("tuition_id"),T.warning("Tuition Required","Please select a tuition type for this flight."),!1;if(isNaN(U.invoice_totals))return T.warning("Form Incomplete","Please ensure you have filled in the form above - the current total for this invoice cannot be calculated without this."),!1;var e=(U.bookout.booking&&0<U.bookout.booking.club_id?U.bookout.booking:U.bookout).club_id;(U.bookout.booking&&0<U.bookout.booking.user_id?U.bookout.booking:U.bookout).user_id;n.GetMandate(U.bookout.payer_id,e).then(function(e){e.success&&(U.info=e.info)}),U.cards=[];e={user_id:U.bookout.payer_id,club_id:e,membership_id:1};x.GetMemberCards(e).then(function(e){U.cards=e.cards,U.savedCards=e.cards}),U.complete_flight=!0};function z(e,n,o){var i=0;!function t(){V(e,function(e){i++,e?o(!0):n<=i||U.stop_polling?o(!1):setTimeout(t,1e4)})}()}function V(e,t){v.CheckPayment(e).then(function(e){e.success&&e.status?t(!0):t(!1)})}function W(e,t){var n;"home"==e?d.go("dashboard.my_account",{},{reload:!0}):"debrief"==e?(U.user.id==U.bookout.instructor_id||U.user.id==U.bookout.pic_id&&0<U.bookout.put_id)&&(0<U.bookout.booking_id||0<U.bookout.course_id)?(n=0,n=(U.bookout.booking_id<1?t.split:U.bookout).booking_id,t.split?d.go("dashboard.manage_user.debriefing",{booking_id:n,plane_log_sheet_id:U.bookout.id,split_next_id:t.split.plane_log_sheet_id,split_booking_id:t.split.booking_id},{reload:!0}):d.go("dashboard.manage_user.debriefing",{booking_id:n,plane_log_sheet_id:U.bookout.id,split_next_id:0,split_booking_id:0},{reload:!0})):d.go("dashboard.my_account",{},{reload:!0}):"split"==e?(n=0,n=(U.bookout.booking_id<1?t.split:U.bookout).booking_id,(U.user.id==U.bookout.instructor_id||U.user.id==U.bookout.pic_id&&0<U.bookout.put_id)&&(0<U.bookout.booking_id||0<U.bookout.course_id)?d.go("dashboard.manage_user.debriefing",{booking_id:t.split.booking_id,plane_log_sheet_id:U.bookout.id,split_next_id:t.split.plane_log_sheet_id,split_booking_id:t.split.booking_id},{reload:!0}):d.go("dashboard.my_account.book_in",{id:t.split.plane_log_sheet_id},{reload:!0})):d.go("dashboard.my_account.bookout_with_booking",{booking_id:U.bookout.booking_id},{reload:!0})}function J(){var e;1==U.club_courses.length&&(U.bookout.course_id&&0!=U.bookout.course_id||(U.bookout.course_id=U.club_courses[0].id,U.bookout.course=U.club_courses[0])),0<U.bookout.course_id&&(e=U.club_courses.find(function(e){return e.id===U.bookout.course_id}),U.bookout.course=e),1==U.instructor_charges.length&&(U.bookout.tuition_required=U.instructor_charges[0]),U.update_tuition_charges()}function Z(t){var e;U.bookout.booking_id=t.booking_id,U.bookout.club_id=t.club_id,U.bookout.user_id=t.user_id,U.bookout.plane=t.plane,U.club_id=t.club_id,U.is_split_flight=t.is_split_flight,U.send={club_id:U.bookout.club_id,user_id:U.user.id},C.GetCurrencies(U.club_id).then(function(e){U.currencies=e.currencies,U.club_currency=e.club_currency,U.receipt.currency=$.grep(U.currencies,function(e){return e.iso_code==U.club_currency})[0]}),(-1<U.user.access.instructor.indexOf(U.club_id)||-1<U.user.access.manager.indexOf(U.club_id))&&(U.can_authorise=!0),U.invoices=[],U.previous_total=0,U.free_flight=!1,t.booking&&1==t.booking.maintenance_flight&&(U.free_flight=!0),1==U.is_split_flight&&O.GetAllByBooking(t.booking_id).then(function(t){if(t.success){U.previous_invoice=t.invoices;for(var n=0;n<t.invoices.length;n++)Object.keys(t.invoices[n].flights).forEach(function(e){e=t.invoices[n].flights[e];U.invoices.push(e),U.previous_total=Number.parseFloat(U.previous_total)+Number.parseFloat(e.total)})}}),C.GetOpenIssues(t.plane_id).then(function(e){U.reported_defects=e}),C.GetAllSheetReceipts(U.bookout.id).then(function(e){U.lubricant_receipts=e}),S.GetByClubId(t.club_id).then(function(e){U.instructor_charges=e.items}),(t&&0<t.id||U.try_split)&&(U.pics&&t.pic_id&&(o=U.pics.find(function(e){return e.user_id===t.pic_id}),U.bookout.pic=o),n=U.flight_types.find(function(e){return e.id===t.detail_type_id}),U.bookout.flight_type=n,t.instructor&&""!==t.instructor&&t.instructor.user_id==t.pic_id&&(U.bookout.put=U.bookout.user),U.pics&&t.put_id&&(e=U.pics.find(function(e){return e.user_id===t.put_id}),U.bookout.put=e),U.bookout.authorised_solo=1==t.authorised_solo,U.bookout.from_airfield=t.from_airport,U.bookout.to_airfield=t.to_airport,0<t.course_id?U.bookout.course_id=t.course_id:t.booking&&t.booking.course_id&&0<t.booking.course_id&&(U.bookout.course_id=t.booking.course_id),U.bookout.start_tacho=Number.parseFloat(t.last_tacho),U.start_tacho_orig=t.last_tacho,U.bookout.instructor=t.instructor,o=U.pics.find(function(e){return e.user_id===t.pic_id}),U.bookout.pic=o),t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.wgs_n&&(U.wgs_n=t.plane_details.location.wgs_n,U.wgs_e=t.plane_details.location.wgs_e);var n,o="",o=t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.code?t.plane_details.location.code.slice(0,-1):"EG";v.GetAirfieldsByCode(o).then(function(e){e.success&&(U.airfields=e.airfields)}),t.fox_log_id&&0<t.fox_log_id?(U.auto_claim=1,n=U.bookout.from_airport.id==U.bookout.to_airport.id?2<U.bookout.touch_and_go?U.flight_types.find(function(e){return 3===e.id}):U.flight_types.find(function(e){return 1===e.id}):U.flight_types.find(function(e){return 2===e.id}),U.bookout.flight_type=n,U.bookout.brakes_off={time:U.bookout.brakes_off},U.bookout.brakes_on={time:U.bookout.brakes_on},U.bookout.tng=U.bookout.touch_and_go,U.bookout.landings=U.bookout.full_stop_landings,U.bookout.fox_claimed=1,U.has_used_claimed_flight=!0,U.has_requested_to_change_times=!1,U.claimed_flight&&0<U.claimed_flight.id&&(U.bookout.claimed_fox_plane_log_sheet_id=U.claimed_flight.id),0<U.bookout.fox_log_id&&(U.bookout.claimed_fox_plane_log_sheet_id=U.bookout.fox_log_id),U.flight_units.brakes_to_brakes=U.bookout.brakes_time,U.flight_units.airborne_times=U.bookout.airborne_time,U.flight_units.flight_time=U.bookout.flight_time,U.flight_units.brakes_times_rounded=U.bookout.brakes_times_rounded,U.calculate_invoice_for_flight(),U.flight_times_complete=!0):"airborne"!=U.bookout.plane_charges.charge_type&&"flight"!=U.bookout.plane_charges.charge_type||(U.show_takeoff_landing_times=!0),M.GetCoursesByClubId(t.club_id).then(function(e){U.club_courses=e.items,(0<U.bookout.instructor_id||0<U.bookout.put_id||U.this_was_instructional_claim||U.this_claim_was_instructional||0<U.bookout.course_id)&&J()}),U.scroll&&(U.scroll=!1,P.toTop(),U.show_loading=!1)}U.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},U.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return(t=1==t?"":"-")+n+":"+(e=e.length<2?"0"+e:e)},U.book_in_flight=function(){for(var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"home",e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"none",t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",o=!(U.show_loading=!0),i=0,r=0,a=0;a<U.lubricant_receipts.length;a++)"Fuel"==U.lubricant_receipts[a].item?r=Number.parseFloat(r)+Number.parseFloat(U.lubricant_receipts[a].quantity):i=Number.parseFloat(i)+Number.parseFloat(U.lubricant_receipts[a].quantity);if(parseInt(parseInt(U.bookout.landings)+parseInt(U.bookout.tng)+parseInt(U.bookout.remote_landings))<1){if(!confirm("It looks as though you didn't land, is that correct?"))return!1;o=!0}if(("tacho"==U.bookout.plane_charges.charge_type||"hobbs"==U.bookout.plane_charges.charge_type)&&Number.parseFloat(U.start_tacho_orig)!==Number.parseFloat(U.bookout.start_tacho)){if(!confirm("It looks as though your start meter reading ["+U.bookout.start_tacho+"] is not the same as the previous flight's last meter reading of "+U.start_tacho_orig+" - is that correct?"))return!1;o=!0}var s=0;(0==(s=0<U.bookout.instructor_id&&0<U.bookout.tuition_id?1:s)&&0<U.put_id&&U.pic_id!==U.put_id||0==s&&0<U.put_id)&&(s=1);var c=0,l=0;U.this_was_supervised_solo&&(c=1,U.bookout.instructor&&U.bookout.instructor.user_id?l=U.bookout.instructor.user_id:0<U.bookout.instructor_id&&(l=U.bookout.instructor_id));var d=U.bookout.user_id;d&&0!=d||(d=U.bookout.payer_id);var u=U.bookout.instructor_id;(!u||0==u&&1==s&&0<U.bookout.pic_id)&&(u=U.bookout.pic_id);var _=U.bookout.put_id;0==_&&1==s&&(_=U.bookout.payer_id);var p=U.bookout.pic_id;0==(p=0==p&&0==s?U.bookout.payer_id:p)&&0<U.bookout.payer_id&&0==u&&(p=U.bookout.payer_id);var m=(1==U.bookout.flight_type.id?U.bookout.from_airfield:U.bookout.to_airfield).id,f={method:{},method_name:""},o={user_id:d,club_id:U.bookout.club_id,plane_id:U.bookout.plane_id,instructor_id:u,booking_id:U.bookout.booking_id,payer_id:U.bookout.payer_id,plane_log_sheet:{dual_flight:s,authorised_solo:c,authorised_by:l,tuition_id:U.bookout.tuition_id,course_id:U.bookout.course_id,club_id:U.bookout.club_id,plane_id:U.bookout.plane_id,pic_id:p,put_id:_,user_id:d,payer_id:U.bookout.payer_id,detail_type_id:U.bookout.flight_type.id,from_airport_id:U.bookout.from_airfield.id,to_airport_id:m,tacho_start:U.bookout.start_tacho,tacho_end:U.bookout.end_tacho,brakes_off:U.bookout.brakes_off.time,brakes_on:U.bookout.brakes_on.time,oil_uplift_litres:i,fuel_uplift_litres:r,full_stop_landings:U.bookout.landings,touch_and_go:U.bookout.tng,remote_landings:U.bookout.remote_landings,booked_in:1,original_id:U.this_pls_id_raw.id,booked_in_by:U.user.id},invoice:function(){var e=[];if(U.package_used&&U.package_removed&&0<U.package_removed.length)for(var t=0;t<U.package_removed.length;t++){var n=0<U.package_removed[t].hours_dual_spent?U.package_removed[t].hours_dual_spent:U.package_removed[t].hours_solo_spent;e.push({package_id:U.package_removed[t].package_id,title:"Package: "+U.package_removed[t].title,hours:n,hours_type:U.package_removed[t].solo_dual,member_packages_id:U.packages[t].id,unit_price:0,total:0,organise:0})}e.push({title:"Aircraft "+U.plane_charges.plane_charge_type+" Charge",unit:U.plane_charges.plane_units,unit_price:U.plane_charges.plane_unit_price,total:U.plane_charges.plane_total,organise:0}),0<U.plane_charges.surcharge_total&&e.push({title:"Surcharge per "+U.plane_charges.surcharge_charge_type,unit:U.plane_charges.surcharge_units,unit_price:U.plane_charges.surcharge_unit_price,total:U.plane_charges.surcharge_total,organise:1}),0<U.plane_charges.tuition_total&&e.push({title:"Tuition Charge - "+U.bookout.tuition_required.title,unit:U.plane_charges.tuition_units,unit_price:U.plane_charges.tuition_unit_price,total:U.plane_charges.tuition_total,organise:2}),0<U.plane_charges.landing_total&&e.push({title:"Home Landing",unit:U.plane_charges.landing_units,unit_price:U.plane_charges.landing_unit_price,total:U.plane_charges.landing_total,organise:4}),0<U.plane_charges.tng_total&&e.push({title:"Home Touch and Go",unit:U.plane_charges.tng_units,unit_price:U.plane_charges.tng_unit_price,total:U.plane_charges.tng_total,organise:3});for(t=0;t<U.plane_charges.receipts.length;t++){var o=parseInt(5+t);e.push({title:"Reimbursement - "+U.plane_charges.receipts[t].item,unit:U.plane_charges.receipts[t].quantity,unit_price:U.plane_charges.receipts[t].price/U.plane_charges.receipts[t].quantity,total:-U.plane_charges.receipts[t].price,organise:o})}return e}(),paying_now:U.complete_flight,pay_with:f,free_flight:U.free_flight,paymentIntent:t,flag_flight:o};"new-card"==e||"saved-card"==e?(o.paymentIntent=t,o.method=e,o.pay_with.method=e,o.pay_with.method_name=e):"direct-debit"==e?(o.method=e,o.pay_with.method=e,o.pay_with.method_name=e):"card-machine"==e?(o.paymentIntent=t,o.method=e,o.pay_with.method=e,o.pay_with.method_name=e):"free"==e&&(o.method=e,o.pay_with.method=e,o.pay_with.method_name=e),0==m&&(o.plane_log_sheet.new_to_airport=U.bookout.to_airfield,o.plane_log_sheet.new_to_airport.title=o.plane_log_sheet.new_to_airport.title.replace("NOT LISTED : ","")),0==U.bookout.from_airfield.id&&(o.plane_log_sheet.new_from_airport=U.bookout.from_airfield,o.plane_log_sheet.new_from_airport.title=o.plane_log_sheet.new_from_airport.title.replace("NOT LISTED : ","")),o.plane_log_sheet.fox_log_id=U.bookout.fox_log_id,o.plane_log_sheet.fox_claimed=1,o.plane_log_sheet.takeoff_time=U.bookout.takeoff_time,o.plane_log_sheet.landing_time=U.bookout.landing_time,U.has_used_claimed_flight&&U.claimed_flight&&U.claimed_flight.takeoff_time&&""!==U.claimed_flight.takeoff_time&&(o.plane_log_sheet.takeoff_time=U.claimed_flight.takeoff_time,o.plane_log_sheet.landing_time=U.claimed_flight.landing_time,o.plane_log_sheet.landing_rounded=U.claimed_flight.landing_rounded,o.plane_log_sheet.takeoff_rounded=U.claimed_flight.takeoff_rounded),o.plane_log_sheet.brakes_time=U.flight_units.brakes_to_brakes,o.plane_log_sheet.airborne_time=U.flight_units.airborne_times,o.plane_log_sheet.claimed_fox_plane_log_sheet_id=U.claimed_flight.id,U.split_flight&&U.split_one&&(o.plane_log_sheet.brakes_off_rounded=U.split_one.brakes_off_rounded,o.plane_log_sheet.brakes_on_rounded=U.split_one.brakes_on_rounded,o.plane_log_sheet.takeoff_time=U.split_one.takeoff_time,o.plane_log_sheet.landing_time=U.split_one.landing_time,o.plane_log_sheet.takeoff_rounded=U.split_one.takeoff_rounded,o.plane_log_sheet.landing_rounded=U.split_one.landing_rounded,o.plane_log_sheet.airborne_rounded=U.split_one.airborne_rounded,o.plane_log_sheet.brakes_times_rounded=U.split_one.brakes_times_rounded,o.plane_log_sheet.brakes_time=U.split_one.brakes_time,o.plane_log_sheet.flight_time=U.split_one.flight_time,o.plane_log_sheet.airborne_time=U.split_one.airborne_time,o.plane_log_sheet.flight_time=U.split_one.flight_time),1==U.split_flight&&U.split_two&&""!==U.split_two&&(delete U.split_two.booking,delete U.split_two.passengers,delete U.split_two.from_airport,delete U.split_two.to_airport,delete U.split_two.plane_charges,delete U.split_two.tuition_charges,delete U.split_two.tuition_required,delete U.split_two.pilot_in_command,delete U.split_two.home_airport_id,delete U.split_two.aircraft,delete U.split_two.stops,delete U.split_two.user,delete U.split_two.last_tacho,delete U.split_two.instructor,delete U.split_two.id,0<m&&m!==U.split_two.from_airport_id&&(U.split_two.from_airport_id=m),U.split_two&&U.split_two.brakes_on&&U.split_two.brakes_on.time&&(U.split_two.brakes_on=U.split_two.brakes_on.time),U.split_two&&U.split_two.brakes_off&&U.split_two.brakes_off.time&&(U.split_two.brakes_off=U.split_two.brakes_off.time),U.split_two&&(U.split_two.is_split_flight=1),U.split_two&&o.plane_log_sheet.booking_id&&0<o.plane_log_sheet.booking_id&&(U.split_two.booking_id=o.plane_log_sheet.booking_id),o.plane_log_sheet.split_two=U.split_two,o.plane_log_sheet.is_split_flight=1),U.is_split_flight&&1==U.is_split_flight&&0==U.split_flight&&(o.plane_log_sheet.is_split_complete=1),o&&o.plane_log_sheet&&o.plane_log_sheet.takeoff_time&&o.plane_log_sheet.takeoff_time.time&&""!==o.plane_log_sheet.takeoff_time.time&&(o.plane_log_sheet.takeoff_time=o.plane_log_sheet.takeoff_time.time),o&&o.plane_log_sheet&&o.plane_log_sheet.landing_time&&o.plane_log_sheet.landing_time.time&&""!==o.plane_log_sheet.landing_time.time&&(o.plane_log_sheet.landing_time=o.plane_log_sheet.landing_time.time),v.BookInFlight(U.bookout.id,o).then(function(t){U.after_where_to=n,(U.after_data=t).success?(t.paymentID&&(U.payment_id=t.paymentID,U.paymentID=t.paymentID),"cardmachine"==f.method_name?(U.show_cardmachine=!0,z(t.paymentID,30,function(e){e?(U.stop_polling=!0,U.show_loading=!1,W(n,t)):U.show_loading=!1})):(U.show_loading=!1,U.stop_polling=!0,W(n,t))):"stripe"==f.method_name&&t.card_processor?Stripe(A.getStripeKey()).confirmCardPayment(t.client_secret,{payment_method:t.payment_method,return_url:t.card_url.return_url}).then(function(e){e.error?"payment_intent_authentication_failure"==e.error.code&&(U.show_loading=!1,W(n,t)):"succeeded"===e.paymentIntent.status?v.CheckPayment(t.paymentID).then(function(e){e.success?(U.show_loading=!1,W(n,e)):U.show_loading=!1}):U.show_loading=!1}):t.error?(T.error("Card Machine Error","There was an error connecting to the card machine - please ensure that the card machine is ON and connected to the internet."),U.show_loading=!1,U.show_cardmachine=!0):(T.error("Error","An error occurred: "+t.message),U.show_loading=!1)})},U.close_machine_popup=function(){v.ClearMachine(U.payment_id,U.club_id).then(function(e){e.success,U.show_cardmachine=!1,U.show_after_bookedin=!0})},U.cancel_machine=function(){v.ClearMachine(U.payment_id,U.club_id).then(function(e){e.success?(U.show_cardmachine=!1,U.show_after_bookedin=!0,U.stop_polling=!0):U.show_after_bookedin=!0})},U.close_bookedin=function(){v.ClearMachine(U.payment_id,U.club_id).then(function(e){U.show_cardmachine=!1,U.show_after_bookedin=!1,U.stop_polling=!0,W(U.after_where_to,U.after_data)})},U.reset_card_machine=function(){v.RetryPaymentMachine(U.payment_id,U.club_id).then(function(e){e.success?(T.success("Payment Sent","The card machine should hopefully be displaying the payment now"),U.stop_polling=!1,z(U.payment_id,30,function(e){e?(T.success("Payment Confirmed","Payment confirmed!"),U.stop_polling=!0,W(U.after_where_to,U.after_data)):T.error("Payment Failed","Payment not confirmed - please try again")})):(0==e.success&&"The payment has already been successfully made."==e.message&&(U.stop_polling=!0,W(U.after_where_to,U.after_data)),T.error("Payment Error",e.message))}),U.show_cardmachine=!0},U.this_claim_was_instructional=!1,U.this_was_supervised_solo=!1,U.start_tacho_orig,U.send={},l.popup=[],l.open=function(e,t){l.popup[e]&&1==l.popup[e].opened?(t.preventDefault(),t.stopPropagation()):l.popup[e]={opened:!0}},l.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],l.format=l.formats[0],l.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1}}function Bookings2Controller(n,t,r,e,o,i,a,s,d,c,l,u,_,p,m,f,g,b,h,k,y){var v=this;d.va1="123",v.user=a.globals.currentUser,v.allUsers=[],v.club={},v.page_title="",v.club.member={},v.imported_new_headers=[],v.see_booking={},v.is_current=!1,v.currency_type="",v.currency_days="",v.booking_self=!0,v.times_clean_type="start_times",d.club_timezone="Europe/London",v.club_timezone="Europe/London",v.is_edit_show_all=!1,v.action=c.current.data.action,v.return_to=c.current.data.return_to,v.bookingPanelOpen=!1,v.toggleBookingPanel=function(){v.bookingPanelOpen=!v.bookingPanelOpen},v.bookWithInstructor=function(s){v.see_booking.visible=0;var e=new Date,t=new Date(e);t.setMinutes(0),t.setSeconds(0);e=new Date(t);e.setHours(e.getHours()+1),v.new_booking.start_date=t,v.new_booking.end_date=e,v.new_booking.start_time={time:moment(t).format("HH:mm")},v.new_booking.end_time={time:moment(e).format("HH:mm")},v.new_booking.instructor=s.instructor,v.booking_self=!1,v.show_self_option=!0,d.update_dateTime("edit2");var c=t.toISOString(),l=e.toISOString();b.GetAllPlanes(v.user.id,c,l,0,0).then(function(e){var t=e,n=s.instructor.id,o=[],i=[];t.forEach(function(t){var e=b.GetPlaneInstructors(v.user.id,t.id,c,l,1).then(function(e){e.find(function(e){return parseInt(e.id)===parseInt(n)})&&i.push(t)});o.push(e)});var r=0,a=o.length;o.forEach(function(e){e.finally(function(){++r===a&&(v.planes=0<i.length?i:t,v.instructors=[s.instructor])})})}),v.bookingPanelOpen=!0},v.user_id=v.user.id,v.no_show_cols=["membership_start","membership_id","selected"];var w=new Date,C=Math.floor(8),a=Math.floor(18);new Date(w.getFullYear(),w.getMonth(),w.getDate(),C,0,0),new Date(w.getFullYear(),w.getMonth(),w.getDate(),a,0,0);v.default_date=new Date,v.datepickerOptions={customClass:x,format:"dd/MM/yyyy",showWeeks:!1,startingDay:1},v.dateTimeRangePickerOptions={hour_step:1,minute_step:30,min_date:S,datepicker:{customClass:x,format:"dd/MM/yyyy",showWeeks:!1,minDate:S},business_hours:{from:"09:00",to:"22:30"}},d.whole_day_booking=!1,v.instructor_charges=[],v.cancellation={reasons:["Pilot Unwell","Pilot Unavailable","Weather at home base","Weather at destination","Plane Unavailable","Plane Unserviceable","Plane Returned Too Late by previous booking","Instructor Not Available","Airfield Closed","Airspace Closed","Other - please specify"],notes:""};var S=new Date;S.setMinutes(0),S.setSeconds(0);a=new Date;a.setHours(a.getHours()+2),a.setSeconds(0);(new Date).format("d/M/yyyy");v.start_times=[],v.end_times=[],v.new_booking={start_date:S,end_date:S,free_seats:[],passengers:[],options:v.dateTimeRangePickerOptions},d.toggle=!0,d.whentimechangedata={},d.overridePicker=!0;Date();switch(v.planes=[],function(){for(var e=0;e<24;e+=v.new_booking.options.hour_step)if(v.new_booking.options.minute_step&&0<v.new_booking.options.minute_step)for(var t=0;t<60/v.new_booking.options.minute_step;t++){var n=v.new_booking.options.minute_step*t;n=(n<10?"0":"")+n,v.start_times.push({time:e+":"+n,disabled:L(e,n)}),v.end_times.push({time:e+":"+n,disabled:L(e,n),duration:""})}else v.start_times.push({time:e+":00",disabled:L(e)}),v.end_times.push({time:e+":00",disabled:L(e),duration:""})}(),d.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],d.format=d.formats[0],v.action){case"add":v.page_title="Add a Booking",v.new_booking={start_date:S,end_date:S,free_seats:[],passengers:[],options:v.dateTimeRangePickerOptions},P();break;case"edit":v.page_title="Edit a Booking",v.see_booking.visible=0,v.bookingPanelOpen=!0,v.new_booking={start_date:S,end_date:S,free_seats:[],passengers:[],options:v.dateTimeRangePickerOptions},P(),M(),l.booking_id&&b.GetEdit(v.user.id,l.booking_id).then(function(e){if(e.success){if(v.new_booking=e.booking,(-1<v.user.access.instructor.indexOf(e.booking.club_id)||-1<v.user.access.manager.indexOf(e.booking.club_id))&&(v.show_self_option=!0),e.booking.user_id==v.user.id?v.booking_self=!0:v.booking_self=!1,1==e.booking.maintenance_flight&&(v.new_booking.maintenance_flight=!0),v.new_booking.options=v.dateTimeRangePickerOptions,v.new_booking.edit_booking=1,v.new_booking.start_date=moment(v.new_booking.start).toDate(),v.new_booking.start_time={time:moment(v.new_booking.start).format("HH:mm")},v.new_booking.end_date=moment(v.new_booking.end).toDate(),v.new_booking.end_time={time:moment(v.new_booking.end).format("HH:mm")},v.new_booking.after_booking_end=moment().isAfter(moment(v.new_booking.end)),v.new_booking.instructor&&v.new_booking.instructor.id==v.user_id&&(v.booking_self=!1),d.$parent.vm.default_date=v.new_booking.start_date,setTimeout(function(){d.$parent.vm.see_booking&&(d.$parent.vm.see_booking.visible=1),$("#calendar").fullCalendar("gotoDate",v.new_booking.start_date),setTimeout(function(){var e=parseInt($("a.fc-timeline-event.booking"+l.booking_id).css("left"))+parseInt($("a.fc-timeline-event.booking"+l.booking_id).width())/2-$("tbody .fc-time-area .fc-scroller").width()/2;$("tbody .fc-time-area .fc-scroller").animate({scrollLeft:e},1800)},1e3),d.$apply()},800),B(),d.update_dateTime("edit"),k.GetCoursesByClubId(v.new_booking.club_id).then(function(e){v.courses=e.items,v.new_booking.tuition_required=v.courses.find(function(e,t){if(e.id==v.new_booking.course_id)return!0})}),E(v.new_booking.club_id,v.new_booking.end),v.new_booking.rental_items)for(var t=0;t<v.new_booking.rental_items.length;t++)v.new_booking.rental_items[t].number_to_book=parseInt(v.new_booking.rental_items[t].number_to_book);v.new_booking.free_seats&&(v.new_booking.free_seats=parseInt(v.new_booking.free_seats)),v.new_booking.instructor,0!=v.club_id&&v.club_id||!v.new_booking.plane||!v.new_booking.plane.id||(v.club_id=v.new_booking.plane.club_id),A()}else y.error("Booking Error",e.message),c.go("dashboard.add_booking")});break;case"list":v.show_no_membership_message=!1,v.hide_dropdown=!1,v.clubs=[],r.GetUserClubs(v.user.id).then(function(e){v.clubs=e.clubs,v.clubs&&1<v.clubs.length?v.hide_dropdown=!0:1==v.clubs.length&&(v.club_id=v.clubs[0].id),M()})}function x(e){var t=e.date;if("day"===e.mode)for(var n=new Date(t).setHours(0,0,0,0),o=0;o<d.events.length;o++)if(n===new Date(d.events[o].date).setHours(0,0,0,0))return d.events[o].status;return""}function O(e){var t=0<arguments.length&&void 0!==e?e:null,n=new Date,e=v.new_booking.start_time?v.new_booking.start_time.time.split(":"):[n.getHours(),n.getMinutes()],n=new Date(v.new_booking.start_date);n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0);var o,i=moment(n).add(1,"hour").format();R()||!v.new_booking.end_time?(F(Y(v.new_booking.end_date,"end"),"end_times",n),v.end_times.some(function(e,t){if(e.time==moment(i).format("H:mm"))return o=t,!0}),v.new_booking.end_time={},v.new_booking.end_time=v.end_times[o]):t||F(Y(v.new_booking.end_date,"end"),"end_times",n),v.new_booking.end_time&&1==v.new_booking.end_time.disabled&&(v.end_times.some(function(e,t){if(e.time==moment(i).format("H:mm"))return o=t,!0}),v.new_booking.end_time={},v.new_booking.end_time=v.end_times[o]),v.new_booking.start_time&&1==v.new_booking.start_time.disabled&&(t||(v.start_times.some(function(e,t){if(0==e.disabled)return o=t}),v.new_booking.start_time={},v.new_booking.start_time=v.start_times[o]),T())}function D(){v.start_times.forEach(function(e,t){e.time==v.new_booking.start_time.time&&(v.new_booking.start_time=v.start_times[t])}),v.end_times.forEach(function(e,t){e.time==v.new_booking.end_time.time&&(v.new_booking.end_time=v.end_times[t])}),d.$apply()}function M(){b.GetAll(v.user.id,moment().format("Y-MM-DD"),"").then(function(e){return d.all_events=e.events,d.all_resources=e.resources,e})}function I(n,e){(1<arguments.length&&void 0!==e?e:null)&&(v.booking_errors={},v.error_event={});var t,o=jQuery.extend({},n);if(n.resourceId&&""!==n.resourceId)o.plane_id=n.resourceId;else if(n.resourceIds&&0<n.resourceIds.length)for(var i=0;i<n.resourceIds.length;i++)-1==n.resourceIds[i].indexOf("fi")&&(o.plane_id=n.resourceIds[i]);""!==n.instructor_id?o.instructor_id=n.instructor_id:o.instructor_id="0",delete o._start,delete o._end,delete o._id,delete o.source,delete o._allDay,delete o.allDay,delete o.className,delete o.plane,delete o.title,delete o.editable,delete o.resourceId,delete o.resourceIds,o.update_rental_items=!0;for(i=0;i<d.all_events.length;i++)d.all_events[i].id==o.id&&(t=d.all_events[i]);if(moment(Date.parse(o.end))<moment())y.error("Cannot Amend","This booking ends in the past  you cannot amend a booking in the past.");else{if(moment(o.start).add(30,"minutes")<moment()&&moment(t.end)!==o.end){if(!confirm("This booking starts in the past - you cannot amend the start date or time of a booking in the past, would you like to amend the end time along with any other changes you have made?"))return;o.start=t.start}b.updateBooking(o,v.user.id).then(function(e){var t;return 1==e.success?(o.edit_booking,y.success("Changes Saved","Your changes were saved successfully."),"bookout"==v.return_to?c.go("dashboard.my_account.bookout_with_booking",{booking_id:n.id}):c.go("dashboard.add_booking")):(t=[],!0!==e.instructor?t.push({type:"instructor",message:"It looks like your instructor is not available on the updated date and time",api:e.instructor,override:"instructor_override",can_override:e.can_override,button:"OVERRIDE INSTRUCTOR AVAILABILITY"}):!0!==e.check_user?-1<e.check_user.indexOf("self-certify")?t.push({type:"check_user",message:"It would appear that you are not within the currency requirements to book this aircraft for this flight.",api:e.check_user,override:"currency_override",button:"I am Current"}):t.push({type:"check_user",message:"It looks like your user account does not allow this booking to happen",api:e.check_user,override:"currency_override",can_override:e.can_override,button:""}):!0!==e.rental_items&&t.push({type:"rental_items",message:"It looks like some of the rental items are not available",api:e.rental_items,override:"update_rental_items",button:"Confirm Changes"}),v.booking_errors=t,v.error_event=o),e})}}function P(){v.new_booking.options=v.dateTimeRangePickerOptions;for(var e=0;e<24;e+=v.new_booking.options.hour_step)if(v.new_booking.options.minute_step&&0<v.new_booking.options.minute_step)for(var t=0;t<60/v.new_booking.options.minute_step;t++){var n=v.new_booking.options.minute_step*t;v.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:L(e,n)}),v.end_times.push({time:e+":"+n,disabled:L(e,n),duration:""})}else v.start_times.push({time:e+":00",disabled:L(e)}),v.end_times.push({time:e+":00",disabled:L(e),duration:""})}function A(){v.free_seats=[];var e=parseInt(v.new_booking.plane.seats)-1;if(v.new_booking.instructor&&0<v.new_booking.instructor.id&&e--,0<v.new_booking.passengers.length)for(var t=0;t<v.new_booking.passengers.length;t++)v.new_booking.passengers[t]&&""!==v.new_booking.passengers[t].email&&e--;v.free_seats=[];for(t=0;t<e;t++)v.free_seats.push(t)}function T(){var o,e;v.new_booking.start_date&&v.new_booking.start_time&&(o=new Date(v.new_booking.start_date),e=v.new_booking.start_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),v.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(v.new_booking.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=function(e){var t=moment.duration(e).days(),n=moment.duration(e).hours(),o=moment.duration(e).minutes();59==o&&(n++,o=0);e="";0<t&&(e=e+" "+t+" day",e=1<t?e+"s":e);0<n&&(e=e+" "+n+" hour",e=1<n?e+"s":e);0<o&&(e=e+" "+o+" minute",e=1<o?e+"s":e);return e}(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?v.end_times[t].disabled=1:v.end_times[t].duration="( "+n+" )"):v.end_times[t].duration=""}))}d.back=function(){p.history.back()},d.test=function(){v.new_booking.instructor={id:90,first_name:"A",last_name:"REYNIER"}},d.updateEvents=function(e,t){b.GetAll(v.user.id,e,t).then(function(e){return d.all_events=e.events,d.all_resources=e.resources,e})},d.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),m(t)(d)},d.alertOnClicked=function(e,t,n){v.bookingPanelOpen=!0,v.see_booking=e,v.see_booking.start_date=moment(v.see_booking.start).format("DD/MM/YYYY"),v.see_booking.end_date=moment(v.see_booking.end).format("DD/MM/YYYY"),v.see_booking.start_time=moment(v.see_booking.start).format("HH:mm"),v.see_booking.end_time=moment(v.see_booking.end).format("HH:mm"),v.see_booking.start_datetime=new Date(new Date(v.see_booking.start).toUTCString()),v.see_booking.end_datetime=new Date(v.see_booking.end),v.see_booking.visible=1,v.see_booking.after_booking_end=moment().isAfter(moment(v.see_booking.end)),d.$apply()},d.close_details=function(){v.see_booking.visible=0},d.changeLang=function(){d.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},d.changed=function(){d.check_plane_availability()},d.check_plane_availability=function(){B();var o=1==v.new_booking.edit_booking?1:0,e=0<v.new_booking.plane_id?v.new_booking.plane_id:0;v.new_booking.plane&&v.new_booking.plane.id&&(e=v.new_booking.plane.id);var t=new Date(v.new_booking.start_datetime).toISOString(),n=new Date(v.new_booking.end_datetime).toISOString(),i=v.is_edit_show_all?1:0;b.GetAllPlanes(v.user.id,t,n,i,e).then(function(e){if(v.planes=e,1==o)for(var t=0;t<v.planes.length;t++)v.planes[t].id==v.new_booking.plane.id&&(n=0,v.new_booking.plane=v.planes[t],d.check_rental_items());else{var n=1;if(v.new_booking.plane){for(t=0;t<v.planes.length;t++)v.planes[t].id==v.new_booking.plane.id&&(n=0,d.check_rental_items());1==n&&(v.new_booking.plane={},delete v.new_booking.plane)}}})},d.events=[],d.addOne=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null,o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;e&&!n&&(n=moment(e).add(1,"hour").format()),"list"==v.action||"add"==v.action?v.add_booking_event({start:e,plane_id:t,end:n,resourceObj:o}):"edit"==v.action&&c.go("dashboard.add_booking",{start:e,plane_id:t,end:n})},d.cancel_changes=function(){c.go("dashboard.add_booking")},d.check_rental_items=function(){var e,t,n;B(),v.rental_items=[],v.new_booking.plane&&(e=(1==v.new_booking.edit_booking?v.new_booking:v.new_booking.plane).club_id,t=new Date(v.new_booking.start_datetime).toISOString(),n=new Date(v.new_booking.end_datetime).toISOString(),b.GetRentalItems(e,t,n,0).then(function(e){if(v.rental_items=e,v.new_booking.rental_items)for(var t=0;t<v.new_booking.rental_items.length;t++){for(var n=0,o=0;o<v.rental_items.length;o++)if(v.rental_items[o].id==v.new_booking.rental_items[t].id){parseInt(v.new_booking.rental_items[t].number_to_book)>parseInt(v.rental_items[o].number_available)&&(v.new_booking.rental_items[t].number_to_book=parseInt(v.rental_items[o].number_available)),v.new_booking.rental_items[t].number_available=parseInt(v.rental_items[o].number_available),n=1;break}0==n&&delete v.new_booking.rental_items[t]}for(var i=0;i<v.rental_items.length;i++)v.rental_items[i].number=0;if(v.new_booking.rental_items)for(o=0;o<v.new_booking.rental_items.length;o++){for(var r=1,t=0;t<v.rental_items.length;t++)v.rental_items[t].id==v.new_booking.rental_items[o].id&&(r=0);1==r&&delete v.new_booking.rental_items[o]}}))},d.update_dateTime=function(e){var t,n,o,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;switch(e){case"start_date":j(),v.new_booking.start_date>v.new_booking.end_date&&(v.new_booking.end_date=v.new_booking.start_date),F(Y(v.new_booking.start_date),"start_times"),O(),R()&&G();break;case"end_date":j(),O(),v.new_booking.end_date<v.new_booking.start_date?(v.new_booking.start_date=v.new_booking.end_date,F(Y(v.new_booking.start_date),"start_times")):(F(Y(v.new_booking.start_date),"start_times"),F(Y(v.new_booking.end_date,"end"),"end_times")),R()&&G();break;case"start_time":j(),O(),T();break;case"end_time":"past"==v.times_clean_type?O("edit"):O();break;case"edit":v.is_edit_show_all=!0,v.times_clean_type="start_times",moment(v.new_booking.start).unix()<moment().unix()?v.times_clean_type="past":(O(),j()),T(),setTimeout(function(){D()},500);break;case"edit2":j(),F(Y(v.new_booking.start_date),"start_times"),O(),T(),setTimeout(function(){if(D(),i)for(var e=0;e<v.planes.length;e++)parseInt(v.planes[e].id)==i&&(v.new_booking.plane=v.planes[e],d.getPlaneInstructors(v.new_booking.plane.id),d.$apply())},500)}v.instructor_first_booking||d.check_plane_availability(),v.new_booking.plane&&d.check_rental_items(),v.new_booking.plane&&!v.instructor_first_booking&&d.getPlaneInstructors(),v.new_booking.plane&&(v.new_booking.start_date,t=moment(v.new_booking.start_date).format("Y-MM-DD"),n=v.new_booking.start_time.time,e=moment(t+" "+n),t=moment(v.new_booking.end_date).format("Y-MM-DD"),n=v.new_booking.end_time.time,n=moment(t+" "+n),o={id:"TEMP",title:"TEMPORARY",resourceId:parseInt(v.new_booking.plane.id),start:e,end:n,editable:!1,color:"rgb(255, 110, 110)",opacity:"1"},v.already_added_temp?($("#calendar").fullCalendar("removeEvents","TEMP"),setTimeout(function(){$("#calendar").fullCalendar("renderEvent",o)},150)):($("#calendar").fullCalendar("renderEvent",o),v.already_added_temp=!0))},v.decline_new_booking_error=function(){v.new_booking_errors={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},v.override_new_booking_errors=function(){v.new_booking.admin_override=!0,v.new_booking_errors={},d.make_booking(!0)},d.update_booking=function(e){if(B(),e){e={};if(delete(e=jQuery.extend(!0,{},v.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,delete e.after_booking_end,e.free_seats=v.new_booking.free_seats.constructor===Array?0:v.new_booking.free_seats,e.start=v.new_booking.start_datetime,e.end=v.new_booking.end_datetime,v.new_booking.tuition_required&&0<v.new_booking.tuition_required.id&&(e.course_id=v.new_booking.tuition_required.id),e.maintenance_flight=v.new_booking.maintenance_flight,moment(Date.parse(v.new_booking.end_datetime)).add(1,"hour").isBefore())return y.error("Cannot Amend","This booking ends in the past by more than an hour  you cannot amend a booking that finished in the past."),!1;e.resourceId=v.new_booking.plane.id,-1<v.new_booking.plane.id.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=v.new_booking.plane.id.slice(0,-1)),v.booking_self?e.user_id=v.user.id:e.user_id=v.new_booking.user.user_id,e.instructor_id=v.new_booking.instructor?v.new_booking.instructor.id:0,e.plane_id=v.new_booking.plane.id,e.override=v.new_booking.override||0,e.club_id=v.new_booking.club_id,I(e)}},d.update_club=function(){v.club_id=v.change_club.id,-1<v.user.access.instructor.indexOf(v.club_id)||-1<v.user.access.manager.indexOf(v.club_id)?v.booking_self=!1:v.booking_self=!0,M()},d.alertOnEventClick=function(e,t,n){d.alertMessage=e.title+" was clicked "},d.alertOnDrop=function(e,t,n,o,i,r){if(e.resourceId)-1<e.resourceId.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=e.resourceId.slice(0,-1));else if(e.resourceIds)for(var a=0;a<e.resourceIds.length;a++)-1<e.resourceIds[a].toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceIds[a]=e.resourceIds[a].slice(0,-1));I(e)},d.alertOnResize=function(e,t,n,o,i,r){I(e)},d.override_booking_change=function(e){v.error_event[e]=!0,v.error_event.override=1,I(v.error_event,!0)},d.override_booking_change2=function(e){v.error_event.admin_override=!0,v.error_event.override=1,e&&(v.error_event[e]=!0),I(v.error_event,!0)},d.decline_booking_change=function(){v.booking_errors={},v.error_event={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},d.wholeDay=function(){1==d.whole_day_booking?(d.whole_day_booking=!1,d.myDatetimeRange.time.from=480,d.myDatetimeRange.time.to=1080):(d.whole_day_booking=!0,d.myDatetimeRange.time.from=0,d.myDatetimeRange.time.to=1440)},d.changeView=function(e,t){g.calendars[t].fullCalendar("changeView",e)},d.renderCalender=function(e){f(function(){g.calendars[e]&&g.calendars[e].fullCalendar("render")})},d.add_rental_item=function(){if(v.rental_item&&v.new_booking.rental_items&&v.rental_item.id){for(var e=1,t=0;t<v.new_booking.rental_items.length;t++)v.new_booking.rental_items[t].id==v.rental_item.id&&(e=0,v.new_booking.rental_items[t]);1==e&&(v.new_booking.rental_items.push(v.rental_item),delete v.rental_item)}else v.rental_item&&(v.new_booking.rental_items||(v.new_booking.rental_items=[]),v.new_booking.rental_items.push(v.rental_item),delete v.rental_item)},d.rental_item_remove=function(t){v.new_booking.rental_items=$.grep(v.new_booking.rental_items,function(e){return e.id!=t})},d.getPlaneInstructors=function(){var e=parseInt(v.new_booking.plane.club_id)||v.club_id;v.club_id=e,-1<v.user.access.instructor.indexOf(e)||-1<v.user.access.manager.indexOf(e)?(v.booking_self=!1,E()):v.booking_self=!0,-1<v.user.access.manager.indexOf(e)?v.booking_admin=!0:v.booking_admin=!1,d.check_rental_items();var t=new Date(v.new_booking.start_datetime).toISOString(),e=new Date(v.new_booking.end_datetime).toISOString();"add"==v.action||"list"==v.action?(n=!v.is_edit_show_all&&v.booking_self?0:1,b.GetPlaneInstructors(v.user.id,v.new_booking.plane.id,t,e,n).then(function(e){v.instructors=e;var t=1;if(v.new_booking.instructor){for(var n=0;n<v.instructors.length;n++)v.instructors[n].id!=v.new_booking.instructor.id&&v.instructors[n].user_id!=v.new_booking.instructor.user_id||(t=0,v.new_booking.instructor=v.instructors[n]);1==t&&(v.new_booking.instructor={},delete v.new_booking.instructor)}A()})):(n=!v.is_edit_show_all&&v.booking_self?0:1,b.GetPlaneInstructorsEdit(v.user.id,v.new_booking.plane.id,t,e,n,v.new_booking.id).then(function(e){v.instructors=e;var t=1;if(v.new_booking.instructor){for(var n=0;n<v.instructors.length;n++)v.instructors[n].id==v.new_booking.instructor.id&&(t=0);1==t&&(v.new_booking.instructor={},delete v.new_booking.instructor)}A()})),k.GetCoursesByClubId(v.new_booking.plane.club_id).then(function(e){v.courses=e.items});var n=new Date(v.new_booking.end_datetime);b.GetIfCurrent(v.user_id,v.new_booking.plane.id,n.toISOString()).then(function(e){e.success&&(v.is_current=e.is_current,v.currency_type=e.requirements.currency_type,v.currency_days=e.requirements.currency_days)})},d.clear_booking=function(){v.new_booking={start_date:S,end_date:S,free_seats:[],passengers:[],instructor:void 0,options:v.dateTimeRangePickerOptions},v.instructor_first_booking=!1,d.submitted=!1},v.seats_in_plane=function(){A();var e=v.new_booking.plane.seats;return v.new_booking.instructor&&e--,--e},v.invite_new_passenger=function(e){v.new_pax&&""!==v.new_pax.email&&0==v.new_pax.is_member?(v.new_pax.invited_by=v.user.id,t.AddPassenger(v.new_pax,l.booking_id).then(function(e){e.success&&(y.success("Invitation Sent","The passenger invitation has been sent."),v.update_passenger_list(),v.show_new_passenger_invitation=!1)})):y.error("Invalid Email","Please enter a valid email address to send the invitation to.")},v.add_new_passenger=function(e){v.new_pax.is_member?(v.new_pax.club_id=v.club_id,v.new_pax.invited_by=v.user.id,v.new_booking.passengers.push(v.new_pax)):v.show_new_passenger_invitation=!0},v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},v.close_passenger_invitation=function(){v.show_new_passenger_invitation=!1};v.get_pax_class=function(e,t){return"to_invite"==e||"invited"==e?"waiting_pax_invitation":"member"==e||"accepted"==e||"is_member"==e?"success_pax_invitation":"declined"==e?"declined_pax_invitation":!e&&t?"success_pax_invitation":"new_pax_invitation"},v.new_passenger_invite_ready=function(e){if(!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(v.new_pax.email))return y.error("Invalid Email","The email address appears to be incorrect  please double check the email address entered."),!1;v.new_pax.is_member=!1,v.new_pax.status="to_invite",v.new_booking.passengers.push(v.new_pax),v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},v.show_new_passenger_invitation=!1},v.remove_passenger=function(e){v.new_booking.passengers.splice(e,1)},d.cancel_booking=function(t){"YES"==prompt("Are you sure you wish to cancel this booking? Please type YES in the box below to confirm.")?b.DeleteBooking(v.user.id,t).then(function(e){y.success("Booking Cancelled","The booking has been cancelled."),e.success?(c.go("dashboard.add_booking"),d.all_events=$.grep(d.all_events,function(e){return e.id!=t}),$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",d.all_events)):y.error("Error","An error occurred while cancelling the booking.")}):c.go("dashboard.add_booking")};var U;function E(e,t){e=0<arguments.length&&void 0!==e?e:null,t=1<arguments.length&&void 0!==t?t:null,e=e||v.club_id,t=t||v.new_booking.end_datetime;0<e&&t&&(t=new Date(t).toISOString(),r.GetAllActiveByClub(e,t).then(function(e){if((-1<v.user.access.instructor.indexOf(v.club_id)||-1<v.user.access.manager.indexOf(v.club_id))&&(v.booking_self=!1,v.show_self_option=!0),v.members=e.members||e,v.members&&0<v.members.length)for(var t=0;t<v.members.length;t++)v.members[t].is_member=!0;if(v.new_booking.instructor&&v.new_booking.instructor.id==v.user.id&&(v.show_self_option=!0,v.booking_self=!1),v.new_booking.user||(v.all_members?v.new_booking.user=v.all_members.find(function(e,t){if(e.user_id==v.new_booking.user_id)return!0}):r.GetAllByClub(v.club_id).then(function(e){v.all_members=e;for(var t=0;t<v.all_members.length;t++)v.all_members[t].is_member=!0;v.new_booking.user=v.all_members.find(function(e,t){if(e.user_id==v.new_booking.user_id)return!0})})),v.members&&0<v.members.length)for(var n=0;n<v.members.length;n++)v.members[n].is_member=!0}))}function B(){var e=new Date(v.new_booking.start_date),t=new Date,n=v.new_booking.start_time?v.new_booking.start_time.time.split(":"):[t.getHours(),t.getMinutes()];e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0);n=new Date(v.new_booking.end_date),t=v.new_booking.end_time?v.new_booking.end_time.time.split(":"):[t.getHours(),t.getMinutes()];n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(0),v.new_booking.start_datetime=e.toISOString(),v.new_booking.end_datetime=n.toISOString()}function L(e,t,n){var o=1<arguments.length&&void 0!==t?t:null,i=2<arguments.length&&void 0!==n?n:0,o=parseInt(o);e=parseInt(e);var r=0;return v.new_booking.options.business_hours&&(t=v.new_booking.options.business_hours.from.split(":"),n=v.new_booking.options.business_hours.to.split(":"),0==i||(n[0]=parseInt(n[0])-1),o||0==o?((e<parseInt(t[0])||e==parseInt(t[0])&&o<parseInt(t[1]))&&(r=1),(e>parseInt(n[0])||e==parseInt(n[0])&&o>parseInt(n[1]))&&(r=1)):(parseInt(t[0])<e&&(r=1),parseInt(n[0])>e&&(r=1))),r}function F(e,n,t){var o,i=2<arguments.length&&void 0!==t?t:null;switch(e){case"today":o=new Date;break;case"past":case"future":o=new Date("1990-07-26");break;case"after":case"before":o=new Date(i)}var r=new Date(v.new_booking.start_date);v[n].forEach(function(e,t){e=e.time.split(":");r.setHours(e[0]),r.setMinutes(e[1]),r.setSeconds(0),moment(r).isAfter(moment(o))?v[n][t].disabled=L(parseInt(e[0]),parseInt(e[1]),"start_times"==n?1:0):v[n][t].disabled=1}),T()}function G(){var e=v.new_booking.start_time.time.split(":"),t=new Date(v.new_booking.start_date);t.setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0);moment(t).add(1,"hour").format();23<=parseInt(e[0])?moment(v.new_booking.start_date).isSame(moment(v.new_booking.end_date))&&(v.new_booking.end_date=new Date(moment(v.new_booking.end_date).add(1,"day").format()),F("future","end_times"),v.new_booking.end_time=v.end_times[0]):F("after","end_times",t)}function R(){var e,t,n,o=!1;return v.new_booking.end_time&&(e=new Date(v.new_booking.start_date),n=v.new_booking.start_time.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date(v.new_booking.end_date),n=v.new_booking.end_time.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),(moment(e).isAfter(moment(t))||moment(e).isSame(t)||t==e)&&(o=!0)),o}function j(){var e,t;moment(v.new_booking.start_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")?F("today","start_times"):moment(v.new_booking.start_date).isAfter(moment())&&F("future","start_times"),moment(v.new_booking.end_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(v.new_booking.start_time&&G(),F(Y(v.new_booking.start_date),"end_times")),v.new_booking.end_date==v.new_booking.start_date&&v.new_booking.start_time&&(e=v.new_booking.start_time.time.split(":"),(t=new Date(v.new_booking.start_date)).setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0),R()?(F(Y(v.new_booking.start_date),"start_times"),F(Y(v.new_booking.end_date,"end"),"end_times",t),G()):F(Y(v.new_booking.end_date,"end"),"end_times",t))}function Y(e,t){var n=1<arguments.length&&void 0!==t?t:"start",t="today";return moment(moment(e).format("YYYY/MM/DD")).isAfter(moment().format("YYYY/MM/DD"))?(t="future",v.new_booking.start_date&&v.new_booking.end_date&&"end"==n&&moment(v.new_booking.start_date).isSame(moment(v.new_booking.end_date))&&(t="after")):t=moment(e).format("YYYY/MM/DD")==moment().format("YYYY/MM/DD")?"start"==n?"today":"after":"past",t}setTimeout(function(){r.GetAllByClub(v.club_id).then(function(e){v.members=e;for(var t=0;t<v.members.length;t++)v.members[t].is_member=!0;v.all_members=e;for(t=0;t<v.all_members.length;t++)v.all_members[t].is_member=!0})},200),v.invite_passenger=function(e,t){v.new_booking.passengers.push(v.new_pax)},v.refresh_passenger=function(e,t){n.GetInvite(v.new_booking.passengers[t].invitation_token).then(function(e){v.new_booking.passengers[t].status=e.status,v.new_booking.passengers[t].user_id=e.user_id,v.new_booking.passengers[t].first_name=e.first_name,v.new_booking.passengers[t].last_name=e.last_name})},v.update_passenger_list=function(){t.GetPassengers(l.booking_id).then(function(e){e.success&&(v.new_booking.passengers=e.passengers,v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0})})},v.resend_invitation=function(e){b.ResendInvitation(e,e.id).then(function(e){1==e.success?y.success("Invitation Resent",e.message):y.error("Resend Failed",e.message)})},v.refresh_all_passenger=function(){var t=0;++t<v.new_booking.passengers.length&&v.new_booking.passengers[t]&&"invited"==v.new_booking.passengers[t].status&&""!==v.new_booking.passengers[t].invitation_token&&n.GetInvite(v.new_booking.passengers[t].invitation_token).then(function(e){v.new_booking.passengers[t].status=e.status,v.new_booking.passengers[t].user_id=e.user_id,v.new_booking.passengers[t].first_name=e.first_name,v.new_booking.passengers[t].last_name=e.last_name})},v.get_passenger_status=function(e){if(e)return e.is_member?"OK - is already club member":"accepted"==e.status?"OK - passenger has accepted the terms":"declined"==e.status?"NO - passenger declined the offer":"invited"==e.status?"Waiting for user response":""},v.remove_invite=function(e){v.new_booking.passengers.splice(e,1),v.init_passengers()},v.resend_invitation=function(e){e=v.new_booking.passengers[e];b.ResendInvitation(e,e.id).then(function(e){1==e.success?y.success("Invitation Resent",e.message):y.error("Resend Failed",e.message)})},v.pax_invited=function(e){return""!=e.status&&"to_invite"!=e.status},v.get_passenger_status=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"invited"==e.status?"This passenger has been invited but has not yet responded.":""},v.get_passenger_status_edit=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"member"==e.status?"This passenger is a member":"invited"==e.status?"This passenger has been invited but has not yet accepted.":""},v.invite_new_passenger=function(e){v.show_new_passenger_invitation=!0,v.new_pax=e,v.new_booking.passengers.push({first_name:"",last_name:"",email:"",status:""})},v.close_passenger_invitation=function(){v.new_pax=-1,v.show_new_passenger_invitation=!1},v.get_members=function(t,e){0!=v.club_id&&v.club_id||!v.new_booking.plane||!v.new_booking.plane.id||(v.club_id=v.new_booking.plane.club_id),(0==v.club_id||!v.club_id)&&v.new_booking&&v.new_booking.club_id&&0<v.new_booking.club_id&&(v.club_id=v.new_booking.club_id),t&&2<t.length&&r.GetAllByClubAndName(v.club_id,t).then(function(e){if(e.success){e=e.members.filter(function(t){return!v.new_booking.passengers.find(function(e){return e.email===t.email})});return v.members=e,v.members.length<1&&(v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)?v.new_pax.email=t:-1<t.indexOf(" ")?(e=t.split(" "),v.new_pax.first_name=e[0],v.new_pax.last_name=e[1]):v.new_pax.first_name=t),!0}return v.new_pax.status="",v.new_pax.email="",v.new_pax.first_name="",v.new_pax.last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)&&(v.new_pax.email=t,v.new_pax.not_found=!0),!1})},d.save=function(){"add"==v.action?d.create():(B(),d.update())},d.update=function(){var e=new Date;e.setHours(14),e.setMinutes(0),d.mytime=e},v.show_self_option=!1,d.select_plane=function(e){d.check_rental_items(),A(),-1<v.user.access.instructor.indexOf(v.club_id)||-1<v.user.access.manager.indexOf(v.club_id)?v.show_self_option=!0:v.show_self_option=!1,-1<v.user.access.instructor.indexOf(v.club_id)&&(v.booking_self=!1)},v.onInstructorPlaneSelected=function(){var e,t,n,o,i;v.new_booking.plane&&(e=parseInt(v.new_booking.plane.club_id),v.club_id=e,(-1<v.user.access.instructor.indexOf(e)||-1<v.user.access.manager.indexOf(e))&&(v.booking_self=!1,v.show_self_option=!0),-1<v.user.access.manager.indexOf(e)&&(v.booking_admin=!0),B(),t=new Date(v.new_booking.start_datetime).toISOString(),n=new Date(v.new_booking.end_datetime).toISOString(),o=v.new_booking.instructor,i=new Date(v.new_booking.end_datetime).toISOString(),r.GetAllActiveByClub(e,i).then(function(e){if(v.members=e.members||e,v.members&&0<v.members.length)for(var t=0;t<v.members.length;t++)v.members[t].is_member=!0}),k.GetCoursesByClubId(e).then(function(e){v.courses=e.items}),b.GetPlaneInstructors(v.user.id,v.new_booking.plane.id,t,n,1).then(function(e){if(v.instructors=e,o){for(var t=!1,n=0;n<v.instructors.length;n++)if(v.instructors[n].id==o.id||v.instructors[n].user_id==o.user_id){v.new_booking.instructor=v.instructors[n],t=!0;break}t||v.instructors.push(o)}A()}),d.check_rental_items())},j(),l.start&&(v.new_booking.start_date=new Date(l.start),v.new_booking.end_date=new Date(l.start),v.new_booking.start_time={time:moment(l.start).format("HH:mm")},v.new_booking.end_time={time:moment(l.start).add(30,"minutes").format("HH:mm")},U=moment(l.start).add(30,"minutes"),v.default_date=v.new_booking.start_date,$("#calendar").fullCalendar("gotoDate",v.new_booking.start_date),setTimeout(function(){var e=[{id:"TEMP",title:"TEMPORARY",resourceId:7,start:l.start,end:U,editable:!1,color:"rgb(255, 110, 110)",opacity:"1"}];$("#calendar").fullCalendar("addEventSource",e),setTimeout(function(){},500),d.update_dateTime("edit2",l.plane_id)},500)),v.already_added_temp=!1,v.add_booking_event=function(r){v.bookingPanelOpen=!0,v.new_booking.start_date=new Date(r.start),v.new_booking.end_date=new Date(luxon.DateTime.fromISO(new Date(r.end).toISOString()).plus({minutes:60}).toISO()),v.new_booking.start_time={time:moment(r.start).format("HH:mm")},v.new_booking.end_time={time:moment(r.start).add(60,"minutes").format("HH:mm")},b.GetAllPlanes(v.user.id,v.new_booking.start_date.toISOString(),v.new_booking.end_date.toISOString(),0,0).then(function(e){v.planes=e;var t,n,o,i=String(r.plane_id),e=0===i.indexOf("fi_");e?(t=parseInt(i.replace("fi_","")),v.instructor_first_booking=!0,v.booking_self=!1,v.booking_admin=!0,v.show_self_option=!0,n=v.new_booking.start_date.toISOString(),o=v.new_booking.end_date.toISOString(),b.GetInstructorByUser(t).then(function(e){return v.new_booking.instructor=e,v.instructors=[e],b.GetInstructorPlanes(v.user.id,t,n,o)}).then(function(e){v.planes=e,d.update_dateTime("edit2")})):(v.instructor_first_booking=!1,v.new_booking.plane=v.planes.find(function(e){return parseInt(e.id)===parseInt(r.plane_id)}),d.update_dateTime("edit2"))})},d.calendarOptions={initialView:"dayGridMonth"},d.calendarEvents=[{title:"Event 1",start:"2024-02-17"},{title:"Event 2",start:"2024-02-18"}],d.make_booking=function(e){if(d.submitted=!0,function(){for(var e=document.querySelectorAll(".make_booking_table tr.field-error"),t=0;t<e.length;t++)e[t].classList.remove("field-error");var n=[{ok:v.new_booking.start_time,id:"field-start-time",label:"Start Time"},{ok:v.new_booking.end_time,id:"field-end-time",label:"End Time"},{ok:v.new_booking.plane,id:"field-aircraft",label:"Aircraft"}];v.booking_self||n.push({ok:v.new_booking.user,id:"field-member",label:"Member"});for(var o=0;o<n.length;o++)if(!n[o].ok){var i=document.getElementById(n[o].id);return i&&(i.classList.add("field-error"),i.scrollIntoView({behavior:"smooth",block:"center"})),y.error("Missing: "+n[o].label,"Please fill in the highlighted field before submitting."),n[o].label}return null}())return!1;if(e){var i={};return(delete(i=jQuery.extend(!0,{},v.new_booking)).options,delete i.instructor,delete i.plane,delete i.start_date,delete i.start_time,delete i.end_date,delete i.end_time,delete i.start_datetime,delete i.end_datetime,delete i.tuition_required,delete i.user,moment(Date.parse(v.new_booking.end_datetime)).add(60,"minutes").isBefore())?(y.error("Booking in the past","This booking ends in the past  you cannot create a booking in the past."),!1):moment(Date.parse(v.new_booking.start_datetime)).add(60,"minutes").isBefore()?(y.error("Booking in the past","This booking starts in the past  you cannot create a booking in the past."),!1):(i.override=v.new_booking.override||0,v.booking_self?(i.user_id=v.user.id,i.instructor_id=v.new_booking.instructor?v.new_booking.instructor.id:0):(i.user_id=v.new_booking.user.user_id,-1<v.user.access.manager.indexOf(v.club_id)?i.instructor_id=v.new_booking.instructor?v.new_booking.instructor.id:0:i.instructor_id=v.user.id,i.booked_by_admin_instructor=1,i.override=1),i.free_seats=v.new_booking.free_seats.constructor===Array?0:v.new_booking.free_seats,i.start=v.new_booking.start_datetime,i.end=v.new_booking.end_datetime,i.plane_id=v.new_booking.plane.id,i.club_id=v.new_booking.plane.club_id,i.booked_by=v.user.id,i.course_id=v.new_booking.tuition_required?v.new_booking.tuition_required.id:0,i.maintenance_flight=v.new_booking.maintenance_flight,void b.Create(v.user.id,i).then(function(e){if(1==e.success)d.clear_booking(),b.GetAll(v.user.id,moment(i.start).format("Y-MM-DD"),"").then(function(e){y.success("Booking Created","Your booking has been created successfully."),d.all_events=e.events,d.all_resources=e.resources,$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",d.all_events)}),c.go("dashboard.add_booking");else{if(e.more&&0<e.more.length){for(var t="",n=0;n<e.more.length;n++)"differences_verified"==e.more[n].name&&(t+="\n - Your differences training sign-offs need to be verified by a member of staff. \n"),"licence_verified"==e.more[n].name&&(t+="\n - Your licence needs to be verified by a member of staff. \n"),"medical_verified"==e.more[n].name&&(t+="\n - Your medical needs to be verified by a member of staff. \n"),"medical"==e.more[n].name&&(t+="\n - You need to upload a copy of your medical. \n"),"licence"==e.more[n].name&&(t+="\n - You need to upload a copy of your licence. \n"),"differences"==e.more[n].name&&(t+="\n - You need to upload a copy of your differences training signed off. \n");e.message=e.message+t}var o;e.allow_override&&-1<v.user.access.manager.indexOf(v.club_id)&&(o=[],"instructor"==e.reason&&o.push({type:"instructor",message:"It looks like the instructor is not available for this booking",api:e.instructor,override:"instructor_override",button:"OVERRIDE INSTRUTOR AVAILABILITY"}),v.new_booking_errors=o),y.error("Booking Error",e.message)}}))}},d.popup2={opened:!1},d.popup3={opened:!1},d.popup4={opened:!1},d.open2=function(){d.popup2.opened=!0},d.open3=function(){d.popup3.opened=!0},d.open4=function(){d.popup4.opened=!0},d.open=function(e){u.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return warning_msg}}}).result.then(function(t){_.info("PRESSED GO: "+t),r.Delete(t).then(function(){v.club.members=$.grep(v.club.members,function(e){return e.id!=t})})},function(){_.info("Modal dismissed at: "+new Date)})}}function BookingsController(e,o,t,n,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k){var y=this;s.va1="123",y.user=r.globals.currentUser,y.allUsers=[],y.club={},y.page_title="",y.club.member={},y.imported_new_headers=[],y.see_booking={},y.is_current=!1,y.currency_type="",y.currency_days="",y.booking_self=!0,y.times_clean_type="start_times",y.action=c.current.data.action,y.return_to=c.current.data.return_to,y.club_id=0,y.user_id=y.user.id,y.no_show_cols=["membership_start","membership_id","selected"];var v=new Date,w=Math.floor(8),r=Math.floor(18);new Date(v.getFullYear(),v.getMonth(),v.getDate(),w,0,0),new Date(v.getFullYear(),v.getMonth(),v.getDate(),r,0,0);y.default_date=new Date,y.datepickerOptions={customClass:S,format:"dd/MM/yyyy",showWeeks:!1},y.dateTimeRangePickerOptions={hour_step:1,minute_step:30,min_date:C,datepicker:{customClass:S,format:"dd/MM/yyyy",showWeeks:!1,minDate:C},business_hours:{from:"09:00",to:"22:30"}},s.whole_day_booking=!1,y.instructor_charges=[],y.cancellation={reasons:["Pilot Unwell","Pilot Unavailable","Weather at home base","Weather at destination","Plane Unavailable","Plane Unserviceable","Plane Returned Too Late by previous booking","Instructor Not Available","Airfield Closed","Airspace Closed","Other - please specify"],notes:""};var C=new Date;C.setMinutes(0),C.setSeconds(0);r=moment(C);r.add(2,"hours"),(r=new Date(r)).setSeconds(0);(new Date).format("d/M/yyyy");y.start_times=[],y.end_times=[],y.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],options:y.dateTimeRangePickerOptions},s.toggle=!0,s.whentimechangedata={},s.overridePicker=!0;Date();switch(y.planes=[],function(){for(var e=0;e<24;e+=y.new_booking.options.hour_step)if(y.new_booking.options.minute_step&&0<y.new_booking.options.minute_step)for(var t=0;t<60/y.new_booking.options.minute_step;t++){var n=y.new_booking.options.minute_step*t;n=(n<10?"0":"")+n,y.start_times.push({time:e+":"+n,disabled:E(e,n)}),y.end_times.push({time:e+":"+n,disabled:E(e,n),duration:""})}else y.start_times.push({time:e+":00",disabled:E(e)}),y.end_times.push({time:e+":00",disabled:E(e),duration:""})}(),s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],y.action){case"add":y.page_title="Add a Booking",y.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],options:y.dateTimeRangePickerOptions},I();break;case"edit":y.page_title="Edit a Booking",y.see_booking.visible=0,y.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],options:y.dateTimeRangePickerOptions},I(),D(),l.booking_id&&g.GetEdit(y.user.id,l.booking_id).then(function(e){if(e.success){if(y.new_booking=e.booking,y.new_booking.options=y.dateTimeRangePickerOptions,y.new_booking.edit_booking=1,y.new_booking.start_date=new Date(y.new_booking.start),y.new_booking.start_time={time:moment(y.new_booking.start).format("HH:mm")},y.new_booking.end_date=new Date(y.new_booking.end),y.new_booking.end_time={time:moment(y.new_booking.end).format("HH:mm")},y.new_booking.after_booking_end=moment().isAfter(moment(y.new_booking.end)),y.new_booking.instructor&&y.new_booking.instructor.id==y.user_id&&(y.booking_self=!1),s.$parent.vm.default_date=y.new_booking.start_date,setTimeout(function(){s.$parent.vm.see_booking.visible=0,s.$apply()},1e3),U(),s.update_dateTime("edit"),h.GetCoursesByClubId(y.new_booking.club_id).then(function(e){y.courses=e.items}),T(y.new_booking.club_id,y.new_booking.end),y.new_booking.rental_items)for(var t=0;t<y.new_booking.rental_items.length;t++)y.new_booking.rental_items[t].number_to_book=parseInt(y.new_booking.rental_items[t].number_to_book);y.new_booking.free_seats&&(y.new_booking.free_seats=parseInt(y.new_booking.free_seats)),y.new_booking.instructor,0!=y.club_id&&y.club_id||!y.new_booking.plane||!y.new_booking.plane.id||(y.club_id=y.new_booking.plane.club_id),P()}else k.error("Booking Error",e.message),c.go("dashboard.bookings.add")});break;case"list":y.show_no_membership_message=!1,y.hide_dropdown=!1,y.clubs=[],o.GetUserClubs(y.user.id).then(function(e){y.clubs=e.clubs,y.clubs&&1<y.clubs.length?y.hide_dropdown=!0:1==y.clubs.length&&(y.club_id=y.clubs[0].id),D()})}function S(e){var t=e.date;if("day"===e.mode)for(var n=new Date(t).setHours(0,0,0,0),o=0;o<s.events.length;o++)if(n===new Date(s.events[o].date).setHours(0,0,0,0))return s.events[o].status;return""}function x(e){var t=0<arguments.length&&void 0!==e?e:null,n=new Date,e=y.new_booking.start_time?y.new_booking.start_time.time.split(":"):[n.getHours(),n.getMinutes()],n=new Date(y.new_booking.start_date);n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0);var o,i=moment(n).add(1,"hour").format();F()||!y.new_booking.end_time?(B(R(y.new_booking.end_date,"end"),"end_times",n),y.end_times.some(function(e,t){if(e.time==moment(i).format("HH:mm"))return o=t}),y.new_booking.end_time={},y.new_booking.end_time=y.end_times[o]):t||B(R(y.new_booking.end_date,"end"),"end_times",n),y.new_booking.end_time&&1==y.new_booking.end_time.disabled&&(y.end_times.some(function(e,t){if(e.time==moment(i).format("HH:mm"))return o=t}),y.new_booking.end_time={},y.new_booking.end_time=y.end_times[o]),y.new_booking.start_time&&1==y.new_booking.start_time.disabled&&(t||(y.start_times.some(function(e,t){if(0==e.disabled)return o=t}),y.new_booking.start_time={},y.new_booking.start_time=y.start_times[o]),A())}function O(){y.start_times.forEach(function(e,t){e.time==y.new_booking.start_time.time&&(y.new_booking.start_time=y.start_times[t])}),y.end_times.forEach(function(e,t){e.time==y.new_booking.end_time.time&&(y.new_booking.end_time=y.end_times[t])}),s.$apply()}function D(){g.GetAll(y.user.id,moment().format("Y-M-D"),"").then(function(e){return s.all_events=e.events,s.all_resources=e.resources,e})}function M(n,e){(1<arguments.length&&void 0!==e?e:null)&&(y.booking_errors={},y.error_event={});var t,o=jQuery.extend({},n);o.plane_id=n.resourceId,""!==n.instructor_id?o.instructor_id=n.instructor_id:o.instructor_id="0",delete o._start,delete o._end,delete o._id,delete o.source,delete o._allDay,delete o.allDay,delete o.className,delete o.plane,delete o.title,delete o.editable,delete o.resourceIds,o.update_rental_items=!0;for(var i=0;i<s.all_events.length;i++)s.all_events[i].id==o.id&&(t=s.all_events[i]);if(moment(Date.parse(o.end))<moment())k.warning("Past Booking","This booking ends in the past - you cannot amend a booking in the past.");else{if(moment(o.start).add(30,"minutes")<moment()&&moment(t.end)!==o.end){if(!confirm("This booking starts in the past - you cannot amend the start date or time of a booking in the past, would you like to amend the end time along with any other changes you have made?"))return;o.start=t.start}g.updateBooking(o,y.user.id).then(function(e){var t;return 1==e.success?(1==o.edit_booking&&s.$parent.updateEvents(o.start,o.end),k.success("Changes Saved","Your changes were saved successfully"),"bookout"==y.return_to?c.go("dashboard.my_account.bookout_with_booking",{booking_id:n.id}):c.go("dashboard.bookings.add")):(t=[],!0!==e.instructor?t.push({type:"instructor",message:"It looks like your instructor is not available on the updated date and time",api:e.instructor,override:"instructor_override",button:""}):!0!==e.check_user?-1<e.check_user.indexOf("self-certify")?t.push({type:"check_user",message:"It would appear that you are not within the currency requirements to book this aircraft for this flight.",api:e.check_user,override:"currency_override",button:"I am Current"}):t.push({type:"check_user",message:"It looks like your user account does not allow this booking to happen",api:e.check_user,override:"currency_override",button:""}):!0!==e.rental_items&&t.push({type:"rental_items",message:"It looks like some of the rental items are not available",api:e.rental_items,override:"update_rental_items",button:"Confirm Changes"}),y.booking_errors=t,y.error_event=o),e})}}function I(){y.new_booking.options=y.dateTimeRangePickerOptions;for(var e=0;e<24;e+=y.new_booking.options.hour_step)if(y.new_booking.options.minute_step&&0<y.new_booking.options.minute_step)for(var t=0;t<60/y.new_booking.options.minute_step;t++){var n=y.new_booking.options.minute_step*t;y.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:E(e,n)}),y.end_times.push({time:e+":"+n,disabled:E(e,n),duration:""})}else y.start_times.push({time:e+":00",disabled:E(e)}),y.end_times.push({time:e+":00",disabled:E(e),duration:""})}function P(){y.free_seats=[];var e=y.new_booking.plane.seats-1;if(y.new_booking.instructor&&0<y.new_booking.instructor.id&&e--,0<y.new_booking.passengers.length)for(var t=0;t<y.new_booking.passengers.length;t++)y.new_booking.passengers[t]&&""!==y.new_booking.passengers[t].email&&e--;for(t=0;t<e;t++)y.free_seats.push(t)}function A(){var o,e;y.new_booking.start_date&&y.new_booking.start_time&&(o=new Date(y.new_booking.start_date),e=y.new_booking.start_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),y.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(y.new_booking.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=function(e){var t=moment.duration(e).days(),n=moment.duration(e).hours(),o=moment.duration(e).minutes();59==o&&(n++,o=0);e="";0<t&&(e=e+" "+t+" day",e=1<t?e+"s":e);0<n&&(e=e+" "+n+" hour",e=1<n?e+"s":e);0<o&&(e=e+" "+o+" minute",e=1<o?e+"s":e);return e}(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?y.end_times[t].disabled=1:y.end_times[t].duration="( "+n+" )"):y.end_times[t].duration=""}))}s.back=function(){_.history.back()},s.test=function(){y.new_booking.instructor={id:90,first_name:"A",last_name:"REYNIER"}},s.updateEvents=function(e,t){g.GetAll(y.user.id,e,t).then(function(e){return s.all_events=e.events,s.all_resources=e.resources,e})},s.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),p(t)(s)},s.alertOnClicked=function(e,t,n){y.see_booking=e,y.see_booking.start_date=moment(y.see_booking.start).format("DD/MM/YYYY"),y.see_booking.end_date=moment(y.see_booking.end).format("DD/MM/YYYY"),y.see_booking.start_time=moment(y.see_booking.start).format("HH:mm"),y.see_booking.end_time=moment(y.see_booking.end).format("HH:mm"),y.see_booking.start_datetime=new Date(new Date(y.see_booking.start).toUTCString()),y.see_booking.end_datetime=new Date(y.see_booking.end),y.see_booking.visible=1,y.see_booking.after_booking_end=moment().isAfter(moment(y.see_booking.end)),s.$apply()},s.close_details=function(){y.see_booking.visible=0},s.changeLang=function(){s.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},s.changed=function(){s.check_plane_availability()},s.check_plane_availability=function(){U();var o=1==y.new_booking.edit_booking?1:0,e=0<y.new_booking.plane_id?y.new_booking.plane_id:0;y.new_booking.plane&&y.new_booking.plane.id&&(e=y.new_booking.plane.id),g.GetAllPlanes(y.user.id,y.new_booking.start_datetime,y.new_booking.end_datetime,0,e).then(function(e){if(y.planes=e,1==o)for(var t=0;t<y.planes.length;t++)y.planes[t].id==y.new_booking.plane.id&&(n=0,y.new_booking.plane=y.planes[t],s.check_rental_items());else{var n=1;if(y.new_booking.plane){for(t=0;t<y.planes.length;t++)y.planes[t].id==y.new_booking.plane.id&&(n=0,s.check_rental_items());1==n&&(y.new_booking.plane={},delete y.new_booking.plane)}}})},s.events=[],s.addOne=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;e&&!n&&(n=moment(e).add(1,"hour").format()),c.go("dashboard.bookings.add",{start:e,plane_id:t,end:n})},s.cancel_changes=function(){c.go("dashboard.bookings.add")},s.check_rental_items=function(){var e;U(),y.rental_items=[],y.new_booking.plane&&(e=(1==y.new_booking.edit_booking?y.new_booking:y.new_booking.plane).club_id,g.GetRentalItems(e,moment(y.new_booking.start_datetime).format("Y-M-D HH:mm"),moment(y.new_booking.end_datetime).format("Y-M-D HH:mm"),0).then(function(e){if(y.rental_items=e,y.new_booking.rental_items)for(var t=0;t<y.new_booking.rental_items;t++){for(var n=0,o=0;o<y.rental_items.length;o++)if(y.rental_items[o].id==y.new_booking.rental_items[t].id){parseInt(y.new_booking.rental_items[t].number_to_book)>parseInt(y.rental_items[o].number_available)&&(y.new_booking.rental_items[t].number_to_book=parseInt(y.rental_items[o].number_available)),y.new_booking.rental_items[t].number_available=parseInt(y.rental_items[o].number_available),n=1;break}0==n&&delete y.new_booking.rental_items[t]}for(var i=0;i<y.rental_items.length;i++)y.rental_items[i].number=0;if(y.new_booking.rental_items)for(o=0;o<y.new_booking.rental_items;o++){for(var r=1,t=0;t<y.rental_items.length;t++)y.rental_items[t].id==y.new_booking.rental_items[o].id&&(r=0);1==r&&delete y.new_booking.rental_items[o]}}))},s.update_dateTime=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;switch(e){case"start_date":G(),y.new_booking.start_date>y.new_booking.end_date&&(y.new_booking.end_date=y.new_booking.start_date),B(R(y.new_booking.start_date),"start_times"),x(),F()&&L();break;case"end_date":G(),x(),y.new_booking.end_date<y.new_booking.start_date?(y.new_booking.start_date=y.new_booking.end_date,B(R(y.new_booking.start_date),"start_times")):(B(R(y.new_booking.start_date),"start_times"),B(R(y.new_booking.end_date,"end"),"end_times")),F()&&L();break;case"start_time":G(),x(),A();break;case"end_time":"past"==y.times_clean_type?x("edit"):x();break;case"edit":y.times_clean_type="start_times",moment(y.new_booking.start).unix()<moment().unix()?y.times_clean_type="past":(x(),G()),A(),setTimeout(function(){O()},500);break;case"edit2":G(),B(R(y.new_booking.start_date),"start_times"),x(),A(),setTimeout(function(){if(O(),t)for(var e=0;e<y.planes.length;e++)parseInt(y.planes[e].id)==t&&(y.new_booking.plane=y.planes[e],s.getPlaneInstructors(y.new_booking.plane.id),s.$apply())},500)}s.check_plane_availability(),y.new_booking.plane&&s.check_rental_items(),y.new_booking.plane&&s.getPlaneInstructors()},s.update_booking=function(e){if(U(),e){e={};if(delete(e=jQuery.extend(!0,{},y.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,delete e.after_booking_end,e.free_seats=y.new_booking.free_seats.constructor===Array?0:y.new_booking.free_seats,e.start=y.new_booking.start_datetime,e.end=y.new_booking.end_datetime,e.course_id=y.new_booking.tuition_required.id,moment(Date.parse(y.new_booking.end_datetime)).add(1,"hour").isBefore())return k.warning("Past Booking","This booking ends in the past by more than an hour - you cannot amend a booking that finished in the past."),!1;e.resourceId=y.new_booking.plane.id,-1<y.new_booking.plane.id.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=y.new_booking.plane.id.slice(0,-1)),y.booking_self?(e.user_id=y.user.id,e.instructor_id=y.new_booking.instructor?y.new_booking.instructor.id:0):(e.user_id=y.new_booking.user.user_id,e.instructor_id=(y.new_booking.instructor||y.user).id),e.plane_id=y.new_booking.plane.id,e.override=y.new_booking.override||0,e.club_id=y.new_booking.plane.club_id,M(e)}},s.update_club=function(){y.club_id=y.change_club.id,-1<y.user.access.instructor.indexOf(y.club_id)||-1<y.user.access.manager.indexOf(y.club_id)?y.booking_self=!1:y.booking_self=!0,D()},s.alertOnEventClick=function(e,t,n){s.alertMessage=e.title+" was clicked "},s.alertOnDrop=function(e,t,n,o,i,r){-1<e.resourceId.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=e.resourceId.slice(0,-1)),M(e)},s.alertOnResize=function(e,t,n,o,i,r){M(e)},s.override_booking_change=function(e){y.error_event[e]=!0,M(y.error_event,!0)},s.decline_booking_change=function(){y.booking_errors={},y.error_event={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},s.wholeDay=function(){1==s.whole_day_booking?(s.whole_day_booking=!1,s.myDatetimeRange.time.from=480,s.myDatetimeRange.time.to=1080):(s.whole_day_booking=!0,s.myDatetimeRange.time.from=0,s.myDatetimeRange.time.to=1440)},s.changeView=function(e,t){f.calendars[t].fullCalendar("changeView",e)},s.renderCalender=function(e){m(function(){f.calendars[e]&&f.calendars[e].fullCalendar("render")})},s.add_rental_item=function(){if(y.rental_item&&y.new_booking.rental_items&&y.rental_item.id){for(var e=1,t=0;t<y.new_booking.rental_items.length;t++)y.new_booking.rental_items[t].id==y.rental_item.id&&(e=0,y.new_booking.rental_items[t]);1==e&&(y.new_booking.rental_items.push(y.rental_item),delete y.rental_item)}else y.rental_item&&(y.new_booking.rental_items||(y.new_booking.rental_items=[]),y.new_booking.rental_items.push(y.rental_item),delete y.rental_item)},s.rental_item_remove=function(t){y.new_booking.rental_items=$.grep(y.new_booking.rental_items,function(e){return e.id!=t})},s.getPlaneInstructors=function(){var e=parseInt(y.new_booking.plane.club_id)||y.club_id;y.club_id=e,-1<y.user.access.instructor.indexOf(e)||-1<y.user.access.manager.indexOf(e)?(y.booking_self=!1,T()):y.booking_self=!0,-1<y.user.access.manager.indexOf(e)?y.booking_admin=!0:y.booking_admin=!1,y.init_passengers(),s.check_rental_items(),"add"==y.action?g.GetPlaneInstructors(y.user.id,y.new_booking.plane.id,y.new_booking.start_datetime,y.new_booking.end_datetime,y.booking_self?0:1).then(function(e){y.instructors=e;var t=1;if(y.new_booking.instructor){for(var n=0;n<y.instructors.length;n++)y.instructors[n].id==y.new_booking.instructor.id&&(t=0);1==t&&(y.new_booking.instructor={},delete y.new_booking.instructor)}P()}):g.GetPlaneInstructorsEdit(y.user.id,y.new_booking.plane.id,y.new_booking.start_datetime,y.new_booking.end_datetime,y.booking_self?0:1,y.new_booking.id).then(function(e){y.instructors=e;var t=1;if(y.new_booking.instructor){for(var n=0;n<y.instructors.length;n++)y.instructors[n].id==y.new_booking.instructor.id&&(t=0);1==t&&(y.new_booking.instructor={},delete y.new_booking.instructor)}P()}),h.GetCoursesByClubId(y.new_booking.plane.club_id).then(function(e){y.courses=e.items}),g.GetIfCurrent(y.user_id,y.new_booking.plane.id,y.new_booking.end_datetime).then(function(e){e.success&&(y.is_current=e.is_current,y.currency_type=e.requirements.currency_type,y.currency_days=e.requirements.currency_days)})},s.clear_booking=function(){y.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],instructor:void 0,options:y.dateTimeRangePickerOptions},s.submitted=!1},y.seats_in_plane=function(){P();var e=y.new_booking.plane.seats;return y.new_booking.instructor&&e--,--e},y.adding_a_member=function(){y.init_passengers()},y.init_passengers=function(){y.seats_in_plane();y.new_booking.passengers.push({first_name:"",last_name:"",email:"",status:""})};function T(e,t){e=0<arguments.length&&void 0!==e?e:null,t=1<arguments.length&&void 0!==t?t:null,e=e||y.club_id,t=t||y.new_booking.end_datetime;0<e&&t&&o.GetAllActiveByClub(e,t).then(function(e){-1<y.user.access.instructor.indexOf(y.club_id)&&(y.booking_self=!1),y.members=e,y.new_booking.instructor&&y.new_booking.instructor.id==y.user.id&&(y.booking_self=!1),y.new_booking.user||(y.new_booking.user=y.members.find(function(e,t){if(e.user_id==y.new_booking.user_id)return!0}));for(var t=0;t<y.members.length;t++)y.members[t].is_member=!0})}function U(){var e=new Date(y.new_booking.start_date),t=new Date,n=y.new_booking.start_time?y.new_booking.start_time.time.split(":"):[t.getHours(),t.getMinutes()];e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0);n=new Date(y.new_booking.end_date),t=y.new_booking.end_time?y.new_booking.end_time.time.split(":"):[t.getHours(),t.getMinutes()];n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(0),y.new_booking.start_datetime=moment(e).format("Y-M-D HH:mm"),y.new_booking.end_datetime=moment(n).format("Y-M-D HH:mm")}function E(e,t,n){var o=1<arguments.length&&void 0!==t?t:null,i=2<arguments.length&&void 0!==n?n:0,o=parseInt(o);e=parseInt(e);var r=0;return y.new_booking.options.business_hours&&(t=y.new_booking.options.business_hours.from.split(":"),n=y.new_booking.options.business_hours.to.split(":"),0==i||(n[0]=parseInt(n[0])-1),o||0==o?((e<parseInt(t[0])||e==parseInt(t[0])&&o<parseInt(t[1]))&&(r=1),(e>parseInt(n[0])||e==parseInt(n[0])&&o>parseInt(n[1]))&&(r=1)):(parseInt(t[0])<e&&(r=1),parseInt(n[0])>e&&(r=1))),r}function B(e,n,t){var o,i=2<arguments.length&&void 0!==t?t:null;switch(e){case"today":o=new Date;break;case"past":case"future":o=new Date("1990-07-26");break;case"after":case"before":o=new Date(i)}var r=new Date(y.new_booking.start_date);y[n].forEach(function(e,t){e=e.time.split(":");r.setHours(e[0]),r.setMinutes(e[1]),r.setSeconds(0),moment(r).isAfter(moment(o))?y[n][t].disabled=E(parseInt(e[0]),parseInt(e[1]),"start_times"==n?1:0):y[n][t].disabled=1}),A()}function L(){var e=y.new_booking.start_time.time.split(":"),t=new Date(y.new_booking.start_date);t.setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0);moment(t).add(1,"hour").format();23<=parseInt(e[0])?moment(y.new_booking.start_date).isSame(moment(y.new_booking.end_date))&&(y.new_booking.end_date=new Date(moment(y.new_booking.end_date).add(1,"day").format()),B("future","end_times"),y.new_booking.end_time=y.end_times[0]):B("after","end_times",t)}function F(){var e,t,n,o=!1;return y.new_booking.end_time&&(e=new Date(y.new_booking.start_date),n=y.new_booking.start_time.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date(y.new_booking.end_date),n=y.new_booking.end_time.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),(moment(e).isAfter(moment(t))||moment(e).isSame(t)||t==e)&&(o=!0)),o}function G(){var e,t;moment(y.new_booking.start_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")?B("today","start_times"):moment(y.new_booking.start_date).isAfter(moment())&&B("future","start_times"),moment(y.new_booking.end_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(y.new_booking.start_time&&L(),B(R(y.new_booking.start_date),"end_times")),y.new_booking.end_date==y.new_booking.start_date&&y.new_booking.start_time&&(e=y.new_booking.start_time.time.split(":"),(t=new Date(y.new_booking.start_date)).setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0),F()?(B(R(y.new_booking.start_date),"start_times"),B(R(y.new_booking.end_date,"end"),"end_times",t),L()):B(R(y.new_booking.end_date,"end"),"end_times",t))}function R(e,t){var n=1<arguments.length&&void 0!==t?t:"start",t="today";return moment(moment(e).format("YYYY/MM/DD")).isAfter(moment().format("YYYY/MM/DD"))?(t="future",y.new_booking.start_date&&y.new_booking.end_date&&"end"==n&&moment(y.new_booking.start_date).isSame(moment(y.new_booking.end_date))&&(t="after")):t=moment(e).format("YYYY/MM/DD")==moment().format("YYYY/MM/DD")?"start"==n?"today":"after":"past",t}y.new_passenger_invite_ready=function(e){if(!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(y.new_booking.passengers[e].email))return k.warning("Invalid Email","The email address appears to be incorrect - please double check the email address entered."),!1;y.new_booking.passengers[e].is_member=!1,y.new_booking.passengers[e].status="to_invite",y.init_passengers(),P(),y.show_new_passenger_invitation=!1},s.cancel_booking=function(t){"YES"==prompt("Are you sure you wish to cancel this booking? Please type YES in the box below to confirm.")?g.DeleteBooking(y.user.id,t).then(function(e){k.success("Booking Cancelled","The booking has been cancelled"),e.success?(c.go("dashboard.bookings.add"),s.all_events=$.grep(s.all_events,function(e){return e.id!=t}),$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",s.all_events)):k.error("Error","An error occurred")}):c.go("dashboard.bookings.add")},y.remove_invite=function(e){y.new_booking.passengers.splice(e,1),y.init_passengers()},y.remove_passenger=function(t){var e=y.new_booking.passengers[t];y.pax_invited(e)?g.DeleteInvitation(e,e.id).then(function(e){1==e.success?(y.new_booking.passengers.splice(t,1),y.init_passengers()):k.error("Error",e.message)}):(y.new_booking.passengers.splice(t,1),y.init_passengers())},y.resend_invitation=function(e){e=y.new_booking.passengers[e];g.ResendInvitation(e,e.id).then(function(e){1==e.success?k.success("Success",e.message):k.error("Error",e.message)})},y.pax_invited=function(e){return""!=e.status&&"to_invite"!=e.status},y.get_passenger_status=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"invited"==e.status?"This passenger has been invited but has not yet responded.":""},y.get_passenger_status_edit=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"member"==e.status?"This passenger is a member":"invited"==e.status?"This passenger has been invited but has not yet accepted.":""},y.invite_new_passenger=function(e){y.show_new_passenger_invitation=!0,y.new_pax=e},y.close_passenger_invitation=function(){y.new_pax=-1,y.show_new_passenger_invitation=!1},s.get_members=function(t,n){0!=y.club_id&&y.club_id||!y.new_booking.plane||!y.new_booking.plane.id||(y.club_id=y.new_booking.plane.club_id),2<t.length&&o.GetAllByClubAndName(y.club_id,t).then(function(e){e.success?(y.members=e.members,y.members.length<1&&(y.new_booking.passengers[n].not_found=!0,y.new_booking.passengers[n].email="",y.new_booking.passengers[n].status="",y.new_booking.passengers[n].first_name="",y.new_booking.passengers[n].last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)?y.new_booking.passengers[n].email=t:-1<t.indexOf(" ")?(e=t.split(" "),y.new_booking.passengers[n].first_name=e[0],y.new_booking.passengers[n].last_name=e[1]):y.new_booking.passengers[n].first_name=t)):(y.new_booking.passengers[n].status="",y.new_booking.passengers[n].email="",y.new_booking.passengers[n].first_name="",y.new_booking.passengers[n].last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)&&(y.new_booking.passengers[n].email=t,y.new_booking.passengers[n].not_found=!0))})},s.save=function(){"add"==y.action?s.create():(U(),s.update())},s.update=function(){var e=new Date;e.setHours(14),e.setMinutes(0),s.mytime=e},y.show_self_option=!1,s.select_plane=function(e){s.check_rental_items(),P(),-1<y.user.access.instructor.indexOf(y.club_id)||-1<y.user.access.manager.indexOf(y.club_id)?y.show_self_option=!0:y.show_self_option=!1,-1<y.user.access.instructor.indexOf(y.club_id)&&(y.booking_self=!1)},G(),l.start&&(y.new_booking.start_date=new Date(l.start),y.new_booking.end_date=new Date(l.start),y.new_booking.start_time={time:moment(l.start).format("HH:mm")},y.new_booking.end_time={time:moment(l.start).add(30,"minutes").format("HH:mm")},y.default_date=y.new_booking.start_date,setTimeout(function(){$("#calendar").fullCalendar("renderEvent",{id:"TEMP",title:"TEMPORARY",resourceId:7,start:"2021-03-21 19:30:00",end:"2021-03-21 21:00:00",editable:!1,color:"#FFcccc",opacity:"1"}),s.update_dateTime("edit2",l.plane_id)},1e3)),s.make_booking=function(e){if(s.submitted=!0,e){e={};return(delete(e=jQuery.extend(!0,{},y.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,delete e.user,moment(Date.parse(y.new_booking.start_datetime)).isBefore())?(k.warning("Past Booking","This booking ends in the past - you cannot create a booking in the past."),!1):moment(Date.parse(y.new_booking.start_datetime)).add(30,"minutes").isBefore()?(k.warning("Past Booking","This booking starts in the past - you cannot create a booking in the past."),!1):(e.override=y.new_booking.override||0,y.booking_self?(e.user_id=y.user.id,e.instructor_id=y.new_booking.instructor?y.new_booking.instructor.id:0):(e.user_id=y.new_booking.user.user_id,-1<y.user.access.manager.indexOf(y.club_id)?e.instructor_id=y.new_booking.instructor?y.new_booking.instructor.id:0:e.instructor_id=y.user.id,e.booked_by_admin_instructor=1,e.override=1),e.free_seats=y.new_booking.free_seats.constructor===Array?0:y.new_booking.free_seats,e.start=y.new_booking.start_datetime,e.end=y.new_booking.end_datetime,e.plane_id=y.new_booking.plane.id,e.club_id=y.new_booking.plane.club_id,e.booked_by=y.user.id,e.course_id=y.new_booking.tuition_required?y.new_booking.tuition_required.id:0,void g.Create(y.user.id,e).then(function(e){if(1==e.success)s.clear_booking(),g.GetAll(y.user.id,moment(y.new_booking.start_date).format("Y-M-D"),"").then(function(e){s.all_events=e.events,s.all_resources=e.resources,$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",s.all_events)}),c.go("dashboard.bookings.add");else{if(e.more&&0<e.more.length){for(var t="",n=0;n<e.more.length;n++)"differences_verified"==e.more[n].name&&(t+="\n - Your differences training sign-offs need to be verified by a member of staff. \n"),"licence_verified"==e.more[n].name&&(t+="\n - Your licence needs to be verified by a member of staff. \n"),"medical_verified"==e.more[n].name&&(t+="\n - Your medical needs to be verified by a member of staff. \n"),"medical"==e.more[n].name&&(t+="\n - You need to upload a copy of your medical. \n"),"licence"==e.more[n].name&&(t+="\n - You need to upload a copy of your licence. \n"),"differences"==e.more[n].name&&(t+="\n - You need to upload a copy of your differences training signed off. \n");e.message=e.message+t}k.error("Error",e.message)}}))}},s.popup2={opened:!1},s.popup3={opened:!1},s.popup4={opened:!1},s.open2=function(){s.popup2.opened=!0},s.open3=function(){s.popup3.opened=!0},s.open4=function(){s.popup4.opened=!0},s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return warning_msg}}}).result.then(function(t){u.info("PRESSED GO: "+t),o.Delete(t).then(function(){y.club.members=$.grep(y.club.members,function(e){return e.id!=t})})},function(){u.info("Modal dismissed at: "+new Date)})}}function BookoutController(n,e,t,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C,S,x,O,D){var M=this;M.user=r.globals.currentUser,M.user_id=M.user.id,M.booking={},M.wgs_n="51.51",M.wgs_e="0.12",M.change_booking={},M.show_change_plane=!1,M.bookout={start:!0,passengers:[],pic:{id:M.user_id}},M.reported_defects=[],M.can_authorise=!1,M.bookout.plane={id:12,registration:"G-BSXA",type:"PA28",current_tacho:5112.3,estimated_fuel:100,consumption:30,seats:4,last_tacho:3941.01,last_position:12},M.dateFormat="date:HH:mm 'on' dd/MM/yyyy",s.show_change_plane=function(){M.show_change_plane=!0},M.seats_in_plane=function(){var e=M.bookout.plane.seats;return M.bookout.pic.id!==M.user_id&&e--,0<M.bookout.passengers.length&&(e-=M.bookout.passengers.length),--e},M.init_passengers=function(){},s.amend_booking=function(){},s.accept_defects=function(){confirm("You accept to fly the aircraft despite known defect(s) which have been reported by previous pilots")&&(M.bookout.accept_defects=!0)},s.reject_defects=function(){confirm("Would you like to cancel this booking?")||(M.bookout.accept_defects=!1)},s.get_hours_from_decimal=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(1==t?"":"-")+n+":"+e},s.get_airfields=function(t){var e;2<t.length&&t.length<5&&k.GetAirfieldsByCode(t).then(function(e){e.success&&(M.airfields=e.airfields,0==M.airfields.length&&(M.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}),4<t.length&&(e=t.replace(/\s/g,"_"),k.GetAirfields(e).then(function(e){e.success&&(M.airfields=e.airfields,0==M.airfields.length&&(M.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}))};s.update_pic=function(){M.bookout.pic.user_id==M.user.id&&0<M.bookout.instructor_id||0<M.bookout.instructor_id&&(M.bookout.pic.user_id,M.bookout.instructor_id)},M.invite_new_passenger=function(e){M.new_pax&&""!==M.new_pax.email&&0==M.new_pax.is_member?(M.new_pax.invited_by=M.user.id,k.AddPassenger(M.new_pax,l.booking_id).then(function(e){e.success&&(D.success("Invitation Sent","The invitation has been sent successfully"),M.update_passenger_list(),M.show_new_passenger_invitation=!1)})):D.warning("Invalid Email","Please enter a valid email address to send the invitation to.")},M.add_new_passenger=function(e){M.new_pax.is_member?(M.new_pax.club_id=M.club_id,M.new_pax.invited_by=M.user.id,k.AddPassenger(M.new_pax,l.booking_id).then(function(e){e.success&&M.update_passenger_list()})):M.show_new_passenger_invitation=!0},M.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},M.close_passenger_invitation=function(){M.show_new_passenger_invitation=!1},s.get_members=function(t){0!=M.club_id&&M.club_id||!M.bookout.plane||!M.bookout.plane.id||(M.club_id=M.bookout.plane.club_id),2<t.length&&e.GetAllByClubAndName(M.club_id,t).then(function(e){e.success?(e=e.members.filter(function(t){return!M.bookout.passengers.find(function(e){return e.email===t.email})}),M.members=e,M.members.length<1&&(M.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)?M.new_pax.email=t:-1<t.indexOf(" ")?(e=t.split(" "),M.new_pax.first_name=e[0],M.new_pax.last_name=e[1]):M.new_pax.first_name=t)):(M.new_pax.status="",M.new_pax.email="",M.new_pax.first_name="",M.new_pax.last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)&&(M.new_pax.email=t,M.new_pax.not_found=!0))})};var I=function(){e.GetAllByClub(M.club_id).then(function(e){M.members=e;for(var t=0;t<M.members.length;t++)M.members[t].is_member=!0})};function P(e,n,t){var o,i=2<arguments.length&&void 0!==t?t:null;switch(e){case"today":o=new Date;break;case"past":case"future":o=new Date("1990-07-26");break;case"after":case"before":o=new Date(i)}var r=new Date;M[n].forEach(function(e,t){e=e.time.split(":");r.setHours(e[0]),r.setMinutes(e[1]),r.setSeconds(0),moment(r).isAfter(moment(o))?M[n][t].disabled=0:M[n][t].disabled=1})}I(),M.invite_passenger=function(e,t){n.InvitePassenger(M.bookout.passengers[t].email,M.user_id,M.club_id,9,M.bookout.booking_id).then(function(e){M.bookout.passengers[t].status=e.invite.status,M.bookout.passengers[t].invitation_token=e.invite.invitation_token})},M.refresh_passenger=function(e,t){n.GetInvite(M.bookout.passengers[t].invitation_token).then(function(e){M.bookout.passengers[t].status=e.status,M.bookout.passengers[t].user_id=e.user_id,M.bookout.passengers[t].first_name=e.first_name,M.bookout.passengers[t].last_name=e.last_name})},M.update_passenger_list=function(){k.GetPassengers(l.booking_id).then(function(e){e.success&&(M.bookout.passengers=e.passengers,M.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0})})},M.resend_invitation=function(e){b.ResendInvitation(e,e.id).then(function(e){1==e.success?D.success("Success",e.message):D.error("Error",e.message)})},M.refresh_all_passenger=function(){var t=0;++t<M.bookout.passengers.length&&M.bookout.passengers[t]&&"invited"==M.bookout.passengers[t].status&&""!==M.bookout.passengers[t].invitation_token&&n.GetInvite(M.bookout.passengers[t].invitation_token).then(function(e){M.bookout.passengers[t].status=e.status,M.bookout.passengers[t].user_id=e.user_id,M.bookout.passengers[t].first_name=e.first_name,M.bookout.passengers[t].last_name=e.last_name})},M.get_passenger_status=function(e){if(e)return e.is_member?"OK - is already club member":"accepted"==e.status?"OK - passenger has accepted the terms":"declined"==e.status?"NO - passenger declined the offer":"invited"==e.status?"Waiting for user response":""},M.pics=[],M.flight_types=[{id:1,title:"Local"},{id:2,title:"Departure"},{id:3,title:"Circuits"},{id:4,title:"Other"}],M.biggin_hill={routes:[{id:1,title:"Kenley"},{id:2,title:"Sevenoaks"},{id:3,title:"Swanley"},{id:4,title:"Other"}],parking:""},M.flight_rules=[{id:1,title:"VFR"},{id:2,title:"IFR"}],M.start_times=[],M.all_times=[];for(var A=0;A<24;A++){for(var T=0;T<12;T++)M.start_times.push({time:A+":"+(U=((U=5*T)<10?"0":"")+U),disabled:!1});for(var U,T=0;T<6;T++)M.all_times.push({time:A+":"+(U=((U=10*T)<10?"0":"")+U),disabled:!1})}switch(P("today","start_times"),P("future","all_times"),M.init_passengers(),M.currency_days=28,M.extra_information_required=!1,M.filing_flightplan=!1,M.instructor_charges=[],M.club={plane:{}},c.current.data.action){case"add":b.GetForBookout(M.user.id,l.booking_id).then(function(t){t.success&&(M.booking=t.booking,e.GetAllByPicsBookinout(t.booking.id,t.booking.club_id,M.user.id).then(function(e){w.GetByIdMaintenance(M.booking.plane.id,t.booking.club_id).then(function(e){M.club.plane=e,function(){var e=M.club.plane;e.maintenance&&(s.status.days=0<e.maintenance.days_remaining?"ok":"expired",s.status.hours=0<e.maintenance.hours_remaining?"ok":"expired");s.status.certificate=0<e.certificate.days_to_expiry?"ok":"expired",s.status.insurance=0<e.insurance.days_to_expiry?"ok":"expired",s.status.radio_licence=0<e.radio_licence.days_to_expiry?"ok":"expired"}()}),M.pics=e,function(t){M.bookout.booking_id=t.id,M.bookout.club_id=t.club_id,M.bookout.user_id=t.user_id,M.bookout.plane=t.plane,M.club_id=t.club_id,M.bookout.lesson_id=l.lesson_id||0,M.bookout.return=new Date(t.end),M.bookout.booking_start=new Date(t.start),(-1<M.user.access.instructor.indexOf(M.club_id)||-1<M.user.access.manager.indexOf(M.club_id))&&(M.can_authorise=!0);{var e;w.GetOpenIssues(t.plane.id).then(function(e){M.reported_defects=e}),I(),t.instructor&&0<t.instructor.id?(n=M.pics.find(function(e){return e.user_id===t.instructor.id}),M.bookout.pic=n,M.bookout.instructor_id=t.instructor.id,M.bookout.instructor=t.instructor,M.bookout.course_id=t.course_id,M.bookout.tuition_required=t.tuition_required,O.GetCoursesByClubId(M.bookout.club_id).then(function(e){M.courses=e.items,M.bookout.selected_course=M.courses.find(function(e,t){if(e.id==M.bookout.course_id)return!0}),M.update_course()}),e=M.pics.find(function(e){return e.user_id===t.user_id}),M.bookout.put=e):(n=M.pics.find(function(e){return e.user_id===t.user_id}),M.bookout.pic=n)}M.bookout.passengers=t.passengers,M.init_passengers(),t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.wgs_n&&(M.wgs_n=t.plane_details.location.wgs_n,M.wgs_e=t.plane_details.location.wgs_e);var n="";n=t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.code?t.plane_details.location.code.slice(0,-1):"EG";k.GetAirfieldsByCode(n).then(function(e){e.success&&(M.airfields=e.airfields,e=M.airfields.find(function(e){return e.id===t.plane_details.location.id}),M.bookout.from_airfield=e)})}(t.booking)}))});break;case"edit":h.GetById(l.licence_id).then(function(e){if(e.success){M.licence=e.licence,M.licence.licence_issue_date=new Date(M.licence.licence_issue_date),M.licence.licence_expiry_date=new Date(M.licence.licence_expiry_date),M.licence.licence_type=$.grep(M.licence_types,function(e){return e.id==M.licence.licence_id})[0],M.licence.state_of_issue=$.grep(M.authority,function(e){return e.id==M.licence.authority_id})[0];for(var t=0;t<M.licence.ratings.length;t++)delete M.licence.ratings[t].id,M.licence.ratings[t].id=M.licence.ratings[t].rating_id,delete M.licence.ratings[t].rating_id,M.licence.ratings[t].test_date=new Date(M.licence.ratings[t].test_date),M.licence.ratings[t].expiry_date=new Date(M.licence.ratings[t].expiry_date),M.ratings=$.grep(M.ratings,function(e){return e.id!=M.licence.ratings[t].id})}});break;case"list":h.GetByUserId(M.user_id).then(function(e){e.success&&(M.user_licences=e.licences)})}s.show_file_now=!1,s.show_file_url="",s.show_file=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");C.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){D.error("Download Error","There was an error downloading the selected document(s)")})},s.close_file=function(){s.show_file_now=!1,s.show_file_url=""},s.applyFilter=function(e,t){if(t){var n=t.split(":"),o=n[0],t=[e];return 1<n.length?"date"==o.toLowerCase()&&t.push(n.slice(1).join(":")):t=t.concat(n.slice(1)),y(o).apply(this,t)}return e},s.status={days:"",hours:"",insurance:"",certificate:"",radio_licence:""},M.update_course=function(){M.bookout.selected_course&&0<M.bookout.selected_course.id?O.GetChargesByCourseId(M.bookout.selected_course.id).then(function(e){M.instructor_charges=e.items,1==M.instructor_charges.length&&(M.bookout.tuition_required=M.instructor_charges[0])}):v.GetByClubId(M.bookout.club_id).then(function(e){M.instructor_charges=e.items,1==M.instructor_charges.length&&(M.bookout.tuition_required=M.instructor_charges[0])})},s.selected_airfield_check=function(){150==M.bookout.from_airfield.id||M.bookout.to_airfield&&150==M.bookout.to_airfield.id?M.extra_information_required=!0:M.filing_flightplan||150===M.bookout.from_airfield.id||M.bookout.to_airfield&&M.bookout.to_airfield.id&&150===M.bookout.to_airfield.id||(M.extra_information_required=!1)},s.add_rating=function(){M.ratings=$.grep(M.ratings,function(e){return e.id!=M.selected_rating.id}),M.licence.ratings.push(M.selected_rating),delete M.selected_rating},s.remove_rating=function(e){M.ratings.push(M.licence.ratings[e]),M.licence.ratings.splice(e,1)},s.bookout_plane=function(){if(!M.bookout.flight_type||M.bookout.flight_type.id<1)return D.highlightField("flight_type"),D.warning("Flight Type","You need to select a flight type - is this a local flight? Or a departure?"),!1;if(!M.bookout.pic||M.bookout.pic.id<1)return D.highlightField("pic"),D.warning("Missing PIC","You need to select a Pilot In Command (PIC)"),!1;if((!M.bookout.is_current||0==M.bookout.is_current)&&M.bookout.instructor_id<1)return D.highlightField("is_current"),D.warning("Currency Check","Please confirm that you are current according to the club rules, as you do not have an instructor booked."),!1;if(2==M.bookout.flight_type.id&&(!M.bookout.to_airfield||M.bookout.to_airfield.id<1&&""==M.bookout.to_airfield.title))return D.highlightField("to_airfield"),D.warning("Missing Destination","As you selected this flight to be a departure, please select a destination airfield"),!1;if(!M.bookout.accept_defects&&0<M.reported_defects.length)return D.highlightField("accept_defects"),D.warning("Defects Acknowledgement","You must state that you have read the defects currently reported and accept to fly the plane in the condition provided prior to booking out the plane."),!1;M.refresh_all_passenger();for(var e=M.bookout.passengers,t=0;t<e.length;t++){if("to_invite"==e[t].status)return D.warning("Passenger Invite","You need to press the invitation button for your passenger who isn't already a member before booking out."),!1;if("invited"==e[t].status&&e[t].aboard)return D.warning("Passenger Status","You need to make sure that your passenger has completed his membership and has agreed to the terms of your flight before you go flying."),!1}var n={club_id:M.bookout.club_id,plane_id:M.bookout.plane.id,user_id:M.bookout.user_id,pic_id:M.bookout.pic.user_id,booking_id:M.bookout.booking_id,is_pilot_current:M.bookout.is_current,dual_flight:0<M.bookout.instructor_id&&M.bookout.pic.id==M.bookout.instructor.id?1:0,instructor_id:M.bookout.instructor_id,tuition_id:0<M.bookout.instructor_id&&M.bookout.tuition_required&&!M.bookout.authorised_solo?M.bookout.tuition_required.id:0,detail_type_id:M.bookout.flight_type.id,from_airport_id:M.bookout.from_airfield.id,to_airport_id:(1==M.bookout.flight_type.id||3==M.bookout.flight_type.id?M.bookout.from_airfield:M.bookout.to_airfield).id,booked_out:1,booked_in:0,flight_date:new Date(M.bookout.booking_start),passengers:M.bookout.passengers,authorised_solo:!!M.bookout.authorised_solo,authorised_by:M.bookout.authorised_solo?M.user.id:0,endurance_time:M.bookout.endurance,estimated_enroute_time:M.bookout.en_route,flight_rules:M.bookout.flight_rule,flight_notes:M.bookout.additional_details,parking_note:M.bookout.parking_note,estimated_departure:M.bookout.departure,routing_via_id:M.bookout.routing_via?M.bookout.routing_via.id:0,lesson_id:M.bookout.lesson_id||0};0==n.to_airport_id&&(n.new_to_airport=M.bookout.to_airfield,n.new_to_airport.title=n.new_to_airport.title.replace("NOT LISTED : ","")),0==n.from_airport_id&&(n.new_from_airport=M.bookout.from_airfield,n.new_from_airport.title=n.new_from_airport.title.replace("NOT LISTED : ","")),k.SendBookout(M.user.id,n).then(function(e){e.success?c.go("dashboard.my_account.booked_out",{booking_id:M.bookout.booking_id}):D.error("Bookout Failed","Something went wrong: "+(e.message||"Unknown error"))})},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){M.licence.images=$.grep(M.licence.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);h.DeleteTmp(e.saved_url).then(function(e){e.success&&(M.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,M.licence_images.push(e[t].file)}},s.delete_licence=function(t){"YES"==prompt("Are you sure you wish to delete this licence? \n\n This change is irreversible! To confirm please type YES in the box below.")&&h.Delete(M.user_id,t).then(function(e){e.success?(M.user_licences=$.grep(M.user_licences,function(e){return e.id!=t}),c.reload(),c.go("dashboard.my_account.licence")):D.error("Error",e.message)})},s.save_licence=function(e){if(M.licence_images.length<1&&M.licence.images.length<1)return $(".drop").focus(),D.warning("Missing Image","You must at least have 1 image of your licence!"),!1;if(!M.licence.licence_type)return $("#licence_type").focus(),D.warning("Missing Licence Type","You must select a licence type"),!1;if(!M.licence.state_of_issue)return $("#state_of_issue").focus(),D.warning("Missing State","You must select a licence state of issue"),!1;if(M.licence.ratings.length<1)return $("#ratings").focus(),D.warning("Missing Rating","You must at least have 1 rating!"),!1;for(var t=0;t<M.licence.images.length;t++)delete M.licence.images[t].data_uri;M.licence.images=M.licence.images.concat(M.licence_images),M.licence.licence_id=M.licence.licence_type.id,M.licence.authority_id=M.licence.state_of_issue.id,M.licence.user_id=M.user_id,delete M.licence.licence_type,delete M.licence.state_of_issue,M.licence.id?h.Update(M.licence).then(function(e){e.success?c.go("dashboard.my_account.licence",{},{reload:!0}):D.error("Error",e.message)}):h.Create(M.licence).then(function(e){e.success?(c.reload(),c.go("dashboard.my_account.licence",{},{reload:!0})):D.error("Error",e.message)})},s.logout=function(){x.Logout(function(e){x.ClearCredentials(),S.remove("globals"),S.remove("session");try{localStorage.removeItem("toaviate_return_url")}catch(e){}a.path("/login")})},s.go_flying=function(){c.go("dashboard.my_account",{},{reload:!0})}}function CategoriesController(e,n,t,o,i,r,a){var s=this;n.GetAll().then(function(e){s.cats=e}),s.id=1,s.myModel="Click here and delete me",a.myUpdateHandler=function(e,t){n.Update({id:e,title:t}).then(function(e){})},a.addCategory=function(){var e={title:s.new_category};n.Create(e).then(function(e){s.cats.push(e),s.new_category=""})},a.deleteCategory=function(t){n.Delete(t).then(function(e){s.cats=$.grep(s.cats,function(e){return e.id!=t})})}}function ClaimAFlightController(e,t,n,i,o,r){var a=this;a.user=n.globals.currentUser,a.unclaimed=[],a.looking_for=o.registration,a.activeView="aircraft",a.setView=function(e){a.activeView=e},a.aircraftList=[],a.selectedAircraft=null,a.allFlights=[],a.onAircraftSelected=function(e){a.selectedAircraft=e||null},a.clearAircraftFilter=function(){a.selectedAircraft=null},a.aircraftFilter=function(e){return!a.selectedAircraft||e.registration===a.selectedAircraft.registration},t.GetFoxEntries(n.globals.currentUser.id).then(function(e){a.unclaimed=e,a.aircraftList=[],a.allFlights=[],a.unclaimed&&a.unclaimed.to_claim&&(a.unclaimed.to_claim.forEach(function(n){(n.aircraft||[]).forEach(function(t){var e={plane_id:t.plane_id,registration:t.registration,plane_type:t.plane_type,club_name:n.club_name,label:t.registration+"  "+t.plane_type};a.aircraftList.push(e),(t.flights||[]).forEach(function(e){a.allFlights.push({registration:t.registration,plane_type:t.plane_type,club_name:n.club_name,flight_date:e.flight_date,brakes_time:e.brakes_time,plane_log_sheet_id:e.plane_log_sheet_id,brakes_off:e.brakes_off,brakes_on:e.brakes_on,from_airfield_code:e.from_airfield_code,from_airfield_name:e.from_airfield_name,to_airfield_code:e.to_airfield_code,to_airfield_name:e.to_airfield_name,airborne_seconds:e.airborne_seconds,number_landings:e.number_landings,takeoffs_landings:e.takeoffs_landings})})})}),a.allFlights.sort(function(e,t){e=new Date(e.flight_date+" "+(e.brakes_off||"00:00"));return new Date(t.flight_date+" "+(t.brakes_off||"00:00"))-e}),!a.looking_for||(e=a.aircraftList.filter(function(e){return-1!==e.registration.toLowerCase().indexOf(a.looking_for.toLowerCase())})).length&&(a.selectedAircraft=e[0]))}),i.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(i.my_search)||"")},i.search2=function(e){return-1!==angular.lowercase(e.registration).indexOf(angular.lowercase(i.my_search2)||"")},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},a.clean_times=function(e){return e.substring(0,5)},a.difference_times=function(e,t){e=moment(e),t=moment(t),t=moment.duration(t.diff(e)).asHours(),e=Math.floor(Math.abs(t)),t=Math.round(60*Math.abs(t)%60);return(e<10?"0":"")+e+":"+(t<10?"0":"")+t},a.difference_times_decimal=function(e,t){e=moment(e),t=moment(t);return moment.duration(t.diff(e)).asHours()},a.airborne_decimal=function(e){return e/60/60},a.airborne_to_hours=function(e){var t=e/60/60,e=Math.floor(Math.abs(t)),t=Math.round(60*Math.abs(t)%60);return 60==t&&(e+=1,t=0),(e<10?"0":"")+e+":"+(t<10?"0":"")+t},i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"}}function ClubDocumentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y){var v=this;switch(v.licence_images=[],v.documents=[],v.licence={images:[],ratings:[]},v.club_id=r.globals.currentUser.current_club_admin.id,v.user=r.globals.currentUser,v.user_id=v.user.id,v.uploaded_document={},c.current.data.action){case"add":break;case"edit":h.GetById(l.document_id).then(function(e){e.success&&(v.document=e.document,v.uploaded_document={file:v.document.document})});break;case"list":h.GetByClubId(v.club_id).then(function(e){e.success&&(v.club_documents=e.club_documents)})}s.add_rating=function(){v.ratings=$.grep(v.ratings,function(e){return e.id!=v.selected_rating.id}),v.licence.ratings.push(v.selected_rating),delete v.selected_rating},s.remove_rating=function(e){v.ratings.push(v.licence.ratings[e]),v.licence.ratings.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(v.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,v.documents.push(e[t].file)}},s.delete_licence=function(t){"YES"==prompt("Are you sure you wish to delete this licence? \n\n This change is irreversible! To confirm please type YES in the box below.")&&h.Delete(v.user_id,t).then(function(e){e.success?(v.club_documents=$.grep(v.club_documents,function(e){return e.id!=t}),c.reload(),c.go("dashboard.manage_club.documents")):y.error("Save Failed","Something went terribly wrong... "+e.message)})},s.save_licence=function(e){if(v.document.id){if((!v.documents||v.documents.length<1)&&(!v.document.document||""==v.document.document))return y.highlightField(".drop"),y.warning("Missing Document","You must at least have 1 pdf!"),!1}else if(!v.documents||v.documents.length<1)return y.highlightField(".drop"),y.warning("Missing Document","You must upload at least 1 file before saving!"),!1;if(!v.document.title||""===v.document.title.trim())return y.highlightField("doc_title"),y.warning("Title Required","Please enter a title for this document."),!1;var t;v.document.id?h.Update(v.document).then(function(e){e.success?c.go("dashboard.manage_club.documents",{},{reload:!0}):y.error("Save Failed","Something went terribly wrong... "+e.message)}):(t={my_file:v.documents[0],title:v.document.title,description:v.document.description,club_id:v.club_id},h.Create(t).then(function(e){e.success?(c.reload(),c.go("dashboard.manage_club.documents",{},{reload:!0})):y.error("Save Failed","Something went terribly wrong... "+e.message)}))};function w(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this document no other member will be able to see it."}}}).result.then(function(e){var t=e.id;u.info("PRESSED GO: ",t),h.Delete(v.user_id,t).then(function(e){e.success?(v.club_documents=$.grep(v.club_documents,function(e){return e.id!=t}),c.reload(),c.go("dashboard.manage_club.documents")):y.error("Delete Failed","Something went terribly wrong... "+e.message)})},function(){u.info("Modal dismissed at: "+new Date)})},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");k.get("api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){w(e,n)}).error(function(e,t){y.error("Download Failed","There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");k.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){w(e,n)}).error(function(e,t){y.error("Download Failed","There was an error downloading the selected document(s).")})}}function ClubPaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b){var h=this;switch(h.poid_images=[],h.poid={images:[]},h.user=r.globals.currentUser,h.user_id=h.user.id,h.customer_token="",s.get_addresses=function(){g.GetAddresses(h.postcode).then(function(e){e.success&&(h.addresses=e.addresses)})},c.current.data.action){case"add":break;case"edit":b.GetById(l.card_id).then(function(e){e.success&&(h.poid=e.poid,h.poid.expiry_date=new Date(h.poid.expiry_date))});break;case"list":g.GetByUserId(h.user_id).then(function(e){e.success&&(h.cards=e.cards)})}}function ClubSignupController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;a.companies=[],a.selected_company,a.selected_phone,a.verified_mobile=!1,a.text_verification="",_.check_id=12,a.link="",a.prefix="",a.countries=[{CountryCode:"+247",CountryCodeISO:"SH",Country:"Ascension"},{CountryCode:"+246",CountryCodeISO:"DG",Country:"Diego Garcia"},{CountryCode:"+291",CountryCodeISO:"ER",Country:"Eritrea"},{CountryCode:"+500",CountryCodeISO:"FK",Country:"Falkland (Malvinas) Islands"},{CountryCode:"+692",CountryCodeISO:"MH",Country:"Marshall Islands"},{CountryCode:"+691",CountryCodeISO:"FM",Country:"Micronesia"},{CountryCode:"+683",CountryCodeISO:"NU",Country:"Niue Island"},{CountryCode:"+290",CountryCodeISO:"SH",Country:"Saint Helena"},{CountryCode:"+508",CountryCodeISO:"PM",Country:"Saint Pierre and Miquelon"},{CountryCode:"+690",CountryCodeISO:"TK",Country:"Tokelau"},{CountryCode:"+688",CountryCodeISO:"TV",Country:"Tuvalu"},{CountryCode:"+379",CountryCodeISO:"VA",Country:"Vatican City"},{CountryCode:"+681",CountryCodeISO:"WF",Country:"Wallis and Futuna"},{CountryCode:"+1",CountryCodeISO:"AS",Country:"American Samoa"},{CountryCode:"+1",CountryCodeISO:"CA",Country:"Canada"},{CountryCode:"+61",CountryCodeISO:"AU",Country:"Australia"},{CountryCode:"+93",CountryCodeISO:"AF",Country:"Afghanistan"},{CountryCode:"+355",CountryCodeISO:"AL",Country:"Albania"},{CountryCode:"+213",CountryCodeISO:"DZ",Country:"Algeria"},{CountryCode:"+376",CountryCodeISO:"AD",Country:"Andorra"},{CountryCode:"+244",CountryCodeISO:"AO",Country:"Angola"},{CountryCode:"+54",CountryCodeISO:"AR",Country:"Argentina"},{CountryCode:"+374",CountryCodeISO:"AM",Country:"Armenia"},{CountryCode:"+297",CountryCodeISO:"AW",Country:"Aruba"},{CountryCode:"+43",CountryCodeISO:"AT",Country:"Austria"},{CountryCode:"+994",CountryCodeISO:"AZ",Country:"Azerbaijan"},{CountryCode:"+973",CountryCodeISO:"BH",Country:"Bahrain"},{CountryCode:"+880",CountryCodeISO:"BD",Country:"Bangladesh"},{CountryCode:"+375",CountryCodeISO:"BY",Country:"Belarus"},{CountryCode:"+32",CountryCodeISO:"BE",Country:"Belgium"},{CountryCode:"+501",CountryCodeISO:"BZ",Country:"Belize"},{CountryCode:"+229",CountryCodeISO:"BJ",Country:"Benin"},{CountryCode:"+975",CountryCodeISO:"BT",Country:"Bhutan"},{CountryCode:"+591",CountryCodeISO:"BO",Country:"Bolivia"},{CountryCode:"+387",CountryCodeISO:"BA",Country:"Bosnia and Herzegovina"},{CountryCode:"+267",CountryCodeISO:"BW",Country:"Botswana"},{CountryCode:"+55",CountryCodeISO:"BR",Country:"Brazil"},{CountryCode:"+673",CountryCodeISO:"BN",Country:"Brunei"},{CountryCode:"+359",CountryCodeISO:"BG",Country:"Bulgaria"},{CountryCode:"+226",CountryCodeISO:"BF",Country:"Burkina Faso"},{CountryCode:"+257",CountryCodeISO:"BI",Country:"Burundi"},{CountryCode:"+855",CountryCodeISO:"KH",Country:"Cambodia"},{CountryCode:"+237",CountryCodeISO:"CM",Country:"Cameroon"},{CountryCode:"+238",CountryCodeISO:"CV",Country:"Cape Verde"},{CountryCode:"+236",CountryCodeISO:"CF",Country:"Central African Republic"},{CountryCode:"+235",CountryCodeISO:"TD",Country:"Chad"},{CountryCode:"+56",CountryCodeISO:"CL",Country:"Chile"},{CountryCode:"+86",CountryCodeISO:"CN",Country:"China"},{CountryCode:"+57",CountryCodeISO:"CO",Country:"Colombia"},{CountryCode:"+269",CountryCodeISO:"KM",Country:"Comoros"},{CountryCode:"+242",CountryCodeISO:"CG",Country:"Congo"},{CountryCode:"+682",CountryCodeISO:"CK",Country:"Cook Islands"},{CountryCode:"+506",CountryCodeISO:"CR",Country:"Costa Rica"},{CountryCode:"+385",CountryCodeISO:"HR",Country:"Croatia"},{CountryCode:"+53",CountryCodeISO:"CU",Country:"Cuba"},{CountryCode:"+357",CountryCodeISO:"CY",Country:"Cyprus"},{CountryCode:"+420",CountryCodeISO:"CZ",Country:"Czech Republic"},{CountryCode:"+243",CountryCodeISO:"CD",Country:"Democratic Republic of Congo"},{CountryCode:"+45",CountryCodeISO:"DK",Country:"Denmark"},{CountryCode:"+253",CountryCodeISO:"DJ",Country:"Djibouti"},{CountryCode:"+670",CountryCodeISO:"TL",Country:"East Timor"},{CountryCode:"+593",CountryCodeISO:"EC",Country:"Ecuador"},{CountryCode:"+20",CountryCodeISO:"EG",Country:"Egypt"},{CountryCode:"+503",CountryCodeISO:"SV",Country:"El Salvador"},{CountryCode:"+240",CountryCodeISO:"GQ",Country:"Equatorial Guinea"},{CountryCode:"+372",CountryCodeISO:"EE",Country:"Estonia"},{CountryCode:"+251",CountryCodeISO:"ET",Country:"Ethiopia"},{CountryCode:"+298",CountryCodeISO:"FO",Country:"Faroe Islands"},{CountryCode:"+679",CountryCodeISO:"FJ",Country:"Fiji"},{CountryCode:"+358",CountryCodeISO:"FI",Country:"Finland"},{CountryCode:"+33",CountryCodeISO:"FR",Country:"France"},{CountryCode:"+594",CountryCodeISO:"GF",Country:"French Guiana"},{CountryCode:"+689",CountryCodeISO:"PF",Country:"French Polynesia"},{CountryCode:"+241",CountryCodeISO:"GA",Country:"Gabon"},{CountryCode:"+220",CountryCodeISO:"GM",Country:"Gambia"},{CountryCode:"+995",CountryCodeISO:"GE",Country:"Georgia"},{CountryCode:"+49",CountryCodeISO:"DE",Country:"Germany"},{CountryCode:"+233",CountryCodeISO:"GH",Country:"Ghana"},{CountryCode:"+350",CountryCodeISO:"GI",Country:"Gibraltar"},{CountryCode:"+30",CountryCodeISO:"GR",Country:"Greece"},{CountryCode:"+299",CountryCodeISO:"GL",Country:"Greenland"},{CountryCode:"+590",CountryCodeISO:"GP",Country:"Guadeloupe"},{CountryCode:"+502",CountryCodeISO:"GT",Country:"Guatemala"},{CountryCode:"+224",CountryCodeISO:"GN",Country:"Guinea"},{CountryCode:"+245",CountryCodeISO:"GW",Country:"Guinea-Bissau"},{CountryCode:"+592",CountryCodeISO:"GY",Country:"Guyana"},{CountryCode:"+509",CountryCodeISO:"HT",Country:"Haiti"},{CountryCode:"+504",CountryCodeISO:"HN",Country:"Honduras"},{CountryCode:"+852",CountryCodeISO:"HK",Country:"Hong Kong"},{CountryCode:"+36",CountryCodeISO:"HU",Country:"Hungary"},{CountryCode:"+354",CountryCodeISO:"IS",Country:"Iceland"},{CountryCode:"+91",CountryCodeISO:"IN",Country:"India"},{CountryCode:"+62",CountryCodeISO:"ID",Country:"Indonesia"},{CountryCode:"+98",CountryCodeISO:"IR",Country:"Iran"},{CountryCode:"+964",CountryCodeISO:"IQ",Country:"Iraq"},{CountryCode:"+353",CountryCodeISO:"IE",Country:"Ireland"},{CountryCode:"+972",CountryCodeISO:"IL",Country:"Israel"},{CountryCode:"+39",CountryCodeISO:"IT",Country:"Italy"},{CountryCode:"+225",CountryCodeISO:"CI",Country:"Ivory Coast"},{CountryCode:"+81",CountryCodeISO:"JP",Country:"Japan"},{CountryCode:"+962",CountryCodeISO:"JO",Country:"Jordan"},{CountryCode:"+254",CountryCodeISO:"KE",Country:"Kenya"},{CountryCode:"+686",CountryCodeISO:"KI",Country:"Kiribati"},{CountryCode:"+965",CountryCodeISO:"KW",Country:"Kuwait"},{CountryCode:"+996",CountryCodeISO:"KG",Country:"Kyrgyzstan"},{CountryCode:"+856",CountryCodeISO:"LA",Country:"Laos"},{CountryCode:"+371",CountryCodeISO:"LV",Country:"Latvia"},{CountryCode:"+961",CountryCodeISO:"LB",Country:"Lebanon"},{CountryCode:"+266",CountryCodeISO:"LS",Country:"Lesotho"},{CountryCode:"+231",CountryCodeISO:"LR",Country:"Liberia"},{CountryCode:"+218",CountryCodeISO:"LY",Country:"Libya"},{CountryCode:"+423",CountryCodeISO:"LI",Country:"Liechtenstein"},{CountryCode:"+370",CountryCodeISO:"LT",Country:"Lithuania"},{CountryCode:"+352",CountryCodeISO:"LU",Country:"Luxembourg"},{CountryCode:"+853",CountryCodeISO:"MO",Country:"Macau"},{CountryCode:"+389",CountryCodeISO:"MK",Country:"Macedonia"},{CountryCode:"+261",CountryCodeISO:"MG",Country:"Madagascar"},{CountryCode:"+265",CountryCodeISO:"MW",Country:"Malawi"},{CountryCode:"+60",CountryCodeISO:"MY",Country:"Malaysia"},{CountryCode:"+960",CountryCodeISO:"MV",Country:"Maldives"},{CountryCode:"+223",CountryCodeISO:"ML",Country:"Mali"},{CountryCode:"+356",CountryCodeISO:"MT",Country:"Malta"},{CountryCode:"+596",CountryCodeISO:"MQ",Country:"Martinique"},{CountryCode:"+222",CountryCodeISO:"MR",Country:"Mauritania"},{CountryCode:"+230",CountryCodeISO:"MU",Country:"Mauritius"},{CountryCode:"+262",CountryCodeISO:"RE",Country:"Reunion"},{CountryCode:"+52",CountryCodeISO:"MX",Country:"Mexico"},{CountryCode:"+373",CountryCodeISO:"MD",Country:"Moldova"},{CountryCode:"+377",CountryCodeISO:"MC",Country:"Monaco"},{CountryCode:"+976",CountryCodeISO:"MN",Country:"Mongolia"},{CountryCode:"+382",CountryCodeISO:"ME",Country:"Montenegro"},{CountryCode:"+212",CountryCodeISO:"MA",Country:"Morocco"},{CountryCode:"+258",CountryCodeISO:"MZ",Country:"Mozambique"},{CountryCode:"+95",CountryCodeISO:"MM",Country:"Myanmar"},{CountryCode:"+264",CountryCodeISO:"NA",Country:"Namibia"},{CountryCode:"+674",CountryCodeISO:"NR",Country:"Nauru"},{CountryCode:"+977",CountryCodeISO:"NP",Country:"Nepal"},{CountryCode:"+31",CountryCodeISO:"NL",Country:"Netherlands"},{CountryCode:"+599",CountryCodeISO:"AN",Country:"Netherlands Antilles"},{CountryCode:"+687",CountryCodeISO:"NC",Country:"New Caledonia"},{CountryCode:"+64",CountryCodeISO:"NZ",Country:"New Zealand"},{CountryCode:"+505",CountryCodeISO:"NI",Country:"Nicaragua"},{CountryCode:"+227",CountryCodeISO:"NE",Country:"Niger"},{CountryCode:"+234",CountryCodeISO:"NG",Country:"Nigeria"},{CountryCode:"+850",CountryCodeISO:"KP",Country:"North Korea"},{CountryCode:"+47",CountryCodeISO:"NO",Country:"Norway"},{CountryCode:"+968",CountryCodeISO:"OM",Country:"Oman"},{CountryCode:"+92",CountryCodeISO:"PK",Country:"Pakistan"},{CountryCode:"+680",CountryCodeISO:"PW",Country:"Palau"},{CountryCode:"+507",CountryCodeISO:"PA",Country:"Panama"},{CountryCode:"+675",CountryCodeISO:"PG",Country:"Papua New Guinea"},{CountryCode:"+595",CountryCodeISO:"PY",Country:"Paraguay"},{CountryCode:"+51",CountryCodeISO:"PE",Country:"Peru"},{CountryCode:"+63",CountryCodeISO:"PH",Country:"Philippines"},{CountryCode:"+48",CountryCodeISO:"PL",Country:"Poland"},{CountryCode:"+351",CountryCodeISO:"PT",Country:"Portugal"},{CountryCode:"+974",CountryCodeISO:"QA",Country:"Qatar"},{CountryCode:"+40",CountryCodeISO:"RO",Country:"Romania"},{CountryCode:"+7",CountryCodeISO:"KZ",Country:"Kazakhstan"},{CountryCode:"+250",CountryCodeISO:"RW",Country:"Rwanda"},{CountryCode:"+685",CountryCodeISO:"WS",Country:"Samoa"},{CountryCode:"+378",CountryCodeISO:"SM",Country:"San Marino"},{CountryCode:"+239",CountryCodeISO:"ST",Country:"Sao Tome and Principe"},{CountryCode:"+966",CountryCodeISO:"SA",Country:"Saudi Arabia"},{CountryCode:"+221",CountryCodeISO:"SN",Country:"Senegal"},{CountryCode:"+381",CountryCodeISO:"RS",Country:"Serbia"},{CountryCode:"+248",CountryCodeISO:"SC",Country:"Seychelles"},{CountryCode:"+232",CountryCodeISO:"SL",Country:"Sierra Leone"},{CountryCode:"+65",CountryCodeISO:"SG",Country:"Singapore"},{CountryCode:"+421",CountryCodeISO:"SK",Country:"Slovakia"},{CountryCode:"+386",CountryCodeISO:"SI",Country:"Slovenia"},{CountryCode:"+677",CountryCodeISO:"SB",Country:"Solomon Islands"},{CountryCode:"+252",CountryCodeISO:"SO",Country:"Somalia"},{CountryCode:"+27",CountryCodeISO:"ZA",Country:"South Africa"},{CountryCode:"+82",CountryCodeISO:"KR",Country:"South Korea"},{CountryCode:"+34",CountryCodeISO:"ES",Country:"Spain"},{CountryCode:"+94",CountryCodeISO:"LK",Country:"Sri Lanka"},{CountryCode:"+249",CountryCodeISO:"SD",Country:"Sudan"},{CountryCode:"+597",CountryCodeISO:"SR",Country:"Suriname"},{CountryCode:"+268",CountryCodeISO:"SZ",Country:"Swaziland"},{CountryCode:"+46",CountryCodeISO:"SE",Country:"Sweden"},{CountryCode:"+41",CountryCodeISO:"CH",Country:"Switzerland"},{CountryCode:"+963",CountryCodeISO:"SY",Country:"Syria"},{CountryCode:"+886",CountryCodeISO:"TW",Country:"Taiwan"},{CountryCode:"+992",CountryCodeISO:"TJ",Country:"Tajikistan"},{CountryCode:"+255",CountryCodeISO:"TZ",Country:"Tanzania"},{CountryCode:"+66",CountryCodeISO:"TH",Country:"Thailand"},{CountryCode:"+228",CountryCodeISO:"TG",Country:"Togo"},{CountryCode:"+216",CountryCodeISO:"TN",Country:"Tunisia"},{CountryCode:"+90",CountryCodeISO:"TR",Country:"Turkey"},{CountryCode:"+993",CountryCodeISO:"TM",Country:"Turkmenistan"},{CountryCode:"+256",CountryCodeISO:"UG",Country:"Uganda"},{CountryCode:"+380",CountryCodeISO:"UA",Country:"Ukraine"},{CountryCode:"+971",CountryCodeISO:"AE",Country:"United Arab Emirates"},{CountryCode:"+44",CountryCodeISO:"GB",Country:"United Kingdom"},{CountryCode:"+1",CountryCodeISO:"VI",Country:"U.S. Virgin Islands"},{CountryCode:"+598",CountryCodeISO:"UY",Country:"Uruguay"},{CountryCode:"+998",CountryCodeISO:"UZ",Country:"Uzbekistan"},{CountryCode:"+678",CountryCodeISO:"VU",Country:"Vanuatu"},{CountryCode:"+58",CountryCodeISO:"VE",Country:"Venezuela"},{CountryCode:"+84",CountryCodeISO:"VN",Country:"Vietnam"},{CountryCode:"+967",CountryCodeISO:"YE",Country:"Yemen"},{CountryCode:"+260",CountryCodeISO:"ZM",Country:"Zambia"},{CountryCode:"+263",CountryCodeISO:"ZW",Country:"Zimbabwe"},{CountryCode:"+262",CountryCodeISO:"YT",Country:"Mayotte"},{CountryCode:"+7",CountryCodeISO:"RU",Country:"Russian Federation"},{CountryCode:"+1",CountryCodeISO:"AI",Country:"Anguilla"},{CountryCode:"+1",CountryCodeISO:"AG",Country:"Antigua and Barbuda"},{CountryCode:"+1",CountryCodeISO:"BS",Country:"Bahamas"},{CountryCode:"+1",CountryCodeISO:"BB",Country:"Barbados"},{CountryCode:"+1",CountryCodeISO:"BM",Country:"Bermuda"},{CountryCode:"+1",CountryCodeISO:"VG",Country:"British Virgin Islands"},{CountryCode:"+1",CountryCodeISO:"KY",Country:"Cayman Islands"},{CountryCode:"+1",CountryCodeISO:"DM",Country:"Dominica"},{CountryCode:"+1",CountryCodeISO:"DO",Country:"Dominican Republic"},{CountryCode:"+1",CountryCodeISO:"GD",Country:"Grenada"},{CountryCode:"+1",CountryCodeISO:"GU",Country:"Guam"},{CountryCode:"+1",CountryCodeISO:"JM",Country:"Jamaica"},{CountryCode:"+1",CountryCodeISO:"MS",Country:"Montserrat"},{CountryCode:"+1",CountryCodeISO:"MP",Country:"Northern Marianas"},{CountryCode:"+1",CountryCodeISO:"PR",Country:"Puerto Rico"},{CountryCode:"+1",CountryCodeISO:"KN",Country:"Saint Kitts and Nevis"},{CountryCode:"+1",CountryCodeISO:"LC",Country:"Saint Lucia"},{CountryCode:"+1",CountryCodeISO:"VC",Country:"Saint Vincent and the Grenadines"},{CountryCode:"+1",CountryCodeISO:"TT",Country:"Trinidad and Tobago"},{CountryCode:"+1",CountryCodeISO:"TC",Country:"Turks and Caicos Islands"},{CountryCode:"+676",CountryCodeISO:"TO",Country:"Tonga"},{CountryCode:"+1",CountryCodeISO:"US",Country:"United States of America"},{CountryCode:"+970",CountryCodeISO:"PS",Country:"Palestine"},{CountryCode:"+211",CountryCodeISO:"SS",Country:"South Sudan"},{CountryCode:"+44",CountryCodeISO:"IM",Country:"Isle of Man"}];var p,m,f=r.path().split("/");"verified"==f[f.length-3]&&(p=f[f.length-1],m=f[f.length-2],p&&m&&n.Verify(p,m).then(function(e){e.success||u.error("Verification Failed","Sorry - your verification link seems to be incorrect.")})),"payment_setup_confirmation"==f[f.length-1].split("?")[0]&&(m=l.get("mid"),f=l.get("bid"),o.SetupGoCard({mid:m,bid:f,code:r.search().code}).then(function(e){e.success||u.error("Setup Failed","Sorry - we were unable to setup your connection to our payment provider GoCardless.")})),a.go_to_login=function(){s.go("login")},a.verify_mobile=function(e){4==_.text_verification.length&&t.VerifyPhone(_.text_verification,p).then(function(e){e.success?(a.verified_mobile=!0,a.link=e.link.url,l.put("mid",p),l.put("bid",e.bid)):(u.error("Verification Failed","Your verification code is incorrect."),a.verified_mobile=!1)})},a.get_companies=function(e){2<e.length&&t.GetCompany(e).then(function(e){e.success&&(a.companies=e.items)})},a.prefix_length=0,a.prefix="",a.set_prefix=function(){},a.set_company=function(){t.GetCompanyDetail(_.selected_company.company_number).then(function(e){e.success&&function(e){_.officers=e.officer,_.company_details=e.company;for(var t=!1,n=a.formData.user.first_name.toLowerCase(),o=a.formData.user.last_name.toLowerCase(),i=0,r=0;r<_.officers.length;r++)-1<_.officers[r].name.toLowerCase().indexOf(n)&&-1<_.officers[r].name.toLowerCase().indexOf(o)&&(t=!0,i=r);t?(u.success("Match Found","We have matched you!"),a.formData.club={},a.formData.club.company_name=e.company.company_name,a.formData.club.trading_as=e.company.company_name,a.formData.club.title=e.company.company_name.replace("LTD","").replace("LIMITED","").replace("LLC",""),a.formData.club.company_number=e.company.company_number,a.formData.club.date_of_creation=e.company.date_of_creation,a.formData.club.address_line_1=e.company.registered_office_address.address_line_1,a.formData.club.address_line_2=e.company.registered_office_address.address_line_2,a.formData.club.city=e.company.registered_office_address.locality,a.formData.club.post_code=e.company.registered_office_address.postal_code,a.formData.user.dob_year=e.officer[i].date_of_birth.year,a.formData.user.dob_month=e.officer[i].date_of_birth.month,a.formData.user.role=e.officer[i].officer_role,a.formData.club.is_company=!0):u.error("No Match","Unfortunately we cannot match your personal details with any of the company directors. Did you select the correct company from the drop-down list?")}(a.company=e)})},a.formData={club:{is_company:!0},user:{phone:""}},a.setup_direct_debit=function(){window.open(a.link)},a.checkValid=function(){if(a.formData.user.password!==a.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),u.warning("Password Mismatch","Your passwords do not match"),!1;var e=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!e.test(a.formData.user.password))return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),u.warning("Weak Password","Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1;if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),$("input:checkbox:not(:checked)").addClass("ng-checkbox-unchecked"),!1;if($("input:checkbox:not(:checked)").removeClass("ng-checkbox-unchecked"),!a.formData.user)return s.go("club_signup.my_profile"),!1;if(!_.selected_phone.CountryCode)return u.warning("Country Code Required","Please select the country prefix of the mobile phone entered from the drop-down menu, this will ensure that the text messages we send will be sent to the correct telephone number."),!1;a.formData.user.phone;if(0==a.formData.user.phone.slice(0,1)&&(u.warning("Phone Number","Your telephone number seems to start with a 0, as we will be using your international phone number, the first zero will be stripped automatically."),a.formData.user.phone.phone=a.formData.user.phone.phone.substring(1)),!a.formData.club||!a.formData.club.title)return s.go("club_signup.my_club"),!1;if(!a.formData.tnc)return s.go("club_signup.terms"),!1;if(a.formData.user.password!=a.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1;e=$(".btn-info").attr("one-ui-sref");"club_signup.verify"==e?a.processForm():s.go(e)},a.processForm=function(){a.formData?(a.formData.user.phone=_.selected_phone.CountryCode+a.formData.user.phone,e.Create(a.formData).then(function(e){e.success?(s.go("club_signup.verify"),a.formData={}):$("#error_message").html(e.message)})):u.error("Error","Something went wrong.")},a.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");d.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",d.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){$log.info("saveBlob method failed with the following exception:"),$log.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){$log.info("Download link method with simulated click failed with the following exception:"),$log.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){$log.info("Download link method with window.location failed with the following exception:"),$log.info(e)}}}o||($log.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){u.error("Download Failed","There was an error downloading the selected document(s).")})}}function CreateGalleryController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;_.gallery={is_protected:"false",download_low:"false",download_medium:"false",download_high:"false",gallery_link:"",fullscreen:"false"},u.GetAll().then(function(e){_.all_galleries=e}),_.images=d.data.selected_images,l.remove_image=function(t){_.images=$.grep(_.images,function(e){return e.id!=t.id}),d.SetSelectedImages(_.images)},l.check_link_unique=function(){for(var e=0;e<_.all_galleries.length;e++)if(_.all_galleries[e].link===_.gallery.link)return!1},l.generate_gallery=function(){for(var e=0;e<_.images.length;e++)_.images[e].organise=e;_.gallery.images=_.images,u.Create(_.gallery).then(function(e){r.path("/gallery/"+e.gallery_link)})}}function DashboardClubAirframeLogbookController(e,n,t,o,i,r,a,s,d,c,l,u,_,p,m,f,g,b){var h=this;switch(h.action){case"add":h.page_title="Add a New Plane";break;case"edit":n.GetByIdMaintenance2(a.plane_id,h.club_id).then(function(e){h.club.plane=e,h.this_plane_id=a.plane_id,h.club.plane&&h.club.plane.maintenance&&(h.obj.hours_remaining=h.club.plane.maintenance.hours_remaining,h.obj.next_check=new Date(h.club.plane.maintenance.next_maintenance),h.obj.check_date=new Date,h.obj.extension_granted=new Date),h.page_title="Edit a Plane Maintenance - "+h.club.plane.registration}),n.GetOpenIssues(a.plane_id).then(function(e){h.reported_defects=e})}function k(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}return o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},h.prop_no="",h.getAge=function(e){return(new Date).getFullYear()-e},n.GetAirframeLogs(a.plane_id,0,25).then(function(e){h.logs=e.logs,h.plane=e.plane}),h.current_offset=0,h.loaded_per_batch=25,h.all_loaded=!1,h.load_more=function(){h.current_offset=h.current_offset+h.loaded_per_batch,n.GetAirframeLogs(a.plane_id,h.current_offset,h.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return h.logs.push(e)}):h.all_loaded=!0,h.plane=e.plane})},h.update_logbooks=function(){n.UpdateAircraftLogbooks(a.plane_id).then(function(e){e.success&&n.GetAirframeLogs(a.plane_id,0,25).then(function(e){h.logs=e.logs,h.plane=e.plane})})},h.get_initial=function(e){return e.charAt(0)},h.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},h.maintenanceTypeLabels={"50hour":"50-Hour Check","100hour":"100-Hour Check","150hour":"150-Hour Check","25hours":"25-Hour Check","50hours":"50-Hour Check","100hours":"100-Hour Check",annual:"Annual Inspection",cofa:"Certificate of Airworthiness",arc:"Airworthiness Review Certificate",engine_overhaul:"Engine Overhaul",propeller_overhaul:"Propeller Overhaul",interim:"Interim Inspection","6months":"6-Month Check",extension:"Extension",workpack:"Workpack",other:"Other Maintenance"},h.formatMaintenanceType=function(e){return h.maintenanceTypeLabels[e]||e||"Maintenance"},h.isMaintenanceEntry=function(e){return"maintenance_check"===e.entry_type},h.getEntryType=function(e){return e.entry_type||"flight"},h.getEntryPosition=function(e){return e.entry_position||"full_day"},h.getHoursRemainingClass=function(e){return null==e?"":e<=5?"hours-critical":e<=10?"hours-warning":""},h.formatHoursRemaining=function(e){return null==e?"N/A":e.toFixed(2)+" hrs"},h.selected_check=null,h.show_check_detail=!1,h.check_logbook_links=[],h.check_logbook_loading=!1,h.check_logbook_error=!1,h.check_workpack=null,h.check_workpack_loading=!1,h.viewMaintenanceCheck=function(e){var t;h.isMaintenanceEntry(e)&&(h.selected_check=e,h.show_check_detail=!0,h.check_logbook_links=[],h.check_logbook_error=!1,h.check_workpack=null,(t=(e.maintenance_check||{}).id||e.maintenance_check_id||null)&&(h.loadCheckLogbookLinks(t),h.loadCheckWorkpack(e)))},h.closeMaintenanceCheck=function(){h.selected_check=null,h.show_check_detail=!1,h.check_logbook_links=[],h.check_logbook_error=!1,h.check_workpack=null},h.loadCheckLogbookLinks=function(n){n&&(h.check_logbook_loading=!0,h.check_logbook_error=!1,h.check_logbook_links=[],g.GetAvailableLogbooks(a.plane_id).then(function(e){var t=e&&e.available_logbooks?e.available_logbooks:[];if(0===t.length)return h.check_logbook_loading=!1,void(h.check_logbook_error=!0);g.GetLinks(n).then(function(e){h.check_logbook_loading=!1;var n=[];e&&e.maintenance_check&&e.maintenance_check.logbook_links&&(n=e.maintenance_check.logbook_links),h.check_logbook_links=t.map(function(t){var e=n.some(function(e){return e.logbook_type===t.logbook_type&&e.logbook_entity_id==t.logbook_entity_id});return{logbook_type:t.logbook_type,logbook_entity_id:t.logbook_entity_id,label:t.label,position:t.position||null,isLinked:e}})},function(){h.check_logbook_loading=!1,h.check_logbook_error=!0})},function(){h.check_logbook_loading=!1,h.check_logbook_error=!0}))},h.loadCheckWorkpack=function(e){e=e.maintenance_check||{},e=e.linked_workpack_id||e.workpack_id||null;e&&(h.check_workpack_loading=!0,b.GetById(e).then(function(e){h.check_workpack_loading=!1,e&&e.workpack&&(h.check_workpack=e.workpack)},function(){h.check_workpack_loading=!1}))},h.downloadWorkpackDocument=function(e){e&&m.get("/api/v1/maintenance_workpacks/file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){var o=new Blob([e],{type:"application/pdf"}),e=URL.createObjectURL(o),o=window.open();o.document.write('<html><head><title>Workpack Document</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),o.document.close()}).error(function(){f.error("Download Error","There was an error downloading the workpack document.")})},h.getLogbookIcon=function(e){switch(e){case"airframe":return"fa-plane";case"engine":return"fa-cog";case"propeller":return"fa-refresh";default:return"fa-book"}},h.getCheckTypeIcon=function(e){if(!e)return"fa-wrench";switch(e.toLowerCase()){case"annual":return"fa-calendar-check-o";case"50hours":case"50hour":case"25hours":case"100hours":case"100hour":case"150hour":return"fa-tachometer";case"extension":return"fa-clock-o";case"interim":return"fa-cogs";case"6months":return"fa-calendar";case"cofa":case"arc":return"fa-certificate";case"engine_overhaul":return"fa-cog";case"propeller_overhaul":return"fa-repeat";case"workpack":return"fa-briefcase";default:return"fa-wrench"}},i.update_this_file=function(e){-1===update_this_file.indexOf(e.id)&&update_this_file.push(e.id)},i.remove_real_file=function(t){h.club.plane.plane_documents=$.grep(h.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(h.user_id,t.id).then(function(e){e.success&&(h.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){JSON.parse(e.file_return)},h.files={radio:[],cert:[],insurance:[]},i.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,h.files[t].push(e[n].file)}},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,h.files[t].push(e[0])},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},h.defect_severity,h.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){h.plane_documents=$.grep(h.plane_documents,function(e){return e.temp_path!=t.temp_path}),h.plane_documents.push(t)},i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return warning_msg}}}).result.then(function(e){var t=e.id;d.info("PRESSED GO: ",t),n.Delete(t).then(function(){h.club.planes=$.grep(h.club.planes,function(e){return e.id!=t})})},function(){d.info("Modal dismissed at: "+new Date)})},i.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){f.error("Download Failed","There was an error downloading the selected document(s).")})},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){f.error("Download Failed","There was an error downloading the selected document(s).")})},i.search2=function(e){return!i.my_search2||""==i.my_search2||!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(i.my_search2,e.entry_date)},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},i.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n}}function DashboardClubCourseController(e,t,n,o,i,r,a,s,c,l,d){var u=this;u.charge_type=["brakes","session","plane","brakes_rounded"],u.user=null,u.allUsers=[],u.club={course:{}},u.page_title="",u.course_document={},u.course_documents=[];var _=[];switch(u.action=i.current.data.action,u.user=t.globals.currentUser,u.club_id=t.globals.currentUser.current_club_admin.id,u.user_id=u.user.id,u.course_certificate={},u.course_noise={},u.course_radio={},u.course_maintenance={},u.course_insurance={},u.club.lessons=[],u.exams=[],u.tags=[],u.instructor_charges=[],u.editing=!1,u.edit_course=!1,u.action){case"add":u.page_title="Add a New Course";break;case"edit":u.editing=!0,u.edit_course=!0,l.GetCourseById(r.course_id).then(function(e){u.club.course=e.item,u.page_title="Edit a Course - "+u.club.course.title}),l.GetLessonsByCourseId(r.course_id).then(function(e){u.club.lessons=e.items}),p(),m(),f();break;case"list":l.GetCoursesByClubId(u.club_id).then(function(e){u.club.courses=e.items})}function p(){l.GetExamsByCourseId(r.course_id).then(function(e){u.exams=e.items})}function m(){l.GetTagsByCourseId(r.course_id).then(function(e){u.tags=e.items})}function f(){l.GetChargesByCourseId(r.course_id).then(function(e){u.instructor_charges=e.items})}function g(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}o.back=function(){c.history.back()},u.clearFieldError=function(e){d.clearFieldError(e)},o.save=function(){var e=[{ok:u.club.course.title,field:"title",label:"Course Title"}];d.validateForm(e)&&("add"==u.action?o.create():o.update())},o.save_lesson_order=function(){for(var e=[],t=0;t<u.club.lessons.length;t++){var n={id:u.club.lessons[t].id,organise:t};e.push(n)}l.UpdateLessonOrder({order:e}).then(function(e){})},u.delete_lesson=function(e,t){confirm("Are you sure you wish to delete this lesson? This is irreversible.")&&l.DeleteLesson(e).then(function(e){e.success?u.club.lessons.splice(t,1):d.error("Error","An error occurred")})},u.update_exam=function(e,t){delete e.edit_me,l.UpdateExam(e).then(function(e){e.success?u.exams[t].edit_me=!1:d.error("Error","An error occurred")})},u.update_cancel=function(e){p()},u.edit_exam=function(e){u.exams[e].edit_me=!0},u.delete_exam=function(e,t){confirm("Are you sure you wish to delete this exam? This is irreversible.")&&l.DeleteExam(e.id).then(function(e){e.success?u.exams.splice(t,1):d.error("Error","An error occurred")})},u.add_exam=function(){u.new_exam.course_id=r.course_id,u.new_exam.club_id=u.club_id,l.CreateExam(u.new_exam).then(function(e){e.success?(u.exams.push(e.item),u.new_exam={title:"",description:""}):d.error("Error","An error occurred")})},u.update_tag=function(e,t){d.warning("Tag Removal","This tag being removed will not remove the tag from previous flights where this tag was already applied."),delete e.edit_me,l.UpdateTags(e).then(function(e){e.success?u.tags[t].edit_me=!1:d.error("Error","An error occurred")})},u.update_cancel_tag=function(e){m()},u.edit_tag=function(e){u.tags[e].edit_me=!0},u.delete_tag=function(e,t){confirm("Are you sure you wish to delete this tag? If this tag has already been assigned to particular flight(s) this will not remove these from existing flights.")&&l.DeleteTags(e.id).then(function(e){e.success?u.tags.splice(t,1):d.error("Error","An error occurred")})},u.add_tag=function(){u.new_tag.course_id=r.course_id,u.new_tag.club_id=u.club_id,l.CreateTags(u.new_tag).then(function(e){e.success?(u.tags.push(e.item),u.new_tag={title:""}):d.error("Error","An error occurred")})},u.update_charge=function(e,t){delete e.edit_me,l.UpdateCharge(e).then(function(e){e.success?u.instructor_charges[t].edit_me=!1:d.error("Error","An error occurred")})},u.update_cancel_charge=function(e){f()},u.edit_charge=function(e){u.instructor_charges[e].edit_me=!0},u.delete_charge=function(e,t){confirm("Are you sure you wish to delete this instructor charge? This is irreversible.")&&l.DeleteCharge(e.id).then(function(e){e.success?u.instructor_charges.splice(t,1):d.error("Error","An error occurred")})},u.add_charge=function(){u.new_charge.course_id=r.course_id,u.new_charge.club_id=u.club_id,l.CreateCharge(u.new_charge).then(function(e){e.success?(u.instructor_charges.push(e.item),u.new_charge={title:"",charge_type:"",price:""}):d.error("Error","An error occurred")})},u.delete_course=function(e,t){confirm("Are you sure you wish to delete this course? This is irreversible.")&&l.DeleteCourse(e).then(function(e){e.success?u.club.courses.splice(t,1):d.error("Error","An error occurred")})},o.create=function(){u.club.course.club_id=u.club_id,l.CreateCourse(u.club.course).then(function(e){e.success&&i.go("dashboard.manage_club.edit_course",{course_id:e.id,reload:!0})})},o.delete=function(){d.warning("Delete Course","Are you sure you would like to delete this course?"),l.DeleteCourse(u.club.course.id).then(function(e){})},o.update=function(){l.UpdateCourse(u.club.course).then(function(e){i.go("dashboard.manage_club.courses")})},o.add_item=function(e){switch(e){case"licence":var t;u.temporary.licence&&""!==u.temporary.licence&&u.temporary.rating&&""!==u.temporary.rating?(0==g(t={licence_id:u.temporary.licence.id,licence_title:u.temporary.licence.abbreviation,rating_title:u.temporary.rating.abbreviation,rating_id:u.temporary.rating.id},u.club.course.requirements.licence,new Array("licence_id","rating_id"))&&u.club.course.requirements.licence.push(t),delete u.temporary.licence,delete u.temporary.rating):d.warning("Selection Required","Please select a licence and rating that is required to book the course solo!");break;case"medical":u.temporary.medical_authority&&""!==u.temporary.medical_authority&&u.temporary.medical_component&&""!==u.temporary.medical_component?(0==g(n={authority_id:u.temporary.medical_authority.id,authority_title:u.temporary.medical_authority.abbreviation,medical_component_id:u.temporary.medical_component.id,medical_component_title:u.temporary.medical_component.title},u.club.course.requirements.medical,new Array("authority_id","medical_component_id"))&&u.club.course.requirements.medical.push(n),delete u.temporary.medical_authority,delete u.temporary.medical_component):d.warning("Selection Required","Please select a medical that is required to book the course solo!");break;case"differences":var n;u.temporary.difference&&""!==u.temporary.difference?(0==g(n={difference_id:u.temporary.difference.id,difference_title:u.temporary.difference.title},u.club.course.requirements.differences,new Array("difference_id","difference_title"))&&u.club.course.requirements.differences.push(n),delete u.temporary.difference):d.warning("Selection Required","Please select a difference that is required to book the course solo!")}},o.update_this_file=function(e){-1===_.indexOf(e.id)&&_.push(e.id)},o.remove_real_file=function(t){u.club.course.course_documents=$.grep(u.club.course.course_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(u.user_id,t.id).then(function(e){e.success&&(u.course_documents=[],o.processFiles(current_files))})},u.files={radio:[],cert:[],insurance:[],noise:[]},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,u.files[t].push(e[0].file)},o.set_title=function(e){return e.save_name},o.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(u.course_documents=[],o.processFiles(t))})},o.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,u.course_documents.push(e[t].file)}},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function DashboardClubEngineLogbookController(e,n,t,o,i,r,a,s,d,c,l,u,_,p,m,f,g,b){var h=this;switch(h.action){case"add":h.page_title="Add a New Plane";break;case"edit":n.GetByIdMaintenance2(a.plane_id,h.club_id).then(function(e){h.club.plane=e,h.this_plane_id=a.plane_id,h.club.plane&&h.club.plane.maintenance&&(h.obj.hours_remaining=h.club.plane.maintenance.hours_remaining,h.obj.next_check=new Date(h.club.plane.maintenance.next_maintenance),h.obj.check_date=new Date,h.obj.extension_granted=new Date),h.page_title="Edit a Plane Maintenance - "+h.club.plane.registration}),n.GetOpenIssues(a.plane_id).then(function(e){h.reported_defects=e})}function k(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}return o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},n.GetEngineLogs(a.engine_id,a.plane_id,0,25).then(function(e){h.logs=e.logs,h.engine=e.engine}),h.current_offset=0,h.loaded_per_batch=25,h.all_loaded=!1,h.load_more=function(){h.current_offset=h.current_offset+h.loaded_per_batch,n.GetEngineLogs(a.engine_id,a.plane_id,h.current_offset,h.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return h.logs.push(e)}):h.all_loaded=!0,h.engine=e.engine})},h.get_initial=function(e){return e.charAt(0)},h.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},h.maintenanceTypeLabels={"50hour":"50-Hour Check","100hour":"100-Hour Check","150hour":"150-Hour Check","25hours":"25-Hour Check","50hours":"50-Hour Check","100hours":"100-Hour Check",annual:"Annual Inspection",cofa:"Certificate of Airworthiness",arc:"Airworthiness Review Certificate",engine_overhaul:"Engine Overhaul",propeller_overhaul:"Propeller Overhaul",interim:"Interim Inspection","6months":"6-Month Check",extension:"Extension",workpack:"Workpack",other:"Other Maintenance"},h.formatMaintenanceType=function(e){return h.maintenanceTypeLabels[e]||e||"Maintenance"},h.isMaintenanceEntry=function(e){return"maintenance_check"===e.entry_type},h.getEntryType=function(e){return e.entry_type||"flight"},h.getEntryPosition=function(e){return e.entry_position||"full_day"},h.getHoursRemainingClass=function(e){return null==e?"":e<=5?"hours-critical":e<=10?"hours-warning":""},h.formatHoursRemaining=function(e){return null==e?"N/A":e.toFixed(2)+" hrs"},h.selected_check=null,h.show_check_detail=!1,h.check_logbook_links=[],h.check_logbook_loading=!1,h.check_logbook_error=!1,h.check_workpack=null,h.check_workpack_loading=!1,h.viewMaintenanceCheck=function(e){var t;h.isMaintenanceEntry(e)&&(h.selected_check=e,h.show_check_detail=!0,h.check_logbook_links=[],h.check_logbook_error=!1,h.check_workpack=null,(t=(e.maintenance_check||{}).id||e.maintenance_check_id||null)&&(h.loadCheckLogbookLinks(t),h.loadCheckWorkpack(e)))},h.closeMaintenanceCheck=function(){h.selected_check=null,h.show_check_detail=!1,h.check_logbook_links=[],h.check_logbook_error=!1,h.check_workpack=null},h.loadCheckLogbookLinks=function(n){n&&(h.check_logbook_loading=!0,h.check_logbook_error=!1,h.check_logbook_links=[],g.GetAvailableLogbooks(a.plane_id).then(function(e){var t=e&&e.available_logbooks?e.available_logbooks:[];if(0===t.length)return h.check_logbook_loading=!1,void(h.check_logbook_error=!0);g.GetLinks(n).then(function(e){h.check_logbook_loading=!1;var n=[];e&&e.maintenance_check&&e.maintenance_check.logbook_links&&(n=e.maintenance_check.logbook_links),h.check_logbook_links=t.map(function(t){var e=n.some(function(e){return e.logbook_type===t.logbook_type&&e.logbook_entity_id==t.logbook_entity_id});return{logbook_type:t.logbook_type,logbook_entity_id:t.logbook_entity_id,label:t.label,position:t.position||null,isLinked:e}})},function(){h.check_logbook_loading=!1,h.check_logbook_error=!0})},function(){h.check_logbook_loading=!1,h.check_logbook_error=!0}))},h.loadCheckWorkpack=function(e){e=e.maintenance_check||{},e=e.linked_workpack_id||e.workpack_id||null;e&&(h.check_workpack_loading=!0,b.GetById(e).then(function(e){h.check_workpack_loading=!1,e&&e.workpack&&(h.check_workpack=e.workpack)},function(){h.check_workpack_loading=!1}))},h.downloadWorkpackDocument=function(e){e&&m.get("/api/v1/maintenance_workpacks/file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){var o=new Blob([e],{type:"application/pdf"}),e=URL.createObjectURL(o),o=window.open();o.document.write('<html><head><title>Workpack Document</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),o.document.close()}).error(function(){f.error("Download Error","There was an error downloading the workpack document.")})},h.getLogbookIcon=function(e){switch(e){case"airframe":return"fa-plane";case"engine":return"fa-cog";case"propeller":return"fa-refresh";default:return"fa-book"}},h.getCheckTypeIcon=function(e){if(!e)return"fa-wrench";switch(e.toLowerCase()){case"annual":return"fa-calendar-check-o";case"50hours":case"50hour":case"25hours":case"100hours":case"100hour":case"150hour":return"fa-tachometer";case"extension":return"fa-clock-o";case"interim":return"fa-cogs";case"6months":return"fa-calendar";case"cofa":case"arc":return"fa-certificate";case"engine_overhaul":return"fa-cog";case"propeller_overhaul":return"fa-repeat";case"workpack":return"fa-briefcase";default:return"fa-wrench"}},h.update_logbooks=function(){n.UpdateAircraftLogbooks(a.plane_id).then(function(e){e.success&&n.GetEngineLogs(a.engine_id,a.plane_id,0,25).then(function(e){h.logs=e.logs,h.engine=e.engine,f.success("Recheck Complete","The logbook has been re-checked")})})},i.update_this_file=function(e){-1===update_this_file.indexOf(e.id)&&update_this_file.push(e.id)},i.remove_real_file=function(t){h.club.plane.plane_documents=$.grep(h.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(h.user_id,t.id).then(function(e){e.success&&(h.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){JSON.parse(e.file_return)},h.files={radio:[],cert:[],insurance:[]},i.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,h.files[t].push(e[n].file)}},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,h.files[t].push(e[0])},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},h.defect_severity,h.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){h.plane_documents=$.grep(h.plane_documents,function(e){return e.temp_path!=t.temp_path}),h.plane_documents.push(t)},i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return warning_msg}}}).result.then(function(e){var t=e.id;d.info("PRESSED GO: ",t),n.Delete(t).then(function(){h.club.planes=$.grep(h.club.planes,function(e){return e.id!=t})})},function(){d.info("Modal dismissed at: "+new Date)})},i.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){f.error("Download Failed","There was an error downloading the selected document(s).")})},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){f.error("Download Failed","There was an error downloading the selected document(s).")})},i.search2=function(e){return!i.my_search2||""==i.my_search2||!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(i.my_search2,e.entry_date)},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},i.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n}}function DashboardClubExperienceDiscountsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={item:{}},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];switch(f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.charge_type=["brakes","session","plane"],f.planes=[],p.GetByClubId(f.club_id).then(function(e){f.experiences=e.items}),f.action){case"add":f.page_title="Add an Experience";break;case"edit":p.GetById(a.id).then(function(e){f.club.item=e.item});break;case"list":p.GetDiscountsByClubId(f.club_id).then(function(e){f.club.items=e.items})}i.check_code=function(){},i.back=function(){l.history.back()},f.clearFieldError=function(e){m.clearFieldError(e)},i.save=function(){var e=[{ok:f.club.item.experience&&f.club.item.experience.id,field:"experience_select",label:"Experience"},{ok:f.club.item.discount_type&&"0"!==f.club.item.discount_type,field:"discount_type",label:"Discount Type"},{ok:f.club.item.discount_code,field:"discount_code",label:"Discount Code"}];"1"==f.club.item.discount_type&&e.push({ok:null!=f.club.item.price&&""!==f.club.item.price,field:"price",label:"Discounted Price"}),"2"==f.club.item.discount_type&&e.push({ok:null!=f.club.item.percentage&&""!==f.club.item.percentage,field:"percentage",label:"Discounted Percentage"}),m.validateForm(e)&&("add"==f.action?i.create():i.update())},i.create=function(){f.club.item.experience_id=f.club.item.experience.id,delete f.club.item.experience,f.club.item.club_id=f.club_id,p.CreateDiscount(f.club.item).then(function(e){r.go("dashboard.manage_club.experience_discounts",{},{reload:!0})})},i.delete=function(){m.warning("Confirm Delete","Are you sure you would like to delete this plane?"),p.DeleteDiscount(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,p.UpdateDiscount(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.experience_discounts",{},{reload:!0})})},i.add_item=function(e){"plane"===e&&(f.temporary.plane&&""!==f.temporary.plane?(f.club.item.planes||(f.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(f.temporary.plane,f.club.item.planes,new Array("plane_id"))&&f.club.item.planes.push(f.temporary.plane),delete f.temporary.plane):m.warning("Selection Required","Please select a plane that this activity be done on!"))},i.remove_item=function(e,t){f.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubExperiencesController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={item:{planes:[]}},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];switch(f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.charge_type=["brakes","session","plane"],f.planes=[],f.club.item.planes=[],f.temporary={},f.temporary.plane={},t.GetAllByClub(f.club_id).then(function(e){f.planes=e}),f.action){case"add":f.page_title="Add an Experience";break;case"edit":p.GetById(a.id).then(function(e){f.club.item=e.item});break;case"list":p.GetByClubId(f.club_id).then(function(e){f.club.items=e.items})}i.back=function(){l.history.back()},f.clearFieldError=function(e){m.clearFieldError(e)},i.save=function(){var e=f.club.item||{},t=[{ok:e.title,field:"title",label:"Title"},{ok:null!=e.price&&""!==e.price,field:"price",label:"Price"},{ok:null!=e.valid_for&&""!==e.valid_for,field:"valid_for",label:"Validity (days)"},{ok:null!=e.booking_duration&&""!==e.booking_duration,field:"booking_duration",label:"Slot Required (hours)"}];if(m.validateForm(t))return!e.planes||e.planes.length<1?(m.highlightField(".card"),void m.warning("Aircraft Required","You must add at least 1 aircraft to this experience.")):void("add"==f.action?i.create():i.update())},i.create=function(){f.club.item.club_id=f.club_id,p.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.experiences",{},{reload:!0})})},i.delete=function(){m.warning("Confirm Delete","Are you sure you would like to delete this plane?"),p.Delete(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,p.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.experiences",{},{reload:!0})})},i.add_item=function(e){"plane"===e&&(f.temporary.plane&&f.temporary.plane.id?(f.club.item.planes||(f.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(f.temporary.plane,f.club.item.planes,new Array("plane_id"))&&f.club.item.planes.push(f.temporary.plane),delete f.temporary.plane):(m.highlightField("add_aircraft_select"),m.warning("Missing Plane","Please select a plane that this activity be done on!")))},i.remove_item=function(e,t){f.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubFlightsController(e,r,t,n,o,a,i,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},f.show_loading=!1,f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];switch(f.currency_types=["class","type"],f.gear_types=["tricycle","tailwheel","monowheel","floats","amphibian","skis"],f.certificates=[{id:1,title:"Certificate of Airworthiness",value:"cofa"},{id:2,title:"National Certificate of Airworthiness",value:"cofa"},{id:2,title:"LAA Permit to Fly",value:"ptf"}],f.classes=["SEP (land)","SEP (sea)","SET (land)","SET (sea)","MEP (land)","MEP (sea)","ME"],f.charge_type=["airborne","brakes","tacho","hobbs","flight","brakes_rounded"],f.surcharge_type=["none","flight","hour"],f.action=a.current.data.action,f.user=t.globals.currentUser,f.club_id=t.globals.currentUser.current_club_admin.id,f.user_id=f.user.id,f.to_date=new Date,f.from_date=new Date,f.aircraft="",f.from_date.setMonth(f.from_date.getMonth()-1),f.show_loading=!0,r.GetAllFlightsByClub(f.club_id,f.from_date,f.to_date,f.selected_aircraft).then(function(e){f.flights=e.flights,f.totals=e.totals,f.aircraft=e.aircraft,f.show_loading=!1}),f.editing=!1,f.action){case"add":f.page_title="Add a New Plane";break;case"edit":f.editing=!0,r.GetById(i.plane_id,f.club_id).then(function(e){f.club.plane=e,f.club.plane.airframe_hours=parseFloat(f.club.plane.airframe_hours),f.club.plane.vp=1==f.club.plane.vp,f.club.plane.rg=1==f.club.plane.rg,f.club.plane.tb=1==f.club.plane.tb,f.plane_engine_1=f.club.plane.engine_1,f.plane_engine_2=f.club.plane.engine_2,f.plane_propeller_1=f.club.plane.propeller_1,f.plane_propeller_2=f.club.plane.propeller_2,f.page_title="Edit a Plane - "+f.club.plane.registration});break;case"list":r.GetAllByClub(f.club_id).then(function(e){f.club.planes=e})}function b(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}o.back=function(){l.history.back()},o.my_search="",o.search=function(e){if(""==o.my_search)return!0;return!(!e||!e.aircraft||-1===angular.lowercase(e.aircraft.registration).indexOf(angular.lowercase(o.my_search)||""))||(!(!e||!e.flight_date||-1===angular.lowercase(e.flight_date.toString()).indexOf(angular.lowercase(o.my_search)||""))||(!!(e&&e.from_airport&&e.from_airport.code&&-1!==angular.lowercase(e.from_airport.code).indexOf(angular.lowercase(o.my_search)||""))||(!!(e&&e.from_airport&&e.from_airport.title&&-1!==angular.lowercase(e.from_airport.title).indexOf(angular.lowercase(o.my_search)||""))||(!!(e&&e.to_airport&&e.to_airport.code&&-1!==angular.lowercase(e.to_airport.code).indexOf(angular.lowercase(o.my_search)||""))||!!(e&&e.to_airport&&e.to_airport.title&&-1!==angular.lowercase(e.to_airport.title).indexOf(angular.lowercase(o.my_search)||""))))))},o.set_aircraft_details=function(){r.GetAddAircraft(f.plane_search.registration).then(function(e){e&&(0==e.length||(f.plane_search=e,function(){f.club.plane.manufacturer=f.plane_search.manufacturer,f.club.plane.serial_no=f.plane_search.serial_number,f.club.plane.plane_type=f.plane_search.icao_type,f.club.plane.type_name=f.plane_search.type_name,f.club.plane.year_built=f.plane_search.year_built,f.club.plane.aircraft_id=f.plane_search.id,f.club.plane.mtow=parseInt(f.plane_search.mtow),f.club.plane.airframe_hours=f.plane_search.airframe_hours,f.plane_search.noise_level&&(f.plane_noise.noise_level=f.plane_search.noise_level.match(/[+-]?\d+(\.\d+)?/g).map(function(e){return parseFloat(e)}));f.plane_noise.noise_cert_issue=f.plane_search.noise_cert_issue?new Date(f.plane_search.noise_cert_issue):"",-1<f.plane_search.aircraft_class.indexOf("FIXED-WING")&&(0<f.plane_search.is_propeller&&-1==f.plane_search.engine_name.indexOf("PT6A-")?f.club.plane.plane_class=1<f.club.plane.number_of_engines?"MEP":"SEP":f.club.plane.plane_class=1<f.club.plane.number_of_engines?"ME":"SET",-1<f.plane_search.aircraft_class.indexOf("LANDPLANE")&&(f.club.plane.plane_class=f.club.plane.plane_class+" (land)",f.club.plane.gear_type=""),(-1<f.plane_search.aircraft_class.indexOf("AMPHIBIAN")||-1<f.plane_search.aircraft_class.indexOf("FLOAT"))&&(f.club.plane.plane_class=f.club.plane.plane_class+" (sea)",f.club.plane.gear_type=-1<f.plane_search.aircraft_class.indexOf("AMPHIBIAN")?"amphibian":"floats"));f.club.plane.seats=parseInt(f.plane_search.seats)+1,f.plane_maintenance.cofa_category=-1<f.plane_search.cofa_category.indexOf("cofa")?"Certificate of Airworthiness":"Permit to Fly",f.plane_maintenance.certificate_expiry=new Date(f.plane_search.cofa_expiry),f.club.plane.cofa_category=f.plane_maintenance.cofa_category,f.club.plane.gear_type=f.plane_search.gear_type,f.plane_engine_1.make=f.plane_search.engine_name,f.plane_engine_1.model=f.plane_search.engine_name,f.plane_propeller_1.make=f.plane_search.propeller_manufacturer,f.plane_propeller_1.model=f.plane_search.propeller_name,1<f.plane_search.number_of_engines&&(f.number_of_engine=f.plane_search.number_of_engines,f.plane_engine_2.make=f.plane_search.engine_name,f.plane_engine_2.model=f.plane_search.engine_name,f.plane_propeller_2.make=f.plane_search.propeller_manufacturer,f.plane_propeller_2.model=f.plane_search.propeller_name)}()))})},o.save=function(){"add"==f.action?o.create():o.update()},f.update_ac=function(){},f.search_for_flights=function(){f.show_loading=!0;var e=0;f.selected_aircraft&&f.selected_aircraft.plane_id&&(e=f.selected_aircraft.plane_id),r.GetAllFlightsByClub(f.club_id,f.from_date,f.to_date,e).then(function(e){f.flights=e.flights,f.totals=e.totals,f.aircraft=e.aircraft,f.show_loading=!1})},f.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},o.create=function(){return f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,f.club.plane.registration=f.plane_search.registration,f.club.maintenance_type=f.plane_maintenance.cofa_category.value,!1},o.delete=function(){m.warning("Delete Plane","Are you sure you would like to delete this plane?"),r.Update(f.club.plane).then(function(e){})},o.update=function(){f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,f.club.plane.update_documents=function(){for(var e=[],t=0;t<g.length;t++)for(var n=g[t],o=0;o<f.club.plane.plane_documents.length;o++)f.club.plane.plane_documents[o].id==n&&e.push(f.club.plane.plane_documents[o]);return e}(),r.Update(f.club.plane).then(function(e){a.go("dashboard.manage_club.planes")})},f.save_new_aircraft_bit=function(e,t){var n="plane_"+e+"_"+t,o="plane_"+e+"_"+t+"_replace",i={},i=f[n]&&""!==f[n]?(f[n].removed_date=f[o].removed_date,delete f[o].removed_date,{old_item:f[n],new_item:f[o],plane_id:f.club.plane.id,item:e,no:t}):{old_item:{},new_item:f[o],plane_id:f.club.plane.id,item:e,no:t};r.UpdateAircraftBit(i).then(function(e){a.go("dashboard.manage_club.planes")})},o.add_item=function(e){switch(e){case"licence":var t;f.temporary.licence&&""!==f.temporary.licence&&f.temporary.rating&&""!==f.temporary.rating?(0==b(t={licence_id:f.temporary.licence.id,licence_title:f.temporary.licence.abbreviation,rating_title:f.temporary.rating.abbreviation,rating_id:f.temporary.rating.id},f.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&f.club.plane.requirements.licence.push(t),delete f.temporary.licence,delete f.temporary.rating):m.warning("Selection Required","Please select a licence and rating that is required to book the plane solo!");break;case"medical":f.temporary.medical_authority&&""!==f.temporary.medical_authority&&f.temporary.medical_component&&""!==f.temporary.medical_component?(0==b(n={authority_id:f.temporary.medical_authority.id,authority_title:f.temporary.medical_authority.abbreviation,medical_component_id:f.temporary.medical_component.id,medical_component_title:f.temporary.medical_component.title},f.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&f.club.plane.requirements.medical.push(n),delete f.temporary.medical_authority,delete f.temporary.medical_component):m.warning("Selection Required","Please select a medical that is required to book the plane solo!");break;case"differences":var n;f.temporary.difference&&""!==f.temporary.difference?(0==b(n={difference_id:f.temporary.difference.id,difference_title:f.temporary.difference.title},f.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&f.club.plane.requirements.differences.push(n),delete f.temporary.difference):m.warning("Selection Required","Please select a difference that is required to book the plane solo!")}},o.remove_item=function(e,t){f.club.plane.requirements[e].splice(t,1)},o.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},o.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(f.user_id,t.id).then(function(e){e.success&&(f.plane_documents=[],o.processFiles(current_files))})},f.files={radio:[],cert:[],insurance:[],noise:[]},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,f.files[t].push(e[0].file)},o.set_title=function(e){return e.save_name},o.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],o.processFiles(t))})},o.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},o.save_plane_documents=function(){},o.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};o.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;c.info("PRESSED GO: ",t),r.Delete(t).then(function(){f.club.planes=$.grep(f.club.planes,function(e){return e.id!=t})})},function(){c.info("Modal dismissed at: "+new Date)})},f.aircraft,f.plane_search,f.plane_to_add,o.get_aircraft=function(t){3<t.length&&r.GetAddAircraft(t).then(function(e){!e||0==e.length?f.aircraft=[{icao_type:"not known",registration:t.toUpperCase()}]:f.aircraft=e})}}function DashboardClubFlyingController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v){var w=this;switch(w.user=null,w.allUsers=[],w.club={},w.page_title="",w.club.member={},w.club.member.payment_now=!0,w.imported_new_headers=[],w.test="Package valid until 12/03/2022<br /> To be used on:<br /> G-BOOF <br /> G-OARU",w.action=s.current.data.action,w.club_id=i.globals.currentUser.current_club_admin.id,w.user=i.globals.currentUser,w.user_id=w.user.id,w.no_show_cols=["membership_start","membership_id","selected"],a.sortType="Email",a.sortReverse=!1,a.searchTool="",a.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},w.action){case"add":w.page_title="Add a New member",n.GetAllByClub(w.club_id).then(function(e){w.club.memberships=e});break;case"edit":break;case"list":o.GetIncompleteClub(w.club_id).then(function(e){w.club.flights=e.bookouts}),w.get_pax_html=function(e){for(var t="",n=0;n<e.passengers.length;n++){var o="";if(0<e.passengers[n].nok.length)for(var i=0;i<e.passengers[n].nok.length;i++)o=o+"<br /><br />Emergency Contact ("+(i+1)+"): <br />"+e.passengers[n].nok[i].first_name+" "+e.passengers[n].nok[i].last_name+" <br />relationship: "+e.passengers[n].nok[i].relationship+"<br />t: "+e.passengers[n].nok[i].phone_number+" <br /> e: "+e.passengers[n].nok[i].email_address+"<br />";t=t+"<span class='bolder'><b>"+e.passengers[n].first_name+" "+e.passengers[n].last_name+"</b></span><br />e: "+e.passengers[n].email+"<br />t: "+(e.passengers[n].telephone_number||"unknown")+o+"  <br /> <br />"}if(e.passengers.length,0<e.instructor_id){var r="";if(0<e.booking.instructor_nok.noks.length)for(i=0;i<e.booking.instructor_nok.noks.length;i++)r=r+"<br />Emergency Contact ("+(i+1)+"): <br />"+e.booking.instructor_nok.noks[i].first_name+" "+e.booking.instructor_nok.noks[i].last_name+" <br />relationship: "+e.booking.instructor_nok.noks[i].relationship+"<br />t: "+e.booking.instructor_nok.noks[i].phone_number+" <br /> e: "+e.booking.instructor_nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Instructor Present</span> <br /> "+e.booking.instructor.first_name+" "+e.booking.instructor.last_name+" <br /> "+r}if(0<e.user_id){var a="";if(0<e.booking.user_nok.noks.length)for(i=0;i<e.booking.user_nok.noks.length;i++)a=a+"<br />Emergency Contact ("+(i+1)+"): <br />"+e.booking.user_nok.noks[i].first_name+" "+e.booking.user_nok.noks[i].last_name+" <br />relationship: "+e.booking.user_nok.noks[i].relationship+"<br />t: "+e.booking.user_nok.noks[i].phone_number+" <br /> e: "+e.booking.user_nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Member Present</span><br />"+e.booking.user.first_name+" "+e.booking.user.last_name+" <br />"+a}return t}}a.back=function(){u.history.back()},w.load_adsb=function(e){window.open("https://globe.adsbexchange.com/?icao="+e,"_blank","")},w.cancel_bookout=function(e){confirm("Please confirm you wish to cancel the bookout.")&&y.CancelBookout(e).then(function(e){e.success?o.GetIncompleteClub(w.club_id).then(function(e){w.club.flights=e.bookouts}):v.error("Error",e.message)})}}function DashboardClubInstructorBookings(e,r,t,n,o,a,i,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];function b(e){var t=e.substring(e.indexOf("(")).split(","),n=parseInt(h(t[0].substring(1)),10),e=parseInt(h(t[1]),10),t=parseInt(h(t[2]),10),o=[n.toString(16),e.toString(16),t.toString(16)];return o.forEach(function(e,t){1===e.length&&(o[t]="0"+e)}),"#"+o.join("")}function h(e){return e.replace(/^\s+|\s+$/gm,"")}function k(e,t){t=1<arguments.length&&void 0!==t?t:1;return"rgba("+parseInt(e.substring(1,3),16)+", "+parseInt(e.substring(3,5),16)+", "+parseInt(e.substring(5),16)+", "+t+")"}function y(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}f.currency_types=["class","type"],f.gear_types=["tricycle","tailwheel","monowheel","floats","amphibian","skis"],f.certificates=[{id:1,title:"Certificate of Airworthiness",value:"cofa"},{id:2,title:"National Certificate of Airworthiness",value:"cofa"},{id:2,title:"LAA Permit to Fly",value:"ptf"}],f.classes=["SEP (land)","SEP (sea)","SET (land)","SET (sea)","MEP (land)","MEP (sea)","ME"],f.charge_type=["airborne","brakes","tacho","hobbs","flight","brakes_rounded"],f.surcharge_type=["none","flight","hour"],f.action=a.current.data.action,f.user=t.globals.currentUser,f.club_id=t.globals.currentUser.current_club_admin.id,f.user_id=f.user.id,f.editing=!1,"list"===f.action&&p.GetAllByClub(f.club_id,f.user_id).then(function(e){f.club.instructors=e.instructors,f.edit_instructor()}),o.back=function(){l.history.back()},f.save_instructor=function(e){e.new_colour&&""!==e.new_colour&&(e.instructor_colour=k(e.new_colour,1),delete e.new_colour),e.new_booking_colour&&""!==e.new_booking_colour&&(e.booking_colour=k(e.new_booking_colour,1),delete e.new_booking_colour),e.edit=!1,delete e.edit,p.UpdateInstructor(e,f.club_id).then(function(e){})},f.edit_instructor=function(){for(var e=0;e<f.club.instructors.length;e++)f.club.instructors[e].instructor_colour&&""!==f.club.instructors[e].instructor_colour&&(f.club.instructors[e].new_colour=b(f.club.instructors[e].instructor_colour)),f.club.instructors[e].booking_colour&&""!==f.club.instructors[e].booking_colour&&(f.club.instructors[e].new_booking_colour=b(f.club.instructors[e].booking_colour))},o.save_instructor_order=function(){for(var e=[],t=0;t<f.club.instructors.length;t++){var n={id:f.club.instructors[t].id,display_order:t};e.push(n)}p.UpdateOrder({order:e},f.club_id).then(function(e){})},o.set_aircraft_details=function(){r.GetAddAircraft(f.plane_search.registration).then(function(e){e&&(0==e.length||(f.plane_search=e,function(){f.club.plane.manufacturer=f.plane_search.manufacturer,f.club.plane.serial_no=f.plane_search.serial_number,f.club.plane.plane_type=f.plane_search.icao_type,f.club.plane.type_name=f.plane_search.type_name,f.club.plane.year_built=f.plane_search.year_built,f.club.plane.aircraft_id=f.plane_search.id,f.club.plane.mtow=parseInt(f.plane_search.mtow),f.club.plane.airframe_hours=f.plane_search.airframe_hours,f.plane_search.noise_level&&(f.plane_noise.noise_level=f.plane_search.noise_level.match(/[+-]?\d+(\.\d+)?/g).map(function(e){return parseFloat(e)}));f.plane_noise.noise_cert_issue=f.plane_search.noise_cert_issue?new Date(f.plane_search.noise_cert_issue):"",-1<f.plane_search.aircraft_class.indexOf("FIXED-WING")&&(0<f.plane_search.is_propeller&&-1==f.plane_search.engine_name.indexOf("PT6A-")?f.club.plane.plane_class=1<f.club.plane.number_of_engines?"MEP":"SEP":f.club.plane.plane_class=1<f.club.plane.number_of_engines?"ME":"SET",-1<f.plane_search.aircraft_class.indexOf("LANDPLANE")&&(f.club.plane.plane_class=f.club.plane.plane_class+" (land)",f.club.plane.gear_type=""),(-1<f.plane_search.aircraft_class.indexOf("AMPHIBIAN")||-1<f.plane_search.aircraft_class.indexOf("FLOAT"))&&(f.club.plane.plane_class=f.club.plane.plane_class+" (sea)",f.club.plane.gear_type=-1<f.plane_search.aircraft_class.indexOf("AMPHIBIAN")?"amphibian":"floats"));f.club.plane.seats=parseInt(f.plane_search.seats)+1,f.plane_maintenance.cofa_category=-1<f.plane_search.cofa_category.indexOf("cofa")?"Certificate of Airworthiness":"Permit to Fly",f.plane_maintenance.certificate_expiry=new Date(f.plane_search.cofa_expiry),f.club.plane.cofa_category=f.plane_maintenance.cofa_category,f.club.plane.gear_type=f.plane_search.gear_type,f.plane_engine_1.make=f.plane_search.engine_name,f.plane_engine_1.model=f.plane_search.engine_name,f.plane_propeller_1.make=f.plane_search.propeller_manufacturer,f.plane_propeller_1.model=f.plane_search.propeller_name,1<f.plane_search.number_of_engines&&(f.number_of_engine=f.plane_search.number_of_engines,f.plane_engine_2.make=f.plane_search.engine_name,f.plane_engine_2.model=f.plane_search.engine_name,f.plane_propeller_2.make=f.plane_search.propeller_manufacturer,f.plane_propeller_2.model=f.plane_search.propeller_name)}()))})},o.save=function(){"add"==f.action?o.create():o.update()},f.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},o.create=function(){return f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,f.club.plane.registration=f.plane_search.registration,f.club.maintenance_type=f.plane_maintenance.cofa_category.value,!1},o.delete=function(){m.warning("Confirm Delete","Are you sure you would like to delete this plane?"),r.Update(f.club.plane).then(function(e){})},o.update=function(){f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,f.club.plane.update_documents=function(){for(var e=[],t=0;t<g.length;t++)for(var n=g[t],o=0;o<f.club.plane.plane_documents.length;o++)f.club.plane.plane_documents[o].id==n&&e.push(f.club.plane.plane_documents[o]);return e}(),f.club.plane.colour&&""!==f.club.plane.colour&&-1==f.club.plane.colour.indexOf("rgba")&&(f.club.plane.colour=k(f.club.plane.colour,.75)),f.club.plane.bg_colour&&""!==f.club.plane.bg_colour&&-1==f.club.plane.bg_colour.indexOf("rgba")&&(f.club.plane.bg_colour=k(f.club.plane.bg_colour,.25)),r.Update(f.club.plane).then(function(e){a.go("dashboard.manage_club.planes")})},f.save_new_aircraft_bit=function(e,t){var n="plane_"+e+"_"+t,o="plane_"+e+"_"+t+"_replace",i={},i=f[n]&&""!==f[n]?(f[n].removed_date=f[o].removed_date,delete f[o].removed_date,{old_item:f[n],new_item:f[o],plane_id:f.club.plane.id,item:e,no:t}):{old_item:{},new_item:f[o],plane_id:f.club.plane.id,item:e,no:t};r.UpdateAircraftBit(i).then(function(e){a.go("dashboard.manage_club.planes")})},o.add_item=function(e){switch(e){case"licence":var t;f.temporary.licence&&""!==f.temporary.licence&&f.temporary.rating&&""!==f.temporary.rating?(0==y(t={licence_id:f.temporary.licence.id,licence_title:f.temporary.licence.abbreviation,rating_title:f.temporary.rating.abbreviation,rating_id:f.temporary.rating.id},f.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&f.club.plane.requirements.licence.push(t),delete f.temporary.licence,delete f.temporary.rating):m.warning("Missing Licence","Please select a licence and rating that is required to book the plane solo!");break;case"medical":f.temporary.medical_authority&&""!==f.temporary.medical_authority&&f.temporary.medical_component&&""!==f.temporary.medical_component?(0==y(n={authority_id:f.temporary.medical_authority.id,authority_title:f.temporary.medical_authority.abbreviation,medical_component_id:f.temporary.medical_component.id,medical_component_title:f.temporary.medical_component.title},f.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&f.club.plane.requirements.medical.push(n),delete f.temporary.medical_authority,delete f.temporary.medical_component):m.warning("Missing Medical","Please select a medical that is required to book the plane solo!");break;case"differences":var n;f.temporary.difference&&""!==f.temporary.difference?(0==y(n={difference_id:f.temporary.difference.id,difference_title:f.temporary.difference.title},f.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&f.club.plane.requirements.differences.push(n),delete f.temporary.difference):m.warning("Missing Difference","Please select a difference that is required to book the plane solo!")}},o.remove_item=function(e,t){f.club.plane.requirements[e].splice(t,1)},o.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},o.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user_id,t.id).then(function(e){e.success&&(f.plane_documents=[],o.processFiles(current_files))})},f.files={radio:[],cert:[],insurance:[],noise:[]},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,f.files[t].push(e[0].file)},o.set_title=function(e){return e.save_name},o.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],o.processFiles(t))})},o.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},o.save_plane_documents=function(){},o.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};o.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;c.info("PRESSED GO: ",t),r.Delete(t).then(function(){f.club.planes=$.grep(f.club.planes,function(e){return e.id!=t})})},function(){c.info("Modal dismissed at: "+new Date)})},f.aircraft,f.plane_search,f.plane_to_add,o.get_aircraft=function(t){3<t.length&&r.GetAddAircraft(t).then(function(e){!e||0==e.length?f.aircraft=[{icao_type:"not known",registration:t.toUpperCase()}]:f.aircraft=e})}}function DashboardClubInstructorChargesController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];switch(f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.charge_type=["brakes","session","plane"],f.action){case"add":f.page_title="Add a Instructor Charge";break;case"edit":p.GetById(a.id).then(function(e){f.club.item=e.item,f.page_title="Edit an instructor charge - "+f.club.item.title});break;case"list":p.GetByClubId(f.club_id).then(function(e){f.club.items=e.items})}function b(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}i.back=function(){l.history.back()},f.clearFieldError=function(e){m.clearFieldError(e)},i.save=function(){var e=[{ok:f.club.item.title,field:"title",label:"Instructing Type / Name"},{ok:f.club.item.charge_type,field:"description",label:"Charged By"},{ok:null!=f.club.item.price&&""!==f.club.item.price,field:"price",label:"Cost per Unit"}];m.validateForm(e)&&("add"==f.action?i.create():i.update())},i.create=function(){f.club.item.club_id=f.club_id,p.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.instructor_charges",{},{reload:!0})})},i.delete=function(){m.warning("Confirm Delete","Are you sure you would like to delete this item?"),p.Delete(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,p.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.instructor_charges",{},{reload:!0})})},i.add_item=function(e){switch(e){case"licence":var t;f.temporary.licence&&""!==f.temporary.licence&&f.temporary.rating&&""!==f.temporary.rating?(0==b(t={licence_id:f.temporary.licence.id,licence_title:f.temporary.licence.abbreviation,rating_title:f.temporary.rating.abbreviation,rating_id:f.temporary.rating.id},f.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&f.club.plane.requirements.licence.push(t),delete f.temporary.licence,delete f.temporary.rating):m.warning("Selection Required","Please select a licence and rating that is required to book the plane solo!");break;case"medical":f.temporary.medical_authority&&""!==f.temporary.medical_authority&&f.temporary.medical_component&&""!==f.temporary.medical_component?(0==b(n={authority_id:f.temporary.medical_authority.id,authority_title:f.temporary.medical_authority.abbreviation,medical_component_id:f.temporary.medical_component.id,medical_component_title:f.temporary.medical_component.title},f.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&f.club.plane.requirements.medical.push(n),delete f.temporary.medical_authority,delete f.temporary.medical_component):m.warning("Selection Required","Please select a medical that is required to book the plane solo!");break;case"differences":var n;f.temporary.difference&&""!==f.temporary.difference?(0==b(n={difference_id:f.temporary.difference.id,difference_title:f.temporary.difference.title},f.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&f.club.plane.requirements.differences.push(n),delete f.temporary.difference):m.warning("Selection Required","Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){f.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubInvoicesController(e,n,t,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C,S){var x=this;x.clubs=[],x.user=c.globals.currentUser,x.user_id=x.user.id,x.club_id=x.user.current_club_admin.id,x.to_date=new Date,x.from_date=new Date,x.from_date.setMonth(x.from_date.getMonth()-1),x.show_pay_now=!1,x.show_loading=!1,x.last_invoice_opened={};function O(e){var t=new Date(e),n=t.getDay(),n=t.getDate()-n+(0===n?-6:1);return new Date(e.setDate(n))}x.donConfirm=function(e,t){x.complete_invoice(e,t)},x.default_payment="direct-debit",x.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!1},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],x.savedCards=[],x.complete_invoice=function(e,t){e={user_id:x.last_invoice_opened.user_id,club_id:x.last_invoice_opened.club_id,paymentIntent:t,invoice_id:x.last_invoice_opened.id,method:e};n.ProcessPayment(e).then(function(e){e.success&&o.GetClubInvoices(x.club_id,x.from_date,x.to_date).then(function(e){x.invoices=e.invoices,x.totals=e.totals,x.show_pay_now=!1,x.show_loading=!1})})},x.close_pay_now=function(){x.show_pay_now=!1,x.show_loading=!1},x.show_payment_option=function(e){e=e.status;return"pending_submission"==e||"issued"==e},x.info,x.show_payment=function(e){x.last_invoice_opened=e,x.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.id},i.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(x.info=e.info,x.savedCards=e.cards,0<x.savedCards.length?x.methods[1].visible=!0:x.methods[1].visible=!1,x.machine=e.machine,x.machine.success?x.methods[3].visible=!0:x.methods[3].visible=!1,x.show_pay_now=!0)})},x.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},x.quick_select={},x.base_date=new Date,x.yesterday=new Date,x.sevendaysago=new Date,x.thirtydaysago=new Date,x.yesterday.setDate(x.yesterday.getDate()-1),x.sevendaysago.setDate(x.yesterday.getDate()-7),x.thirtydaysago.setDate(x.yesterday.getDate()-30);var D,M=new Date,I=new Date(M.getFullYear(),M.getMonth(),1),c=new Date(M.getFullYear(),M.getMonth()+1,0),e=new Date(M.getFullYear(),M.getMonth()-1,1),M=new Date(M.getFullYear(),M.getMonth(),0);function P(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){m.info("!!saveBlob method failed with the following exception:"),m.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){m.info("Download link method with simulated click failed with the following exception:"),m.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){m.info("Download link method with window.location failed with the following exception:"),m.info(e)}}}return o||(m.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}x.quick_selects=[{title:"Today",from_date:x.base_date,to_date:x.base_date},{title:"Yesterday",from_date:x.yesterday,to_date:x.yesterday},{title:"Last 7 days",from_date:x.sevendaysago,to_date:x.base_date},{title:"Last 30 days",from_date:x.thirtydaysago,to_date:x.yesterday},{title:"This week",from_date:O(new Date),to_date:(D=O(new Date),(D=new Date(D)).setDate(D.getDate()+6),D)},{title:"This month",from_date:I,to_date:c},{title:"Last month",from_date:e,to_date:M}],x.update_qs=function(){x.from_date=x.quick_select.from_date,x.to_date=x.quick_select.to_date,x.update_date_range()},x.update_date_range=function(){o.GetClubInvoices(x.club_id,x.from_date,x.to_date).then(function(e){x.invoices=e.invoices,x.totals=e.totals})},x.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(t=1==t?"":"-")+n+":"+e},o.GetClubInvoices(x.club_id,x.from_date,x.to_date).then(function(e){x.invoices=e.invoices,x.totals=e.totals}),d.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},x.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},d.search=function(e){return!(!e.plane_registration||-1===angular.lowercase(e.plane_registration).indexOf(angular.lowercase(d.my_search)||""))||(-1!==angular.lowercase(e.invoice_number).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(e.user.last_name).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(parseFloat(e.total).toFixed(2).toString()).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(d.my_search)||""))},d.show_more=function(e){x.invoices[e].show_more=!x.invoices[e].show_more},d.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},d.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");C.get("/api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){P(e,n)}).error(function(e,t){S.error("Download Error","There was an error downloading the selected document(s).")})},d.downloadInvoice=function(e){C.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){P(e,n)}).error(function(e,t){S.error("Download Error","There was an error downloading the selected document(s).")})}}function DashboardClubItemsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={},f.page_title="",f.plane_document={},f.plane_documents=[];switch(f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.action){case"add":f.page_title="Add a New Plane";break;case"edit":p.GetById(a.item_id).then(function(e){f.club.item=e.item,f.page_title="Edit an Item - "+f.club.item.title});break;case"list":p.GetByClubId(f.club_id).then(function(e){f.club.items=e.items})}i.back=function(){l.history.back()},f.clearFieldError=function(e){m.clearFieldError(e)},i.save=function(){f.club.item||(f.club.item={});var e=[{ok:f.club.item.title,field:"title",label:"Title"},{ok:null!=f.club.item.cost&&""!==f.club.item.cost,field:"cost",label:"Cost"},{ok:null!=f.club.item.number_available&&""!==f.club.item.number_available,field:"number_available",label:"Number Available"},{ok:f.club.item.cost_schedule,field:"cost_schedule",label:"Cost Schedule"}];m.validateForm(e)&&("add"==f.action?i.create():i.update())},i.create=function(){f.club.item.club_id=f.club_id,p.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.items")})},i.delete=function(e){confirm("Are you sure you would like to delete this item?")&&p.Delete(f.user.id,e.id).then(function(e){e.success?p.GetByClubId(f.club_id).then(function(e){f.club.items=e.items}):m.error("Delete Error","An error occurred when trying to delete this item.")})},i.update=function(){f.club.item.club_id=f.club_id,p.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.items")})};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubLessonController(e,t,n,i,o,r,a,s,c,l,d){var u=this;u.user=null,u.allUsers=[],u.club={lesson:{}},u.page_title="",u.lesson_document={},u.lesson_documents=[];var _=[];switch(u.action=o.current.data.action,u.user=t.globals.currentUser,u.club_id=t.globals.currentUser.current_club_admin.id,u.user_id=u.user.id,u.lesson_certificate={},u.lesson_noise={},u.lesson_radio={},u.lesson_maintenance={},u.lesson_insurance={},u.club.lessons=[],u.club.lesson={},u.lessonContentTab="upload",u.contentFiles=[],u.uploadQueue=[],u.uploadProgress={},u.isUploading=!1,u.dragOver=!1,u.pdfSelector={active:!1,file:null,fileName:"",pages:[],totalPages:0,selectedPages:[],loading:!1,error:null},u.new_tem={threat:"",consequence:"",mitigation:""},u.new={preflight:{title:"",bullet_format:"0"},airex:{title:"",bullet_format:"0"},debrief:{title:"",bullet_format:"0"}},u.editing=!1,u.action){case"add":u.page_title="Add a New Course";break;case"edit":u.editing=!0,l.GetLessonById(r.lesson_id).then(function(e){u.club.lesson=e.item}),m(),p(),f(),b()}function p(){l.GetBulletsByLessonId(r.lesson_id).then(function(e){u.bullets=e.bullets})}function m(){l.GetTemByLessonId(r.lesson_id).then(function(e){u.tem=e.items})}function f(){l.GetItemsByLessonId(r.lesson_id).then(function(e){u.items=e.items})}function g(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}function b(){l.GetLessonContentFiles(r.lesson_id).then(function(e){e&&e.items?(u.contentFiles=e.items,angular.forEach(u.contentFiles,function(t){t._loading=!0,t.data_uri=null,l.GetLessonContentFileData(t.id).then(function(e){e&&e.success&&(t.data_uri=e.data_uri,t.file_base64=e.file),t._loading=!1}).catch(function(){t._loading=!1,t._loadError=!0})})):u.contentFiles=[]})}u.add_tem=function(){u.new_tem.lesson_id=r.lesson_id,u.new_tem.organise=u.tem&&0<u.tem.length?u.tem.length:0,l.CreateTem(u.new_tem).then(function(e){e.success?(u.tem.push(e.item),u.new_tem={threat:"",consequence:"",mitigation:""}):d.error("Error","An error occurred")})},u.update_tem=function(e,t){delete e.edit_me,l.UpdateTem(e).then(function(e){e.success?u.tem[t].edit_me=!1:d.error("Error","An error occurred")})},u.update_cancel=function(e){m()},u.edit_tem=function(e){u.tem[e].edit_me=!0},u.delete_tem=function(e,t){l.DeleteTem(e.id).then(function(e){e.success?u.tem.splice(t,1):d.error("Error","An error occurred")})},u.add_bullet=function(t){var e=u.bullets[t]&&0<u.bullets[t].length?u.bullets[t].length:0,e={title:u.new[t].title,bullet_format:u.new[t].bullet_format,lesson_id:r.lesson_id,bullet_type:t,organise:e};l.CreateBullet(e).then(function(e){e.success?(u.bullets[t]?u.bullets[t].push(e.item):u.bullets[t]=Array(e.item),u.new[t].title="",u.new[t].bullet_format="0"):d.error("Error","An error occurred")})},u.update_bullet=function(t,e,n){delete e.edit_me,l.UpdateBullet(e).then(function(e){e.success?u.bullets[t][n].edit_me=!1:d.error("Error","An error occurred")})},u.update_cancel_bullet=function(e){p()},u.edit_bullet=function(e,t){u.bullets[e][t].edit_me=!0},u.delete_bullet=function(t,e,n){l.DeleteBullet(e.id).then(function(e){e.success?u.bullets[t].splice(n,1):d.error("Error","An error occurred")})},i.save_bullet_order=function(e){for(var t=[],n=0;n<u.bullets[e].length;n++){var o={id:u.bullets[e][n].id,organise:n};t.push(o)}l.UpdateBulletOrder({order:t}).then(function(e){})},i.save_items_order=function(){for(var e=[],t=0;t<u.items.length;t++){var n={id:u.items[t].id,organise:t};e.push(n)}l.UpdateItemsOrder({order:e}).then(function(e){})},i.save_tem_order=function(){for(var e=[],t=0;t<u.tem.length;t++){var n={id:u.tem[t].id,organise:t};e.push(n)}l.UpdateTemOrder({order:e}).then(function(e){})},u.add_item=function(){u.new_item.lesson_id=r.lesson_id,u.new_item.organise=u.items&&0<u.items.length?u.items.length:0,l.CreateItem(u.new_item).then(function(e){e.success?(u.items.push(e.item),u.new_item={title:""}):d.error("Error","An error occurred")})},u.update_item=function(e,t){delete e.edit_me,l.UpdateItem(e).then(function(e){e.success?u.items[t].edit_me=!1:d.error("Error","An error occurred")})},u.update_cancel_item=function(e){f()},u.edit_item=function(e){u.items[e].edit_me=!0},u.delete_item=function(e,t){l.DeleteItem(e.id).then(function(e){e.success?u.items.splice(t,1):d.error("Error","An error occurred")})},i.back=function(){c.history.back()},u.clearFieldError=function(e){d.clearFieldError(e)},i.save=function(){var e=[{ok:u.club.lesson.title,field:"title",label:"Lesson Title"}];d.validateForm(e)&&i.update()},i.create=function(){var e=[{ok:u.club.lesson.title,field:"title",label:"Lesson Title"}];d.validateForm(e)&&(u.club.lesson.course_id=r.course_id,l.CreateLesson(u.club.lesson).then(function(e){o.go("dashboard.manage_club.edit_lesson",{course_id:u.club.lesson.course_id,lesson_id:e.id,reload:!0})}))},i.delete=function(){d.warning("Confirm Delete","Are you sure you would like to delete this lesson?"),l.DeleteLesson(u.club.lesson.id).then(function(e){})},i.update=function(){l.UpdateLesson(u.club.lesson).then(function(e){o.go("dashboard.manage_club.edit_course",{course_id:u.club.lesson.course_id,reload:!0})})},i.add_item=function(e){switch(e){case"licence":var t;u.temporary.licence&&""!==u.temporary.licence&&u.temporary.rating&&""!==u.temporary.rating?(0==g(t={licence_id:u.temporary.licence.id,licence_title:u.temporary.licence.abbreviation,rating_title:u.temporary.rating.abbreviation,rating_id:u.temporary.rating.id},u.club.lesson.requirements.licence,new Array("licence_id","rating_id"))&&u.club.lesson.requirements.licence.push(t),delete u.temporary.licence,delete u.temporary.rating):d.warning("Missing Licence","Please select a licence and rating that is required to book the lesson solo!");break;case"medical":u.temporary.medical_authority&&""!==u.temporary.medical_authority&&u.temporary.medical_component&&""!==u.temporary.medical_component?(0==g(n={authority_id:u.temporary.medical_authority.id,authority_title:u.temporary.medical_authority.abbreviation,medical_component_id:u.temporary.medical_component.id,medical_component_title:u.temporary.medical_component.title},u.club.lesson.requirements.medical,new Array("authority_id","medical_component_id"))&&u.club.lesson.requirements.medical.push(n),delete u.temporary.medical_authority,delete u.temporary.medical_component):d.warning("Missing Medical","Please select a medical that is required to book the lesson solo!");break;case"differences":var n;u.temporary.difference&&""!==u.temporary.difference?(0==g(n={difference_id:u.temporary.difference.id,difference_title:u.temporary.difference.title},u.club.lesson.requirements.differences,new Array("difference_id","difference_title"))&&u.club.lesson.requirements.differences.push(n),delete u.temporary.difference):d.warning("Missing Difference","Please select a difference that is required to book the lesson solo!")}},i.update_this_file=function(e){-1===_.indexOf(e.id)&&_.push(e.id)},i.remove_real_file=function(t){u.club.lesson.lesson_documents=$.grep(u.club.lesson.lesson_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(u.user_id,t.id).then(function(e){e.success&&(u.lesson_documents=[],i.processFiles(current_files))})},u.files={radio:[],cert:[],insurance:[],noise:[]},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,u.files[t].push(e[0].file)},i.set_title=function(e){return e.save_name},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(u.lesson_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,u.lesson_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},u.switchContentTab=function(e){u.lessonContentTab=e},u.triggerFileInput=function(){var e=document.getElementById("lesson-content-file-input");e&&e.click()},u.onFileInputChange=function(e){e&&0<e.length&&u.handleSelectedFiles(e)},u.handleSelectedFiles=function(e){for(var t=["image/png","image/jpeg","image/jpg","application/pdf"],n=0;n<e.length;n++){var o=e[n];if(-1!==t.indexOf(o.type))if(20971520<o.size)d.error("File Too Large",o.name+" exceeds the 20MB limit.");else{if("application/pdf"===o.type)return void u.openPdfSelector(o);u.addImageToQueue(o)}else d.error("Invalid File Type",o.name+" is not a supported format. Please use PNG, JPG, or PDF.")}i.$applyAsync()},u.addImageToQueue=function(t){var e=new FileReader;e.onload=function(e){i.$apply(function(){u.uploadQueue.push({file:t,name:t.name,size:t.size,type:t.type,preview:e.target.result,isPdf:!1,pdfPages:null})})},e.readAsDataURL(t)},u.removeFromQueue=function(e){u.uploadQueue.splice(e,1)},u.openPdfSelector=function(e){u.pdfSelector.active=!0,u.pdfSelector.file=e,u.pdfSelector.fileName=e.name,u.pdfSelector.pages=[],u.pdfSelector.selectedPages=[],u.pdfSelector.totalPages=0,u.pdfSelector.loading=!0,u.pdfSelector.error=null;var t=new FileReader;t.onload=function(e){e=new Uint8Array(e.target.result);"undefined"!=typeof pdfjsLib?pdfjsLib.getDocument({data:e}).promise.then(function(e){i.$apply(function(){u.pdfSelector.totalPages=e.numPages});for(var t=[],n=1;n<=e.numPages;n++)t.push(function(e,i){return e.getPage(i).then(function(e){var t=e.getViewport({scale:1.5}),n=document.createElement("canvas"),o=n.getContext("2d");return n.height=t.height,n.width=t.width,e.render({canvasContext:o,viewport:t}).promise.then(function(){return{pageNum:i,thumbnail:n.toDataURL("image/png"),selected:!1}})})}(e,n));Promise.all(t).then(function(e){i.$apply(function(){u.pdfSelector.pages=e,u.pdfSelector.loading=!1})})}).catch(function(e){i.$apply(function(){u.pdfSelector.loading=!1,u.pdfSelector.error="Failed to read PDF file. Please ensure it is a valid PDF."})}):i.$apply(function(){u.pdfSelector.loading=!1,u.pdfSelector.error="PDF viewer library not loaded. Please refresh the page and try again."})},t.readAsArrayBuffer(e)},u.togglePdfPage=function(t){t.selected?(t.selected=!1,u.pdfSelector.selectedPages=u.pdfSelector.selectedPages.filter(function(e){return e!==t.pageNum})):2<=u.pdfSelector.selectedPages.length?d.warning("Page Limit","You can select a maximum of 2 pages per PDF file."):(t.selected=!0,u.pdfSelector.selectedPages.push(t.pageNum))},u.confirmPdfPages=function(){var e;0!==u.pdfSelector.selectedPages.length?(e=u.pdfSelector.pages.filter(function(e){return e.selected}).map(function(e){return{pageNum:e.pageNum,thumbnail:e.thumbnail}}),u.uploadQueue.push({file:u.pdfSelector.file,name:u.pdfSelector.fileName,size:u.pdfSelector.file.size,type:"application/pdf",preview:e[0].thumbnail,isPdf:!0,pdfPages:u.pdfSelector.selectedPages.slice().sort(),pdfThumbnails:e}),u.closePdfSelector()):d.warning("No Pages Selected","Please select at least one page from the PDF.")},u.closePdfSelector=function(){u.pdfSelector.active=!1,u.pdfSelector.file=null,u.pdfSelector.pages=[],u.pdfSelector.selectedPages=[],u.pdfSelector.totalPages=0,u.pdfSelector.loading=!1,u.pdfSelector.error=null},u.uploadAllFiles=function(){if(0!==u.uploadQueue.length){u.isUploading=!0;for(var e=[],t=0;t<u.uploadQueue.length;t++)e.push(function(e,t){var n=new FormData;n.append("file",e.file),n.append("lesson_id",r.lesson_id),n.append("file_type",e.isPdf?"pdf":"image"),e.isPdf&&e.pdfPages&&n.append("pdf_pages",JSON.stringify(e.pdfPages));return u.uploadProgress[t]=0,l.UploadLessonContentFile(n).then(function(e){if(i.$applyAsync(function(){u.uploadProgress[t]=100}),!e.success)throw new Error(e.message||"Upload failed");return e}).catch(function(e){throw i.$applyAsync(function(){u.uploadProgress[t]=-1}),e})}(u.uploadQueue[t],t));Promise.all(e).then(function(){i.$apply(function(){u.isUploading=!1,u.uploadQueue=[],u.uploadProgress={},b(),d.success("Upload Complete","Your lesson content files have been uploaded successfully.")})}).catch(function(){i.$apply(function(){u.isUploading=!1,d.error("Upload Error","One or more files failed to upload. Please try again.")})})}else d.warning("No Files","Please add at least one file to upload.")},i.save_content_files_order=function(){for(var e=[],t=0;t<u.contentFiles.length;t++)e.push({id:u.contentFiles[t].id,organise:t});l.UpdateLessonContentFilesOrder({order:e}).then(function(e){e.success&&d.success("Order Saved","File order has been updated.")})},u.deleteContentFile=function(e,t){confirm("Are you sure you want to delete this file?")&&l.DeleteLessonContentFile(e.id).then(function(e){e.success?(u.contentFiles.splice(t,1),d.success("Deleted","File has been removed.")):d.error("Error","Failed to delete the file.")})},u.replaceContentFile=function(n){var e=document.createElement("input");e.type="file",e.accept=".png,.jpg,.jpeg,.pdf",e.onchange=function(e){var t=e.target.files[0];t&&(-1!==["image/png","image/jpeg","image/jpg","application/pdf"].indexOf(t.type)?"application/pdf"!==t.type?((e=new FormData).append("file",t),e.append("lesson_id",r.lesson_id),e.append("file_type","image"),l.UpdateLessonContentFile(n.id,e).then(function(e){e.success?(b(),d.success("Replaced","File has been updated.")):d.error("Error","Failed to replace the file.")})):i.$apply(function(){u.replacingFileId=n.id,u.openPdfSelector(t)}):i.$apply(function(){d.error("Invalid File Type","Please use PNG, JPG, or PDF.")}))},e.click()},u.formatFileSize=function(e){if(!e)return"0 B";var t=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,t)).toFixed(1)+" "+["B","KB","MB","GB"][t]},u.getFileTypeIcon=function(e){return e?-1<e.indexOf("pdf")?"fa-file-pdf":-1<e.indexOf("image")?"fa-file-image":"fa-file":"fa-file"}}function DashboardClubMaintenanceController(e,a,t,n,o,s,i,r,_,c,l,d,u,p,m,f,g,b,h,k){var y=this;y.user=null,y.allUsers=[],y.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},y.page_title="",y.plane_document={},y.plane_documents=[];var v=[];function w(){a.GetAllByClubMaintenance(y.club_id).then(function(e){y.club.planes=e})}function C(){a.GetByIdMaintenance2(i.plane_id,y.club_id).then(function(e){y.club.plane=e,y.this_plane_id=i.plane_id,y.club.plane&&y.club.plane.maintenance&&(y.obj.hours_remaining=y.club.plane.maintenance.hours_remaining,y.obj.next_check=new Date(y.club.plane.maintenance.next_maintenance),y.obj.check_date=new Date,y.obj.extension_granted=new Date),y.page_title="Edit a Plane Maintenance - "+y.club.plane.registration}),a.GetOpenIssues(i.plane_id).then(function(e){y.reported_defects=e}),g.GetByPlane(i.plane_id).then(function(e){!1!==e.success&&(y.workpacks=e.workpacks||[])}),g.GetOpenByPlane(i.plane_id).then(function(e){!1!==e.success&&(y.open_workpacks=e.workpacks||[])}),a.GetMaintenanceEvents(i.plane_id).then(function(e){e&&e.maintenance_events?y.maintenance_events=e.maintenance_events:e&&e.events?y.maintenance_events=e.events:Array.isArray(e)&&(y.maintenance_events=e)})}switch(y.currency_types=["class","type"],y.gear_types=["tricycle","tailwheel","monowheel","floats","skis"],y.charge_type=["brakes","tacho","hobbs"],y.surcharge_type=["none","flight","hour"],y.action=i.plane_id?"edit":s.current.data.action||"list",y.user=t.globals.currentUser,y.club_id=t.globals.currentUser.current_club_admin.id,y.user_id=y.user.id,y.show_overlay=!1,y.show_cert=!1,y.show_maintenance=!1,y.show_radio=!1,y.show_noise=!1,y.show_insurance=!1,y.show_offline=!1,y.show_crs=!1,y.crs_records=[],y.obj={issues:[],issue_confirmation:!1},y.reported_defects=[],y.maintenance_types=["annual","25hours","50hours","100hours","interim","6months","extension","workpack"],y.workpacks=[],y.workpack=null,y.open_workpacks=[],y.new_workpack={},y.show_create_workpack=!1,y.show_workpack_detail=!1,y.workpack_files={workpack_doc:[]},y.defect_workpack_files={defect_wp_doc:[]},y.show_link_defect=!1,y.show_link_maintenance=!1,y.show_defect_workpack=!1,y.selected_defect_for_wp=null,y.defect_wp={},y.maintenance_events=[],y.selected_event=null,y.show_event_detail=!1,y.event_filter="all",y.available_logbooks=[],y.event_logbook_links=[],y.logbook_checkboxes=[],y.saving_logbook_links=!1,y.logbook_load_error=!1,y.create_logbook_checkboxes=[],y.create_logbook_loading=!1,y.create_logbook_error=!1,y.action){case"add":y.page_title="Add a New Plane";break;case"edit":C();var S=o.$on("$stateChangeSuccess",function(e,t){"dashboard.manage_club.maintenance.detail"===t.name&&C()});o.$on("$destroy",S);break;case"list":w();S=o.$on("$stateChangeSuccess",function(e,t){"dashboard.manage_club.maintenance"===t.name&&w()});o.$on("$destroy",S)}function x(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}y.reset_aeroplane=function(){y.this_plane_id&&0<y.this_plane_id?confirm("Are you sure you wish to override the logs?")&&m.ResetOneClubPlane(y.this_plane_id).then(function(e){e.success&&k.success("Reset Complete","Logbooks have been re-checked.")}):k.error("Error","An unexpected error occurred.")},y.selected_type="",y.send_obj={},o.show_overlay=function(e){y.show_overlay=!0,"maintenance"==(y.selected_type=e)?(y.show_cert=!0,y.show_insurance=!0,y.show_radio=!0,y.show_maintenance=!0,y.show_noise=!0,y.show_crs=!0,y.show_offline=!1,y.new_workpack={status:"completed"},y.workpack_files={workpack_doc:[]},y.loadCreateLogbooks()):"crs"==e?(y.show_cert=!1,y.show_insurance=!1,y.show_radio=!1,y.show_maintenance=!1,y.show_noise=!1,y.show_crs=!0,y.show_offline=!1):"cert"==e?(y.show_cert=!0,y.show_insurance=!1,y.show_radio=!1,y.show_maintenance=!1,y.show_noise=!1,y.show_crs=!1,y.show_offline=!1):"insurance"==e?(y.show_cert=!1,y.show_insurance=!0,y.show_radio=!1,y.show_maintenance=!1,y.show_noise=!1,y.show_crs=!1,y.show_offline=!1):"radio"==e?(y.show_cert=!1,y.show_insurance=!1,y.show_radio=!0,y.show_maintenance=!1,y.show_noise=!1,y.show_crs=!1,y.show_offline=!1):"noise"==e?(y.show_cert=!1,y.show_insurance=!1,y.show_radio=!1,y.show_maintenance=!1,y.show_noise=!0,y.show_crs=!1,y.show_offline=!1):"offline"==e&&(y.show_cert=!1,y.show_insurance=!1,y.show_offline=!0,y.show_radio=!1,y.show_noise=!1,y.show_crs=!1,y.show_maintenance=!1)},o.close_overlay=function(){y.show_overlay=!1},o.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},o.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},o.count_defects=function(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=0,o=0;o<e.length;o++)(1==t||"open"==e[o].status)&&n++;return n},o.save_overlay=function(){var e=y.obj,t=!(e.files={radio:y.files.radio[0]?y.files.radio[0].file:{},cert:y.files.cert[0]?y.files.cert[0].file:{},noise_cert:y.files.noise_cert[0]?y.files.noise_cert[0].file:{},insurance:y.files.insurance[0]?y.files.insurance[0].file:{}});e.selected_type=y.selected_type;var n,o={};if(y.one_ticked){for(var i=0;i<y.reported_defects.length;i++)y.reported_defects[i].resolved&&y.obj.issues.push(y.reported_defects[i]);o.issues=y.obj.issues,0<o.issues.length&&(t=!0)}if(y.files.radio[0]&&null==y.obj.radio_expiry||!y.files.radio[0]&&y.obj.radio_expiry)return k.warning("Radio Incomplete","Please add both the expiry date and the new certificate."),!1;if(y.files.radio[0]&&y.obj.radio_expiry&&(o.radio={file:y.files.radio[0]?y.files.radio[0].file:{},expiry:y.obj.radio_expiry},t=!0),y.files.cert[0]&&null==y.obj.certificate_expiry||null==y.files.cert[0]&&y.obj.certificate_expiry)return k.warning("Certificate Incomplete","Please add both the expiry date and the new certificate."),!1;if(y.files.cert[0]&&y.obj.certificate_expiry&&(o.cert={file:y.files.cert[0]?y.files.cert[0].file:{},expiry:y.obj.certificate_expiry,date_issued:y.obj.certificate_issue},t=!0),y.files.insurance[0]&&!y.obj.insurance_expiry||null==y.files.insurance[0]&&y.obj.insurance_expiry)return k.warning("Insurance Incomplete","Please add both the expiry date and the new certificate."),!1;if(y.files.insurance[0]&&y.obj.insurance_expiry&&(o.insurance={file:y.files.insurance[0]?y.files.insurance[0].file:{},expiry:y.obj.insurance_expiry},t=!0),y.files.noise_cert[0]&&!y.obj.noise_date||null==y.files.noise_cert[0]&&y.obj.noise_date)return k.warning("Noise Certificate Incomplete","Please add both the date and the certificate, or leave both empty."),!1;if(y.files.noise_cert[0]&&y.obj.noise_date&&(o.noise_cert={file:y.files.noise_cert[0]?y.files.noise_cert[0].file:{},noise_level:y.obj.noise_level,date_issued:y.obj.noise_date},t=!0),y.files.crs[0]){if(!y.obj.crs_release_date||!y.obj.crs_release_time)return k.warning("CRS Incomplete","Please add the release date, release time, and the certificate."),!1;e={plane_id:parseInt(y.this_plane_id),release_date:moment(y.obj.crs_release_date).format("YYYY-MM-DD"),release_time:moment(y.obj.crs_release_time).format("HH:mm:ss"),file:y.files.crs[0].file};o.crs=e,t=!0}else if(y.obj.crs_release_date||y.obj.crs_release_time)return k.warning("CRS Incomplete","Please upload the certificate document along with the release date and time."),!1;if(y.show_maintenance){if(!y.obj.maintenance_type||""===y.obj.maintenance_type)return k.warning("Maintenance Type Required","Please select a maintenance type."),!1;if(!y.obj.check_time)return k.warning("Time Required","Please enter the time of maintenance."),!1;if(!y.obj.checked_by||""===y.obj.checked_by.trim())return k.warning("Checked By Required","Please enter who checked/signed off the maintenance."),!1;if("extension"!==y.obj.maintenance_type&&!y.obj.check_date)return k.warning("Date Required","Please enter the date of maintenance."),!1;if("extension"===y.obj.maintenance_type&&!y.obj.extension_granted)return k.warning("Date Required","Please enter the extension granted date."),!1;if(void 0!==y.obj.maintenance_type&&"extension"!==y.obj.maintenance_type||void 0!==y.obj.hours_remaining||void 0!==y.obj.next_check){if(""===y.obj.maintenance_type&&void 0===y.obj.maintenance_type||void 0===y.obj.hours_remaining&&""===y.obj.hours_remaining||void 0===y.obj.next_check||""===y.obj.next_check)return k.warning("Maintenance Incomplete","Please add check date, next check, and hours remaining."),!1;var r=moment(moment(y.obj.check_date).format("YYYY-MM-DD")+" "+moment(y.obj.check_time).format("HH:mm:ss")).format("YYYY-MM-DD HH:mm:ss");o.maintenance={maintenance_type:y.obj.maintenance_type,hours_remaining:y.obj.hours_remaining,check_date:r,expiry_date:y.obj.next_check,checked_by:y.obj.checked_by,description:y.obj.notes},"existing"===y.obj.workpack_option&&y.obj.workpack_id&&(o.maintenance.workpack_id=parseInt(y.obj.workpack_id)),t=!0}if("extension"==y.obj.maintenance_type){if(""===y.obj.extension_hours&&""===y.obj.extension_days)return k.warning("Maintenance Incomplete","Please add check date, next check, and hours remaining."),!1;r=moment(moment(y.obj.extension_granted).format("YYYY-MM-DD")+" "+moment(y.obj.check_time).format("HH:mm:ss")).format("YYYY-MM-DD HH:mm:ss");o.extension={maintenance_type:y.obj.maintenance_type,extension_hours:y.obj.extension_hours,extension_days:y.obj.extension_days,extension_granted:r,description:y.obj.notes},t=!0}}if(y.show_offline){if(""===y.obj.offline_until&&""===y.obj.offline_notes)return k.warning("Offline Date","Please ensure the offline date is set in the future."),!1;o.offline={offline_until:y.obj.offline_until,offline_notes:y.obj.offline_notes,club_id:y.club_id},t=!0}t?(y.send_obj=o,n=function(e){if(y.reported_defects&&0<y.reported_defects.length)for(var t=0;t<y.reported_defects.length;t++){var n,o=y.reported_defects[t];o.resolved&&(e&&o._link_to_workpack?g.LinkDefect(e,o.id):(o.defect_workpack_number||o.defect_workpack_signatory||o._uploaded_file)&&(n={workpack_number:o.defect_workpack_number||"",signatory:o.defect_workpack_signatory||""},o._uploaded_file&&(n.document_temp_path=o._uploaded_file.temp_path,n.document_extension=o._uploaded_file.extension,n.document_original_name=o._uploaded_file.name),g.UpdateDefectWorkpack(o.id,n)))}},a.AddMaintenance(y.this_plane_id,o).then(function(e){var t;o.crs&&b.Create(o.crs),e.maintenance_check_id&&y.saveCreateLogbookLinks(e.maintenance_check_id),"new"===y.obj.workpack_option&&y.new_workpack.workpack_number?(t={club_id:y.club_id,plane_id:parseInt(y.this_plane_id),workpack_number:y.new_workpack.workpack_number,authorised_signatory:y.new_workpack.authorised_signatory,description:y.new_workpack.description,status:y.new_workpack.status||"completed",created_by_user_id:y.user_id},e.maintenance_check_id&&(t.maintenance_check_id=e.maintenance_check_id),y.workpack_files.workpack_doc&&0<y.workpack_files.workpack_doc.length&&(e=y.workpack_files.workpack_doc[0],t.document_temp_path=e.temp_path,t.document_extension=e.extension,t.document_original_name=e.name),g.Create(t).then(function(e){e.success?(n(e.id),y.new_workpack={},y.workpack_files={workpack_doc:[]}):k.error("Workpack Error",e.message||"Unknown error"),s.go("dashboard.manage_club.maintenance.detail",{plane_id:y.this_plane_id},{reload:!0})})):(n(),s.go("dashboard.manage_club.maintenance.detail",{plane_id:y.this_plane_id},{reload:!0}))})):k.warning("Nothing Saved","No changes were made  the panel will close."),y.show_overlay=!1},o.check_ticked=function(){for(var e=0,t=0;t<y.reported_defects.length;t++)y.reported_defects[t].resolved&&e++;y.one_ticked=0<e},o.show_cert=function(){y.show_cert=!0},o.close_cert=function(){y.show_cert=!1},o.save_cert=function(){y.show_cert=!1},o.show_insurance=function(){y.show_insurance=!0},o.close_insurance=function(){y.show_insurance=!1},o.save_insurance=function(){y.show_insurance=!1},o.show_radio=function(){y.show_radio=!0},o.close_radio=function(){y.show_radio=!1},o.save_radio=function(){y.show_radio=!1},o.show_noise=function(){y.show_noise=!0},o.close_noise=function(){y.show_noise=!1},o.save_noise=function(){y.show_noise=!1},o.show_maintenance=function(){y.show_maintenance=!0},o.close_maintenance=function(){y.show_maintenance=!1},o.save_maintenance=function(){y.show_maintenance=!1},y.add_defect=function(){var e={club_id:y.club_id,user_id:y.user_id,plane_id:y.this_plane_id,defect:y.defect,severity:y.defect_severity.title,status:"open"};a.AddDefect(e).then(function(e){e.item.can_delete=!0,y.club.plane.defects.push(e.item),y.defect="",y.defect_severity=""})},y.delete_defect=function(e){a.DeleteDefect(e).then(function(e){a.GetOpenIssues(y.bookout.plane_id).then(function(e){y.reported_defects=e})})},o.back=function(){c.history.back()},o.save=function(){"add"==y.action?o.create():o.update()},o.create=function(){y.club.plane.club_id=y.club_id,y.club.plane.add_documents=y.plane_documents,a.Create(y.club.plane).then(function(e){s.go("dashboard.manage_club.planes",{reload:!0})})},o.delete=function(){k.warning("Confirm Delete","Are you sure you would like to delete this plane?"),a.Update(y.club.plane).then(function(e){})},o.getColours=function(e){return e<1?"red":e<5?"warning":e<10?"amber":void 0},o.update=function(){y.club.plane.club_id=y.club_id,y.club.plane.add_documents=y.plane_documents,y.club.plane.update_documents=function(){for(var e=[],t=0;t<v.length;t++)for(var n=v[t],o=0;o<y.club.plane.plane_documents.length;o++)y.club.plane.plane_documents[o].id==n&&e.push(y.club.plane.plane_documents[o]);return e}(),a.Update(y.club.plane).then(function(e){s.go("dashboard.manage_club.planes")})},o.add_item=function(e){switch(e){case"licence":var t;y.temporary.licence&&""!==y.temporary.licence&&y.temporary.rating&&""!==y.temporary.rating?(0==x(t={licence_id:y.temporary.licence.id,licence_title:y.temporary.licence.abbreviation,rating_title:y.temporary.rating.abbreviation,rating_id:y.temporary.rating.id},y.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&y.club.plane.requirements.licence.push(t),delete y.temporary.licence,delete y.temporary.rating):k.warning("Missing Selection","Please select a licence and rating required to book the plane solo.");break;case"medical":y.temporary.medical_authority&&""!==y.temporary.medical_authority&&y.temporary.medical_component&&""!==y.temporary.medical_component?(0==x(n={authority_id:y.temporary.medical_authority.id,authority_title:y.temporary.medical_authority.abbreviation,medical_component_id:y.temporary.medical_component.id,medical_component_title:y.temporary.medical_component.title},y.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&y.club.plane.requirements.medical.push(n),delete y.temporary.medical_authority,delete y.temporary.medical_component):k.warning("Missing Selection","Please select a medical required to book the plane solo.");break;case"differences":var n;y.temporary.difference&&""!==y.temporary.difference?(0==x(n={difference_id:y.temporary.difference.id,difference_title:y.temporary.difference.title},y.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&y.club.plane.requirements.differences.push(n),delete y.temporary.difference):k.warning("Missing Selection","Please select a differences training required to book the plane solo.")}},o.remove_item=function(e,t){y.club.plane.requirements[e].splice(t,1)},o.update_this_file=function(e){-1===v.indexOf(e.id)&&v.push(e.id)},o.remove_real_file=function(t){y.club.plane.plane_documents=$.grep(y.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(y.user_id,t.id).then(function(e){e.success&&(y.plane_documents=[],o.processFiles(current_files))})},o.remove_file=function(e,t){JSON.parse(e.file_return)},y.files={radio:[],cert:[],noise_cert:[],insurance:[],crs:[]},o.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,y.files[t].push(e[n].file)}},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,y.files[t].push(e[0])},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},y.defect_severity,y.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],o.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},o.save_plane_documents=function(){},o.change_file_name=function(t){y.plane_documents=$.grep(y.plane_documents,function(e){return e.temp_path!=t.temp_path}),y.plane_documents.push(t)},y.loadWorkpacks=function(){y.this_plane_id&&g.GetByPlane(y.this_plane_id).then(function(e){!1!==e.success&&(y.workpacks=e.workpacks||[])})},y.loadOpenWorkpacks=function(){y.this_plane_id&&g.GetOpenByPlane(y.this_plane_id).then(function(e){!1!==e.success&&(y.open_workpacks=e.workpacks||[])})},y.createWorkpack=function(){var e,t={club_id:y.club_id,plane_id:parseInt(y.this_plane_id),workpack_number:y.new_workpack.workpack_number,authorised_signatory:y.new_workpack.authorised_signatory,description:y.new_workpack.description,status:y.new_workpack.status||"completed",created_by_user_id:y.user_id};y.workpack_files.workpack_doc&&0<y.workpack_files.workpack_doc.length&&(e=y.workpack_files.workpack_doc[0],t.document_temp_path=e.temp_path,t.document_extension=e.extension,t.document_original_name=e.name),g.Create(t).then(function(e){e.success?(y.show_create_workpack=!1,y.new_workpack={},y.workpack_files={workpack_doc:[]},y.loadWorkpacks(),y.loadOpenWorkpacks()):k.error("Workpack Error",e.message||"Unknown error")})},y.viewWorkpack=function(e){g.GetById(e).then(function(e){!1!==e.success&&(y.workpack=e.workpack,y.show_workpack_detail=!0)})},y.closeWorkpackDetail=function(){y.workpack=null,y.show_workpack_detail=!1,y.show_link_defect=!1,y.show_link_maintenance=!1},y.updateWorkpack=function(e,t){var n;y.workpack&&((n={})[e]=t,g.Update(y.workpack.id,n).then(function(e){e.success&&(y.viewWorkpack(y.workpack.id),y.loadWorkpacks(),y.loadOpenWorkpacks())}))},y.completeWorkpack=function(){y.workpack&&confirm("Are you sure you want to mark this workpack as completed?")&&g.Update(y.workpack.id,{status:"completed"}).then(function(e){e.success&&(y.viewWorkpack(y.workpack.id),y.loadWorkpacks(),y.loadOpenWorkpacks())})},y.reopenWorkpack=function(){y.workpack&&g.Update(y.workpack.id,{status:"open"}).then(function(e){e.success&&(y.viewWorkpack(y.workpack.id),y.loadWorkpacks(),y.loadOpenWorkpacks())})},y.deleteWorkpack=function(){y.workpack&&confirm("Are you sure you want to delete (archive) this workpack? This will unlink all defects and maintenance events.")&&g.Delete(y.workpack.id).then(function(e){e.success&&(y.closeWorkpackDetail(),y.loadWorkpacks(),y.loadOpenWorkpacks())})},y.uploadWorkpackDocument=function(){var e;y.workpack&&y.workpack_files.workpack_doc&&0<y.workpack_files.workpack_doc.length&&(e=y.workpack_files.workpack_doc[0],g.Update(y.workpack.id,{document_temp_path:e.temp_path,document_extension:e.extension,document_original_name:e.name}).then(function(e){e.success&&(y.workpack_files={workpack_doc:[]},y.viewWorkpack(y.workpack.id))}))},y.removeWorkpackDocument=function(){y.workpack&&g.Update(y.workpack.id,{remove_document:!0}).then(function(e){e.success&&y.viewWorkpack(y.workpack.id)})},o.downloadWorkpackDocument=function(e){e&&f.get("/api/v1/maintenance_workpacks/file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){O(e,n)}).error(function(e,t){k.error("Download Error","There was an error downloading the workpack document.")})},y.linkDefectToWorkpack=function(e){y.workpack&&e&&g.LinkDefect(y.workpack.id,e).then(function(e){e.success?(y.show_link_defect=!1,y.viewWorkpack(y.workpack.id)):k.error("Link Error",e.message||"Error linking defect.")})},y.unlinkDefect=function(e){e&&confirm("Unlink this defect from the workpack?")&&g.UnlinkDefect(e).then(function(e){e.success&&y.viewWorkpack(y.workpack.id)})},y.linkMaintenanceToWorkpack=function(e){y.workpack&&e&&g.LinkMaintenance(y.workpack.id,e).then(function(e){e.success?(y.show_link_maintenance=!1,y.viewWorkpack(y.workpack.id)):k.error("Link Error",e.message||"Error linking maintenance event.")})},y.unlinkMaintenance=function(e){e&&confirm("Unlink this maintenance event from the workpack?")&&g.UnlinkMaintenance(e).then(function(e){e.success&&y.viewWorkpack(y.workpack.id)})},y.openDefectWorkpack=function(e){y.selected_defect_for_wp=e,y.defect_wp={workpack_number:e.defect_workpack_number||"",signatory:e.defect_workpack_signatory||""},y.show_defect_workpack=!0},y.closeDefectWorkpack=function(){y.selected_defect_for_wp=null,y.defect_wp={},y.defect_workpack_files={defect_wp_doc:[]},y.show_defect_workpack=!1},y.saveDefectWorkpack=function(){var e,t;y.selected_defect_for_wp&&(e={workpack_number:y.defect_wp.workpack_number,signatory:y.defect_wp.signatory},y.defect_workpack_files.defect_wp_doc&&0<y.defect_workpack_files.defect_wp_doc.length&&(t=y.defect_workpack_files.defect_wp_doc[0],e.document_temp_path=t.temp_path,e.document_extension=t.extension,e.document_original_name=t.name),g.UpdateDefectWorkpack(y.selected_defect_for_wp.id,e).then(function(e){e.success?(y.closeDefectWorkpack(),a.GetByIdMaintenance2(y.this_plane_id,y.club_id).then(function(e){y.club.plane=e})):k.error("Workpack Error",e.message||"Error saving defect workpack info.")}))},y.loadCrs=function(){b.GetAll(y.this_plane_id).then(function(e){e.success&&(y.crs_records=e.plane_crs||[])})},y.deleteCrs=function(e){confirm("Are you sure you want to archive this CRS?")&&b.Delete(e).then(function(e){e.success&&(y.loadCrs(),s.go("dashboard.manage_club.maintenance.detail",{plane_id:y.this_plane_id},{reload:!0}))})},y.downloadCrs=function(e){e&&(e=b.DownloadFile(e),c.open(e,"_blank"))},y.saveCrsStandalone=function(){var e;y.files.crs[0]?y.obj.crs_release_date&&y.obj.crs_release_time?(e={plane_id:parseInt(y.this_plane_id),release_date:moment(y.obj.crs_release_date).format("YYYY-MM-DD"),release_time:moment(y.obj.crs_release_time).format("HH:mm:ss"),file:y.files.crs[0].file},b.Create(e).then(function(e){e.success?(y.files.crs=[],y.obj.crs_release_date=null,y.obj.crs_release_time=null,y.show_overlay=!1,s.go("dashboard.manage_club.maintenance.detail",{plane_id:y.this_plane_id},{reload:!0})):k.error("CRS Error",e.message||"Unknown error")})):k.warning("CRS Incomplete","Please provide both the release date and release time."):k.warning("CRS Missing","Please upload the CRS certificate document.")},o.processWorkpackFile=function(e,t){if(e&&0!==e.length)try{var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;var o=n.files.file.name.split(".").pop();e[0].file.extension=o,"workpack_doc"===t?y.workpack_files.workpack_doc=[e[0].file]:"defect_wp_doc"===t&&(y.defect_workpack_files.defect_wp_doc=[e[0].file])}catch(e){k.error("Upload Error","There was an error uploading the document. Please try again.")}},y.processDefectFile=function(e,t){if(e&&0!==e.length)try{var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;var o=n.files.file.name.split(".").pop();e[0].file.extension=o,t._uploaded_file=e[0].file}catch(e){k.error("Upload Error","There was an error uploading the document. Please try again.")}},y.loadMaintenanceEvents=function(){y.this_plane_id&&a.GetMaintenanceEvents(y.this_plane_id).then(function(e){e&&e.maintenance_events?y.maintenance_events=e.maintenance_events:e&&e.events?y.maintenance_events=e.events:Array.isArray(e)&&(y.maintenance_events=e)})},y.viewEvent=function(e){y.selected_event=angular.copy(e),y.selected_event.check_date&&(y.selected_event._check_date=new Date(y.selected_event.check_date)),y.selected_event.expiry_date&&(y.selected_event._expiry_date=new Date(y.selected_event.expiry_date)),y.selected_event.check_date&&(y.selected_event._check_time=new Date(y.selected_event.check_date)),y.show_event_detail=!0,y.loadLogbookLinks(e.id)},y.closeEventDetail=function(){y.selected_event=null,y.show_event_detail=!1,y.logbook_checkboxes=[],y.event_logbook_links=[],y.logbook_load_error=!1},y.saveEvent=function(){var e,t;y.selected_event&&y.selected_event.id&&(e={maintenance_type:y.selected_event.maintenance_type,hours_remaining:y.selected_event.hours_remaining,description:y.selected_event.description,checked_by:y.selected_event.checked_by},y.selected_event._check_date&&(t=moment(y.selected_event._check_date).format("YYYY-MM-DD"),y.selected_event._check_time&&(t+=" "+moment(y.selected_event._check_time).format("HH:mm:ss")),e.check_date=t),y.selected_event._expiry_date&&(e.expiry_date=moment(y.selected_event._expiry_date).format("YYYY-MM-DD")),a.UpdateMaintenanceEvent(y.selected_event.id,e).then(function(e){e&&!1!==e.success?(y.closeEventDetail(),y.loadMaintenanceEvents(),a.GetByIdMaintenance2(y.this_plane_id,y.club_id).then(function(e){y.club.plane=e})):k.error("Update Error",e&&e.message||"Error updating maintenance event.")}))},y.getEventTypeIcon=function(e){if(!e)return"fa-wrench";switch(e.toLowerCase()){case"annual":return"fa-calendar-check-o";case"50hours":case"25hours":case"100hours":return"fa-tachometer";case"extension":return"fa-clock-o";case"interim":return"fa-tools";case"6months":return"fa-calendar";default:return"fa-wrench"}},y.getEventTypeLabel=function(e){if(!e)return"Maintenance";switch(e.toLowerCase()){case"annual":return"Annual";case"50hours":return"50 Hour";case"25hours":return"25 Hour";case"100hours":return"100 Hour";case"extension":return"Extension";case"interim":return"Interim";case"6months":return"6 Month";default:return e}},y.loadCreateLogbooks=function(){y.this_plane_id&&(y.create_logbook_loading=!0,y.create_logbook_error=!1,y.create_logbook_checkboxes=[],h.GetAvailableLogbooks(y.this_plane_id).then(function(e){y.create_logbook_loading=!1;e=e&&e.available_logbooks?e.available_logbooks:[];y.create_logbook_checkboxes=e.map(function(e){return{logbook_type:e.logbook_type,logbook_entity_id:e.logbook_entity_id,label:e.label,position:e.position||null,isLinked:"airframe"===e.logbook_type}})},function(){y.create_logbook_loading=!1,y.create_logbook_error=!0}))},y.saveCreateLogbookLinks=function(e){var t;e&&((t=y.create_logbook_checkboxes.filter(function(e){return e.isLinked}).map(function(e){return{logbook_type:e.logbook_type,logbook_entity_id:e.logbook_entity_id}})).length<=1||h.BulkLink(e,t))},y.toggleCreateLogbook=function(e){var t=y.create_logbook_checkboxes.filter(function(e){return e.isLinked}).length;!e.isLinked&&t<1&&(e.isLinked=!0,k.warning("Logbook Required","At least one logbook must be selected."))},y.loadAvailableLogbooks=function(){y.this_plane_id&&h.GetAvailableLogbooks(y.this_plane_id).then(function(e){e&&e.available_logbooks&&(y.available_logbooks=e.available_logbooks)})},y.loadLogbookLinks=function(n){n&&(y.logbook_checkboxes=[],y.logbook_load_error=!1,h.GetAvailableLogbooks(y.this_plane_id).then(function(e){var t=e&&e.available_logbooks?e.available_logbooks:[];0!==(y.available_logbooks=t).length?h.GetLinks(n).then(function(e){var n=[];e&&e.maintenance_check&&e.maintenance_check.logbook_links&&(n=e.maintenance_check.logbook_links),y.event_logbook_links=n,y.logbook_checkboxes=t.map(function(t){var e=n.some(function(e){return e.logbook_type===t.logbook_type&&e.logbook_entity_id==t.logbook_entity_id});return{logbook_type:t.logbook_type,logbook_entity_id:t.logbook_entity_id,label:t.label,position:t.position||null,isLinked:e}})},function(){y.logbook_load_error=!0}):y.logbook_load_error=!0},function(){y.logbook_load_error=!0}))},y.saveLogbookLinks=function(){var e;y.selected_event&&y.selected_event.id&&(0!==(e=y.logbook_checkboxes.filter(function(e){return e.isLinked}).map(function(e){return{logbook_type:e.logbook_type,logbook_entity_id:e.logbook_entity_id}})).length?(y.saving_logbook_links=!0,h.BulkLink(y.selected_event.id,e).then(function(e){y.saving_logbook_links=!1,e&&!1!==e.success?y.loadLogbookLinks(y.selected_event.id):k.error("Logbook Links","Error saving logbook links: "+(e&&e.message||"Unknown error"))})):k.warning("Logbook Required","At least one logbook must be selected."))},y.getLogbookIcon=function(e){switch(e){case"airframe":return"fa-plane";case"engine":return"fa-cog";case"propeller":return"fa-refresh";default:return"fa-book"}},y.countCheckedLogbooks=function(){return y.logbook_checkboxes&&y.logbook_checkboxes.length?y.logbook_checkboxes.filter(function(e){return e.isLinked}).length:0},y.toggleLogbook=function(e){!e.isLinked&&y.countCheckedLogbooks()<1&&(e.isLinked=!0,k.warning("Logbook Required","At least one logbook must remain linked."))};function O(e,t){var n,o="application/octet-stream",i=!1,r=(t=t())["x-filename"]||"download.zip",t=t["content-type"]||o;try{_.info("first try");var a=new Blob([e],{type:"application/pdf"}),s=URL.createObjectURL(a);c=s,n="Secure Documents",(l=window.open()).document.write("<html><head><title>"+n+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+c+'" type="application/pdf" internalinstanceid="21"></body></html>'),l.document.close(),i=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!i){var c=window.URL||window.webkitURL||window.mozURL||window.msURL;if(c){var l=document.createElement("a");if("download"in l)try{_.info("second try");var a=new Blob([e],{type:t}),d=c.createObjectURL(a);l.setAttribute("href",d),l.setAttribute("download",r);var u=document.createEvent("MouseEvents");u.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(u),i=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!i)try{_.info("third try");a=new Blob([e],{type:o}),d=c.createObjectURL(a);window.location=d,i=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}return i||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),r}o.open=function(e){r.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;_.info("PRESSED GO: ",t),a.Delete(t).then(function(){y.club.planes=$.grep(y.club.planes,function(e){return e.id!=t})})},function(){_.info("Modal dismissed at: "+new Date)})},o.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");f.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){O(e,n)}).error(function(e,t){k.error("Download Error","There was an error downloading the selected document(s).")})},o.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");f.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){O(e,n)}).error(function(e,t){k.error("Download Error","There was an error downloading the selected document(s).")})}}function DashboardClubMemberRequestsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v){var w=this;function C(){n.GetRequestsByClub(w.club_id).then(function(e){e.success&&(w.requests=e.requests)})}w.user=s.globals.currentUser,w.user_id=w.user.id,w.club_id=s.globals.currentUser.current_club_admin.id,w.user=s.globals.currentUser,w.user_id=w.user.id,w.noks=[],w.requests=[],w.auto_renew=!1,C(),l.popup=[],l.open=function(e,t){l.popup[e]&&1==l.popup[e].opened?(t.preventDefault(),t.stopPropagation()):l.popup[e]={opened:!0}},l.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],l.format=l.formats[0],l.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},w.show_memberships=!1,l.accept_request=function(e){n.ClubAcceptRequest(e,{status:"Accepted"}).then(function(e){C()})},l.decline_request=function(){n.ClubDeclineRequest(w.this_req.id).then(function(e){C()})},l.delete_request=function(e){n.DeleteRequest(e).then(function(e){C()})},l.resend_request=function(e){n.ResendRequest({request_id:e}).then(function(e){e.success&&v.success("Request Sent","Request re-sent. Please ask them to check their junk / spam folders if they do not see it within the next 5 minutes."),C()})}}function DashboardClubMembersController(e,n,o,r,i,t,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v){var w=this;w.user=null,w.allUsers=[],w.club={},w.page_title="",w.club.member={},w.club.member.user={},w.club.member.payment_now=!0,w.imported_new_headers=[],w.test="Package valid until 12/03/2022<br /> To be used on:<br /> G-BOOF <br /> G-OARU",w.action=l.current.data.action,w.club_id=a.globals.currentUser.current_club_admin.id,w.user=a.globals.currentUser,w.user_id=w.user.id,w.no_show_cols=["membership_start","membership_id","selected"],w.show_loading=!0,c.sortType="Email",c.sortReverse=!1,c.searchTool="",w.show_pay_now=!1,w.show_loading=!1,w.last_invoice_opened={};switch(w.donConfirm=function(e,t){w.complete_invoice(e,t)},w.default_payment="direct-debit",w.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!1},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],w.savedCards=[],w.complete_invoice=function(e,t){e={user_id:w.last_invoice_opened.user_id,club_id:w.last_invoice_opened.club_id,paymentIntent:t,invoice_id:w.last_invoice_opened.id,method:e};n.ProcessPayment(e).then(function(e){e.success?o.GetInvoicesUserClub(w.club.member.user_id,w.club_id,w.current_invoice_offset,w.loaded_per_batch,0).then(function(e){w.invoices=e.invoices,w.upcoming=e.upcoming,w.add_credit_amount=0,w.add_credit_note="",w.show_add_credit=!1,w.show_loading=!1,w.show_pay_now=!1,v.success("Success","Operation completed successfully")}):v.error("Error","Something happened which was not supposed to happen... Please try again")})},w.close_pay_now=function(){w.show_pay_now=!1,w.show_loading=!1},w.show_payment_option=function(e){e=e.status;return"pending_submission"==e||"issued"==e},w.info,w.show_payment=function(e){w.last_invoice_opened=e,w.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.id},r.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(w.info=e.info,w.savedCards=e.cards,0<w.savedCards.length?w.methods[1].visible=!0:w.methods[1].visible=!1,w.machine=e.machine,w.machine.success?w.methods[3].visible=!0:w.methods[3].visible=!1,w.show_pay_now=!0)})},c.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},w.action){case"add":w.page_title="Add a New member",w.club.member.membership_start=new Date,i.GetAllByClub(w.club_id).then(function(e){w.club.memberships=e});break;case"edit":r.GetById(d.member_id,w.club_id).then(function(e){w.club.member=e.member,w.club.member.is_manager=1==w.club.member.is_manager,w.club.member.approved=1==w.club.member.approved,m.GetByUserIdClub(w.club.member.user_id,w.club_id).then(function(e){e.success&&(w.poids=e.poids)}),g.GetByUserIdClub(w.club.member.user_id,w.club_id).then(function(e){e.success&&(w.medicals=e.medicals)}),f.GetByUserIdClub(w.club.member.user_id,w.club_id).then(function(e){e.success&&(w.licences=e.licences)}),b.GetByUserIdClub(w.club.member.user_id,w.club_id).then(function(e){for(var t=e.differences.differences,n=0;n<t.length;n++)"0000-00-00"==t[n].sign_off_date&&delete t[n].sign_off_date,t[n].sign_off_date=new Date(t[n].sign_off_date),t[n].day=1==t[n].day,t[n].night=1==t[n].night,t[n].vfr=1==t[n].vfr,t[n].ifr=1==t[n].ifr;e.differences.differences=t,w.differences=e.differences.differences,w.differences_images=e.differences.images}),y.GetPackagesByUserIdAndClubId(w.club.member.user_id,w.club_id).then(function(e){w.packages=e.items}),w.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},w.get_pax_html=function(e){for(var t="",n=0;n<e.passengers.length;n++){var o="";if(0<e.passengers[n].nok.length)for(var i=0;i<e.passengers[n].nok.length;i++)o=o+"<br /><br />Emergency Contact ("+(i+1)+"): <br />"+e.passengers[n].nok[i].first_name+" "+e.passengers[n].nok[i].last_name+" <br />relationship: "+e.passengers[n].nok[i].relationship+"<br />t: "+e.passengers[n].nok[i].phone_number+" <br /> e: "+e.passengers[n].nok[i].email_address+"<br />";t=t+"<span class='bolder'><b>"+e.passengers[n].first_name+" "+e.passengers[n].last_name+"</b></span><br />e: "+e.passengers[n].email+"<br />t: "+(e.passengers[n].telephone_number||"unknown")+o+"  <br /> <br />"}if(e.passengers.length,0<e.instructor_id){var r="";if(0<w.club.member.nok.noks.length)for(i=0;i<w.club.member.nok.noks.length;i++)r=r+"<br />Emergency Contact ("+(i+1)+"): <br />"+w.club.member.nok.noks[i].first_name+" "+w.club.member.nok.noks[i].last_name+" <br />relationship: "+w.club.member.nok.noks[i].relationship+"<br />t: "+w.club.member.nok.noks[i].phone_number+" <br /> e: "+w.club.member.nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Instructor Present</span> <br /> "+e.booking.instructor.first_name+" "+e.booking.instructor.last_name+" <br /> "+r}if(0<e.user_id){var a="";if(0<w.club.member.nok.noks.length)for(i=0;i<w.club.member.nok.noks.length;i++)a=a+"<br />Emergency Contact ("+(i+1)+"): <br />"+w.club.member.nok.noks[i].first_name+" "+w.club.member.nok.noks[i].last_name+" <br />relationship: "+w.club.member.nok.noks[i].relationship+"<br />t: "+w.club.member.nok.noks[i].phone_number+" <br /> e: "+w.club.member.nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Member Present</span> <br />"+a}return t},w.change_package={},w.calculate_change=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=0<e?e:w.change_package.slider_value;w.change_package.dual_percent=e/100,w.change_package.dual_hours=w.change_package.dual_percent*w.change_package.remaining_price/w.change_package.initial_dual_price,w.change_package.dual_price=w.change_package.dual_percent*w.change_package.remaining_price,w.change_package.dual_price>=w.change_package.remaining_price&&(w.change_package.dual_price=w.change_package.remaining_price,w.change_package.dual_hours=w.change_package.dual_price/w.change_package.initial_dual_price),w.change_package.remaining_solo_hours=(w.change_package.remaining_price-w.change_package.dual_price)/w.change_package.initial_solo_price,w.change_package.solo_number=w.change_package.remaining_solo_hours,w.change_package.dual_number=w.change_package.dual_hours,w.change_package.solo_price=w.change_package.remaining_solo_hours*w.change_package.initial_solo_price},w.show_package_change=function(e){w.show_package_popup=!0;document.getElementById("myRange");w.change_package.id=e.id,w.change_package.price=e.price,w.change_package.hours_dual=e.remaining_hours_dual,w.change_package.hours_solo=e.remaining_hours_solo,w.change_package.dual_hours=e.remaining_hours_dual,w.change_package.solo_hours=e.remaining_hours_solo,w.change_package.difference=e.difference,w.change_package.hours_dual_remaining=e.remaining_hours_dual,w.change_package.hours_solo_remaining=e.remaining_hours_solo,w.change_package.solo_number=e.remaining_hours_solo,w.change_package.dual_number=e.remaining_hours_dual,w.change_package.base=(w.change_package.price-w.change_package.difference*w.change_package.hours_dual)/(w.change_package.hours_dual+w.change_package.hours_solo),w.change_package.initial_dual_price=w.change_package.base+w.change_package.difference,0<w.change_package.hours_solo?w.change_package.initial_solo_price=(w.change_package.price-w.change_package.initial_dual_price*w.change_package.hours_dual)/w.change_package.hours_solo:w.change_package.initial_solo_price=w.change_package.base,w.change_package.remaining_price=w.change_package.hours_dual_remaining*w.change_package.initial_dual_price+w.change_package.hours_solo_remaining*w.change_package.initial_solo_price,w.change_package.remaining_ratio=w.change_package.initial_dual_price*w.change_package.hours_dual_remaining/w.change_package.remaining_price,w.change_package.slider_value=100*w.change_package.remaining_ratio;w.calculate_change()},w.hide_package_change=function(){w.show_package_popup=!1},w.refund_package_to_credit=function(){if(w.show_loading=!0,!confirm("Are you sure you wish to refund this package? This is irreversible!"))return!1;y.RefundPackageToAccount(w.change_package.id).then(function(e){e.success?w.packages=e.items:v.error("Error","An error happened - please try again"),w.show_package_popup=!1,w.show_loading=!1})},w.save_package_change=function(){w.show_loading=!0;var e={remaining_hours_dual:w.change_package.dual_number,remaining_hours_solo:w.change_package.solo_number};y.SwapPackageHours(w.change_package.id,e).then(function(e){e.success?w.packages=e.items:v.error("Error","An error happened - please try again"),w.show_package_popup=!1,w.show_loading=!1})},w.change_numbers=function(e){val=0,val="solo"==e?w.change_package.solo_number>w.change_package.remaining_price/w.change_package.initial_solo_price?(w.change_package.solo_number=w.change_package.remaining_price/w.change_package.initial_solo_price,0):0<=w.change_package.solo_number?1-w.change_package.solo_number*w.change_package.initial_solo_price/w.change_package.remaining_price:1:w.change_package.dual_number>w.change_package.remaining_price/w.change_package.initial_dual_price?(w.change_package.dual_number=w.change_package.remaining_price/w.change_package.initial_dual_price,1):0<=w.change_package.dual_number?w.change_package.dual_number*w.change_package.initial_dual_price/w.change_package.remaining_price:0,w.change_package.percent=100*val,w.change_package.slider_value=w.change_package.percent,w.calculate_change(w.change_package.percent)},w.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(1==t?"":"-")+n+":"+e},w.show_add_credit=!1,w.add_credit=function(){w.show_add_credit=!0},w.close_credit=function(){w.show_add_credit=!1},w.apply_credit=function(){w.show_loading=!0;var e={items:[{quantity:1,price:-w.add_credit_amount,title:w.add_credit_note,vat:0,is_credit_from_admin:1}],user:{user_id:w.club.member.user_id},club_id:w.club_id,payment:{direct_debit:!0},credit_only:1};n.CreateCustom(e).then(function(e){e.success?o.GetInvoicesUserClub(w.club.member.user_id,w.club_id,w.current_invoice_offset,w.loaded_per_batch,0).then(function(e){w.invoices=e.invoices,w.upcoming=e.upcoming,w.add_credit_amount=0,w.add_credit_note="",w.show_add_credit=!1,w.show_loading=!1}):w.show_loading=!1})},w.current_offset=0,w.current_invoice_offset=0,w.loaded_per_batch=5,w.all_loaded=!1,w.all_invoices_loaded=!1,t.GetUserJourneyLogs(w.club.member.user_id,w.club_id,w.current_offset,w.loaded_per_batch).then(function(e){w.logs=e.logs}),o.GetInvoicesUserClub(w.club.member.user_id,w.club_id,w.current_invoice_offset,w.loaded_per_batch,0).then(function(e){w.invoices=e.invoices,w.upcoming=e.upcoming}),w.load_more=function(){w.current_offset=w.current_offset+w.loaded_per_batch,t.GetUserJourneyLogs(w.club.member.user_id,w.club_id,w.current_offset,w.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return w.logs.push(e)}):w.all_loaded=!0})},w.load_more_invoices=function(){w.current_invoice_offset=w.current_invoice_offset+w.loaded_per_batch,o.GetInvoicesUserClub(w.club.member.user_id,w.club_id,w.current_invoice_offset,w.loaded_per_batch,1).then(function(e){0<e.invoices.length?e.invoices.forEach(function(e){return w.invoices.push(e)}):w.all_invoices_loaded=!0})},w.get_initial=function(e){return e.charAt(0)},w.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},c.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.floor(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},w.club.member.instructor=1==w.club.member.instructor,w.page_title="Edit a Member - "+w.club.member.first_name+" "+w.club.member.last_name,w.club.member.membership_start=new Date(w.club.member.membership_start),r.GetMemberPlanes(w.club.member.user_id,w.club_id).then(function(e){w.club.planes=e})}),i.GetAllByClub(w.club_id).then(function(e){w.club.memberships=e});break;case"list":r.GetAllByClub(w.club_id).then(function(e){w.club.members=e}),i.GetAllByClub(w.club_id).then(function(e){w.club.memberships=e}),c.checkAll=function(){c.selectedAll?c.selectedAll=!0:c.selectedAll=!1,angular.forEach(w.club.members,function(e){e.selected=c.selectedAll})}}function C(e){for(var t=document.querySelectorAll(".field-error-highlight"),n=0;n<t.length;n++)t[n].classList.remove("field-error-highlight");e=document.getElementById(e);e&&(e.classList.add("field-error-highlight"),e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus())}c.back=function(){p.history.back()},c.save=function(){"add"==w.action?c.create():c.update()},c.search=function(e){return-1!==angular.lowercase(e.invoice_number).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.club_title).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.total.toString()).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(c.my_search)||"")},c.show_more=function(e){w.invoices[e].show_more=!w.invoices[e].show_more},c.csvToJSON=function(e){var t=e.csv.split(/\r\n|\n/),n=[],o=0;t[0]+=",membership_id,membership_start,selected";for(var i=1;i<t.length;i++)t[i]+=",membership_id,membership_start,true";var r=t[0].split(e.separator).length,a=[];e.header&&(a=t[0].split(e.separator),w.imported_headers=a,o=1);for(var s=o;s<t.length;s++){var c={},l=t[s].split(new RegExp(e.separator+'(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)'));if(l.length===r){if(e.header)for(i=0;i<a.length;i++)c[a[i]]=l[i];else for(var d=0;d<l.length;d++)c[d]=l[d];n.push(c)}}return n},w.apply_default_memberships=function(){for(var e=0;e<w.imported_users.length;e++)w.imported_users[e].membership&&w.imported_users[e].membership!={}&&""!=w.imported_users[e].membership||(w.imported_users[e].membership_id=w.default_membership.id,w.imported_users[e].membership=w.default_membership)},w.change_header=function(e,t){if("membership_start"==w.imported_new_headers[e])for(var n=0;n<w.imported_users.length;n++)try{var o=function(e,t){var n=(t=t||{}).prefer||"DMY",o=!!t.utc;if(null==e)return null;if("[object Date]"===Object.prototype.toString.call(e))return isNaN(e.getTime())?null:new Date(e.getTime());if("number"==typeof e&&isFinite(e)){var i=new Date(e);return isNaN(i.getTime())?null:i}if(!(t=String(e).trim()))return null;if(!/^\d{1,2}[\/. -]\d{1,2}[\/. -]\d{2,4}(\s+.*)?$/.test(t)){var r=new Date(t);if(!isNaN(r.getTime()))return r}if(i=(t=t.replace(/[.\-]/g,"/").replace(/\s+/g," ").trim()).split(" "),e=i[0],r=i.slice(1).join(" ").trim(),3!==(t=e.split("/")).length)return null;var a,s,c,i=parseInt(t[0],10),e=parseInt(t[1],10),l=parseInt(t[2],10);if(![i,e,l].every(function(e){return isFinite(e)}))return null;if(4===t[0].length?(a=i,s=e,c=l):(a=4===t[2].length?l:0<=(l=l)&&l<=99?l<=69?2e3+l:1900+l:l,!(12<i&&e<=12)&&(12<e&&i<=12||"MDY"===n)?(s=i,c=e):(c=i,s=e)),!(1<=a&&a<=9999))return null;if(!(1<=s&&s<=12))return null;if(!(1<=c&&c<=31))return null;if(e=i=n=0,r){r=r.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);if(r&&(n=parseInt(r[1],10),i=parseInt(r[2],10),e=r[3]?parseInt(r[3],10):0,23<n||59<i||59<e))return null}return n=o?new Date(Date.UTC(a,s-1,c,n,i,e,0)):new Date(a,s-1,c,n,i,e,0),i=o?n.getUTCFullYear():n.getFullYear(),e=(o?n.getUTCMonth():n.getMonth())+1,o=o?n.getUTCDate():n.getDate(),i!==a||e!==s||o!==c?null:n}(w.imported_users[n][t]);w.imported_users[n].membership_start&&w.imported_users[n].membership_start!={}&&""!=w.imported_users[n].membership_start&&w.imported_users[n].membership_start.getTime()||(w.imported_users[n].membership_start=new Date(o.toISOString()))}catch(e){}},w.apply_default_start=function(){},c.processData=function(){var e={csv:w.import_users,separator:",",header:!0};w.imported_users=c.csvToJSON(e);for(var t=0;t<w.imported_users.length;t++)w.imported_users[t].matching=w.imported_users[t].email,w.imported_users[t].email="a"+t+"@toaviate.com",w.imported_users[t].membership_start?w.imported_users[t].membership_start=new Date(w.imported_users[t].membership_start):w.imported_users[t].membership_start=new Date},w.user_columns={first_name:"First Name",last_name:"Last Name",email:"Email Address",dob:"Date of Birth",membership_number:"Membership Number",membership_start:"Membership Start Date",membership_id:"Membership Name",matching_email:"Matching Email"},c.import_column=function(e){},w.member_check=[],c.update_verification=function(e,t,n){w.member_check.push({type:e,obj:t});n={check_type:e,user_id:w.club.member.user_id,club_id:w.club_id,check_id:t.id,verified:n};r.Verify(n).then(function(e){}),function(){for(var e=0,t=0,n=0,o=0;o<w.member_check.length;o++)switch(w.member_check[o].type){case"poid":e++;break;case"medical":t++;break;case"licence":n++;break;case"difference":difference++}0<e&&0<t&&0<n&&(w.club.member.approved=1)}()},c.import_users=function(){if(w.imported_users=$.grep(w.imported_users,function(e){return"false"!=e.selected}),-1<w.imported_new_headers.indexOf("first_name")&&-1<w.imported_new_headers.indexOf("last_name")&&-1<w.imported_new_headers.indexOf("email")){for(var e=0;e<w.imported_users.length;e++)w.imported_users[e].membership&&w.imported_users[e].membership.membership_id&&(w.imported_users[e].membership_id=w.imported_users[e].membership.id,delete w.imported_users[e].membership);w.imported_new_headers.push("membership_id"),w.imported_new_headers.push("membership_start");for(var t=[],n=0;n<w.imported_users.length;n++){for(var o={user:{},club_id:w.club_id},i=0;i<w.imported_new_headers.length;i++)w.imported_new_headers[i]&&("first_name"==w.imported_new_headers[i]||"last_name"==w.imported_new_headers[i]||"dob"==w.imported_new_headers[i]||"email"==w.imported_new_headers[i]?o.user[w.imported_new_headers[i]]=w.imported_users[n][Object.keys(w.imported_users[n])[i]]:"membership_start"==w.imported_new_headers[i]||"membership_id"==w.imported_new_headers[i]?o[w.imported_new_headers[i]]=w.imported_users[n][w.imported_new_headers[i]]:o[w.imported_new_headers[i]]=w.imported_users[n][Object.keys(w.imported_users[n])[i]]);t.push(o)}r.CreateMany(t).then(function(e){l.go("dashboard.manage_club.members")})}else v.warning("Missing Fields","You must select the First Name, Last Name and Email Address to be able to add the user to the system!")},w.sa_dual=!1,w.sa_solo=!1,w.sa_instruct=!1,w.select_all=function(e){if("dual"==e)for(var t=0;t<w.club.planes.length;t++)w.club.planes[t].book_dual=1,w.sa_dual=!0;else if("solo"==e)for(t=0;t<w.club.planes.length;t++)w.club.planes[t].book_solo=1,w.sa_solo=!0;else if("instruct"==e)for(t=0;t<w.club.planes.length;t++)w.club.planes[t].instruct=1,w.sa_instruct=!0},w.deselect_all=function(e){if("dual"==e)for(var t=0;t<w.club.planes.length;t++)w.club.planes[t].book_dual=0,w.sa_dual=!1;else if("solo"==e)for(t=0;t<w.club.planes.length;t++)w.club.planes[t].book_solo=0,w.sa_solo=!1;else if("instruct"==e)for(t=0;t<w.club.planes.length;t++)w.club.planes[t].instruct=0,w.sa_instruct=!1},c.create=function(){w.club.member.club_id=w.club_id,r.Create(w.club.member).then(function(e){l.go("dashboard.manage_club.members")})},w.clearFieldError=function(e){e&&e.target&&e.target.classList.remove("field-error-highlight");e=e.target.closest(".field-error-highlight");e&&e.classList.remove("field-error-highlight")},c.invite_member=function(){var e=w.club.member.user&&w.club.member.user.first_name?w.club.member.user.first_name.trim():"",t=w.club.member.user&&w.club.member.user.last_name?w.club.member.user.last_name.trim():"",n=w.club.member.user&&w.club.member.user.email?w.club.member.user.email.trim():"";return e?t?n?w.club.member.membership_id?w.club.member.membership_start?(w.club.selected_membership&&0==w.club.selected_membership.price&&(w.club.member.payment_now=!0),w.club.member.club_id=w.club_id,void r.send_invite_by_club(w.club.member).then(function(e){l.go("dashboard.manage_club.members")})):(v.error("Validation Error","Membership start date is required"),void C("membership_start")):(v.error("Validation Error","Please select a membership"),void C("membership_select_wrapper")):(v.error("Validation Error","Email is required"),void C("email")):(v.error("Validation Error","Last name is required"),void C("last_name")):(v.error("Validation Error","First name is required"),void C("first_name"))},c.delete=function(){v.warning("Confirm Delete","Are you sure you would like to delete this membership?"),r.Update(w.club.membership).then(function(e){})},c.update=function(){w.club.member.club_id=w.club_id;var e=new Date(w.club.member.membership_start);e.isValid||(e=new Date),w.club.member.membership_start=e,r.Update(w.club.member).then(function(e){l.go("dashboard.manage_club.members")}),r.SaveMemberPlanes(w.club.member.user_id,w.club.member.club_id,w.club.planes).then(function(e){})},w.select_member_approval=!1,c.selected_members=function(e){if(w.select_member_approval)return!1;w.show_loading=!0,w.select_member_approval=!0,w.selected_members=$.grep(w.club.members,function(e){return 1==e.selected});for(var t=0;t<w.selected_members.length;t++)w.selected_members[t].approved="approve"==e?1:0,r.Update(w.selected_members[t]).then(function(e){});setTimeout(function(){r.GetAllByClub(w.club_id).then(function(e){w.club.members=e,i.GetAllByClub(w.club_id).then(function(e){w.club.memberships=e,w.select_member_approval=!1,w.show_loading=!1})})},1e3)},c.update_membership=function(e,t){w.club.member.membership_id=e.membership_id,w.club.member.membership_name=e.membership_name,w.club.selected_membership=e};var S="By deleting this membership, you will also cancel all reservations that this membership currently has.";function x(e,t,o,i){u.open({animation:!0,templateUrl:"views/modals/check_documents.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return t},warning:function(){return S}}}).result.then(function(e){_.info("PRESSED GO: ",e);for(var t,n=0;n<w[o].length;n++)w[o][n].id==i&&1!=w[o][n].verified&&(w[o][n].verified=1,t="differences"==o?"differences":o.slice(0,-1),c.update_verification(t,w[o][n],1));switch(o){case"poids":case"medicals":case"licences":case"differences":break;default:v.error("Unknown Request","Sorry - we didn't recognise the request")}},function(){_.info("Modal dismissed at: "+new Date)})}w.show_temp_login=!1,w.show_loading=!1,c.re_login=function(){h.Login3(w.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(c.openDocument(w.maybe.doc_type,w.maybe.doc_id),w.show_temp_login=!1):v.error("Wrong Password","This is the wrong password - please try again")})},c.openDocument=function(n,o){w.show_loading=!0;var i=o,r=[];switch(n){case"poids":m.GetById(o,0,1).then(function(e){var t;e.success?(r=e.poid.images,w.show_loading=!(t={document_type:n,document_id:o,images:r}),x(i,t,n,o)):("templogin"==e.fail&&(w.show_temp_login=!0,w.maybe={doc_type:"poids",doc_id:o}),w.show_loading=!1)});break;case"medicals":g.GetById(o,0,1).then(function(e){var t;e.success?(r=e.medical.images,w.show_loading=!(t={document_type:n,document_id:o,images:r}),x(i,t,n,o)):(w.show_loading=!1,w.maybe={doc_type:"medicals",doc_id:o},"templogin"==e.fail&&(w.show_temp_login=!0,w.maybe={doc_type:"medicals",doc_id:o}))});break;case"licences":f.GetById(o,0,1).then(function(e){var t;e.success?(r=e.licence.images,w.show_loading=!(t={document_type:n,document_id:o,images:r}),x(i,t,n,o)):(w.show_loading=!1,"templogin"==e.fail&&(w.show_temp_login=!0,w.maybe={doc_type:"licences",doc_id:o}))});break;case"differences":var e={document_type:n,document_id:o,images:w.differences_images};w.show_loading=!1,x(i,e,n,o);break;default:w.show_loading=!1,v.error("Unknown Request","Sorry - we didn't recognise the request")}},c.downloadInvoice=function(e){k.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}o||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){v.error("Download Error","There was an error downloading the selected document(s)")})},c.open=function(e){u.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return S}}}).result.then(function(t){_.info("PRESSED GO: "+t),r.Delete(t).then(function(){w.club.members=$.grep(w.club.members,function(e){return e.id!=t})})},function(){_.info("Modal dismissed at: "+new Date)})}}function DashboardClubMembershipsController(e,i,t,n,o,r,a,s,c,l,d,u){var _=this;_.user=null,_.allUsers=[],_.club={},_.page_title="",_.action=a.current.data.action,_.club_id=n.globals.currentUser.current_club_admin.id,_.user=n.globals.currentUser,_.user_id=_.user.id,t.GetById(_.club_id).then(function(e){switch(_.club=e,_.club.membership={},_.action){case"add":_.page_title="Add a New membership",_.club.membership.currency=_.club.account_currency,_.club.membership.passenger_only=0,_.club.membership.passenger_only_default=0,i.GetAllMembershipPlanes(_.club_id,1).then(function(e){_.club_planes=e.membership_planes});break;case"edit":i.GetById(s.membership_id,_.club_id).then(function(e){_.club.membership=e,_.page_title="Edit a membership - "+_.club.membership.membership_name}),i.GetAllMembershipPlanes(_.club_id,s.membership_id).then(function(e){_.club_planes=e.membership_planes});break;case"list":i.GetAllByClub(_.club_id).then(function(e){_.club.memberships=e})}}),r.back=function(){d.history.back()},_.clearFieldError=function(e){u.clearFieldError(e)},r.save=function(){var e=[{ok:_.club.membership.membership_name,field:"membership_name",label:"Membership Name"},{ok:_.club.membership.payment_term,field:"payment_term",label:"Payment Term"}];_.club.membership.payment_term&&"free"!==_.club.membership.payment_term&&e.push({ok:null!=_.club.membership.price&&""!==_.club.membership.price,field:"price",label:"Price"}),u.validateForm(e)&&("add"==_.action?r.create():r.update())},r.create=function(){_.club.membership.club_id=_.club_id,i.Create(_.club.membership).then(function(e){a.go("dashboard.manage_club.memberships")})},r.delete=function(){u.warning("Confirm Delete","Are you sure you would like to delete this membership?"),i.Update(_.club.membership).then(function(e){})},r.update=function(){_.club.membership.club_id=_.club_id,i.Update(_.club.membership).then(function(e){if(1==_.club.membership.plane_access){for(var t=[],n=0;n<_.club_planes.length;n++){var o={id:_.club_planes[n].id,tacho_hour_fee:_.club_planes[n].membership_tacho_hour_fee,landing_fee:_.club_planes[n].membership_landing_fee,touch_and_go_fee:_.club_planes[n].membership_touch_and_go_fee,access:_.club_planes[n].access,membership_id:e,plane_id:_.club_planes[n].plane_id};t.push(o)}i.UpdateMembershipPlanes(e,t).then(function(e){})}a.go("dashboard.manage_club.memberships")})},_.previous_price=0,_.update_price=function(){"free"==_.club.membership.payment_term?(_.previous_price=0<_.club.membership.price?_.club.membership.price:0,_.club.membership.price=0):_.club.membership.price=0<_.club.membership.price?_.club.membership.price:0<_.previous_price?_.previous_price:0};r.open=function(e){c.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this membership, you will also cancel all reservations that this membership currently has."}}}).result.then(function(t){l.info("PRESSED GO: "+t.id),i.Delete(t.id).then(function(){_.club.memberships=$.grep(_.club.memberships,function(e){return e.id!=t.id})})},function(){l.info("Modal dismissed at: "+new Date)})}}function DashboardClubPackagesController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;switch(_.charge_type=["brakes","session","plane"],_.page_title="",_.action=i.current.data.action,_.user=t.globals.currentUser,_.club_id=t.globals.currentUser.current_club_admin.id,_.user_id=_.user.id,_.packages=[],_.editing=!1,_.action){case"add":d.GetAllByClub(_.club_id).then(function(e){_.planes_original=e,_.planes=JSON.parse(JSON.stringify(_.planes_original))});break;case"edit":_.editing=!0,_.package_id=r.package_id,l.GetPackageById(r.package_id).then(function(e){_.package=e.item,_.package.available=1==_.package.available,_.page_title="Edit a Package - "+_.package.title}),l.GetPackagePlanesByPackageId(r.package_id).then(function(e){_.aircraft=e.items,d.GetAllByClub(_.club_id).then(function(e){_.planes_original=e,_.planes=JSON.parse(JSON.stringify(_.planes_original)),_.clean_aircraft_selection()})});break;case"list":l.GetPackagesByClubId(_.club_id).then(function(e){_.packages=e.items})}o.back=function(){c.history.back()},_.clearFieldError=function(e){u.clearFieldError(e)},o.save=function(){_.package||(_.package={});var e=_.package,e=[{ok:e.title,field:"title",label:"Package Title"},{ok:null!=e.price&&""!==e.price,field:"price",label:"Price"},{ok:null!=e.hours_dual&&""!==e.hours_dual,field:"hours_dual",label:"Hours Dual"},{ok:null!=e.hours_solo&&""!==e.hours_solo,field:"hours_solo",label:"Hours Solo"},{ok:null!=e.difference&&""!==e.difference,field:"difference",label:"Difference"},{ok:null!=e.validity&&""!==e.validity,field:"validity",label:"Validity"}];if(u.validateForm(e))return!_.aircraft||_.aircraft.length<1?(u.highlightField(".card"),void u.warning("Aircraft Required","You must add at least 1 aircraft to this package.")):void("add"==_.action?o.create():o.update())},_.delete_aircraft=function(e,t){"add"==_.action?(_.aircraft.splice(t,1),_.clean_aircraft_selection()):confirm("Are you sure you wish to delete this aircraft for this package? This is irreversible.")&&l.DeletePackagePlane(e.id).then(function(e){e.success?(_.aircraft.splice(t,1),_.clean_aircraft_selection()):u.error("Error","An error occurred")})},_.aircraft=[],_.new_aircraft2={},_.new_aircraft={},_.add_aircraft=function(){"add"==_.action?(_.aircraft.push(_.new_aircraft.plane),_.clean_aircraft_selection(),_.new_aircraft={},_.new_aircraft2={}):(_.new_aircraft2.package_id=_.package_id,_.new_aircraft2.club_id=_.club_id,_.new_aircraft2.plane_id=_.new_aircraft.plane.plane_id,l.CreatePackagePlane(_.new_aircraft2).then(function(e){e.success?(_.aircraft.push(e.item),_.clean_aircraft_selection(),_.new_aircraft={},_.new_aircraft2={}):u.error("Error","An error occurred")}))},_.clean_aircraft_selection=function(){_.planes=JSON.parse(JSON.stringify(_.planes_original));for(var e=0;e<_.aircraft.length;e++)for(var t=0;t<_.planes.length;)_.planes[t].plane_id===_.aircraft[e].plane_id?_.planes.splice(t,1):++t},_.update_charge=function(e,t){delete e.edit_me,l.UpdateCharge(e).then(function(e){e.success?_.instructor_charges[t].edit_me=!1:u.error("Error","An error occurred")})},_.update_cancel_charge=function(e){refresh_charges()},_.edit_charge=function(e){_.instructor_charges[e].edit_me=!0},_.delete_charge=function(e,t){confirm("Are you sure you wish to delete this instructor charge? This is irreversible.")&&l.DeleteCharge(e.id).then(function(e){e.success?_.instructor_charges.splice(t,1):u.error("Error","An error occurred")})},_.add_charge=function(){_.new_charge.course_id=r.course_id,_.new_charge.club_id=_.club_id,l.CreateCharge(_.new_charge).then(function(e){e.success?(_.instructor_charges.push(e.item),_.new_charge={title:"",charge_type:"",price:""}):u.error("Error","An error occurred")})},_.convert_decimal_to_hours=function(e){var t,n=new Array,e=(n=e.toString().split("."))[0];return e<10&&(e="0"+e),n[1]?(t=100/n[1],(t=Math.round(60/t))<10&&(t="0"+t)):t="00",e+":"+t},_.delete_course=function(e,t){confirm("Are you sure you wish to delete this course? This is irreversible.")&&l.DeletePackage(e).then(function(e){e.success?_.packages.splice(t,1):u.error("Error","An error occurred")})},o.create=function(){_.package.club_id=_.club_id,_.package.aircraft=_.aircraft,l.CreatePackage(_.package).then(function(e){i.go("dashboard.manage_club.package",{reload:!0})})},o.delete=function(){u.warning("Delete Package","Are you sure you would like to delete this package?"),l.DeletePackage(_.package.id).then(function(e){})},o.update=function(){l.UpdatePackage(_.package).then(function(e){i.go("dashboard.manage_club.package")})}}function DashboardClubPaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f){var g=this;g.user=null,g.allUsers=[],g.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},g.page_title="",g.plane_document={},g.plane_documents=[];var b=[];g.action=r.current.data.action,g.club_id=n.globals.currentUser.current_club_admin.id,g.user=n.globals.currentUser,g.user_id=g.user.id,m.GetPaymentsByClub(g.club_id).then(function(e){g.payments=e.payments}),i.back=function(){l.history.back()},i.save=function(){"add"==g.action?i.create():i.update()},i.create=function(){g.club.plane.club_id=g.club_id,g.club.plane.add_documents=g.plane_documents,t.Create(g.club.plane).then(function(e){r.go("dashboard.manage_club.planes",{reload:!0})})},i.delete=function(){f.warning("Delete Plane","Are you sure you would like to delete this plane?"),t.Update(g.club.plane).then(function(e){})},i.update=function(){g.club.plane.club_id=g.club_id,g.club.plane.add_documents=g.plane_documents,g.club.plane.update_documents=function(){for(var e=[],t=0;t<b.length;t++)for(var n=b[t],o=0;o<g.club.plane.plane_documents.length;o++)g.club.plane.plane_documents[o].id==n&&e.push(g.club.plane.plane_documents[o]);return e}(),t.Update(g.club.plane).then(function(e){r.go("dashboard.manage_club.planes")})},i.get_payment_description=function(e){return"Stripe"==e?"This invoice was charged using the Stripe integration":"Equilibrium"==e?"This invoice amounted to 0 and hence no payment was taken":"GoCardless"==e?"This invoice was charged using the GoCardless integration":"GoCardless + Credit"==e?"This invoice was charged using the GoCardless integration as well as Credit on file.":"Credit"==e?"This invoice was charged using the Credit the user had on file.":void 0};var h="By deleting this plane, you will also cancel all reservations that this plane currently has.";i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/refundModal.html",controller:"RefundModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return e},warning:function(){return h}}}).result.then(function(e){e.id;if(c.info("PRESSED GO: ",e),e.to_refund>e.amount-e.amount_refunded)return f.warning("Refund Limit","You are trying to refund more than the payment was for. You will need to first refund this amount in full, and then make a payment to the user for the remaining sum."),!1;0<e.to_refund&&"Stripe"==e.payment_method&&(e.to_refund,e.amount,m.Refund(e).then(function(e){}))},function(){c.info("Modal dismissed at: "+new Date)})},i.new_charge=function(e){s.open({animation:!0,templateUrl:"views/modals/newChargeModal.html",controller:"NewChargeModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return e},warning:function(){return h}}}).result.then(function(e){c.info("PRESSED GO: ",e)},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubPlanesController(e,r,t,n,o,i,a,s,c,l,d,u,_,p,m,f){var g=this;g.show_loading=!1,g.user=null,g.allUsers=[],g.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},g.page_title="",g.plane_document={},g.plane_documents=[];var b=[];switch(g.currency_types=["class","type"],g.gear_types=["tricycle","tailwheel","monowheel","floats","amphibian","skis"],g.certificates=[{id:1,title:"Certificate of Airworthiness",value:"cofa"},{id:2,title:"National Certificate of Airworthiness",value:"cofa"},{id:2,title:"LAA Permit to Fly",value:"ptf"}],g.classes=["SEP (land)","SEP (sea)","SET (land)","SET (sea)","MEP (land)","MEP (sea)","ME"],g.charge_type=["airborne","brakes","tacho","hobbs","flight","brakes_rounded"],g.surcharge_type=["none","flight","hour","taxi"],g.action=a.current.data.action,g.user=n.globals.currentUser,g.club_id=n.globals.currentUser.current_club_admin.id,g.user_id=g.user.id,g.plane_certificate={},g.plane_noise={},g.plane_radio={},g.plane_maintenance={},g.plane_insurance={},g.plane_engine_1={removed_date:""},g.plane_engine_1_replace={removed_date:""},g.plane_engine_2={removed_date:""},g.plane_engine_2_replace={removed_date:""},g.plane_propeller_1={removed_date:""},g.plane_propeller_1_replace={removed_date:""},g.plane_propeller_2={removed_date:""},g.plane_propeller_2_replace={removed_date:""},g.show_replace_engine_1=!1,g.show_replace_engine_2=!1,g.show_replace_prop_1=!1,g.show_replace_prop_2=!1,u.GetAll().then(function(e){g.licences=e.licences}),u.GetRatings().then(function(e){g.ratings=e}),_.GetAuthority().then(function(e){g.medical_authorities=e}),_.GetComponents().then(function(e){g.medical_components=e}),p.GetDifferences().then(function(e){g.differences=e}),g.editing=!1,g.action){case"add":g.page_title="Add a New Plane";break;case"edit":g.editing=!0,r.GetById(s.plane_id,g.club_id).then(function(e){g.club.plane=e,g.club.plane.colour&&-1<g.club.plane.colour.indexOf("rgba")&&(g.club.plane.colour=h(g.club.plane.colour)),g.club.plane.bg_colour&&-1<g.club.plane.bg_colour.indexOf("rgba")&&(g.club.plane.bg_colour=h(g.club.plane.bg_colour)),g.club.plane.airframe_hours=parseFloat(g.club.plane.airframe_hours),g.club.plane.vp=1==g.club.plane.vp,g.club.plane.rg=1==g.club.plane.rg,g.club.plane.tb=1==g.club.plane.tb,g.plane_engine_1=g.club.plane.engine_1,g.plane_engine_2=g.club.plane.engine_2,g.plane_propeller_1=g.club.plane.propeller_1,g.plane_propeller_2=g.club.plane.propeller_2,g.page_title="Edit a Plane - "+g.club.plane.registration});break;case"list":r.GetAllByClub(g.club_id).then(function(e){g.club.planes=e})}function h(e){var t=e.substring(e.indexOf("(")).split(","),n=parseInt(k(t[0].substring(1)),10),e=parseInt(k(t[1]),10),t=parseInt(k(t[2]),10),o=[n.toString(16),e.toString(16),t.toString(16)];return o.forEach(function(e,t){1===e.length&&(o[t]="0"+e)}),"#"+o.join("")}function k(e){return e.replace(/^\s+|\s+$/gm,"")}function y(e,t){t=1<arguments.length&&void 0!==t?t:1;return"rgba("+parseInt(e.substring(1,3),16)+", "+parseInt(e.substring(3,5),16)+", "+parseInt(e.substring(5),16)+", "+t+")"}function v(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}i.back=function(){d.history.back()},i.save_planes_order=function(){for(var e=[],t=0;t<g.club.planes.length;t++){var n={id:g.club.planes[t].plane_id,display_order:t};e.push(n)}r.UpdateOrder({order:e}).then(function(e){})},i.set_aircraft_details=function(){r.GetAddAircraft(g.plane_search.registration).then(function(e){e&&(0==e.length||(g.plane_search=e,function(){g.club.plane.manufacturer=g.plane_search.manufacturer,g.club.plane.serial_no=g.plane_search.serial_number,g.club.plane.plane_type=g.plane_search.icao_type,g.club.plane.type_name=g.plane_search.type_name,g.club.plane.year_built=g.plane_search.year_built,g.club.plane.aircraft_id=g.plane_search.id,g.club.plane.mtow=parseInt(g.plane_search.mtow),g.club.plane.airframe_hours=g.plane_search.airframe_hours,g.plane_search.noise_level&&(g.plane_noise.noise_level=g.plane_search.noise_level.match(/[+-]?\d+(\.\d+)?/g).map(function(e){return parseFloat(e)}));g.plane_noise.noise_cert_issue=g.plane_search.noise_cert_issue?new Date(g.plane_search.noise_cert_issue):"",-1<g.plane_search.aircraft_class.indexOf("FIXED-WING")&&(0<g.plane_search.is_propeller&&-1==g.plane_search.engine_name.indexOf("PT6A-")?g.club.plane.plane_class=1<g.club.plane.number_of_engines?"MEP":"SEP":g.club.plane.plane_class=1<g.club.plane.number_of_engines?"ME":"SET",-1<g.plane_search.aircraft_class.indexOf("LANDPLANE")&&(g.club.plane.plane_class=g.club.plane.plane_class+" (land)",g.club.plane.gear_type=""),(-1<g.plane_search.aircraft_class.indexOf("AMPHIBIAN")||-1<g.plane_search.aircraft_class.indexOf("FLOAT"))&&(g.club.plane.plane_class=g.club.plane.plane_class+" (sea)",g.club.plane.gear_type=-1<g.plane_search.aircraft_class.indexOf("AMPHIBIAN")?"amphibian":"floats"));g.club.plane.seats=parseInt(g.plane_search.seats)+1,g.plane_maintenance&&g.plane_maintenance.cofa_category&&(g.plane_maintenance.cofa_category=-1<g.plane_search.cofa_category.indexOf("cofa")?"Certificate of Airworthiness":"Permit to Fly");g.plane_maintenance.certificate_expiry=new Date(g.plane_search.cofa_expiry),g.club.plane.cofa_category=g.plane_maintenance.cofa_category,g.club.plane.gear_type=g.plane_search.gear_type,g.plane_engine_1.make=g.plane_search.engine_name,g.plane_engine_1.model=g.plane_search.engine_name,g.plane_propeller_1.make=g.plane_search.propeller_manufacturer,g.plane_propeller_1.model=g.plane_search.propeller_name,1<g.plane_search.number_of_engines&&(g.number_of_engine=g.plane_search.number_of_engines,g.plane_engine_2.make=g.plane_search.engine_name,g.plane_engine_2.model=g.plane_search.engine_name,g.plane_propeller_2.make=g.plane_search.propeller_manufacturer,g.plane_propeller_2.model=g.plane_search.propeller_name)}()))})},g.clearFieldError=function(e){f.clearFieldError(e)},i.save=function(){var e=[];"add"==g.action&&(e.push({ok:g.plane_search&&g.plane_search.registration,field:"registration",label:"Registration"}),e.push({ok:g.club.plane.manufacturer,field:"manufacturer",label:"Manufacturer"}),e.push({ok:g.club.plane.serial_no,field:"serial_no",label:"Serial Number"}),e.push({ok:g.club.plane.year_built,field:"year_built",label:"Year Built"}),e.push({ok:g.club.plane.plane_class,field:"plane_class",label:"Aircraft Class"}),e.push({ok:g.club.plane.gear_type,field:"gear_type",label:"Undercarriage Type"}),e.push({ok:g.club.plane.seats,field:"seats",label:"Total Seats"}),e.push({ok:g.club.plane.mtow,field:"mtow",label:"MTOW"}),e.push({ok:null!=g.club.plane.airframe_hours&&""!==g.club.plane.airframe_hours,field:"airframe_hours",label:"Airframe Hours"}),e.push({ok:g.plane_engine_1.make,field:"engine1_make",label:"Engine Make"}),e.push({ok:g.plane_engine_1.model,field:"engine1_model",label:"Engine Model"}),e.push({ok:g.plane_engine_1.serial_no,field:"engine1_serial_no",label:"Engine Serial Number"}),e.push({ok:null!=g.plane_engine_1.total_hours_at_start&&""!==g.plane_engine_1.total_hours_at_start,field:"engine1_total_hours",label:"Engine Total Hours"}),e.push({ok:g.plane_engine_1.date_fitted,field:"engine1_date_fitted",label:"Engine Date Fitted"}),e.push({ok:null!=g.plane_engine_1.tbo_hours&&""!==g.plane_engine_1.tbo_hours,field:"engine1_tbo_hours",label:"Engine TBO Hours"}),e.push({ok:g.plane_propeller_1.make,field:"prop1_make",label:"Propeller Make"}),e.push({ok:g.plane_propeller_1.model,field:"prop1_model",label:"Propeller Model"}),e.push({ok:g.plane_propeller_1.serial_no,field:"prop1_serial_no",label:"Propeller Serial Number"}),e.push({ok:g.plane_propeller_1.date_fitted,field:"prop1_date_fitted",label:"Propeller Date Fitted"}),e.push({ok:null!=g.plane_propeller_1.tbo_hours&&""!==g.plane_propeller_1.tbo_hours,field:"prop1_tbo_hours",label:"Propeller TBO Hours"}),e.push({ok:null!=g.plane_propeller_1.total_hours_at_start&&""!==g.plane_propeller_1.total_hours_at_start,field:"prop1_hours",label:"Propeller Hours"}),e.push({ok:g.plane_maintenance.cofa_category,field:"cert_type",label:"Certificate Type"}),e.push({ok:g.plane_maintenance.certificate_expiry,field:"cert_expiry",label:"Certificate Expiry"}),e.push({ok:g.plane_maintenance.next_maintenance,field:"next_maintenance",label:"Next Maintenance"}),e.push({ok:null!=g.plane_maintenance.hours_remaining&&""!==g.plane_maintenance.hours_remaining,field:"hours_remaining",label:"Hours Remaining"}),e.push({ok:g.club.plane.charge_type,field:"charge_type",label:"Charge Type"}),e.push({ok:null!=g.club.plane.tacho_hour_fee&&""!==g.club.plane.tacho_hour_fee,field:"tacho_hour_fee",label:"Cost Per Hour"})),e.push({ok:g.club.plane.plane_type,field:"plane_type",label:"ICAO Type"}),f.validateForm(e)&&("add"==g.action?i.create():i.update())},g.disable_reset=!1,g.disable_reset2=!1,g.fix_uncombined=function(){confirm("Are you sure you wish to fix uncombined flight logs - this will also reset the aerolpane logbooks and cannot be undone.")&&!g.disable_reset2?(g.disable_reset2=!0,g.show_loading=!0,t.FixUncombinedLogs(g.club_id).then(function(e){a.go("dashboard.manage_club.planes",{reload:!0}),g.disable_reset2=!0,g.show_loading=!1})):g.show_loading=!1},g.reset_all_club_logs=function(){confirm("Are you sure you wish to reset this?")&&!g.disable_reset?(g.disable_reset=!0,g.show_loading=!0,t.ResetAllClubPlanes(g.club_id).then(function(e){a.go("dashboard.manage_club.planes",{reload:!0}),g.disable_reset=!0,g.show_loading=!1})):g.show_loading=!1},g.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},i.create=function(){g.club.plane.club_id=g.club_id,g.club.plane.add_documents=g.plane_documents,g.club.plane.registration=g.plane_search.registration,g.club.maintenance_type=g.plane_maintenance.cofa_category.value,g.plane_maintenance.file=g.files.cert[0],g.plane_radio.file=g.files.radio[0],g.plane_noise.file=g.files.noise[0],g.plane_insurance.file=g.files.insurance[0],g.club.plane.maintenance=g.plane_maintenance,g.club.plane.insurance=g.plane_insurance,g.club.plane.noise_cert=g.plane_noise,g.club.plane.radio_licence=g.plane_radio,g.club.plane.vp=g.club.plane.vp?1:0,g.club.plane.rg=g.club.plane.rg?1:0,g.club.plane.tb=g.club.plane.tb?1:0,g.club.plane.engine_1=g.plane_engine_1,g.club.plane.engine_2=g.plane_engine_2,g.club.plane.propeller_1=g.plane_propeller_1,g.club.plane.propeller_2=g.plane_propeller_2,g.club.plane.colour&&""!==g.club.plane.colour&&-1==g.club.plane.colour.indexOf("rgba")&&(g.club.plane.colour=y(g.club.plane.colour,.75)),g.club.plane.bg_colour&&""!==g.club.plane.bg_colour&&-1==g.club.plane.bg_colour.indexOf("rgba")&&(g.club.plane.bg_colour=y(g.club.plane.bg_colour,.25)),r.Create(g.club.plane).then(function(e){a.go("dashboard.manage_club.planes",{reload:!0})})},i.delete=function(){f.warning("Delete Plane","Are you sure you would like to delete this plane?"),r.Update(g.club.plane).then(function(e){})},i.update=function(){g.club.plane.club_id=g.club_id,g.club.plane.add_documents=g.plane_documents,g.club.plane.update_documents=function(){for(var e=[],t=0;t<b.length;t++)for(var n=b[t],o=0;o<g.club.plane.plane_documents.length;o++)g.club.plane.plane_documents[o].id==n&&e.push(g.club.plane.plane_documents[o]);return e}(),g.club.plane.colour&&""!==g.club.plane.colour&&-1==g.club.plane.colour.indexOf("rgba")&&(g.club.plane.colour=y(g.club.plane.colour,.75)),g.club.plane.bg_colour&&""!==g.club.plane.bg_colour&&-1==g.club.plane.bg_colour.indexOf("rgba")&&(g.club.plane.bg_colour=y(g.club.plane.bg_colour,.25)),r.Update(g.club.plane).then(function(e){a.go("dashboard.manage_club.planes")})},g.save_new_aircraft_bit=function(e,t){var n="plane_"+e+"_"+t,o="plane_"+e+"_"+t+"_replace",i={},i=g[n]&&""!==g[n]?(g[n].removed_date=g[o].removed_date,delete g[o].removed_date,{old_item:g[n],new_item:g[o],plane_id:g.club.plane.id,item:e,no:t}):{old_item:{},new_item:g[o],plane_id:g.club.plane.id,item:e,no:t};r.UpdateAircraftBit(i).then(function(e){a.go("dashboard.manage_club.planes")})},i.add_item=function(e){switch(e){case"licence":var t;g.temporary.licence&&""!==g.temporary.licence&&g.temporary.rating&&""!==g.temporary.rating?(0==v(t={licence_id:g.temporary.licence.id,licence_title:g.temporary.licence.abbreviation,rating_title:g.temporary.rating.abbreviation,rating_id:g.temporary.rating.id},g.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&g.club.plane.requirements.licence.push(t),delete g.temporary.licence,delete g.temporary.rating):f.warning("Selection Required","Please select a licence and rating that is required to book the plane solo!");break;case"medical":g.temporary.medical_authority&&""!==g.temporary.medical_authority&&g.temporary.medical_component&&""!==g.temporary.medical_component?(0==v(n={authority_id:g.temporary.medical_authority.id,authority_title:g.temporary.medical_authority.abbreviation,medical_component_id:g.temporary.medical_component.id,medical_component_title:g.temporary.medical_component.title},g.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&g.club.plane.requirements.medical.push(n),delete g.temporary.medical_authority,delete g.temporary.medical_component):f.warning("Selection Required","Please select a medical that is required to book the plane solo!");break;case"differences":var n;g.temporary.difference&&""!==g.temporary.difference?(0==v(n={difference_id:g.temporary.difference.id,difference_title:g.temporary.difference.title},g.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&g.club.plane.requirements.differences.push(n),delete g.temporary.difference):f.warning("Selection Required","Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){g.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===b.indexOf(e.id)&&b.push(e.id)},i.remove_real_file=function(t){g.club.plane.plane_documents=$.grep(g.club.plane.plane_documents,function(e){return e.id!=t.id}),m.Delete(g.user_id,t.id).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(current_files))})},g.files={radio:[],cert:[],insurance:[],noise:[]},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,g.files[t].push(e[0].file)},i.set_title=function(e){return e.save_name},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,g.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){g.plane_documents=$.grep(g.plane_documents,function(e){return e.temp_path!=t.temp_path}),g.plane_documents.push(t)};i.open=function(e){c.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;l.info("PRESSED GO: ",t),r.Delete(t).then(function(){g.club.planes=$.grep(g.club.planes,function(e){return e.id!=t})})},function(){l.info("Modal dismissed at: "+new Date)})},g.aircraft,g.plane_search,g.plane_to_add,i.get_aircraft=function(t){3<t.length&&r.GetAddAircraft(t).then(function(e){!e||0==e.length?g.aircraft=[{icao_type:"not known",registration:t.toUpperCase()}]:g.aircraft=e})}}function DashboardClubPropellerLogbookController(e,n,t,o,i,r,a,s,d,c,l,u,_,p,m,f,g,b){var h=this;switch(h.action){case"add":h.page_title="Add a New Plane";break;case"edit":n.GetByIdMaintenance2(a.plane_id,h.club_id).then(function(e){h.club.plane=e,h.this_plane_id=a.plane_id,h.club.plane&&h.club.plane.maintenance&&(h.obj.hours_remaining=h.club.plane.maintenance.hours_remaining,h.obj.next_check=new Date(h.club.plane.maintenance.next_maintenance),h.obj.check_date=new Date,h.obj.extension_granted=new Date),h.page_title="Edit a Plane Maintenance - "+h.club.plane.registration}),n.GetOpenIssues(a.plane_id).then(function(e){h.reported_defects=e})}function k(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}return o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},h.prop_no="",n.GetPropLogs(a.prop_id,a.plane_id,0,25).then(function(e){h.logs=e.logs,h.propeller=e.propeller}),h.current_offset=0,h.loaded_per_batch=25,h.all_loaded=!1,h.load_more=function(){h.current_offset=h.current_offset+h.loaded_per_batch,n.GetPropLogs(a.prop_id,a.plane_id,h.current_offset,h.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return h.logs.push(e)}):h.all_loaded=!0,h.propeller=e.propeller})},h.get_initial=function(e){return e.charAt(0)},h.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},h.maintenanceTypeLabels={"50hour":"50-Hour Check","100hour":"100-Hour Check","150hour":"150-Hour Check","25hours":"25-Hour Check","50hours":"50-Hour Check","100hours":"100-Hour Check",annual:"Annual Inspection",cofa:"Certificate of Airworthiness",arc:"Airworthiness Review Certificate",engine_overhaul:"Engine Overhaul",propeller_overhaul:"Propeller Overhaul",interim:"Interim Inspection","6months":"6-Month Check",extension:"Extension",workpack:"Workpack",other:"Other Maintenance"},h.formatMaintenanceType=function(e){return h.maintenanceTypeLabels[e]||e||"Maintenance"},h.isMaintenanceEntry=function(e){return"maintenance_check"===e.entry_type},h.getEntryType=function(e){return e.entry_type||"flight"},h.getEntryPosition=function(e){return e.entry_position||"full_day"},h.getHoursRemainingClass=function(e){return null==e?"":e<=5?"hours-critical":e<=10?"hours-warning":""},h.formatHoursRemaining=function(e){return null==e?"N/A":e.toFixed(2)+" hrs"},h.selected_check=null,h.show_check_detail=!1,h.check_logbook_links=[],h.check_logbook_loading=!1,h.check_logbook_error=!1,h.check_workpack=null,h.check_workpack_loading=!1,h.viewMaintenanceCheck=function(e){var t;h.isMaintenanceEntry(e)&&(h.selected_check=e,h.show_check_detail=!0,h.check_logbook_links=[],h.check_logbook_error=!1,h.check_workpack=null,(t=(e.maintenance_check||{}).id||e.maintenance_check_id||null)&&(h.loadCheckLogbookLinks(t),h.loadCheckWorkpack(e)))},h.closeMaintenanceCheck=function(){h.selected_check=null,h.show_check_detail=!1,h.check_logbook_links=[],h.check_logbook_error=!1,h.check_workpack=null},h.loadCheckLogbookLinks=function(n){n&&(h.check_logbook_loading=!0,h.check_logbook_error=!1,h.check_logbook_links=[],g.GetAvailableLogbooks(a.plane_id).then(function(e){var t=e&&e.available_logbooks?e.available_logbooks:[];if(0===t.length)return h.check_logbook_loading=!1,void(h.check_logbook_error=!0);g.GetLinks(n).then(function(e){h.check_logbook_loading=!1;var n=[];e&&e.maintenance_check&&e.maintenance_check.logbook_links&&(n=e.maintenance_check.logbook_links),h.check_logbook_links=t.map(function(t){var e=n.some(function(e){return e.logbook_type===t.logbook_type&&e.logbook_entity_id==t.logbook_entity_id});return{logbook_type:t.logbook_type,logbook_entity_id:t.logbook_entity_id,label:t.label,position:t.position||null,isLinked:e}})},function(){h.check_logbook_loading=!1,h.check_logbook_error=!0})},function(){h.check_logbook_loading=!1,h.check_logbook_error=!0}))},h.loadCheckWorkpack=function(e){e=e.maintenance_check||{},e=e.linked_workpack_id||e.workpack_id||null;e&&(h.check_workpack_loading=!0,b.GetById(e).then(function(e){h.check_workpack_loading=!1,e&&e.workpack&&(h.check_workpack=e.workpack)},function(){h.check_workpack_loading=!1}))},h.downloadWorkpackDocument=function(e){e&&m.get("/api/v1/maintenance_workpacks/file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){var o=new Blob([e],{type:"application/pdf"}),e=URL.createObjectURL(o),o=window.open();o.document.write('<html><head><title>Workpack Document</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),o.document.close()}).error(function(){f.error("Download Error","There was an error downloading the workpack document.")})},h.getLogbookIcon=function(e){switch(e){case"airframe":return"fa-plane";case"engine":return"fa-cog";case"propeller":return"fa-refresh";default:return"fa-book"}},h.getCheckTypeIcon=function(e){if(!e)return"fa-wrench";switch(e.toLowerCase()){case"annual":return"fa-calendar-check-o";case"50hours":case"50hour":case"25hours":case"100hours":case"100hour":case"150hour":return"fa-tachometer";case"extension":return"fa-clock-o";case"interim":return"fa-cogs";case"6months":return"fa-calendar";case"cofa":case"arc":return"fa-certificate";case"engine_overhaul":return"fa-cog";case"propeller_overhaul":return"fa-repeat";case"workpack":return"fa-briefcase";default:return"fa-wrench"}},h.update_logbooks=function(){n.UpdateAircraftLogbooks(a.plane_id).then(function(e){e.success&&n.GetPropLogs(a.prop_id,a.plane_id,0,25).then(function(e){h.logs=e.logs,h.propeller=e.propeller})})},i.update_this_file=function(e){-1===update_this_file.indexOf(e.id)&&update_this_file.push(e.id)},i.remove_real_file=function(t){h.club.plane.plane_documents=$.grep(h.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(h.user_id,t.id).then(function(e){e.success&&(h.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){JSON.parse(e.file_return)},h.files={radio:[],cert:[],insurance:[]},i.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,h.files[t].push(e[n].file)}},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,h.files[t].push(e[0])},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},h.defect_severity,h.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){h.plane_documents=$.grep(h.plane_documents,function(e){return e.temp_path!=t.temp_path}),h.plane_documents.push(t)},i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return warning_msg}}}).result.then(function(e){var t=e.id;d.info("PRESSED GO: ",t),n.Delete(t).then(function(){h.club.planes=$.grep(h.club.planes,function(e){return e.id!=t})})},function(){d.info("Modal dismissed at: "+new Date)})},i.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){f.error("Download Failed","There was an error downloading the selected document(s).")})},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){f.error("Download Failed","There was an error downloading the selected document(s).")})},i.search2=function(e){return!i.my_search2||""==i.my_search2||!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(i.my_search2,e.entry_date)},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},i.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n}}function DashboardClubReceiptsApprovalController(e,n,t,o,i,r,a,s,c,l,d,u,_,p,m,f){var g=this;g.user=null,g.allUsers=[],g.club={},g.page_title="",g.plane_document={},g.plane_documents=[];var b=[];function h(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}g.action=r.current.data.action,g.club_id=t.globals.currentUser.current_club_admin.id,g.user=t.globals.currentUser,g.user_id=g.user.id,n.GetCurrencies(g.club_id).then(function(e){g.currencies=e.currencies,g.club_currency=e.club_currency}),n.GetReceiptsApproval(g.club_id).then(function(e){g.receipts=e.receipts,g.receipts.forEach(function(e){g.verify_reimbursement(e)})}),i.get_currency=function(t){return $.grep(g.currencies,function(e){return e.iso_code==t})[0]},g.update_price=function(t){var e={modified_price:t.modified_price};n.UpdateReceipt(t.id,e).then(function(e){g.verify_reimbursement(t)})},g.verify_reimbursement=function(t){if(t.modified_price&&!t.modified_currency)t.modified_reimbursed_amount=t.modified_price,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount));else if(!t.modified_price||!t.modified_currency||0==t.reimbursement)return!1;var e={club_id:(t=$.grep(g.receipts,function(e){return e.id==t.id})[0]).club_id,currency:t.modified_currency||t.currency,price:t.modified_price||t.price,requested_at:t.created_at};n.CheckReimbursement(e).then(function(e){t.modified_reimbursed_amount=e.reimburse.reimbursed_amount,t.modified_reimbursed_rate=e.reimburse.rate,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount)),0==t.modified_reimbursed_difference&&(t.modified_reimbursed_difference=0)})},g.modified_reimbursement_tooltip=function(e){var t=e.modified_currency||e.currency,n=(e.modified_price?parseFloat(e.modified_price):parseFloat(e.price)).toFixed(2),t=t+""+parseFloat(n).toFixed(2);(e.modified_currency&&e.modified_currency!==e.reimbursed_currency||e.reimbursed_currency!==e.currency&&e.modified_reimbursed_rate)&&(t=t+" which on "+moment(e.created_at).format("DD MMM YYYY HH:mm")+" the Transferwise currency conversion of "+parseFloat(e.modified_reimbursed_rate).toFixed(5)+" gave a value of "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_amount).toFixed(2));n="<br /><br /> By approving this receipt, we will automatically adjust the reimbursement by "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_difference).toFixed(2)+" for this claim.";return 0==e.modified_reimbursed_difference&&(n="<br /><br /> By approving this receipt, there will be no financial charge for this change."),m.getTrustedHtml("<div>This is the amount that should have been removed from the associated invoice. <br /><br /> This is based on the receipt value of "+t+". "+n+"</div>")},g.update_currency=function(t){var e={modified_currency:t.modified_currency};n.UpdateReceipt(t.id,e).then(function(e){g.verify_reimbursement(t)})},g.update_invoice_no=function(e){var t={invoice_number:e.invoice_number};n.UpdateReceipt(e.id,t).then(function(e){})},g.update_qty=function(e){var t={modified_quantity:e.modified_quantity};n.UpdateReceipt(e.id,t).then(function(e){})},i.back=function(){l.history.back()},i.save=function(){"add"==g.action?i.create():i.update()},i.create=function(){g.club.item.club_id=g.club_id,p.Create(g.club.item).then(function(e){r.go("dashboard.manage_club.items")})},i.delete=function(){f.warning("Confirm Delete","Are you sure you would like to delete this item?"),p.Delete(g.user.id,g.club.item).then(function(e){})},i.update=function(){g.club.item.club_id=g.club_id,p.Update(g.club.item,g.user.id).then(function(e){r.go("dashboard.manage_club.items")})},i.add_item=function(e){switch(e){case"licence":var t;g.temporary.licence&&""!==g.temporary.licence&&g.temporary.rating&&""!==g.temporary.rating?(0==h(t={licence_id:g.temporary.licence.id,licence_title:g.temporary.licence.abbreviation,rating_title:g.temporary.rating.abbreviation,rating_id:g.temporary.rating.id},g.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&g.club.plane.requirements.licence.push(t),delete g.temporary.licence,delete g.temporary.rating):f.warning("Selection Required","Please select a licence and rating that is required to book the plane solo!");break;case"medical":g.temporary.medical_authority&&""!==g.temporary.medical_authority&&g.temporary.medical_component&&""!==g.temporary.medical_component?(0==h(n={authority_id:g.temporary.medical_authority.id,authority_title:g.temporary.medical_authority.abbreviation,medical_component_id:g.temporary.medical_component.id,medical_component_title:g.temporary.medical_component.title},g.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&g.club.plane.requirements.medical.push(n),delete g.temporary.medical_authority,delete g.temporary.medical_component):f.warning("Selection Required","Please select a medical that is required to book the plane solo!");break;case"differences":var n;g.temporary.difference&&""!==g.temporary.difference?(0==h(n={difference_id:g.temporary.difference.id,difference_title:g.temporary.difference.title},g.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&g.club.plane.requirements.differences.push(n),delete g.temporary.difference):f.warning("Selection Required","Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){g.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===b.indexOf(e.id)&&b.push(e.id)},i.remove_real_file=function(t){g.club.plane.plane_documents=$.grep(g.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(g.user.id,t.id).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,g.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon3=function(e){var e=e.split(";")[0],t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},g.approve_receipt_final=function(t){delete t.image,n.ApproveReceipt(t.id,t).then(function(e){e.success?g.receipts.splice(g.receipts.findIndex(function(e){return e.id===t.id}),1):f.error("Approval Error","An error occurred: "+e.message),g.show_popup=!1,g.current_receipt={}})},g.reject_receipt_final=function(t){delete t.image,n.RejectReceipt(t.id,t).then(function(e){e.success?g.receipts.splice(g.receipts.findIndex(function(e){return e.id===t.id}),1):f.error("Rejection Error","An error occurred: "+e.message),g.show_popup=!1,g.current_receipt={}})},i.approve_receipt=function(e){g.current_receipt=e,0<g.current_receipt.modified_reimbursed_amount?g.show_popup="approve":g.approve_receipt_final(e)},i.reject_receipt=function(e){g.current_receipt=e,g.show_popup="reject"},i.close_popup=function(){g.show_popup=!1,g.current_receipt={}},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){g.plane_documents=$.grep(g.plane_documents,function(e){return e.temp_path!=t.temp_path}),g.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(g.user.id,t.id).then(function(){g.club.items=$.grep(g.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubReceiptsController(e,n,t,o,i,r,a,s,c,l,d,u,_,p,m,f){var g=this;g.user=null,g.allUsers=[],g.club={},g.page_title="",g.plane_document={},g.plane_documents=[];var b=[];function h(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}g.action=r.current.data.action,g.club_id=t.globals.currentUser.current_club_admin.id,g.user=t.globals.currentUser,g.user_id=g.user.id,n.GetCurrencies(g.club_id).then(function(e){g.currencies=e.currencies,g.club_currency=e.club_currency}),g.current_offset=0,g.loaded_per_batch=10,g.all_loaded=!1,n.GetReceiptsClub(g.club_id,g.current_offset,g.loaded_per_batc).then(function(e){g.receipts=e.receipts,g.receipts.forEach(function(e){g.verify_reimbursement(e)})}),g.load_more=function(){g.current_offset=g.current_offset+g.loaded_per_batch,n.GetReceiptsClub(g.club_id,g.current_offset,g.loaded_per_batch).then(function(e){0<e.receipts.length?e.receipts.forEach(function(e){return g.receipts.push(e)}):g.all_loaded=!0})},g.show_receipt_image=function(e){g.show_receipt=!0,g.receipt_image=e.image},i.get_currency=function(t){return $.grep(g.currencies,function(e){return e.iso_code==t})[0]},g.update_price=function(t){var e={modified_price:t.modified_price};n.UpdateReceipt(t.id,e).then(function(e){g.verify_reimbursement(t)})},g.verify_reimbursement=function(t){if(t.modified_price&&!t.modified_currency)t.modified_reimbursed_amount=t.modified_price,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount));else if(!t.modified_price||!t.modified_currency||0==t.reimbursement)return!1;var e={club_id:(t=$.grep(g.receipts,function(e){return e.id==t.id})[0]).club_id,currency:t.modified_currency||t.currency,price:t.modified_price||t.price,requested_at:t.created_at};n.CheckReimbursement(e).then(function(e){t.modified_reimbursed_amount=e.reimburse.reimbursed_amount,t.modified_reimbursed_rate=e.reimburse.rate,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount)),0==t.modified_reimbursed_difference&&(t.modified_reimbursed_difference=0)})},g.modified_reimbursement_tooltip=function(e){var t=e.modified_currency||e.currency,n=(e.modified_price?parseFloat(e.modified_price):parseFloat(e.price)).toFixed(2),t=t+""+parseFloat(n).toFixed(2);(e.modified_currency&&e.modified_currency!==e.reimbursed_currency||e.reimbursed_currency!==e.currency&&e.modified_reimbursed_rate)&&(t=t+" which on "+moment(e.created_at).format("DD MMM YYYY HH:mm")+" the Transferwise currency conversion of "+parseFloat(e.modified_reimbursed_rate).toFixed(5)+" gave a value of "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_amount).toFixed(2));n="<br /><br /> By approving this receipt, we will automatically adjust the reimbursement by "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_difference).toFixed(2)+" for this claim.";return 0==e.modified_reimbursed_difference&&(n="<br /><br /> By approving this receipt, there will be no financial charge for this change."),m.getTrustedHtml("<div>This is the amount that should have been removed from the associated invoice. <br /><br /> This is based on the receipt value of "+t+". "+n+"</div>")},g.update_currency=function(t){var e={modified_currency:t.modified_currency};n.UpdateReceipt(t.id,e).then(function(e){g.verify_reimbursement(t)})},g.update_invoice_no=function(e){var t={invoice_number:e.invoice_number};n.UpdateReceipt(e.id,t).then(function(e){})},g.update_qty=function(e){var t={modified_quantity:e.modified_quantity};n.UpdateReceipt(e.id,t).then(function(e){})},i.back=function(){l.history.back()},i.save=function(){"add"==g.action?i.create():i.update()},i.create=function(){g.club.item.club_id=g.club_id,p.Create(g.club.item).then(function(e){r.go("dashboard.manage_club.items")})},i.delete=function(){f.warning("Confirm Delete","Are you sure you would like to delete this item?"),p.Delete(g.user.id,g.club.item).then(function(e){})},i.update=function(){g.club.item.club_id=g.club_id,p.Update(g.club.item,g.user.id).then(function(e){r.go("dashboard.manage_club.items")})},i.add_item=function(e){switch(e){case"licence":var t;g.temporary.licence&&""!==g.temporary.licence&&g.temporary.rating&&""!==g.temporary.rating?(0==h(t={licence_id:g.temporary.licence.id,licence_title:g.temporary.licence.abbreviation,rating_title:g.temporary.rating.abbreviation,rating_id:g.temporary.rating.id},g.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&g.club.plane.requirements.licence.push(t),delete g.temporary.licence,delete g.temporary.rating):f.warning("Selection Required","Please select a licence and rating that is required to book the plane solo!");break;case"medical":g.temporary.medical_authority&&""!==g.temporary.medical_authority&&g.temporary.medical_component&&""!==g.temporary.medical_component?(0==h(n={authority_id:g.temporary.medical_authority.id,authority_title:g.temporary.medical_authority.abbreviation,medical_component_id:g.temporary.medical_component.id,medical_component_title:g.temporary.medical_component.title},g.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&g.club.plane.requirements.medical.push(n),delete g.temporary.medical_authority,delete g.temporary.medical_component):f.warning("Selection Required","Please select a medical that is required to book the plane solo!");break;case"differences":var n;g.temporary.difference&&""!==g.temporary.difference?(0==h(n={difference_id:g.temporary.difference.id,difference_title:g.temporary.difference.title},g.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&g.club.plane.requirements.differences.push(n),delete g.temporary.difference):f.warning("Selection Required","Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){g.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===b.indexOf(e.id)&&b.push(e.id)},i.remove_real_file=function(t){g.club.plane.plane_documents=$.grep(g.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(g.user.id,t.id).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,g.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon3=function(e){var e=e.split(";")[0],t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},g.approve_receipt_final=function(t){delete t.image,n.ApproveReceipt(t.id,t).then(function(e){e.success?g.receipts.splice(g.receipts.findIndex(function(e){return e.id===t.id}),1):f.error("Approval Error","An error occurred: "+e.message),g.show_popup=!1,g.current_receipt={}})},g.reject_receipt_final=function(t){delete t.image,n.RejectReceipt(t.id,t).then(function(e){e.success?g.receipts.splice(g.receipts.findIndex(function(e){return e.id===t.id}),1):f.error("Rejection Error","An error occurred: "+e.message),g.show_popup=!1,g.current_receipt={}})},i.approve_receipt=function(e){g.current_receipt=e,0<g.current_receipt.modified_reimbursed_amount?g.show_popup="approve":g.approve_receipt_final(e)},i.reject_receipt=function(e){g.current_receipt=e,g.show_popup="reject"},i.close_popup=function(){g.show_popup=!1,g.current_receipt={}},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){g.plane_documents=$.grep(g.plane_documents,function(e){return e.temp_path!=t.temp_path}),g.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(g.user.id,t.id).then(function(){g.club.items=$.grep(g.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubSettingsController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;switch(_.user=null,_.allUsers=[],_.club={},_.club_id=o.globals.currentUser.current_club_admin.id,_.user=o.globals.currentUser,_.user_id=_.user.id,_.action=a.current.data.action,_.action){case"list":t.GetById(_.club_id).then(function(e){_.club.settings=e,_.club.settings.vat_registered=1==_.club.settings.vat_registered,_.club.settings.tpc_aircraft_surchages=1==_.club.settings.tpc_aircraft_surchages,_.club.settings.vat_rate=parseFloat(_.club.settings.vat_rate)});break;case"stripe_return":_.stripe_id=s.stripe_id,n.SaveStripeLink(_.club_id,_.stripe_id).then(function(e){});break;case"stripe_refresh":_.stripe_id=s.stripe_id,n.RefreshStripeLink(_.club_id,_.stripe_id).then(function(e){})}r.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url;o="update_"+t;_.club.settings[t]=e[n].file,_.club.settings[t]=e[n].file.temp_path,_.club.settings[o]=!0}},_.clearFieldError=function(e){u.clearFieldError(e)},r.save=function(){var e=[{ok:_.club.settings.title,field:"title",label:"Trading As"},{ok:_.club.settings.email,field:"email",label:"Email"},{ok:_.club.settings.address,field:"address",label:"Registered Address"}];_.club.settings.vat_registered&&(e.push({ok:_.club.settings.vat_number,field:"vat_number",label:"VAT Number"}),e.push({ok:null!=_.club.settings.vat_rate&&""!==_.club.settings.vat_rate,field:"vat_rate",label:"VAT Rate"})),u.validateForm(e)&&(_.club.settings.update_logo||delete _.club.settings.logo,_.club.settings.update_invoice_logo||delete _.club.settings.invoice_logo,_.privacy_file?_.club.settings.privacy_terms=_.privacy_file:delete _.club.settings.privacy_terms,_.membership_file?_.club.settings.membership_terms=_.membership_file:delete _.club.settings.membership_terms,_.passenger_file?_.club.settings.passenger_terms=_.passenger_file:delete _.club.settings.passenger_terms,delete _.club.settings.membership_updated,delete _.club.settings.passenger_updated,delete _.club.settings.privacy_updated,delete _.club.settings.updated_at,delete _.club.settings.created_at,delete _.club.settings.gcl,delete _.club.settings.salt,delete _.club.settings.pepper,_.club.settings.vat_registered=_.club.settings.vat_registered?1:0,_.club.settings.tpc_aircraft_surchages=_.club.settings.tpc_aircraft_surchages?1:0,t.Update(_.club.settings).then(function(e){a.go("dashboard.manage_club")}))},_.called_stripe_setup=!1,_.generate_stripe_link=function(){_.called_stripe_setup=!0,n.GenerateStripeLink(_.club.settings).then(function(e){e.success&&""!==e.onboarding_link?(u.success("Stripe Redirect","You will be redirected to Stripe - please complete the setup and you will be returned to ToAviate"),window.location=e.onboarding_link):(u.error("Stripe Error","Please try the link again! Stripe didn't seem to want to connect to ToAviate"),_.called_stripe_setup=!1)})},_.term_documents=[],r.processFiles2=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();switch(e[n].file.extension=o,t){case"privacy":_.privacy_file=e[n].file;break;case"membership":_.membership_file=e[n].file;break;case"passenger":_.passenger_file=e[n].file}}},r.delete_file=function(e){switch(e){case"privacy":_.club.settings.privacy_terms,_.club.settings.privacy_terms="";break;case"membership":_.club.settings.membership_terms,_.club.settings.membership_terms="";break;case"passenger":_.club.settings.passenger_terms,_.club.settings.passenger_terms=""}},r.remove_file=function(e,t){JSON.parse(e.file_return)},r.set_title=function(e){return e.save_name},r.back=function(){c.history.back()},r.get_icon=function(e){var e=e&&e.name?e.name:e,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},r.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");l.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){u.error("Download Error","There was an error downloading the selected document(s)")})}}function DashboardClubShopItemsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];switch(f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.action){case"add":f.page_title="Add a New Plane";break;case"edit":p.GetById(a.item_id).then(function(e){f.club.item=e.item,f.page_title="Edit an Item - "+f.club.item.title});break;case"list":p.GetByClubId(f.club_id).then(function(e){f.club.items=e.items})}i.back=function(){l.history.back()},f.clearFieldError=function(e){m.clearFieldError(e)},i.save=function(){f.club.item||(f.club.item={});var e=[{ok:f.club.item.title,field:"title",label:"Title"},{ok:null!=f.club.item.price&&""!==f.club.item.price,field:"price",label:"Price"}];m.validateForm(e)&&("add"==f.action?i.create():i.update())},i.create=function(){f.club.item.club_id=f.club_id,p.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.shop_items")})},i.delete=function(e){confirm("Are you sure you would like to delete this item?")&&p.Delete(f.user.id,e.id).then(function(e){e.success?p.GetByClubId(f.club_id).then(function(e){f.club.items=e.items}):m.error("Delete Error","An error occurred when trying to delete this item.")})},i.update=function(){f.club.item.club_id=f.club_id,p.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.shop_items")})},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),ItemService.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubShopSaleController(n,e,t,o,i,r,a,s,c,l,d){var u=this;i.to_refund=0,i.reason="",i.club_id=r.globals.currentUser.current_club_admin.id,u.club_id=i.club_id,i.club_settings={},i.new_client={first_name:"",last_name:"",email:""},i.items=[],i.item={title:"",quantity:1,vat:0,price:0},i.selected_client,i.selected_card,u.selected_voucher,i.members=[],i.show_direct_debit_details=!1,u.custom_item=!1;function _(){for(var e=0,t=0,n=0;n<i.items.length;n++)i.items[n].total=i.items[n].quantity*i.items[n].price,0<i.items[n].vat&&(this_vat=i.items[n].total*(i.items[n].vat/100),t+=this_vat),e+=i.items[n].total;i.the_vat=t,i.the_total=e}u.close_pay_now=function(){u.show_pay_now=!1,u.show_loading=!1},u.donConfirm=function(e,t){u.complete_now(e,t)},u.default_payment="new-card",u.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],u.savedCards=[],c.GetByClubId(u.club_id).then(function(e){u.shop_items=e.items}),s.GetById(i.club_id).then(function(e){i.club_settings=e,i.item.vat=parseFloat(i.club_settings.vat_rate),i.club_settings.vat_registered=1==i.club_settings.vat_registered}),t.GetByClubId(i.club_id).then(function(e){u.vouchers=e.items}),t.GetDiscountsByClubId(i.club_id).then(function(e){u.discounts=e.items}),d.GetPackagesByClubId(i.club_id).then(function(e){u.packages=e.items}),a.GetAllByClub(i.club_id).then(function(e){i.members=e,i.members.unshift({id:-12,first_name:"New",last_name:"Client"})}),i.delete_receipt=function(e){i.items.splice(e,1),_()},i.card_selected=function(e){(i.selected_card=e).id},i.member_selected=function(e){(i.selected_client=e)&&e.account_ending&&""!==e.account_ending?i.show_direct_debit_details=!0:i.show_direct_debit_details=!1,e&&e.id},i.selected_item,i.item_selected=function(e){i.selected_item=e},i.package_selected=function(e){i.selected_package=e},u.new_item_qty=1,u.add_selected_voucher=function(){var e;i.items.find(function(e){return e.voucher_id===u.selected_voucher.id})&&0<u.selected_voucher.id?i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).quantity=i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).quantity+1:0<u.selected_voucher.id&&((e=u.selected_voucher).quantity=1,e.item_id=u.selected_voucher.id,e.unit_price=u.selected_voucher.price,e.voucher_id=u.selected_voucher.id,u.selected_discount&&u.selected_discount.id&&0<u.selected_discount.id?e.discount_id=u.selected_discount.id:e.discount_id=0,e.vat_rate&&(e.vat=parseFloat(u.selected_voucher.vat_rate),delete e.vat_rate),i.items.push(e)),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},u.new_item_qty=1,_(),t.GetDiscountsByClubIdAndExperienceId(i.club_id,u.selected_voucher.id).then(function(e){u.discounts=e.items})},u.add_selected_discount=function(){var e=0,e=1==u.selected_discount.discount_type?u.selected_discount.discount.price:u.selected_voucher.price-u.selected_voucher.price*(u.selected_discount.percentage/100);i.items.find(function(e){return e.voucher_id===u.selected_voucher.id})&&0<u.selected_voucher.id&&(i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).price=e,i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).unit_price=e,i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).discount_id=u.selected_discount.id,i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).discount_code=u.selected_discount.discount_code),_()},i.add_selected_item=function(){var e;i.items.find(function(e){return e.item_id===i.selected_item.id})?i.items.find(function(e){return e.item_id===i.selected_item.id}).quantity=i.items.find(function(e){return e.item_id===i.selected_item.id}).quantity+u.new_item_qty:((e=i.selected_item).quantity=u.new_item_qty,e.item_id=i.selected_item.id,e.vat_rate&&(e.vat=parseFloat(i.selected_item.vat_rate),delete e.vat_rate),i.items.push(e)),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},u.new_item_qty=1,_()},i.selected_package,i.add_selected_package=function(){var e;i.items.find(function(e){return e.package_id===i.selected_package.id})?i.items.find(function(e){return e.package_id===i.selected_package.id}).quantity++:((e=i.selected_package).quantity=1,e.package_id=i.selected_package.id,e.vat_rate=parseFloat(i.club_settings.vat_rate),e.vat_rate&&(e.package_id=i.selected_package.id,e.vat=i.selected_package.vat_rate,delete e.vat_rate),i.items.push(e)),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},u.new_item_qty=1,_()},i.add_item=function(e){i.item=e,i.items.push(i.item),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},_()},u.complete_now=function(e,t){t={user_id:i.selected_client.user_id,club_id:i.club_id,user:i.selected_client,invoice_id:u.invoice_id,method:e,paymentIntent:t};o.CompleteCustom(t).then(function(e){e.success&&n(function(){l.go("dashboard.manage_club",{},{reload:!0})},2e3)})},u.invoice_id=0,i.ok=function(){u.show_loading=!0,-12==i.selected_client.id?(i.selected_client.first_name=i.new_client.first_name,i.selected_client.last_name=i.new_client.last_name,i.selected_client.email=i.new_client.email):(i.selected_client.first_name=i.selected_client.first_name,i.selected_client.last_name=i.selected_client.last_name,i.selected_client.email=i.selected_client.email);var e={items:i.items,user:i.selected_client,user_id:i.selected_client.user_id,club_id:i.club_id};o.CreateCustom(e).then(function(e){e.success?(u.invoice_id=e.invoice_id,u.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.invoice_id},a.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(u.info=e.info,u.savedCards=e.cards,0<u.savedCards.length?u.methods[1].visible=!0:u.methods[1].visible=!1,null==u.info?u.methods[0].visible=!1:u.methods[0].visible=!0,u.machine=e.machine,u.machine.success?u.methods[3].visible=!0:u.methods[3].visible=!1,u.show_pay_now=!0,u.show_loading=!1)})):u.show_loading=!1})},i.cancel=function(){l.go("dashboard.manage_club",{},{reload:!0})}}function DashboardClubVouchersAddController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g){var b=this;b.user=null,b.allUsers=[],b.club={item:{}},b.page_title="",b.plane_document={},b.plane_documents=[];b.action=r.current.data.action,b.club_id=n.globals.currentUser.current_club_admin.id,b.user=n.globals.currentUser,b.user_id=b.user.id,b.charge_type=["brakes","session","plane"],b.discounts=[],b.planes=[],b.show_paid=!1,p.GetByClubId(b.club_id).then(function(e){b.experiences=e.items}),b.page_title="Add a Voucher",m.GetUniqueCode(b.club_id).then(function(e){b.club.item.code=e.code});var h,k=Stripe(f.getStripeKeyLegacy()),y=k.elements().create("card",{hidePostalCode:!0,style:{base:{iconColor:"#666EE8",color:"#31325F",lineHeight:"40px",fontWeight:300,fontFamily:"Helvetica Neue",fontSize:"15px","::placeholder":{color:"#CFD7E0"}}}}),v=!1,w=!1;p.GetDiscountsByClubId(b.club_id).then(function(e){b.discounts=e.items}),i.$on("$viewContentLoaded",function(){clearTimeout(h),0==w&&(w=!0,h=setTimeout(function(){clearTimeout(h),0==v&&(v=!0,y.mount("#card-element"),document.getElementById("payment-form2").addEventListener("submit",function(e){e.preventDefault()}))},1500))}),i.check_code=function(){},i.back=function(){l.history.back()},b.clearFieldError=function(e){g.clearFieldError(e)},i.save=function(){var e=[{ok:b.club.item.experience&&b.club.item.experience.id,field:"voucher_experience",label:"Experience"},{ok:b.club.item.first_name,field:"first_name",label:"First Name"},{ok:b.club.item.last_name,field:"last_name",label:"Last Name"},{ok:b.club.item.email,field:"email",label:"Email Address"},{ok:b.club.item.code,field:"code",label:"Voucher Code"},{ok:b.club.item.expiry_date,field:"expiry_date",label:"Expiry Date"}];b.already_paid&&(e.push({ok:null!=b.club.item.price_paid&&0<=b.club.item.price_paid,field:"price_paid",label:"Price Paid"}),e.push({ok:b.club.item.payment_method,field:"payment_method",label:"Payment Method"})),g.validateForm(e)&&("add"==b.action?i.create():i.update())},i.create=function(){return b.club.item.experience&&b.club.item.experience.id?b.club.item.first_name&&b.club.item.last_name&&b.club.item.email?b.already_paid&&(b.club.item.price_paid<0||!b.club.item.payment_method)?(g.warning("Payment Required","Please fill in how much was paid and what payment method was used to complete the payment."),!1):(b.club.item.experience_title=b.club.item.experience.title,b.club.item.experience_id=b.club.item.experience.id,b.club.item.discount&&0<b.club.item.discount.id&&(b.club.item.discount_id=b.club.item.discount.id),b.club.item.club_id=b.club_id,void(b.already_paid?(e={payment_method:b.club.item.payment_method,amount:b.club.item.price_paid},b.club.item.price=b.club.item.price_paid,b.club.item.payment=e,delete b.club.item.payment_method,delete b.club.item.price_paid,m.Create(b.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})):(e={name:document.getElementById("name").value,address_zip:document.getElementById("address-postcode").value},k.createToken(y,e).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={user_id:b.user.id,brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,exp_month:e.token.card.exp_month,exp_year:e.token.card.exp_year,funding:e.token.card.funding,name:e.token.card.name,address_postcode:e.token.card.address_zip,client_ip:e.token.client_ip},b.club.item.payment=e,delete b.club.item.experience,m.Create(b.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})}))})))):(g.warning("Missing Details","You must enter the purchasor's first name, last name and email address."),!1):(g.warning("Selection Required","You must select an experience to issue this voucher."),!1);var e},i.delete=function(){g.warning("Confirm Delete","Are you sure you would like to delete this voucher?"),m.Delete(b.user.id,b.club.item).then(function(e){})},i.update=function(){b.club.item.club_id=b.club_id,m.Update(b.club.item,b.user.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.update_experience=function(){var e=b.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),b.club.item.expiry_date=new Date(e),b.club.item.price=b.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(b.club_id,b.club.item.experience.id).then(function(e){b.discounts=e.items})},i.update_discount=function(){1==b.club.item.discount.discount_type?b.club.item.price=b.club.item.discount.price:b.club.item.price=b.club.item.experience.price-b.club.item.experience.price*(b.club.item.discount.percentage/100)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(b.user.id,t.id).then(function(){b.club.items=$.grep(b.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubVouchersController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f){var g=this;g.user=null,g.allUsers=[],g.club={item:{}},g.page_title="",g.plane_document={},g.plane_documents=[];var b=[];g.action=r.current.data.action,g.club_id=n.globals.currentUser.current_club_admin.id,g.user=n.globals.currentUser,g.user_id=g.user.id,g.charge_type=["brakes","session","plane"],g.discounts=[],g.planes=[],p.GetByClubId(g.club_id).then(function(e){g.experiences=e.items}),m.GetByClubId(g.club_id).then(function(e){g.club.items=e.items}),i.check_code=function(){},i.back=function(){l.history.back()},i.save=function(){"add"==g.action?i.create():i.update()},i.create=function(){return g.club.item.experience&&g.club.item.experience.id?g.club.item.first_name&&g.club.item.last_name&&g.club.item.email?!g.already_paid||g.club.item.price_paid&&g.club.item.payment_method?(g.club.item.experience_title=g.club.item.experience.title,g.club.item.experience_id=g.club.item.experience.id,g.club.item.discount_id=g.club.item.discount.id,g.club.item.club_id=g.club_id,void(g.already_paid?(e={payment_method:g.club.item.payment_method,amount:g.club.item.price_paid},g.club.item.payment=e,delete g.club.item.payment_method,delete g.club.item.price_paid,m.Create(g.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})):(e={name:document.getElementById("name").value,address_zip:document.getElementById("address-postcode").value},stripe.createToken(card,e).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={user_id:g.user.id,brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,exp_month:e.token.card.exp_month,exp_year:e.token.card.exp_year,funding:e.token.card.funding,name:e.token.card.name,address_postcode:e.token.card.address_zip,client_ip:e.token.client_ip},g.club.item.payment=e,delete g.club.item.experience,m.Create(g.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})}))})))):(f.warning("Payment Details","Please fill in how much was paid and what payment method was used to complete the payment"),!1):(f.warning("Missing Details","You must enter the purchasor's first name, last name and email address."),!1):(f.warning("Missing Experience","You must select an experience to issue this voucher"),!1);var e},i.delete=function(){f.warning("Confirm Delete","Are you sure you would like to delete this plane?"),m.Delete(g.user.id,g.club.item).then(function(e){})},i.update=function(){g.club.item.club_id=g.club_id,m.Update(g.club.item,g.user.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.update_experience=function(){var e=g.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),g.club.item.expiry_date=new Date(e),g.club.item.price=g.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(g.club_id,g.club.item.experience.id).then(function(e){g.discounts=e.items})},i.update_discount=function(){1==g.club.item.discount.discount_type?g.club.item.price=g.club.item.discount.price:g.club.item.price=g.club.item.experience.price-g.club.item.experience.price*(g.club.item.discount.percentage/100)},i.add_item=function(e){"plane"===e&&(g.temporary.plane&&""!==g.temporary.plane?(g.club.item.planes||(g.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(g.temporary.plane,g.club.item.planes,new Array("plane_id"))&&g.club.item.planes.push(g.temporary.plane),delete g.temporary.plane):f.warning("Missing Plane","Please select a plane that this activity be done on!"))},i.remove_item=function(e,t){g.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===b.indexOf(e.id)&&b.push(e.id)},i.remove_real_file=function(t){g.club.plane.plane_documents=$.grep(g.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(g.user.id,t.id).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,g.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){g.plane_documents=$.grep(g.plane_documents,function(e){return e.temp_path!=t.temp_path}),g.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(g.user.id,t.id).then(function(){g.club.items=$.grep(g.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubVouchersEditController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f){var g=this;g.user=null,g.allUsers=[],g.club={item:{}},g.page_title="",g.plane_document={},g.plane_documents=[];var b=[];g.action=r.current.data.action,g.club_id=n.globals.currentUser.current_club_admin.id,g.user=n.globals.currentUser,g.user_id=g.user.id,g.charge_type=["brakes","session","plane"],g.discounts=[],g.planes=[],g.show_paid=!0,p.GetByClubId(g.club_id).then(function(e){g.experiences=e.items}),m.GetById(a.id).then(function(e){e.item.expiry_date=new Date(e.item.expiry_date),g.club.item=e.item}),i.update_experience=function(){var e=g.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),g.club.item.expiry_date=new Date(e),g.club.item.price=g.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(g.club_id,g.club.item.experience.id).then(function(e){g.discounts=e.items})},i.update_discount=function(){1==g.club.item.discount.discount_type?g.club.item.price=g.club.item.discount.price:g.club.item.price=g.club.item.experience.price-g.club.item.experience.price*(g.club.item.discount.percentage/100)},i.check_code=function(){},i.back=function(){l.history.back()},g.clearFieldError=function(e){f.clearFieldError(e)},i.save=function(){var e=[{ok:g.club.item.experience&&g.club.item.experience.id,field:"voucher_experience",label:"Experience"},{ok:g.club.item.first_name,field:"first_name",label:"First Name"},{ok:g.club.item.last_name,field:"last_name",label:"Last Name"},{ok:g.club.item.email,field:"email",label:"Email Address"},{ok:g.club.item.code,field:"code",label:"Voucher Code"},{ok:g.club.item.expiry_date,field:"expiry_date",label:"Expiry Date"}];f.validateForm(e)&&("add"==g.action?i.create():i.update())},i.create=function(){return g.club.item.experience&&g.club.item.experience.id?g.club.item.first_name&&g.club.item.last_name&&g.club.item.email?!g.already_paid||g.club.item.price_paid&&g.club.item.payment_method?(g.club.item.experience_title=g.club.item.experience.title,g.club.item.experience_id=g.club.item.experience.id,g.club.item.discount_id=g.club.item.discount.id,g.club.item.club_id=g.club_id,void(g.already_paid?(e={payment_method:g.club.item.payment_method,amount:g.club.item.price_paid},g.club.item.payment=e,delete g.club.item.payment_method,delete g.club.item.price_paid,m.Create(g.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})):(e={name:document.getElementById("name").value,address_zip:document.getElementById("address-postcode").value},stripe.createToken(card,e).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={user_id:g.user.id,brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,exp_month:e.token.card.exp_month,exp_year:e.token.card.exp_year,funding:e.token.card.funding,name:e.token.card.name,address_postcode:e.token.card.address_zip,client_ip:e.token.client_ip},g.club.item.payment=e,delete g.club.item.experience,m.Create(g.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})}))})))):(f.warning("Payment Required","Please fill in how much was paid and what payment method was used to complete the payment."),!1):(f.warning("Missing Details","You must enter the purchasor's first name, last name and email address."),!1):(f.warning("Selection Required","You must select an experience to issue this voucher."),!1);var e},i.cancel=function(){m.CancelVoucher(g.user.id,g.club.item.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.delete=function(){f.warning("Confirm Delete","Are you sure you would like to delete this voucher?"),m.CancelVoucher(g.user.id,g.club.item).then(function(e){})},i.update=function(){g.club.item.club_id=g.club_id,m.Update(g.club.item,g.user.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.update_experience=function(){var e=g.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),g.club.item.expiry_date=new Date(e),g.club.item.price=g.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(g.club_id,g.club.item.experience.id).then(function(e){g.discounts=e.items})},i.update_discount=function(){1==g.club.item.discount.discount_type?g.club.item.price=g.club.item.discount.price:g.club.item.price=g.club.item.experience.price-g.club.item.experience.price*(g.club.item.discount.percentage/100)},i.add_item=function(e){"plane"===e&&(g.temporary.plane&&""!==g.temporary.plane?(g.club.item.planes||(g.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(g.temporary.plane,g.club.item.planes,new Array("plane_id"))&&g.club.item.planes.push(g.temporary.plane),delete g.temporary.plane):f.warning("Selection Required","Please select a plane that this activity be done on!"))},i.remove_item=function(e,t){g.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===b.indexOf(e.id)&&b.push(e.id)},i.remove_real_file=function(t){g.club.plane.plane_documents=$.grep(g.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(g.user.id,t.id).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(t))})};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(g.user.id,t.id).then(function(){g.club.items=$.grep(g.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardController(e,r,t,n,a,s,o,i){var c=this;if(!a.globals.currentUser&&0==o.CheckLoggedIn())return s.path("/login"),!1;function l(){t.GetTodayBookingsUser(c.user.id).then(function(e){c.bookings=e.bookings,c.to_pay=e.to_pay,c.to_complete_split=e.to_complete_split}),n.GetBookoutsToComplete(c.user.id).then(function(e){c.bookouts=e.bookouts})}c.user=a.globals.currentUser,c.bookings=[],c.bookouts=[],c.to_pay=[],c.to_complete_split=[],c.allUsers=[],c.clubs=[],c.force_show_admins=!1,(c.user&&c.user.access&&c.user.access.manager||c.user&&c.user.access&&c.user.access.instructor)&&(c.force_show_admins=!0),e.GetAdminClubs(c.user.id).then(function(e){if(e.success){c.clubs=e.clubs;var t=null;try{var n=localStorage.getItem("toaviate_selected_club_id");null!==n&&(t=n)}catch(e){}var o=null;if(null!==t)for(var i=0;i<c.clubs.length;i++)if(String(c.clubs[i].id)===String(t)){o=c.clubs[i];break}o=o||c.clubs[0],c.club=o,a.globals.currentUser.current_club_admin=o,r.put("globals",a.globals);try{localStorage.setItem("toaviate_selected_club_id",String(o.id))}catch(e){}}else s.path("/login")}),c.onClubSelected=function(e){c.club=e,a.globals.currentUser.current_club_admin=e,r.put("globals",a.globals);try{localStorage.setItem("toaviate_selected_club_id",String(e.id))}catch(e){}},l(),c.logout=function(){o.Logout(function(e){o.ClearCredentials(),r.remove("globals"),r.remove("session");try{localStorage.removeItem("toaviate_return_url")}catch(e){}s.path("/login")})},c.cancel_bookout=function(e){if(!confirm("Are you sure you wish to cancel the bookout?"))return!1;n.CancelBookout(e).then(function(e){e.success?l():i.error("Error",e.message)})},c.cancel_booking=function(e){if(!confirm("Are you sure you wish to cancel the booking?"))return!1;n.DeleteBooking(c.user.id,e).then(function(e){e.success?l():i.error("Error",e.message)})}}function DashboardCourseSyllabusController(e,t,n,o,i,r,a,s,c,l){var d=this;switch(d.user=null,d.allUsers=[],d.action=i.current.data.action,d.user=t.globals.currentUser,d.club_id=t.globals.currentUser&&t.globals.currentUser.current_club_admin&&t.globals.currentUser.current_club_admin.id?t.globals.currentUser.current_club_admin.id:0,d.user_id=d.user.id,d.exams=[],d.action){case"add":d.page_title="Add a New Course";break;case"view":l.GetCourseById(r.course_id).then(function(e){d.course=e.item}),l.GetExamsByCourseId(r.course_id).then(function(e){d.course.exams=e.items}),l.GetLessonsByCourseId(r.course_id).then(function(e){d.course.lessons=e.items});break;case"view_lesson":l.GetLessonById(r.lesson_id).then(function(e){d.lesson=e.item}),l.GetBulletsByLessonId(r.lesson_id).then(function(e){d.lesson.bullets=e.bullets}),l.GetTemByLessonId(r.lesson_id).then(function(e){d.lesson.tem=e.items}),l.GetItemsByLessonId(r.lesson_id).then(function(e){d.lesson.items=e.items});break;case"list":l.GetCoursesByClubId(d.club_id).then(function(e){d.courses=e.items});break;case"list_member":l.GetCoursesByUserId(d.user.id).then(function(e){d.clubs=e.items})}o.back=function(){c.history.back()}}function DashboardCourseSyllabusViewController(e,t,n,o,i,r,a,s,c,l){var d=this;switch(d.user=null,d.allUsers=[],d.action=i.current.data.action,d.user=t.globals.currentUser,d.club_id=t.globals.currentUser&&t.globals.currentUser.current_club_admin&&t.globals.currentUser.current_club_admin.id?t.globals.currentUser.current_club_admin.id:0,d.user_id=d.user.id,d.exams=[],d.course={exams:[],lessons:[]},d.lesson={tem:[],bullets:{},items:[]},d.contentFiles=[],d.contentFilesLoading=!0,d.activeContentFile=null,d.action){case"add":d.page_title="Add a New Course";break;case"view":d.course_id=r.course_id,l.GetCourseById(r.course_id).then(function(e){d.course=e.item,l.GetExamsByCourseId(r.course_id).then(function(e){d.course.exams=e.items}),l.GetLessonsByCourseId(r.course_id).then(function(e){d.course.lessons=e.items})});break;case"view_lesson":d.course_id=r.course_id,l.GetLessonById(r.lesson_id).then(function(e){d.lesson=e.item,l.GetBulletsByLessonId(r.lesson_id).then(function(e){d.lesson.bullets=e.bullets}),l.GetTemByLessonId(r.lesson_id).then(function(e){d.lesson.tem=e.items}),l.GetItemsByLessonId(r.lesson_id).then(function(e){d.lesson.items=e.items}),e=r.lesson_id,d.contentFilesLoading=!0,d.contentFiles=[],d.activeContentFile=null,l.GetLessonContentFiles(e).then(function(e){e&&e.items&&0<e.items.length?(d.contentFiles=e.items,angular.forEach(d.contentFiles,function(t){t._loading=!0,t.data_uri=null,l.GetLessonContentFileData(t.id).then(function(e){e&&e.success&&(t.data_uri=e.data_uri,t.file_base64=e.file),t._loading=!1,!d.activeContentFile&&t.data_uri&&(d.activeContentFile=t)}).catch(function(){t._loading=!1,t._loadError=!0})})):d.contentFiles=[],d.contentFilesLoading=!1}).catch(function(){d.contentFiles=[],d.contentFilesLoading=!1})});break;case"list":l.GetCoursesByClubId(d.club_id).then(function(e){d.courses=e.items})}d.selectContentFile=function(e){e&&e.data_uri&&(d.activeContentFile=e)},d.hasContentFiles=function(){return d.contentFiles&&0<d.contentFiles.length},d.hasSectionContent=function(e){if(!d.lesson)return!1;switch(e){case"tem":return d.lesson.tem&&0<d.lesson.tem.length;case"preflight":return d.lesson.bullets&&d.lesson.bullets.preflight&&0<d.lesson.bullets.preflight.length;case"airex":return d.lesson.bullets&&d.lesson.bullets.airex&&0<d.lesson.bullets.airex.length;case"debrief":return d.lesson.bullets&&d.lesson.bullets.debrief&&0<d.lesson.bullets.debrief.length;case"items":return d.lesson.items&&0<d.lesson.items.length;default:return!1}},o.back=function(){c.history.back()}}function DashboardInstructorBriefController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;switch(_.user=null,_.allUsers=[],_.action=i.current.data.action,_.user=t.globals.currentUser,_.club_id=t.globals.currentUser.current_club_instructor,_.user_id=_.user.id,_.exams=[],_.action){case"add":_.page_title="Add a New Course";break;case"view":l.GetCourseById(r.course_id).then(function(e){_.course=e.item,l.GetExamsByCourseId(r.course_id).then(function(e){_.course.exams=e.items}),l.GetLessonsByCourseId(r.course_id).then(function(e){_.course.lessons=e.items}),l.GetTagsByCourseId(r.course_id).then(function(e){_.all_tags=e.items})});break;case"view_lesson":_.selected_lesson=r.lesson_id,p();break;case"list":d.GetBookingsToBrief(_.user.id).then(function(e){_.briefings=e.briefings});break;case"debrief_list":d.GetBookingsToDebrief(_.user.id).then(function(e){_.briefings=e.briefings});break;case"debrief":_.plane_log_sheet_id=r.plane_log_sheet_id,_.booking_id=r.booking_id,_.show_split=0,r.split_next_id&&0<r.split_next_id&&(_.split_next_id=r.split_next_id,_.show_split=1),r.split_booking_id&&0<r.split_booking_id&&(_.split_booking_id=r.split_booking_id,_.show_split=1),0<_.plane_log_sheet_id?d.GetForForDebriefPls(_.plane_log_sheet_id).then(function(e){e.success?(_.competences=e.competences,_.course_id=e.course_id,_.record_club_id=e.club_id,_.lesson=e.lesson,_.all_items=e.all_items,_.my_search=_.lesson.id,_.student=e.student,_.instructor=e.instructor,_.plane_log_sheet=e.log_sheet,_.lesson&&_.lesson.id&&m(_.lesson.id),l.GetLessonsByCourseId(_.course_id).then(function(e){_.all_lessons=e.items;for(var t=0;t<_.all_lessons.length;t++)if(String(_.all_lessons[t].id)===String(_.lesson.id)){_.selected_debrief_lesson_obj=_.all_lessons[t];break}}),l.GetTagsByCourseId(_.course_id).then(function(e){_.all_tags=e.items,_.selected_flight_tags=[]})):u.error("Load Failed","We could not obtain the debriefing information for you...")}):d.GetForForDebrief(_.booking_id).then(function(e){e.success?(_.competences=e.competences,_.course_id=e.course_id,_.record_club_id=e.club_id,_.lesson=e.lesson,_.all_items=e.all_items,_.my_search=_.lesson.id,_.student=e.student,_.instructor=e.instructor,_.plane_log_sheet=e.log_sheet,_.lesson&&_.lesson.id&&m(_.lesson.id),l.GetLessonsByCourseId(_.course_id).then(function(e){_.all_lessons=e.items;for(var t=0;t<_.all_lessons.length;t++)if(String(_.all_lessons[t].id)===String(_.lesson.id)){_.selected_debrief_lesson_obj=_.all_lessons[t];break}}),l.GetTagsByCourseId(_.course_id).then(function(e){_.all_tags=e.items,_.selected_flight_tags=[]})):u.error("Load Failed","We could not obtain the debriefing information for you...")}),_.show_whole_lesson=!0}function p(){_.booking_id=r.booking_id,l.GetLessonById(_.selected_lesson).then(function(e){e.success&&(_.lesson=e.item,l.GetLessonsByCourseId(e.item.course_id).then(function(e){_.all_lessons=e.items;for(var t=0;t<_.all_lessons.length;t++)if(String(_.all_lessons[t].id)===String(_.selected_lesson)){_.selected_lesson_obj=_.all_lessons[t];break}}),l.GetBulletsByLessonId(_.selected_lesson).then(function(e){_.lesson.bullets=e.bullets}),l.GetTemByLessonId(_.selected_lesson).then(function(e){_.lesson.tem=e.items}),l.GetItemsByLessonId(_.selected_lesson).then(function(e){_.lesson.items=e.items}),m(_.selected_lesson))})}function m(e){_.contentFilesLoading=!0,_.contentFiles=[],_.activeContentFile=null,l.GetLessonContentFiles(e).then(function(e){e&&e.items&&0<e.items.length?(_.contentFiles=e.items,angular.forEach(_.contentFiles,function(t){t._loading=!0,t.data_uri=null,l.GetLessonContentFileData(t.id).then(function(e){e&&e.success&&(t.data_uri=e.data_uri,t.file_base64=e.file),t._loading=!1,!_.activeContentFile&&t.data_uri&&(_.activeContentFile=t)}).catch(function(){t._loading=!1,t._loadError=!0})})):_.contentFiles=[],_.contentFilesLoading=!1}).catch(function(){_.contentFiles=[],_.contentFilesLoading=!1})}_.show_all_lessons=!1,_.tag_full_flight=!0,_.update_flight_tag=function(){_.tag_full_flight=!0},_.update_flight_full_flight=function(){5*Math.round(_.tag_flight_time/5)>60*_.plane_log_sheet.brakes_times_rounded&&(_.tag_flight_time=60*_.plane_log_sheet.brakes_times_rounded,_.tag_flight_time=5*Math.round(_.tag_flight_time/5)),5*Math.round(_.tag_flight_time/5)==0&&(_.tag_flight_time=5),_.tag_full_flight&&(_.tag_flight_time=60*_.plane_log_sheet.brakes_times_rounded,_.tag_flight_time=5*Math.round(_.tag_flight_time/5))},_.show_whole_course=function(){_.show_all_lessons=!_.show_all_lessons,_.show_all_lessons?_.my_search="":_.my_search=_.lesson.id,_.my_search2=""},_.set_updated_search=function(){_.show_all_lessons||1<_.my_search2.length?_.my_search=_.my_search2:_.my_search=_.lesson.id},_.save_progress=function(){for(var e=[],t=0;t<_.all_items.length;t++)(_.all_items[t].result&&0<_.all_items[t].result||_.all_items[t].remarks&&""!==_.all_items[t].result)&&e.push(_.all_items[t]);if(e.length<1&&(!_.general_remarks||""==_.general_remarks))return u.warning("Validation","To save student records, you need to tick at least one student progress record item OR add a general remark"),!1;var n=_.lesson.id;1==_.lesson_completed&&_.next_lesson&&0<_.next_lesson.id&&(n=_.next_lesson.id),_.compiled_save={club_id:_.record_club_id,items:e,general_remarks:_.general_remarks,lesson_id:_.lesson.id,course_id:_.course_id,user_id:_.student.id,instructor_id:_.instructor.id,completed_by:_.user.id,plane_log_sheet_id:_.plane_log_sheet.id,next_lesson_id:n,completed:_.lesson_completed?1:0,booking_id:_.booking_id,flight_tags:_.selected_flight_tags},l.CreateTrainingRecord(_.compiled_save).then(function(e){e.success?(u.success("Records Saved","Thank you!"),_.show_split&&_.split_next_id&&0<_.split_next_id?i.go("dashboard.my_account.book_in",{id:_.split_next_id}):i.go("dashboard.manage_user",{reload:!0})):u.error("Save Failed","We could not save your training records...")})},_.tag_flight_time=0,_.add_tag=function(){if(_.selected_flight_tags.find(function(e){return e.id===_.flight_tag.id}))return u.warning("Duplicate Tag","You already have this tag on this flight!"),!1;5*Math.round(_.tag_flight_time/5)>60*_.plane_log_sheet.brakes_times_rounded&&(_.tag_flight_time=60*_.plane_log_sheet.brakes_times_rounded,_.tag_flight_time=5*Math.round(_.tag_flight_time/5)),5*Math.round(_.tag_flight_time/5)==0&&(_.tag_flight_time=5),_.tag_full_flight&&(_.tag_flight_time=60*_.plane_log_sheet.brakes_times_rounded,_.tag_flight_time=5*Math.round(_.tag_flight_time/5)),_.flight_tag.logging_time=_.tag_flight_time,_.selected_flight_tags.push(_.flight_tag),_.flight_tag="",_.tag_flight_time=60*_.plane_log_sheet.brakes_times_rounded,_.tag_flight_time=5*Math.round(_.tag_flight_time/5),_.tag_full_flight=!0},_.delete_tag=function(e,t){_.selected_flight_tags.splice(t,1)},_.tag_time_to_five=function(){_.tag_flight_time%5!=0&&(_.tag_flight_time=5*Math.round(_.tag_flight_time/5))},_.save_edit_record=function(){for(var e=[],t=0;t<_.all_items.length;t++)(_.all_items[t].result&&0<_.all_items[t].result||_.all_items[t].remarks&&""!==_.all_items[t].result)&&e.push(_.all_items[t]);if(e.length<1&&(!_.general_remarks||""==_.general_remarks))return u.warning("Validation","To save student records, you need to tick at least one student progress record item OR add a general remark"),!1;var n=_.lesson.id;1==_.lesson_completed&&_.next_lesson&&0<_.next_lesson.id&&(n=_.next_lesson.id),_.compiled_save={club_id:_.record_club_id,items:e,general_remarks:_.general_remarks,lesson_id:_.lesson.id,course_id:_.course_id,user_id:_.student.id,instructor_id:_.instructor.id,completed_by:_.user.id,plane_log_sheet_id:_.plane_log_sheet.id,next_lesson_id:n,completed:_.lesson_completed?1:0,booking_id:_.booking_id,flight_tags:_.selected_flight_tags}},_.lesson={},_.selected_lesson_obj=null,_.selected_debrief_lesson_obj=null,_.pending_debrief_lesson_obj=null,_.show_lesson_switcher=!1,_.contentFiles=[],_.contentFilesLoading=!0,_.activeContentFile=null,_.change_lesson=function(){_.selected_lesson_obj&&(_.selected_lesson=_.selected_lesson_obj.id,p())},_.confirm_debrief_lesson_change=function(){_.pending_debrief_lesson_obj&&(_.selected_debrief_lesson_obj=_.pending_debrief_lesson_obj,_.pending_debrief_lesson_obj=null,_.show_lesson_switcher=!1,_.change_debrief_lesson())},_.cancel_debrief_lesson_change=function(){_.pending_debrief_lesson_obj=null,_.show_lesson_switcher=!1},_.change_debrief_lesson=function(){var t;_.selected_debrief_lesson_obj&&(t=_.selected_debrief_lesson_obj.id,l.GetLessonById(t).then(function(e){e.success&&(_.lesson=e.item,_.my_search=_.lesson.id,l.GetBulletsByLessonId(t).then(function(e){_.lesson.bullets=e.bullets}),l.GetTemByLessonId(t).then(function(e){_.lesson.tem=e.items}),l.GetItemsByLessonId(t).then(function(e){_.lesson.items=e.items,e.items&&0<e.items.length&&angular.forEach(e.items,function(t){_.all_items.some(function(e){return String(e.id)===String(t.id)})||_.all_items.push(t)})}),m(t))}))},_.go_book_out=function(){_.booking_id;d.SetBookingToBriefed(_.booking_id).then(function(e){e.success?i.go("dashboard.my_account.bookout_with_booking",{booking_id:_.booking_id,lesson_id:_.selected_lesson}):u.error("Briefing Error","Could not complete the briefing!")})},o.back=function(){c.history.back()},_.selectContentFile=function(e){e&&e.data_uri&&(_.activeContentFile=e)},_.hasContentFiles=function(){return _.contentFiles&&0<_.contentFiles.length},_.hasSectionContent=function(e){if(!_.lesson)return!1;switch(e){case"tem":return _.lesson.tem&&0<_.lesson.tem.length;case"preflight":return _.lesson.bullets&&_.lesson.bullets.preflight&&0<_.lesson.bullets.preflight.length;case"airex":return _.lesson.bullets&&_.lesson.bullets.airex&&0<_.lesson.bullets.airex.length;case"debrief":return _.lesson.bullets&&_.lesson.bullets.debrief&&0<_.lesson.bullets.debrief.length;case"items":return _.lesson.items&&0<_.lesson.items.length;default:return!1}}}function DashboardStudentRecordsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;switch(f.user=null,f.allUsers=[],f.action=r.current.data.action,f.user=n.globals.currentUser,f.user_id=f.user.id,f.club_id=null,f.instructor_clubs=[],f.selected_club=null,f.exams=[],f.action){case"student_records":t.GetAdminClubs(f.user_id).then(function(e){if(e.success&&e.clubs&&0<e.clubs.length){f.instructor_clubs=e.clubs;var t=null;try{var n=localStorage.getItem("toaviate_instructor_selected_club_id");null!==n&&(t=n)}catch(e){}var o=null;if(null!==t)for(var i=0;i<f.instructor_clubs.length;i++)if(String(f.instructor_clubs[i].id)===String(t)){o=f.instructor_clubs[i];break}o=o||f.instructor_clubs[0],f.selected_club=o,f.club_id=o.id,g(f.club_id)}else m.error("Access Error","You do not appear to be an instructor at any club.")});break;case"student_record":f.student_id=f.user_id,e.GetAllForUser(f.user_id).then(function(e){f.clubs=e.clubs,f.clubs.length<2&&0<f.clubs.length&&(f.club_id=f.clubs[0].id,f.update_club_selector())})}function g(e){f.members=[],f.courses=[],_.GetAllByClubStudents(e).then(function(e){f.courses=e.courses,f.members=e.members})}function b(e,t,n){var o=n.toLowerCase(),t=(t=e+" "+t).toLowerCase();return 2<n.length&&-1<t.indexOf(o)}function h(e,t,n){t=t.toLowerCase(),n=n.toLowerCase(),e=e.toLowerCase();return 2<e.length&&-1<t.indexOf(e)||2<e.length&&-1<n.indexOf(e)}f.show_record=!1,f.show_add_exam=!1,f.onInstructorClubSelected=function(e){f.selected_club=e,f.club_id=e.id;try{localStorage.setItem("toaviate_instructor_selected_club_id",String(e.id))}catch(e){}f.member=null,f.course=null,f.show_record=!1,g(f.club_id)},f.update_club_selector=function(){f.selected_club&&f.selected_club.id&&(f.club_id=f.selected_club.id),d.GetCoursesByClubId(f.club_id).then(function(e){f.courses=e.items})},f.load_records=function(){f.member&&f.course?(f.student_id=f.member.user_id,f.course_id=f.course.id,d.GetStudentTrainingRecords(f.student_id,f.course_id).then(function(e){f.show_record=!0,f.all_items=e.all_items,f.student=e.student,f.training_records=e.training_records,f.exams=e.exams,f.exam_records=e.exam_records,f.course_totals=e.course_hours,f.log_sheets=e.log_sheets})):m.warning("Selection Required","You need to select a member and a course to see their training records")},f.get_initial=function(e){return e.charAt(0)},f.list_pilots=function(e){var t="",n="",t="PIC: "+f.get_pic(e),n=f.get_put(e);return p.getTrustedHtml("<div>"+(t=t&&""==t?"No PIC set yet!":t)+" "+(n=n&&""!==n?"<br />PUT: "+n:n)+"</div>")},f.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=f.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=f.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=f.get_initial(e.first_name)+". "+e.last_name),t},f.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=f.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=f.get_initial(e.first_name)+". "+e.last_name),t},f.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},f.clean_times=function(e){return e.substring(0,5)},f.search3=function(e){return!f.my_search3||""==f.my_search3||(!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(f.my_search3,e.flight_date)||(!!b(e.first_name,e.last_name,f.my_search3)||(!!b(e.pic_first_name,e.pic_last_name,f.my_search3)||(!!b(e.instructor_first_name,e.instructor_last_name,f.my_search3)||(t=e.registration,n=f.my_search3,o=n.toLowerCase().replace("-",""),t=(t=t.replace("-","")).toLowerCase(),2<n.length&&-1<t.indexOf(o)||(!!h(f.my_search3,e.departure_airport,e.departure_airport_code)||!!h(f.my_search3,e.destination_airport,e.destination_airport_code)))))));var t,n,o},f.load_records_user=function(){f.course?(f.course_id=f.course.id,d.GetStudentTrainingRecords(f.student_id,f.course_id).then(function(e){f.show_record=!0,f.all_items=e.all_items,f.student=e.student,f.training_records=e.training_records,f.exams=e.exams,f.exam_records=e.exam_records,f.course_totals=e.course_hours,f.log_sheets=e.log_sheets})):m.warning("Selection Required","You need to select a course to see your training records")},f.load_selected_flight=function(e){},f.add_exam_record=function(){f.new_exam.user_id=f.student_id,f.new_exam.course_id=f.course_id,d.CreateExamRecord(f.new_exam).then(function(e){e.success?(f.load_records(),f.show_add_exam=!1):m.error("Exam Error","The exam could not be added")})},f.get_remarks=function(t,e){e=e.items.find(function(e){return e.lesson_item_id===t});return e?e.remarks:""},f.get_result=function(t,e){e=e.items.find(function(e){return e.lesson_item_id===t});return e?e.grade_name:""},f.get_result3=function(t){var e=record.items.find(function(e){return e.lesson_item_id===t});return e?e.grade_name:""},f.get_competence=function(t,e){var n=e.items.find(function(e){return e.lesson_item_id===t}),e="";return n&&n.grade_colour&&n.grade_name&&(p.getTrustedHtml('<span style="color: '+n.grade_colour+'" ><i class="fa fa-'+n.grade_icon+'" style="color: '+n.grade_colour+'"></i></span>'),e=p.trustAsHtml('<span style="color: '+n.grade_colour+'" ><i class="fa fa-'+n.grade_icon+'" style="color: '+n.grade_colour+'"></i></span>')),n?e:""},f.get_competence2=function(e){var t="";return e&&e.grade_colour&&e.grade_name&&(p.getTrustedHtml('<span style="color: '+e.grade_colour+'" ><i class="fa fa-'+e.grade_icon+'" style="color: '+e.grade_colour+'"></i></span>'),t=p.trustAsHtml('<span style="color: '+e.grade_colour+'" ><i class="fa fa-'+e.grade_icon+'" style="color: '+e.grade_colour+'"></i></span>')),e?t:""},f.get_flight_date=function(t,e){e=e.items.find(function(e){return e.lesson_item_id===t});return e?e.flight_date:""},f.user_can_edit=!1,f.get_record_details=function(t,e){var n=e.items.find(function(e){return e.lesson_item_id===t});if(n){e="<h4>Training Record Details</h4><table class='inner_overlay_tble'>";return n.flight_date&&""!==n.flight_date&&(e+="<tr><td>Flight Date:</td><td>"+n.flight_date+"</td></tr>"),0<n.instructor_id&&""!==n.instructor_first_name&&(e+="<tr><td><span class='instructor'>Instructor:</span></td><td>"+f.get_initial(n.instructor_first_name)+" "+n.instructor_last_name+"</td></tr>"),0<n.completed_by&&""!==n.completed_by_first_name&&n.completed_by!==n.instructor_id&&(e+="<tr><td><span class='instructor'>Record By:</span></td><td>"+f.get_initial(n.completed_by_first_name)+" "+n.completed_by_last_name+"</td></tr>"),n.remarks&&""!==n.remarks&&(e+="<tr><td><span class='instructor'>Remarks:</td><td></td></tr><tr><td colspan='2'>"+n.remarks+"</td> </tr>"),e&&""!==e&&(e+="</table>"),p.getTrustedHtml(e)}return" "},f.get_record_details2=function(e){if(e){var t="<h4>Training Record Details</h4><table class='inner_overlay_tble'>";return e.flight_date&&""!==e.flight_date&&(t+="<tr><td>Flight Date:</td><td>"+e.flight_date+"</td></tr>"),e.registration&&""!==e.registration&&(t+="<tr><td>Aircraft:</td><td>"+e.registration+"</td></tr>",t+="<tr><td>Type:</td><td>"+e.plane_type+"</td></tr>"),0<e.instructor_id&&""!==e.instructor_first_name&&(t+="<tr><td><span class='instructor'>Instructor:</span></td><td>"+f.get_initial(e.instructor_first_name)+" "+e.instructor_last_name+"</td></tr>"),0<e.completed_by&&""!==e.completed_by_first_name&&e.completed_by!==e.instructor_id&&(t+="<tr><td><span class='instructor'>Record By:</span></td><td>"+f.get_initial(e.completed_by_first_name)+" "+e.completed_by_last_name+"</td></tr>"),e.remarks&&""!==e.remarks&&(t+="<tr><td><span class='instructor'>Remarks:</td><td></td></tr><tr><td colspan='2'>"+e.remarks+"</td> </tr>"),t&&""!==t&&(t+="</table>"),p.getTrustedHtml(t)}return"This objective has not yet been marked as complete by your instructor"},f.get_exam=function(t){var e=f.exam_records.find(function(e){return e.exam_id===t});return e||""},f.open_training_detail=function(e,t){f.show_popup=!0,show_edit_training_record=!1,f.show_popup_name="see_records",f.flight_detail_id=e,f.user_can_edit=f.user_can_edit_record(),f.selected_flight=t,f.selected_record={},f.selected_record_remarks="",d.GetStudentTrainingRecordsForFlight(f.student_id,f.course_id,f.flight_detail_id).then(function(e){f.competences=e.competences,f.selected_record=e.all_items,f.selected_record_remarks=e.general_remarks,f.this_entry=e.this_entry})},f.close_popup=function(){f.show_popup=!1,f.show_edit_training_record=!1,f.selected_record={},f.selected_record_remarks="",f.this_entry={}},i.back=function(){l.history.back()},f.set_updated_search=function(){f.show_all_lessons||1<f.my_search2.length?f.my_search=f.my_search2:f.my_search=f.lesson.id},f.all_tags=[],f.show_edit_training_record=!1,f.show_edit_record=function(){f.show_edit_training_record=!0,f.lesson=f.selected_record,f.plane_log_sheet=f.selected_flight,d.GetTagsByCourseId(f.course_id).then(function(e){for(var t=0;t<e.items.length;t++)e.items.flight_tag_id=e.items.id;f.all_tags=e.items}),f.selected_flight_tags=f.plane_log_sheet.flight_tags;for(var e=0;e<f.selected_flight_tags.length;e++)f.selected_flight_tags[e].logging_time=5*Math.round(60*f.selected_flight_tags[e].tag_time/5);d.GetExamsByCourseId(f.course_id).then(function(e){f.course.exams=e.items}),d.GetLessonsByCourseId(f.course_id).then(function(e){f.course.lessons=e.items}),f.is_lesson_completed=1==f.this_entry.completed},f.tag_flight_time=0,f.add_tag=function(){if(f.selected_flight_tags.find(function(e){return e.flight_tag_id===f.flight_tag.id}))return m.warning("Duplicate Tag","You already have this tag on this flight!"),!1;f.flight_tag.flight_tag_id=f.flight_tag.id,5*Math.round(f.tag_flight_time/5)>60*f.plane_log_sheet.brakes_times_rounded&&(f.tag_flight_time=60*f.plane_log_sheet.brakes_times_rounded,f.tag_flight_time=5*Math.round(f.tag_flight_time/5)),5*Math.round(f.tag_flight_time/5)==0&&(f.tag_flight_time=5),f.tag_full_flight&&(f.tag_flight_time=60*f.plane_log_sheet.brakes_times_rounded,f.tag_flight_time=5*Math.round(f.tag_flight_time/5)),f.flight_tag.logging_time=f.tag_flight_time,f.selected_flight_tags.push(f.flight_tag),f.flight_tag="",f.tag_flight_time=60*f.plane_log_sheet.brakes_times_rounded,f.tag_flight_time=5*Math.round(f.tag_flight_time/5),f.tag_full_flight=!0},f.delete_tag=function(e,t){f.selected_flight_tags.splice(t,1)},f.tag_time_to_five=function(){f.tag_flight_time%5!=0&&(f.tag_flight_time=5*Math.round(f.tag_flight_time/5))},f.save_edit_record=function(){for(var e,t=[],n=0;n<f.selected_record.length;n++)f.selected_record[n].this_entry&&(f.selected_record[n].this_entry.result||f.selected_record[n].this_entry.remarks)&&(-1<f.selected_record[n].this_entry.result||""!==f.selected_record[n].this_entry.remarks)&&(e={remarks:f.selected_record[n].this_entry.remarks,result:f.selected_record[n].this_entry.result,lesson_item_id:f.selected_record[n].id},t.push(e));if(t.length<1&&(!f.general_remarks||""==f.general_remarks))return m.warning("Validation","To save student records, you need to tick at least one student progress record item OR add a general remark"),!1;var o=f.this_entry.next_lesson_id;1==f.lesson_completed&&f.next_lesson&&0<f.next_lesson.id&&(o=f.next_lesson.id),f.compiled_save={update_record_id:f.this_entry.id,club_id:f.this_entry.club_id,items:t,general_remarks:f.this_entry.general_remarks,lesson_id:f.this_entry.lesson_id,course_id:f.this_entry.course_id,user_id:f.this_entry.user_id,instructor_id:f.this_entry.instructor_id,completed_by:f.this_entry.completed_by,plane_log_sheet_id:f.selected_flight.id,next_lesson_id:o,edited_by:f.user.id,completed:f.lesson_completed?1:0,flight_tags:f.selected_flight_tags,edit_reason:f.edit_reason},d.UpdateTrainingRecord(f.compiled_save,f.this_entry.id).then(function(e){e.success?(m.success("Records Saved","Thank you!"),d.GetStudentTrainingRecords(f.student_id,f.course_id).then(function(e){f.show_record=!0,f.all_items=e.all_items,f.student=e.student,f.training_records=e.training_records,f.exams=e.exams,f.exam_records=e.exam_records,f.course_totals=e.course_hours,f.log_sheets=e.log_sheets}),f.show_edit_training_record=!1,f.close_popup(),f.lesson={},f.plane_log_sheet={},f.compiled_save={},f.this_entry={}):m.error("Save Failed","We could not save your training records...")})},f.tag_full_flight=!0,f.update_flight_tag=function(){f.tag_full_flight=!0},f.update_flight_full_flight=function(){5*Math.round(f.tag_flight_time/5)>60*f.plane_log_sheet.brakes_times_rounded&&(f.tag_flight_time=60*f.plane_log_sheet.brakes_times_rounded,f.tag_flight_time=5*Math.round(f.tag_flight_time/5)),5*Math.round(f.tag_flight_time/5)==0&&(f.tag_flight_time=5),f.tag_full_flight&&(f.tag_flight_time=60*f.plane_log_sheet.brakes_times_rounded,f.tag_flight_time=5*Math.round(f.tag_flight_time/5))},f.user_can_edit_record=function(){var e=!!f.user.access.manager.find(function(e){return e===f.training_records.club_id});return f.training_records.instructor_id==f.user_id||(f.user_id,f.training_records.completed_by),!0}}function DashboardUserInstructorController(e,r,t,n,o,i,a,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={},m.page_title="",m.club.member={},m.imported_new_headers=[],m.action=c.current.data.action,m.user=i.globals.currentUser,m.user_id=m.user.id,m.no_show_cols=["membership_start","membership_id","selected"],s.sortType="Email",s.sortReverse=!1,s.searchTool="",s.mytime=new Date,s.hstep=1,s.mstep=15,m.days=[{day:"Monday",from_variable:"monday_from_time",to_variable:"monday_to_time",disabled_variable:"monday_disabled"},{day:"Tuesday",from_variable:"tuesday_from_time",to_variable:"tuesday_to_time",disabled_variable:"tuesday_disabled"},{day:"Wednesday",from_variable:"wednesday_from_time",to_variable:"wednesday_to_time",disabled_variable:"wednesday_disabled"},{day:"Thursday",from_variable:"thursday_from_time",to_variable:"thursday_to_time",disabled_variable:"thursday_disabled"},{day:"Friday",from_variable:"friday_from_time",to_variable:"friday_to_time",disabled_variable:"friday_disabled"},{day:"Saturday",from_variable:"saturday_from_time",to_variable:"saturday_to_time",disabled_variable:"saturday_disabled"},{day:"Sunday",from_variable:"sunday_from_time",to_variable:"sunday_to_time",disabled_variable:"sunday_disabled"}];var f=new Date;f.setHours(9),f.setMinutes(0);var g=moment.utc("2021-01-01T18:15:00Z").toISOString();switch(t.GetAvailability(m.user.id).then(function(e){m.available_times=e;for(var t=0;t<m.available_times.length;t++)m.available_times[t].monday_from_time==m.available_times[t].monday_to_time&&(m.available_times[t].monday_from_time=f,m.available_times[t].monday_to_time=g),m.available_times[t].tuesday_from_time==m.available_times[t].tuesday_to_time&&(m.available_times[t].tuesday_from_time=f,m.available_times[t].tuesday_to_time=g),m.available_times[t].wednesday_from_time==m.available_times[t].wednesday_to_time&&(m.available_times[t].wednesday_from_time=f,m.available_times[t].wednesday_to_time=g),m.available_times[t].thursday_from_time==m.available_times[t].thursday_to_time&&(m.available_times[t].thursday_from_time=f,m.available_times[t].thursday_to_time=g),m.available_times[t].friday_from_time==m.available_times[t].friday_to_time&&(m.available_times[t].friday_from_time=f,m.available_times[t].friday_to_time=g),m.available_times[t].saturday_from_time==m.available_times[t].saturday_to_time&&(m.available_times[t].saturday_from_time=f,m.available_times[t].saturday_to_time=g),m.available_times[t].sunday_from_time==m.available_times[t].sunday_to_time&&(m.available_times[t].sunday_from_time=f,m.available_times[t].sunday_to_time=g),m.available_times[t].monday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].monday_from_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].monday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].monday_to_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].monday_disabled=parseInt(m.available_times[t].monday_disabled),m.available_times[t].tuesday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].tuesday_from_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].tuesday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].tuesday_to_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].tuesday_disabled=parseInt(m.available_times[t].tuesday_disabled),m.available_times[t].wednesday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].wednesday_from_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].wednesday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].wednesday_to_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].wednesday_disabled=parseInt(m.available_times[t].wednesday_disabled),m.available_times[t].thursday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].thursday_from_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].thursday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].thursday_to_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].thursday_disabled=parseInt(m.available_times[t].thursday_disabled),m.available_times[t].friday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].friday_from_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].friday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].friday_to_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].friday_disabled=parseInt(m.available_times[t].friday_disabled),m.available_times[t].saturday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].saturday_from_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].saturday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].saturday_to_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].saturday_disabled=parseInt(m.available_times[t].saturday_disabled),m.available_times[t].sunday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].sunday_from_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].sunday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+m.available_times[t].sunday_to_time+"Z").setZone("UTC").toHTTP()),m.available_times[t].sunday_disabled=parseInt(m.available_times[t].sunday_disabled);1==m.available_times.length&&(m.available_times[0].monday_from_time==m.available_times[0].monday_to_time&&(m.available_times[0].monday_from_time=f,m.available_times[0].monday_to_time=g),m.available_times[0].tuesday_from_time==m.available_times[0].tuesday_to_time&&(m.available_times[0].tuesday_from_time=f,m.available_times[0].tuesday_to_time=g),m.available_times[0].wednesday_from_time==m.available_times[0].wednesday_to_time&&(m.available_times[0].wednesday_from_time=f,m.available_times[0].wednesday_to_time=g),m.available_times[0].thursday_from_time==m.available_times[0].thursday_to_time&&(m.available_times[0].thursday_from_time=f,m.available_times[0].thursday_to_time=g),m.available_times[0].friday_from_time==m.available_times[0].friday_to_time&&(m.available_times[0].friday_from_time=f,m.available_times[0].friday_to_time=g),m.available_times[0].saturday_from_time==m.available_times[0].saturday_to_time&&(m.available_times[0].saturday_from_time=f,m.available_times[0].saturday_to_time=g),m.available_times[0].sunday_from_time==m.available_times[0].sunday_to_time&&(m.available_times[0].sunday_from_time=f,m.available_times[0].sunday_to_time=g),m.selected_club=m.available_times[0],m.selected_now=$.grep(m.available_times,function(e){return e.club_id==m.selected_club.club_id}),m.available_time=m.selected_now[0])}),s.ismeridian=!1,s.toggleMode=function(){s.ismeridian=!s.ismeridian},s.update_time=function(e){var t=new Date;t.setHours(14),t.setMinutes(0),m.available_time[e]=t},s.changed_time=function(e){},s.disable_time=function(e){m.available_time[e]=!m.available_time[e]},s.change_club=function(){m.selected_now=$.grep(m.available_times,function(e){return e.club_id==m.selected_club.club_id}),m.available_time=m.selected_now[0]},s.save_club_times=function(){t.SetAvailability(m.available_time).then(function(e){}),m.available_times=$.grep(m.available_times,function(e){return e.club_id!=m.available_time.club_id}),m.available_times.push(m.available_time),c.go("dashboard.manage_user.instructor_availability")},m.action){case"add":m.page_title="Add a New member";break;case"edit":r.GetMemberPlanes(l.member_id,m.club_id).then(function(e){m.club.planes=e}),r.GetById(l.member_id,m.club_id).then(function(e){m.club.member=e,m.club.member.is_manager=1==m.club.member.is_manager,m.club.member.approved=1==m.club.member.approved,m.club.member.instructor=1==m.club.member.instructor,m.club.member.membership_start=Date.parse(m.club.member.membership_start),m.page_title="Edit a Member - "+m.club.member.first_name+" "+m.club.member.last_name,m.club.member.membership_start=new Date(m.club.member.membership_start)}),n.GetAllByClub(m.club_id).then(function(e){m.club.memberships=e});break;case"list":r.GetAllByClub(m.club_id).then(function(e){m.club.members=e}),n.GetAllByClub(m.club_id).then(function(e){m.club.memberships=e}),s.checkAll=function(){s.selectedAll?s.selectedAll=!0:s.selectedAll=!1,angular.forEach(m.club.members,function(e){e.selected=s.selectedAll})}}s.back=function(){_.history.back()},s.save=function(){"add"==m.action?s.create():s.update()},s.csvToJSON=function(e){var t=e.csv.split(/\r\n|\n/),n=[],o=0;t[0]+=",membership_id,membership_start,selected";for(var i=1;i<t.length;i++)t[i]+=",membership_id,membership_start,true";var r=t[0].split(e.separator).length,a=[];e.header&&(a=t[0].split(e.separator),m.imported_headers=a,o=1);for(var s=o;s<t.length;s++){var c={},l=t[s].split(new RegExp(e.separator+'(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)'));if(l.length===r){if(e.header)for(i=0;i<a.length;i++)c[a[i]]=l[i];else for(var d=0;d<l.length;d++)c[d]=l[d];n.push(c)}}return n},s.processData=function(){allText=m.import_users;var e={csv:m.import_users,separator:",",header:!0};m.imported_users=s.csvToJSON(e);for(var t=0;t<m.imported_users.length;t++)m.imported_users[t].membership_start?m.imported_users[t].membership_start=new Date(m.imported_users[t].membership_start):m.imported_users[t].membership_start=new Date,m.imported_users[t].membership_id=4,m.imported_users[t].membership={membership_id:4,membership_name:"Annual Membership"}},m.user_columns={first_name:"First Name",last_name:"Last Name",email:"Email Address",dob:"Date of Birth",membership_number:"Membership Number",membership_start:"Membership Start Date",membership_id:"Membership Name"},s.import_column=function(e){},s.import_users=function(){if(m.imported_users=$.grep(m.imported_users,function(e){return"false"!=e.selected}),-1<m.imported_new_headers.indexOf("first_name")&&-1<m.imported_new_headers.indexOf("last_name")&&-1<m.imported_new_headers.indexOf("email")){for(var e=0;e<m.imported_users.length;e++)m.imported_users[e].membership&&m.imported_users[e].membership.membership_id&&(m.imported_users[e].membership_id=m.imported_users[e].membership.membership_id,delete m.imported_users[e].membership);m.imported_new_headers.push("membership_id"),m.imported_new_headers.push("membership_start");for(var t=[],n=0;n<m.imported_users.length;n++){for(var o={user:{},club_id:m.club_id},i=0;i<m.imported_new_headers.length;i++)m.imported_new_headers[i]&&("first_name"==m.imported_new_headers[i]||"last_name"==m.imported_new_headers[i]||"dob"==m.imported_new_headers[i]||"email"==m.imported_new_headers[i]?o.user[m.imported_new_headers[i]]=m.imported_users[n][Object.keys(m.imported_users[n])[i]]:"membership_start"==m.imported_new_headers[i]||"membership_id"==m.imported_new_headers[i]?o[m.imported_new_headers[i]]=m.imported_users[n][m.imported_new_headers[i]]:o[m.imported_new_headers[i]]=m.imported_users[n][Object.keys(m.imported_users[n])[i]]);t.push(o)}r.CreateMany(t).then(function(e){c.go("dashboard.manage_club.members")})}else p.warning("Missing Fields","You must select the First Name, Last Name and Email Address to be able to add the user to the system!")},s.create=function(){m.club.member.club_id=m.club_id,r.Create(m.club.member).then(function(e){c.go("dashboard.manage_club.members")})},s.delete=function(){p.warning("Confirm Delete","Are you sure you would like to delete this membership?"),r.Update(m.club.membership).then(function(e){})},s.update=function(){m.club.member.club_id=m.club_id,r.Update(m.club.member).then(function(e){c.go("dashboard.manage_club.members")}),r.SaveMemberPlanes(m.club.member.id,m.club.member.club_id,m.club.planes).then(function(e){})},s.selected_members=function(e){m.selected_members=$.grep(m.club.members,function(e){return 1==e.selected});for(var t=0;t<m.selected_members.length;t++)m.selected_members[t].approved="approve"==e?1:0,r.Update(m.selected_members[t]).then(function(e){});c.go("dashboard.manage_club.members")},s.update_membership=function(e,t){m.club.member.membership_id=e.membership_id,m.club.member.membership_name=e.membership_name};s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return"By deleting this membership, you will also cancel all reservations that this membership currently has."}}}).result.then(function(t){u.info("PRESSED GO: "+t),r.Delete(t).then(function(){m.club.members=$.grep(m.club.members,function(e){return e.id!=t})})},function(){u.info("Modal dismissed at: "+new Date)})}}function DashboardUserInstructorHolidayController(e,r,t,n,a,o,i,s,c,l,d,u,_,p,m,f,g){var b=this;s.va1="123",b.user=null,b.allUsers=[],b.club={},b.page_title="",b.club.member={},b.imported_new_headers=[],b.action=c.current.data.action,b.user=o.globals.currentUser,b.user_id=b.user.id,b.no_show_cols=["membership_start","membership_id","selected"];var h=new Date,k=Math.floor(8),o=Math.floor(18),k=new Date(h.getFullYear(),h.getMonth(),h.getDate(),k,0,0),o=new Date(h.getFullYear(),h.getMonth(),h.getDate(),o,0,0);function y(e,t){var n=s.myDatetimeRange.date[t],o=n.getDate(),i=n.getMonth(),r=n.getFullYear(),e=e[t],t=e.slice(0,2),e="00"==(e=e.slice(3,5)).toString()?0:e;return n=new Date(r,i,o,t,e,0)}s.myDatetimeRange={date:{from:k,to:o},time:{from:480,to:1080,step:15,minRange:15,hours24:!0}},s.myDatetimeLabels={date:{from:"Start date",to:"End date"}},s.toggle=!0,s.toggleDirective=function(){s.toggle=!s.toggle},s.whentimechangedata={},s.overridePicker=!0,s.whenTimeChange=function(e){var t=y(e,"from"),n=y(e,"to");s.myDatetimeRange.date.from=t,s.myDatetimeRange.date.to=n,s.whentimechangedata=e},s.timeRangePicker={time:{from:480,to:1020,step:15,minRange:15,hours24:!0}},s.dateRangePicker={date:{from:new Date,to:new Date}};k=new Date,o=new Date(k.getTime()-864e6);s.datePickerWithRange={date:{from:new Date,to:new Date,max:k,min:o},time:{from:420,to:1020,step:15,minRange:15,hours24:!0}};o=new Date,o.getDate(),o.getMonth(),o.getFullYear();s.events=[],a.GetAll(b.user.id).then(function(e){for(var t=0;t<e.length;t++)s.events.push({id:e[t].id,title:e[t].title,start:new Date(e[t].from_date),end:new Date(e[t].to_date),allDay:e[t].allDay,className:["customFeed"]})}),s.alertOnEventClick=function(e,t,n){s.alertMessage=e.title+" was clicked "},s.alertOnDrop=function(e,t,n,o,i,r){a.Update(b.user.id,e).then(function(e){}),s.alertMessage="Event Updated"},s.alertOnResize=function(e,t,n,o,i,r){a.Update(b.user.id,e).then(function(e){}),s.alertMessage="Event Updated"},s.addRemoveEventSource=function(n,o){var i=0;angular.forEach(n,function(e,t){n[t]===o&&(n.splice(t,1),i=1)}),0===i&&n.push(o)},s.whole_day_booking=!1,s.wholeDay=function(){1==s.whole_day_booking?(s.whole_day_booking=!1,s.myDatetimeRange.time.from=480,s.myDatetimeRange.time.to=1080):(s.whole_day_booking=!0,s.myDatetimeRange.time.from=0,s.myDatetimeRange.time.to=1440)},s.addEvent=function(){var e={title:"Holiday",start:s.myDatetimeRange.date.from,end:s.myDatetimeRange.date.to,className:["openSesame"],allDay:s.whole_day_booking};s.events.push(e),a.Create(b.user.id,e).then(function(e){c.go("dashboard.manage_user.instructor_holidays")})},s.remove=function(t){var e=s.events[t].id;a.Delete(b.user.id,e).then(function(e){s.events.splice(t,1)})},s.changeView=function(e,t){f.calendars[t].fullCalendar("changeView",e)},s.renderCalender=function(e){m(function(){f.calendars[e]&&f.calendars[e].fullCalendar("render")})},s.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),p(t)(s)},s.uiConfig={schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",calendar:{height:650,editable:!0,header:{left:"title",center:"",right:"today prev,next"},firstDay:1,slotEventOverlap:!1,eventClick:s.alertOnEventClick,eventDrop:s.alertOnDrop,eventResize:s.alertOnResize,eventRender:s.eventRender}},s.changeLang=function(){s.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},s.eventSources=[s.events],"add"===b.action&&(b.page_title="Add a New member"),s.back=function(){_.history.back()},s.save=function(){"add"==b.action?s.create():s.update()},s.csvToJSON=function(e){var t=e.csv.split(/\r\n|\n/),n=[],o=0;t[0]+=",membership_id,membership_start,selected";for(var i=1;i<t.length;i++)t[i]+=",membership_id,membership_start,true";var r=t[0].split(e.separator).length,a=[];e.header&&(a=t[0].split(e.separator),b.imported_headers=a,o=1);for(var s=o;s<t.length;s++){var c={},l=t[s].split(new RegExp(e.separator+'(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)'));if(l.length===r){if(e.header)for(i=0;i<a.length;i++)c[a[i]]=l[i];else for(var d=0;d<l.length;d++)c[d]=l[d];n.push(c)}}return n},s.processData=function(){allText=b.import_users;var e={csv:b.import_users,separator:",",header:!0};b.imported_users=s.csvToJSON(e);for(var t=0;t<b.imported_users.length;t++)b.imported_users[t].membership_start?b.imported_users[t].membership_start=new Date(b.imported_users[t].membership_start):b.imported_users[t].membership_start=new Date,b.imported_users[t].membership_id=4,b.imported_users[t].membership={membership_id:4,membership_name:"Annual Membership"}},b.user_columns={first_name:"First Name",last_name:"Last Name",email:"Email Address",dob:"Date of Birth",membership_number:"Membership Number",membership_start:"Membership Start Date",membership_id:"Membership Name"},s.import_column=function(e){},s.import_users=function(){if(b.imported_users=$.grep(b.imported_users,function(e){return"false"!=e.selected}),-1<b.imported_new_headers.indexOf("first_name")&&-1<b.imported_new_headers.indexOf("last_name")&&-1<b.imported_new_headers.indexOf("email")){for(var e=0;e<b.imported_users.length;e++)b.imported_users[e].membership&&b.imported_users[e].membership.membership_id&&(b.imported_users[e].membership_id=b.imported_users[e].membership.membership_id,delete b.imported_users[e].membership);b.imported_new_headers.push("membership_id"),b.imported_new_headers.push("membership_start");for(var t=[],n=0;n<b.imported_users.length;n++){for(var o={user:{},club_id:6},i=0;i<b.imported_new_headers.length;i++)b.imported_new_headers[i]&&("first_name"==b.imported_new_headers[i]||"last_name"==b.imported_new_headers[i]||"dob"==b.imported_new_headers[i]||"email"==b.imported_new_headers[i]?o.user[b.imported_new_headers[i]]=b.imported_users[n][Object.keys(b.imported_users[n])[i]]:"membership_start"==b.imported_new_headers[i]||"membership_id"==b.imported_new_headers[i]?o[b.imported_new_headers[i]]=b.imported_users[n][b.imported_new_headers[i]]:o[b.imported_new_headers[i]]=b.imported_users[n][Object.keys(b.imported_users[n])[i]]);t.push(o)}r.CreateMany(t).then(function(e){c.go("dashboard.manage_club.members")})}else g.warning("Missing Fields","You must select the First Name, Last Name and Email Address to be able to add the user to the system!")},s.create=function(){b.club.member.club_id=6,r.Create(b.club.member).then(function(e){c.go("dashboard.manage_club.members")})},s.delete=function(){g.warning("Confirm Delete","Are you sure you would like to delete this membership?"),r.Update(b.club.membership).then(function(e){})},s.update=function(){b.club.member.club_id=6,r.Update(b.club.member).then(function(e){c.go("dashboard.manage_club.members")}),r.SaveMemberPlanes(b.club.member.id,b.club.member.club_id,b.club.planes).then(function(e){})},s.selected_members=function(e){b.selected_members=$.grep(b.club.members,function(e){return 1==e.selected});for(var t=0;t<b.selected_members.length;t++)b.selected_members[t].approved="approve"==e?1:0,r.Update(b.selected_members[t]).then(function(e){});c.go("dashboard.manage_club.members")},s.update_membership=function(e,t){b.club.member.membership_id=e.membership_id,b.club.member.membership_name=e.membership_name};s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return"By deleting this membership, you will also cancel all reservations that this membership currently has."}}}).result.then(function(t){u.info("PRESSED GO: "+t),r.Delete(t).then(function(){b.club.members=$.grep(b.club.members,function(e){return e.id!=t})})},function(){u.info("Modal dismissed at: "+new Date)})}}function FinishAndPayController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C,S,x,O,$){var D=this;D.user=a.globals.currentUser,D.user_id=D.user.id,D.show_loading=!1,D.club_id=6,D.booking={},D.wgs_n="51.51",D.wgs_e="0.12",D.change_booking={},D.show_change_plane=!1,D.bookout={start:!0,passengers:[],pic:{id:D.user_id},plane:{}},D.dateFormat="date:HH:mm 'on' dd/MM/yyyy",D.reported_defects=[],D.complete_flight=!0,D.previous_invoice,D.defect_severity,D.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}];D.donConfirm=function(e,t){D.book_in_flight(e,t)},D.default_payment="direct-debit",D.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],D.savedCards=[],D.complete_flight=!1,D.complete_this_flight=function(){if(D.tacho_error_highlight)return $.error("Meter Error","You cannot complete a flight where the last meter reading is greater than the start meter reading!"),!1;D.bookout.club_id,D.bookout.user_id;n.GetMandate(D.bookout.user_id,D.bookout.club_id).then(function(e){e.success&&(D.info=e.info,D.savedCards=e.cards,0<D.savedCards.length?D.methods[1].visible=!0:D.methods[1].visible=!1,D.machine=e.machine,D.machine.success?D.methods[3].visible=!0:D.methods[3].visible=!1)}),D.complete_flight=!0},c.get_airfields=function(t){var e;2<t.length&&t.length<5&&y.GetAirfieldsByCode(t).then(function(e){e.success&&(D.airfields=e.airfields,0==D.airfields.length&&(D.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}),4<t.length&&(e=t.replace(/\s/g,"_"),y.GetAirfields(e).then(function(e){e.success&&(D.airfields=e.airfields,0==D.airfields.length&&(D.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}))},c.update_pic=function(){D.bookout.pic.user_id==D.user.id&&0<D.bookout.instructor_id||0<D.bookout.instructor_id&&(D.bookout.pic.user_id,D.bookout.instructor_id)},"add"===l.current.data.action&&h.GetForBookout(D.user.id,d.id).then(function(t){t.success&&(1==t.booking.complete&&($.warning("Already Complete","It appears that you have already completed this booking..."),l.go("dashboard.my_account",{},{reload:!0})),D.bookout=t.booking,D.bookout.start_date=new Date("2100/07/26"),D.bookout.end_date=new Date("2100/07/26"),n.GetAllByPics(t.booking.club_id,D.user.id).then(function(e){D.pics=e,function(o){D.bookout.booking_id=o.id,D.bookout.club_id=o.club_id,D.bookout.user_id=o.user_id,D.bookout.plane=o.plane,D.club_id=o.club_id,(-1<D.user.access.instructor.indexOf(D.club_id)||-1<D.user.access.manager.indexOf(D.club_id))&&D.bookout.user_id!==D.user.id&&(D.can_authorise=!0);D.invoices=[],D.previous_total=0,x.GetAllByBooking(o.id).then(function(e){if(e.success){for(var t in D.previous_invoice=e.invoice,e.invoices)for(var n in e.invoices[t].flights)e.invoices[t]&&e.invoices[t].status&&"paid"!==e.invoices[t].status.toLowerCase()&&(D.invoices.push(e.invoices[t].flights[n]),D.previous_total=Number.parseFloat(D.previous_total)+Number.parseFloat(e.invoices[t].flights[n].total));D.complete_this_flight(),D.invoice_totals=D.previous_total,D.send={club_id:D.bookout.club_id,user_id:D.user.id,booking_id:o.id},D.show_add_card=!0,0!=D.previous_total&&0!=D.invoices.length||($.warning("Already Complete","It appears that you have already completed this flight!"),l.go("dashboard.my_account",{},{reload:!0}))}})}(t.booking)}))}),D.calculate_invoice_for_flight=function(){D.invoice_totals=D.previous_total,D.plane_charges={total:0}},D.instructor_charges=[],D.complete_flight=!0,D.book_in_flight=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n={user_id:D.bookout.user_id,club_id:D.bookout.club_id,plane_id:D.bookout.plane_id,booking_id:D.bookout.booking_id,paying_now:D.complete_flight,free_flight:0==D.invoice_totals};"new-card"==e||"saved-card"==e?(n.paymentIntent=t,n.method=e):"direct-debit"==e?n.method=e:"card-machine"==e&&(n.paymentIntent=t,n.method=e),y.PayBooking(D.bookout.id,n).then(function(e){e.success?(D.show_loading=!1,l.go("dashboard.my_account",{},{reload:!0})):($.error("Error","An error occurred: "+e.message),D.show_loading=!1)})},D.start_tacho_orig,c.popup=[],c.open=function(e,t){c.popup[e]&&1==c.popup[e].opened?(t.preventDefault(),t.stopPropagation()):c.popup[e]={opened:!0}},c.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],c.format=c.formats[0],c.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1}}function GalleriesController(e,t,n,o,i,r,a,s,c,l,d,u,_){var p=this;u.GetAll().then(function(e){p.galleries=e,d.SetAllGalleries(e),0<d.data.selecting_for&&(p.galleries.forEach(function(e){e.id==d.data.selecting_for&&(e.images=d.data.selected_images)}),$("#organise_images").fadeIn())}),p.images=d.data.selected_images,l.remove_image=function(t){p.images=$.grep(p.images,function(e){return e.id!=t.id}),d.SetSelectedImages(p.images)},l.check_link_unique=function(){for(var e=0;e<p.all_galleries.length;e++)if(p.all_galleries[e].link===p.gallery.link)return!1},l.edit_gallery_images=function(e){for(var t=p.galleries[e],n=0;n<t.images.length;n++)t.images[n].selected=!0;d.SetSelectedImages(t.images),d.SetSelectingFor(t.id),r.path("/select_images")},l.save_images=function(){var n=[];p.galleries.forEach(function(e){if(e.id==d.data.selecting_for){e.images=d.data.selected_images;for(var t=0;t<e.images.length;t++)e.images[t].organise=t;n=e.images}}),u.Update({id:d.data.selecting_for,images:n}).then(function(e){d.SetSelectingFor(0),$("#organise_images").fadeOut()})},l.save_gallery=function(e){var t=p.galleries[e];d.SetSelectedImages(t.images);for(var n=0;n<t.images.length;n++)t.images[n].organise=n;u.Update(p.galleries[e]).then(function(e){_.success("Saved","Gallery saved successfully.")})};function m(e){var t;return t=e=e+"-COPY",p.galleries.forEach(function(e){if(e.gallery_link==t)return!1}),e}l.duplicate_gallery=function(e){e=JSON.parse(JSON.stringify(p.galleries[e]));delete e.id,e.opened=0,e.downloaded=0,e.gallery_link=m(e.gallery_link),u.Create(e).then(function(e){p.galleries.push(e)})},l.delete_gallery=function(e){var t=p.galleries[e];u.Delete(t.id).then(function(e){p.galleries=$.grep(p.galleries,function(e){return e.id!=t.id})})}}function HomeController(t,e,n){var o=this;o.user=e.globals.currentUser,o.allUsers=[],o.deleteUser=function(e){t.Delete(e).then(function(e){e.success&&n.path("/")})},t.GetById(e.globals.currentUser.id).then(function(e){o.user=e.user}),t.GetAll().then(function(e){o.allUsers=e.users})}function ImagesController(e,t,n,o,i,r,a,s,c,l,d){var u=this;l.filters="",u.selected_images=[],n.GetAll().then(function(e){u.images=e}),t.GetAll().then(function(e){u.all_artpieces=e,u.artpieces=e}),i.GetAll().then(function(e){u.categories=e}),c.imageId&&n.GetOne(c.imageId).then(function(e){u.one_image=e;var t=[];u.one_image.keywords.forEach(function(e){t.push({id:e.id,text:e.keyword})}),l.tags=t}),o.GetAll().then(function(e){u.all_keywords=e,u.all_tags=[],u.all_keywords.forEach(function(e){u.all_tags.push({id:e.id,text:e.keyword})})});function _(){var e,n,o=l.tags,t=l.filters;t&&t.indexOf(", ")?(e=t.split(", "),t="",n=[],e.forEach(function(e){var t=e;o&&o.forEach(function(e){t+="."+e.text}),n.push(t)}),t=n.join(", ")):o&&o.forEach(function(e){t+="."+e.text}),l.$emit("iso-option",{filter:t})}var p=0;l.change_category=function(e){if("all"==(p=e))u.artpieces=u.all_artpieces,l.filters="",_();else{if(u.artpieces=u.categories[e].artpieces||[],u.categories[e].artpieces&&0<u.categories[e].artpieces.length){var e=u.categories[e].artpieces,t=[];return e.forEach(function(e){t.push(".artpiece"+e.id)}),l.filters=t.join(", "),_(),l.filters}l.filters=".hideAllPossibleItems",_()}},l.artpiece_filter=function(e){l.filters="all"==e?0==p?"":l.change_category(p):".artpiece"+e,_()},l.update_list=function(){setTimeout(function(){_()},500)};var m=function(e,t){for(var n=0;n<u.images.length;n++)u.images[n].id===e&&(u.images[n].selected=t)};l.add_image=function(t){1==t.selected?(m(t.id,!1),u.selected_images=$.grep(u.selected_images,function(e){return e.id!=t.id})):(u.selected_images.push(t),m(t.id,!0)),d.SetSelectedImages(u.selected_images)},u.save_btn_text=0<d.data.selecting_for?"UPDATE GALLERY":"GENERATE GALLERY",l.save=function(){var e=0<d.data.selecting_for?"/galleries":"/create_gallery";r.path(e)},l.editImage=function(){u.one_image.keywords=l.tags,n.Update(u.one_image).then(function(e){r.path("/images"),u.one_image={}})},l.loadClasses=function(e){return"one two three"},l.loadTags=function(t){for(var e=$.grep(u.all_keywords,function(e){if(e.keyword.toLowerCase().startsWith(t.toLowerCase()))return!0}),n=[],o=0;o<e.length;o++){var i=(i=e[o].keyword).toLowerCase();n.push({id:e[o].id,text:i})}return n},l.deleteImage=function(t){n.Delete(t).then(function(e){u.images=$.grep(u.images,function(e){return e.id!=t})})},setTimeout(function(){u.selected_images=d.data.selected_images,0<u.selected_images.length&&u.selected_images.forEach(function(t){1==t.selected?m(t.id,!0):(m(t.id,!1),u.selected_images=$.grep(u.selected_images,function(e){return e.id!=t.id}))})},500)}function InvitationsSignupController(t,n,e,o,i,r,a,s,c,l,d,u){a.formData={},this.selected_phone,this.countries=[{CountryCode:"+247",CountryCodeISO:"SH",Country:"Ascension"},{CountryCode:"+246",CountryCodeISO:"DG",Country:"Diego Garcia"},{CountryCode:"+291",CountryCodeISO:"ER",Country:"Eritrea"},{CountryCode:"+500",CountryCodeISO:"FK",Country:"Falkland (Malvinas) Islands"},{CountryCode:"+692",CountryCodeISO:"MH",Country:"Marshall Islands"},{CountryCode:"+691",CountryCodeISO:"FM",Country:"Micronesia"},{CountryCode:"+683",CountryCodeISO:"NU",Country:"Niue Island"},{CountryCode:"+290",CountryCodeISO:"SH",Country:"Saint Helena"},{CountryCode:"+508",CountryCodeISO:"PM",Country:"Saint Pierre and Miquelon"},{CountryCode:"+690",CountryCodeISO:"TK",Country:"Tokelau"},{CountryCode:"+688",CountryCodeISO:"TV",Country:"Tuvalu"},{CountryCode:"+379",CountryCodeISO:"VA",Country:"Vatican City"},{CountryCode:"+681",CountryCodeISO:"WF",Country:"Wallis and Futuna"},{CountryCode:"+1",CountryCodeISO:"AS",Country:"American Samoa"},{CountryCode:"+1",CountryCodeISO:"CA",Country:"Canada"},{CountryCode:"+61",CountryCodeISO:"AU",Country:"Australia"},{CountryCode:"+93",CountryCodeISO:"AF",Country:"Afghanistan"},{CountryCode:"+355",CountryCodeISO:"AL",Country:"Albania"},{CountryCode:"+213",CountryCodeISO:"DZ",Country:"Algeria"},{CountryCode:"+376",CountryCodeISO:"AD",Country:"Andorra"},{CountryCode:"+244",CountryCodeISO:"AO",Country:"Angola"},{CountryCode:"+54",CountryCodeISO:"AR",Country:"Argentina"},{CountryCode:"+374",CountryCodeISO:"AM",Country:"Armenia"},{CountryCode:"+297",CountryCodeISO:"AW",Country:"Aruba"},{CountryCode:"+43",CountryCodeISO:"AT",Country:"Austria"},{CountryCode:"+994",CountryCodeISO:"AZ",Country:"Azerbaijan"},{CountryCode:"+973",CountryCodeISO:"BH",Country:"Bahrain"},{CountryCode:"+880",CountryCodeISO:"BD",Country:"Bangladesh"},{CountryCode:"+375",CountryCodeISO:"BY",Country:"Belarus"},{CountryCode:"+32",CountryCodeISO:"BE",Country:"Belgium"},{CountryCode:"+501",CountryCodeISO:"BZ",Country:"Belize"},{CountryCode:"+229",CountryCodeISO:"BJ",Country:"Benin"},{CountryCode:"+975",CountryCodeISO:"BT",Country:"Bhutan"},{CountryCode:"+591",CountryCodeISO:"BO",Country:"Bolivia"},{CountryCode:"+387",CountryCodeISO:"BA",Country:"Bosnia and Herzegovina"},{CountryCode:"+267",CountryCodeISO:"BW",Country:"Botswana"},{CountryCode:"+55",CountryCodeISO:"BR",Country:"Brazil"},{CountryCode:"+673",CountryCodeISO:"BN",Country:"Brunei"},{CountryCode:"+359",CountryCodeISO:"BG",Country:"Bulgaria"},{CountryCode:"+226",CountryCodeISO:"BF",Country:"Burkina Faso"},{CountryCode:"+257",CountryCodeISO:"BI",Country:"Burundi"},{CountryCode:"+855",CountryCodeISO:"KH",Country:"Cambodia"},{CountryCode:"+237",CountryCodeISO:"CM",Country:"Cameroon"},{CountryCode:"+238",CountryCodeISO:"CV",Country:"Cape Verde"},{CountryCode:"+236",CountryCodeISO:"CF",Country:"Central African Republic"},{CountryCode:"+235",CountryCodeISO:"TD",Country:"Chad"},{CountryCode:"+56",CountryCodeISO:"CL",Country:"Chile"},{CountryCode:"+86",CountryCodeISO:"CN",Country:"China"},{CountryCode:"+57",CountryCodeISO:"CO",Country:"Colombia"},{CountryCode:"+269",CountryCodeISO:"KM",Country:"Comoros"},{CountryCode:"+242",CountryCodeISO:"CG",Country:"Congo"},{CountryCode:"+682",CountryCodeISO:"CK",Country:"Cook Islands"},{CountryCode:"+506",CountryCodeISO:"CR",Country:"Costa Rica"},{CountryCode:"+385",CountryCodeISO:"HR",Country:"Croatia"},{CountryCode:"+53",CountryCodeISO:"CU",Country:"Cuba"},{CountryCode:"+357",CountryCodeISO:"CY",Country:"Cyprus"},{CountryCode:"+420",CountryCodeISO:"CZ",Country:"Czech Republic"},{CountryCode:"+243",CountryCodeISO:"CD",Country:"Democratic Republic of Congo"},{CountryCode:"+45",CountryCodeISO:"DK",Country:"Denmark"},{CountryCode:"+253",CountryCodeISO:"DJ",Country:"Djibouti"},{CountryCode:"+670",CountryCodeISO:"TL",Country:"East Timor"},{CountryCode:"+593",CountryCodeISO:"EC",Country:"Ecuador"},{CountryCode:"+20",CountryCodeISO:"EG",Country:"Egypt"},{CountryCode:"+503",CountryCodeISO:"SV",Country:"El Salvador"},{CountryCode:"+240",CountryCodeISO:"GQ",Country:"Equatorial Guinea"},{CountryCode:"+372",CountryCodeISO:"EE",Country:"Estonia"},{CountryCode:"+251",CountryCodeISO:"ET",Country:"Ethiopia"},{CountryCode:"+298",CountryCodeISO:"FO",Country:"Faroe Islands"},{CountryCode:"+679",CountryCodeISO:"FJ",Country:"Fiji"},{CountryCode:"+358",CountryCodeISO:"FI",Country:"Finland"},{CountryCode:"+33",CountryCodeISO:"FR",Country:"France"},{CountryCode:"+594",CountryCodeISO:"GF",Country:"French Guiana"},{CountryCode:"+689",CountryCodeISO:"PF",Country:"French Polynesia"},{CountryCode:"+241",CountryCodeISO:"GA",Country:"Gabon"},{CountryCode:"+220",CountryCodeISO:"GM",Country:"Gambia"},{CountryCode:"+995",CountryCodeISO:"GE",Country:"Georgia"},{CountryCode:"+49",CountryCodeISO:"DE",Country:"Germany"},{CountryCode:"+233",CountryCodeISO:"GH",Country:"Ghana"},{CountryCode:"+350",CountryCodeISO:"GI",Country:"Gibraltar"},{CountryCode:"+30",CountryCodeISO:"GR",Country:"Greece"},{CountryCode:"+299",CountryCodeISO:"GL",Country:"Greenland"},{CountryCode:"+590",CountryCodeISO:"GP",Country:"Guadeloupe"},{CountryCode:"+502",CountryCodeISO:"GT",Country:"Guatemala"},{CountryCode:"+224",CountryCodeISO:"GN",Country:"Guinea"},{CountryCode:"+245",CountryCodeISO:"GW",Country:"Guinea-Bissau"},{CountryCode:"+592",CountryCodeISO:"GY",Country:"Guyana"},{CountryCode:"+509",CountryCodeISO:"HT",Country:"Haiti"},{CountryCode:"+504",CountryCodeISO:"HN",Country:"Honduras"},{CountryCode:"+852",CountryCodeISO:"HK",Country:"Hong Kong"},{CountryCode:"+36",CountryCodeISO:"HU",Country:"Hungary"},{CountryCode:"+354",CountryCodeISO:"IS",Country:"Iceland"},{CountryCode:"+91",CountryCodeISO:"IN",Country:"India"},{CountryCode:"+62",CountryCodeISO:"ID",Country:"Indonesia"},{CountryCode:"+98",CountryCodeISO:"IR",Country:"Iran"},{CountryCode:"+964",CountryCodeISO:"IQ",Country:"Iraq"},{CountryCode:"+353",CountryCodeISO:"IE",Country:"Ireland"},{CountryCode:"+972",CountryCodeISO:"IL",Country:"Israel"},{CountryCode:"+39",CountryCodeISO:"IT",Country:"Italy"},{CountryCode:"+225",CountryCodeISO:"CI",Country:"Ivory Coast"},{CountryCode:"+81",CountryCodeISO:"JP",Country:"Japan"},{CountryCode:"+962",CountryCodeISO:"JO",Country:"Jordan"},{CountryCode:"+254",CountryCodeISO:"KE",Country:"Kenya"},{CountryCode:"+686",CountryCodeISO:"KI",Country:"Kiribati"},{CountryCode:"+965",CountryCodeISO:"KW",Country:"Kuwait"},{CountryCode:"+996",CountryCodeISO:"KG",Country:"Kyrgyzstan"},{CountryCode:"+856",CountryCodeISO:"LA",Country:"Laos"},{CountryCode:"+371",CountryCodeISO:"LV",Country:"Latvia"},{CountryCode:"+961",CountryCodeISO:"LB",Country:"Lebanon"},{CountryCode:"+266",CountryCodeISO:"LS",Country:"Lesotho"},{CountryCode:"+231",CountryCodeISO:"LR",Country:"Liberia"},{CountryCode:"+218",CountryCodeISO:"LY",Country:"Libya"},{CountryCode:"+423",CountryCodeISO:"LI",Country:"Liechtenstein"},{CountryCode:"+370",CountryCodeISO:"LT",Country:"Lithuania"},{CountryCode:"+352",CountryCodeISO:"LU",Country:"Luxembourg"},{CountryCode:"+853",CountryCodeISO:"MO",Country:"Macau"},{CountryCode:"+389",CountryCodeISO:"MK",Country:"Macedonia"},{CountryCode:"+261",CountryCodeISO:"MG",Country:"Madagascar"},{CountryCode:"+265",CountryCodeISO:"MW",Country:"Malawi"},{CountryCode:"+60",CountryCodeISO:"MY",Country:"Malaysia"},{CountryCode:"+960",CountryCodeISO:"MV",Country:"Maldives"},{CountryCode:"+223",CountryCodeISO:"ML",Country:"Mali"},{CountryCode:"+356",CountryCodeISO:"MT",Country:"Malta"},{CountryCode:"+596",CountryCodeISO:"MQ",Country:"Martinique"},{CountryCode:"+222",CountryCodeISO:"MR",Country:"Mauritania"},{CountryCode:"+230",CountryCodeISO:"MU",Country:"Mauritius"},{CountryCode:"+262",CountryCodeISO:"RE",Country:"Reunion"},{CountryCode:"+52",CountryCodeISO:"MX",Country:"Mexico"},{CountryCode:"+373",CountryCodeISO:"MD",Country:"Moldova"},{CountryCode:"+377",CountryCodeISO:"MC",Country:"Monaco"},{CountryCode:"+976",CountryCodeISO:"MN",Country:"Mongolia"},{CountryCode:"+382",CountryCodeISO:"ME",Country:"Montenegro"},{CountryCode:"+212",CountryCodeISO:"MA",Country:"Morocco"},{CountryCode:"+258",CountryCodeISO:"MZ",Country:"Mozambique"},{CountryCode:"+95",CountryCodeISO:"MM",Country:"Myanmar"},{CountryCode:"+264",CountryCodeISO:"NA",Country:"Namibia"},{CountryCode:"+674",CountryCodeISO:"NR",Country:"Nauru"},{CountryCode:"+977",CountryCodeISO:"NP",Country:"Nepal"},{CountryCode:"+31",CountryCodeISO:"NL",Country:"Netherlands"},{CountryCode:"+599",CountryCodeISO:"AN",Country:"Netherlands Antilles"},{CountryCode:"+687",CountryCodeISO:"NC",Country:"New Caledonia"},{CountryCode:"+64",CountryCodeISO:"NZ",Country:"New Zealand"},{CountryCode:"+505",CountryCodeISO:"NI",Country:"Nicaragua"},{CountryCode:"+227",CountryCodeISO:"NE",Country:"Niger"},{CountryCode:"+234",CountryCodeISO:"NG",Country:"Nigeria"},{CountryCode:"+850",CountryCodeISO:"KP",Country:"North Korea"},{CountryCode:"+47",CountryCodeISO:"NO",Country:"Norway"},{CountryCode:"+968",CountryCodeISO:"OM",Country:"Oman"},{CountryCode:"+92",CountryCodeISO:"PK",Country:"Pakistan"},{CountryCode:"+680",CountryCodeISO:"PW",Country:"Palau"},{CountryCode:"+507",CountryCodeISO:"PA",Country:"Panama"},{CountryCode:"+675",CountryCodeISO:"PG",Country:"Papua New Guinea"},{CountryCode:"+595",CountryCodeISO:"PY",Country:"Paraguay"},{CountryCode:"+51",CountryCodeISO:"PE",Country:"Peru"},{CountryCode:"+63",CountryCodeISO:"PH",Country:"Philippines"},{CountryCode:"+48",CountryCodeISO:"PL",Country:"Poland"},{CountryCode:"+351",CountryCodeISO:"PT",Country:"Portugal"},{CountryCode:"+974",CountryCodeISO:"QA",Country:"Qatar"},{CountryCode:"+40",CountryCodeISO:"RO",Country:"Romania"},{CountryCode:"+7",CountryCodeISO:"KZ",Country:"Kazakhstan"},{CountryCode:"+250",CountryCodeISO:"RW",Country:"Rwanda"},{CountryCode:"+685",CountryCodeISO:"WS",Country:"Samoa"},{CountryCode:"+378",CountryCodeISO:"SM",Country:"San Marino"},{CountryCode:"+239",CountryCodeISO:"ST",Country:"Sao Tome and Principe"},{CountryCode:"+966",CountryCodeISO:"SA",Country:"Saudi Arabia"},{CountryCode:"+221",CountryCodeISO:"SN",Country:"Senegal"},{CountryCode:"+381",CountryCodeISO:"RS",Country:"Serbia"},{CountryCode:"+248",CountryCodeISO:"SC",Country:"Seychelles"},{CountryCode:"+232",CountryCodeISO:"SL",Country:"Sierra Leone"},{CountryCode:"+65",CountryCodeISO:"SG",Country:"Singapore"},{CountryCode:"+421",CountryCodeISO:"SK",Country:"Slovakia"},{CountryCode:"+386",CountryCodeISO:"SI",Country:"Slovenia"},{CountryCode:"+677",CountryCodeISO:"SB",Country:"Solomon Islands"},{CountryCode:"+252",CountryCodeISO:"SO",Country:"Somalia"},{CountryCode:"+27",CountryCodeISO:"ZA",Country:"South Africa"},{CountryCode:"+82",CountryCodeISO:"KR",Country:"South Korea"},{CountryCode:"+34",CountryCodeISO:"ES",Country:"Spain"},{CountryCode:"+94",CountryCodeISO:"LK",Country:"Sri Lanka"},{CountryCode:"+249",CountryCodeISO:"SD",Country:"Sudan"},{CountryCode:"+597",CountryCodeISO:"SR",Country:"Suriname"},{CountryCode:"+268",CountryCodeISO:"SZ",Country:"Swaziland"},{CountryCode:"+46",CountryCodeISO:"SE",Country:"Sweden"},{CountryCode:"+41",CountryCodeISO:"CH",Country:"Switzerland"},{CountryCode:"+963",CountryCodeISO:"SY",Country:"Syria"},{CountryCode:"+886",CountryCodeISO:"TW",Country:"Taiwan"},{CountryCode:"+992",CountryCodeISO:"TJ",Country:"Tajikistan"},{CountryCode:"+255",CountryCodeISO:"TZ",Country:"Tanzania"},{CountryCode:"+66",CountryCodeISO:"TH",Country:"Thailand"},{CountryCode:"+228",CountryCodeISO:"TG",Country:"Togo"},{CountryCode:"+216",CountryCodeISO:"TN",Country:"Tunisia"},{CountryCode:"+90",CountryCodeISO:"TR",Country:"Turkey"},{CountryCode:"+993",CountryCodeISO:"TM",Country:"Turkmenistan"},{CountryCode:"+256",CountryCodeISO:"UG",Country:"Uganda"},{CountryCode:"+380",CountryCodeISO:"UA",Country:"Ukraine"},{CountryCode:"+971",CountryCodeISO:"AE",Country:"United Arab Emirates"},{CountryCode:"+44",CountryCodeISO:"GB",Country:"United Kingdom"},{CountryCode:"+1",CountryCodeISO:"VI",Country:"U.S. Virgin Islands"},{CountryCode:"+598",CountryCodeISO:"UY",Country:"Uruguay"},{CountryCode:"+998",CountryCodeISO:"UZ",Country:"Uzbekistan"},{CountryCode:"+678",CountryCodeISO:"VU",Country:"Vanuatu"},{CountryCode:"+58",CountryCodeISO:"VE",Country:"Venezuela"},{CountryCode:"+84",CountryCodeISO:"VN",Country:"Vietnam"},{CountryCode:"+967",CountryCodeISO:"YE",Country:"Yemen"},{CountryCode:"+260",CountryCodeISO:"ZM",Country:"Zambia"},{CountryCode:"+263",CountryCodeISO:"ZW",Country:"Zimbabwe"},{CountryCode:"+262",CountryCodeISO:"YT",Country:"Mayotte"},{CountryCode:"+7",CountryCodeISO:"RU",Country:"Russian Federation"},{CountryCode:"+1",CountryCodeISO:"AI",Country:"Anguilla"},{CountryCode:"+1",CountryCodeISO:"AG",Country:"Antigua and Barbuda"},{CountryCode:"+1",CountryCodeISO:"BS",Country:"Bahamas"},{CountryCode:"+1",CountryCodeISO:"BB",Country:"Barbados"},{CountryCode:"+1",CountryCodeISO:"BM",Country:"Bermuda"},{CountryCode:"+1",CountryCodeISO:"VG",Country:"British Virgin Islands"},{CountryCode:"+1",CountryCodeISO:"KY",Country:"Cayman Islands"},{CountryCode:"+1",CountryCodeISO:"DM",Country:"Dominica"},{CountryCode:"+1",CountryCodeISO:"DO",Country:"Dominican Republic"},{CountryCode:"+1",CountryCodeISO:"GD",Country:"Grenada"},{CountryCode:"+1",CountryCodeISO:"GU",Country:"Guam"},{CountryCode:"+1",CountryCodeISO:"JM",Country:"Jamaica"},{CountryCode:"+1",CountryCodeISO:"MS",Country:"Montserrat"},{CountryCode:"+1",CountryCodeISO:"MP",Country:"Northern Marianas"},{CountryCode:"+1",CountryCodeISO:"PR",Country:"Puerto Rico"},{CountryCode:"+1",CountryCodeISO:"KN",Country:"Saint Kitts and Nevis"},{CountryCode:"+1",CountryCodeISO:"LC",Country:"Saint Lucia"},{CountryCode:"+1",CountryCodeISO:"VC",Country:"Saint Vincent and the Grenadines"},{CountryCode:"+1",CountryCodeISO:"TT",Country:"Trinidad and Tobago"},{CountryCode:"+1",CountryCodeISO:"TC",Country:"Turks and Caicos Islands"},{CountryCode:"+676",CountryCodeISO:"TO",Country:"Tonga"},{CountryCode:"+1",CountryCodeISO:"US",Country:"United States of America"},{CountryCode:"+970",CountryCodeISO:"PS",Country:"Palestine"},{CountryCode:"+211",CountryCodeISO:"SS",Country:"South Sudan"},{CountryCode:"+44",CountryCodeISO:"IM",Country:"Isle of Man"}],s.params.verify&&(u.warning("Verification","VERIFY?"),t.Verify(s.params.user_id,s.params.verify).then(function(e){e.success?s.go("verified"):(u.error("Error",e.message),s.go("login"))}));var _,p=r.path().split("/");"verified"==p[p.length-1]&&(_=l.get("uid"),n.VerifyInvitedUser(_).then(function(e){e.success?s.go("invitations.verified"):u.error("Verification Failed","Your verification code is incorrect.")})),c.token?t.GetInvite(c.token).then(function(e){e?(a.total_invite=e,a.formData.first_name=e.first_name,a.formData.last_name=e.last_name,a.formData.email=e.email,a.formData.membership_id=e.membership_id,a.formData.club_id=e.club_id,a.formData.to_pay=e.to_pay,a.formData.token=e.invitation_token,a.formData.invited_by=e.invited_by,0<e.user_id&&l.put("uid",e.user_id),a.payment_now=e.payment_now,a.first_payment=e.first_payment,a.club=e.club,a.membership=e.membership,a.all=e):(u.error("Invitation Not Found","Sorry we were unable to find this invitation. Please try clicking the link again."),s.go("login"))}):s.go("login"),""!==l.get("session")&&r.search().redirect_flow_id&&(r={mandate:r.search().redirect_flow_id,session:l.get("session"),member_accepted:!0},e.SetupMandate(r).then(function(e){e.success})),a.add_element=function(t){a[t][t]=$.grep(a[t][t],function(e){return e.id!=a.formData.license.add_to[t].id}),"differences"==t&&(a.formData.license.add_to[t].day=!0,a.formData.license.add_to[t].vfr=!0),a.formData.license[t].push(a.formData.license.add_to[t]),delete a.formData.license.add_to[t]},a.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");o.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",o.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){u.error("Download Failed","There was an error downloading the selected document(s).")})},a.remove_element=function(e,t){a[e][e].push(a.formData.license[e][t]),a.formData.license[e].splice(t,1),a.formData.license[e]=a.formData.license[e].filter(Boolean)},a.setup_direct_debit=function(){var e;a.checkValid("verify_account",1)?((e=a.formData).request_id=a.all.membership_request_id,e.invitation=c.token,e.payment_now=a.payment_now,e.first_payment=a.first_payment,t.InviteSignup(e).then(function(e){return e.success?(l.put("session",e.mandate.session),void(window.location=e.mandate.link)):(u.error("Signup Error","An error occurred: "+e.error),!1)})):u.warning("Incomplete Form","Please ensure that all fields are complete")},a.checkValid=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(e&&""!=e||(e=$(".btn-info").attr("one-ui-sref")),!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),$("input:checkbox:not(:checked):required").addClass("ng-checkbox-unchecked"),!1;if(!function(){if(a.formData.first_name&&a.formData.last_name&&a.formData.email&&a.formData.dob&&a.formData.password&&a.formData.password2)if(a.formData.password.length<7)u.warning("Password Too Short","Password must be more than 7 characters long");else{if(a.formData.password===a.formData.password2)return 1;u.warning("Password Mismatch","Your passwords do not match.")}else u.warning("Missing Fields","All form fields are required.")}())return s.go("invitations.your_details"),!1;if(!a.formData.nok)return s.go("invitations.next_of_kin"),!1;if(a.formData.tnc?$("input:checkbox:not(:checked)").removeClass("ng-checkbox-unchecked"):$("input:checkbox:not(:checked)").addClass("ng-checkbox-unchecked"),a.formData.password!=a.formData.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1;if(0!=t)return!0;"verify_account"==e?a.processForm():s.go(e)},a.sendVerification=function(){var e=l.get("uid");n.VerifyInvitedUser(e).then(function(e){e.success?s.go("invitations.verified"):u.error("Verification Failed","Your verification code is incorrect.")})},a.verify_mobile=function(e){e=e.text_verification;6==e.length&&n.VerifyPhoneInvite(e,l.get("uid")).then(function(e){e&&e.success?a.verified_mobile=!0:u.error("Verification Failed","Your verification code is incorrect.")})},a.processForm=function(){t.InviteSignup(a.formData).then(function(e){e?(u.success("Success","All good to go!"),s.go("invitations.verified")):(u.error("Invitation Not Found","Sorry we were unable to find this invitation. Please try clicking the link again."),s.go("login"))})}}function KeywordController(e,t,n,o){o.tags=new n,o.jsTagOptions={tags:o.tags};n=new Bloodhound({datumTokenizer:function(e){return Bloodhound.tokenizers.whitespace(e.keyword)},identify:function(e){return e.keyword},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:"/api/v1/keywords"});n.initialize(),o.exampleData={displayKey:"keyword",source:n.ttAdapter()},o.exampleOptions={hint:!1,highlight:!0},o.CheckContent=function(){}}function KeywordsController(e,n,t,o,i,r,a){var s=this;n.GetAll().then(function(e){s.keywords=e}),s.id=1,s.myModel="Click here and delete me",a.myUpdateHandler=function(e,t){n.Update({id:e,keyword:t}).then(function(e){})},a.addKeyword=function(){var e={keyword:s.new_keyword};n.Create(e).then(function(e){s.keywords.push(e),s.new_keyword=""})},a.deleteKeyword=function(t){n.Delete(t).then(function(e){s.keywords=$.grep(s.keywords,function(e){return e.id!=t})})}}function LoginController(i,r,e,a,s){var c=this;c.login=function n(){if(!c.email||""===c.email.trim())return s.highlightField("email"),void s.warning("Email Required","Please enter your email address.");if(!c.password||""===c.password)return s.highlightField("password"),void s.warning("Password Required","Please enter your password.");c.dataLoading=!0;c.error=null;r.Login1(c.email,c.login_session,function(e){var t;e.success?(t=e.login_key,r.Login2(c.password,t,function(e){var n,o;e.success?(n=!1,o=a(function(){n||(n=!0,i.path("/dashboard"))},1e4),r.SetCredentials2(c.email,c.password,e.user,e.session,function(e){if(o&&a.cancel(o),!n){n=!0;var t=null;try{t=localStorage.getItem("toaviate_return_url")}catch(e){}if(t){try{localStorage.removeItem("toaviate_return_url")}catch(e){}a(function(){i.path(t)},1e3)}else e&&e.access&&(0<e.access.instructor.length||0<e.access.manager.length)?i.path("/dashboard"):e?i.path("/dashboard/my_account"):(c.error="Login succeeded but we could not load your access level. Please try again.",c.dataLoading=!1)}})):(s.highlightField("password"),s.error("Login Failed",e.error||"Invalid password. Please try again."),c.error=e.error,c.dataLoading=!1)})):"The login session has expired - please try again"===e.error?r.Login0(function(e){e.success?(c.login_session=e.login_session,n()):(c.error=e.error||"Unable to refresh login session. Please refresh the page.",c.dataLoading=!1)}):(s.highlightField("email"),s.error("Login Failed",e.error||"Email not recognised. Please check and try again."),c.error=e.error,c.dataLoading=!1)})},c.login_session,c.login_key,r.CheckLoggedIn()?i.path("/dashboard"):r.ClearCredentials(),r.Login0(function(e){e.success?c.login_session=e.login_session:(c.error=e.error||"Unable to initialise login. Please refresh the page.",c.dataLoading=!1)})}function ManageAccountController(t,e,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var k=this;k.user=r.globals.currentUser,k.avatar="",k.address="Please choose address...",k.user.address_line1="Please choose",k.addresses={},k.show_addresses=!1,k.show_address=!1,k.show_search=!1,t.GetById(k.user.id).then(function(e){e.success&&(e.user.dob=new Date(e.user.dob),k.user=e.user,""!==k.user.address_line1&&(k.show_address=!0,k.show_search=!1,k.show_addresses=!1))}),s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,k.avatar=e[t].file,k.user.avatar=k.avatar.temp_path,k.user.update_avatar=!0}},s.show_form=function(){k.show_address=!0},s.set_address=function(){k.user.address_line1=k.address.line1,k.user.address_line2=k.address.line2,k.user.address_line3=k.address.line3,k.user.address_line4=k.address.line4,k.user.address_postcode=k.address.postcode,k.user.address_locality=k.address.locality,k.user.address_city=k.address.city,k.user.address_county=k.address.county,k.user.address_country=k.address.country,k.show_address=!0},s.get_addresses=function(){k.address={},b.GetAddresses(k.postcode).then(function(e){e.success?(k.addresses=e.addresses,k.addresses&&0<k.addresses.length?k.show_addresses=!0:(h.warning("Address Lookup","We couldn't find your address from your postcode, please enter it manually"),k.show_addresses=!1,k.show_address=!0)):(h.warning("Address Lookup","We couldn't find your address from your postcode, please enter it manually"),k.show_addresses=!1,k.show_address=!0)})},s.save_user=function(e){if(e){if(k.user.update_avatar||delete k.user.avatar,!k.user.phone_number||""==k.user.phone_number)return h.highlightField("phone_number"),h.warning("Validation Error","Please enter a mobile phone number"),!1;if(k.user.new_password){if(k.user.new_password!==k.user.new_password2)return h.highlightField("new_password2"),h.warning("Password Mismatch","Please ensure your updated passwords match"),!1;e=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!e.test(k.user.new_password))return k.show_error=!0,h.highlightField("new_password"),h.warning("Weak Password","Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1}if(!k.user.password)return h.highlightField("password"),h.warning("Password Required","Please enter your current password to ensure that these changes are made by you."),!1;t.Update(k.user).then(function(e){e.success?(h.success("Account Updated","Changes updated successfully."),c.go("dashboard.my_account",{},{reload:!0})):"Password entered failed"==e.message?h.error("Incorrect Password","The password entered was incorrect"):h.error("Update Failed","Something horrible happened!")})}}}function ManageDifferencesController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var k=this;b.GetDifferences().then(function(e){k.all_differences=e}),k.user=r.globals.currentUser,k.user_id=k.user.id,b.GetByUserId(k.user.id).then(function(e){for(var t=e.differences.differences,n=0;n<t.length;n++)"0000-00-00"==t[n].sign_off_date&&delete t[n].sign_off_date,t[n].sign_off_date=new Date(t[n].sign_off_date),t[n].day=1==t[n].day,t[n].night=1==t[n].night,t[n].vfr=1==t[n].vfr,t[n].ifr=1==t[n].ifr;e.differences.differences=t,k.differences=e.differences,function(){if(0<k.differences.differences.length)for(var t=0;t<k.differences.differences.length;t++)k.all_differences=$.grep(k.all_differences,function(e){return e.id!=k.differences.differences[t].differences_id})}()}),k.differences={images:[],differences:[],user_id:k.user.id},k.differences_images=[],s.add_differences=function(){k.selected_differences&&(k.all_differences=$.grep(k.all_differences,function(e){return e.id!=k.selected_differences.id}),k.selected_differences.day=!0,k.selected_differences.vfr=!0,k.differences.differences.push(k.selected_differences),delete k.selected_differences)},s.remove_differences=function(e){k.all_differences.push(k.differences.differences[e]),k.differences.differences.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){k.differences.images=$.grep(k.differences.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);LicenceService.DeleteTmp(e.saved_url).then(function(e){e.success&&(k.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,k.differences_images.push(e[t].file)}},s.save_differences=function(){if(k.differences_images.length<1&&k.differences.images.length<1)return h.highlightField(".drop"),h.warning("Image Required","You must at least have 1 image of the differences page of your log book!"),!1;if(k.differences.differences.length<1)return h.highlightField("differences"),h.warning("Differences Required","You must at least have 1 differences to be able to save the image(s) above!"),!1;for(var e=0;e<k.differences.images.length;e++)delete k.differences.images[e].data_uri;k.differences.user_id=k.user.id,k.differences.images=k.differences.images.concat(k.differences_images),b.Update(k.differences).then(function(e){e.success?(h.success("Differences Saved","Differences saved successfully!"),c.go("dashboard.my_account",{},{reload:!0})):h.error("Save Failed","Something went terribly wrong: "+e.message)})}}function ManageLicenceController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k){var y=this;switch(y.licence_images=[],y.licence={images:[],ratings:[]},y.user=r.globals.currentUser,y.user_id=y.user.id,b.GetLicenceTypes().then(function(e){y.licence_types=e}),b.GetRatings().then(function(e){y.ratings=e,"add"==c.current.data.action&&(y.selected_rating=$.grep(y.ratings,function(e){return 7==e.id})[0],s.add_rating())}),b.GetAuthority().then(function(e){y.authority=e}),c.current.data.action){case"add":break;case"edit":b.GetById(l.licence_id,1,0).then(function(e){if(e.success){y.licence=e.licence,y.licence.licence_issue_date=new Date(y.licence.licence_issue_date),y.licence.licence_expiry_date=new Date(y.licence.licence_expiry_date),y.licence.licence_type=$.grep(y.licence_types,function(e){return e.id==y.licence.licence_id})[0],y.licence.state_of_issue=$.grep(y.authority,function(e){return e.id==y.licence.authority_id})[0];for(var t=0;t<y.licence.ratings.length;t++)delete y.licence.ratings[t].id,y.licence.ratings[t].id=y.licence.ratings[t].rating_id,delete y.licence.ratings[t].rating_id,y.licence.ratings[t].test_date=new Date(y.licence.ratings[t].test_date),y.licence.ratings[t].expiry_date=new Date(y.licence.ratings[t].expiry_date),y.ratings=$.grep(y.ratings,function(e){return e.id!=y.licence.ratings[t].id})}});break;case"list":b.GetByUserId(y.user.id).then(function(e){e.success&&(y.user_licences=e.licences)})}s.add_rating=function(){y.ratings=$.grep(y.ratings,function(e){return e.id!=y.selected_rating.id}),y.licence.ratings.push(y.selected_rating),delete y.selected_rating},s.remove_rating=function(e){y.ratings.push(y.licence.ratings[e]),y.licence.ratings.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){y.licence.images=$.grep(y.licence.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(y.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,y.licence_images.push(e[t].file)}},s.delete_licence=function(t){"YES"==prompt("Are you sure you wish to delete this licence? \n\n This change is irreversible! To confirm please type YES in the box below.")&&b.Delete(y.user.id,t).then(function(e){e.success?(y.user_licences=$.grep(y.user_licences,function(e){return e.id!=t}),c.reload(),c.go("dashboard.my_account.licence")):k.error("Delete Failed","Something went terribly wrong: "+e.message)})},y.show_loading=!1,y.blurred=!0,y.show_temp_login=!1,s.getDecrypted=function(){y.show_loading=!0,b.GetById(l.licence_id,1,1).then(function(e){if(e.success){y.licence=e.licence,y.licence.licence_issue_date=new Date(y.licence.licence_issue_date),y.licence.licence_expiry_date=new Date(y.licence.licence_expiry_date),y.licence.licence_type=$.grep(y.licence_types,function(e){return e.id==y.licence.licence_id})[0],y.licence.state_of_issue=$.grep(y.authority,function(e){return e.id==y.licence.authority_id})[0];for(var t=0;t<y.licence.ratings.length;t++)delete y.licence.ratings[t].id,y.licence.ratings[t].id=y.licence.ratings[t].rating_id,delete y.licence.ratings[t].rating_id,y.licence.ratings[t].test_date=new Date(y.licence.ratings[t].test_date),y.licence.ratings[t].expiry_date=new Date(y.licence.ratings[t].expiry_date),y.ratings=$.grep(y.ratings,function(e){return e.id!=y.licence.ratings[t].id});y.show_loading=!1,y.blurred=!1}else"templogin"==e.fail&&(y.show_temp_login=!0),y.show_loading=!1})},s.re_login=function(){h.Login3(y.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(s.getDecrypted(),y.show_temp_login=!1):k.error("Wrong Password","This is the wrong password - please try again...")})},s.save_licence=function(e){if(y.show_loading=!0,y.licence_images.length<1&&y.licence.images.length<1)return k.highlightField(".drop"),k.warning("Image Required","You must at least have 1 image of your licence!"),y.show_loading=!1;if(!y.licence.licence_type)return k.highlightField("licence_type"),k.warning("Licence Type Required","You must select a licence type"),y.show_loading=!1;if(!y.licence.state_of_issue)return k.highlightField("state_of_issue"),k.warning("State Required","You must select a licence state of issue"),y.show_loading=!1;if(y.licence.ratings.length<1)return k.highlightField("ratings"),k.warning("Rating Required","You must at least have 1 rating!"),y.show_loading=!1;for(var t=0;t<y.licence.images.length;t++)delete y.licence.images[t].data_uri;y.licence.images=y.licence.images.concat(y.licence_images),y.licence.licence_id=y.licence.licence_type.id,y.licence.authority_id=y.licence.state_of_issue.id,y.licence.user_id=y.user.id,delete y.licence.licence_type,delete y.licence.state_of_issue,y.licence.id?b.Update(y.licence).then(function(e){e.success?c.go("dashboard.my_account.licence",{},{reload:!0}):k.error("Update Failed","Something went terribly wrong: "+e.message),y.show_loading=!1}):b.Create(y.licence).then(function(e){e.success?(c.reload(),y.show_loading=!1,c.go("dashboard.my_account.licence",{},{reload:!0})):(k.error("Create Failed","Something went terribly wrong: "+e.message),y.show_loading=!1)})}}function ManageMedicalController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k){var y=this;switch(y.medical_images=[],y.medical={images:[],components:[]},y.user=a.globals.currentUser,y.user_id=y.user.id,h.GetMedicalTypes().then(function(e){y.medical_types=e}),h.GetAuthority().then(function(e){y.authority=e}),h.GetComponents().then(function(e){y.components=e}),l.current.data.action){case"add":break;case"edit":h.GetById(d.medical_id,1,0).then(function(e){if(e.success){y.medical=e.medical,y.medical.examination_date=new Date(y.medical.examination_date),y.medical.state_of_issue=$.grep(y.authority,function(e){return e.id==y.medical.authority_id})[0];for(var t=0;t<y.medical.components.length;t++)delete y.medical.components[t].id,y.medical.components[t].id=y.medical.components[t].component_id,delete y.medical.components[t].component_id,y.medical.components[t].expiry_date=new Date(y.medical.components[t].expiry_date),y.components=$.grep(y.components,function(e){return e.id!=y.medical.components[t].id})}});break;case"list":h.GetByUserId(y.user.id).then(function(e){e.success&&(y.user_medicals=e.medicals)})}c.add_component=function(){y.components=$.grep(y.components,function(e){return e.id!=y.selected_component.id}),y.medical.components.push(y.selected_component),delete y.selected_component},c.remove_component=function(e){y.components.push(y.medical.components[e]),y.medical.components.splice(e,1)},c.popup=[],c.open=function(e,t){c.popup[e]&&1==c.popup[e].opened?(t.preventDefault(),t.stopPropagation()):c.popup[e]={opened:!0}},c.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],c.format=c.formats[0],c.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},c.remove_real_file=function(t){y.medical.images=$.grep(y.medical.images,function(e){return e.id!=t.id})},y.show_loading=!1,y.blurred=!0,y.show_temp_login=!1,c.getDecrypted=function(){y.show_loading=!0,h.GetById(d.medical_id,1,1).then(function(e){if(e.success){y.medical=e.medical,y.medical.examination_date=new Date(y.medical.examination_date),y.medical.state_of_issue=$.grep(y.authority,function(e){return e.id==y.medical.authority_id})[0];for(var t=0;t<y.medical.components.length;t++)delete y.medical.components[t].id,y.medical.components[t].id=y.medical.components[t].component_id,delete y.medical.components[t].component_id,y.medical.components[t].expiry_date=new Date(y.medical.components[t].expiry_date),y.components=$.grep(y.components,function(e){return e.id!=y.medical.components[t].id});y.blurred=!1,y.show_loading=!1}else"templogin"==e.fail&&(y.show_temp_login=!0),y.show_loading=!1})},c.re_login=function(){n.Login3(y.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(c.getDecrypted(),y.show_temp_login=!1):k.error("Wrong Password","This is the wrong password - please try again...")})},c.remove_file=function(e,t){e=JSON.parse(e.file_return);h.DeleteTmp(e.saved_url).then(function(e){e.success&&(y.medical_images=[],c.processFiles(t))})},c.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,y.medical_images.push(e[t].file)}},c.delete_medical=function(t){"YES"==prompt("Are you sure you wish to delete this medical? \n\n This change is irreversible! To confirm please type YES in the box below.")&&h.Delete(y.user.id,t).then(function(e){e.success?(y.user_medicals=$.grep(y.user_medicals,function(e){return e.id!=t}),l.reload(),l.go("dashboard.my_account.medical")):k.error("Delete Failed","Something went terribly wrong: "+e.message)})},c.save_medical=function(e){if(y.show_loading=!0,y.medical_images.length<1&&y.medical.images.length<1)return k.highlightField(".drop"),k.warning("Image Required","You must at least have 1 image of your medical!"),y.show_loading=!1;if(!y.medical.state_of_issue)return k.highlightField("state_of_issue"),k.warning("State Required","You must select a medical state of issue"),y.show_loading=!1;if(y.medical.components.length<1)return k.highlightField("components"),k.warning("Component Required","You must at least have 1 component!"),y.show_loading=!1;for(var t=0;t<y.medical.images.length;t++)delete y.medical.images[t].data_uri;y.medical.images=y.medical.images.concat(y.medical_images),y.medical.authority_id=y.medical.state_of_issue.id,y.medical.user_id=y.user.id,delete y.medical.medical_type,delete y.medical.state_of_issue,y.medical.id?h.Update(y.medical).then(function(e){e.success?l.go("dashboard.my_account.medical",{},{reload:!0}):k.error("Update Failed","Something went terribly wrong: "+e.message),y.show_loading=!1}):h.Create(y.medical).then(function(e){e.success?(y.show_loading=!1,l.go("dashboard.my_account.medical",{},{reload:!0})):(k.error("Create Failed","Something went terribly wrong: "+e.message),y.show_loading=!1)})}}function ManageMyMembershipsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C,S){var x=this;switch(x.user=s.globals.currentUser,x.user_id=x.user.id,x.noks=[],x.requests=[],x.auto_renew=!1,d.current.data.action){case"add":a.GetAll().then(function(e){x.clubs=e});break;case"edit":t.GetOneForUser(u.membership_id).then(function(e){e.success&&(x.membership_now=e.membership,x.auto_renew=1==e.membership.auto_renew,e={user_id:x.user.id,club_id:x.membership_now.club_id,membership_id:u.membership_id},o.GetMemberCards(e).then(function(e){x.membership_now.cards=e.cards,x.membership_now.default_card=e.default_card}))});break;case"accept":n.GetRequestsById(u.request_id).then(function(e){e.success&&(x.this_req=e.request)});break;case"list":t.GetUserMemberships(x.user.id).then(function(e){e.success&&(x.memberships=e.memberships)}),O()}function O(){n.GetRequestsByUser(x.user.id).then(function(e){e.success&&(x.requests=e.requests)})}l.popup=[],l.open=function(e,t){l.popup[e]&&1==l.popup[e].opened?(t.preventDefault(),t.stopPropagation()):l.popup[e]={opened:!0}},l.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],l.format=l.formats[0],l.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},x.show_memberships=!1,l.set_club=function(){x.show_memberships=!0,n.GetAllByClubAvailable(x.club.id).then(function(e){x.memberships=e})},l.set_default_payment_method=function(e){t.UpdateOneByUser(u.membership_id,{default_payment_method:e}).then(function(e){t.GetOneForUser(u.membership_id).then(function(e){e.success&&(x.membership_now=e.membership,x.auto_renew=1==e.membership.auto_renew,e={user_id:x.user.id,club_id:x.membership_now.club_id,membership_id:u.membership_id},o.GetMemberCards(e).then(function(e){x.membership_now.cards=e.cards,x.membership_now.default_card=e.default_card}))})})},l.make_default_card=function(e){confirm("Are you sure you wish to make this card the default card?")&&(e={user_id:x.user.id,club_id:x.membership_now.club_id,card_id:e.stripe_id},o.UpdateDefaultCard(e).then(function(e){e.success&&(x.membership_now.cards=e.cards,x.membership_now.default_card=e.default_card)}))},l.delete_member_card=function(e){var t;confirm("Are you sure you wish to delete this card?")&&(t={user_id:x.user.id,club_id:x.membership_now.club_id,card_id:e.stripe_id},o.DeleteMemberCard(t).then(function(e){e.success&&o.GetMemberCards(t).then(function(e){x.membership_now.cards=e.cards})}))},l.delete_request=function(e){n.DeleteRequest(e).then(function(e){O()})},l.set_membership=function(){x.show_confirmation=!0,o.GetByUserId(x.user.id).then(function(e){x.cards=e.cards})},l.set_card=function(){},l.accept_it=function(){if(!x.club_tnc)return S.warning("Terms Required","You need to access the terms of the flight organisation prior to continuing!"),!1;var e={club_id:x.this_req.club_id,user_id:x.user_id,request_id:x.this_req.id};n.AcceptRequest(x.this_req.id,e).then(function(e){y.put("gcl_sess",e.mandate.session),y.put("gcl_member_accepted",!0),window.location=e.mandate.link})},l.update_it=function(){var e={auto_renew:1==x.auto_renew?1:0};t.UpdateOneByUser(u.membership_id,e).then(function(e){})},l.edit_membership=function(e){d.go("dashboard.my_account.memberships.edit",{membership_id:e})};l.create_direct_debit=function(){};x.change_direct_debit=function(){var e={user_id:x.user.id,club_id:x.membership_now.club_id,membership_id:u.membership_id};v.GenerateUpdateLink(e).then(function(e){e.success?(y.put("gcl_sess",e.session),y.put("gcl_member_accepted",!0),window.location=e.link):S.error("Direct Debit Error","An error occurred when generating the link to update your direct debit instructions - please contact support@toaviate.com")})},x.show_add_card=!1,l.add_card=function(){var e={club_id:x.membership_now.club_id,user_id:x.user.id};x.show_add_card=!0,o.CreateNewCustomer(e).then(function(e){var o=Stripe(C.getStripeKey()),e={clientSecret:e.secret,appearance:{}},i=o.elements(e);i.create("payment",{layout:"tabs"}).mount("#payment-element"),document.getElementById("payment-form").addEventListener("submit",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),e.next=3,o.confirmSetup({elements:i,confirmParams:{return_url:window.location.href}});case 3:n=e.sent,(n=n.error)&&(document.querySelector("#error-message").textContent=n.message);case 6:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}())})},x.try_charge_default_card=function(){S.success("Processing","Initiating card charge.");var e={invoice_id:55,card_id:x.membership_now.cards[1].stripe_id,last4:x.membership_now.cards[1].last4};o.CreatePaymentIntent(e).then(function(e){})},l.save_added_card=function(){x.user.id,x.membership_now.club_id,u.membership_id;x.show_add_card=!1},l.get_icon=function(e){var e=e&&e.name?e.name:e,t="";switch(!0){case-1<(e=(e=e||"other.other").split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},l.downloadClubDocument=function(e){$.param({id:e});if(!e)return S.warning("Document Unavailable","Sorry - it looks like this flight organisation hasn't yet uploaded their document - please contact them to upload it to ToAviate."),!1;e=e.replace(/^.*[\\\/]/,"");w.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",w.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){p.info("saveBlob method failed with the following exception:"),p.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){p.info("Download link method with simulated click failed with the following exception:"),p.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){p.info("Download link method with window.location failed with the following exception:"),p.info(e)}}}o||(p.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){S.error("Download Failed","This file is not available at the moment - please contact the flight organisation.")})},l.request=function(){var e;x.club_tnc&&x.card_tnc&&x.club.id&&x.membership.id?(S.success("Thank You","Your request has been submitted."),e={user_id:x.user.id,club_id:x.club.id,membership_id:x.membership.id,requested_by:"user",paid:0},n.SendRequest(e).then(function(e){e.success&&(y.put("gcl_sess",e.mandate.session),window.location=e.mandate.link)})):S.warning("Missing Fields","Please fill all fields.")}}function ManageMyMembershipsDirectDebitController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v){var w=this;w.user=s.globals.currentUser,w.user_id=w.user.id,w.success=!0,"direct_debit"===d.current.data.action&&(c={mandate:c.search().redirect_flow_id,session:v.get("gcl_sess"),member_accepted:!1},v.get("gcl_member_accepted")&&(c.member_accepted=!0),y.SetupMandate(c).then(function(e){e.success?(w.club=e.club,w.success=!0):w.success=!1}))}function ManageNokController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var k=this;switch(k.user=r.globals.currentUser,k.user_id=k.user.id,k.noks=[],k.clearFieldError=h.clearFieldError,c.current.data.action){case"add":break;case"edit":b.GetById(l.nok_id).then(function(e){e.success&&(k.nok=e.nok)});break;case"list":b.GetByUserId(k.user.id).then(function(e){e.success&&(k.noks=e.noks)})}s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.delete_nok=function(e){"YES"==prompt("Are you sure you wish to delete this nok? \n\n This change is irreversible! To confirm please type YES in the box below.")&&b.Delete(k.user.id,e).then(function(e){e.success?c.go("dashboard.my_account.nok",{},{reload:!0}):h.error("Delete Failed","Something went terribly wrong: "+e.message)})},s.save_nok=function(e){var t=[{ok:k.nok.first_name,field:"first_name",label:"First Name"},{ok:k.nok.last_name,field:"last_name",label:"Last Name"},{ok:k.nok.phone_number,field:"phone_number",label:"Phone Number"},{ok:k.nok.relationship,field:"relationship",label:"Relationship"},{ok:k.nok.address,field:"address",label:"Address"}];if(!h.validateForm(t))return!1;k.nok.user_id=k.user.id,k.nok.id?b.Update(k.nok).then(function(e){e.success?(h.success("Saved","Next of kin updated successfully."),c.go("dashboard.my_account.nok",{},{reload:!0})):h.error("Update Failed","Something went terribly wrong: "+e.message)}):b.Create(k.nok).then(function(e){e.success?(h.success("Saved","Next of kin created successfully."),c.go("dashboard.my_account.nok",{},{reload:!0})):h.error("Create Failed","Something went terribly wrong: "+e.message)})}}function ManagePaymentsAddController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k){var y=this;function v(){b.GetUserForPayment(y.user.id).then(function(e){e.success&&(y.cards=e.cards,y.customer_token=e.token,c.iframe_url=t.trustAsResourceUrl("https://hosted.sandbox.paybase.io/card?t="+y.customer_token))})}y.poid_images=[],y.poid={images:[]},y.user=a.globals.currentUser,y.user_id=y.user.id,y.customer_token="",c.iframe_url="",c.get_addresses=function(){b.GetAddresses(y.postcode).then(function(e){e.success&&(y.addresses=e.addresses)})},c.add_card=function(){createToken()},c.delete_card=function(e){"YES"==prompt("Please write YES to confirm you wish to delete the card")&&b.Delete(e,y.user.id).then(function(e){b.GetByUserId(y.user.id).then(function(e){e.success&&(y.cards=e.cards)})})};document.querySelector(".errors"),document.querySelector(".success");window.addEventListener("message",function(e){var t=e.data;switch(t.type){case"success":b.Create2(y.user.id,t.id).then(function(e){e.success&&l.go("dashboard.my_account.payment_methods",{},{reload:!0})});break;case"error":switch(t.code){case"5002":k.error("Card Declined","Your card was declined, please verify your details or contact your card provider. Should this problem persist, please contact: info@toaviate.com");break;case"4060":k.warning("Duplicate Card","It appears that you are adding a card that has already been added to your account");break;default:k.error("Card Error","Please check your card details are correct and match your billing address.")}v()}}),v()}function ManagePaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k){var y=this;y.poid_images=[],y.poid={images:[]},y.user=a.globals.currentUser,y.user_id=y.user.id,y.customer_token="",c.iframe_url="",y.change_address=!1,y.billing_address={flatNumber:"",houseNameNumber:"",townCity:"",region:"",postalCode:"",countryISO:""},y.change_address_for="",c.change_address=function(e){y.change_address_for=e,b.GetCardDetails(e).then(function(e){e&&(y.billing_address=e.billingAddress,y.change_address=!0)})},c.save_address=function(){b.UpdateCard(y.change_address_for,y.billing_address).then(function(e){e&&(y.billing_address={flatNumber:"",houseNameNumber:"",townCity:"",region:"",postalCode:"",countryISO:""},k.success("Address Saved","Address saved successfully."),y.change_address=!1)})},c.decline_change=function(){y.change_address=!1},c.get_addresses=function(){},c.changePrimary=function(e){b.ChangePrimary(y.user.id,e).then(function(e){e.success&&k.success("Card Updated","Changed primary card!")})},c.add_card=function(){createToken()},c.delete_card=function(e){"YES"==prompt("Please write YES to confirm you wish to delete the card")&&b.Delete(e,y.user.id).then(function(e){b.GetByUserId(y.user.id).then(function(e){e.success&&(y.cards=e.cards)})})},b.GetByUserId(y.user.id).then(function(e){e.success&&(y.cards=e.cards)})}function ManagePoidController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k){var y=this;switch(y.poid_images=[],y.poid={images:[]},y.user=r.globals.currentUser,y.user_id=y.user.id,c.current.data.action){case"add":break;case"edit":b.GetById(l.poid_id,1,0).then(function(e){e.success&&(y.poid=e.poid,y.poid.expiry_date=new Date(y.poid.expiry_date))});break;case"list":b.GetByUserId(y.user.id).then(function(e){e.success&&(y.user_poids=e.poids)})}s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){y.poid.images=$.grep(y.poid.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(y.poid_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,y.poid_images.push(e[t].file)}},y.show_loading=!1,y.blurred=!0,y.show_temp_login=!1,s.getDecrypted=function(){y.show_loading=!0,b.GetById(l.poid_id,1,1).then(function(e){e.success?(y.poid=e.poid,y.poid.expiry_date=new Date(y.poid.expiry_date),y.blurred=!1):"templogin"==e.fail&&(y.show_temp_login=!0),y.show_loading=!1})},s.re_login=function(){h.Login3(y.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(s.getDecrypted(),y.show_temp_login=!1):k.error("Wrong Password","This is the wrong password - please try again.")})},s.delete_poid=function(t){"YES"==prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")&&b.Delete(y.user.id,t).then(function(e){e.success?(y.user_poids=$.grep(y.user_poids,function(e){return e.id!=t}),c.reload(),c.go("dashboard.my_account.poid")):k.error("Error",e.message)})},s.save_poid=function(){if(y.show_loading=!0,y.poid_images.length<1&&y.poid.images.length<1)return k.highlightField(".drop"),k.warning("Image Required","You must at least have 1 image of your poid!"),y.show_loading=!1;if(!y.poid.expiry_date)return k.highlightField("expiry_date"),k.warning("Expiry Required","You must enter an expiry date for your ID."),y.show_loading=!1;if(!y.poid.title)return k.highlightField("title"),k.warning("ID Type Required","You must enter an ID Type."),y.show_loading=!1;for(var e=0;e<y.poid.images.length;e++)delete y.poid.images[e].data_uri;y.poid.images=y.poid.images.concat(y.poid_images),y.poid.user_id=y.user.id,y.poid.id?b.Update(y.poid).then(function(e){e.success?(y.show_loading=!1,k.success("Saved","Your changes have been saved."),c.go("dashboard.my_account.poid",{},{reload:!0})):(k.error("Error",e.message),y.show_loading=!1)}):b.Create(y.poid).then(function(e){e.success?(y.show_loading=!1,c.go("dashboard.my_account.poid",{},{reload:!0})):(k.error("Error",e.message),y.show_loading=!1)})}}function ModalInstanceCtrl(e,t,n,o){var i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;e.warning=o,e.params=i,e.images=i.images,e.ok=function(){t.close(i)},e.cancel=function(){t.dismiss("cancel")},e.params=function(e){return e}}function MyAccountController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g){this.user=r.globals.currentUser}function MyJourneyLogsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v,w,C){var S=this;function x(e,t,n){t=t.toLowerCase(),n=n.toLowerCase(),e=e.toLowerCase();return 2<e.length&&-1<t.indexOf(e)||2<e.length&&-1<n.indexOf(e)}function O(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}S.clubs=[],S.user=r.globals.currentUser,S.user_id=S.user.id,S.looking_for=l.registration,S.looking_for&&(s.my_search2=S.looking_for),S.defect_severity,S.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],v.GetMyJourneyLogs(l.plane_id,0,25).then(function(e){S.logs=e.logs,S.user_totals=e.user_totals,S.aircraft=e.aircraft}),S.current_offset=0,S.loaded_per_batch=25,S.all_loaded=!1,S.load_more=function(){S.current_offset=S.current_offset+S.loaded_per_batch,v.GetMyJourneyLogs(l.plane_id,S.current_offset,S.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return S.logs.push(e)}):S.all_loaded=!0})},S.get_initial=function(e){return e.charAt(0)},S.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},S.list_pilots=function(e){var t="",n="",t="PIC: "+S.get_pic(e),n=S.get_put(e);return w.getTrustedHtml("<div>"+(t=t&&""==t?"No PIC set yet!":t)+" "+(n=n&&""!==n?"<br />PUT: "+n:n)+"</div>")},S.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=S.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=S.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=S.get_initial(e.first_name)+". "+e.last_name),t},S.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=S.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=S.get_initial(e.first_name)+". "+e.last_name),t},s.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},S.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return!s.my_search2||""==s.my_search2||(!!function(e,t){if(!(e.length<2)){if(e&&e.length<=3)return-1<t.indexOf(e);var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return 1;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return 1}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return 1}}}(s.my_search2,e.flight_date)||(t=e.first_name,n=e.last_name,o=s.my_search2,i=o.toLowerCase(),n=(n=t+" "+n).toLowerCase(),2<o.length&&-1<n.indexOf(i)||(o=e.aircraft.registration,n=s.my_search2,i=n.toLowerCase().replace("-",""),o=(o=o.replace("-","")).toLowerCase(),2<n.length&&-1<o.indexOf(i)||(!!x(s.my_search2,e.departure_airport,e.departure_airport_code)||!!x(s.my_search2,e.destination_airport,e.destination_airport_code)))));var t,n,o,i},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},s.downloadDocument=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){O(e,n)}).error(function(e,t){C.error("Download Failed","There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){O(e,n)}).error(function(e,t){C.error("Download Failed","There was an error downloading the selected document(s).")})},s.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function NewChargeModalInstanceCtrl(o,t,e,n,i,r,a,s){var c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:null,l=9<arguments.length?arguments[9]:void 0,d=10<arguments.length?arguments[10]:void 0;function u(){for(var e=0,t=0,n=0;n<o.items.length;n++)o.items[n].total=o.items[n].quantity*o.items[n].price,0<o.items[n].vat&&(this_vat=o.items[n].total*(o.items[n].vat/100),t+=this_vat),e+=o.items[n].total;o.the_vat=t,o.the_total=e}o.warning=n,o.params=c,o.to_refund=0,o.reason="",o.club_id=a.globals.currentUser.current_club_admin.id,o.club_settings={},o.new_client={first_name:"",last_name:"",email:""},o.items=[],o.item={title:"",quantity:0,vat:0,price:0},o.selected_client,o.selected_card,o.members=[],o.show_direct_debit_details=!1,r.GetById(o.club_id).then(function(e){o.club_settings=e,o.item.vat=o.club_settings.vat_rate,o.club_settings.vat_registered=1==o.club_settings.vat_registered}),i.GetAllByClub(o.club_id).then(function(e){o.members=e,o.members.unshift({id:-12,first_name:"New",last_name:"Client"})}),o.delete_receipt=function(e){o.items.splice(e,1),u()},o.card_selected=function(e){-12==(o.selected_card=e).id&&setTimeout(function(){f()},1e3)},o.member_selected=function(e){(o.selected_client=e)&&e.account_ending&&""!==e.account_ending?o.show_direct_debit_details=!0:(o.show_direct_debit_details=!1,setTimeout(function(){f()},1e3)),e&&-12==e.id&&setTimeout(function(){f()},1e3)},o.add_item=function(e){o.item=e,o.items.push(o.item),o.item={quantity:0,price:0,vat:o.club_settings.vat_rate,title:""},u()},o.ok=function(){if(!o.items||o.items.length<1)d.error("No Items","Please add at least one item to the invoice.");else if(o.selected_client&&o.selected_client.id){if(-12==o.selected_client.id){if(!o.new_client.first_name||!o.new_client.first_name.trim())return void d.error("Missing: First Name","Please enter the new client's first name.");if(!o.new_client.last_name||!o.new_client.last_name.trim())return void d.error("Missing: Last Name","Please enter the new client's last name.");if(!o.new_client.email||!o.new_client.email.trim())return void d.error("Missing: Email","Please enter the new client's email address.")}var e;-12==o.selected_client.id?(o.selected_client.first_name=o.new_client.first_name,o.selected_client.last_name=o.new_client.last_name,o.selected_client.email=o.new_client.email):(o.selected_client.first_name=o.selected_client.first_name,o.selected_client.last_name=o.selected_client.last_name,o.selected_client.email=o.selected_client.email),-12!=o.selected_client.id&&o.show_direct_debit_details?(e={payment:{},items:o.items,user:o.selected_client,club_id:o.club_id},""!==o.selected_client.account_ending&&(e.payment.direct_debit=!0),s.CreateCustom(e).then(function(e){e.success&&t.close(e)})):_.createToken(p,{}).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={payment:{brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,funding:e.token.card.funding,name:e.token.card.name,client_ip:e.token.client_ip},items:o.items,user:o.selected_client,club_id:o.club_id},s.CreateCustom(e).then(function(e){e.success&&t.close(e)}))})}else d.error("Missing: Client","Please select a client to charge.")},o.cancel=function(){t.dismiss("cancel")},o.params=function(e){return e};var _=Stripe(l.getStripeKeyLegacy()),p=_.elements().create("card",{hidePostalCode:!0,style:{base:{iconColor:"#666EE8",color:"#31325F",lineHeight:"40px",fontWeight:300,fontFamily:"Helvetica Neue",fontSize:"15px","::placeholder":{color:"#CFD7E0"}}}}),m=!1;function f(){clearTimeout(void 0),0==m&&(m=!0,p.mount("#card-element"),form=document.getElementById("payment-form"),form.addEventListener("submit",function(e){e.preventDefault(),createToken()}))}}function PassengerSignupCompleteController(a,e,t,s,c,l,d){s.checked_identity=!1,s.is_already_user=!1,s.submit_button="SUBMIT INFORMATION",s.formData={},s.formData.password&&""!==s.formData.password&&s.formData.password==s.formData.password2&&(s.submit_button="SUBMIT INFORMATION & CREATE YOUR ACCOUNT"),l.token?s.checked_identity||"/check"===c.current.url||c.go("passenger_signup_complete.check"):c.go("login"),s.gotologin=function(){c.go("login")},s.formcode=[],s.checkedcode=0,s.goToNextInput=function(e,t){var n=document.getElementById("index"+(t-1)).value;if(1!=t||91!=e.keyCode&&17!=e.keyCode||6!=n.toString().length){if(37==e.keyCode&&0<t)return document.getElementById("index"+(t-2)).focus(),!1;if(39==e.keyCode&&t<6)return document.getElementById("index"+t).focus(),!1;if(8==e.keyCode&&1<t&&""==document.getElementById("index"+(t-1)).value)return document.getElementById("index"+(t-2)).focus(),!1}else{for(var o=Array.from(n.toString()),i=0;i<6;i++)s.formcode.push(parseInt(o[i]));document.getElementById("index5").focus(),t=6}if(6==t&&6==s.formcode.length){var r=s.formcode.join("");return(s.checkedcode++,4<s.checkedcode)?(d.error("Too Many Attempts","Sorry - you have tried too many times, this code is now invalid and a new invitation will be sent to you."),!1):(a.GetPaxSecureInvite2(l.token,r).then(function(e){return e.success?e.invitation.is_already_user?(s.formData.user_id=e.invitation.user_id,s.formData.token=l.token,s.checked_identity=!0,void c.go("passenger_signup_complete.your_profile")):(d.error("Invitation Not Found","We couldn't match your invitation with our records - if you think you have an account, please go to the login screen and click the forgotten password link."),!1):(d.error("Error",e.message),!1)}),!1)}r=document.getElementById("index"+(t-1)).value;if(!(-1<r&&r<10&&""!==r))return document.getElementById("index"+(t-1)).value="",document.getElementById("index"+(t-1)).focus(),!1;document.getElementById("index"+t).focus()},s.submit_user_for_signup=function(){if(s.formData.password!==s.formData.password2||s.formData.password.length<8)return d.warning("Password Mismatch","Please ensure your password is at least 8 characters and both of these match"),!1;var e={user_id:s.formData.user_id,token:s.formData.token,password:s.formData.password};a.SignupUserFromPassenger(l.token,e).then(function(e){e.success?(s.formData={},s.checked_identity=!1,c.go("passenger_signup_complete.thank_you")):d.error("Error",e.message)})}}function PassengerSignupController(a,e,t,s,c,l,n,d){s.checked_identity=!1,s.is_already_user=!1,s.submit_button="SUBMIT INFORMATION",s.formData={},s.formData.password&&""!==s.formData.password&&s.formData.password==s.formData.password2&&(s.submit_button="SUBMIT INFORMATION & CREATE YOUR ACCOUNT"),l.token?s.checked_identity||"/check"===c.current.url||c.go("passenger_signup.check"):c.go("login");function o(e){return e=Date.now()-e.getTime(),e=new Date(e),Math.abs(e.getUTCFullYear()-1970)}s.guardian=!1,s.validate_age=function(){var e;i()&&(e=o(s.formData.dob),s.guardian=e<18)},s.next_of_kin=function(){if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),!1;c.go("passenger_signup.next_of_kin")};var i=function(){return!0};s.check_nok=function(){if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),!1;c.go("passenger_signup.tnc")},s.checkValid=function(e){return e=e||$(".btn-info").attr("one-ui-sref"),!!i()&&(s.formData.password!=s.formData.password2?($("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1):void c.go(e))},s.submit_passenger=function(){if(!(s.formData.first_name&&s.formData.last_name&&s.formData.email&&s.formData.dob))return d.warning("Incomplete Details","Please complete your personal details"),c.go("passenger_signup.your_profile"),!1;if(o(s.formData.dob)<18){if(!(s.formData.guardian&&s.formData.guardian.first_name&&s.formData.guardian.last_name&&s.formData.guardian.dob&&s.formData.guardian.guardianship))return d.warning("Guardian Required","As you are under the age of 18, your guardian needs to complete their details."),c.go("passenger_signup.your_profile"),!1;if(o(s.formData.guardian.dob)<18)return d.warning("Invalid Guardian","Your guardian needs to be over the age of 18 to legally enable you to go flying."),c.go("passenger_signup.your_profile"),!1}if(!(s.formData.nok&&s.formData.nok.first_name&&s.formData.nok.last_name&&s.formData.nok.email_address&&s.formData.nok.relationship&&s.formData.nok.phone_number&&s.formData.nok.address))return d.warning("Missing Next of Kin","Your next of kin information needs to be complete - in case of an emergency, or an accident, we must be able to contact them."),c.go("passenger_signup.next_of_kin"),!1;if(!s.formData.tnc||!s.formData.club_tnc)return d.warning("Terms Required","Please tick to confirm that you have read, understood and agreed to the terms and conditions of both the software and the flight organisation."),!1;new Date(s.formData.dob);s.formData.guardian&&(s.formData.guardian.dob=s.formData.guardian.dob.format("yyyy-MM-dd"));var e={user_id:s.formData.user_id,first_name:s.formData.first_name,last_name:s.formData.last_name,email:s.formData.email,dob:s.formData.dob.format("yyyy-MM-dd"),club_id:s.formData.club_id,club_tnc:s.formData.club_tnc,tnc:s.formData.tnc,nok:s.formData.nok,guardian:s.formData.guardian,booking_id:s.formData.booking_id,token:s.formData.token,membership_id:0,invited_by:s.formData.invited_by};a.ConfirmPaxInvite(l.token,e).then(function(e){return e.success?(s.formData={},void(s.checked_identity=!1)):(d.error("Error",e.message),!1)}),c.go("passenger_signup.thank_you")},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");n.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",n.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){$log.info("saveBlob method failed with the following exception:"),$log.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){$log.info("Download link method with simulated click failed with the following exception:"),$log.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){$log.info("Download link method with window.location failed with the following exception:"),$log.info(e)}}}o||($log.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){d.error("Download Failed","There was an error downloading the selected document(s).")})},s.formcode=[],s.checkedcode=0,s.goToNextInput=function(e,t){var n=document.getElementById("index"+(t-1)).value;if(1!=t||91!=e.keyCode&&17!=e.keyCode||6!=n.toString().length){if(37==e.keyCode&&0<t)return document.getElementById("index"+(t-2)).focus(),!1;if(39==e.keyCode&&t<6)return document.getElementById("index"+t).focus(),!1;if(8==e.keyCode&&1<t&&""==document.getElementById("index"+(t-1)).value)return document.getElementById("index"+(t-2)).focus(),!1}else{for(var o=Array.from(n.toString()),i=0;i<6;i++)s.formcode.push(parseInt(o[i]));document.getElementById("index5").focus(),t=6}if(6==t&&6==s.formcode.length){var r=s.formcode.join("");return(s.checkedcode++,4<s.checkedcode)?(d.error("Too Many Attempts","Sorry - you have tried too many times, this code is now invalid and a new invitation will be sent to you."),!1):(a.GetPaxSecureInvite(l.token,r).then(function(e){return e.success?(e.invitation.is_already_user?(s.is_already_user=!0,s.formData.user_id=e.invitation.user_id,s.formData.first_name=e.invitation.user.first_name,s.formData.last_name=e.invitation.user.last_name,s.formData.email=e.invitation.user.email,s.formData.dob=new Date(e.invitation.user.dob),s.formData.club=e.invitation.club,s.formData.guardian=e.invitation.user.guardian,s.formData.nok=e.invitation.user.nok,s.formData.membership_id=e.invitation.membership_id,s.formData.club_id=e.invitation.club_id,s.formData.token=e.invitation.invitation_token,s.formData.status=e.invitation.status,s.formData.invited_by=e.invitation.invited_by,s.formData.booking_id=e.invitation.booking_id,e.invitation.user.guardian&&""!==e.invitation.user.guardian.first_name&&(s.guardian=!0)):(s.formData.first_name=e.invitation.first_name,s.formData.last_name=e.invitation.last_name,s.formData.email=e.invitation.email,s.formData.membership_id=e.invitation.membership_id,s.formData.club_id=e.invitation.club_id,s.formData.token=e.invitation.invitation_token,s.formData.status=e.invitation.status,s.formData.invited_by=e.invitation.invited_by,s.formData.booking_id=e.invitation.booking_id,s.formData.club=e.invitation.club),s.checked_identity=!0,void c.go("passenger_signup.your_profile")):(d.error("Error",e.message),!1)}),!1)}r=document.getElementById("index"+(t-1)).value;if(!(-1<r&&r<10&&""!==r))return document.getElementById("index"+(t-1)).value="",document.getElementById("index"+(t-1)).focus(),!1;document.getElementById("index"+t).focus()}}function PasswordResetController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.show_error=!1,f.show_error2=!1,f.show_thankyou=!1,o.password_reset=function(){if(!f.email||""===f.email.trim())return m.highlightField("reset_email"),m.warning("Email Required","Please enter your email address."),!1;/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(f.email)?p.ResetPassword(f.email,function(e){f.show_thankyou=!0,f.show_error=!1}):(m.highlightField("reset_email"),m.warning("Invalid Email","Please enter a valid email address."),f.show_error=!0)},o.go_login=function(){n.path("/login")},o.password_reset2=function(){if(!f.password||""===f.password)return m.highlightField("new_password"),m.warning("Password Required","Please enter a new password."),!(f.show_error=!0);if(f.password.length<8)return m.highlightField("new_password"),m.warning("Password Too Short","Your password must be at least 8 characters."),!(f.show_error2=!0);var e=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!e.test(f.password))return m.highlightField("new_password"),f.show_error=!0,m.warning("Weak Password","Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1;p.ResetPassword2(f.password,r.token,function(e){f.show_thankyou=!0,f.show_error=!1,f.show_error2=!1,f.thank_you=e.message})}}function RefundModalInstanceCtrl(t,n,e,o){var i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null,r=5<arguments.length?arguments[5]:void 0;t.warning=o,t.params=i,t.to_refund=0,t.reason="",t.remaining=i.amount-i.amount_refunded,t.ok=function(){var e;!t.to_refund||t.to_refund<=0?(r.error("Missing: Refund Amount","Please enter an amount greater than zero to refund."),(e=document.querySelector('input[name="refund_amount"]'))&&(e.classList.add("field-error-highlight"),e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus())):t.to_refund>t.remaining?r.error("Invalid Amount","The refund amount cannot exceed "+t.remaining+"."):t.reason&&t.reason.trim()?((e=i).reason=t.reason,e.to_refund=t.to_refund,n.close(e)):r.error("Missing: Reason","Please provide a reason for this refund.")},t.cancel=function(){n.dismiss("cancel")},t.params=function(e){return e}}function RegisterController(e,t,n,o,i,r){var a=this;a.verify_status="",a.register=function(){a.user&&a.user.first_name&&""!==a.user.first_name.trim()?a.user.last_name&&""!==a.user.last_name.trim()?a.user.email&&""!==a.user.email.trim()?a.user.password&&""!==a.user.password?new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})").test(a.user.password)?(a.dataLoading=!0,e.Create(a.user).then(function(e){e.success?(r.success("Registration Successful","Please check your email to verify your account."),t.path("/registration_success")):(r.error("Registration Failed",e.error||"Something went wrong. Please try again."),a.dataLoading=!1)})):(r.highlightField("password"),r.warning("Weak Password","Your password must be at least 8 characters, containing 1 uppercase, 1 lowercase, 1 number, and 1 special character.")):(r.highlightField("password"),r.warning("Password Required","Please enter a password.")):(r.highlightField("email"),r.warning("Email Required","Please enter your email address.")):(r.highlightField("last_name"),r.warning("Last Name Required","Please enter your last name.")):(r.highlightField("first_name"),r.warning("First Name Required","Please enter your first name."))},i.token&&i.userId&&e.Verify(i.userId,i.token).then(function(e){e.success?(a.title="Thank You!",a.verify_status="Your email address has been verified."):(a.title="Sorry!",a.verify_status="Sorry - something went wrong here! Please try clicking the link your email again. Should this still be a problem, please contact support.")})}function ReviewBookingsController(e,t,i,n,o,r,a,s,c){var l=this;o.globals.currentUser||s.CheckLoggedIn().then(function(e){}),l.user=o.globals.currentUser,l.bookings=[],l.allUsers=[],l.clubs=[];var d=new Date,s=Math.floor(8),o=Math.floor(18);new Date(d.getFullYear(),d.getMonth(),d.getDate(),s,0,0),new Date(d.getFullYear(),d.getMonth(),d.getDate(),o,0,0);function u(){i.GetBookingsToReview(l.user.id).then(function(e){l.bookings=e.bookings})}function _(e){var n=jQuery.extend({},e);n.plane_id=e.resourceId,""!==e.instructor_id?(n.instructor_id=e.instructor_id,e.tuition_required&&(n.tuition_id=e.tuition_required.id)):n.instructor_id="0",delete n._start,delete n._end,delete n._id,delete n.source,delete n._allDay,delete n.allDay,delete n.className,delete n.plane,delete n.title,delete n.editable,delete n.resourceIds,n.update_rental_items=!0,i.updateBooking(n,l.user.id).then(function(e){var t;return 1==e.success?(1==n.edit_booking&&r.$parent.updateEvents(n.start,n.end),c.success("Changes Saved","Your changes were saved successfully")):(t=[],!0!==e.instructor?t.push({type:"instructor",message:"It looks like your instructor is not available on the updated date and time",api:e.instructor,override:"instructor_override"}):!0!==e.check_user?t.push({type:"check_user",message:"It looks like your user account does not allow this booking to happen",api:e.check_user,override:"currency_override"}):!0!==e.rental_items&&t.push({type:"rental_items",message:"It looks like some of the rental items are not available",api:e.rental_items,override:"update_rental_items"}),c.error("Booking Error","Error found in altering the booking"),l.booking_errors=t,l.error_event=n),e})}l.default_date=new Date,u(),r.all_events=[],r.all_resources=[],r.approve_booking=function(e){i.AcceptBooking(e,l.user.id).then(function(e){u()})},r.decline_booking=function(e){i.DeclineBooking(e,l.user.id,{}).then(function(e){u()})},r.view_booking=function(n,e){i.GetAllInstructor(l.user.id,e,"").then(function(e){$("#calendar").fullCalendar("gotoDate",l.default_date);var t=parseInt($("a.fc-timeline-event.booking"+n).css("left"))+parseInt($("a.fc-timeline-event.booking"+n).width())/2-$("tbody .fc-time-area .fc-scroller").width()/2;return $("tbody .fc-time-area .fc-scroller").animate({scrollLeft:t},600),r.all_events=e.events,r.all_resources=e.resources,$("a.fc-timeline-event.booking"+n).removeClass("highlight_item"),setTimeout(function(){$("a.fc-timeline-event.booking"+n).addClass("highlight_item")},200),e})},r.updateEvents=function(e,t){i.GetAllInstructor(l.user.id,e,t).then(function(e){return r.all_events=e.events,r.all_resources=e.resources,e})},r.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),$compile(t)(r)},r.alertOnClicked=function(e,t,n){l.see_booking=e,l.see_booking.start_date=moment(l.see_booking.start).format("DD/MM/YYYY"),l.see_booking.end_date=moment(l.see_booking.end).format("DD/MM/YYYY"),l.see_booking.start_time=moment(l.see_booking.start).format("HH:mm"),l.see_booking.end_time=moment(l.see_booking.end).format("HH:mm"),l.see_booking.start_datetime=new Date(new Date(l.see_booking.start).toUTCString()),l.see_booking.end_datetime=new Date(l.see_booking.end),l.see_booking.visible=1,l.see_booking.can_be_edited=moment().isAfter(moment(l.see_booking.end)),r.$apply()},r.changeLang=function(){r.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],r.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},r.changed=function(){$log.log("Time changed to: "+r.mytime),r.check_plane_availability()},r.check_plane_availability=function(){generate_datetimes();var o=1==l.new_booking.edit_booking?1:0,e=0<l.new_booking.plane_id?l.new_booking.plane_id:0;l.new_booking.plane&&l.new_booking.plane.id&&(e=l.new_booking.plane.id),i.GetAllPlanes(l.user.id,l.new_booking.start_datetime,l.new_booking.end_datetime,0,e).then(function(e){if(l.planes=e,1==o)for(var t=0;t<l.planes.length;t++)l.planes[t].id==l.new_booking.plane.id&&(n=0,l.new_booking.plane=l.planes[t],r.check_rental_items());else{var n=1;if(l.new_booking.plane){for(t=0;t<l.planes.length;t++)l.planes[t].id==l.new_booking.plane.id&&(n=0,r.check_rental_items());1==n&&(l.new_booking.plane={},delete l.new_booking.plane)}}})},r.events=[],r.addOne=function(){$state.go("dashboard.bookings.add")},r.cancel_changes=function(){},r.check_rental_items=function(){var e;generate_datetimes(),l.rental_items=[],l.new_booking.plane&&(e=(1==l.new_booking.edit_booking?l.new_booking:l.new_booking.plane).club_id,i.GetRentalItems(e,moment(l.new_booking.start_datetime).format("Y-M-D HH:mm"),moment(l.new_booking.end_datetime).format("Y-M-D HH:mm"),0).then(function(e){if(l.rental_items=e,l.new_booking.rental_items)for(var t=0;t<l.new_booking.rental_items;t++){for(var n=0,o=0;o<l.rental_items.length;o++)if(l.rental_items[o].id==l.new_booking.rental_items[t].id){parseInt(l.new_booking.rental_items[t].number_to_book)>parseInt(l.rental_items[o].number_available)&&(l.new_booking.rental_items[t].number_to_book=parseInt(l.rental_items[o].number_available)),l.new_booking.rental_items[t].number_available=parseInt(l.rental_items[o].number_available),n=1;break}0==n&&delete l.new_booking.rental_items[t]}for(var i=0;i<l.rental_items.length;i++)l.rental_items[i].number=0;if(l.new_booking.rental_items)for(o=0;o<l.new_booking.rental_items;o++){for(var r=1,t=0;t<l.rental_items.length;t++)l.rental_items[t].id==l.new_booking.rental_items[o].id&&(r=0);1==r&&delete l.new_booking.rental_items[o]}}))},r.update_booking=function(e){generate_datetimes(),e&&(e={},delete(e=jQuery.extend(!0,{},l.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,e.free_seats=l.new_booking.free_seats.constructor===Array?0:l.new_booking.free_seats,e.start=l.new_booking.start_datetime,e.end=l.new_booking.end_datetime,e.tuition_id=l.new_booking.tuition_required.id,e.user_id=l.user.id,e.instructor_id=l.new_booking.instructor?l.new_booking.instructor.id:0,e.plane_id=l.new_booking.plane.id,e.override=l.new_booking.override||0,e.club_id=l.new_booking.plane.club_id,_(e))},r.update_club=function(){l.club_id=l.change_club.id,i.GetAllUserClub(l.user.id,l.club_id,moment().format("Y-M-D"),"").then(function(e){r.all_events=e.events,r.all_resources=e.resources})},r.alertOnEventClick=function(e,t,n){r.alertMessage=e.title+" was clicked "},r.alertOnDrop=function(e,t,n,o,i,r){_(e)},r.alertOnResize=function(e,t,n,o,i,r){_(e)},r.override_booking_change=function(e){l.error_event[e]=!0,_(l.error_event)},r.decline_booking_change=function(){l.booking_errors={},l.error_event={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},r.wholeDay=function(){1==r.whole_day_booking?(r.whole_day_booking=!1,r.myDatetimeRange.time.from=480,r.myDatetimeRange.time.to=1080):(r.whole_day_booking=!0,r.myDatetimeRange.time.from=0,r.myDatetimeRange.time.to=1440)},r.changeView=function(e,t){uiCalendarConfig.calendars[t].fullCalendar("changeView",e)},r.renderCalender=function(e){$timeout(function(){uiCalendarConfig.calendars[e]&&uiCalendarConfig.calendars[e].fullCalendar("render")})}}function ShowGalleryController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;_.gallery={is_protected:"false",download_low:"false",download_medium:"false",download_high:"false",gallery_link:"",fullscreen:"false"},_.current={image:{link:"",description:"hi"},artpiece:{title:"",description:""},index:0},u.GetByUrl({gallery_link:c.gallery_link}).then(function(e){0<(_.gallery=e).images.length?("true"==e.is_disabled&&r.path("/disabled"),_.current.image.link=_.gallery.images[0].link,_.current.image.description=_.gallery.images[0].description,_.current.artpiece.title=_.gallery.images[0].artpiece.title,_.current.artpiece.description=_.gallery.images[0].artpiece.description,_.current.index=0):r.path("/disabled")}),l.login=function(){if(_.password_protected!=_.gallery.password)return!1;_.gallery.is_protected="false"};function p(e){_.current.image.link=_.gallery.images[e].link,_.current.image.description=_.gallery.images[e].description,_.current.artpiece.title=_.gallery.images[e].artpiece.title,_.current.artpiece.description=_.gallery.images[e].artpiece.description,_.current.index=e}l.change_image=function(e){p(e)},l.show_fullscreen=function(){$("#fullscreen").fadeIn(),$("p.viewport").hide()},l.hide_fullscreen=function(){$("#fullscreen").fadeOut(),$("p.viewport").show()},l.fullscreen_next=function(){var e=_.current.index+1;e>_.gallery.images.length-1&&(e=0),p(e)},l.fullscreen_previous=function(){var e=_.current.index-1;e<0&&(e=_.gallery.images.length-1),p(e)},l.download=function(e){u.DownloadZip({gallery_id:_.gallery.id,quality:e}).then(function(e){var t=document.createElement("a");t.download=e.zip_url,t.href=e.zip_url,t.click()})},l.remove_image=function(t){_.images=$.grep(_.images,function(e){return e.id!=t.id}),d.SetSelectedImages(_.images)},l.check_link_unique=function(){for(var e=0;e<_.all_galleries.length;e++)if(_.all_galleries[e].link===_.gallery.link)return!1},l.generate_gallery=function(){for(var e=0;e<_.images.length;e++)_.images[e].organise=e;_.gallery.images=_.images,u.Create(_.gallery).then(function(e){})}}function UpdateMyMembershipDirectDebitController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,k,y,v){var w=this;w.user=s.globals.currentUser,w.user_id=w.user.id,w.success=!0,w.return_id=u.membership_id,"direct_debit2"===d.current.data.action&&(u={mandate:c.search().redirect_flow_id,session:v.get("gcl_sess"),membership_id:u.membership_id},v.get("gcl_member_accepted")&&(u.member_accepted=!0),y.UpdateMandate(u).then(function(e){e.error?w.success=!1:(w.success=!0,d.go("dashboard.my_account.memberships.edit",{membership_id:w.return_id},{reload:!0}))}))}function UploadController(e,t,r,a,n,s){var c=this;a.tags=[],e.GetAll().then(function(e){c.all_keywords=e}),t.GetAll().then(function(e){c.artpieces=e}),a.loadTags=function(t){for(var e=$.grep(c.all_keywords,function(e){if(e.keyword.toLowerCase().startsWith(t.toLowerCase()))return!0}),n=[],o=0;o<e.length;o++){var i=(i=e[o].keyword).toLowerCase();n.push({id:e[o].id,text:i})}return n},a.CheckData=function(e){for(var t=[],n=e,o=0;o<n.length;o++){var i=n[o].file_return,i=JSON.parse(i);t.push(i.files.file.tmp_name)}e={images:t,keywords:a.tags,artpiece_id:c.artme};r.Create(e).then(function(e){s.path("/")})}}function UsersController(t,n,e,o,i,r){var a=this;a.update=function(e){"password"==a.user.password&&(a.user.password="");t.Update(a.user).then(function(e){e.success?(o.Success("Update successful",!0),n.path("/")):("Password entered failed"==e.message?r.error("Login Failed","The password entered was incorrect"):o.Error(e.error),a.dataLoading=!1)})},a.dataLoading=!1,a.default_pwd="password",t.GetById(i.userId).then(function(e){a.user=e.user})}function UserSignupController(e,t,n,o,i,r,a,s){r.params.verify&&e.Verify(r.params.user_id,r.params.verify).then(function(e){e.success?r.go("verified"):(s.error("Error",e.message),r.go("login"))}),i.clubs={clubs:[{id:1,title:"Alouette Flying Club"},{id:2,title:"EFG Flying Club"},{id:3,title:"Surrey & Kent Flying Club"},{id:4,title:"Arrow Flight Club"},{id:5,title:"Cirrus Flying Club"}]},i.memberships={memberships:[{id:1,title:"honory membership"},{id:2,title:"day membership"},{id:3,title:"social membership"},{id:4,title:"full flying membership"},{id:5,title:"temporary flying membership"}]},i.state={state:[{id:2,title:"France"},{id:3,title:"Netherlands"},{id:4,title:"Germany"},{id:5,title:"Spain"}]},i.licenses={licenses:[{id:1,title:"EASA PPL"},{id:2,title:"EASA CPL"},{id:3,title:"EASA ATPL"},{id:4,title:"UK NPPL"},{id:5,title:"FAA SPL"}]},i.medicals={medicals:[{id:1,title:"EASA MEDICAL"},{id:2,title:"UK MEDICAL EXAMINATION"},{id:3,title:"FAA MEDICAL"},{id:4,title:"NZ CAA MEDICAL"},{id:5,title:"FAA SPL MEDICAL"}]},i.person={},i.person.selectedSingle="Samantha",i.person.selectedSingleKey="5",i.people=[{name:"Adam",email:"adam@email.com",age:12,country:"United States"},{name:"Amalie",email:"amalie@email.com",age:12,country:"Argentina"},{name:"Estefana",email:"estefania@email.com",age:21,country:"Argentina"},{name:"Adrian",email:"adrian@email.com",age:21,country:"Ecuador"},{name:"Wladimir",email:"wladimir@email.com",age:30,country:"Ecuador"},{name:"Samantha",email:"samantha@email.com",age:30,country:"United States"},{name:"Nicole",email:"nicole@email.com",age:43,country:"Colombia"},{name:"Natasha",email:"natasha@email.com",age:54,country:"Ecuador"},{name:"Michael",email:"michael@email.com",age:15,country:"Colombia"},{name:"Nicols",email:"nicolas@email.com",age:43,country:"Colombia"}],i.ratings={ratings:[{id:1,title:"SEP (land)"},{id:2,title:"SEP (sea)"},{id:3,title:"MEP (land)"},{id:4,title:"MEP (sea)"},{id:1,title:"Night Rating"},{id:2,title:"Instrument Rating Restricted IR(r)"},{id:3,title:"Instrument Rating"},{id:4,title:"Aerobatics Rating"},{id:5,title:"High Performance Aircraft Rating"}]},i.differences={differences:[{id:1,title:"Variable Pitch"},{id:2,title:"Retractable Gear"},{id:3,title:"Turbo Differences Training"},{id:4,title:"EFIS Differences Training"}]},i.formData={license:{differences:[],ratings:[i.ratings.ratings[0]],add_to:{}},medical:{}},i.add_element=function(t){i[t][t]=$.grep(i[t][t],function(e){return e.id!=i.formData.license.add_to[t].id}),"differences"==t&&(i.formData.license.add_to[t].day=!0,i.formData.license.add_to[t].vfr=!0),i.formData.license[t].push(i.formData.license.add_to[t]),delete i.formData.license.add_to[t]},i.remove_element=function(e,t){i[e][e].push(i.formData.license[e][t]),i.formData.license[e].splice(t,1),i.formData.license[e]=i.formData.license[e].filter(Boolean)},i.checkValid=function(e){if(e&&""!=e||(e=$(".btn-info").attr("one-ui-sref")),i.formData.user.password!==i.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),s.warning("Password Mismatch","Your passwords do not match"),!1;var t=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!t.test(i.formData.user.password))return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),s.warning("Weak Password","Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1;if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),$("input:checkbox:not(:checked):required").addClass("ng-checkbox-unchecked"),!1;if(!i.formData.user)return r.go("user_signup.your_details"),!1;if(!i.formData.user.nok)return r.go("user_signup.next_of_kin"),!1;if(!i.formData.club)return r.go("user_signup.your_club"),!1;if(i.formData.tnc?$("input:checkbox:not(:checked)").removeClass("ng-checkbox-unchecked"):$("input:checkbox:not(:checked)").addClass("ng-checkbox-unchecked"),i.formData.user.password!=i.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1;"verify_account"==e?i.processForm():r.go(e)},i.processForm=function(){i.formData.$valid&&s.success("Form Valid","Your form is valid.")},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");t.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",t.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){$log.info("saveBlob method failed with the following exception:"),$log.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){$log.info("Download link method with simulated click failed with the following exception:"),$log.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){$log.info("Download link method with window.location failed with the following exception:"),$log.info(e)}}}o||($log.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){s.error("Download Failed","There was an error downloading the selected document(s).")})}}UserSignupController.$inject=["UserService","$http","$rootScope","$location","$scope","$state","$stateParams","ToastService"],UsersController.$inject=["UserService","$location","$rootScope","FlashService","$routeParams","ToastService"],UploadController.$inject=["KeywordsService","ArtpiecesService","ImageUploadService","$scope","$http","$location"],UpdateMyMembershipDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],ShowGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],ReviewBookingsController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$scope","$location","AuthenticationService","ToastService"],RegisterController.$inject=["UserService","$location","$rootScope","FlashService","$stateParams","ToastService"],RefundModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning"],PasswordResetController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","ToastService"],PassengerSignupController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$http","ToastService"],PassengerSignupCompleteController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","ToastService"],NewChargeModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","MemberService","ClubService","$rootScope","PaymentService"],MyJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce","ToastService"],MyAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService"],ModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning"],ManagePoidController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","PoidService","AuthenticationService","ToastService"],ManagePaymentsController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService","ToastService"],ManagePaymentsAddController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService","ToastService"],ManageNokController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","ToastService"],ManageMyMembershipsDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],ManageMyMembershipsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies","GoCardService","$http","EnvConfig","ToastService"],ManageMedicalController.$inject=["UserService","MemberService","AuthenticationService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","MedicalService","ToastService"],ManageLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","AuthenticationService","ToastService"],ManageDifferencesController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","DifferencesService","ToastService"],ManageAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","PaymentService","ToastService"],LoginController.$inject=["$location","AuthenticationService","FlashService","$timeout","ToastService"],KeywordsController.$inject=["UserService","KeywordsService","$location","$rootScope","FlashService","$routeParams","$scope"],KeywordController.$inject=["KeywordsService","UserService","JSTagsCollection","$scope"],InvitationsSignupController.$inject=["UserService","MemberService","GoCardService","$http","$rootScope","$location","$scope","$state","$stateParams","$cookies","$log","ToastService"],ImagesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService"],HomeController.$inject=["UserService","$rootScope","$location"],GalleriesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService","ToastService"],FinishAndPayController.$inject=["$sce","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService","EnvConfig","ToastService"],DashboardUserInstructorHolidayController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","ToastService"],DashboardUserInstructorController.$inject=["UserService","MemberService","InstructorService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","ToastService"],DashboardStudentRecordsController.$inject=["ClubService","UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService","MemberService","$sce","ToastService"],DashboardInstructorBriefController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService","ToastService"],DashboardCourseSyllabusViewController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],DashboardCourseSyllabusController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],DashboardController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$location","AuthenticationService","ToastService"],DashboardClubVouchersEditController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService","ToastService"],DashboardClubVouchersController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService","ToastService"],DashboardClubVouchersAddController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService","EnvConfig","ToastService"],DashboardClubShopSaleController.$inject=["$timeout","$sce","ExperiencesService","PaymentService","$scope","$rootScope","MemberService","ClubService","ShopItemService","$state","PackageService"],DashboardClubShopItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ShopItemService","ToastService"],DashboardClubSettingsController.$inject=["UserService","ClubService","PaymentService","$rootScope","$location","$scope","$state","$stateParams","$window","$http","$log","ToastService"],DashboardClubReceiptsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce","ToastService"],DashboardClubReceiptsApprovalController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce","ToastService"],DashboardClubPropellerLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http","ToastService","LogbookLinkService","WorkpackService"],DashboardClubPlanesController.$inject=["UserService","PlaneService","FoxService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ToastService"],DashboardClubPaymentsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ClubPaymentService","ToastService"],DashboardClubPackagesController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PackageService","PlaneService","ToastService"],DashboardClubMembershipsController.$inject=["UserService","MembershipService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","ToastService"],DashboardClubMembersController.$inject=["$sce","PaymentService","UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PackageService","ToastService"],DashboardClubMemberRequestsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies","ToastService"],DashboardClubMaintenanceController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","FoxService","$http","WorkpackService","CrsService","LogbookLinkService","ToastService"],DashboardClubLessonController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","ToastService"],DashboardClubItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","ToastService"],DashboardClubInvoicesController.$inject=["$sce","PaymentService","UserService","ClubService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],DashboardClubInstructorChargesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorCharges","ToastService"],DashboardClubInstructorBookings.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorService","ToastService"],DashboardClubFlyingController.$inject=["UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PaymentService","PackageService","BookoutService","ToastService"],DashboardClubFlightsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ToastService"],DashboardClubExperiencesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","ToastService"],DashboardClubExperienceDiscountsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","ToastService"],DashboardClubEngineLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http","ToastService","LogbookLinkService","WorkpackService"],DashboardClubCourseController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","ToastService"],DashboardClubAirframeLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http","ToastService","LogbookLinkService","WorkpackService"],CreateGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],ClubSignupController.$inject=["ClubService","MemberService","UserService","GoCardService","$rootScope","$location","$scope","$state","$stateParams","$cookies","$http","ToastService"],ClubPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],ClubDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","$http","ToastService"],ClaimAFlightController.$inject=["UserService","FoxService","$rootScope","$scope","$stateParams","$location"],CategoriesController.$inject=["UserService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope"],BookoutController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","InstructorCharges","PlaneService","$http","$cookieStore","AuthenticationService","CourseService","ToastService"],BookingsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService","ToastService"],Bookings2Controller.$inject=["UserService","BookoutService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService","ToastService"],BookinController.$inject=["$sce","UserService","MemberService","FoxService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService","PackageService","CourseService","$anchorScroll","smoothScroll","EnvConfig","ToastService"],ArtpiecesController.$inject=["UserService","CategoryService","ArtpiecesService","$location","$rootScope","FlashService","$routeParams","$scope","ToastService"],AllPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],AllInvoicesController.$inject=["$sce","PaymentService","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],AllDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],AircraftStatusController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","ToastService"],AircraftJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce","ToastService"],AddLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ToastService"],AccountController.$inject=["UserService","$rootScope","$location"],app.controller("AccountController",AccountController),AccountController.$inject=["UserService","$rootScope","$location"],app.controller("AddLicenceController",AddLicenceController),AddLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ToastService"],app.controller("AircraftJourneyLogsController",AircraftJourneyLogsController),AircraftJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce","ToastService"],app.controller("AircraftStatusController",AircraftStatusController),AircraftStatusController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","ToastService"],app.controller("AllDocumentsController",AllDocumentsController),AllDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],app.controller("AllInvoicesController",AllInvoicesController),AllInvoicesController.$inject=["$sce","PaymentService","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],app.controller("AllPaymentsController",AllPaymentsController),AllPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],app.controller("ArtpiecesController",ArtpiecesController),ArtpiecesController.$inject=["UserService","CategoryService","ArtpiecesService","$location","$rootScope","FlashService","$routeParams","$scope","ToastService"],app.controller("BookinController",BookinController),BookinController.$inject=["$sce","UserService","MemberService","FoxService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService","PackageService","CourseService","$anchorScroll","smoothScroll","EnvConfig","ToastService"],app.controller("Bookings2Controller",Bookings2Controller),Bookings2Controller.$inject=["UserService","BookoutService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService","ToastService"],app.controller("BookingsController",BookingsController),BookingsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService","ToastService"],app.controller("BookoutController",BookoutController),BookoutController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","InstructorCharges","PlaneService","$http","$cookieStore","AuthenticationService","CourseService","ToastService"],app.controller("CategoriesController",CategoriesController),CategoriesController.$inject=["UserService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope"],app.controller("ClaimAFlightController",ClaimAFlightController),ClaimAFlightController.$inject=["UserService","FoxService","$rootScope","$scope","$stateParams","$location"],app.controller("ClubDocumentsController",ClubDocumentsController),ClubDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","$http","ToastService"],app.controller("ClubPaymentsController",ClubPaymentsController),ClubPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],app.controller("ClubSignupController",ClubSignupController),ClubSignupController.$inject=["ClubService","MemberService","UserService","GoCardService","$rootScope","$location","$scope","$state","$stateParams","$cookies","$http","ToastService"],app.controller("CreateGalleryController",CreateGalleryController),CreateGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],app.controller("DashboardClubAirframeLogbookController",DashboardClubAirframeLogbookController),DashboardClubAirframeLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http","ToastService","LogbookLinkService","WorkpackService"],app.controller("DashboardClubCourseController",DashboardClubCourseController),DashboardClubCourseController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","ToastService"],app.controller("DashboardClubEngineLogbookController",DashboardClubEngineLogbookController),DashboardClubEngineLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http","ToastService","LogbookLinkService","WorkpackService"],app.controller("DashboardClubExperienceDiscountsController",DashboardClubExperienceDiscountsController),DashboardClubExperienceDiscountsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","ToastService"],app.controller("DashboardClubExperiencesController",DashboardClubExperiencesController),DashboardClubExperiencesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","ToastService"],app.controller("DashboardClubFlightsController",DashboardClubFlightsController),DashboardClubFlightsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ToastService"],app.controller("DashboardClubFlyingController",DashboardClubFlyingController),DashboardClubFlyingController.$inject=["UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PaymentService","PackageService","BookoutService","ToastService"],app.controller("DashboardClubInstructorBookings",DashboardClubInstructorBookings),DashboardClubInstructorBookings.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorService","ToastService"],app.controller("DashboardClubInstructorChargesController",DashboardClubInstructorChargesController),DashboardClubInstructorChargesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorCharges","ToastService"],app.controller("DashboardClubInvoicesController",DashboardClubInvoicesController),DashboardClubInvoicesController.$inject=["$sce","PaymentService","UserService","ClubService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","ToastService"],app.controller("DashboardClubItemsController",DashboardClubItemsController),DashboardClubItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","ToastService"],app.controller("DashboardClubLessonController",DashboardClubLessonController),DashboardClubLessonController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","ToastService"],app.controller("DashboardClubMaintenanceController",DashboardClubMaintenanceController),DashboardClubMaintenanceController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","FoxService","$http","WorkpackService","CrsService","LogbookLinkService","ToastService"],app.controller("DashboardClubMemberRequestsController",DashboardClubMemberRequestsController),DashboardClubMemberRequestsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies","ToastService"],app.controller("DashboardClubMembersController",DashboardClubMembersController),DashboardClubMembersController.$inject=["$sce","PaymentService","UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PackageService","ToastService"],app.controller("DashboardClubMembershipsController",DashboardClubMembershipsController),DashboardClubMembershipsController.$inject=["UserService","MembershipService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","ToastService"],app.controller("DashboardClubPackagesController",DashboardClubPackagesController),DashboardClubPackagesController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PackageService","PlaneService","ToastService"],app.controller("DashboardClubPaymentsController",DashboardClubPaymentsController),DashboardClubPaymentsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ClubPaymentService","ToastService"],app.controller("DashboardClubPlanesController",DashboardClubPlanesController),DashboardClubPlanesController.$inject=["UserService","PlaneService","FoxService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ToastService"],app.controller("DashboardClubPropellerLogbookController",DashboardClubPropellerLogbookController),DashboardClubPropellerLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http","ToastService","LogbookLinkService","WorkpackService"],app.controller("DashboardClubReceiptsApprovalController",DashboardClubReceiptsApprovalController),DashboardClubReceiptsApprovalController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce","ToastService"],app.controller("DashboardClubReceiptsController",DashboardClubReceiptsController),DashboardClubReceiptsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce","ToastService"],app.controller("DashboardClubSettingsController",DashboardClubSettingsController),DashboardClubSettingsController.$inject=["UserService","ClubService","PaymentService","$rootScope","$location","$scope","$state","$stateParams","$window","$http","$log","ToastService"],app.controller("DashboardClubShopItemsController",DashboardClubShopItemsController),DashboardClubShopItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ShopItemService","ToastService"],app.controller("DashboardClubShopSaleController",DashboardClubShopSaleController),DashboardClubShopSaleController.$inject=["$timeout","$sce","ExperiencesService","PaymentService","$scope","$rootScope","MemberService","ClubService","ShopItemService","$state","PackageService"],app.controller("DashboardClubVouchersAddController",DashboardClubVouchersAddController),DashboardClubVouchersAddController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService","EnvConfig","ToastService"],app.controller("DashboardClubVouchersController",DashboardClubVouchersController),DashboardClubVouchersController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService","ToastService"],app.controller("DashboardClubVouchersEditController",DashboardClubVouchersEditController),DashboardClubVouchersEditController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService","ToastService"],app.filter("asDate",function(){return function(e){return e&&""!==e?moment(e).toDate():""}}),app.controller("DashboardController",DashboardController),DashboardController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$location","AuthenticationService","ToastService"],app.controller("DashboardCourseSyllabusController",DashboardCourseSyllabusController),DashboardCourseSyllabusController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],app.controller("DashboardCourseSyllabusViewController",DashboardCourseSyllabusViewController),DashboardCourseSyllabusViewController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],app.controller("DashboardInstructorBriefController",DashboardInstructorBriefController),DashboardInstructorBriefController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService","ToastService"],app.controller("DashboardStudentRecordsController",DashboardStudentRecordsController),DashboardStudentRecordsController.$inject=["ClubService","UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService","MemberService","$sce","ToastService"],app.controller("DashboardUserInstructorController",DashboardUserInstructorController),DashboardUserInstructorController.$inject=["UserService","MemberService","InstructorService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","ToastService"],app.controller("DashboardUserInstructorHolidayController",DashboardUserInstructorHolidayController),DashboardUserInstructorHolidayController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","ToastService"],app.controller("FinishAndPayController",FinishAndPayController),FinishAndPayController.$inject=["$sce","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService","EnvConfig","ToastService"],app.controller("GalleriesController",GalleriesController),GalleriesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService","ToastService"],app.controller("HomeController",HomeController),HomeController.$inject=["UserService","$rootScope","$location"],app.controller("ImagesController",ImagesController),ImagesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService"],app.controller("InvitationsSignupController",InvitationsSignupController),InvitationsSignupController.$inject=["UserService","MemberService","GoCardService","$http","$rootScope","$location","$scope","$state","$stateParams","$cookies","$log","ToastService"],app.controller("KeywordController",KeywordController),KeywordController.$inject=["KeywordsService","UserService","JSTagsCollection","$scope"],app.controller("KeywordsController",KeywordsController),KeywordsController.$inject=["UserService","KeywordsService","$location","$rootScope","FlashService","$routeParams","$scope"],app.controller("LoginController",LoginController),LoginController.$inject=["$location","AuthenticationService","FlashService","$timeout","ToastService"],app.controller("ManageAccountController",ManageAccountController),ManageAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","PaymentService","ToastService"],app.controller("ManageDifferencesController",ManageDifferencesController),ManageDifferencesController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","DifferencesService","ToastService"],app.controller("ManageLicenceController",ManageLicenceController),ManageLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","AuthenticationService","ToastService"],app.controller("ManageMedicalController",ManageMedicalController),ManageMedicalController.$inject=["UserService","MemberService","AuthenticationService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","MedicalService","ToastService"],app.controller("ManageMyMembershipsController",ManageMyMembershipsController),ManageMyMembershipsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies","GoCardService","$http","EnvConfig","ToastService"],app.controller("ManageMyMembershipsDirectDebitController",ManageMyMembershipsDirectDebitController),ManageMyMembershipsDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],app.controller("ManageNokController",ManageNokController),ManageNokController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","ToastService"],app.controller("ManagePaymentsAddController",ManagePaymentsAddController),ManagePaymentsAddController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService","ToastService"],app.controller("ManagePaymentsController",ManagePaymentsController),ManagePaymentsController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService","ToastService"],app.controller("ManagePoidController",ManagePoidController),ManagePoidController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","PoidService","AuthenticationService","ToastService"],app.controller("ModalInstanceCtrl",ModalInstanceCtrl),ModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","params"],app.controller("MyAccountController",MyAccountController),MyAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService"],app.controller("MyJourneyLogsController",MyJourneyLogsController),MyJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce","ToastService"],app.controller("NewChargeModalInstanceCtrl",NewChargeModalInstanceCtrl),NewChargeModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","MemberService","ClubService","$rootScope","PaymentService","params","EnvConfig","ToastService"],app.controller("PassengerSignupCompleteController",PassengerSignupCompleteController),PassengerSignupCompleteController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","ToastService"],app.controller("PassengerSignupController",PassengerSignupController),PassengerSignupController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$http","ToastService"],app.controller("PasswordResetController",PasswordResetController),PasswordResetController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","ToastService"],app.controller("RefundModalInstanceCtrl",RefundModalInstanceCtrl),RefundModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","params","ToastService"],app.controller("RegisterController",RegisterController),RegisterController.$inject=["UserService","$location","$rootScope","FlashService","$stateParams","ToastService"],app.controller("ReviewBookingsController",ReviewBookingsController),ReviewBookingsController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$scope","$location","AuthenticationService","ToastService"],app.controller("ShowGalleryController",ShowGalleryController),ShowGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],app.controller("UpdateMyMembershipDirectDebitController",UpdateMyMembershipDirectDebitController),UpdateMyMembershipDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],app.controller("UploadController",UploadController),UploadController.$inject=["KeywordsService","ArtpiecesService","ImageUploadService","$scope","$http","$location"],app.controller("UsersController",UsersController),UsersController.$inject=["UserService","$location","$rootScope","FlashService","$routeParams","ToastService"],app.controller("UserSignupController",UserSignupController),UserSignupController.$inject=["UserService","$http","$rootScope","$location","$scope","$state","$stateParams","ToastService"];