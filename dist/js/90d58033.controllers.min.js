"use strict";function asyncGeneratorStep(e,t,n,o,i,r,a){try{var s=e[r](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(o,i)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(t,n){var o=s.apply(e,a);function i(e){asyncGeneratorStep(o,t,n,i,r,"next",e)}function r(e){asyncGeneratorStep(o,t,n,i,r,"throw",e)}i(void 0)})}}function AccountController(e,t,n){this.user=t.globals.currentUser}function AddLicenceController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b){var h=this;h.licence_images=[],h.licence={images:[],ratings:[]},b.GetLicenceTypes().then(function(e){h.licence_types=e}),b.GetRatings().then(function(e){h.ratings=e;for(var t=0;t<h.ratings.length;t++)if(7==h.ratings[t].id){h.selected_rating=h.ratings[t],s.add_rating();break}}),b.GetAuthority().then(function(e){h.authority=e}),s.add_rating=function(){h.ratings=$.grep(h.ratings,function(e){return e.id!=h.selected_rating.id}),h.licence.ratings.push(h.selected_rating),delete h.selected_rating},s.remove_rating=function(e){h.ratings.push(h.licence.ratings[e]),h.licence.ratings.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(h.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,h.licence_images.push(e[t].file)}},s.save_licence=function(e){return h.licence_images.length<1&&h.licence.images.length<1?($(".drop").focus(),alert("You must at least have 1 image of your licence!"),!1):h.licence.licence_type?h.licence.state_of_issue?h.licence.ratings.length<1?($("#ratings").focus(),alert("You must at least have 1 rating!"),!1):void(h.licence.id||(h.licence.images=h.licence_images,h.licence.licence_id=h.licence.licence_type.id,h.licence.authority_id=h.licence.state_of_issue.id,h.licence.user_id=h.user_id,delete h.licence.licence_type,delete h.licence.state_of_issue,b.Create(h.licence).then(function(e){e.success||alert("Something went terribly wrong... \n\n "+e.message)}))):($("#state_of_issue").focus(),alert("You must select a licence state of issue"),!1):($("#licence_type").focus(),alert("You must select a licence type"),!1)}}function AircraftJourneyLogsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w){var C=this;function S(e,t,n){t=t.toLowerCase(),n=n.toLowerCase(),e=e.toLowerCase();return 2<e.length&&-1<t.indexOf(e)||2<e.length&&-1<n.indexOf(e)}function x(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}C.clubs=[],C.user=r.globals.currentUser,C.user_id=C.user.id,C.looking_for=l.registration,C.looking_for&&(s.my_search2=C.looking_for),C.defect_severity,C.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],k.GetAircraftJourneyLogs(l.plane_id,0,25).then(function(e){C.logs=e.logs,C.aircraft=e.aircraft}),C.current_offset=0,C.loaded_per_batch=25,C.all_loaded=!1,C.load_more=function(){C.current_offset=C.current_offset+C.loaded_per_batch,k.GetAircraftJourneyLogs(l.plane_id,C.current_offset,C.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return C.logs.push(e)}):C.all_loaded=!0})},C.get_initial=function(e){return e?e.charAt(0):""},C.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},C.round_brake_times=function(e,t,n){},C.round_brake_times_end=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,60*parseInt(i)+parseInt(t)<n&&(60==(r=parseInt(r)+5)?(o[0]++,r="00"):60<r&&(o[0]++,(r-=60)<10&&(r="0"+r)))),o[0]+":"+r}return e}return""},C.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},s.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},C.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return!s.my_search2||""==s.my_search2||(!!function(e,t){if(!(e.length<2)){if(e&&e.length<=3)return-1<t.indexOf(e);var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return 1;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return 1}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return 1}}}(s.my_search2,e.flight_date)||(t=e.first_name,n=e.last_name,o=s.my_search2,i=o.toLowerCase(),n=(n=t+" "+n).toLowerCase(),2<o.length&&-1<n.indexOf(i)||(!!S(s.my_search2,e.departure_airport,e.departure_airport_code)||!!S(s.my_search2,e.destination_airport,e.destination_airport_code))));var t,n,o,i},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},s.downloadDocument=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){x(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){x(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},C.list_pilots=function(e){var t="",n="",t="PIC: "+C.get_pic(e),n=C.get_put(e);return w.getTrustedHtml("<div>"+(t=t&&""==t?"No PIC set yet!":t)+" "+(n=n&&""!==n?"<br />PUT: "+n:n)+"</div>")},C.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=C.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=C.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=C.get_initial(e.first_name)+". "+e.last_name),t},C.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=C.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=C.get_initial(e.first_name)+". "+e.last_name),t},s.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function AircraftStatusController(e,t,n,o,i,r,a,s,c,l,d,_,u,p,m,f,g,b,h,y,v,k){var w=this;function C(e,t){var n,o="application/octet-stream",i=!1,r=(t=t())["x-filename"]||"download.zip",t=t["content-type"]||o;try{_.info("first try");var a=new Blob([e],{type:"application/pdf"}),s=URL.createObjectURL(a);c=s,n="Secure Documents",(l=window.open()).document.write("<html><head><title>"+n+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+c+'" type="application/pdf" internalinstanceid="21"></body></html>'),l.document.close(),i=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!i){var c=window.URL||window.webkitURL||window.mozURL||window.msURL;if(c){var l=document.createElement("a");if("download"in l)try{_.info("second try");var a=new Blob([e],{type:t}),d=c.createObjectURL(a);l.setAttribute("href",d),l.setAttribute("download",r);var u=document.createEvent("MouseEvents");u.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(u),i=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!i)try{_.info("third try");a=new Blob([e],{type:o}),d=c.createObjectURL(a);window.location=d,i=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}return i||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),r}w.clubs=[],w.user=r.globals.currentUser,w.user_id=w.user.id,w.looking_for=l.registration,w.looking_for&&(s.my_search2=w.looking_for),w.defect_severity,w.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],k.GetByUserMaintenance(w.user.id).then(function(e){w.clubs=e.clubs}),w.get_initial=function(e){return e.charAt(0)},w.list_pilots=function(e){var t="",n="",t="PIC: "+w.get_pic(e);return(n=w.get_put(e))&&""!==n&&(n="<br />PUT: "+n),t&&""==t&&(t="No PIC set yet!"),$sce.getTrustedHtml("<div>"+t+" "+n+"</div>")},w.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=w.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=w.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=w.get_initial(e.first_name)+". "+e.last_name),t},w.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=w.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=w.get_initial(e.first_name)+". "+e.last_name),t},w.clean_times=function(e){return e.substring(0,5)},w.add_defect=function(t,n){var e={club_id:n,user_id:w.user_id,plane_id:t,defect:w.defect,severity:w.defect_severity.title,status:"open"};k.AddDefect(e).then(function(e){e.item.can_delete=!0,w.clubs.find(function(e){return e.id===n}).planes.find(function(e){return e.plane_id===t}).defects.push(e.item),w.defect="",w.defect_severity=""})},w.delete_defect=function(e){k.DeleteDefect(e).then(function(e){k.GetOpenIssues(w.bookout.plane_id).then(function(e){w.reported_defects=e})})},s.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},s.count_defects=function(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=0,o=0;o<e.length;o++)(1==t||"open"==e[o].status)&&n++;return n},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},w.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},w.show_receipt_image=function(e){w.show_receipt=!0,w.receipt_image=e.image},w.get_icon3=function(e){var e=e.split(";")[0],t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return-1!==angular.lowercase(e.registration).indexOf(angular.lowercase(s.my_search2)||"")},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},s.downloadDocument=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){C(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){C(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},w.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},w.round_brake_times_end=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,60*parseInt(i)+parseInt(t)<n&&(60==(r=parseInt(r)+5)?(o[0]++,r="00"):60<r&&(o[0]++,(r-=60)<10&&(r="0"+r)))),o[0]+":"+r}return e}return""},s.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function AllDocumentsController(e,t,n,o,i,r,a,s,c,l,d,_,u,p,m,f,g,b,h,y,v){var k=this;function w(e,t){var n,o="application/octet-stream",i=!1,r=(t=t())["x-filename"]||"download.zip",t=t["content-type"]||o;try{var a=new Blob([e],{type:"application/pdf"}),s=URL.createObjectURL(a);c=s,n="Secure Documents",(l=window.open()).document.write("<html><head><title>"+n+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+c+'" type="application/pdf" internalinstanceid="21"></body></html>'),l.document.close(),i=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!i){var c=window.URL||window.webkitURL||window.mozURL||window.msURL;if(c){var l=document.createElement("a");if("download"in l)try{var a=new Blob([e],{type:t}),d=c.createObjectURL(a);l.setAttribute("href",d),l.setAttribute("download",r);var u=document.createEvent("MouseEvents");u.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(u),i=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!i)try{a=new Blob([e],{type:o}),d=c.createObjectURL(a);window.location=d,i=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}return i||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),r}k.clubs=[],k.user=r.globals.currentUser,k.user_id=k.user.id,h.GetByUserId(k.user.id).then(function(e){k.clubs=e.clubs;for(var t=0;t<k.clubs.length;t++)""!==k.clubs[t].membership_terms&&k.clubs[t].documents.push({title:"Membership Terms & Conditions",document:k.clubs[t].membership_terms,updated_at:k.clubs[t].membership_updated}),""!==k.clubs[t].privacy_terms&&k.clubs[t].documents.push({title:"Privacy Terms",document:k.clubs[t].privacy_terms,updated_at:k.clubs[t].privacy_updated}),""!==k.clubs[t].passenger_terms&&k.clubs[t].documents.push({title:"Passenger Terms & Conditions",document:k.clubs[t].passenger_terms,updated_at:k.clubs[t].passenger_updated})}),s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},k.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search3=function(e){return-1!==angular.lowercase(e.membership_name).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return-1!==angular.lowercase(e.registration).indexOf(angular.lowercase(s.my_search2)||"")},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){w(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){w(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function AllInvoicesController(e,n,o,t,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w){var C=this;C.clubs=[],C.user=s.globals.currentUser,C.user_id=C.user.id,C.show_pay_now=!1,C.show_loading=!1,C.last_invoice_opened={};function S(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){p.info("!!saveBlob method failed with the following exception:"),p.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){p.info("Download link method with simulated click failed with the following exception:"),p.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){p.info("Download link method with window.location failed with the following exception:"),p.info(e)}}}return o||(p.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}C.donConfirm=function(e,t){C.complete_invoice(e,t)},C.default_payment="direct-debit",C.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],C.savedCards=[],C.complete_invoice=function(e,t){e={user_id:C.user.id,club_id:C.last_invoice_opened.club_id,paymentIntent:t,invoice_id:C.last_invoice_opened.id,method:e};n.ProcessPayment(e).then(function(e){e.success?o.GetInvoices(C.user.id).then(function(e){C.invoices=e.invoices,C.show_pay_now=!1,C.show_loading=!1}):(console.log("===== ERROR ====="),console.log(e),console.log("===== ERROR ====="))})},C.close_pay_now=function(){C.show_pay_now=!1,C.show_loading=!1},C.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},C.show_payment_option=function(e){e=e.status;return"pending_submission"==e||"issued"==e},C.info,C.show_payment=function(e){console.log("invoice details: ",e),C.last_invoice_opened=e,C.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.id},t.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(C.info=e.info,C.savedCards=e.cards,0<C.savedCards.length?C.methods[1].visible=!0:C.methods[1].visible=!1,C.machine=e.machine,C.machine.success?C.methods[3].visible=!0:C.methods[3].visible=!1,C.show_pay_now=!0)})},C.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(t=1==t?"":"-")+n+":"+e},o.GetInvoices(C.user.id).then(function(e){C.invoices=e.invoices}),o.GetUpcoming(C.user.id).then(function(e){C.upcoming=e.upcoming}),l.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},C.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},l.search=function(e){return-1!==angular.lowercase(e.invoice_number).indexOf(angular.lowercase(l.my_search)||"")||!!e.plane_registration&&-1!==angular.lowercase(e.plane_registration).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(e.club_title).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(parseFloat(e.total).toFixed(2).toString()).indexOf(angular.lowercase(l.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(l.my_search)||"")},l.show_more=function(e){C.invoices[e].show_more=!C.invoices[e].show_more},l.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},l.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");w.get("http://local.arrow.com/api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){S(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},l.downloadInvoice=function(e){w.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){S(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function AllPaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v){var k=this;function w(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}k.clubs=[],k.user=r.globals.currentUser,k.user_id=k.user.id,k.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},k.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(1==t?"":"-")+n+":"+e},e.GetPayments(k.user.id).then(function(e){k.payments=e.payments}),e.GetUpcoming(k.user.id).then(function(e){k.upcoming=e.upcoming}),s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},k.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.id.toString()).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.club_title).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.amount.toString()).indexOf(angular.lowercase(s.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(s.my_search)||"")},s.show_more=function(e){k.invoices[e].show_more=!k.invoices[e].show_more},s.get_human_method=function(e){var t;switch(e){case"GoCardless":t="Direct Debit";break;case"Credit":t="Credit";break;case"GoCardless + Credit":t="Direct Debit + Credit";break;case"Equilibrium":t="Not Required "}return t},s.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"toaviate_ready":case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":case"paid":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},s.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");v.get("http://local.arrow.com/api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){w(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.downloadInvoice=function(e){v.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){w(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function ArtpiecesController(e,n,o,t,i,r,a,s){var c=this;c.artpiece={},c.artpiece.categories=[],n.GetAll().then(function(e){c.categories=e,""!==a.artpieceId&&o.GetById(a.artpieceId).then(function(e){if(c.artpiece=e,c.artpiece.categories)for(var t=0;t<c.artpiece.categories.length;t++)c.categories=$.grep(c.categories,function(e){return e.id!=c.artpiece.categories[t].category_id})})}),o.GetAll().then(function(e){c.artpieces=e}),s.tempAddCategory=function(e){var t=JSON.parse(e);c.artpiece.categories.push(t),c.categories=$.grep(c.categories,function(e){return e.id!=t.id})},s.tempDeleteCategory=function(t){c.artpiece.categories=$.grep(c.artpiece.categories,function(e){return e.id!=t.id}),c.categories.push(t)},s.AddCategory=function(e){var t=JSON.parse(e);o.AddCategory({category_id:t.id,artpiece_id:c.artpiece.id}).then(function(e){c.artpiece.categories.push(t),c.categories=$.grep(c.categories,function(e){return e.id!=t.id})})},s.DeleteCategory=function(t){o.DeleteCategory({category_id:t.category_id,artpiece_id:c.artpiece.id}).then(function(e){c.artpiece.categories=$.grep(c.artpiece.categories,function(e){return e.id!=t.id}),c.categories.push(t)})},s.addArtpiece=function(){o.Create(c.artpiece).then(function(e){t.path("/artpieces"),c.artpiece={}})},s.editArtpiece=function(){o.Update(c.artpiece).then(function(e){t.path("/artpieces"),c.artpiece={}})},s.deleteArtpiece=function(t){o.Delete(t).then(function(e){c.artpieces=$.grep(c.artpieces,function(e){return e.id!=t})})},s.addCategory=function(){var e={title:c.new_category};n.Create(e).then(function(e){c.cats.push(e),c.new_category=""})},s.deleteCategory=function(t){n.Delete(t).then(function(e){c.cats=$.grep(c.cats,function(e){return e.id!=t})})}}function BookinController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w,C,S,x,O,D,I,M,P){var A=this;A.user=s.globals.currentUser,A.user_id=A.user.id,A.club_id=0,A.booking={},A.wgs_n="51.51",A.wgs_e="0.12",A.split_flight=0,A.show_takeoff_landing_times=!1,A.change_booking={},A.show_change_plane=!1,A.bookout={start:!0,passengers:[],pic:{id:A.user_id},plane:{}},A.this_pls_id_raw=0,A.instructors=[],A.pics=[],A.instructor_charges=[],A.club_courses=[],A.can_authorise=!1,A.dateFormat="date:HH:mm 'on' dd/MM/yyyy",A.flight_times_complete=!1,A.calculated_invoice=!1,A.show_loading=!0,A.reported_defects=[],A.scroll=!0,A.previous_invoice,A.defect_severity,A.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],A.claim_a_flight=[],A.claimed_flight={},A.auto_claim=0,A.ignore_next_tuition_change=!1,A.get_currency=function(t){return $.grep(A.currencies,function(e){return e.iso_code==t})[0]},l.get_airfields=function(t){var e;2<t.length&&t.length<5&&k.GetAirfieldsByCode(t).then(function(e){e.success&&(A.airfields=e.airfields,0==A.airfields.length&&(A.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}),4<t.length&&(e=t.replace(/\s/g,"_"),k.GetAirfields(e).then(function(e){e.success&&(A.airfields=e.airfields,0==A.airfields.length&&(A.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}))},A.original_bookout={},l.reset_claim_my_flight=function(){A.bookout=A.original_bookout,A.different_date_warning=!1,A.claimed_flight={},A.calculate_invoice_for_flight(),A.flight_times_complete=!1},A.different_date_warning=!1,A.has_used_claimed_flight=!1;function U(e,n,t){var o=2<arguments.length&&void 0!==t?t:null,i=new Date;if(A.bookout&&A.bookout.brakes_off){var r=new Date(o),t=A.bookout.brakes_off.time.split(":");r.setHours(t[0]),r.setMinutes(t[1]),r.setSeconds(0),(i=new Date(o)).setHours(0),i.setMinutes(0),i.setSeconds(0)}else switch(e){case"today":case"past":case"future":r=new Date("1990-07-26");break;case"after":r=new Date(o),i=new Date(o);break;case"before":r=new Date(o)}A[n].forEach(function(e,t){e=e.time.split(":");i.setHours(e[0]),i.setMinutes(e[1]),i.setSeconds(0),moment(i).isAfter(moment(r))?A[n][t].disabled=0:A[n][t].disabled=1})}A.donConfirm=function(e,t){console.log("confirmation is called",e),console.log("paymentIntent",t);var n="home";A.user.id===A.bookout.payer_id||A.user.id!=A.bookout.pic_id&&A.user.id!=A.bookout.instructor_id?A.split_flight_confirmation:n="debrief",A.book_in_flight(n,e,t)},A.default_payment="direct-debit",A.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],A.savedCards=[],l.claim_my_flight=function(){var e;if(A.bookout.flight_date!==A.claimed_flight.flight_date&&!1===(0<arguments.length&&void 0!==arguments[0]&&arguments[0]))return alert("The bookout date and the flight you are claiming do not match - are you absolutely sure that this is your flight?"),!(A.different_date_warning=!0);1==A.this_claim_was_instructional&&A.this_was_instructional_claim(),A.this_pls_id_raw=Object.assign({},A.bookout),console.log("vm.this_pls_id_raw",A.this_pls_id_raw),A.has_used_claimed_flight=!0,A.bookout.from_airfield=A.claimed_flight.from_airport,A.bookout.to_airfield=A.claimed_flight.to_airport,e=A.claimed_flight.from_airport.id==A.claimed_flight.to_airport.id?2<A.claimed_flight.touch_and_go?A.flight_types.find(function(e){return 3===e.id}):A.flight_types.find(function(e){return 1===e.id}):A.flight_types.find(function(e){return 2===e.id}),A.bookout.flight_type=e,A.bookout.flight_date=A.claimed_flight.flight_date,A.bookout.brakes_off_rounded=A.claimed_flight.brakes_off_rounded,A.bookout.brakes_on_rounded=A.claimed_flight.brakes_on_rounded,A.bookout.brakes_off={time:A.claimed_flight.brakes_off},A.bookout.brakes_on={time:A.claimed_flight.brakes_on},A.bookout.touch_and_go=A.claimed_flight.touch_and_go,A.bookout.landings=A.claimed_flight.full_stop_landings,A.bookout.stops=A.claimed_flight.stops,A.bookout.fox_log_id=A.claimed_flight.fox_log_id,A.bookout.fox_claimed=1,A.bookout.takeoff_time=A.claimed_flight.takeoff_time,A.bookout.landing_time=A.claimed_flight.landing_time,A.bookout.takeoff_rounded=A.claimed_flight.takeoff_rounded,A.bookout.landing_rounded=A.claimed_flight.landing_rounded,A.bookout.claimed_fox_plane_log_sheet_id=A.claimed_flight.id,A.flight_units.brakes_to_brakes=A.claimed_flight.brakes_time,A.flight_units.airborne_times=A.claimed_flight.airborne_time,A.flight_units.flight_time=A.claimed_flight.flight_time,A.flight_units.brakes_times_rounded=A.bookout.brakes_times_rounded,A.calculate_invoice_for_flight(),A.flight_times_complete=!0,"tacho"==A.bookout.plane_charges.charge_type||A.bookout.plane_charges.charge_type,console.log("BOOKING : ",A.bookout.booking_id),console.log("PLS ID : ",A.bookout.id)},l.update_pic=function(){var e=A.pics.find(function(e){return e.user_id===A.bookout.pic.user_id});A.bookout.pic=e,A.bookout.pic_id=A.bookout.pic.user_id,A.this_claim_was_instructional&&0!=A.this_claim_was_instructional?(console.log("before change - this was instructional"),1==A.bookout.pic.instructor||(A.this_claim_was_instructional=!1,A.bookout.put_id=0,A.bookout.put={},((A.bookout.instructor_id=0)<A.bookout.pic_id||0<A.bookout.user_id)&&(A.bookout.payer_id=A.bookout.pic_id),A.calculate_invoice_for_flight())):D.GetPackagesByUserId(A.bookout.pic_id).then(function(e){A.packages=e.items,C.GetUpdatedCharges(A.bookout.club_id,A.bookout.plane_id,A.bookout.pic_id).then(function(e){A.bookout.plane_charges=e.plane_charges,A.bookout.put_id=0,A.bookout.put={},((A.bookout.instructor_id=0)<A.bookout.pic_id||0<A.bookout.user_id)&&(A.bookout.payer_id=A.bookout.pic_id),A.calculate_invoice_for_flight()})}),A.complete_flight=!1,A.bookout.pic.user_id==A.user.id&&(A.can_authorise=!1),A.bookout.booking&&0!=A.bookout.booking.user_id&&0!=A.bookout.user_id||(A.bookout.user_id=A.bookout.pic.user_id),0==A.bookout.put_id&&0==A.bookout.instructor_id&&(A.bookout.payer_id=A.bookout.pic_id),A.bookout.payer_id,A.complete_flight&&A.complete_this_flight()},l.update_put=function(){if(A.bookout.put.user_id==A.bookout.pic.user_id)return alert("please select a different PIC to the PUT"),!(A.bookout.put={});A.complete_flight=!1;var e=A.pics.find(function(e){return e.user_id===A.bookout.put.user_id});A.bookout.put=e,A.bookout.put_id=e.user_id,0<A.bookout.put_id&&(A.bookout.instructor_id=A.bookout.pic_id,A.bookout.instructor=A.bookout.pic,console.log("FI: ",A.bookout.instructor),console.log("instructor_id: ",A.bookout.instructor_id),l.update_pic()),D.GetPackagesByUserId(A.bookout.put_id).then(function(e){A.packages=e.items,C.GetUpdatedCharges(A.bookout.club_id,A.bookout.plane_id,A.bookout.put_id).then(function(e){A.bookout.plane_charges=e.plane_charges,A.calculate_invoice_for_flight()})}),0!==A.bookout.pic_id&&A.bookout.pic_id!==A.bookout.instructor_id?A.bookout.payer_id=A.bookout.pic_id:0<A.bookout.instructor_id&&0<A.bookout.put_id||0<A.bookout.instructor_id&&0<A.bookout.user_id?A.bookout.payer_id=0<A.bookout.put_id?A.bookout.put_id:A.bookout.user_id:0<A.bookout.put_id?A.bookout.payer_id=A.bookout.put_id:0==A.bookout.put_id&&0==A.bookout.user_id?A.bookout.payer_id=A.bookout.pic_id:(0==A.bookout.instructor_id&&(A.bookout.payer_id=A.bookout.pic_id),0==A.bookout.payer_id&&alert("It appears you need to select a student or person paying for this flight? Please select a student or pilot in command")),A.complete_flight&&A.complete_this_flight()},l.update_instructor=function(){var e=A.instructors.find(function(e){return e.user_id===A.bookout.instructor.user_id});e&&0<e.user_id?(A.bookout.instructor=e,A.bookout.instructor_id=e.user_id,0!==A.bookout.pic_id&&A.bookout.pic_id!==A.bookout.instructor_id?A.bookout.payer_id=A.bookout.pic_id:0<A.bookout.instructor_id&&0<A.bookout.put_id||0<A.bookout.instructor_id&&0<A.bookout.user_id?A.bookout.payer_id=0<A.bookout.put_id?A.bookout.put_id:A.bookout.user_id:0<A.bookout.put_id?A.bookout.payer_id=A.bookout.put_id:0==A.bookout.put_id&&0==A.bookout.user_id?A.bookout.payer_id=A.bookout.pic_id:(0==A.bookout.instructor_id&&(A.bookout.payer_id=A.bookout.pic_id),0==A.bookout.payer_id&&alert("It appears you need to select a student or person paying for this flight? Please select a student or pilot in command"))):(A.bookout.instructor={},A.bookout.instructor_id=0,A.bookout.payer_id=A.bookout.pic_id),A.complete_flight&&A.complete_this_flight()},A.flight_types=[{id:1,title:"Local"},{id:2,title:"Departure"},{id:3,title:"Circuits"},{id:4,title:"Other"}],A.biggin_hill={routes:[{id:1,title:"Kenley"},{id:2,title:"Sevenoaks"},{id:3,title:"Swanley"},{id:4,title:"Other"}],parking:""},A.flight_rules=[{id:1,title:"VFR"},{id:2,title:"IFR"}],A.split_flight_confirmation=0,A.split_this_flight=function(){A.split_flight=1;var e=A.split_flight_time;e.booking_id=A.bookout.booking_id,e.this_pls_id=A.bookout.id,C.HypotheticalFlightSplit(A.bookout.id,e).then(function(e){A.split_one=e.first_flight,A.split_flight=1,A.split_two=e.second_flight,A.split_two.brakes_off={time:A.split_two.brakes_off},A.split_two.brakes_on={time:A.split_two.brakes_on}})},A.cancel_split=function(){A.bookout=A.original_bookout,A.split_one={},A.split_two={},A.split_flight=0,A.split_flight_confirmation=0,K(A.bookout)},A.update_split=function(){var e=A.bookout.id;e&&null!=e&&0!=e||(e=A.this_pls_id_raw),A.has_used_claimed_flight&&0<A.claimed_flight.id&&(e=A.claimed_flight.id);var t=A.split_flight_time;t.booking_id=A.bookout.booking_id,t.this_pls_id=A.bookout.id,C.HypotheticalFlightSplit(e,t).then(function(e){console.log("data is : ",e),A.split_one=e.first_flight,A.split_flight=1,A.split_two=e.second_flight,A.split_two.brakes_off={time:A.split_two.brakes_off},A.split_two.brakes_on={time:A.split_two.brakes_on}})},A.start_times=[],A.all_times=[];for(var T=0;T<24;T++){for(var E=0;E<12;E++)A.start_times.push({time:T+":"+(B=((B=5*E)<10?"0":"")+B),disabled:!1});for(var B,E=0;E<6;E++)A.all_times.push({time:T+":"+(B=((B=10*E)<10?"0":"")+B),disabled:!1})}function G(e,t,n){var o=1<arguments.length&&void 0!==t?t:null,i=2<arguments.length&&void 0!==n?n:0,o=parseInt(o);e=parseInt(e);var r=0;return A.options.business_hours&&(t=A.options.business_hours.from.split(":"),n=A.options.business_hours.to.split(":"),0==i||(n[0]=parseInt(n[0])-1),o||0==o?((e<parseInt(t[0])||e==parseInt(t[0])&&o<parseInt(t[1]))&&(r=1),(e>parseInt(n[0])||e==parseInt(n[0])&&o>parseInt(n[1]))&&(r=1)):(parseInt(t[0])<e&&(r=1),parseInt(n[0])>e&&(r=1))),r}function L(e){var t=moment.duration(e).days(),n=moment.duration(e).hours(),o=moment.duration(e).minutes();59==o&&(n++,o=0);e="";return 0<t&&(e=e+" "+t+" day",e=1<t?e+"s":e),0<n&&(e=e+" "+n+" hour",e=1<n?e+"s":e),0<o&&(e=e+" "+o+" minute",e=1<o?e+"s":e),e}function R(){var o,e;A.bookout.start_date&&A.bookout.start_time&&(o=new Date(A.bookout.start_date),e=A.bookout.start_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),A.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(A.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=L(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?A.end_times[t].disabled=1:A.end_times[t].duration="( "+n+" )"):A.end_times[t].duration=""}),A.show_takeoff_landing_times&&angular.copy(A.end_times,A.takeoff_times))}function j(e,t){var n=1<arguments.length&&void 0!==t?t:"start",t="today";return moment(moment(e).format("YYYY/MM/DD")).isAfter(moment().format("YYYY/MM/DD"))?(t="future",A.bookout.start_date&&A.bookout.end_date&&"end"==n&&moment(A.bookout.start_date).isSame(moment(A.bookout.end_date))&&(t="after")):t=moment(e).format("YYYY/MM/DD")==moment().format("YYYY/MM/DD")?"start"==n?"today":"after":"past",t}function N(){var e=new Date,t=A.bookout.start_time?A.bookout.start_time.time.split(":"):[e.getHours(),e.getMinutes()],e=new Date(A.bookout.start_date);e.setHours(t[0]),e.setMinutes(t[1]),e.setSeconds(0);var n,o=moment(e).add(1,"hour").format();F()||!A.bookout.end_time?(U(j(A.bookout.end_date,"end"),"end_times",e),A.end_times.some(function(e,t){if(e.time==moment(o).format("H:mm"))return n=t}),A.bookout.end_time={},A.bookout.end_time=A.end_times[n]):U(j(A.bookout.end_date,"end"),"end_times",e),A.bookout.end_time&&1==A.bookout.end_time.disabled&&(A.end_times.some(function(e,t){if(e.time==moment(o).format("H:mm"))return n=t}),A.bookout.end_time={},A.bookout.end_time=A.end_times[n]),A.bookout.start_time&&1==A.bookout.start_time.disabled&&(A.start_times.some(function(e,t){if(0==e.disabled)return n=t}),A.bookout.start_time={},A.bookout.start_time=A.start_times[n],R())}function Y(){var e,t;moment(A.bookout.start_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")?U("today","start_times"):moment(A.bookout.start_date).isAfter(moment())&&U("future","start_times"),moment(A.bookout.end_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(A.bookout.start_time&&add_hour_to_end(),U(j(A.bookout.start_date),"end_times")),A.bookout.end_date==A.bookout.start_date&&A.bookout.start_time&&(e=A.bookout.start_time.time.split(":"),(t=new Date(A.bookout.start_date)).setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0),F()?(U(j(A.bookout.start_date),"start_times"),U(j(A.bookout.end_date,"end"),"end_times",t),add_hour_to_end()):U(j(A.bookout.end_date,"end"),"end_times",t))}function F(){var e,t,n,o=!1;return A.bookout.end_time&&(e=new Date(A.bookout.start_date),n=A.bookout.start_time.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date(A.bookout.end_date),n=A.bookout.end_time.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),(moment(e).isAfter(moment(t))||moment(e).isSame(t)||t==e)&&(o=!0)),o}U("future","all_times"),A.currency_days=28,A.dateTimeRangePickerOptions={hour_step:1,minute_step:30,min_date:new Date,business_hours:{from:"09:00",to:"22:30"}},A.dateTimeRangePickerOptions2={hour_step:1,minute_step:5,min_date:new Date,business_hours:{from:"00:00",to:"23:55"}},A.options={hour_step:1,minute_step:5,min_date:new Date,business_hours:{from:"00:00",to:"23:55"}},A.lubricant_type=[{title:"Fuel"},{title:"Oil"}],A.who_paid=[{title:"Me"},{title:"Club"}],A.receipt={image:"",quantity:0,price:0,reimbursement:!1,item:{title:"Fuel"}},l.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,A.receipt_image=e[t].file,A.receipt.image=A.receipt_image.temp_path}},A.update_course=function(){console.log("do we need to update tuition to be offered from this?"),A.bookout.course&&0<A.bookout.course.id?(console.log("vm.bookout.course",A.bookout.course),S.GetByCourseId(A.bookout.course.id).then(function(e){A.instructor_charges=e.items,1==A.instructor_charges.length&&(A.bookout.tuition_required=A.instructor_charges[0]),A.ignore_next_tuition_change=!0,A.update_tuition_charges()})):S.GetByClubId(A.bookout.club_id).then(function(e){A.instructor_charges=e.items,1==A.instructor_charges.length&&(A.bookout.tuition_required=A.instructor_charges[0]),A.ignore_next_tuition_change=!0,A.update_tuition_charges()})},A.update_tuition_charges=function(){A.bookout.tuition_required&&0<A.bookout.tuition_required.id?S.GetUpdatedCharges(A.bookout.tuition_required.id).then(function(e){A.bookout.tuition_charges=e.tuition_charges,A.bookout.tuition_required=e.tuition_required,A.bookout.tuition_id=e.tuition_required.id,console.log("tuition charges: ",A.bookout),A.calculate_invoice_for_flight(),A.complete_flight&&A.complete_this_flight(),A.ignore_next_tuition_change=!1}):A.ignore_next_tuition_change||(0<A.bookout.instructor_id&&alert("Please select a tuition type for this flight."),A.ignore_next_tuition_change=!1)},A.delete_receipt=function(e){C.DeleteReceipt(e).then(function(e){C.GetAllSheetReceipts(A.bookout.id).then(function(e){A.lubricant_receipts=e,A.calculate_invoice_for_flight()})})},A.check_reimbursement=function(){if(A.receipt.price<.01||""==A.receipt.currency)return!1;var e={price:A.receipt.price,currency:A.receipt.currency.iso_code,club_id:A.bookout.club_id};C.CheckReimbursement(e).then(function(e){A.receipt.reimbursed_amount=e.reimburse.reimbursed_amount,A.receipt.reimbursed_currency=e.reimburse.reimbursed_currency,A.receipt.reimbursed_rate=e.reimburse.rate,A.receipt.reimbursed_datetime=e.reimburse.datetime})},A.add_receipt=function(){if(A.receipt.reimbursement&&!A.receipt.image)return alert("You must upload a copy of your receipt if you wish to be re-imbursed."),!1;var e={plane_id:A.bookout.plane_id,club_id:A.bookout.club_id,user_id:A.user.id,plane_log_sheet_id:A.bookout.id,reimbursement:A.receipt.reimbursement,image:A.receipt.image,currency:A.receipt.currency.iso_code,item:A.receipt.item.title,quantity:A.receipt.quantity,price:A.receipt.price};C.AddReceipt(e).then(function(e){A.lubricant_receipts.push(e.item),A.receipt={image:"",quantity:0,price:0,reimbursement:!1,item:{title:"Fuel"}},A.calculate_invoice_for_flight()})},A.options={},A.start_times=[],A.end_times=[],A.takeoff_times=[],A.landing_times=[],A.calculate_my_brakes_duration=function(){var o,e;A.bookout.start_date&&A.bookout.brakes_off&&(o=new Date(A.bookout.start_date),e=A.bookout.brakes_off.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),A.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(A.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=L(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?A.end_times[t].disabled=1:A.end_times[t].duration="( "+n+" )"):A.end_times[t].duration=""}),A.show_takeoff_landing_times&&angular.copy(A.end_times,A.takeoff_times))},A.calculate_airborne_duration=function(){var o,e;A.bookout.takeoff_time&&(o=new Date(A.bookout.start_date),e=A.bookout.takeoff_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),A.landing_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(A.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=L(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?A.landing_times[t].disabled=1:A.landing_times[t].duration="( "+n+" )"):A.landing_times[t].duration=""}))},A.calculate_after_landing_duration=function(){var o,e;A.show_takeoff_landing_times&&A.bookout.start_date&&A.bookout.landing_time&&(o=new Date(A.bookout.start_date),e=A.bookout.landing_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),A.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(A.bookout.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=L(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?A.end_times[t].disabled=1:A.end_times[t].duration="( "+n+" )"):A.end_times[t].duration=""}))},A.flight_units={brakes_to_brakes:0,airborne_times:0,flight_time:0,meter_units:A.bookout.end_tacho-A.bookout.start_tacho},A.cancel_split=function(){A.bookout=A.original_bookout,A.bookout.brakes_off=A.bookout.brakes_off.time,A.bookout.brakes_on=A.bookout.brakes_on.time,console.log(A.bookout),console.log(A.bookout.brakes_on),A.split_flight_confirmation=0,A.split_flight=0,K(A.bookout)},A.confirm_split=function(){console.log("CONFIRM SPLIT"),A.try_split=!0,A.before_split_bookout=A.bookout,A.split_flight_confirmation=1,A.original_bookout=A.bookout,A.split_one.touch_and_go=A.bookout.touch_and_go,A.split_one.tng=A.bookout.tng,console.log("TNG : ",A.split_one.touch_and_go),A.split_one.full_stop_landings=A.bookout.full_stop_landings,A.split_one.landings=A.bookout.landings,A.split_one.remote_landings=A.bookout.remote_landings,A.split_one.pic=A.bookout.pic,A.split_one.pic_id=A.bookout.pic_id,A.split_one.put=A.bookout.put,A.split_one.put_id=A.bookout.put_id,A.split_one.payer_id=A.bookout.payer_id,A.split_one.instructor=A.bookout.instructor,A.split_one.instructor_id=A.bookout.instructor_id,A.split_one.booking=A.bookout.booking,A.split_one.booking_id=A.bookout.booking_id,A.bookout.course&&A.bookout.course.id&&(A.split_one.course_id=A.bookout.course.id),A.split_one.course=A.bookout.course,A.split_one.tuition_required=A.bookout.tuition_required,A.split_one.authorised_solo=A.bookout.authorised_solo,A.flight_units.brakes_to_brakes=A.split_one.brakes_times,A.flight_units.airborne_times=A.split_one.airborne_time,A.flight_units.flight_time=A.split_one.flight_time,A.flight_units.brakes_times_rounded=A.split_one.brakes_times_rounded,console.log("OLD ONE - ",A.split_one),A.bookout=A.split_one,console.log("SPLIT 1 - ",A.split_one),console.log("SPLIT 2 - ",A.split_two),K(A.bookout),console.log("new bookout = ",A.bookout)},A.calculate_my_airborne_duration=function(){var e,t,n,o;A.has_used_claimed_flight?(A.flight_units.brakes_to_brakes=A.claimed_flight.brakes_time,A.flight_units.airborne_times=A.claimed_flight.airborne_time,A.flight_units.flight_time=A.claimed_flight.flight_time,A.flight_units.brakes_times_rounded=A.claimed_flight.brakes_times_rounded,A.calculate_invoice_for_flight()):(A.bookout.takeoff_time&&A.bookout.takeoff_time.time&&A.bookout.landing_time&&A.bookout.landing_time.time&&(t=new Date,o=A.bookout.takeoff_time.time.split(":"),t.setHours(o[0]),t.setMinutes(o[1]),t.setSeconds(0),n=new Date,e=A.bookout.landing_time.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),o=moment(moment(n).startOf("minute")).diff(moment(t).startOf("minute")),A.flight_units.airborne_times=moment.duration(o).asHours(),A.calculate_invoice_for_flight()),A.bookout.brakes_off&&""!==A.bookout.brakes_off.time&&A.bookout.brakes_on&&""!==A.bookout.brakes_on.time&&(e=new Date,n=A.bookout.brakes_off.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date,A.bookout.brakes_on&&A.bookout.brakes_on.time&&(n=A.bookout.brakes_on.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),o=moment(moment(t).startOf("minute")).diff(moment(e).startOf("minute")),A.flight_units.brakes_to_brakes=moment.duration(o).asHours(),A.calculate_invoice_for_flight()))),A.flight_times_complete=!0},A.update_dateTime=function(){var e,t,n;A.has_used_claimed_flight?(A.flight_units.brakes_to_brakes=A.claimed_flight.brakes_time,A.flight_units.airborne_times=A.claimed_flight.airborne_time,A.flight_units.flight_time=A.claimed_flight.flight_time,A.calculate_invoice_for_flight()):A.bookout.brakes_off&&A.bookout.brakes_off.time&&A.bookout.brakes_on&&A.bookout.brakes_on.time&&(n=new Date,t=A.bookout.brakes_off.time.split(":"),n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(0),e=new Date,t=A.bookout.brakes_on.time.split(":"),e.setHours(t[0]),e.setMinutes(t[1]),e.setSeconds(0),n=moment(moment(e).startOf("minute")).diff(moment(n).startOf("minute")),A.flight_units.brakes_to_brakes=moment.duration(n).asHours(),A.calculate_invoice_for_flight()),A.flight_times_complete=!0},Y(),l.update_dateTime=function(e){switch(e){case"start_time":Y(),N(),R();break;case"end_time":N();break;case"edit":Y(),U(j(A.bookout.start_date),"start_times"),N(),R(),setTimeout(function(){pre_select_value_id()},500)}},function(){A.options=A.dateTimeRangePickerOptions2;for(var e=0;e<24;e+=A.options.hour_step)if(A.options.minute_step&&0<A.options.minute_step)for(var t=0;t<60/A.options.minute_step;t++){var n=A.options.minute_step*t;A.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:G(e,n)}),A.end_times.push({time:e+":"+n,disabled:G(e,n),duration:""})}else A.start_times.push({time:e+":00",disabled:G(e)}),A.end_times.push({time:e+":00",disabled:G(e),duration:""});angular.copy(A.start_times,A.takeoff_times),angular.copy(A.end_times,A.landing_times)}(),function(){for(var e=0;e<24;e+=A.options.hour_step)if(A.options.minute_step&&0<A.options.minute_step)for(var t=0;t<60/A.options.minute_step;t++){var n=A.options.minute_step*t;A.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:G(e,n)}),A.end_times.push({time:e+":"+n,disabled:G(e,n),duration:""})}else A.start_times.push({time:e+":00",disabled:G(e)}),A.end_times.push({time:e+":00",disabled:G(e),duration:""});angular.copy(A.start_times,A.takeoff_times),angular.copy(A.end_times,A.landing_times)}(),"add"===d.current.data.action&&y.GetForBookIn(u.id).then(function(t){console.log("data is : ",t),t.success&&(1==t.bookout.booked_in&&(alert("It appears that you have already booked this flight back in..."),d.go("dashboard.my_account",{},{reload:!0})),A.original_bookout=t.bookout,A.bookout=t.bookout,A.claim_a_flight=t.unclaimed,A.bookout.start_date=new Date("2100/07/26"),A.bookout.end_date=new Date("2100/07/26"),n.GetAllByPicsBookinout(A.bookout.booking_id,A.bookout.club_id,A.user.id,1).then(function(e){A.pics=e,console.log("PICS: ",A.pics),K(t.bookout)}),n.GetAllByClubInstructor(A.bookout.club_id,A.user.id).then(function(e){A.instructors=e.instructors}),D.GetPackagesForBookout(A.bookout.id).then(function(e){A.packages=e.packages}),0==A.bookout.payer_id&&(0!==A.bookout.pic_id&&A.bookout.pic_id!==A.bookout.instructor_id?A.bookout.payer_id=A.bookout.pic_id:0<A.bookout.instructor_id&&0<A.bookout.put_id||0<A.bookout.instructor_id&&0<A.bookout.user_id?A.bookout.payer_id=0<A.bookout.put_id?A.bookout.put_id:A.bookout.user_id:0<A.bookout.put_id?A.bookout.payer_id=A.bookout.put_id:0==A.bookout.put_id&&0==A.bookout.user_id?A.bookout.payer_id=A.bookout.pic_id:(0==A.bookout.instructor_id&&(A.bookout.payer_id=A.bookout.pic_id),0==A.bookout.payer_id&&alert("It appears you need to select a student or person paying for this flight? Please select a student or pilot in command"))))}),A.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},A.this_was_a_supervised_solo=function(){A.this_was_supervised_solo=!A.this_was_supervised_solo,A.this_was_supervised_solo?A.bookout.payer_id=A.bookout.pic_id:0<A.bookout.put_id?A.bookout.payer_id=A.bookout.put_id:0<A.bookout.user_id&&(A.bookout.payer_id=A.bookout.user_id)},A.this_was_instructional_claim=function(){A.this_claim_was_instructional=!A.this_claim_was_instructional,A.complete_flight=!1,A.this_claim_was_instructional?(A.ignore_next_tuition_change=!0,A.bookout.payer_id=A.bookout.put_id,0==A.bookout.instructor_id&&A.bookout.pic&&0<A.bookout.pic.user_id&&(A.bookout.instructor_id=A.bookout.pic.user_id),V()):(A.bookout.put_id=0,A.bookout.put={},(A.bookout.instructor_id=0)<A.bookout.pic_id?A.bookout.payer_id=A.bookout.pic_id:0<A.bookout.user_id&&(A.bookout.payer_id=A.bookout.user_id)),A.calculate_invoice_for_flight()},l.applyFilter=function(e,t){if(t){var n=t.split(":"),o=n[0],t=[e];return 1<n.length?"date"==o.toLowerCase()&&t.push(n.slice(1).join(":")):t=t.concat(n.slice(1)),w(o).apply(this,t)}return e},A.add_defect=function(){var e={club_id:A.bookout.club_id,user_id:A.bookout.user_id,plane_id:A.bookout.plane_id,defect:A.defect,severity:A.defect_severity.title,status:"open"};C.AddDefect(e).then(function(e){e.item.can_delete=!0,A.reported_defects.push(e.item),A.defect="",A.defect_severity=""})},A.delete_defect=function(e){C.DeleteDefect(e).then(function(e){C.GetOpenIssues(A.bookout.plane_id).then(function(e){A.reported_defects=e})})},A.tacho_error_highlight=!1,A.check_tacho_bigger=function(){A.bookout.start_tacho>=A.bookout.end_tacho?(alert("Please check start and end tacho \n You cannot end on a smaller tacho"),A.tacho_error_highlight=!0):A.tacho_error_highlight=!1},A.calculate_invoice_for_flight=function(){console.log("RUN CALCULATION",A.flight_units),A.free_flight&&(A.bookout.plane_charges&&(A.bookout.plane_charges.charge_rate_unit=0,A.bookout.plane_charges.surcharge_fee=0,A.bookout.plane_charges.landing_fee=0,A.bookout.plane_charges.touch_and_go_fee=0),A.bookout.tuition_charges&&(A.bookout.tuition_charges.price=0));var e=0;if(A.claimed_flight&&null!==A.claimed_flight?"flight"==A.bookout.plane_charges.charge_type||"airborne"==A.bookout.plane_charges.charge_type?e=A.flight_units.airborne_times:"brakes"==A.bookout.plane_charges.charge_type?(!A.flight_units.brakes_to_brakes||0==A.flight_units.brakes_to_brakes)&&A.bookout.brakes_times&&0<A.bookout.brakes_times?(e=A.bookout.brakes_times,A.flight_units.brakes_to_brakes=A.bookout.brakes_times):e=A.flight_units.brakes_to_brakes:e="brakes_rounded"==A.bookout.plane_charges.charge_type?A.flight_units.brakes_to_brakes:A.bookout.end_tacho-A.bookout.start_tacho:"flight"==A.bookout.plane_charges.charge_type?e=A.flight_units.flight_time:"airborne"==A.bookout.plane_charges.charge_type?e=A.flight_units.airborne_times:"brakes"==A.bookout.plane_charges.charge_type?(!A.flight_units.brakes_to_brakes||0==A.flight_units.brakes_to_brakes)&&A.bookout.brakes_times&&0<A.bookout.brakes_times?(e=A.bookout.brakes_times,A.flight_units.brakes_to_brakes=A.bookout.brakes_times):e=A.flight_units.brakes_to_brakes:e="brakes_rounded"==A.bookout.plane_charges.charge_type?A.flight_units.brakes_times_rounded:A.bookout.end_tacho-A.bookout.start_tacho,(!A.flight_units.brakes_to_brakes||0==A.flight_units.brakes_to_brakes)&&A.bookout.brakes_times&&0<A.bookout.brakes_times&&(console.log("force it again"),A.flight_units.brakes_to_brakes=A.bookout.brakes_times),console.log("plane units: ",e),A.package_removed=[],A.package_used=!1,A.packages&&0<A.packages.length)for(var t=0;t<A.packages.length;t++)if(A.package_used=!0,A.bookout.instructor_id&&0<A.bookout.instructor_id){if(A.packages[t].remaining_hours_dual&&0<A.packages[t].remaining_hours_dual){if(e<A.packages[t].remaining_hours_dual){var n=A.packages[t].remaining_hours_dual-e;A.package_removed.push({solo_dual:"dual",title:A.packages[t].title,member_packages_id:A.packages[t].id,hours_dual_before:A.packages[t].remaining_hours_dual,hours_dual_spent:e,hours_dual_remaining_after:n,hours_solo_remaining_after:A.packages[t].remaining_hours_solo,package_id:A.packages[t].package_id}),e=0;break}A.package_removed.push({solo_dual:"dual",title:A.packages[t].title,member_packages_id:A.packages[t].id,hours_dual_before:A.packages[t].remaining_hours_dual,hours_dual_spent:A.packages[t].remaining_hours_dual,hours_dual_remaining_after:0,hours_solo_remaining_after:A.packages[t].remaining_hours_solo,package_id:A.packages[t].package_id}),e-=A.packages[t].remaining_hours_dual}}else if(A.packages[t].remaining_hours_solo&&0<A.packages[t].remaining_hours_solo){if(e<A.packages[t].remaining_hours_solo){n=A.packages[t].remaining_hours_solo-e;A.package_removed.push({solo_dual:"solo",title:A.packages[t].title,member_packages_id:A.packages[t].id,hours_solo_before:A.packages[t].remaining_hours_solo,hours_solo_spent:e,hours_solo_remaining_after:n,hours_dual_remaining_after:A.packages[t].remaining_hours_dual,package_id:A.packages[t].package_id}),e=0;break}A.package_removed.push({solo_dual:"solo",title:A.packages[t].title,member_packages_id:A.packages[t].id,hours_solo_before:A.packages[t].remaining_hours_solo,hours_solo_spent:A.packages[t].remaining_hours_solo,hours_solo_remaining_after:0,hours_dual_remaining_after:A.packages[t].remaining_hours_dual,package_id:A.packages[t].package_id}),e-=A.packages[t].remaining_hours_solo}var o=A.bookout.plane_charges.charge_rate_unit*e,i=0;"flight"==A.bookout.plane_charges.surcharge_type||"taxi"==A.bookout.plane_charges.surcharge_type?i=1:"none"!==A.bookout.plane_charges.surcharge_type&&(i=e);var r=A.bookout.plane_charges.surcharge_fee*i;A.bookout.landings<0&&(A.bookout.landings=1);var a=0|A.bookout.landings,s=a*A.bookout.plane_charges.landing_fee;A.bookout.tng<0&&(A.bookout.tng=1);var c=0|A.bookout.tng,l=c*A.bookout.plane_charges.touch_and_go_fee,d="none",u=0,_=0,p=0;(!A.packages||0==A.packages.length||0<e)&&0<A.bookout.instructor_id&&0<A.bookout.tuition_id&&A.bookout.tuition_charges&&(d=A.bookout.tuition_charges.charge_type,u=A.bookout.tuition_charges.price,"brakes"==d?(p=A.flight_units.brakes_to_brakes,d="brakes off to brakes on hours"):"brakes_rounded"==d?(p=A.flight_units.brakes_times_rounded,d="rounded brakes off to brakes on hours"):"plane"==d?(p=e,d="plane units"):"session"==d&&(p=1,d="session"),_=p*u);var m=0,f=[];if(A.lubricant_receipts&&0<A.lubricant_receipts.length)for(t=0;t<A.lubricant_receipts.length;t++)1==A.lubricant_receipts[t].reimbursement&&(f.push(A.lubricant_receipts[t]),m=Number.parseFloat(Number.parseFloat(m)+Number.parseFloat(A.lubricant_receipts[t].reimbursed_amount)));var g=o+r+s+l+_-m;A.invoice_totals=A.previous_total+g,A.send.amount=100*A.invoice_totals,A.plane_charges={plane_charge_type:A.bookout.plane_charges.charge_type,plane_unit_price:A.bookout.plane_charges.charge_rate_unit,plane_units:e,plane_total:o,surcharge_charge_type:A.bookout.plane_charges.surcharge_type,surcharge_unit_price:A.bookout.plane_charges.surcharge_fee,surcharge_units:i,surcharge_total:r,landing_units:a,landing_unit_price:A.bookout.plane_charges.landing_fee,landing_total:s,tng_units:c,tng_unit_price:A.bookout.plane_charges.touch_and_go_fee,tng_total:l,tuition_charge_type:d,tuition_unit_price:u,tuition_units:p,tuition_total:_,receipts:f,total:g},A.calculated_invoice=!0},A.instructor_charges=[],A.complete_flight=!1,A.complete_this_flight=function(){if(A.tacho_error_highlight)return alert("You cannot complete a flight where the last meter reading is greater than the start meter reading!"),!1;if(A.this_claim_was_instructional&&(0==A.bookout.instructor_id||0==A.bookout.tuition_id))return alert("You need to add an instructor and tuition type if this flight was instructional."),!1;if(0<A.bookout.instructor_id&&0==A.bookout.tuition_id)return alert("Please select a tuition type for this flight."),!1;if(A.tacho_error_highlight)return alert("You cannot complete a flight where the last meter reading is greater than the start meter reading!"),!1;if(NaN===A.invoice_totals)return alert("Please ensure you have filled in the form above - as the current total for this invoice cannot be calculated without this."),!1;var e=(A.bookout.booking&&0<A.bookout.booking.club_id?A.bookout.booking:A.bookout).club_id;(A.bookout.booking&&0<A.bookout.booking.user_id?A.bookout.booking:A.bookout).user_id;n.GetMandate(A.bookout.payer_id,e).then(function(e){e.success&&(A.info=e.info)}),A.cards=[];e={user_id:A.bookout.payer_id,club_id:e,membership_id:1};x.GetMemberCards(e).then(function(e){A.cards=e.cards,A.savedCards=e.cards}),console.log("CONFIRM BOOKING IS : ",A.bookout.booking_id),A.complete_flight=!0};function H(e,n,o){var i=0;!function t(){z(e,function(e){i++,e?(console.log("Payment confirmed!"),o(!0)):n<=i?(console.log("Max attempts reached, giving up."),o(!1)):A.stop_polling?(console.log("called to stop polling"),o(!1)):(console.log("Retrying in 10000 ms..."),setTimeout(t,1e4))})}()}function z(e,t){k.CheckPayment(e).then(function(e){e.success?(console.log("check payment",e),e.status?(console.log("status = true"),t(!0)):(console.log("status = false"),t(!1))):(console.log("NOTHING SENT?"),t(!1))})}function q(e,t){var n;"home"==e?d.go("dashboard.my_account",{},{reload:!0}):"debrief"==e?(console.log("DEBRIEF!!"),(A.user.id==A.bookout.instructor_id||A.user.id==A.bookout.pic_id&&0<A.bookout.put_id)&&(0<A.bookout.booking_id||0<A.bookout.course_id)?(console.log("DEBRIEF 2!!"),n=0,n=(A.bookout.booking_id<1?t.split:A.bookout).booking_id,t.split?(console.log("DEBRIEF WITH DATA RESPONSE"),console.log(t),d.go("dashboard.manage_user.debriefing",{booking_id:n,plane_log_sheet_id:A.bookout.id,split_next_id:t.split.plane_log_sheet_id,split_booking_id:t.split.booking_id},{reload:!0})):(console.log("DEBRIEF without DATA RESPONSE"),d.go("dashboard.manage_user.debriefing",{booking_id:n,plane_log_sheet_id:A.bookout.id,split_next_id:0,split_booking_id:0},{reload:!0}))):(console.log("DEBRIEF 3!!"),d.go("dashboard.my_account",{},{reload:!0}))):"split"==e?(console.log("SPLIT HERE"),n=0,n=(A.bookout.booking_id<1?t.split:A.bookout).booking_id,(A.user.id==A.bookout.instructor_id||A.user.id==A.bookout.pic_id&&0<A.bookout.put_id)&&(0<A.bookout.booking_id||0<A.bookout.course_id)?(console.log("SPLIT AND DEBRIEF???"),d.go("dashboard.manage_user.debriefing",{booking_id:t.split.booking_id,plane_log_sheet_id:A.bookout.id,split_next_id:t.split.plane_log_sheet_id,split_booking_id:t.split.booking_id},{reload:!0})):d.go("dashboard.my_account.book_in",{id:t.split.plane_log_sheet_id},{reload:!0})):d.go("dashboard.my_account.bookout_with_booking",{booking_id:A.bookout.booking_id},{reload:!0})}function V(){var e;console.log("PRESELECT TUITION NOW"),1==A.club_courses.length&&(A.bookout.course_id&&0!=A.bookout.course_id||(A.bookout.course_id=A.club_courses[0].id,A.bookout.course=A.club_courses[0])),console.log(A.bookout.course_id),console.log(A.club_courses),0<A.bookout.course_id&&(e=A.club_courses.find(function(e){return e.id===A.bookout.course_id}),A.bookout.course=e),1==A.instructor_charges.length&&(A.bookout.tuition_required=A.instructor_charges[0]),A.update_tuition_charges()}function K(t){var e;A.bookout.booking_id=t.booking_id,A.bookout.club_id=t.club_id,A.bookout.user_id=t.user_id,A.bookout.plane=t.plane,A.club_id=t.club_id,A.is_split_flight=t.is_split_flight,A.send={club_id:A.bookout.club_id,user_id:A.user.id},C.GetCurrencies(A.club_id).then(function(e){A.currencies=e.currencies,A.club_currency=e.club_currency,A.receipt.currency=$.grep(A.currencies,function(e){return e.iso_code==A.club_currency})[0]}),(-1<A.user.access.instructor.indexOf(A.club_id)||-1<A.user.access.manager.indexOf(A.club_id))&&(A.can_authorise=!0),A.invoices=[],A.previous_total=0,A.free_flight=!1,t.booking&&1==t.booking.maintenance_flight&&(A.free_flight=!0),1==A.is_split_flight?O.GetAllByBooking(t.booking_id).then(function(t){if(t.success){A.previous_invoice=t.invoices;for(var n=0;n<t.invoices.length;n++)Object.keys(t.invoices[n].flights).forEach(function(e){e=t.invoices[n].flights[e];A.invoices.push(e),A.previous_total=Number.parseFloat(A.previous_total)+Number.parseFloat(e.total)})}}):console.log("NOT SPLIT?"),C.GetOpenIssues(t.plane_id).then(function(e){A.reported_defects=e}),C.GetAllSheetReceipts(A.bookout.id).then(function(e){A.lubricant_receipts=e}),S.GetByClubId(t.club_id).then(function(e){A.instructor_charges=e.items}),(t&&0<t.id||A.try_split)&&(console.log("PIC ID: ",t.pic_id),A.pics&&t.pic_id&&(o=A.pics.find(function(e){return e.user_id===t.pic_id}),console.log("selected_pic : ",o),A.bookout.pic=o),n=A.flight_types.find(function(e){return e.id===t.detail_type_id}),A.bookout.flight_type=n,t.instructor&&""!==t.instructor&&t.instructor.user_id==t.pic_id&&(A.bookout.put=A.bookout.user),A.pics&&t.put_id&&(e=A.pics.find(function(e){return e.user_id===t.put_id}),console.log("selected_put : ",e),A.bookout.put=e),A.bookout.authorised_solo=1==t.authorised_solo,A.bookout.from_airfield=t.from_airport,A.bookout.to_airfield=t.to_airport,0<t.course_id?A.bookout.course_id=t.course_id:t.booking&&t.booking.course_id&&0<t.booking.course_id&&(A.bookout.course_id=t.booking.course_id),A.bookout.start_tacho=Number.parseFloat(t.last_tacho),A.start_tacho_orig=t.last_tacho,A.bookout.instructor=t.instructor,o=A.pics.find(function(e){return e.user_id===t.pic_id}),A.bookout.pic=o),t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.wgs_n&&(A.wgs_n=t.plane_details.location.wgs_n,A.wgs_e=t.plane_details.location.wgs_e);var n,o="",o=t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.code?t.plane_details.location.code.slice(0,-1):"EG";k.GetAirfieldsByCode(o).then(function(e){e.success&&(A.airfields=e.airfields)}),t.fox_log_id&&0<t.fox_log_id?(A.auto_claim=1,n=A.bookout.from_airport.id==A.bookout.to_airport.id?2<A.bookout.touch_and_go?A.flight_types.find(function(e){return 3===e.id}):A.flight_types.find(function(e){return 1===e.id}):A.flight_types.find(function(e){return 2===e.id}),A.bookout.flight_type=n,A.bookout.brakes_off={time:A.bookout.brakes_off},A.bookout.brakes_on={time:A.bookout.brakes_on},A.bookout.tng=A.bookout.touch_and_go,A.bookout.landings=A.bookout.full_stop_landings,A.bookout.fox_claimed=1,A.has_used_claimed_flight=!0,A.has_requested_to_change_times=!1,A.claimed_flight&&0<A.claimed_flight.id&&(A.bookout.claimed_fox_plane_log_sheet_id=A.claimed_flight.id),0<A.bookout.fox_log_id&&(A.bookout.claimed_fox_plane_log_sheet_id=A.bookout.fox_log_id),A.flight_units.brakes_to_brakes=A.bookout.brakes_time,A.flight_units.airborne_times=A.bookout.airborne_time,A.flight_units.flight_time=A.bookout.flight_time,A.flight_units.brakes_times_rounded=A.bookout.brakes_times_rounded,A.calculate_invoice_for_flight(),A.flight_times_complete=!0):"airborne"!=A.bookout.plane_charges.charge_type&&"flight"!=A.bookout.plane_charges.charge_type||(A.show_takeoff_landing_times=!0),I.GetCoursesByClubId(t.club_id).then(function(e){A.club_courses=e.items,(0<A.bookout.instructor_id||0<A.bookout.put_id||A.this_was_instructional_claim||A.this_claim_was_instructional||0<A.bookout.course_id)&&V()}),A.scroll&&(A.scroll=!1,P.toTop(),A.show_loading=!1)}A.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},A.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return(t=1==t?"":"-")+n+":"+(e=e.length<2?"0"+e:e)},A.book_in_flight=function(){for(var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"home",e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"none",t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"",o=!(A.show_loading=!0),i=0,r=0,a=0;a<A.lubricant_receipts.length;a++)"Fuel"==A.lubricant_receipts[a].item?r=Number.parseFloat(r)+Number.parseFloat(A.lubricant_receipts[a].quantity):i=Number.parseFloat(i)+Number.parseFloat(A.lubricant_receipts[a].quantity);if(parseInt(parseInt(A.bookout.landings)+parseInt(A.bookout.tng)+parseInt(A.bookout.remote_landings))<1){if(!confirm("It looks as though you didn't land, is that correct?"))return!1;o=!0}if(("tacho"==A.bookout.plane_charges.charge_type||"hobbs"==A.bookout.plane_charges.charge_type)&&Number.parseFloat(A.start_tacho_orig)!==Number.parseFloat(A.bookout.start_tacho)){if(!confirm("It looks as though your start meter reading ["+A.bookout.start_tacho+"] is not the same as the previous flight's last meter reading of "+A.start_tacho_orig+" - is that correct?"))return!1;o=!0}var s=0;(0==(s=0<A.bookout.instructor_id&&0<A.bookout.tuition_id?1:s)&&0<A.put_id&&A.pic_id!==A.put_id||0==s&&0<A.put_id)&&(s=1);var c=0,l=0;A.this_was_supervised_solo&&(c=1,A.bookout.instructor&&A.bookout.instructor.user_id?l=A.bookout.instructor.user_id:0<A.bookout.instructor_id&&(l=A.bookout.instructor_id));var d=A.bookout.user_id;d&&0!=d||(d=A.bookout.payer_id);var u=A.bookout.instructor_id;(!u||0==u&&1==s&&0<A.bookout.pic_id)&&(u=A.bookout.pic_id);var _=A.bookout.put_id;0==_&&1==s&&(_=A.bookout.payer_id);var p=A.bookout.pic_id;0==(p=0==p&&0==s?A.bookout.payer_id:p)&&0<A.bookout.payer_id&&0==u&&(p=A.bookout.payer_id);var m=(1==A.bookout.flight_type.id?A.bookout.from_airfield:A.bookout.to_airfield).id;1==s&&u<1&&console.log("did we forget to set the FI?");var f={method:{},method_name:""},o={user_id:d,club_id:A.bookout.club_id,plane_id:A.bookout.plane_id,instructor_id:u,booking_id:A.bookout.booking_id,payer_id:A.bookout.payer_id,plane_log_sheet:{dual_flight:s,authorised_solo:c,authorised_by:l,tuition_id:A.bookout.tuition_id,course_id:A.bookout.course_id,club_id:A.bookout.club_id,plane_id:A.bookout.plane_id,pic_id:p,put_id:_,user_id:d,payer_id:A.bookout.payer_id,detail_type_id:A.bookout.flight_type.id,from_airport_id:A.bookout.from_airfield.id,to_airport_id:m,tacho_start:A.bookout.start_tacho,tacho_end:A.bookout.end_tacho,brakes_off:A.bookout.brakes_off.time,brakes_on:A.bookout.brakes_on.time,oil_uplift_litres:i,fuel_uplift_litres:r,full_stop_landings:A.bookout.landings,touch_and_go:A.bookout.tng,remote_landings:A.bookout.remote_landings,booked_in:1,original_id:A.this_pls_id_raw.id,booked_in_by:A.user.id},invoice:function(){var e=[];if(A.package_used&&A.package_removed&&0<A.package_removed.length)for(var t=0;t<A.package_removed.length;t++){var n=0<A.package_removed[t].hours_dual_spent?A.package_removed[t].hours_dual_spent:A.package_removed[t].hours_solo_spent;e.push({package_id:A.package_removed[t].package_id,title:"Package: "+A.package_removed[t].title,hours:n,hours_type:A.package_removed[t].solo_dual,member_packages_id:A.packages[t].id,unit_price:0,total:0,organise:0})}e.push({title:"Aircraft "+A.plane_charges.plane_charge_type+" Charge",unit:A.plane_charges.plane_units,unit_price:A.plane_charges.plane_unit_price,total:A.plane_charges.plane_total,organise:0}),0<A.plane_charges.surcharge_total&&e.push({title:"Surcharge per "+A.plane_charges.surcharge_charge_type,unit:A.plane_charges.surcharge_units,unit_price:A.plane_charges.surcharge_unit_price,total:A.plane_charges.surcharge_total,organise:1}),0<A.plane_charges.tuition_total&&e.push({title:"Tuition Charge - "+A.bookout.tuition_required.title,unit:A.plane_charges.tuition_units,unit_price:A.plane_charges.tuition_unit_price,total:A.plane_charges.tuition_total,organise:2}),0<A.plane_charges.landing_total&&e.push({title:"Home Landing",unit:A.plane_charges.landing_units,unit_price:A.plane_charges.landing_unit_price,total:A.plane_charges.landing_total,organise:4}),0<A.plane_charges.tng_total&&e.push({title:"Home Touch and Go",unit:A.plane_charges.tng_units,unit_price:A.plane_charges.tng_unit_price,total:A.plane_charges.tng_total,organise:3});for(t=0;t<A.plane_charges.receipts.length;t++){var o=parseInt(5+t);e.push({title:"Reimbursement - "+A.plane_charges.receipts[t].item,unit:A.plane_charges.receipts[t].quantity,unit_price:A.plane_charges.receipts[t].price/A.plane_charges.receipts[t].quantity,total:-A.plane_charges.receipts[t].price,organise:o})}return e}(),paying_now:A.complete_flight,pay_with:f,free_flight:A.free_flight,paymentIntent:t,flag_flight:o};"new-card"==e||"saved-card"==e?(o.paymentIntent=t,o.method=e,o.pay_with.method=e,o.pay_with.method_name=e):"direct-debit"==e?(o.method=e,o.pay_with.method=e,o.pay_with.method_name=e):"card-machine"==e?(o.paymentIntent=t,o.method=e,o.pay_with.method=e,o.pay_with.method_name=e):"free"==e&&(o.method=e,o.pay_with.method=e,o.pay_with.method_name=e),0==m&&(o.plane_log_sheet.new_to_airport=A.bookout.to_airfield,o.plane_log_sheet.new_to_airport.title=o.plane_log_sheet.new_to_airport.title.replace("NOT LISTED : ","")),0==A.bookout.from_airfield.id&&(o.plane_log_sheet.new_from_airport=A.bookout.from_airfield,o.plane_log_sheet.new_from_airport.title=o.plane_log_sheet.new_from_airport.title.replace("NOT LISTED : ","")),o.plane_log_sheet.fox_log_id=A.bookout.fox_log_id,o.plane_log_sheet.fox_claimed=1,o.plane_log_sheet.takeoff_time=A.bookout.takeoff_time,o.plane_log_sheet.landing_time=A.bookout.landing_time,A.has_used_claimed_flight&&A.claimed_flight&&A.claimed_flight.takeoff_time&&""!==A.claimed_flight.takeoff_time&&(o.plane_log_sheet.takeoff_time=A.claimed_flight.takeoff_time,o.plane_log_sheet.landing_time=A.claimed_flight.landing_time,o.plane_log_sheet.landing_rounded=A.claimed_flight.landing_rounded,o.plane_log_sheet.takeoff_rounded=A.claimed_flight.takeoff_rounded),o.plane_log_sheet.brakes_time=A.flight_units.brakes_to_brakes,o.plane_log_sheet.airborne_time=A.flight_units.airborne_times,o.plane_log_sheet.claimed_fox_plane_log_sheet_id=A.claimed_flight.id,A.split_flight&&A.split_one&&(o.plane_log_sheet.brakes_off_rounded=A.split_one.brakes_off_rounded,o.plane_log_sheet.brakes_on_rounded=A.split_one.brakes_on_rounded,o.plane_log_sheet.takeoff_time=A.split_one.takeoff_time,o.plane_log_sheet.landing_time=A.split_one.landing_time,o.plane_log_sheet.takeoff_rounded=A.split_one.takeoff_rounded,o.plane_log_sheet.landing_rounded=A.split_one.landing_rounded,o.plane_log_sheet.airborne_rounded=A.split_one.airborne_rounded,o.plane_log_sheet.brakes_times_rounded=A.split_one.brakes_times_rounded,o.plane_log_sheet.brakes_time=A.split_one.brakes_time,o.plane_log_sheet.flight_time=A.split_one.flight_time,o.plane_log_sheet.airborne_time=A.split_one.airborne_time,o.plane_log_sheet.flight_time=A.split_one.flight_time),1==A.split_flight&&A.split_two&&""!==A.split_two&&(console.log("vm.bookout.booking_id ",A.bookout.booking_id),console.log("vm.split_two.booking ",A.split_two.booking),delete A.split_two.booking,delete A.split_two.passengers,delete A.split_two.from_airport,delete A.split_two.to_airport,delete A.split_two.plane_charges,delete A.split_two.tuition_charges,delete A.split_two.tuition_required,delete A.split_two.pilot_in_command,delete A.split_two.home_airport_id,delete A.split_two.aircraft,delete A.split_two.stops,delete A.split_two.user,delete A.split_two.last_tacho,delete A.split_two.instructor,delete A.split_two.id,0<m&&m!==A.split_two.from_airport_id&&(A.split_two.from_airport_id=m),A.split_two&&A.split_two.brakes_on&&A.split_two.brakes_on.time&&(A.split_two.brakes_on=A.split_two.brakes_on.time),A.split_two&&A.split_two.brakes_off&&A.split_two.brakes_off.time&&(A.split_two.brakes_off=A.split_two.brakes_off.time),A.split_two&&(A.split_two.is_split_flight=1),A.split_two&&o.plane_log_sheet.booking_id&&0<o.plane_log_sheet.booking_id&&(A.split_two.booking_id=o.plane_log_sheet.booking_id),o.plane_log_sheet.split_two=A.split_two,o.plane_log_sheet.is_split_flight=1),A.is_split_flight&&1==A.is_split_flight&&0==A.split_flight&&(o.plane_log_sheet.is_split_complete=1),o&&o.plane_log_sheet&&o.plane_log_sheet.takeoff_time&&o.plane_log_sheet.takeoff_time.time&&""!==o.plane_log_sheet.takeoff_time.time&&(o.plane_log_sheet.takeoff_time=o.plane_log_sheet.takeoff_time.time),o&&o.plane_log_sheet&&o.plane_log_sheet.landing_time&&o.plane_log_sheet.landing_time.time&&""!==o.plane_log_sheet.landing_time.time&&(o.plane_log_sheet.landing_time=o.plane_log_sheet.landing_time.time),k.BookInFlight(A.bookout.id,o).then(function(t){A.after_where_to=n,(A.after_data=t).success?(console.log("paymentID",A.paymentID),t.paymentID&&(A.payment_id=t.paymentID,A.paymentID=t.paymentID),"cardmachine"==f.method_name?(console.log("paymentID 1",A.paymentID),console.log("paymentID 2",t.paymentID),A.show_cardmachine=!0,H(t.paymentID,30,function(e){e?(A.stop_polling=!0,A.show_loading=!1,q(n,t)):A.show_loading=!1}),console.log("check_payment ",z)):(A.show_loading=!1,A.stop_polling=!0,q(n,t))):"stripe"==f.method_name&&t.card_processor?(console.log("BEFORE STRIPE = ",t),Stripe("pk_test_51QttFFG8WiGSRCORyxkdZTO8oajcqz9OUsvcDJFpr9FB2PAdbzJc0tS7WNnfzKYsTiqHN1YDZi5UtXk4K52SeD4h00YWXuChNd").confirmCardPayment(t.client_secret,{payment_method:t.payment_method,return_url:t.card_url.return_url}).then(function(e){console.log(e),e.error?(console.error(e.error),"payment_intent_authentication_failure"==e.error.code&&(A.show_loading=!1,q(n,t))):"succeeded"===e.paymentIntent.status?(console.log("Payment successful!"),k.CheckPayment(t.paymentID).then(function(e){e.success?(A.show_loading=!1,q(n,e)):(console.log("NOTHING SENT?"),A.show_loading=!1)})):(console.log("not sure what happened"),A.show_loading=!1)})):t.error?(alert("There was an error connecting to the card machine - please ensure that the card machine is ON and connected to the internet."),A.show_loading=!1,A.show_cardmachine=!0):(alert("an error occurred.... \n\n "+t.message),A.show_loading=!1)})},A.close_machine_popup=function(){k.ClearMachine(A.payment_id,A.club_id).then(function(e){e.success?console.log("machine should be clear now?",e):console.log("No success on card machine clear"),A.show_cardmachine=!1,A.show_after_bookedin=!0})},A.cancel_machine=function(){k.ClearMachine(A.payment_id,A.club_id).then(function(e){e.success?(console.log("machine should be clear now?",e),A.show_cardmachine=!1,A.show_after_bookedin=!0,A.stop_polling=!0):(console.log("No success on card machine clear"),A.show_after_bookedin=!0)})},A.close_bookedin=function(){k.ClearMachine(A.payment_id,A.club_id).then(function(e){console.log("regardless of clear - should now be cleared?"),A.show_cardmachine=!1,A.show_after_bookedin=!1,A.stop_polling=!0,q(A.after_where_to,A.after_data)})},A.reset_card_machine=function(){console.log("retry",A.payment_id),k.RetryPaymentMachine(A.payment_id,A.club_id).then(function(e){console.log(e),e.success?(alert("The card machine should hopefully be displaying the payment now"),A.stop_polling=!1,H(A.payment_id,30,function(e){e?(alert("Payment confirmed!"),A.stop_polling=!0,q(A.after_where_to,A.after_data)):alert("Payment not confirmed - please try again")})):(0==e.success&&"The payment has already been successfully made."==e.message&&(A.stop_polling=!0,q(A.after_where_to,A.after_data)),alert(e.message))}),A.show_cardmachine=!0},A.this_claim_was_instructional=!1,A.this_was_supervised_solo=!1,A.start_tacho_orig,A.send={},l.popup=[],l.open=function(e,t){l.popup[e]&&1==l.popup[e].opened?(t.preventDefault(),t.stopPropagation()):l.popup[e]={opened:!0}},l.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],l.format=l.formats[0],l.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1}}function Bookings2Controller(n,t,o,e,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y){var v=this;c.va1="123",v.user=a.globals.currentUser,v.allUsers=[],v.club={},v.page_title="",v.club.member={},v.imported_new_headers=[],v.see_booking={},v.is_current=!1,v.currency_type="",v.currency_days="",v.booking_self=!0,v.times_clean_type="start_times",c.club_timezone="Europe/London",v.club_timezone="Europe/London",v.is_edit_show_all=!1,v.action=l.current.data.action,v.return_to=l.current.data.return_to,v.user_id=v.user.id,v.no_show_cols=["membership_start","membership_id","selected"];var k=new Date,w=Math.floor(8),a=Math.floor(18);new Date(k.getFullYear(),k.getMonth(),k.getDate(),w,0,0),new Date(k.getFullYear(),k.getMonth(),k.getDate(),a,0,0);v.default_date=new Date,v.datepickerOptions={customClass:S,format:"dd/MM/yyyy",showWeeks:!1},v.dateTimeRangePickerOptions={hour_step:1,minute_step:30,min_date:C,datepicker:{customClass:S,format:"dd/MM/yyyy",showWeeks:!1,minDate:C},business_hours:{from:"09:00",to:"22:30"}},c.whole_day_booking=!1,v.instructor_charges=[],v.cancellation={reasons:["Pilot Unwell","Pilot Unavailable","Weather at home base","Weather at destination","Plane Unavailable","Plane Unserviceable","Plane Returned Too Late by previous booking","Instructor Not Available","Airfield Closed","Airspace Closed","Other - please specify"],notes:""};var C=new Date;C.setMinutes(0),C.setSeconds(0);a=new Date;a.setHours(a.getHours()+2),a.setSeconds(0);(new Date).format("d/M/yyyy");v.start_times=[],v.end_times=[],v.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],options:v.dateTimeRangePickerOptions},c.toggle=!0,c.whentimechangedata={},c.overridePicker=!0;Date();switch(v.planes=[],function(){for(var e=0;e<24;e+=v.new_booking.options.hour_step)if(v.new_booking.options.minute_step&&0<v.new_booking.options.minute_step)for(var t=0;t<60/v.new_booking.options.minute_step;t++){var n=v.new_booking.options.minute_step*t;n=(n<10?"0":"")+n,v.start_times.push({time:e+":"+n,disabled:B(e,n)}),v.end_times.push({time:e+":"+n,disabled:B(e,n),duration:""})}else v.start_times.push({time:e+":00",disabled:B(e)}),v.end_times.push({time:e+":00",disabled:B(e),duration:""})}(),c.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],c.format=c.formats[0],v.action){case"add":v.page_title="Add a Booking",v.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],options:v.dateTimeRangePickerOptions},M();break;case"edit":v.page_title="Edit a Booking",v.see_booking.visible=0,v.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],options:v.dateTimeRangePickerOptions},M(),D(),d.booking_id&&b.GetEdit(v.user.id,d.booking_id).then(function(e){if(e.success){if(v.new_booking=e.booking,(-1<v.user.access.instructor.indexOf(e.booking.club_id)||-1<v.user.access.manager.indexOf(e.booking.club_id))&&(v.show_self_option=!0),e.booking.user_id==v.user.id?v.booking_self=!0:v.booking_self=!1,1==e.booking.maintenance_flight&&(v.new_booking.maintenance_flight=!0),v.new_booking.options=v.dateTimeRangePickerOptions,v.new_booking.edit_booking=1,v.new_booking.start_date=moment(v.new_booking.start).toDate(),v.new_booking.start_time={time:moment(v.new_booking.start).format("HH:mm")},v.new_booking.end_date=moment(v.new_booking.end).toDate(),v.new_booking.end_time={time:moment(v.new_booking.end).format("HH:mm")},v.new_booking.after_booking_end=moment().isAfter(moment(v.new_booking.end)),v.new_booking.instructor&&v.new_booking.instructor.id==v.user_id&&(v.booking_self=!1),c.$parent.vm.default_date=v.new_booking.start_date,setTimeout(function(){c.$parent.vm.see_booking&&(c.$parent.vm.see_booking.visible=1),$("#calendar").fullCalendar("gotoDate",v.new_booking.start_date),setTimeout(function(){console.log("ID IS : ",d.booking_id);var e=parseInt($("a.fc-timeline-event.booking"+d.booking_id).css("left"))+parseInt($("a.fc-timeline-event.booking"+d.booking_id).width())/2-$("tbody .fc-time-area .fc-scroller").width()/2;$("tbody .fc-time-area .fc-scroller").animate({scrollLeft:e},1800)},1e3),c.$apply()},800),E(),c.update_dateTime("edit"),y.GetCoursesByClubId(v.new_booking.club_id).then(function(e){v.courses=e.items,v.new_booking.tuition_required=v.courses.find(function(e,t){if(e.id==v.new_booking.course_id)return!0})}),T(v.new_booking.club_id,v.new_booking.end),v.new_booking.rental_items)for(var t=0;t<v.new_booking.rental_items.length;t++)v.new_booking.rental_items[t].number_to_book=parseInt(v.new_booking.rental_items[t].number_to_book);v.new_booking.free_seats&&(v.new_booking.free_seats=parseInt(v.new_booking.free_seats)),console.log("here"),v.new_booking.instructor&&console.log("MY INSTRUCTOR HERE22: ",v.new_booking.instructor),0!=v.club_id&&v.club_id||!v.new_booking.plane||!v.new_booking.plane.id||(v.club_id=v.new_booking.plane.club_id),P()}else alert("Booking Error \n \n"+e.message),l.go("dashboard.add_booking")});break;case"list":v.show_no_membership_message=!1,v.hide_dropdown=!1,v.clubs=[],o.GetUserClubs(v.user.id).then(function(e){v.clubs=e.clubs,v.clubs&&1<v.clubs.length?v.hide_dropdown=!0:1==v.clubs.length&&(v.club_id=v.clubs[0].id),D()})}function S(e){var t=e.date;if("day"===e.mode)for(var n=new Date(t).setHours(0,0,0,0),o=0;o<c.events.length;o++)if(n===new Date(c.events[o].date).setHours(0,0,0,0))return c.events[o].status;return""}function x(e){var t=0<arguments.length&&void 0!==e?e:null,n=new Date,e=v.new_booking.start_time?v.new_booking.start_time.time.split(":"):[n.getHours(),n.getMinutes()],n=new Date(v.new_booking.start_date);n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0);var o,i=moment(n).add(1,"hour").format();R()||!v.new_booking.end_time?(G(N(v.new_booking.end_date,"end"),"end_times",n),v.end_times.some(function(e,t){if(e.time==moment(i).format("H:mm"))return o=t}),v.new_booking.end_time={},v.new_booking.end_time=v.end_times[o]):t||G(N(v.new_booking.end_date,"end"),"end_times",n),v.new_booking.end_time&&1==v.new_booking.end_time.disabled&&(v.end_times.some(function(e,t){if(e.time==moment(i).format("H:mm"))return o=t}),v.new_booking.end_time={},v.new_booking.end_time=v.end_times[o]),v.new_booking.start_time&&1==v.new_booking.start_time.disabled&&(t||(v.start_times.some(function(e,t){if(0==e.disabled)return o=t}),v.new_booking.start_time={},v.new_booking.start_time=v.start_times[o]),A())}function O(){v.start_times.forEach(function(e,t){e.time==v.new_booking.start_time.time&&(v.new_booking.start_time=v.start_times[t])}),v.end_times.forEach(function(e,t){e.time==v.new_booking.end_time.time&&(v.new_booking.end_time=v.end_times[t])}),c.$apply()}function D(){b.GetAll(v.user.id,moment().format("Y-MM-DD"),"").then(function(e){return c.all_events=e.events,c.all_resources=e.resources,e})}function I(n,e){(1<arguments.length&&void 0!==e?e:null)&&(v.booking_errors={},v.error_event={});var t,o=jQuery.extend({},n);if(n.resourceId&&""!==n.resourceId)o.plane_id=n.resourceId;else if(n.resourceIds&&0<n.resourceIds.length)for(var i=0;i<n.resourceIds.length;i++)-1==n.resourceIds[i].indexOf("fi")&&(o.plane_id=n.resourceIds[i]);else console.log("EVENT HAS AN ISSUE WITH RESORUCE ID...");""!==n.instructor_id?o.instructor_id=n.instructor_id:o.instructor_id="0",delete o._start,delete o._end,delete o._id,delete o.source,delete o._allDay,delete o.allDay,delete o.className,delete o.plane,delete o.title,delete o.editable,delete o.resourceId,delete o.resourceIds,o.update_rental_items=!0;for(i=0;i<c.all_events.length;i++)c.all_events[i].id==o.id&&(t=c.all_events[i]);if(moment(Date.parse(o.end))<moment())alert("This booking ends in the past - you cannot amend a booking in the past.");else{if(moment(o.start).add(30,"minutes")<moment()&&moment(t.end)!==o.end){if(!confirm("This booking starts in the past - you cannot amend the start date or time of a booking in the past, would you like to amend the end time along with any other changes you have made?"))return;o.start=t.start}b.updateBooking(o,v.user.id).then(function(e){var t;return 1==e.success?(o.edit_booking,alert("Your changes were saved successfully"),"bookout"==v.return_to?l.go("dashboard.my_account.bookout_with_booking",{booking_id:n.id}):l.go("dashboard.add_booking")):(t=[],!0!==e.instructor?t.push({type:"instructor",message:"It looks like your instructor is not available on the updated date and time",api:e.instructor,override:"instructor_override",can_override:e.can_override,button:"OVERRIDE INSTRUCTOR AVAILABILITY"}):!0!==e.check_user?-1<e.check_user.indexOf("self-certify")?t.push({type:"check_user",message:"It would appear that you are not within the currency requirements to book this aircraft for this flight.",api:e.check_user,override:"currency_override",button:"I am Current"}):t.push({type:"check_user",message:"It looks like your user account does not allow this booking to happen",api:e.check_user,override:"currency_override",can_override:e.can_override,button:""}):!0!==e.rental_items&&t.push({type:"rental_items",message:"It looks like some of the rental items are not available",api:e.rental_items,override:"update_rental_items",button:"Confirm Changes"}),v.booking_errors=t,v.error_event=o),e})}}function M(){v.new_booking.options=v.dateTimeRangePickerOptions;for(var e=0;e<24;e+=v.new_booking.options.hour_step)if(v.new_booking.options.minute_step&&0<v.new_booking.options.minute_step)for(var t=0;t<60/v.new_booking.options.minute_step;t++){var n=v.new_booking.options.minute_step*t;v.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:B(e,n)}),v.end_times.push({time:e+":"+n,disabled:B(e,n),duration:""})}else v.start_times.push({time:e+":00",disabled:B(e)}),v.end_times.push({time:e+":00",disabled:B(e),duration:""})}function P(){v.free_seats=[],console.log("NEW_BOOKING - PLANE: ",v.new_booking.plane);var e=parseInt(v.new_booking.plane.seats)-1;if(v.new_booking.instructor&&0<v.new_booking.instructor.id&&e--,0<v.new_booking.passengers.length)for(var t=0;t<v.new_booking.passengers.length;t++)v.new_booking.passengers[t]&&""!==v.new_booking.passengers[t].email&&e--;v.free_seats=[];for(t=0;t<e;t++)v.free_seats.push(t)}function A(){var o,e;v.new_booking.start_date&&v.new_booking.start_time&&(o=new Date(v.new_booking.start_date),e=v.new_booking.start_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),v.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(v.new_booking.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=function(e){var t=moment.duration(e).days(),n=moment.duration(e).hours(),o=moment.duration(e).minutes();59==o&&(n++,o=0);e="";0<t&&(e=e+" "+t+" day",e=1<t?e+"s":e);0<n&&(e=e+" "+n+" hour",e=1<n?e+"s":e);0<o&&(e=e+" "+o+" minute",e=1<o?e+"s":e);return e}(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?v.end_times[t].disabled=1:v.end_times[t].duration="( "+n+" )"):v.end_times[t].duration=""}))}c.back=function(){p.history.back()},c.test=function(){v.new_booking.instructor={id:90,first_name:"A",last_name:"REYNIER"}},c.updateEvents=function(e,t){b.GetAll(v.user.id,e,t).then(function(e){return c.all_events=e.events,c.all_resources=e.resources,e})},c.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),m(t)(c)},c.alertOnClicked=function(e,t,n){v.see_booking=e,v.see_booking.start_date=moment(v.see_booking.start).format("DD/MM/YYYY"),v.see_booking.end_date=moment(v.see_booking.end).format("DD/MM/YYYY"),v.see_booking.start_time=moment(v.see_booking.start).format("HH:mm"),v.see_booking.end_time=moment(v.see_booking.end).format("HH:mm"),v.see_booking.start_datetime=new Date(new Date(v.see_booking.start).toUTCString()),v.see_booking.end_datetime=new Date(v.see_booking.end),v.see_booking.visible=1,v.see_booking.after_booking_end=moment().isAfter(moment(v.see_booking.end)),c.$apply()},c.close_details=function(){v.see_booking.visible=0},c.changeLang=function(){c.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],c.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},c.changed=function(){c.check_plane_availability()},c.check_plane_availability=function(){E();var o=1==v.new_booking.edit_booking?1:0,e=0<v.new_booking.plane_id?v.new_booking.plane_id:0;v.new_booking.plane&&v.new_booking.plane.id&&(e=v.new_booking.plane.id),console.log("START BOOKINGS 2",v.new_booking.start_datetime),console.log(v.new_booking.start_datetime),console.log(v.new_booking.end_datetime),console.log("START BOOKINGS 2",new Date(v.new_booking.start_datetime).toISOString());var t=new Date(v.new_booking.start_datetime).toISOString(),n=new Date(v.new_booking.end_datetime).toISOString(),i=v.is_edit_show_all?1:0;b.GetAllPlanes(v.user.id,t,n,i,e).then(function(e){if(v.planes=e,1==o)for(var t=0;t<v.planes.length;t++)v.planes[t].id==v.new_booking.plane.id&&(n=0,v.new_booking.plane=v.planes[t],c.check_rental_items());else{var n=1;if(v.new_booking.plane){for(t=0;t<v.planes.length;t++)v.planes[t].id==v.new_booking.plane.id&&(n=0,c.check_rental_items());1==n&&(v.new_booking.plane={},delete v.new_booking.plane)}}})},c.events=[],c.addOne=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;e&&!n&&(n=moment(e).add(1,"hour").format()),"list"==v.action||"add"==v.action?(console.log("add it yeah"),v.add_booking_event({start:e,plane_id:t,end:n})):"edit"==v.action&&l.go("dashboard.add_booking",{start:e,plane_id:t,end:n})},c.cancel_changes=function(){l.go("dashboard.add_booking")},c.check_rental_items=function(){var e,t,n;E(),v.rental_items=[],v.new_booking.plane&&(e=(1==v.new_booking.edit_booking?v.new_booking:v.new_booking.plane).club_id,t=new Date(v.new_booking.start_datetime).toISOString(),n=new Date(v.new_booking.end_datetime).toISOString(),b.GetRentalItems(e,t,n,0).then(function(e){if(v.rental_items=e,v.new_booking.rental_items)for(var t=0;t<v.new_booking.rental_items;t++){for(var n=0,o=0;o<v.rental_items.length;o++)if(v.rental_items[o].id==v.new_booking.rental_items[t].id){parseInt(v.new_booking.rental_items[t].number_to_book)>parseInt(v.rental_items[o].number_available)&&(v.new_booking.rental_items[t].number_to_book=parseInt(v.rental_items[o].number_available)),v.new_booking.rental_items[t].number_available=parseInt(v.rental_items[o].number_available),n=1;break}0==n&&delete v.new_booking.rental_items[t]}for(var i=0;i<v.rental_items.length;i++)v.rental_items[i].number=0;if(v.new_booking.rental_items)for(o=0;o<v.new_booking.rental_items;o++){for(var r=1,t=0;t<v.rental_items.length;t++)v.rental_items[t].id==v.new_booking.rental_items[o].id&&(r=0);1==r&&delete v.new_booking.rental_items[o]}}))},c.update_dateTime=function(e){var t,n,o,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;switch(e){case"start_date":j(),v.new_booking.start_date>v.new_booking.end_date&&(v.new_booking.end_date=v.new_booking.start_date),G(N(v.new_booking.start_date),"start_times"),x(),R()&&L();break;case"end_date":j(),x(),v.new_booking.end_date<v.new_booking.start_date?(v.new_booking.start_date=v.new_booking.end_date,G(N(v.new_booking.start_date),"start_times")):(G(N(v.new_booking.start_date),"start_times"),G(N(v.new_booking.end_date,"end"),"end_times")),R()&&L();break;case"start_time":j(),x(),A();break;case"end_time":"past"==v.times_clean_type?x("edit"):x();break;case"edit":v.is_edit_show_all=!0,v.times_clean_type="start_times",moment(v.new_booking.start).unix()<moment().unix()?v.times_clean_type="past":(x(),j()),A(),setTimeout(function(){O()},500);break;case"edit2":j(),G(N(v.new_booking.start_date),"start_times"),x(),A(),setTimeout(function(){if(O(),i)for(var e=0;e<v.planes.length;e++)parseInt(v.planes[e].id)==i&&(v.new_booking.plane=v.planes[e],c.getPlaneInstructors(v.new_booking.plane.id),c.$apply())},500)}c.check_plane_availability(),v.new_booking.plane&&c.check_rental_items(),v.new_booking.plane&&c.getPlaneInstructors(),v.new_booking.plane&&(v.new_booking.start_date,t=moment(v.new_booking.start_date).format("Y-MM-DD"),n=v.new_booking.start_time.time,e=moment(t+" "+n),t=moment(v.new_booking.end_date).format("Y-MM-DD"),n=v.new_booking.end_time.time,n=moment(t+" "+n),o={id:"TEMP",title:"TEMPORARY",resourceId:parseInt(v.new_booking.plane.id),start:e,end:n,editable:!1,color:"rgb(255, 110, 110)",opacity:"1"},v.already_added_temp?($("#calendar").fullCalendar("removeEvents","TEMP"),setTimeout(function(){$("#calendar").fullCalendar("renderEvent",o)},150)):($("#calendar").fullCalendar("renderEvent",o),v.already_added_temp=!0))},v.decline_new_booking_error=function(){v.new_booking_errors={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},v.override_new_booking_errors=function(){v.new_booking.admin_override=!0,v.new_booking_errors={},c.make_booking(!0)},c.update_booking=function(e){if(E(),e){e={};if(delete(e=jQuery.extend(!0,{},v.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,delete e.after_booking_end,e.free_seats=v.new_booking.free_seats.constructor===Array?0:v.new_booking.free_seats,e.start=v.new_booking.start_datetime,e.end=v.new_booking.end_datetime,v.new_booking.tuition_required&&0<v.new_booking.tuition_required.id&&(e.course_id=v.new_booking.tuition_required.id),e.maintenance_flight=v.new_booking.maintenance_flight,moment(Date.parse(v.new_booking.end_datetime)).add(1,"hour").isBefore())return alert("This booking ends in the past by more than an hour - you cannot amend a booking that finished in the past."),!1;e.resourceId=v.new_booking.plane.id,-1<v.new_booking.plane.id.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=v.new_booking.plane.id.slice(0,-1)),v.booking_self?e.user_id=v.user.id:e.user_id=v.new_booking.user.user_id,e.instructor_id=v.new_booking.instructor?v.new_booking.instructor.id:0,console.log("vm.new_booking.plane",v.new_booking),e.plane_id=v.new_booking.plane.id,e.override=v.new_booking.override||0,e.club_id=v.new_booking.club_id,I(e)}},c.update_club=function(){console.log("we changed club here"),v.club_id=v.change_club.id,-1<v.user.access.instructor.indexOf(v.club_id)&&(v.booking_self=!1),D()},c.alertOnEventClick=function(e,t,n){c.alertMessage=e.title+" was clicked "},c.alertOnDrop=function(e,t,n,o,i,r){if(e.resourceId)-1<e.resourceId.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=e.resourceId.slice(0,-1));else if(e.resourceIds)for(var a=0;a<e.resourceIds.length;a++)-1<e.resourceIds[a].toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceIds[a]=e.resourceIds[a].slice(0,-1));I(e)},c.alertOnResize=function(e,t,n,o,i,r){I(e)},c.override_booking_change=function(e){v.error_event[e]=!0,I(v.error_event,!0)},c.override_booking_change2=function(e){v.error_event.admin_override=!0,I(v.error_event,!0)},c.decline_booking_change=function(){v.booking_errors={},v.error_event={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},c.wholeDay=function(){1==c.whole_day_booking?(c.whole_day_booking=!1,c.myDatetimeRange.time.from=480,c.myDatetimeRange.time.to=1080):(c.whole_day_booking=!0,c.myDatetimeRange.time.from=0,c.myDatetimeRange.time.to=1440)},c.changeView=function(e,t){g.calendars[t].fullCalendar("changeView",e)},c.renderCalender=function(e){f(function(){g.calendars[e]&&g.calendars[e].fullCalendar("render")})},c.add_rental_item=function(){if(v.rental_item&&v.new_booking.rental_items&&v.rental_item.id){for(var e=1,t=0;t<v.new_booking.rental_items.length;t++)v.new_booking.rental_items[t].id==v.rental_item.id&&(e=0,v.new_booking.rental_items[t]);1==e&&(v.new_booking.rental_items.push(v.rental_item),delete v.rental_item)}else v.rental_item&&(v.new_booking.rental_items||(v.new_booking.rental_items=[]),v.new_booking.rental_items.push(v.rental_item),delete v.rental_item)},c.rental_item_remove=function(t){v.new_booking.rental_items=$.grep(v.new_booking.rental_items,function(e){return e.id!=t})},c.getPlaneInstructors=function(){(-1<v.user.access.instructor.indexOf(v.club_id)||-1<v.user.access.manager.indexOf(v.club_id))&&(v.booking_self=!1,T()),-1<v.user.access.manager.indexOf(v.club_id)&&(v.booking_admin=!0),c.check_rental_items();var e=new Date(v.new_booking.start_datetime).toISOString(),t=new Date(v.new_booking.end_datetime).toISOString();"add"==v.action?(n=!v.is_edit_show_all&&v.booking_self?0:1,b.GetPlaneInstructors(v.user.id,v.new_booking.plane.id,e,t,n).then(function(e){v.instructors=e;var t=1;if(v.new_booking.instructor){for(var n=0;n<v.instructors.length;n++)v.instructors[n].id==v.new_booking.instructor.id&&(t=0);1==t&&(v.new_booking.instructor={},delete v.new_booking.instructor)}P()})):(n=!v.is_edit_show_all&&v.booking_self?0:1,b.GetPlaneInstructorsEdit(v.user.id,v.new_booking.plane.id,e,t,n,v.new_booking.id).then(function(e){v.instructors=e;var t=1;if(v.new_booking.instructor){for(var n=0;n<v.instructors.length;n++)v.instructors[n].id==v.new_booking.instructor.id&&(t=0);1==t&&(v.new_booking.instructor={},delete v.new_booking.instructor)}P()})),y.GetCoursesByClubId(v.new_booking.plane.club_id).then(function(e){v.courses=e.items});var n=new Date(v.new_booking.end_datetime);b.GetIfCurrent(v.user_id,v.new_booking.plane.id,n.toISOString()).then(function(e){e.success&&(v.is_current=e.is_current,v.currency_type=e.requirements.currency_type,v.currency_days=e.requirements.currency_days)})},c.clear_booking=function(){v.new_booking={start_date:C,end_date:C,free_seats:[],passengers:[],instructor:void 0,options:v.dateTimeRangePickerOptions},c.submitted=!1},v.seats_in_plane=function(){P();var e=v.new_booking.plane.seats;return v.new_booking.instructor&&e--,--e},v.invite_new_passenger=function(e){v.new_pax&&""!==v.new_pax.email&&0==v.new_pax.is_member?(v.new_pax.invited_by=v.user.id,t.AddPassenger(v.new_pax,d.booking_id).then(function(e){e.success&&(alert("INVITATION SENT!"),v.update_passenger_list(),v.show_new_passenger_invitation=!1)})):alert("Please enter a valid email address to send the invitation to.")},v.add_new_passenger=function(e){console.log("ADD NEW PAX"),console.log(v.new_pax),v.new_pax.is_member?(v.new_pax.club_id=v.club_id,v.new_pax.invited_by=v.user.id,v.new_booking.passengers.push(v.new_pax)):v.show_new_passenger_invitation=!0},v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},v.close_passenger_invitation=function(){v.show_new_passenger_invitation=!1};v.get_pax_class=function(e,t){return console.log("STATUS:: ",e),"to_invite"==e||"invited"==e?"waiting_pax_invitation":"member"==e||"accepted"==e||"is_member"==e?"success_pax_invitation":"declined"==e?"declined_pax_invitation":!e&&t?"success_pax_invitation":"new_pax_invitation"},v.new_passenger_invite_ready=function(e){if(!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(v.new_pax.email))return alert("The email address appears to be incorrect - please double check the email address entered."),!1;v.new_pax.is_member=!1,v.new_pax.status="to_invite",v.new_booking.passengers.push(v.new_pax),v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},v.show_new_passenger_invitation=!1},v.remove_passenger=function(e){console.log("hi"),v.new_booking.passengers.splice(e,1)},c.cancel_booking=function(t){"YES"==prompt("Are you sure you wish to cancel this booking? Please type YES in the box below to confirm.")?b.DeleteBooking(v.user.id,t).then(function(e){alert("booking cancelled"),e.success?(l.go("dashboard.add_booking"),c.all_events=$.grep(c.all_events,function(e){return e.id!=t}),$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",c.all_events)):alert("an error occurred...")}):l.go("dashboard.add_booking")};var U;function T(e,t){e=0<arguments.length&&void 0!==e?e:null,t=1<arguments.length&&void 0!==t?t:null,e=e||v.club_id,t=t||v.new_booking.end_datetime;0<e&&t&&(t=new Date(t).toISOString(),o.GetAllActiveByClub(e,t).then(function(e){if((-1<v.user.access.instructor.indexOf(v.club_id)||-1<v.user.access.manager.indexOf(v.club_id))&&(v.booking_self=!1,v.show_self_option=!0),v.get_members(),v.new_booking.instructor&&v.new_booking.instructor.id==v.user.id&&(v.show_self_option=!0,v.booking_self=!1),v.new_booking.user||(v.all_members?v.new_booking.user=v.all_members.find(function(e,t){if(e.user_id==v.new_booking.user_id)return!0}):o.GetAllByClub(v.club_id).then(function(e){v.all_members=e;for(var t=0;t<v.all_members.length;t++)v.all_members[t].is_member=!0;v.new_booking.user=v.all_members.find(function(e,t){if(e.user_id==v.new_booking.user_id)return!0})})),v.members&&0<v.members.length)for(var t=0;t<v.members.length;t++)v.members[t].is_member=!0}))}function E(){var e=new Date(v.new_booking.start_date),t=new Date,n=v.new_booking.start_time?v.new_booking.start_time.time.split(":"):[t.getHours(),t.getMinutes()];e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0);n=new Date(v.new_booking.end_date),t=v.new_booking.end_time?v.new_booking.end_time.time.split(":"):[t.getHours(),t.getMinutes()];n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(0),v.new_booking.start_datetime=e.toISOString(),v.new_booking.end_datetime=n.toISOString()}function B(e,t,n){var o=1<arguments.length&&void 0!==t?t:null,i=2<arguments.length&&void 0!==n?n:0,o=parseInt(o);e=parseInt(e);var r=0;return v.new_booking.options.business_hours&&(t=v.new_booking.options.business_hours.from.split(":"),n=v.new_booking.options.business_hours.to.split(":"),0==i||(n[0]=parseInt(n[0])-1),o||0==o?((e<parseInt(t[0])||e==parseInt(t[0])&&o<parseInt(t[1]))&&(r=1),(e>parseInt(n[0])||e==parseInt(n[0])&&o>parseInt(n[1]))&&(r=1)):(parseInt(t[0])<e&&(r=1),parseInt(n[0])>e&&(r=1))),r}function G(e,n,t){var o,i=2<arguments.length&&void 0!==t?t:null;switch(e){case"today":o=new Date;break;case"past":case"future":o=new Date("1990-07-26");break;case"after":case"before":o=new Date(i)}var r=new Date(v.new_booking.start_date);v[n].forEach(function(e,t){e=e.time.split(":");r.setHours(e[0]),r.setMinutes(e[1]),r.setSeconds(0),moment(r).isAfter(moment(o))?v[n][t].disabled=B(parseInt(e[0]),parseInt(e[1]),"start_times"==n?1:0):v[n][t].disabled=1}),A()}function L(){var e=v.new_booking.start_time.time.split(":"),t=new Date(v.new_booking.start_date);t.setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0);moment(t).add(1,"hour").format();23<=parseInt(e[0])?moment(v.new_booking.start_date).isSame(moment(v.new_booking.end_date))&&(v.new_booking.end_date=new Date(moment(v.new_booking.end_date).add(1,"day").format()),G("future","end_times"),v.new_booking.end_time=v.end_times[0]):G("after","end_times",t)}function R(){var e,t,n,o=!1;return v.new_booking.end_time&&(e=new Date(v.new_booking.start_date),n=v.new_booking.start_time.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date(v.new_booking.end_date),n=v.new_booking.end_time.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),(moment(e).isAfter(moment(t))||moment(e).isSame(t)||t==e)&&(o=!0)),o}function j(){var e,t;moment(v.new_booking.start_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")?G("today","start_times"):moment(v.new_booking.start_date).isAfter(moment())&&G("future","start_times"),moment(v.new_booking.end_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(v.new_booking.start_time&&L(),G(N(v.new_booking.start_date),"end_times")),v.new_booking.end_date==v.new_booking.start_date&&v.new_booking.start_time&&(e=v.new_booking.start_time.time.split(":"),(t=new Date(v.new_booking.start_date)).setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0),R()?(G(N(v.new_booking.start_date),"start_times"),G(N(v.new_booking.end_date,"end"),"end_times",t),L()):G(N(v.new_booking.end_date,"end"),"end_times",t))}function N(e,t){var n=1<arguments.length&&void 0!==t?t:"start",t="today";return moment(moment(e).format("YYYY/MM/DD")).isAfter(moment().format("YYYY/MM/DD"))?(t="future",v.new_booking.start_date&&v.new_booking.end_date&&"end"==n&&moment(v.new_booking.start_date).isSame(moment(v.new_booking.end_date))&&(t="after")):t=moment(e).format("YYYY/MM/DD")==moment().format("YYYY/MM/DD")?"start"==n?"today":"after":"past",t}setTimeout(function(){console.log("hello",v.club_id),o.GetAllByClub(v.club_id).then(function(e){v.members=e;for(var t=0;t<v.members.length;t++)v.members[t].is_member=!0;v.all_members=e;for(t=0;t<v.all_members.length;t++)v.all_members[t].is_member=!0;console.log(v.all_members)})},200),v.invite_passenger=function(e,t){v.new_booking.passengers.push(v.new_pax)},v.refresh_passenger=function(e,t){n.GetInvite(v.new_booking.passengers[t].invitation_token).then(function(e){v.new_booking.passengers[t].status=e.status,v.new_booking.passengers[t].user_id=e.user_id,v.new_booking.passengers[t].first_name=e.first_name,v.new_booking.passengers[t].last_name=e.last_name})},v.update_passenger_list=function(){t.GetPassengers(d.booking_id).then(function(e){e.success&&(v.new_booking.passengers=e.passengers,v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0})})},v.resend_invitation=function(e){b.ResendInvitation(e,e.id).then(function(e){e.success,alert(e.message)})},v.refresh_all_passenger=function(){var t=0;++t<v.new_booking.passengers.length&&v.new_booking.passengers[t]&&"invited"==v.new_booking.passengers[t].status&&""!==v.new_booking.passengers[t].invitation_token&&n.GetInvite(v.new_booking.passengers[t].invitation_token).then(function(e){v.new_booking.passengers[t].status=e.status,v.new_booking.passengers[t].user_id=e.user_id,v.new_booking.passengers[t].first_name=e.first_name,v.new_booking.passengers[t].last_name=e.last_name})},v.get_passenger_status=function(e){if(e)return e.is_member?"OK - is already club member":"accepted"==e.status?"OK - passenger has accepted the terms":"declined"==e.status?"NO - passenger declined the offer":"invited"==e.status?"Waiting for user response":""},v.remove_invite=function(e){v.new_booking.passengers.splice(e,1),v.init_passengers()},v.resend_invitation=function(e){e=v.new_booking.passengers[e];b.ResendInvitation(e,e.id).then(function(e){e.success,alert(e.message)})},v.pax_invited=function(e){return""!=e.status&&"to_invite"!=e.status},v.get_passenger_status=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"invited"==e.status?"This passenger has been invited but has not yet responded.":""},v.get_passenger_status_edit=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"member"==e.status?"This passenger is a member":"invited"==e.status?"This passenger has been invited but has not yet accepted.":""},v.invite_new_passenger=function(e){v.show_new_passenger_invitation=!0,v.new_pax=e,v.new_booking.passengers.push({first_name:"",last_name:"",email:"",status:""})},v.close_passenger_invitation=function(){v.new_pax=-1,v.show_new_passenger_invitation=!1},v.get_members=function(t,e){0!=v.club_id&&v.club_id||!v.new_booking.plane||!v.new_booking.plane.id||(v.club_id=v.new_booking.plane.club_id),(0==v.club_id||!v.club_id)&&v.new_booking&&v.new_booking.club_id&&0<v.new_booking.club_id&&(v.club_id=v.new_booking.club_id),console.log("GET vm.club_id : ",v.club_id),t&&2<t.length&&o.GetAllByClubAndName(v.club_id,t).then(function(e){if(e.success){e=e.members.filter(function(t){return!v.new_booking.passengers.find(function(e){return e.email===t.email})});return v.members=e,v.members.length<1&&(v.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)?v.new_pax.email=t:-1<t.indexOf(" ")?(e=t.split(" "),v.new_pax.first_name=e[0],v.new_pax.last_name=e[1]):v.new_pax.first_name=t),!0}return v.new_pax.status="",v.new_pax.email="",v.new_pax.first_name="",v.new_pax.last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)&&(v.new_pax.email=t,v.new_pax.not_found=!0),!1})},c.save=function(){"add"==v.action?c.create():(E(),c.update())},c.update=function(){var e=new Date;e.setHours(14),e.setMinutes(0),c.mytime=e},v.show_self_option=!1,c.select_plane=function(e){c.check_rental_items(),P(),-1<v.user.access.instructor.indexOf(v.club_id)||-1<v.user.access.manager.indexOf(v.club_id)?v.show_self_option=!0:v.show_self_option=!1,-1<v.user.access.instructor.indexOf(v.club_id)&&(v.booking_self=!1)},j(),d.start&&(v.new_booking.start_date=new Date(d.start),v.new_booking.end_date=new Date(d.start),v.new_booking.start_time={time:moment(d.start).format("HH:mm")},v.new_booking.end_time={time:moment(d.start).add(30,"minutes").format("HH:mm")},U=moment(d.start).add(30,"minutes"),v.default_date=v.new_booking.start_date,$("#calendar").fullCalendar("gotoDate",v.new_booking.start_date),setTimeout(function(){var e=[{id:"TEMP",title:"TEMPORARY",resourceId:7,start:d.start,end:U,editable:!1,color:"rgb(255, 110, 110)",opacity:"1"}];$("#calendar").fullCalendar("addEventSource",e),setTimeout(function(){},500),c.update_dateTime("edit2",d.plane_id)},500)),v.already_added_temp=!1,v.add_booking_event=function(t){v.new_booking.start_date=new Date(t.start),v.new_booking.end_date=new Date(luxon.DateTime.fromISO(new Date(t.end).toISOString()).plus({minutes:60}).toISO()),v.new_booking.start_time={time:moment(t.start).format("HH:mm")},v.new_booking.end_time={time:moment(t.start).add(60,"minutes").format("HH:mm")},b.GetAllPlanes(v.user.id,v.new_booking.start_date.toISOString(),v.new_booking.end_date.toISOString(),0,0).then(function(e){v.planes=e,v.new_booking.plane=v.planes.find(function(e){return parseInt(e.id)===parseInt(t.plane_id)}),c.update_dateTime("edit2")})},c.calendarOptions={initialView:"dayGridMonth"},c.calendarEvents=[{title:"Event 1",start:"2024-02-17"},{title:"Event 2",start:"2024-02-18"}],c.make_booking=function(e){if(c.submitted=!0,e){var i={};return(delete(i=jQuery.extend(!0,{},v.new_booking)).options,delete i.instructor,delete i.plane,delete i.start_date,delete i.start_time,delete i.end_date,delete i.end_time,delete i.start_datetime,delete i.end_datetime,delete i.tuition_required,delete i.user,moment(Date.parse(v.new_booking.end_datetime)).add(60,"minutes").isBefore())?(alert("This booking ends in the past - you cannot create a booking in the past."),!1):moment(Date.parse(v.new_booking.start_datetime)).add(60,"minutes").isBefore()?(alert("This booking starts in the past - you cannot create a booking in the past."),!1):(i.override=v.new_booking.override||0,v.booking_self?(i.user_id=v.user.id,i.instructor_id=v.new_booking.instructor?v.new_booking.instructor.id:0):(i.user_id=v.new_booking.user.user_id,-1<v.user.access.manager.indexOf(v.club_id)?i.instructor_id=v.new_booking.instructor?v.new_booking.instructor.id:0:i.instructor_id=v.user.id,i.booked_by_admin_instructor=1,i.override=1),i.free_seats=v.new_booking.free_seats.constructor===Array?0:v.new_booking.free_seats,i.start=v.new_booking.start_datetime,i.end=v.new_booking.end_datetime,i.plane_id=v.new_booking.plane.id,i.club_id=v.new_booking.plane.club_id,i.booked_by=v.user.id,i.course_id=v.new_booking.tuition_required?v.new_booking.tuition_required.id:0,i.maintenance_flight=v.new_booking.maintenance_flight,void b.Create(v.user.id,i).then(function(e){if(1==e.success)c.clear_booking(),b.GetAll(v.user.id,moment(i.start).format("Y-MM-DD"),"").then(function(e){alert("Booking Created Successfully"),c.all_events=e.events,c.all_resources=e.resources,$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",c.all_events)}),l.go("dashboard.add_booking");else{if(e.more&&0<e.more.length){console.log("MORE",e);for(var t="",n=0;n<e.more.length;n++)"differences_verified"==e.more[n].name&&(t+="\n - Your differences training sign-offs need to be verified by a member of staff. \n"),"licence_verified"==e.more[n].name&&(t+="\n - Your licence needs to be verified by a member of staff. \n"),"medical_verified"==e.more[n].name&&(t+="\n - Your medical needs to be verified by a member of staff. \n"),"medical"==e.more[n].name&&(t+="\n - You need to upload a copy of your medical. \n"),"licence"==e.more[n].name&&(t+="\n - You need to upload a copy of your licence. \n"),"differences"==e.more[n].name&&(t+="\n - You need to upload a copy of your differences training signed off. \n");e.message=e.message+t}var o;e.allow_override&&-1<v.user.access.manager.indexOf(v.club_id)&&(o=[],"instructor"==e.reason&&o.push({type:"instructor",message:"It looks like the instructor is not available for this booking",api:e.instructor,override:"instructor_override",button:"OVERRIDE INSTRUTOR AVAILABILITY"}),v.new_booking_errors=o),alert("Sorry! \n\n"+e.message)}}))}},c.popup2={opened:!1},c.popup3={opened:!1},c.popup4={opened:!1},c.open2=function(){c.popup2.opened=!0},c.open3=function(){c.popup3.opened=!0},c.open4=function(){c.popup4.opened=!0},c.open=function(e){u.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return warning_msg}}}).result.then(function(t){_.info("PRESSED GO: "+t),o.Delete(t).then(function(){v.club.members=$.grep(v.club.members,function(e){return e.id!=t})})},function(){_.info("Modal dismissed at: "+new Date)})}}function BookingsController(e,o,t,n,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var y=this;s.va1="123",y.user=r.globals.currentUser,y.allUsers=[],y.club={},y.page_title="",y.club.member={},y.imported_new_headers=[],y.see_booking={},y.is_current=!1,y.currency_type="",y.currency_days="",y.booking_self=!0,y.times_clean_type="start_times",y.action=c.current.data.action,y.return_to=c.current.data.return_to,y.club_id=0,y.user_id=y.user.id,y.no_show_cols=["membership_start","membership_id","selected"];var v=new Date,k=Math.floor(8),r=Math.floor(18);new Date(v.getFullYear(),v.getMonth(),v.getDate(),k,0,0),new Date(v.getFullYear(),v.getMonth(),v.getDate(),r,0,0);y.default_date=new Date,y.datepickerOptions={customClass:C,format:"dd/MM/yyyy",showWeeks:!1},y.dateTimeRangePickerOptions={hour_step:1,minute_step:30,min_date:w,datepicker:{customClass:C,format:"dd/MM/yyyy",showWeeks:!1,minDate:w},business_hours:{from:"09:00",to:"22:30"}},s.whole_day_booking=!1,y.instructor_charges=[],y.cancellation={reasons:["Pilot Unwell","Pilot Unavailable","Weather at home base","Weather at destination","Plane Unavailable","Plane Unserviceable","Plane Returned Too Late by previous booking","Instructor Not Available","Airfield Closed","Airspace Closed","Other - please specify"],notes:""};var w=new Date;w.setMinutes(0),w.setSeconds(0);r=moment(w);r.add(2,"hours"),(r=new Date(r)).setSeconds(0);(new Date).format("d/M/yyyy");y.start_times=[],y.end_times=[],y.new_booking={start_date:w,end_date:w,free_seats:[],passengers:[],options:y.dateTimeRangePickerOptions},s.toggle=!0,s.whentimechangedata={},s.overridePicker=!0;Date();switch(y.planes=[],function(){for(var e=0;e<24;e+=y.new_booking.options.hour_step)if(y.new_booking.options.minute_step&&0<y.new_booking.options.minute_step)for(var t=0;t<60/y.new_booking.options.minute_step;t++){var n=y.new_booking.options.minute_step*t;n=(n<10?"0":"")+n,y.start_times.push({time:e+":"+n,disabled:T(e,n)}),y.end_times.push({time:e+":"+n,disabled:T(e,n),duration:""})}else y.start_times.push({time:e+":00",disabled:T(e)}),y.end_times.push({time:e+":00",disabled:T(e),duration:""})}(),s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],y.action){case"add":y.page_title="Add a Booking",y.new_booking={start_date:w,end_date:w,free_seats:[],passengers:[],options:y.dateTimeRangePickerOptions},I();break;case"edit":y.page_title="Edit a Booking",y.see_booking.visible=0,y.new_booking={start_date:w,end_date:w,free_seats:[],passengers:[],options:y.dateTimeRangePickerOptions},I(),O(),l.booking_id&&g.GetEdit(y.user.id,l.booking_id).then(function(e){if(e.success){if(y.new_booking=e.booking,y.new_booking.options=y.dateTimeRangePickerOptions,y.new_booking.edit_booking=1,y.new_booking.start_date=new Date(y.new_booking.start),y.new_booking.start_time={time:moment(y.new_booking.start).format("HH:mm")},y.new_booking.end_date=new Date(y.new_booking.end),y.new_booking.end_time={time:moment(y.new_booking.end).format("HH:mm")},y.new_booking.after_booking_end=moment().isAfter(moment(y.new_booking.end)),y.new_booking.instructor&&y.new_booking.instructor.id==y.user_id&&(y.booking_self=!1),s.$parent.vm.default_date=y.new_booking.start_date,setTimeout(function(){s.$parent.vm.see_booking.visible=0,s.$apply()},1e3),U(),s.update_dateTime("edit"),h.GetCoursesByClubId(y.new_booking.club_id).then(function(e){y.courses=e.items}),A(y.new_booking.club_id,y.new_booking.end),y.new_booking.rental_items)for(var t=0;t<y.new_booking.rental_items.length;t++)y.new_booking.rental_items[t].number_to_book=parseInt(y.new_booking.rental_items[t].number_to_book);y.new_booking.free_seats&&(y.new_booking.free_seats=parseInt(y.new_booking.free_seats)),y.new_booking.instructor,0!=y.club_id&&y.club_id||!y.new_booking.plane||!y.new_booking.plane.id||(y.club_id=y.new_booking.plane.club_id),M()}else alert("Booking Error \n \n"+e.message),c.go("dashboard.bookings.add")});break;case"list":y.show_no_membership_message=!1,y.hide_dropdown=!1,y.clubs=[],o.GetUserClubs(y.user.id).then(function(e){y.clubs=e.clubs,y.clubs&&1<y.clubs.length?y.hide_dropdown=!0:1==y.clubs.length&&(y.club_id=y.clubs[0].id),O()})}function C(e){var t=e.date;if("day"===e.mode)for(var n=new Date(t).setHours(0,0,0,0),o=0;o<s.events.length;o++)if(n===new Date(s.events[o].date).setHours(0,0,0,0))return s.events[o].status;return""}function S(e){var t=0<arguments.length&&void 0!==e?e:null,n=new Date,e=y.new_booking.start_time?y.new_booking.start_time.time.split(":"):[n.getHours(),n.getMinutes()],n=new Date(y.new_booking.start_date);n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0);var o,i=moment(n).add(1,"hour").format();G()||!y.new_booking.end_time?(E(R(y.new_booking.end_date,"end"),"end_times",n),y.end_times.some(function(e,t){if(e.time==moment(i).format("HH:mm"))return o=t}),y.new_booking.end_time={},y.new_booking.end_time=y.end_times[o]):t||E(R(y.new_booking.end_date,"end"),"end_times",n),y.new_booking.end_time&&1==y.new_booking.end_time.disabled&&(y.end_times.some(function(e,t){if(e.time==moment(i).format("HH:mm"))return o=t}),y.new_booking.end_time={},y.new_booking.end_time=y.end_times[o]),y.new_booking.start_time&&1==y.new_booking.start_time.disabled&&(t||(y.start_times.some(function(e,t){if(0==e.disabled)return o=t}),y.new_booking.start_time={},y.new_booking.start_time=y.start_times[o]),P())}function x(){y.start_times.forEach(function(e,t){e.time==y.new_booking.start_time.time&&(y.new_booking.start_time=y.start_times[t])}),y.end_times.forEach(function(e,t){e.time==y.new_booking.end_time.time&&(y.new_booking.end_time=y.end_times[t])}),s.$apply()}function O(){g.GetAll(y.user.id,moment().format("Y-M-D"),"").then(function(e){return s.all_events=e.events,s.all_resources=e.resources,e})}function D(n,e){(1<arguments.length&&void 0!==e?e:null)&&(y.booking_errors={},y.error_event={});var t,o=jQuery.extend({},n);o.plane_id=n.resourceId,""!==n.instructor_id?o.instructor_id=n.instructor_id:o.instructor_id="0",delete o._start,delete o._end,delete o._id,delete o.source,delete o._allDay,delete o.allDay,delete o.className,delete o.plane,delete o.title,delete o.editable,delete o.resourceIds,o.update_rental_items=!0;for(var i=0;i<s.all_events.length;i++)s.all_events[i].id==o.id&&(t=s.all_events[i]);if(moment(Date.parse(o.end))<moment())alert("This booking ends in the past - you cannot amend a booking in the past.");else{if(moment(o.start).add(30,"minutes")<moment()&&moment(t.end)!==o.end){if(!confirm("This booking starts in the past - you cannot amend the start date or time of a booking in the past, would you like to amend the end time along with any other changes you have made?"))return;o.start=t.start}g.updateBooking(o,y.user.id).then(function(e){var t;return 1==e.success?(1==o.edit_booking&&s.$parent.updateEvents(o.start,o.end),alert("Your changes were saved successfully"),"bookout"==y.return_to?c.go("dashboard.my_account.bookout_with_booking",{booking_id:n.id}):c.go("dashboard.bookings.add")):(t=[],!0!==e.instructor?t.push({type:"instructor",message:"It looks like your instructor is not available on the updated date and time",api:e.instructor,override:"instructor_override",button:""}):!0!==e.check_user?-1<e.check_user.indexOf("self-certify")?t.push({type:"check_user",message:"It would appear that you are not within the currency requirements to book this aircraft for this flight.",api:e.check_user,override:"currency_override",button:"I am Current"}):t.push({type:"check_user",message:"It looks like your user account does not allow this booking to happen",api:e.check_user,override:"currency_override",button:""}):!0!==e.rental_items&&t.push({type:"rental_items",message:"It looks like some of the rental items are not available",api:e.rental_items,override:"update_rental_items",button:"Confirm Changes"}),y.booking_errors=t,y.error_event=o),e})}}function I(){y.new_booking.options=y.dateTimeRangePickerOptions;for(var e=0;e<24;e+=y.new_booking.options.hour_step)if(y.new_booking.options.minute_step&&0<y.new_booking.options.minute_step)for(var t=0;t<60/y.new_booking.options.minute_step;t++){var n=y.new_booking.options.minute_step*t;y.start_times.push({time:e+":"+(n=(n<10?"0":"")+n),disabled:T(e,n)}),y.end_times.push({time:e+":"+n,disabled:T(e,n),duration:""})}else y.start_times.push({time:e+":00",disabled:T(e)}),y.end_times.push({time:e+":00",disabled:T(e),duration:""})}function M(){y.free_seats=[];var e=y.new_booking.plane.seats-1;if(y.new_booking.instructor&&0<y.new_booking.instructor.id&&e--,0<y.new_booking.passengers.length)for(var t=0;t<y.new_booking.passengers.length;t++)y.new_booking.passengers[t]&&""!==y.new_booking.passengers[t].email&&e--;for(t=0;t<e;t++)y.free_seats.push(t)}function P(){var o,e;y.new_booking.start_date&&y.new_booking.start_time&&(o=new Date(y.new_booking.start_date),e=y.new_booking.start_time.time.split(":"),o.setHours(e[0]),o.setMinutes(e[1]),o.setSeconds(0),y.end_times.forEach(function(e,t){var n;0==e.disabled?(n=new Date(y.new_booking.end_date),e=e.time.split(":"),n.setHours(e[0]),n.setMinutes(e[1]),n.setSeconds(0),""==(n=function(e){var t=moment.duration(e).days(),n=moment.duration(e).hours(),o=moment.duration(e).minutes();59==o&&(n++,o=0);e="";0<t&&(e=e+" "+t+" day",e=1<t?e+"s":e);0<n&&(e=e+" "+n+" hour",e=1<n?e+"s":e);0<o&&(e=e+" "+o+" minute",e=1<o?e+"s":e);return e}(moment(moment(n).startOf("minute")).diff(moment(o).startOf("minute"))))?y.end_times[t].disabled=1:y.end_times[t].duration="( "+n+" )"):y.end_times[t].duration=""}))}s.back=function(){_.history.back()},s.test=function(){y.new_booking.instructor={id:90,first_name:"A",last_name:"REYNIER"}},s.updateEvents=function(e,t){g.GetAll(y.user.id,e,t).then(function(e){return s.all_events=e.events,s.all_resources=e.resources,e})},s.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),p(t)(s)},s.alertOnClicked=function(e,t,n){y.see_booking=e,y.see_booking.start_date=moment(y.see_booking.start).format("DD/MM/YYYY"),y.see_booking.end_date=moment(y.see_booking.end).format("DD/MM/YYYY"),y.see_booking.start_time=moment(y.see_booking.start).format("HH:mm"),y.see_booking.end_time=moment(y.see_booking.end).format("HH:mm"),y.see_booking.start_datetime=new Date(new Date(y.see_booking.start).toUTCString()),y.see_booking.end_datetime=new Date(y.see_booking.end),y.see_booking.visible=1,y.see_booking.after_booking_end=moment().isAfter(moment(y.see_booking.end)),s.$apply()},s.close_details=function(){y.see_booking.visible=0},s.changeLang=function(){s.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},s.changed=function(){s.check_plane_availability()},s.check_plane_availability=function(){U();var o=1==y.new_booking.edit_booking?1:0,e=0<y.new_booking.plane_id?y.new_booking.plane_id:0;y.new_booking.plane&&y.new_booking.plane.id&&(e=y.new_booking.plane.id),console.log("START",y.new_booking.start_datetime),console.log("START iso",new Date(y.new_booking.start_datetime).toIsoString()),console.log("END",y.new_booking.end_datetime),g.GetAllPlanes(y.user.id,y.new_booking.start_datetime,y.new_booking.end_datetime,0,e).then(function(e){if(y.planes=e,1==o)for(var t=0;t<y.planes.length;t++)y.planes[t].id==y.new_booking.plane.id&&(n=0,y.new_booking.plane=y.planes[t],s.check_rental_items());else{var n=1;if(y.new_booking.plane){for(t=0;t<y.planes.length;t++)y.planes[t].id==y.new_booking.plane.id&&(n=0,s.check_rental_items());1==n&&(y.new_booking.plane={},delete y.new_booking.plane)}}})},s.events=[],s.addOne=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;e&&!n&&(n=moment(e).add(1,"hour").format()),c.go("dashboard.bookings.add",{start:e,plane_id:t,end:n})},s.cancel_changes=function(){c.go("dashboard.bookings.add")},s.check_rental_items=function(){var e;U(),y.rental_items=[],y.new_booking.plane&&(e=(1==y.new_booking.edit_booking?y.new_booking:y.new_booking.plane).club_id,g.GetRentalItems(e,moment(y.new_booking.start_datetime).format("Y-M-D HH:mm"),moment(y.new_booking.end_datetime).format("Y-M-D HH:mm"),0).then(function(e){if(y.rental_items=e,y.new_booking.rental_items)for(var t=0;t<y.new_booking.rental_items;t++){for(var n=0,o=0;o<y.rental_items.length;o++)if(y.rental_items[o].id==y.new_booking.rental_items[t].id){parseInt(y.new_booking.rental_items[t].number_to_book)>parseInt(y.rental_items[o].number_available)&&(y.new_booking.rental_items[t].number_to_book=parseInt(y.rental_items[o].number_available)),y.new_booking.rental_items[t].number_available=parseInt(y.rental_items[o].number_available),n=1;break}0==n&&delete y.new_booking.rental_items[t]}for(var i=0;i<y.rental_items.length;i++)y.rental_items[i].number=0;if(y.new_booking.rental_items)for(o=0;o<y.new_booking.rental_items;o++){for(var r=1,t=0;t<y.rental_items.length;t++)y.rental_items[t].id==y.new_booking.rental_items[o].id&&(r=0);1==r&&delete y.new_booking.rental_items[o]}}))},s.update_dateTime=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;switch(e){case"start_date":L(),y.new_booking.start_date>y.new_booking.end_date&&(y.new_booking.end_date=y.new_booking.start_date),E(R(y.new_booking.start_date),"start_times"),S(),G()&&B();break;case"end_date":L(),S(),y.new_booking.end_date<y.new_booking.start_date?(y.new_booking.start_date=y.new_booking.end_date,E(R(y.new_booking.start_date),"start_times")):(E(R(y.new_booking.start_date),"start_times"),E(R(y.new_booking.end_date,"end"),"end_times")),G()&&B();break;case"start_time":L(),S(),P();break;case"end_time":"past"==y.times_clean_type?S("edit"):S();break;case"edit":y.times_clean_type="start_times",moment(y.new_booking.start).unix()<moment().unix()?y.times_clean_type="past":(S(),L()),P(),setTimeout(function(){x()},500);break;case"edit2":L(),E(R(y.new_booking.start_date),"start_times"),S(),P(),setTimeout(function(){if(x(),t)for(var e=0;e<y.planes.length;e++)parseInt(y.planes[e].id)==t&&(y.new_booking.plane=y.planes[e],s.getPlaneInstructors(y.new_booking.plane.id),s.$apply())},500)}s.check_plane_availability(),y.new_booking.plane&&s.check_rental_items(),y.new_booking.plane&&s.getPlaneInstructors()},s.update_booking=function(e){if(U(),e){e={};if(delete(e=jQuery.extend(!0,{},y.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,delete e.after_booking_end,e.free_seats=y.new_booking.free_seats.constructor===Array?0:y.new_booking.free_seats,e.start=y.new_booking.start_datetime,e.end=y.new_booking.end_datetime,e.course_id=y.new_booking.tuition_required.id,moment(Date.parse(y.new_booking.end_datetime)).add(1,"hour").isBefore())return alert("This booking ends in the past by more than an hour - you cannot amend a booking that finished in the past."),!1;e.resourceId=y.new_booking.plane.id,-1<y.new_booking.plane.id.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=y.new_booking.plane.id.slice(0,-1)),y.booking_self?(e.user_id=y.user.id,e.instructor_id=y.new_booking.instructor?y.new_booking.instructor.id:0):(e.user_id=y.new_booking.user.user_id,e.instructor_id=(y.new_booking.instructor||y.user).id),e.plane_id=y.new_booking.plane.id,e.override=y.new_booking.override||0,e.club_id=y.new_booking.plane.club_id,D(e)}},s.update_club=function(){y.club_id=y.change_club.id,-1<y.user.access.instructor.indexOf(y.club_id)&&(y.booking_self=!1),O()},s.alertOnEventClick=function(e,t,n){s.alertMessage=e.title+" was clicked "},s.alertOnDrop=function(e,t,n,o,i,r){-1<e.resourceId.toString().indexOf("w")&&(e.changed_to_waiting_list=!0,e.resourceId=e.resourceId.slice(0,-1)),D(e)},s.alertOnResize=function(e,t,n,o,i,r){D(e)},s.override_booking_change=function(e){y.error_event[e]=!0,D(y.error_event,!0)},s.decline_booking_change=function(){y.booking_errors={},y.error_event={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},s.wholeDay=function(){1==s.whole_day_booking?(s.whole_day_booking=!1,s.myDatetimeRange.time.from=480,s.myDatetimeRange.time.to=1080):(s.whole_day_booking=!0,s.myDatetimeRange.time.from=0,s.myDatetimeRange.time.to=1440)},s.changeView=function(e,t){f.calendars[t].fullCalendar("changeView",e)},s.renderCalender=function(e){m(function(){f.calendars[e]&&f.calendars[e].fullCalendar("render")})},s.add_rental_item=function(){if(y.rental_item&&y.new_booking.rental_items&&y.rental_item.id){for(var e=1,t=0;t<y.new_booking.rental_items.length;t++)y.new_booking.rental_items[t].id==y.rental_item.id&&(e=0,y.new_booking.rental_items[t]);1==e&&(y.new_booking.rental_items.push(y.rental_item),delete y.rental_item)}else y.rental_item&&(y.new_booking.rental_items||(y.new_booking.rental_items=[]),y.new_booking.rental_items.push(y.rental_item),delete y.rental_item)},s.rental_item_remove=function(t){y.new_booking.rental_items=$.grep(y.new_booking.rental_items,function(e){return e.id!=t})},s.getPlaneInstructors=function(){(-1<y.user.access.instructor.indexOf(y.club_id)||-1<y.user.access.manager.indexOf(y.club_id))&&(y.booking_self=!1,A()),-1<y.user.access.manager.indexOf(y.club_id)&&(y.booking_admin=!0),y.init_passengers(),s.check_rental_items(),"add"==y.action?g.GetPlaneInstructors(y.user.id,y.new_booking.plane.id,y.new_booking.start_datetime,y.new_booking.end_datetime,y.booking_self?0:1).then(function(e){y.instructors=e;var t=1;if(y.new_booking.instructor){for(var n=0;n<y.instructors.length;n++)y.instructors[n].id==y.new_booking.instructor.id&&(t=0);1==t&&(y.new_booking.instructor={},delete y.new_booking.instructor)}M()}):g.GetPlaneInstructorsEdit(y.user.id,y.new_booking.plane.id,y.new_booking.start_datetime,y.new_booking.end_datetime,y.booking_self?0:1,y.new_booking.id).then(function(e){y.instructors=e;var t=1;if(y.new_booking.instructor){for(var n=0;n<y.instructors.length;n++)y.instructors[n].id==y.new_booking.instructor.id&&(t=0);1==t&&(y.new_booking.instructor={},delete y.new_booking.instructor)}M()}),h.GetCoursesByClubId(y.new_booking.plane.club_id).then(function(e){y.courses=e.items}),g.GetIfCurrent(y.user_id,y.new_booking.plane.id,y.new_booking.end_datetime).then(function(e){e.success&&(y.is_current=e.is_current,y.currency_type=e.requirements.currency_type,y.currency_days=e.requirements.currency_days)})},s.clear_booking=function(){y.new_booking={start_date:w,end_date:w,free_seats:[],passengers:[],instructor:void 0,options:y.dateTimeRangePickerOptions},s.submitted=!1},y.seats_in_plane=function(){M();var e=y.new_booking.plane.seats;return y.new_booking.instructor&&e--,--e},y.adding_a_member=function(){y.init_passengers()},y.init_passengers=function(){y.seats_in_plane();y.new_booking.passengers.push({first_name:"",last_name:"",email:"",status:""})};function A(e,t){e=0<arguments.length&&void 0!==e?e:null,t=1<arguments.length&&void 0!==t?t:null,e=e||y.club_id,t=t||y.new_booking.end_datetime;0<e&&t&&o.GetAllActiveByClub(e,t).then(function(e){-1<y.user.access.instructor.indexOf(y.club_id)&&(y.booking_self=!1),y.members=e,y.new_booking.instructor&&y.new_booking.instructor.id==y.user.id&&(y.booking_self=!1),y.new_booking.user||(y.new_booking.user=y.members.find(function(e,t){if(e.user_id==y.new_booking.user_id)return!0}));for(var t=0;t<y.members.length;t++)y.members[t].is_member=!0})}function U(){var e=new Date(y.new_booking.start_date),t=new Date,n=y.new_booking.start_time?y.new_booking.start_time.time.split(":"):[t.getHours(),t.getMinutes()];e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0);n=new Date(y.new_booking.end_date),t=y.new_booking.end_time?y.new_booking.end_time.time.split(":"):[t.getHours(),t.getMinutes()];n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(0),y.new_booking.start_datetime=moment(e).format("Y-M-D HH:mm"),y.new_booking.end_datetime=moment(n).format("Y-M-D HH:mm")}function T(e,t,n){var o=1<arguments.length&&void 0!==t?t:null,i=2<arguments.length&&void 0!==n?n:0,o=parseInt(o);e=parseInt(e);var r=0;return y.new_booking.options.business_hours&&(t=y.new_booking.options.business_hours.from.split(":"),n=y.new_booking.options.business_hours.to.split(":"),0==i||(n[0]=parseInt(n[0])-1),o||0==o?((e<parseInt(t[0])||e==parseInt(t[0])&&o<parseInt(t[1]))&&(r=1),(e>parseInt(n[0])||e==parseInt(n[0])&&o>parseInt(n[1]))&&(r=1)):(parseInt(t[0])<e&&(r=1),parseInt(n[0])>e&&(r=1))),r}function E(e,n,t){var o,i=2<arguments.length&&void 0!==t?t:null;switch(e){case"today":o=new Date;break;case"past":case"future":o=new Date("1990-07-26");break;case"after":case"before":o=new Date(i)}var r=new Date(y.new_booking.start_date);y[n].forEach(function(e,t){e=e.time.split(":");r.setHours(e[0]),r.setMinutes(e[1]),r.setSeconds(0),moment(r).isAfter(moment(o))?y[n][t].disabled=T(parseInt(e[0]),parseInt(e[1]),"start_times"==n?1:0):y[n][t].disabled=1}),P()}function B(){var e=y.new_booking.start_time.time.split(":"),t=new Date(y.new_booking.start_date);t.setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0);moment(t).add(1,"hour").format();23<=parseInt(e[0])?moment(y.new_booking.start_date).isSame(moment(y.new_booking.end_date))&&(y.new_booking.end_date=new Date(moment(y.new_booking.end_date).add(1,"day").format()),E("future","end_times"),y.new_booking.end_time=y.end_times[0]):E("after","end_times",t)}function G(){var e,t,n,o=!1;return y.new_booking.end_time&&(e=new Date(y.new_booking.start_date),n=y.new_booking.start_time.time.split(":"),e.setHours(n[0]),e.setMinutes(n[1]),e.setSeconds(0),t=new Date(y.new_booking.end_date),n=y.new_booking.end_time.time.split(":"),t.setHours(n[0]),t.setMinutes(n[1]),t.setSeconds(0),(moment(e).isAfter(moment(t))||moment(e).isSame(t)||t==e)&&(o=!0)),o}function L(){var e,t;moment(y.new_booking.start_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")?E("today","start_times"):moment(y.new_booking.start_date).isAfter(moment())&&E("future","start_times"),moment(y.new_booking.end_date).format("DD/MM/YYYY")==moment().format("DD/MM/YYYY")&&(y.new_booking.start_time&&B(),E(R(y.new_booking.start_date),"end_times")),y.new_booking.end_date==y.new_booking.start_date&&y.new_booking.start_time&&(e=y.new_booking.start_time.time.split(":"),(t=new Date(y.new_booking.start_date)).setHours(e[0]),t.setMinutes(e[1]),t.setSeconds(0),G()?(E(R(y.new_booking.start_date),"start_times"),E(R(y.new_booking.end_date,"end"),"end_times",t),B()):E(R(y.new_booking.end_date,"end"),"end_times",t))}function R(e,t){var n=1<arguments.length&&void 0!==t?t:"start",t="today";return moment(moment(e).format("YYYY/MM/DD")).isAfter(moment().format("YYYY/MM/DD"))?(t="future",y.new_booking.start_date&&y.new_booking.end_date&&"end"==n&&moment(y.new_booking.start_date).isSame(moment(y.new_booking.end_date))&&(t="after")):t=moment(e).format("YYYY/MM/DD")==moment().format("YYYY/MM/DD")?"start"==n?"today":"after":"past",t}y.new_passenger_invite_ready=function(e){if(!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(y.new_booking.passengers[e].email))return alert("The email address appears to be incorrect - please double check the email address entered."),!1;y.new_booking.passengers[e].is_member=!1,y.new_booking.passengers[e].status="to_invite",y.init_passengers(),M(),y.show_new_passenger_invitation=!1},s.cancel_booking=function(t){"YES"==prompt("Are you sure you wish to cancel this booking? Please type YES in the box below to confirm.")?g.DeleteBooking(y.user.id,t).then(function(e){alert("booking cancelled"),e.success?(c.go("dashboard.bookings.add"),s.all_events=$.grep(s.all_events,function(e){return e.id!=t}),$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",s.all_events)):alert("an error occurred...")}):c.go("dashboard.bookings.add")},y.remove_invite=function(e){y.new_booking.passengers.splice(e,1),y.init_passengers()},y.remove_passenger=function(t){var e=y.new_booking.passengers[t];y.pax_invited(e)?g.DeleteInvitation(e,e.id).then(function(e){1==e.success?(y.new_booking.passengers.splice(t,1),y.init_passengers()):alert(e.message)}):(y.new_booking.passengers.splice(t,1),y.init_passengers())},y.resend_invitation=function(e){e=y.new_booking.passengers[e];g.ResendInvitation(e,e.id).then(function(e){e.success,alert(e.message)})},y.pax_invited=function(e){return""!=e.status&&"to_invite"!=e.status},y.get_passenger_status=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"invited"==e.status?"This passenger has been invited but has not yet responded.":""},y.get_passenger_status_edit=function(e){if(e)return e.is_member?"This passenger is already club member and hence is ready for flight":"accepted"==e.status?"This passenger has accepted the terms and is ready for flight":"declined"==e.status?"This passenger has declined the terms":"to_invite"==e.status?"Invitation will be sent once the booking is saved.":"member"==e.status?"This passenger is a member":"invited"==e.status?"This passenger has been invited but has not yet accepted.":""},y.invite_new_passenger=function(e){y.show_new_passenger_invitation=!0,y.new_pax=e},y.close_passenger_invitation=function(){y.new_pax=-1,y.show_new_passenger_invitation=!1},s.get_members=function(t,n){0!=y.club_id&&y.club_id||!y.new_booking.plane||!y.new_booking.plane.id||(y.club_id=y.new_booking.plane.club_id),2<t.length&&o.GetAllByClubAndName(y.club_id,t).then(function(e){e.success?(y.members=e.members,y.members.length<1&&(y.new_booking.passengers[n].not_found=!0,y.new_booking.passengers[n].email="",y.new_booking.passengers[n].status="",y.new_booking.passengers[n].first_name="",y.new_booking.passengers[n].last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)?y.new_booking.passengers[n].email=t:-1<t.indexOf(" ")?(e=t.split(" "),y.new_booking.passengers[n].first_name=e[0],y.new_booking.passengers[n].last_name=e[1]):y.new_booking.passengers[n].first_name=t)):(y.new_booking.passengers[n].status="",y.new_booking.passengers[n].email="",y.new_booking.passengers[n].first_name="",y.new_booking.passengers[n].last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)&&(y.new_booking.passengers[n].email=t,y.new_booking.passengers[n].not_found=!0))})},s.save=function(){"add"==y.action?s.create():(U(),s.update())},s.update=function(){var e=new Date;e.setHours(14),e.setMinutes(0),s.mytime=e},y.show_self_option=!1,s.select_plane=function(e){s.check_rental_items(),M(),-1<y.user.access.instructor.indexOf(y.club_id)||-1<y.user.access.manager.indexOf(y.club_id)?y.show_self_option=!0:y.show_self_option=!1,-1<y.user.access.instructor.indexOf(y.club_id)&&(y.booking_self=!1)},L(),l.start&&(y.new_booking.start_date=new Date(l.start),y.new_booking.end_date=new Date(l.start),y.new_booking.start_time={time:moment(l.start).format("HH:mm")},y.new_booking.end_time={time:moment(l.start).add(30,"minutes").format("HH:mm")},y.default_date=y.new_booking.start_date,setTimeout(function(){$("#calendar").fullCalendar("renderEvent",{id:"TEMP",title:"TEMPORARY",resourceId:7,start:"2021-03-21 19:30:00",end:"2021-03-21 21:00:00",editable:!1,color:"#FFcccc",opacity:"1"}),s.update_dateTime("edit2",l.plane_id)},1e3)),s.make_booking=function(e){if(s.submitted=!0,e){e={};return(delete(e=jQuery.extend(!0,{},y.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,delete e.user,moment(Date.parse(y.new_booking.start_datetime)).isBefore())?(alert("This booking ends in the past - you cannot create a booking in the past."),!1):moment(Date.parse(y.new_booking.start_datetime)).add(30,"minutes").isBefore()?(alert("This booking starts in the past - you cannot create a booking in the past."),!1):(e.override=y.new_booking.override||0,y.booking_self?(e.user_id=y.user.id,e.instructor_id=y.new_booking.instructor?y.new_booking.instructor.id:0):(e.user_id=y.new_booking.user.user_id,-1<y.user.access.manager.indexOf(y.club_id)?e.instructor_id=y.new_booking.instructor?y.new_booking.instructor.id:0:e.instructor_id=y.user.id,e.booked_by_admin_instructor=1,e.override=1),e.free_seats=y.new_booking.free_seats.constructor===Array?0:y.new_booking.free_seats,e.start=y.new_booking.start_datetime,e.end=y.new_booking.end_datetime,e.plane_id=y.new_booking.plane.id,e.club_id=y.new_booking.plane.club_id,e.booked_by=y.user.id,e.course_id=y.new_booking.tuition_required?y.new_booking.tuition_required.id:0,void g.Create(y.user.id,e).then(function(e){if(1==e.success)s.clear_booking(),g.GetAll(y.user.id,moment(y.new_booking.start_date).format("Y-M-D"),"").then(function(e){s.all_events=e.events,s.all_resources=e.resources,$("#calendar").fullCalendar("refetchEvents"),$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",s.all_events)}),c.go("dashboard.bookings.add");else{if(e.more&&0<e.more.length){for(var t="",n=0;n<e.more.length;n++)"differences_verified"==e.more[n].name&&(t+="\n - Your differences training sign-offs need to be verified by a member of staff. \n"),"licence_verified"==e.more[n].name&&(t+="\n - Your licence needs to be verified by a member of staff. \n"),"medical_verified"==e.more[n].name&&(t+="\n - Your medical needs to be verified by a member of staff. \n"),"medical"==e.more[n].name&&(t+="\n - You need to upload a copy of your medical. \n"),"licence"==e.more[n].name&&(t+="\n - You need to upload a copy of your licence. \n"),"differences"==e.more[n].name&&(t+="\n - You need to upload a copy of your differences training signed off. \n");e.message=e.message+t}alert("Sorry! \n\n"+e.message)}}))}},s.popup2={opened:!1},s.popup3={opened:!1},s.popup4={opened:!1},s.open2=function(){s.popup2.opened=!0},s.open3=function(){s.popup3.opened=!0},s.open4=function(){s.popup4.opened=!0},s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return warning_msg}}}).result.then(function(t){u.info("PRESSED GO: "+t),o.Delete(t).then(function(){y.club.members=$.grep(y.club.members,function(e){return e.id!=t})})},function(){u.info("Modal dismissed at: "+new Date)})}}function BookoutController(n,e,t,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w,C,S,x,O){var D=this;D.user=r.globals.currentUser,D.user_id=D.user.id,D.booking={},D.wgs_n="51.51",D.wgs_e="0.12",D.change_booking={},D.show_change_plane=!1,D.bookout={start:!0,passengers:[],pic:{id:D.user_id}},D.reported_defects=[],D.can_authorise=!1,D.bookout.plane={id:12,registration:"G-BSXA",type:"PA28",current_tacho:5112.3,estimated_fuel:100,consumption:30,seats:4,last_tacho:3941.01,last_position:12},D.dateFormat="date:HH:mm 'on' dd/MM/yyyy",s.show_change_plane=function(){D.show_change_plane=!0},D.seats_in_plane=function(){var e=D.bookout.plane.seats;return D.bookout.pic.id!==D.user_id&&e--,0<D.bookout.passengers.length&&(e-=D.bookout.passengers.length),--e},D.init_passengers=function(){},s.amend_booking=function(){},s.accept_defects=function(){confirm("You accept to fly the aircraft despite known defect(s) which have been reported by previous pilots")&&(D.bookout.accept_defects=!0)},s.reject_defects=function(){confirm("Would you like to cancel this booking?")||(D.bookout.accept_defects=!1)},s.get_hours_from_decimal=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(1==t?"":"-")+n+":"+e},s.get_airfields=function(t){var e;2<t.length&&t.length<5&&y.GetAirfieldsByCode(t).then(function(e){e.success&&(D.airfields=e.airfields,0==D.airfields.length&&(D.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}),4<t.length&&(e=t.replace(/\s/g,"_"),y.GetAirfields(e).then(function(e){e.success&&(D.airfields=e.airfields,0==D.airfields.length&&(D.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}))};s.update_pic=function(){D.bookout.pic.user_id==D.user.id&&0<D.bookout.instructor_id||0<D.bookout.instructor_id&&(D.bookout.pic.user_id,D.bookout.instructor_id)},D.invite_new_passenger=function(e){D.new_pax&&""!==D.new_pax.email&&0==D.new_pax.is_member?(D.new_pax.invited_by=D.user.id,y.AddPassenger(D.new_pax,l.booking_id).then(function(e){e.success&&(alert("INVITATION SENT!"),D.update_passenger_list(),D.show_new_passenger_invitation=!1)})):alert("Please enter a valid email address to send the invitation to.")},D.add_new_passenger=function(e){D.new_pax.is_member?(D.new_pax.club_id=D.club_id,D.new_pax.invited_by=D.user.id,y.AddPassenger(D.new_pax,l.booking_id).then(function(e){e.success&&D.update_passenger_list()})):D.show_new_passenger_invitation=!0},D.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},D.close_passenger_invitation=function(){D.show_new_passenger_invitation=!1},s.get_members=function(t){0!=D.club_id&&D.club_id||!D.bookout.plane||!D.bookout.plane.id||(D.club_id=D.bookout.plane.club_id),2<t.length&&e.GetAllByClubAndName(D.club_id,t).then(function(e){e.success?(e=e.members.filter(function(t){return!D.bookout.passengers.find(function(e){return e.email===t.email})}),D.members=e,D.members.length<1&&(D.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0},/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)?D.new_pax.email=t:-1<t.indexOf(" ")?(e=t.split(" "),D.new_pax.first_name=e[0],D.new_pax.last_name=e[1]):D.new_pax.first_name=t)):(D.new_pax.status="",D.new_pax.email="",D.new_pax.first_name="",D.new_pax.last_name="",/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)&&(D.new_pax.email=t,D.new_pax.not_found=!0))})};var I=function(){e.GetAllByClub(D.club_id).then(function(e){D.members=e;for(var t=0;t<D.members.length;t++)D.members[t].is_member=!0})};function M(e,n,t){var o,i=2<arguments.length&&void 0!==t?t:null;switch(e){case"today":o=new Date;break;case"past":case"future":o=new Date("1990-07-26");break;case"after":case"before":o=new Date(i)}var r=new Date;D[n].forEach(function(e,t){e=e.time.split(":");r.setHours(e[0]),r.setMinutes(e[1]),r.setSeconds(0),moment(r).isAfter(moment(o))?D[n][t].disabled=0:D[n][t].disabled=1})}I(),D.invite_passenger=function(e,t){n.InvitePassenger(D.bookout.passengers[t].email,D.user_id,D.club_id,9,D.bookout.booking_id).then(function(e){D.bookout.passengers[t].status=e.invite.status,D.bookout.passengers[t].invitation_token=e.invite.invitation_token})},D.refresh_passenger=function(e,t){n.GetInvite(D.bookout.passengers[t].invitation_token).then(function(e){D.bookout.passengers[t].status=e.status,D.bookout.passengers[t].user_id=e.user_id,D.bookout.passengers[t].first_name=e.first_name,D.bookout.passengers[t].last_name=e.last_name})},D.update_passenger_list=function(){y.GetPassengers(l.booking_id).then(function(e){e.success&&(D.bookout.passengers=e.passengers,D.new_pax={id:0,email:"",first_name:"",last_name:"",is_member:!1,status:"",not_found:!0})})},D.resend_invitation=function(e){b.ResendInvitation(e,e.id).then(function(e){e.success,alert(e.message)})},D.refresh_all_passenger=function(){var t=0;++t<D.bookout.passengers.length&&D.bookout.passengers[t]&&"invited"==D.bookout.passengers[t].status&&""!==D.bookout.passengers[t].invitation_token&&n.GetInvite(D.bookout.passengers[t].invitation_token).then(function(e){D.bookout.passengers[t].status=e.status,D.bookout.passengers[t].user_id=e.user_id,D.bookout.passengers[t].first_name=e.first_name,D.bookout.passengers[t].last_name=e.last_name})},D.get_passenger_status=function(e){if(e)return e.is_member?"OK - is already club member":"accepted"==e.status?"OK - passenger has accepted the terms":"declined"==e.status?"NO - passenger declined the offer":"invited"==e.status?"Waiting for user response":""},D.pics=[],D.flight_types=[{id:1,title:"Local"},{id:2,title:"Departure"},{id:3,title:"Circuits"},{id:4,title:"Other"}],D.biggin_hill={routes:[{id:1,title:"Kenley"},{id:2,title:"Sevenoaks"},{id:3,title:"Swanley"},{id:4,title:"Other"}],parking:""},D.flight_rules=[{id:1,title:"VFR"},{id:2,title:"IFR"}],D.start_times=[],D.all_times=[];for(var P=0;P<24;P++){for(var A=0;A<12;A++)D.start_times.push({time:P+":"+(U=((U=5*A)<10?"0":"")+U),disabled:!1});for(var U,A=0;A<6;A++)D.all_times.push({time:P+":"+(U=((U=10*A)<10?"0":"")+U),disabled:!1})}switch(M("today","start_times"),M("future","all_times"),D.init_passengers(),D.currency_days=28,D.extra_information_required=!1,D.filing_flightplan=!1,D.instructor_charges=[],D.club={plane:{}},c.current.data.action){case"add":console.log("ADD"),b.GetForBookout(D.user.id,l.booking_id).then(function(t){t.success&&(D.booking=t.booking,e.GetAllByPicsBookinout(t.booking.id,t.booking.club_id,D.user.id).then(function(e){w.GetByIdMaintenance(D.booking.plane.id,t.booking.club_id).then(function(e){D.club.plane=e,function(){var e=D.club.plane;e.maintenance&&(s.status.days=0<e.maintenance.days_remaining?"ok":"expired",s.status.hours=0<e.maintenance.hours_remaining?"ok":"expired");s.status.certificate=0<e.certificate.days_to_expiry?"ok":"expired",s.status.insurance=0<e.insurance.days_to_expiry?"ok":"expired",s.status.radio_licence=0<e.radio_licence.days_to_expiry?"ok":"expired"}()}),D.pics=e,function(t){D.bookout.booking_id=t.id,D.bookout.club_id=t.club_id,D.bookout.user_id=t.user_id,D.bookout.plane=t.plane,D.club_id=t.club_id,D.bookout.return=new Date(t.end),D.bookout.booking_start=new Date(t.start),(-1<D.user.access.instructor.indexOf(D.club_id)||-1<D.user.access.manager.indexOf(D.club_id))&&(D.can_authorise=!0);{var e;w.GetOpenIssues(t.plane.id).then(function(e){D.reported_defects=e}),I(),t.instructor&&0<t.instructor.id?(n=D.pics.find(function(e){return e.user_id===t.instructor.id}),D.bookout.pic=n,D.bookout.instructor_id=t.instructor.id,D.bookout.instructor=t.instructor,D.bookout.course_id=t.course_id,D.bookout.tuition_required=t.tuition_required,O.GetCoursesByClubId(D.bookout.club_id).then(function(e){D.courses=e.items,console.log("COURSES",D.courses),console.log("COURSES",D.bookout.course_id),D.bookout.selected_course=D.courses.find(function(e,t){if(e.id==D.bookout.course_id)return!0}),console.log("vm.bookout.course_id",D.bookout.course_id),D.update_course()}),e=D.pics.find(function(e){return e.user_id===t.user_id}),D.bookout.put=e):(n=D.pics.find(function(e){return e.user_id===t.user_id}),D.bookout.pic=n)}D.bookout.passengers=t.passengers,D.init_passengers(),t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.wgs_n&&(D.wgs_n=t.plane_details.location.wgs_n,D.wgs_e=t.plane_details.location.wgs_e);var n="";n=t&&t.plane_details&&t.plane_details.location&&t.plane_details.location.code?t.plane_details.location.code.slice(0,-1):"EG";y.GetAirfieldsByCode(n).then(function(e){e.success&&(D.airfields=e.airfields,e=D.airfields.find(function(e){return e.id===t.plane_details.location.id}),D.bookout.from_airfield=e)})}(t.booking)}))});break;case"edit":console.log("EDIT ONE"),h.GetById(l.licence_id).then(function(e){if(e.success){D.licence=e.licence,D.licence.licence_issue_date=new Date(D.licence.licence_issue_date),D.licence.licence_expiry_date=new Date(D.licence.licence_expiry_date),D.licence.licence_type=$.grep(D.licence_types,function(e){return e.id==D.licence.licence_id})[0],D.licence.state_of_issue=$.grep(D.authority,function(e){return e.id==D.licence.authority_id})[0];for(var t=0;t<D.licence.ratings.length;t++)delete D.licence.ratings[t].id,D.licence.ratings[t].id=D.licence.ratings[t].rating_id,delete D.licence.ratings[t].rating_id,D.licence.ratings[t].test_date=new Date(D.licence.ratings[t].test_date),D.licence.ratings[t].expiry_date=new Date(D.licence.ratings[t].expiry_date),D.ratings=$.grep(D.ratings,function(e){return e.id!=D.licence.ratings[t].id})}});break;case"list":h.GetByUserId(D.user_id).then(function(e){e.success&&(D.user_licences=e.licences)})}s.show_file_now=!1,s.show_file_url="",s.show_file=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");C.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.close_file=function(){s.show_file_now=!1,s.show_file_url=""},s.applyFilter=function(e,t){if(t){var n=t.split(":"),o=n[0],t=[e];return 1<n.length?"date"==o.toLowerCase()&&t.push(n.slice(1).join(":")):t=t.concat(n.slice(1)),v(o).apply(this,t)}return e},s.status={days:"",hours:"",insurance:"",certificate:"",radio_licence:""},D.update_course=function(){D.bookout.selected_course&&0<D.bookout.selected_course.id?O.GetChargesByCourseId(D.bookout.selected_course.id).then(function(e){D.instructor_charges=e.items,1==D.instructor_charges.length&&(D.bookout.tuition_required=D.instructor_charges[0])}):k.GetByClubId(D.bookout.club_id).then(function(e){D.instructor_charges=e.items,1==D.instructor_charges.length&&(D.bookout.tuition_required=D.instructor_charges[0])})},s.selected_airfield_check=function(){150==D.bookout.from_airfield.id||D.bookout.to_airfield&&150==D.bookout.to_airfield.id?D.extra_information_required=!0:D.filing_flightplan||150===D.bookout.from_airfield.id||D.bookout.to_airfield&&D.bookout.to_airfield.id&&150===D.bookout.to_airfield.id||(D.extra_information_required=!1)},s.add_rating=function(){D.ratings=$.grep(D.ratings,function(e){return e.id!=D.selected_rating.id}),D.licence.ratings.push(D.selected_rating),delete D.selected_rating},s.remove_rating=function(e){D.ratings.push(D.licence.ratings[e]),D.licence.ratings.splice(e,1)},s.bookout_plane=function(){if(!D.bookout.flight_type||D.bookout.flight_type.id<1)return alert("You need to select a flight type - is this a local flight? Or a departure?"),!1;if(!D.bookout.pic||D.bookout.pic.id<1)return alert("You need to select a Pilot In Command (PIC)"),!1;if((!D.bookout.is_current||0==D.bookout.is_current)&&D.bookout.instructor_id<1)return alert("Please confirm that you are current according to the club rules, as you do not have an instructor booked."),!1;if(2==D.bookout.flight_type.id&&(!D.bookout.to_airfield||D.bookout.to_airfield.id<1&&""==D.bookout.to_airfield.title))return alert("As you selected this flight to be a departure, please select a destination airfield"),!1;if(!D.bookout.accept_defects&&0<D.reported_defects.length)return alert("You must state that you have read the defects currently reported and accept to fly the plane in the condition provided prior to booking out the plane."),!1;D.refresh_all_passenger();for(var e=D.bookout.passengers,t=0;t<e.length;t++){if("to_invite"==e[t].status)return alert("You need to press the invitation button for your passenger who isn't already a member before booking out."),!1;if("invited"==e[t].status&&e[t].aboard)return alert("You need to make sure that your passenger has completed his membership and has agreed to the terms of your flight before you go flying."),!1}var n={club_id:D.bookout.club_id,plane_id:D.bookout.plane.id,user_id:D.bookout.user_id,pic_id:D.bookout.pic.user_id,booking_id:D.bookout.booking_id,is_pilot_current:D.bookout.is_current,dual_flight:0<D.bookout.instructor_id&&D.bookout.pic.id==D.bookout.instructor.id?1:0,instructor_id:D.bookout.instructor_id,tuition_id:0<D.bookout.instructor_id&&D.bookout.tuition_required&&!D.bookout.authorised_solo?D.bookout.tuition_required.id:0,detail_type_id:D.bookout.flight_type.id,from_airport_id:D.bookout.from_airfield.id,to_airport_id:(1==D.bookout.flight_type.id||3==D.bookout.flight_type.id?D.bookout.from_airfield:D.bookout.to_airfield).id,booked_out:1,booked_in:0,flight_date:new Date(D.bookout.booking_start),passengers:D.bookout.passengers,authorised_solo:!!D.bookout.authorised_solo,authorised_by:D.bookout.authorised_solo?D.user.id:0,endurance_time:D.bookout.endurance,estimated_enroute_time:D.bookout.en_route,flight_rules:D.bookout.flight_rule,flight_notes:D.bookout.additional_details,parking_note:D.bookout.parking_note,estimated_departure:D.bookout.departure,routing_via_id:D.bookout.routing_via?D.bookout.routing_via.id:0};0==n.to_airport_id&&(n.new_to_airport=D.bookout.to_airfield,n.new_to_airport.title=n.new_to_airport.title.replace("NOT LISTED : ","")),0==n.from_airport_id&&(n.new_from_airport=D.bookout.from_airfield,n.new_from_airport.title=n.new_from_airport.title.replace("NOT LISTED : ","")),y.SendBookout(D.user.id,n).then(function(e){c.go("dashboard.my_account.booked_out",{booking_id:D.bookout.booking_id})})},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){D.licence.images=$.grep(D.licence.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);h.DeleteTmp(e.saved_url).then(function(e){e.success&&(D.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,D.licence_images.push(e[t].file)}},s.delete_licence=function(t){"YES"==prompt("Are you sure you wish to delete this licence? \n\n This change is irreversible! To confirm please type YES in the box below.")&&h.Delete(D.user_id,t).then(function(e){e.success?(D.user_licences=$.grep(D.user_licences,function(e){return e.id!=t}),c.reload(),c.go("dashboard.my_account.licence")):alert("Something went terribly wrong... \n\n "+e.message)})},s.save_licence=function(e){if(D.licence_images.length<1&&D.licence.images.length<1)return $(".drop").focus(),alert("You must at least have 1 image of your licence!"),!1;if(!D.licence.licence_type)return $("#licence_type").focus(),alert("You must select a licence type"),!1;if(!D.licence.state_of_issue)return $("#state_of_issue").focus(),alert("You must select a licence state of issue"),!1;if(D.licence.ratings.length<1)return $("#ratings").focus(),alert("You must at least have 1 rating!"),!1;for(var t=0;t<D.licence.images.length;t++)delete D.licence.images[t].data_uri;D.licence.images=D.licence.images.concat(D.licence_images),D.licence.licence_id=D.licence.licence_type.id,D.licence.authority_id=D.licence.state_of_issue.id,D.licence.user_id=D.user_id,delete D.licence.licence_type,delete D.licence.state_of_issue,D.licence.id?h.Update(D.licence).then(function(e){e.success?c.go("dashboard.my_account.licence",{},{reload:!0}):alert("Something went terribly wrong... \n\n "+e.message)}):h.Create(D.licence).then(function(e){e.success?(c.reload(),c.go("dashboard.my_account.licence",{},{reload:!0})):alert("Something went terribly wrong... \n\n "+e.message)})},s.logout=function(){x.Logout(function(e){x.ClearCredentials(),S.remove("globals"),S.remove("session"),a.path("/login")})},s.go_flying=function(){c.go("dashboard.my_account",{},{reload:!0})}}function CategoriesController(e,n,t,o,i,r,a){var s=this;n.GetAll().then(function(e){s.cats=e}),s.id=1,s.myModel="Click here and delete me",a.myUpdateHandler=function(e,t){n.Update({id:e,title:t}).then(function(e){})},a.addCategory=function(){var e={title:s.new_category};n.Create(e).then(function(e){s.cats.push(e),s.new_category=""})},a.deleteCategory=function(t){n.Delete(t).then(function(e){s.cats=$.grep(s.cats,function(e){return e.id!=t})})}}function ClaimAFlightController(e,t,n,i,o,r){var a=this;a.user=n.globals.currentUser,a.unclaimed=[],a.looking_for=o.registration,a.looking_for&&(i.my_search2=a.looking_for),console.log("init claim a flight controller"),t.GetFoxEntries(n.globals.currentUser.id).then(function(e){console.log("GetFoxEntries was called here"),a.unclaimed=e,console.log("vm.unclaimed",a.unclaimed)}),i.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(i.my_search)||"")},i.search2=function(e){return-1!==angular.lowercase(e.registration).indexOf(angular.lowercase(i.my_search2)||"")},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},a.clean_times=function(e){return e.substring(0,5)},a.difference_times=function(e,t){e=moment(e),t=moment(t),t=moment.duration(t.diff(e)).asHours(),e=Math.floor(Math.abs(t)),t=Math.round(60*Math.abs(t)%60);return(e<10?"0":"")+e+":"+(t<10?"0":"")+t},a.difference_times_decimal=function(e,t){e=moment(e),t=moment(t);return moment.duration(t.diff(e)).asHours()},a.airborne_decimal=function(e){return e/60/60},a.airborne_to_hours=function(e){var t=e/60/60,e=Math.floor(Math.abs(t)),t=Math.round(60*Math.abs(t)%60);return 60==t&&(e+=1,t=0),(e<10?"0":"")+e+":"+(t<10?"0":"")+t},i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"}}function ClubDocumentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y){var v=this;switch(v.licence_images=[],v.documents=[],v.licence={images:[],ratings:[]},v.club_id=r.globals.currentUser.current_club_admin.id,v.user=r.globals.currentUser,v.user_id=v.user.id,v.uploaded_document={},c.current.data.action){case"add":break;case"edit":h.GetById(l.document_id).then(function(e){e.success&&(v.document=e.document,v.uploaded_document={file:v.document.document})});break;case"list":h.GetByClubId(v.club_id).then(function(e){e.success&&(v.club_documents=e.club_documents)})}s.add_rating=function(){v.ratings=$.grep(v.ratings,function(e){return e.id!=v.selected_rating.id}),v.licence.ratings.push(v.selected_rating),delete v.selected_rating},s.remove_rating=function(e){v.ratings.push(v.licence.ratings[e]),v.licence.ratings.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(v.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,v.documents.push(e[t].file)}},s.delete_licence=function(t){"YES"==prompt("Are you sure you wish to delete this licence? \n\n This change is irreversible! To confirm please type YES in the box below.")&&h.Delete(v.user_id,t).then(function(e){e.success?(v.club_documents=$.grep(v.club_documents,function(e){return e.id!=t}),c.reload(),c.go("dashboard.manage_club.documents")):alert("Something went terribly wrong... \n\n "+e.message)})},s.save_licence=function(e){if(v.documents.length<1&&""==v.document.document)return $(".drop").focus(),alert("You must at least have 1 pdf!"),!1;var t;v.document.id?h.Update(v.document).then(function(e){e.success?c.go("dashboard.manage_club.documents",{},{reload:!0}):alert("Something went terribly wrong... \n\n "+e.message)}):(t={my_file:v.documents[0],title:v.document.title,description:v.document.description,club_id:v.club_id},h.Create(t).then(function(e){e.success?(c.reload(),c.go("dashboard.manage_club.documents",{},{reload:!0})):alert("Something went terribly wrong... \n\n "+e.message)}))};function k(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this document no other member will be able to see it."}}}).result.then(function(e){var t=e.id;u.info("PRESSED GO: ",t),h.Delete(v.user_id,t).then(function(e){e.success?(v.club_documents=$.grep(v.club_documents,function(e){return e.id!=t}),c.reload(),c.go("dashboard.manage_club.documents")):alert("Something went terribly wrong... \n\n "+e.message)})},function(){u.info("Modal dismissed at: "+new Date)})},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");y.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){k(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function ClubPaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b){var h=this;switch(h.poid_images=[],h.poid={images:[]},h.user=r.globals.currentUser,h.user_id=h.user.id,h.customer_token="",s.get_addresses=function(){g.GetAddresses(h.postcode).then(function(e){e.success&&(h.addresses=e.addresses)})},c.current.data.action){case"add":break;case"edit":b.GetById(l.card_id).then(function(e){e.success&&(h.poid=e.poid,h.poid.expiry_date=new Date(h.poid.expiry_date))});break;case"list":g.GetByUserId(h.user_id).then(function(e){e.success&&(h.cards=e.cards)})}}function ClubSignupController(e,t,n,o,i,r,a,s,c,l,d){var u=this;a.companies=[],a.selected_company,a.selected_phone,a.verified_mobile=!1,a.text_verification="",u.check_id=12,a.link="",a.prefix="",a.countries=[{CountryCode:"+247",CountryCodeISO:"SH",Country:"Ascension"},{CountryCode:"+246",CountryCodeISO:"DG",Country:"Diego Garcia"},{CountryCode:"+291",CountryCodeISO:"ER",Country:"Eritrea"},{CountryCode:"+500",CountryCodeISO:"FK",Country:"Falkland (Malvinas) Islands"},{CountryCode:"+692",CountryCodeISO:"MH",Country:"Marshall Islands"},{CountryCode:"+691",CountryCodeISO:"FM",Country:"Micronesia"},{CountryCode:"+683",CountryCodeISO:"NU",Country:"Niue Island"},{CountryCode:"+290",CountryCodeISO:"SH",Country:"Saint Helena"},{CountryCode:"+508",CountryCodeISO:"PM",Country:"Saint Pierre and Miquelon"},{CountryCode:"+690",CountryCodeISO:"TK",Country:"Tokelau"},{CountryCode:"+688",CountryCodeISO:"TV",Country:"Tuvalu"},{CountryCode:"+379",CountryCodeISO:"VA",Country:"Vatican City"},{CountryCode:"+681",CountryCodeISO:"WF",Country:"Wallis and Futuna"},{CountryCode:"+1",CountryCodeISO:"AS",Country:"American Samoa"},{CountryCode:"+1",CountryCodeISO:"CA",Country:"Canada"},{CountryCode:"+61",CountryCodeISO:"AU",Country:"Australia"},{CountryCode:"+93",CountryCodeISO:"AF",Country:"Afghanistan"},{CountryCode:"+355",CountryCodeISO:"AL",Country:"Albania"},{CountryCode:"+213",CountryCodeISO:"DZ",Country:"Algeria"},{CountryCode:"+376",CountryCodeISO:"AD",Country:"Andorra"},{CountryCode:"+244",CountryCodeISO:"AO",Country:"Angola"},{CountryCode:"+54",CountryCodeISO:"AR",Country:"Argentina"},{CountryCode:"+374",CountryCodeISO:"AM",Country:"Armenia"},{CountryCode:"+297",CountryCodeISO:"AW",Country:"Aruba"},{CountryCode:"+43",CountryCodeISO:"AT",Country:"Austria"},{CountryCode:"+994",CountryCodeISO:"AZ",Country:"Azerbaijan"},{CountryCode:"+973",CountryCodeISO:"BH",Country:"Bahrain"},{CountryCode:"+880",CountryCodeISO:"BD",Country:"Bangladesh"},{CountryCode:"+375",CountryCodeISO:"BY",Country:"Belarus"},{CountryCode:"+32",CountryCodeISO:"BE",Country:"Belgium"},{CountryCode:"+501",CountryCodeISO:"BZ",Country:"Belize"},{CountryCode:"+229",CountryCodeISO:"BJ",Country:"Benin"},{CountryCode:"+975",CountryCodeISO:"BT",Country:"Bhutan"},{CountryCode:"+591",CountryCodeISO:"BO",Country:"Bolivia"},{CountryCode:"+387",CountryCodeISO:"BA",Country:"Bosnia and Herzegovina"},{CountryCode:"+267",CountryCodeISO:"BW",Country:"Botswana"},{CountryCode:"+55",CountryCodeISO:"BR",Country:"Brazil"},{CountryCode:"+673",CountryCodeISO:"BN",Country:"Brunei"},{CountryCode:"+359",CountryCodeISO:"BG",Country:"Bulgaria"},{CountryCode:"+226",CountryCodeISO:"BF",Country:"Burkina Faso"},{CountryCode:"+257",CountryCodeISO:"BI",Country:"Burundi"},{CountryCode:"+855",CountryCodeISO:"KH",Country:"Cambodia"},{CountryCode:"+237",CountryCodeISO:"CM",Country:"Cameroon"},{CountryCode:"+238",CountryCodeISO:"CV",Country:"Cape Verde"},{CountryCode:"+236",CountryCodeISO:"CF",Country:"Central African Republic"},{CountryCode:"+235",CountryCodeISO:"TD",Country:"Chad"},{CountryCode:"+56",CountryCodeISO:"CL",Country:"Chile"},{CountryCode:"+86",CountryCodeISO:"CN",Country:"China"},{CountryCode:"+57",CountryCodeISO:"CO",Country:"Colombia"},{CountryCode:"+269",CountryCodeISO:"KM",Country:"Comoros"},{CountryCode:"+242",CountryCodeISO:"CG",Country:"Congo"},{CountryCode:"+682",CountryCodeISO:"CK",Country:"Cook Islands"},{CountryCode:"+506",CountryCodeISO:"CR",Country:"Costa Rica"},{CountryCode:"+385",CountryCodeISO:"HR",Country:"Croatia"},{CountryCode:"+53",CountryCodeISO:"CU",Country:"Cuba"},{CountryCode:"+357",CountryCodeISO:"CY",Country:"Cyprus"},{CountryCode:"+420",CountryCodeISO:"CZ",Country:"Czech Republic"},{CountryCode:"+243",CountryCodeISO:"CD",Country:"Democratic Republic of Congo"},{CountryCode:"+45",CountryCodeISO:"DK",Country:"Denmark"},{CountryCode:"+253",CountryCodeISO:"DJ",Country:"Djibouti"},{CountryCode:"+670",CountryCodeISO:"TL",Country:"East Timor"},{CountryCode:"+593",CountryCodeISO:"EC",Country:"Ecuador"},{CountryCode:"+20",CountryCodeISO:"EG",Country:"Egypt"},{CountryCode:"+503",CountryCodeISO:"SV",Country:"El Salvador"},{CountryCode:"+240",CountryCodeISO:"GQ",Country:"Equatorial Guinea"},{CountryCode:"+372",CountryCodeISO:"EE",Country:"Estonia"},{CountryCode:"+251",CountryCodeISO:"ET",Country:"Ethiopia"},{CountryCode:"+298",CountryCodeISO:"FO",Country:"Faroe Islands"},{CountryCode:"+679",CountryCodeISO:"FJ",Country:"Fiji"},{CountryCode:"+358",CountryCodeISO:"FI",Country:"Finland"},{CountryCode:"+33",CountryCodeISO:"FR",Country:"France"},{CountryCode:"+594",CountryCodeISO:"GF",Country:"French Guiana"},{CountryCode:"+689",CountryCodeISO:"PF",Country:"French Polynesia"},{CountryCode:"+241",CountryCodeISO:"GA",Country:"Gabon"},{CountryCode:"+220",CountryCodeISO:"GM",Country:"Gambia"},{CountryCode:"+995",CountryCodeISO:"GE",Country:"Georgia"},{CountryCode:"+49",CountryCodeISO:"DE",Country:"Germany"},{CountryCode:"+233",CountryCodeISO:"GH",Country:"Ghana"},{CountryCode:"+350",CountryCodeISO:"GI",Country:"Gibraltar"},{CountryCode:"+30",CountryCodeISO:"GR",Country:"Greece"},{CountryCode:"+299",CountryCodeISO:"GL",Country:"Greenland"},{CountryCode:"+590",CountryCodeISO:"GP",Country:"Guadeloupe"},{CountryCode:"+502",CountryCodeISO:"GT",Country:"Guatemala"},{CountryCode:"+224",CountryCodeISO:"GN",Country:"Guinea"},{CountryCode:"+245",CountryCodeISO:"GW",Country:"Guinea-Bissau"},{CountryCode:"+592",CountryCodeISO:"GY",Country:"Guyana"},{CountryCode:"+509",CountryCodeISO:"HT",Country:"Haiti"},{CountryCode:"+504",CountryCodeISO:"HN",Country:"Honduras"},{CountryCode:"+852",CountryCodeISO:"HK",Country:"Hong Kong"},{CountryCode:"+36",CountryCodeISO:"HU",Country:"Hungary"},{CountryCode:"+354",CountryCodeISO:"IS",Country:"Iceland"},{CountryCode:"+91",CountryCodeISO:"IN",Country:"India"},{CountryCode:"+62",CountryCodeISO:"ID",Country:"Indonesia"},{CountryCode:"+98",CountryCodeISO:"IR",Country:"Iran"},{CountryCode:"+964",CountryCodeISO:"IQ",Country:"Iraq"},{CountryCode:"+353",CountryCodeISO:"IE",Country:"Ireland"},{CountryCode:"+972",CountryCodeISO:"IL",Country:"Israel"},{CountryCode:"+39",CountryCodeISO:"IT",Country:"Italy"},{CountryCode:"+225",CountryCodeISO:"CI",Country:"Ivory Coast"},{CountryCode:"+81",CountryCodeISO:"JP",Country:"Japan"},{CountryCode:"+962",CountryCodeISO:"JO",Country:"Jordan"},{CountryCode:"+254",CountryCodeISO:"KE",Country:"Kenya"},{CountryCode:"+686",CountryCodeISO:"KI",Country:"Kiribati"},{CountryCode:"+965",CountryCodeISO:"KW",Country:"Kuwait"},{CountryCode:"+996",CountryCodeISO:"KG",Country:"Kyrgyzstan"},{CountryCode:"+856",CountryCodeISO:"LA",Country:"Laos"},{CountryCode:"+371",CountryCodeISO:"LV",Country:"Latvia"},{CountryCode:"+961",CountryCodeISO:"LB",Country:"Lebanon"},{CountryCode:"+266",CountryCodeISO:"LS",Country:"Lesotho"},{CountryCode:"+231",CountryCodeISO:"LR",Country:"Liberia"},{CountryCode:"+218",CountryCodeISO:"LY",Country:"Libya"},{CountryCode:"+423",CountryCodeISO:"LI",Country:"Liechtenstein"},{CountryCode:"+370",CountryCodeISO:"LT",Country:"Lithuania"},{CountryCode:"+352",CountryCodeISO:"LU",Country:"Luxembourg"},{CountryCode:"+853",CountryCodeISO:"MO",Country:"Macau"},{CountryCode:"+389",CountryCodeISO:"MK",Country:"Macedonia"},{CountryCode:"+261",CountryCodeISO:"MG",Country:"Madagascar"},{CountryCode:"+265",CountryCodeISO:"MW",Country:"Malawi"},{CountryCode:"+60",CountryCodeISO:"MY",Country:"Malaysia"},{CountryCode:"+960",CountryCodeISO:"MV",Country:"Maldives"},{CountryCode:"+223",CountryCodeISO:"ML",Country:"Mali"},{CountryCode:"+356",CountryCodeISO:"MT",Country:"Malta"},{CountryCode:"+596",CountryCodeISO:"MQ",Country:"Martinique"},{CountryCode:"+222",CountryCodeISO:"MR",Country:"Mauritania"},{CountryCode:"+230",CountryCodeISO:"MU",Country:"Mauritius"},{CountryCode:"+262",CountryCodeISO:"RE",Country:"Reunion"},{CountryCode:"+52",CountryCodeISO:"MX",Country:"Mexico"},{CountryCode:"+373",CountryCodeISO:"MD",Country:"Moldova"},{CountryCode:"+377",CountryCodeISO:"MC",Country:"Monaco"},{CountryCode:"+976",CountryCodeISO:"MN",Country:"Mongolia"},{CountryCode:"+382",CountryCodeISO:"ME",Country:"Montenegro"},{CountryCode:"+212",CountryCodeISO:"MA",Country:"Morocco"},{CountryCode:"+258",CountryCodeISO:"MZ",Country:"Mozambique"},{CountryCode:"+95",CountryCodeISO:"MM",Country:"Myanmar"},{CountryCode:"+264",CountryCodeISO:"NA",Country:"Namibia"},{CountryCode:"+674",CountryCodeISO:"NR",Country:"Nauru"},{CountryCode:"+977",CountryCodeISO:"NP",Country:"Nepal"},{CountryCode:"+31",CountryCodeISO:"NL",Country:"Netherlands"},{CountryCode:"+599",CountryCodeISO:"AN",Country:"Netherlands Antilles"},{CountryCode:"+687",CountryCodeISO:"NC",Country:"New Caledonia"},{CountryCode:"+64",CountryCodeISO:"NZ",Country:"New Zealand"},{CountryCode:"+505",CountryCodeISO:"NI",Country:"Nicaragua"},{CountryCode:"+227",CountryCodeISO:"NE",Country:"Niger"},{CountryCode:"+234",CountryCodeISO:"NG",Country:"Nigeria"},{CountryCode:"+850",CountryCodeISO:"KP",Country:"North Korea"},{CountryCode:"+47",CountryCodeISO:"NO",Country:"Norway"},{CountryCode:"+968",CountryCodeISO:"OM",Country:"Oman"},{CountryCode:"+92",CountryCodeISO:"PK",Country:"Pakistan"},{CountryCode:"+680",CountryCodeISO:"PW",Country:"Palau"},{CountryCode:"+507",CountryCodeISO:"PA",Country:"Panama"},{CountryCode:"+675",CountryCodeISO:"PG",Country:"Papua New Guinea"},{CountryCode:"+595",CountryCodeISO:"PY",Country:"Paraguay"},{CountryCode:"+51",CountryCodeISO:"PE",Country:"Peru"},{CountryCode:"+63",CountryCodeISO:"PH",Country:"Philippines"},{CountryCode:"+48",CountryCodeISO:"PL",Country:"Poland"},{CountryCode:"+351",CountryCodeISO:"PT",Country:"Portugal"},{CountryCode:"+974",CountryCodeISO:"QA",Country:"Qatar"},{CountryCode:"+40",CountryCodeISO:"RO",Country:"Romania"},{CountryCode:"+7",CountryCodeISO:"KZ",Country:"Kazakhstan"},{CountryCode:"+250",CountryCodeISO:"RW",Country:"Rwanda"},{CountryCode:"+685",CountryCodeISO:"WS",Country:"Samoa"},{CountryCode:"+378",CountryCodeISO:"SM",Country:"San Marino"},{CountryCode:"+239",CountryCodeISO:"ST",Country:"Sao Tome and Principe"},{CountryCode:"+966",CountryCodeISO:"SA",Country:"Saudi Arabia"},{CountryCode:"+221",CountryCodeISO:"SN",Country:"Senegal"},{CountryCode:"+381",CountryCodeISO:"RS",Country:"Serbia"},{CountryCode:"+248",CountryCodeISO:"SC",Country:"Seychelles"},{CountryCode:"+232",CountryCodeISO:"SL",Country:"Sierra Leone"},{CountryCode:"+65",CountryCodeISO:"SG",Country:"Singapore"},{CountryCode:"+421",CountryCodeISO:"SK",Country:"Slovakia"},{CountryCode:"+386",CountryCodeISO:"SI",Country:"Slovenia"},{CountryCode:"+677",CountryCodeISO:"SB",Country:"Solomon Islands"},{CountryCode:"+252",CountryCodeISO:"SO",Country:"Somalia"},{CountryCode:"+27",CountryCodeISO:"ZA",Country:"South Africa"},{CountryCode:"+82",CountryCodeISO:"KR",Country:"South Korea"},{CountryCode:"+34",CountryCodeISO:"ES",Country:"Spain"},{CountryCode:"+94",CountryCodeISO:"LK",Country:"Sri Lanka"},{CountryCode:"+249",CountryCodeISO:"SD",Country:"Sudan"},{CountryCode:"+597",CountryCodeISO:"SR",Country:"Suriname"},{CountryCode:"+268",CountryCodeISO:"SZ",Country:"Swaziland"},{CountryCode:"+46",CountryCodeISO:"SE",Country:"Sweden"},{CountryCode:"+41",CountryCodeISO:"CH",Country:"Switzerland"},{CountryCode:"+963",CountryCodeISO:"SY",Country:"Syria"},{CountryCode:"+886",CountryCodeISO:"TW",Country:"Taiwan"},{CountryCode:"+992",CountryCodeISO:"TJ",Country:"Tajikistan"},{CountryCode:"+255",CountryCodeISO:"TZ",Country:"Tanzania"},{CountryCode:"+66",CountryCodeISO:"TH",Country:"Thailand"},{CountryCode:"+228",CountryCodeISO:"TG",Country:"Togo"},{CountryCode:"+216",CountryCodeISO:"TN",Country:"Tunisia"},{CountryCode:"+90",CountryCodeISO:"TR",Country:"Turkey"},{CountryCode:"+993",CountryCodeISO:"TM",Country:"Turkmenistan"},{CountryCode:"+256",CountryCodeISO:"UG",Country:"Uganda"},{CountryCode:"+380",CountryCodeISO:"UA",Country:"Ukraine"},{CountryCode:"+971",CountryCodeISO:"AE",Country:"United Arab Emirates"},{CountryCode:"+44",CountryCodeISO:"GB",Country:"United Kingdom"},{CountryCode:"+1",CountryCodeISO:"VI",Country:"U.S. Virgin Islands"},{CountryCode:"+598",CountryCodeISO:"UY",Country:"Uruguay"},{CountryCode:"+998",CountryCodeISO:"UZ",Country:"Uzbekistan"},{CountryCode:"+678",CountryCodeISO:"VU",Country:"Vanuatu"},{CountryCode:"+58",CountryCodeISO:"VE",Country:"Venezuela"},{CountryCode:"+84",CountryCodeISO:"VN",Country:"Vietnam"},{CountryCode:"+967",CountryCodeISO:"YE",Country:"Yemen"},{CountryCode:"+260",CountryCodeISO:"ZM",Country:"Zambia"},{CountryCode:"+263",CountryCodeISO:"ZW",Country:"Zimbabwe"},{CountryCode:"+262",CountryCodeISO:"YT",Country:"Mayotte"},{CountryCode:"+7",CountryCodeISO:"RU",Country:"Russian Federation"},{CountryCode:"+1",CountryCodeISO:"AI",Country:"Anguilla"},{CountryCode:"+1",CountryCodeISO:"AG",Country:"Antigua and Barbuda"},{CountryCode:"+1",CountryCodeISO:"BS",Country:"Bahamas"},{CountryCode:"+1",CountryCodeISO:"BB",Country:"Barbados"},{CountryCode:"+1",CountryCodeISO:"BM",Country:"Bermuda"},{CountryCode:"+1",CountryCodeISO:"VG",Country:"British Virgin Islands"},{CountryCode:"+1",CountryCodeISO:"KY",Country:"Cayman Islands"},{CountryCode:"+1",CountryCodeISO:"DM",Country:"Dominica"},{CountryCode:"+1",CountryCodeISO:"DO",Country:"Dominican Republic"},{CountryCode:"+1",CountryCodeISO:"GD",Country:"Grenada"},{CountryCode:"+1",CountryCodeISO:"GU",Country:"Guam"},{CountryCode:"+1",CountryCodeISO:"JM",Country:"Jamaica"},{CountryCode:"+1",CountryCodeISO:"MS",Country:"Montserrat"},{CountryCode:"+1",CountryCodeISO:"MP",Country:"Northern Marianas"},{CountryCode:"+1",CountryCodeISO:"PR",Country:"Puerto Rico"},{CountryCode:"+1",CountryCodeISO:"KN",Country:"Saint Kitts and Nevis"},{CountryCode:"+1",CountryCodeISO:"LC",Country:"Saint Lucia"},{CountryCode:"+1",CountryCodeISO:"VC",Country:"Saint Vincent and the Grenadines"},{CountryCode:"+1",CountryCodeISO:"TT",Country:"Trinidad and Tobago"},{CountryCode:"+1",CountryCodeISO:"TC",Country:"Turks and Caicos Islands"},{CountryCode:"+676",CountryCodeISO:"TO",Country:"Tonga"},{CountryCode:"+1",CountryCodeISO:"US",Country:"United States of America"},{CountryCode:"+970",CountryCodeISO:"PS",Country:"Palestine"},{CountryCode:"+211",CountryCodeISO:"SS",Country:"South Sudan"},{CountryCode:"+44",CountryCodeISO:"IM",Country:"Isle of Man"}];var _,p,m=r.path().split("/");"verified"==m[m.length-3]&&(_=m[m.length-1],p=m[m.length-2],_&&p&&n.Verify(_,p).then(function(e){e.success||alert("Sorry - your verification link seems to be incorrect.")})),"payment_setup_confirmation"==m[m.length-1].split("?")[0]&&(p=l.get("mid"),m=l.get("bid"),o.SetupGoCard({mid:p,bid:m,code:r.search().code}).then(function(e){e.success||alert("Sorry - we were unable to setup your connection to our payment provider GoCardless.")})),a.go_to_login=function(){s.go("login")},a.verify_mobile=function(e){4==u.text_verification.length&&t.VerifyPhone(u.text_verification,_).then(function(e){e.success?(a.verified_mobile=!0,a.link=e.link.url,l.put("mid",_),l.put("bid",e.bid)):(alert("Your verification code is incorrect..."),a.verified_mobile=!1)})},a.get_companies=function(e){2<e.length&&t.GetCompany(e).then(function(e){e.success&&(a.companies=e.items)})},a.prefix_length=0,a.prefix="",a.set_prefix=function(){},a.set_company=function(){t.GetCompanyDetail(u.selected_company.company_number).then(function(e){e.success&&function(e){u.officers=e.officer,u.company_details=e.company;for(var t=!1,n=a.formData.user.first_name.toLowerCase(),o=a.formData.user.last_name.toLowerCase(),i=0,r=0;r<u.officers.length;r++)-1<u.officers[r].name.toLowerCase().indexOf(n)&&-1<u.officers[r].name.toLowerCase().indexOf(o)&&(t=!0,i=r);t?(alert("We have matched you!"),a.formData.club={},a.formData.club.company_name=e.company.company_name,a.formData.club.trading_as=e.company.company_name,a.formData.club.title=e.company.company_name.replace("LTD","").replace("LIMITED","").replace("LLC",""),a.formData.club.company_number=e.company.company_number,a.formData.club.date_of_creation=e.company.date_of_creation,a.formData.club.address_line_1=e.company.registered_office_address.address_line_1,a.formData.club.address_line_2=e.company.registered_office_address.address_line_2,a.formData.club.city=e.company.registered_office_address.locality,a.formData.club.post_code=e.company.registered_office_address.postal_code,a.formData.user.dob_year=e.officer[i].date_of_birth.year,a.formData.user.dob_month=e.officer[i].date_of_birth.month,a.formData.user.role=e.officer[i].officer_role,a.formData.club.is_company=!0):alert("Unfortunately we cannot match your personal details with any of the company directors. Did you select the correct company from the drop-down list?")}(a.company=e)})},a.formData={club:{is_company:!0},user:{phone:""}},a.setup_direct_debit=function(){window.open(a.link)},a.checkValid=function(){if(console.log("CLICK"),a.formData.user.password!==a.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),alert("Your passwords do not match"),!1;var e=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!e.test(a.formData.user.password))return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),alert("Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1;if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),$("input:checkbox:not(:checked)").addClass("ng-checkbox-unchecked"),!1;if($("input:checkbox:not(:checked)").removeClass("ng-checkbox-unchecked"),!a.formData.user)return s.go("club_signup.my_profile"),!1;if(!u.selected_phone.CountryCode)return alert("Please select the country prefix of the mobile phone entered from the drop-down menu, this will ensure that the text messages we send will be sent to the correct telephone number."),!1;a.formData.user.phone;if(0==a.formData.user.phone.slice(0,1)&&(alert("Your telephone number seems to start with a 0, as we will be using your international phone number, the first zero will be stripped automatically."),a.formData.user.phone.phone=a.formData.user.phone.phone.substring(1)),!a.formData.club||!a.formData.club.title)return s.go("club_signup.my_club"),!1;if(!a.formData.tnc)return s.go("club_signup.terms"),!1;if(a.formData.user.password!=a.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1;e=$(".btn-info").attr("one-ui-sref");"club_signup.verify"==e?a.processForm():s.go(e)},a.processForm=function(){a.formData?(a.formData.user.phone=u.selected_phone.CountryCode+a.formData.user.phone,e.Create(a.formData).then(function(e){e.success?(s.go("club_signup.verify"),a.formData={}):$("#error_message").html(e.message)})):alert("Something went wrong...")},a.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");d.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",d.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){$log.info("saveBlob method failed with the following exception:"),$log.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){$log.info("Download link method with simulated click failed with the following exception:"),$log.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){$log.info("Download link method with window.location failed with the following exception:"),$log.info(e)}}}o||($log.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function CreateGalleryController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;_.gallery={is_protected:"false",download_low:"false",download_medium:"false",download_high:"false",gallery_link:"",fullscreen:"false"},u.GetAll().then(function(e){_.all_galleries=e}),_.images=d.data.selected_images,l.remove_image=function(t){_.images=$.grep(_.images,function(e){return e.id!=t.id}),d.SetSelectedImages(_.images)},l.check_link_unique=function(){for(var e=0;e<_.all_galleries.length;e++)if(_.all_galleries[e].link===_.gallery.link)return!1},l.generate_gallery=function(){for(var e=0;e<_.images.length;e++)_.images[e].organise=e;_.gallery.images=_.images,u.Create(_.gallery).then(function(e){r.path("/gallery/"+e.gallery_link)})}}function DashboardClubAirframeLogbookController(e,n,t,o,i,r,a,s,d,c,l,u,_,p,m){var f=this;switch(f.action){case"add":f.page_title="Add a New Plane";break;case"edit":n.GetByIdMaintenance2(a.plane_id,f.club_id).then(function(e){f.club.plane=e,f.this_plane_id=a.plane_id,f.club.plane&&f.club.plane.maintenance&&(f.obj.hours_remaining=f.club.plane.maintenance.hours_remaining,f.obj.next_check=new Date(f.club.plane.maintenance.next_maintenance),f.obj.check_date=new Date,f.obj.extension_granted=new Date),f.page_title="Edit a Plane Maintenance - "+f.club.plane.registration}),n.GetOpenIssues(a.plane_id).then(function(e){f.reported_defects=e})}function g(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}return o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},f.prop_no="",f.getAge=function(e){return(new Date).getFullYear()-e},n.GetAirframeLogs(a.plane_id,0,25).then(function(e){f.logs=e.logs,f.plane=e.plane}),f.current_offset=0,f.loaded_per_batch=25,f.all_loaded=!1,f.load_more=function(){f.current_offset=f.current_offset+f.loaded_per_batch,n.GetAirframeLogs(a.plane_id,f.current_offset,f.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return f.logs.push(e)}):f.all_loaded=!0,f.plane=e.plane})},f.update_logbooks=function(){n.UpdateAircraftLogbooks(a.plane_id).then(function(e){e.success&&n.GetAirframeLogs(a.plane_id,0,25).then(function(e){f.logs=e.logs,f.plane=e.plane})})},f.get_initial=function(e){return e.charAt(0)},f.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},i.update_this_file=function(e){-1===update_this_file.indexOf(e.id)&&update_this_file.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(f.user_id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){JSON.parse(e.file_return)},f.files={radio:[],cert:[],insurance:[]},i.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,f.files[t].push(e[n].file)}},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,f.files[t].push(e[0])},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},f.defect_severity,f.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)},i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return warning_msg}}}).result.then(function(e){var t=e.id;d.info("PRESSED GO: ",t),n.Delete(t).then(function(){f.club.planes=$.grep(f.club.planes,function(e){return e.id!=t})})},function(){d.info("Modal dismissed at: "+new Date)})},i.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){g(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){g(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},i.search2=function(e){return!i.my_search2||""==i.my_search2||!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(i.my_search2,e.entry_date)},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},i.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n}}function DashboardClubCourseController(e,t,n,o,i,r,a,s,c,l){var d=this;d.charge_type=["brakes","session","plane","brakes_rounded"],d.user=null,d.allUsers=[],d.club={course:{}},d.page_title="",d.course_document={},d.course_documents=[];var u=[];switch(d.action=i.current.data.action,d.user=t.globals.currentUser,d.club_id=t.globals.currentUser.current_club_admin.id,d.user_id=d.user.id,d.course_certificate={},d.course_noise={},d.course_radio={},d.course_maintenance={},d.course_insurance={},d.club.lessons=[],d.exams=[],d.tags=[],d.instructor_charges=[],d.editing=!1,d.edit_course=!1,d.action){case"add":d.page_title="Add a New Course";break;case"edit":d.editing=!0,d.edit_course=!0,l.GetCourseById(r.course_id).then(function(e){d.club.course=e.item,d.page_title="Edit a Course - "+d.club.course.title}),l.GetLessonsByCourseId(r.course_id).then(function(e){d.club.lessons=e.items}),_(),p(),m();break;case"list":l.GetCoursesByClubId(d.club_id).then(function(e){d.club.courses=e.items})}function _(){l.GetExamsByCourseId(r.course_id).then(function(e){d.exams=e.items})}function p(){l.GetTagsByCourseId(r.course_id).then(function(e){d.tags=e.items})}function m(){l.GetChargesByCourseId(r.course_id).then(function(e){d.instructor_charges=e.items})}function f(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}o.back=function(){c.history.back()},o.save=function(){"add"==d.action?o.create():o.update()},o.save_lesson_order=function(){for(var e=[],t=0;t<d.club.lessons.length;t++){var n={id:d.club.lessons[t].id,organise:t};e.push(n)}l.UpdateLessonOrder({order:e}).then(function(e){})},d.delete_lesson=function(e,t){confirm("Are you sure you wish to delete this lesson? This is irreversible.")&&l.DeleteLesson(e).then(function(e){e.success?d.club.lessons.splice(t,1):alert("An error occurred...")})},d.update_exam=function(e,t){delete e.edit_me,l.UpdateExam(e).then(function(e){e.success?d.exams[t].edit_me=!1:alert("An error occurred...")})},d.update_cancel=function(e){_()},d.edit_exam=function(e){d.exams[e].edit_me=!0},d.delete_exam=function(e,t){confirm("Are you sure you wish to delete this exam? This is irreversible.")&&l.DeleteExam(e.id).then(function(e){e.success?d.exams.splice(t,1):alert("An error occurred...")})},d.add_exam=function(){d.new_exam.course_id=r.course_id,d.new_exam.club_id=d.club_id,l.CreateExam(d.new_exam).then(function(e){e.success?(d.exams.push(e.item),d.new_exam={title:"",description:""}):alert("An error occurred...")})},d.update_tag=function(e,t){alert("This tag being removed will not remove the tag from previous flights where this tag was already applied."),delete e.edit_me,l.UpdateTags(e).then(function(e){e.success?d.tags[t].edit_me=!1:alert("An error occurred...")})},d.update_cancel_tag=function(e){p()},d.edit_tag=function(e){d.tags[e].edit_me=!0},d.delete_tag=function(e,t){confirm("Are you sure you wish to delete this tag? If this tag has already been assigned to particular flight(s) this will not remove these from existing flights.")&&l.DeleteTags(e.id).then(function(e){e.success?d.tags.splice(t,1):alert("An error occurred...")})},d.add_tag=function(){d.new_tag.course_id=r.course_id,d.new_tag.club_id=d.club_id,l.CreateTags(d.new_tag).then(function(e){e.success?(d.tags.push(e.item),d.new_tag={title:""}):alert("An error occurred...")})},d.update_charge=function(e,t){delete e.edit_me,l.UpdateCharge(e).then(function(e){e.success?d.instructor_charges[t].edit_me=!1:alert("An error occurred...")})},d.update_cancel_charge=function(e){m()},d.edit_charge=function(e){d.instructor_charges[e].edit_me=!0},d.delete_charge=function(e,t){confirm("Are you sure you wish to delete this instructor charge? This is irreversible.")&&l.DeleteCharge(e.id).then(function(e){e.success?d.instructor_charges.splice(t,1):alert("An error occurred...")})},d.add_charge=function(){d.new_charge.course_id=r.course_id,d.new_charge.club_id=d.club_id,l.CreateCharge(d.new_charge).then(function(e){e.success?(d.instructor_charges.push(e.item),d.new_charge={title:"",charge_type:"",price:""}):alert("An error occurred...")})},d.delete_course=function(e,t){confirm("Are you sure you wish to delete this course? This is irreversible.")&&l.DeleteCourse(e).then(function(e){e.success?d.club.courses.splice(t,1):alert("An error occurred...")})},o.create=function(){d.club.course.club_id=d.club_id,l.CreateCourse(d.club.course).then(function(e){e.success&&i.go("dashboard.manage_club.edit_course",{course_id:e.id,reload:!0})})},o.delete=function(){alert("Are you sure you would like to delete this course?"),l.DeleteCourse(d.club.course.id).then(function(e){})},o.update=function(){l.UpdateCourse(d.club.course).then(function(e){i.go("dashboard.manage_club.courses")})},o.add_item=function(e){switch(e){case"licence":var t;d.temporary.licence&&""!==d.temporary.licence&&d.temporary.rating&&""!==d.temporary.rating?(0==f(t={licence_id:d.temporary.licence.id,licence_title:d.temporary.licence.abbreviation,rating_title:d.temporary.rating.abbreviation,rating_id:d.temporary.rating.id},d.club.course.requirements.licence,new Array("licence_id","rating_id"))&&d.club.course.requirements.licence.push(t),delete d.temporary.licence,delete d.temporary.rating):alert("Please select a licence and rating that is required to book the course solo!");break;case"medical":d.temporary.medical_authority&&""!==d.temporary.medical_authority&&d.temporary.medical_component&&""!==d.temporary.medical_component?(0==f(n={authority_id:d.temporary.medical_authority.id,authority_title:d.temporary.medical_authority.abbreviation,medical_component_id:d.temporary.medical_component.id,medical_component_title:d.temporary.medical_component.title},d.club.course.requirements.medical,new Array("authority_id","medical_component_id"))&&d.club.course.requirements.medical.push(n),delete d.temporary.medical_authority,delete d.temporary.medical_component):alert("Please select a medical that is required to book the course solo!");break;case"differences":var n;d.temporary.difference&&""!==d.temporary.difference?(0==f(n={difference_id:d.temporary.difference.id,difference_title:d.temporary.difference.title},d.club.course.requirements.differences,new Array("difference_id","difference_title"))&&d.club.course.requirements.differences.push(n),delete d.temporary.difference):alert("Please select a difference that is required to book the course solo!")}},o.update_this_file=function(e){-1===u.indexOf(e.id)&&u.push(e.id)},o.remove_real_file=function(t){d.club.course.course_documents=$.grep(d.club.course.course_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(d.user_id,t.id).then(function(e){e.success&&(d.course_documents=[],o.processFiles(current_files))})},d.files={radio:[],cert:[],insurance:[],noise:[]},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,d.files[t].push(e[0].file)},o.set_title=function(e){return e.save_name},o.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(d.course_documents=[],o.processFiles(t))})},o.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,d.course_documents.push(e[t].file)}},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function DashboardClubEngineLogbookController(e,n,t,o,i,r,a,s,d,c,l,u,_,p,m){var f=this;switch(f.action){case"add":f.page_title="Add a New Plane";break;case"edit":n.GetByIdMaintenance2(a.plane_id,f.club_id).then(function(e){f.club.plane=e,f.this_plane_id=a.plane_id,f.club.plane&&f.club.plane.maintenance&&(f.obj.hours_remaining=f.club.plane.maintenance.hours_remaining,f.obj.next_check=new Date(f.club.plane.maintenance.next_maintenance),f.obj.check_date=new Date,f.obj.extension_granted=new Date),f.page_title="Edit a Plane Maintenance - "+f.club.plane.registration}),n.GetOpenIssues(a.plane_id).then(function(e){f.reported_defects=e})}function g(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}return o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},n.GetEngineLogs(a.engine_id,a.plane_id,0,25).then(function(e){f.logs=e.logs,f.engine=e.engine}),f.current_offset=0,f.loaded_per_batch=25,f.all_loaded=!1,f.load_more=function(){f.current_offset=f.current_offset+f.loaded_per_batch,n.GetEngineLogs(a.engine_id,a.plane_id,f.current_offset,f.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return f.logs.push(e)}):f.all_loaded=!0,f.engine=e.engine})},f.get_initial=function(e){return e.charAt(0)},f.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},f.update_logbooks=function(){n.UpdateAircraftLogbooks(a.plane_id).then(function(e){e.success&&n.GetEngineLogs(a.engine_id,a.plane_id,0,25).then(function(e){f.logs=e.logs,f.engine=e.engine,alert("The logbook has been re-checked")})})},i.update_this_file=function(e){-1===update_this_file.indexOf(e.id)&&update_this_file.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(f.user_id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){JSON.parse(e.file_return)},f.files={radio:[],cert:[],insurance:[]},i.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,f.files[t].push(e[n].file)}},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,f.files[t].push(e[0])},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},f.defect_severity,f.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)},i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return warning_msg}}}).result.then(function(e){var t=e.id;d.info("PRESSED GO: ",t),n.Delete(t).then(function(){f.club.planes=$.grep(f.club.planes,function(e){return e.id!=t})})},function(){d.info("Modal dismissed at: "+new Date)})},i.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){g(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){g(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},i.search2=function(e){return!i.my_search2||""==i.my_search2||!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(i.my_search2,e.entry_date)},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},i.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n}}function DashboardClubExperienceDiscountsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={item:{}},m.page_title="",m.plane_document={},m.plane_documents=[];var f=[];switch(m.action=r.current.data.action,m.club_id=n.globals.currentUser.current_club_admin.id,m.user=n.globals.currentUser,m.user_id=m.user.id,m.charge_type=["brakes","session","plane"],m.planes=[],p.GetByClubId(m.club_id).then(function(e){m.experiences=e.items}),m.action){case"add":m.page_title="Add an Experience";break;case"edit":p.GetById(a.id).then(function(e){m.club.item=e.item});break;case"list":p.GetDiscountsByClubId(m.club_id).then(function(e){m.club.items=e.items})}i.check_code=function(){},i.back=function(){l.history.back()},i.save=function(){"add"==m.action?i.create():i.update()},i.create=function(){m.club.item.experience_id=m.club.item.experience.id,delete m.club.item.experience,m.club.item.club_id=m.club_id,p.CreateDiscount(m.club.item).then(function(e){r.go("dashboard.manage_club.experience_discounts",{},{reload:!0})})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),p.DeleteDiscount(m.user.id,m.club.item).then(function(e){})},i.update=function(){m.club.item.club_id=m.club_id,p.UpdateDiscount(m.club.item,m.user.id).then(function(e){r.go("dashboard.manage_club.experience_discounts",{},{reload:!0})})},i.add_item=function(e){"plane"===e&&(m.temporary.plane&&""!==m.temporary.plane?(m.club.item.planes||(m.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(m.temporary.plane,m.club.item.planes,new Array("plane_id"))&&m.club.item.planes.push(m.temporary.plane),delete m.temporary.plane):alert("Please select a plane that this activity be done on!"))},i.remove_item=function(e,t){m.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===f.indexOf(e.id)&&f.push(e.id)},i.remove_real_file=function(t){m.club.plane.plane_documents=$.grep(m.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(m.user.id,t.id).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,m.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){m.plane_documents=$.grep(m.plane_documents,function(e){return e.temp_path!=t.temp_path}),m.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(m.user.id,t.id).then(function(){m.club.items=$.grep(m.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubExperiencesController(e,t,n,o,i,r,a,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={item:{planes:[]}},m.page_title="",m.plane_document={},m.plane_documents=[];var f=[];switch(m.action=r.current.data.action,m.club_id=n.globals.currentUser.current_club_admin.id,m.user=n.globals.currentUser,m.user_id=m.user.id,m.charge_type=["brakes","session","plane"],m.planes=[],m.club.item.planes=[],m.temporary={},m.temporary.plane={},t.GetAllByClub(m.club_id).then(function(e){m.planes=e}),m.action){case"add":m.page_title="Add an Experience";break;case"edit":p.GetById(a.id).then(function(e){m.club.item=e.item});break;case"list":p.GetByClubId(m.club_id).then(function(e){m.club.items=e.items})}i.back=function(){l.history.back()},i.save=function(){"add"==m.action?i.create():i.update()},i.create=function(){m.club.item.club_id=m.club_id,p.Create(m.club.item).then(function(e){r.go("dashboard.manage_club.experiences",{},{reload:!0})})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),p.Delete(m.user.id,m.club.item).then(function(e){})},i.update=function(){m.club.item.club_id=m.club_id,p.Update(m.club.item,m.user.id).then(function(e){r.go("dashboard.manage_club.experiences",{},{reload:!0})})},i.add_item=function(e){"plane"===e&&(m.temporary.plane&&""!==m.temporary.plane?(m.club.item.planes||(m.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(m.temporary.plane,m.club.item.planes,new Array("plane_id"))&&m.club.item.planes.push(m.temporary.plane),delete m.temporary.plane):alert("Please select a plane that this activity be done on!"))},i.remove_item=function(e,t){m.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===f.indexOf(e.id)&&f.push(e.id)},i.remove_real_file=function(t){m.club.plane.plane_documents=$.grep(m.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(m.user.id,t.id).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,m.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){m.plane_documents=$.grep(m.plane_documents,function(e){return e.temp_path!=t.temp_path}),m.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(m.user.id,t.id).then(function(){m.club.items=$.grep(m.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubFlightsController(e,r,t,n,o,a,i,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},m.show_loading=!1,m.page_title="",m.plane_document={},m.plane_documents=[];var f=[];switch(m.currency_types=["class","type"],m.gear_types=["tricycle","tailwheel","monowheel","floats","amphibian","skis"],m.certificates=[{id:1,title:"Certificate of Airworthiness",value:"cofa"},{id:2,title:"National Certificate of Airworthiness",value:"cofa"},{id:2,title:"LAA Permit to Fly",value:"ptf"}],m.classes=["SEP (land)","SEP (sea)","SET (land)","SET (sea)","MEP (land)","MEP (sea)","ME"],m.charge_type=["airborne","brakes","tacho","hobbs","flight","brakes_rounded"],m.surcharge_type=["none","flight","hour"],m.action=a.current.data.action,m.user=t.globals.currentUser,m.club_id=t.globals.currentUser.current_club_admin.id,m.user_id=m.user.id,m.to_date=new Date,m.from_date=new Date,m.aircraft="",m.from_date.setMonth(m.from_date.getMonth()-1),m.show_loading=!0,r.GetAllFlightsByClub(m.club_id,m.from_date,m.to_date,m.selected_aircraft).then(function(e){m.flights=e.flights,m.totals=e.totals,m.aircraft=e.aircraft,m.show_loading=!1}),m.editing=!1,m.action){case"add":m.page_title="Add a New Plane";break;case"edit":m.editing=!0,r.GetById(i.plane_id,m.club_id).then(function(e){m.club.plane=e,console.log(m.club.plane),m.club.plane.airframe_hours=parseFloat(m.club.plane.airframe_hours),m.club.plane.vp=1==m.club.plane.vp,m.club.plane.rg=1==m.club.plane.rg,m.club.plane.tb=1==m.club.plane.tb,m.plane_engine_1=m.club.plane.engine_1,m.plane_engine_2=m.club.plane.engine_2,m.plane_propeller_1=m.club.plane.propeller_1,m.plane_propeller_2=m.club.plane.propeller_2,m.page_title="Edit a Plane - "+m.club.plane.registration});break;case"list":r.GetAllByClub(m.club_id).then(function(e){m.club.planes=e})}function g(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}o.back=function(){l.history.back()},o.my_search="",o.search=function(e){if(""==o.my_search)return!0;return!(!e||!e.aircraft||-1===angular.lowercase(e.aircraft.registration).indexOf(angular.lowercase(o.my_search)||""))||(!(!e||!e.flight_date||-1===angular.lowercase(e.flight_date.toString()).indexOf(angular.lowercase(o.my_search)||""))||(!!(e&&e.from_airport&&e.from_airport.code&&-1!==angular.lowercase(e.from_airport.code).indexOf(angular.lowercase(o.my_search)||""))||(!!(e&&e.from_airport&&e.from_airport.title&&-1!==angular.lowercase(e.from_airport.title).indexOf(angular.lowercase(o.my_search)||""))||(!!(e&&e.to_airport&&e.to_airport.code&&-1!==angular.lowercase(e.to_airport.code).indexOf(angular.lowercase(o.my_search)||""))||!!(e&&e.to_airport&&e.to_airport.title&&-1!==angular.lowercase(e.to_airport.title).indexOf(angular.lowercase(o.my_search)||""))))))},o.set_aircraft_details=function(){r.GetAddAircraft(m.plane_search.registration).then(function(e){e?0==e.length||(m.plane_search=e,function(){m.club.plane.manufacturer=m.plane_search.manufacturer,m.club.plane.serial_no=m.plane_search.serial_number,m.club.plane.plane_type=m.plane_search.icao_type,m.club.plane.type_name=m.plane_search.type_name,m.club.plane.year_built=m.plane_search.year_built,m.club.plane.aircraft_id=m.plane_search.id,m.club.plane.mtow=parseInt(m.plane_search.mtow),m.club.plane.airframe_hours=m.plane_search.airframe_hours,m.plane_search.noise_level&&(m.plane_noise.noise_level=m.plane_search.noise_level.match(/[+-]?\d+(\.\d+)?/g).map(function(e){return parseFloat(e)}));m.plane_noise.noise_cert_issue=m.plane_search.noise_cert_issue?new Date(m.plane_search.noise_cert_issue):"",-1<m.plane_search.aircraft_class.indexOf("FIXED-WING")&&(0<m.plane_search.is_propeller&&-1==m.plane_search.engine_name.indexOf("PT6A-")?m.club.plane.plane_class=1<m.club.plane.number_of_engines?"MEP":"SEP":m.club.plane.plane_class=1<m.club.plane.number_of_engines?"ME":"SET",-1<m.plane_search.aircraft_class.indexOf("LANDPLANE")&&(m.club.plane.plane_class=m.club.plane.plane_class+" (land)",m.club.plane.gear_type=""),(-1<m.plane_search.aircraft_class.indexOf("AMPHIBIAN")||-1<m.plane_search.aircraft_class.indexOf("FLOAT"))&&(m.club.plane.plane_class=m.club.plane.plane_class+" (sea)",m.club.plane.gear_type=-1<m.plane_search.aircraft_class.indexOf("AMPHIBIAN")?"amphibian":"floats"));m.club.plane.seats=parseInt(m.plane_search.seats)+1,m.plane_maintenance.cofa_category=-1<m.plane_search.cofa_category.indexOf("cofa")?"Certificate of Airworthiness":"Permit to Fly",m.plane_maintenance.certificate_expiry=new Date(m.plane_search.cofa_expiry),m.club.plane.cofa_category=m.plane_maintenance.cofa_category,m.club.plane.gear_type=m.plane_search.gear_type,m.plane_engine_1.make=m.plane_search.engine_name,m.plane_engine_1.model=m.plane_search.engine_name,m.plane_propeller_1.make=m.plane_search.propeller_manufacturer,m.plane_propeller_1.model=m.plane_search.propeller_name,1<m.plane_search.number_of_engines&&(m.number_of_engine=m.plane_search.number_of_engines,m.plane_engine_2.make=m.plane_search.engine_name,m.plane_engine_2.model=m.plane_search.engine_name,m.plane_propeller_2.make=m.plane_search.propeller_manufacturer,m.plane_propeller_2.model=m.plane_search.propeller_name)}()):console.log("WOOOPSIES... this aircraft isn't in our database?")})},o.save=function(){"add"==m.action?o.create():o.update()},m.update_ac=function(){},m.search_for_flights=function(){m.show_loading=!0;var e=0;m.selected_aircraft&&m.selected_aircraft.plane_id&&(e=m.selected_aircraft.plane_id),r.GetAllFlightsByClub(m.club_id,m.from_date,m.to_date,e).then(function(e){m.flights=e.flights,m.totals=e.totals,m.aircraft=e.aircraft,m.show_loading=!1})},m.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},o.create=function(){return m.club.plane.club_id=m.club_id,m.club.plane.add_documents=m.plane_documents,m.club.plane.registration=m.plane_search.registration,m.club.maintenance_type=m.plane_maintenance.cofa_category.value,console.log("vm.plane_maintenance.cofa_category ",m.club.maintenance_type),!1},o.delete=function(){alert("Are you sure you would like to delete this plane?"),r.Update(m.club.plane).then(function(e){})},o.update=function(){m.club.plane.club_id=m.club_id,m.club.plane.add_documents=m.plane_documents,m.club.plane.update_documents=function(){for(var e=[],t=0;t<f.length;t++)for(var n=f[t],o=0;o<m.club.plane.plane_documents.length;o++)m.club.plane.plane_documents[o].id==n&&e.push(m.club.plane.plane_documents[o]);return e}(),r.Update(m.club.plane).then(function(e){a.go("dashboard.manage_club.planes")})},m.save_new_aircraft_bit=function(e,t){var n="plane_"+e+"_"+t,o="plane_"+e+"_"+t+"_replace",i={},i=m[n]&&""!==m[n]?(m[n].removed_date=m[o].removed_date,delete m[o].removed_date,{old_item:m[n],new_item:m[o],plane_id:m.club.plane.id,item:e,no:t}):{old_item:{},new_item:m[o],plane_id:m.club.plane.id,item:e,no:t};console.log("LETS SEE WHAT WOULD BE SENT",i),r.UpdateAircraftBit(i).then(function(e){console.log(e),a.go("dashboard.manage_club.planes")})},o.add_item=function(e){switch(e){case"licence":var t;m.temporary.licence&&""!==m.temporary.licence&&m.temporary.rating&&""!==m.temporary.rating?(0==g(t={licence_id:m.temporary.licence.id,licence_title:m.temporary.licence.abbreviation,rating_title:m.temporary.rating.abbreviation,rating_id:m.temporary.rating.id},m.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&m.club.plane.requirements.licence.push(t),delete m.temporary.licence,delete m.temporary.rating):alert("Please select a licence and rating that is required to book the plane solo!");break;case"medical":m.temporary.medical_authority&&""!==m.temporary.medical_authority&&m.temporary.medical_component&&""!==m.temporary.medical_component?(0==g(n={authority_id:m.temporary.medical_authority.id,authority_title:m.temporary.medical_authority.abbreviation,medical_component_id:m.temporary.medical_component.id,medical_component_title:m.temporary.medical_component.title},m.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&m.club.plane.requirements.medical.push(n),delete m.temporary.medical_authority,delete m.temporary.medical_component):alert("Please select a medical that is required to book the plane solo!");break;case"differences":var n;m.temporary.difference&&""!==m.temporary.difference?(0==g(n={difference_id:m.temporary.difference.id,difference_title:m.temporary.difference.title},m.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&m.club.plane.requirements.differences.push(n),delete m.temporary.difference):alert("Please select a difference that is required to book the plane solo!")}},o.remove_item=function(e,t){m.club.plane.requirements[e].splice(t,1)},o.update_this_file=function(e){-1===f.indexOf(e.id)&&f.push(e.id)},o.remove_real_file=function(t){m.club.plane.plane_documents=$.grep(m.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(m.user_id,t.id).then(function(e){e.success&&(m.plane_documents=[],o.processFiles(current_files))})},m.files={radio:[],cert:[],insurance:[],noise:[]},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,m.files[t].push(e[0].file)},o.set_title=function(e){return e.save_name},o.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(m.plane_documents=[],o.processFiles(t))})},o.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,m.plane_documents.push(e[t].file)}},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},o.save_plane_documents=function(){},o.change_file_name=function(t){m.plane_documents=$.grep(m.plane_documents,function(e){return e.temp_path!=t.temp_path}),m.plane_documents.push(t)};o.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;c.info("PRESSED GO: ",t),r.Delete(t).then(function(){m.club.planes=$.grep(m.club.planes,function(e){return e.id!=t})})},function(){c.info("Modal dismissed at: "+new Date)})},m.aircraft,m.plane_search,m.plane_to_add,o.get_aircraft=function(t){3<t.length&&r.GetAddAircraft(t).then(function(e){!e||0==e.length?m.aircraft=[{icao_type:"not known",registration:t.toUpperCase()}]:m.aircraft=e})}}function DashboardClubFlyingController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v){var k=this;switch(k.user=null,k.allUsers=[],k.club={},k.page_title="",k.club.member={},k.club.member.payment_now=!0,k.imported_new_headers=[],k.test="Package valid until 12/03/2022<br /> To be used on:<br /> G-BOOF <br /> G-OARU",k.action=s.current.data.action,k.club_id=i.globals.currentUser.current_club_admin.id,k.user=i.globals.currentUser,k.user_id=k.user.id,k.no_show_cols=["membership_start","membership_id","selected"],a.sortType="Email",a.sortReverse=!1,a.searchTool="",a.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},k.action){case"add":k.page_title="Add a New member",n.GetAllByClub(k.club_id).then(function(e){k.club.memberships=e});break;case"edit":break;case"list":o.GetIncompleteClub(k.club_id).then(function(e){k.club.flights=e.bookouts}),k.get_pax_html=function(e){for(var t="",n=0;n<e.passengers.length;n++){var o="";if(0<e.passengers[n].nok.length)for(var i=0;i<e.passengers[n].nok.length;i++)o=o+"<br /><br />Emergency Contact ("+(i+1)+"): <br />"+e.passengers[n].nok[i].first_name+" "+e.passengers[n].nok[i].last_name+" <br />relationship: "+e.passengers[n].nok[i].relationship+"<br />t: "+e.passengers[n].nok[i].phone_number+" <br /> e: "+e.passengers[n].nok[i].email_address+"<br />";t=t+"<span class='bolder'><b>"+e.passengers[n].first_name+" "+e.passengers[n].last_name+"</b></span><br />e: "+e.passengers[n].email+"<br />t: "+(e.passengers[n].telephone_number||"unknown")+o+"  <br /> <br />"}if(e.passengers.length,0<e.instructor_id){var r="";if(0<e.booking.instructor_nok.noks.length)for(i=0;i<e.booking.instructor_nok.noks.length;i++)r=r+"<br />Emergency Contact ("+(i+1)+"): <br />"+e.booking.instructor_nok.noks[i].first_name+" "+e.booking.instructor_nok.noks[i].last_name+" <br />relationship: "+e.booking.instructor_nok.noks[i].relationship+"<br />t: "+e.booking.instructor_nok.noks[i].phone_number+" <br /> e: "+e.booking.instructor_nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Instructor Present</span> <br /> "+e.booking.instructor.first_name+" "+e.booking.instructor.last_name+" <br /> "+r}if(0<e.user_id){var a="";if(0<e.booking.user_nok.noks.length)for(i=0;i<e.booking.user_nok.noks.length;i++)a=a+"<br />Emergency Contact ("+(i+1)+"): <br />"+e.booking.user_nok.noks[i].first_name+" "+e.booking.user_nok.noks[i].last_name+" <br />relationship: "+e.booking.user_nok.noks[i].relationship+"<br />t: "+e.booking.user_nok.noks[i].phone_number+" <br /> e: "+e.booking.user_nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Member Present</span><br />"+e.booking.user.first_name+" "+e.booking.user.last_name+" <br />"+a}return t}}a.back=function(){u.history.back()},k.load_adsb=function(e){window.open("https://globe.adsbexchange.com/?icao="+e,"_blank","")},k.cancel_bookout=function(e){confirm("Please confirm you wish to cancel the bookout.")&&v.CancelBookout(e).then(function(e){e.success?o.GetIncompleteClub(k.club_id).then(function(e){k.club.flights=e.bookouts}):alert(e.message)})}}function DashboardClubInstructorBookings(e,r,t,n,o,a,i,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},m.page_title="",m.plane_document={},m.plane_documents=[];var f=[];function g(e){var t=e.substring(e.indexOf("(")).split(","),n=parseInt(b(t[0].substring(1)),10),e=parseInt(b(t[1]),10),t=parseInt(b(t[2]),10),o=[n.toString(16),e.toString(16),t.toString(16)];return o.forEach(function(e,t){1===e.length&&(o[t]="0"+e)}),"#"+o.join("")}function b(e){return e.replace(/^\s+|\s+$/gm,"")}function h(e,t){t=1<arguments.length&&void 0!==t?t:1;return"rgba("+parseInt(e.substring(1,3),16)+", "+parseInt(e.substring(3,5),16)+", "+parseInt(e.substring(5),16)+", "+t+")"}function y(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}m.currency_types=["class","type"],m.gear_types=["tricycle","tailwheel","monowheel","floats","amphibian","skis"],m.certificates=[{id:1,title:"Certificate of Airworthiness",value:"cofa"},{id:2,title:"National Certificate of Airworthiness",value:"cofa"},{id:2,title:"LAA Permit to Fly",value:"ptf"}],m.classes=["SEP (land)","SEP (sea)","SET (land)","SET (sea)","MEP (land)","MEP (sea)","ME"],m.charge_type=["airborne","brakes","tacho","hobbs","flight","brakes_rounded"],m.surcharge_type=["none","flight","hour"],m.action=a.current.data.action,m.user=t.globals.currentUser,m.club_id=t.globals.currentUser.current_club_admin.id,m.user_id=m.user.id,m.editing=!1,"list"===m.action&&p.GetAllByClub(m.club_id,m.user_id).then(function(e){m.club.instructors=e.instructors,m.edit_instructor()}),o.back=function(){l.history.back()},m.save_instructor=function(e){console.log(e.new_colour),e.new_colour&&""!==e.new_colour&&(e.instructor_colour=h(e.new_colour,1),delete e.new_colour),console.log(e.new_booking_colour),e.new_booking_colour&&""!==e.new_booking_colour&&(e.booking_colour=h(e.new_booking_colour,1),delete e.new_booking_colour),console.log("SAVE THIS : ",e),e.edit=!1,delete e.edit,p.UpdateInstructor(e,m.club_id).then(function(e){})},m.edit_instructor=function(){for(var e=0;e<m.club.instructors.length;e++)m.club.instructors[e].instructor_colour&&""!==m.club.instructors[e].instructor_colour&&(m.club.instructors[e].new_colour=g(m.club.instructors[e].instructor_colour)),m.club.instructors[e].booking_colour&&""!==m.club.instructors[e].booking_colour&&(m.club.instructors[e].new_booking_colour=g(m.club.instructors[e].booking_colour))},o.save_instructor_order=function(){for(var e=[],t=0;t<m.club.instructors.length;t++){var n={id:m.club.instructors[t].id,display_order:t};e.push(n)}p.UpdateOrder({order:e},m.club_id).then(function(e){console.log(e)})},o.set_aircraft_details=function(){r.GetAddAircraft(m.plane_search.registration).then(function(e){e?0==e.length||(m.plane_search=e,function(){m.club.plane.manufacturer=m.plane_search.manufacturer,m.club.plane.serial_no=m.plane_search.serial_number,m.club.plane.plane_type=m.plane_search.icao_type,m.club.plane.type_name=m.plane_search.type_name,m.club.plane.year_built=m.plane_search.year_built,m.club.plane.aircraft_id=m.plane_search.id,m.club.plane.mtow=parseInt(m.plane_search.mtow),m.club.plane.airframe_hours=m.plane_search.airframe_hours,m.plane_search.noise_level&&(m.plane_noise.noise_level=m.plane_search.noise_level.match(/[+-]?\d+(\.\d+)?/g).map(function(e){return parseFloat(e)}));m.plane_noise.noise_cert_issue=m.plane_search.noise_cert_issue?new Date(m.plane_search.noise_cert_issue):"",-1<m.plane_search.aircraft_class.indexOf("FIXED-WING")&&(0<m.plane_search.is_propeller&&-1==m.plane_search.engine_name.indexOf("PT6A-")?m.club.plane.plane_class=1<m.club.plane.number_of_engines?"MEP":"SEP":m.club.plane.plane_class=1<m.club.plane.number_of_engines?"ME":"SET",-1<m.plane_search.aircraft_class.indexOf("LANDPLANE")&&(m.club.plane.plane_class=m.club.plane.plane_class+" (land)",m.club.plane.gear_type=""),(-1<m.plane_search.aircraft_class.indexOf("AMPHIBIAN")||-1<m.plane_search.aircraft_class.indexOf("FLOAT"))&&(m.club.plane.plane_class=m.club.plane.plane_class+" (sea)",m.club.plane.gear_type=-1<m.plane_search.aircraft_class.indexOf("AMPHIBIAN")?"amphibian":"floats"));m.club.plane.seats=parseInt(m.plane_search.seats)+1,m.plane_maintenance.cofa_category=-1<m.plane_search.cofa_category.indexOf("cofa")?"Certificate of Airworthiness":"Permit to Fly",m.plane_maintenance.certificate_expiry=new Date(m.plane_search.cofa_expiry),m.club.plane.cofa_category=m.plane_maintenance.cofa_category,m.club.plane.gear_type=m.plane_search.gear_type,m.plane_engine_1.make=m.plane_search.engine_name,m.plane_engine_1.model=m.plane_search.engine_name,m.plane_propeller_1.make=m.plane_search.propeller_manufacturer,m.plane_propeller_1.model=m.plane_search.propeller_name,1<m.plane_search.number_of_engines&&(m.number_of_engine=m.plane_search.number_of_engines,m.plane_engine_2.make=m.plane_search.engine_name,m.plane_engine_2.model=m.plane_search.engine_name,m.plane_propeller_2.make=m.plane_search.propeller_manufacturer,m.plane_propeller_2.model=m.plane_search.propeller_name)}()):console.log("WOOOPSIES... this aircraft isn't in our database?")})},o.save=function(){"add"==m.action?o.create():o.update()},m.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},o.create=function(){return m.club.plane.club_id=m.club_id,m.club.plane.add_documents=m.plane_documents,m.club.plane.registration=m.plane_search.registration,m.club.maintenance_type=m.plane_maintenance.cofa_category.value,console.log("vm.plane_maintenance.cofa_category ",m.club.maintenance_type),!1},o.delete=function(){alert("Are you sure you would like to delete this plane?"),r.Update(m.club.plane).then(function(e){})},o.update=function(){m.club.plane.club_id=m.club_id,m.club.plane.add_documents=m.plane_documents,m.club.plane.update_documents=function(){for(var e=[],t=0;t<f.length;t++)for(var n=f[t],o=0;o<m.club.plane.plane_documents.length;o++)m.club.plane.plane_documents[o].id==n&&e.push(m.club.plane.plane_documents[o]);return e}(),m.club.plane.colour&&""!==m.club.plane.colour&&-1==m.club.plane.colour.indexOf("rgba")&&(m.club.plane.colour=h(m.club.plane.colour,.75)),m.club.plane.bg_colour&&""!==m.club.plane.bg_colour&&-1==m.club.plane.bg_colour.indexOf("rgba")&&(m.club.plane.bg_colour=h(m.club.plane.bg_colour,.25)),r.Update(m.club.plane).then(function(e){a.go("dashboard.manage_club.planes")})},m.save_new_aircraft_bit=function(e,t){var n="plane_"+e+"_"+t,o="plane_"+e+"_"+t+"_replace",i={},i=m[n]&&""!==m[n]?(m[n].removed_date=m[o].removed_date,delete m[o].removed_date,{old_item:m[n],new_item:m[o],plane_id:m.club.plane.id,item:e,no:t}):{old_item:{},new_item:m[o],plane_id:m.club.plane.id,item:e,no:t};console.log("LETS SEE WHAT WOULD BE SENT",i),r.UpdateAircraftBit(i).then(function(e){console.log(e),a.go("dashboard.manage_club.planes")})},o.add_item=function(e){switch(e){case"licence":var t;m.temporary.licence&&""!==m.temporary.licence&&m.temporary.rating&&""!==m.temporary.rating?(0==y(t={licence_id:m.temporary.licence.id,licence_title:m.temporary.licence.abbreviation,rating_title:m.temporary.rating.abbreviation,rating_id:m.temporary.rating.id},m.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&m.club.plane.requirements.licence.push(t),delete m.temporary.licence,delete m.temporary.rating):alert("Please select a licence and rating that is required to book the plane solo!");break;case"medical":m.temporary.medical_authority&&""!==m.temporary.medical_authority&&m.temporary.medical_component&&""!==m.temporary.medical_component?(0==y(n={authority_id:m.temporary.medical_authority.id,authority_title:m.temporary.medical_authority.abbreviation,medical_component_id:m.temporary.medical_component.id,medical_component_title:m.temporary.medical_component.title},m.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&m.club.plane.requirements.medical.push(n),delete m.temporary.medical_authority,delete m.temporary.medical_component):alert("Please select a medical that is required to book the plane solo!");break;case"differences":var n;m.temporary.difference&&""!==m.temporary.difference?(0==y(n={difference_id:m.temporary.difference.id,difference_title:m.temporary.difference.title},m.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&m.club.plane.requirements.differences.push(n),delete m.temporary.difference):alert("Please select a difference that is required to book the plane solo!")}},o.remove_item=function(e,t){m.club.plane.requirements[e].splice(t,1)},o.update_this_file=function(e){-1===f.indexOf(e.id)&&f.push(e.id)},o.remove_real_file=function(t){m.club.plane.plane_documents=$.grep(m.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(m.user_id,t.id).then(function(e){e.success&&(m.plane_documents=[],o.processFiles(current_files))})},m.files={radio:[],cert:[],insurance:[],noise:[]},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,m.files[t].push(e[0].file)},o.set_title=function(e){return e.save_name},o.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(m.plane_documents=[],o.processFiles(t))})},o.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,m.plane_documents.push(e[t].file)}},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},o.save_plane_documents=function(){},o.change_file_name=function(t){m.plane_documents=$.grep(m.plane_documents,function(e){return e.temp_path!=t.temp_path}),m.plane_documents.push(t)};o.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;c.info("PRESSED GO: ",t),r.Delete(t).then(function(){m.club.planes=$.grep(m.club.planes,function(e){return e.id!=t})})},function(){c.info("Modal dismissed at: "+new Date)})},m.aircraft,m.plane_search,m.plane_to_add,o.get_aircraft=function(t){3<t.length&&r.GetAddAircraft(t).then(function(e){!e||0==e.length?m.aircraft=[{icao_type:"not known",registration:t.toUpperCase()}]:m.aircraft=e})}}function DashboardClubInstructorChargesController(e,t,n,o,i,r,a,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={},m.page_title="",m.plane_document={},m.plane_documents=[];var f=[];switch(m.action=r.current.data.action,m.club_id=n.globals.currentUser.current_club_admin.id,m.user=n.globals.currentUser,m.user_id=m.user.id,m.charge_type=["brakes","session","plane"],m.action){case"add":m.page_title="Add a Instructor Charge";break;case"edit":p.GetById(a.id).then(function(e){m.club.item=e.item,m.page_title="Edit an instructor charge - "+m.club.item.title});break;case"list":p.GetByClubId(m.club_id).then(function(e){m.club.items=e.items})}function g(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}i.back=function(){l.history.back()},i.save=function(){"add"==m.action?i.create():i.update()},i.create=function(){m.club.item.club_id=m.club_id,p.Create(m.club.item).then(function(e){r.go("dashboard.manage_club.instructor_charges",{},{reload:!0})})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),p.Delete(m.user.id,m.club.item).then(function(e){})},i.update=function(){m.club.item.club_id=m.club_id,p.Update(m.club.item,m.user.id).then(function(e){r.go("dashboard.manage_club.instructor_charges",{},{reload:!0})})},i.add_item=function(e){switch(e){case"licence":var t;m.temporary.licence&&""!==m.temporary.licence&&m.temporary.rating&&""!==m.temporary.rating?(0==g(t={licence_id:m.temporary.licence.id,licence_title:m.temporary.licence.abbreviation,rating_title:m.temporary.rating.abbreviation,rating_id:m.temporary.rating.id},m.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&m.club.plane.requirements.licence.push(t),delete m.temporary.licence,delete m.temporary.rating):alert("Please select a licence and rating that is required to book the plane solo!");break;case"medical":m.temporary.medical_authority&&""!==m.temporary.medical_authority&&m.temporary.medical_component&&""!==m.temporary.medical_component?(0==g(n={authority_id:m.temporary.medical_authority.id,authority_title:m.temporary.medical_authority.abbreviation,medical_component_id:m.temporary.medical_component.id,medical_component_title:m.temporary.medical_component.title},m.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&m.club.plane.requirements.medical.push(n),delete m.temporary.medical_authority,delete m.temporary.medical_component):alert("Please select a medical that is required to book the plane solo!");break;case"differences":var n;m.temporary.difference&&""!==m.temporary.difference?(0==g(n={difference_id:m.temporary.difference.id,difference_title:m.temporary.difference.title},m.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&m.club.plane.requirements.differences.push(n),delete m.temporary.difference):alert("Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){m.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===f.indexOf(e.id)&&f.push(e.id)},i.remove_real_file=function(t){m.club.plane.plane_documents=$.grep(m.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(m.user.id,t.id).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,m.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){m.plane_documents=$.grep(m.plane_documents,function(e){return e.temp_path!=t.temp_path}),m.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(m.user.id,t.id).then(function(){m.club.items=$.grep(m.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubInvoicesController(e,n,t,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w,C){var S=this;S.clubs=[],S.user=c.globals.currentUser,S.user_id=S.user.id,S.club_id=S.user.current_club_admin.id,S.to_date=new Date,S.from_date=new Date,S.from_date.setMonth(S.from_date.getMonth()-1),S.show_pay_now=!1,S.show_loading=!1,S.last_invoice_opened={};function x(e){var t=new Date(e),n=t.getDay(),n=t.getDate()-n+(0===n?-6:1);return new Date(e.setDate(n))}S.donConfirm=function(e,t){S.complete_invoice(e,t)},S.default_payment="direct-debit",S.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!1},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],S.savedCards=[],S.complete_invoice=function(e,t){e={user_id:S.last_invoice_opened.user_id,club_id:S.last_invoice_opened.club_id,paymentIntent:t,invoice_id:S.last_invoice_opened.id,method:e};n.ProcessPayment(e).then(function(e){e.success?o.GetClubInvoices(S.club_id,S.from_date,S.to_date).then(function(e){console.log("data is : ",e),S.invoices=e.invoices,S.totals=e.totals,S.show_pay_now=!1,S.show_loading=!1}):(console.log("===== ERROR ====="),console.log(e),console.log("===== ERROR ====="))})},S.close_pay_now=function(){S.show_pay_now=!1,S.show_loading=!1},S.show_payment_option=function(e){e=e.status;return"pending_submission"==e||"issued"==e},S.info,S.show_payment=function(e){console.log("invoice details: ",e),S.last_invoice_opened=e,S.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.id},i.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(S.info=e.info,S.savedCards=e.cards,0<S.savedCards.length?S.methods[1].visible=!0:S.methods[1].visible=!1,S.machine=e.machine,S.machine.success?S.methods[3].visible=!0:S.methods[3].visible=!1,S.show_pay_now=!0)})},S.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},S.quick_select={},S.base_date=new Date,S.yesterday=new Date,S.sevendaysago=new Date,S.thirtydaysago=new Date,S.yesterday.setDate(S.yesterday.getDate()-1),S.sevendaysago.setDate(S.yesterday.getDate()-7),S.thirtydaysago.setDate(S.yesterday.getDate()-30);var O,D=new Date,I=new Date(D.getFullYear(),D.getMonth(),1),c=new Date(D.getFullYear(),D.getMonth()+1,0),e=new Date(D.getFullYear(),D.getMonth()-1,1),D=new Date(D.getFullYear(),D.getMonth(),0);function M(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){m.info("!!saveBlob method failed with the following exception:"),m.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){m.info("Download link method with simulated click failed with the following exception:"),m.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){m.info("Download link method with window.location failed with the following exception:"),m.info(e)}}}return o||(m.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}S.quick_selects=[{title:"Today",from_date:S.base_date,to_date:S.base_date},{title:"Yesterday",from_date:S.yesterday,to_date:S.yesterday},{title:"Last 7 days",from_date:S.sevendaysago,to_date:S.base_date},{title:"Last 30 days",from_date:S.thirtydaysago,to_date:S.yesterday},{title:"This week",from_date:x(new Date),to_date:(O=x(new Date),(O=new Date(O)).setDate(O.getDate()+6),O)},{title:"This month",from_date:I,to_date:c},{title:"Last month",from_date:e,to_date:D}],S.update_qs=function(){console.log("QUICK SELECT : "),console.log(S.quick_select.from_date),console.log(S.quick_select.to_date),S.from_date=S.quick_select.from_date,S.to_date=S.quick_select.to_date,S.update_date_range()},S.update_date_range=function(){o.GetClubInvoices(S.club_id,S.from_date,S.to_date).then(function(e){console.log("data is : ",e),S.invoices=e.invoices,S.totals=e.totals})},S.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(t=1==t?"":"-")+n+":"+e},o.GetClubInvoices(S.club_id,S.from_date,S.to_date).then(function(e){console.log("data is : ",e),S.invoices=e.invoices,S.totals=e.totals}),d.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},S.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},d.search=function(e){return!(!e.plane_registration||-1===angular.lowercase(e.plane_registration).indexOf(angular.lowercase(d.my_search)||""))||(-1!==angular.lowercase(e.invoice_number).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(e.user.last_name).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(parseFloat(e.total).toFixed(2).toString()).indexOf(angular.lowercase(d.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(d.my_search)||""))},d.show_more=function(e){S.invoices[e].show_more=!S.invoices[e].show_more},d.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},d.downloadDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");C.get("http://local.arrow.com/api/v1/plane_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){M(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},d.downloadInvoice=function(e){C.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){M(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function DashboardClubItemsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={},m.page_title="",m.plane_document={},m.plane_documents=[];switch(m.action=r.current.data.action,m.club_id=n.globals.currentUser.current_club_admin.id,m.user=n.globals.currentUser,m.user_id=m.user.id,m.action){case"add":m.page_title="Add a New Plane";break;case"edit":p.GetById(a.item_id).then(function(e){m.club.item=e.item,m.page_title="Edit an Item - "+m.club.item.title});break;case"list":p.GetByClubId(m.club_id).then(function(e){m.club.items=e.items})}i.back=function(){l.history.back()},i.save=function(){"add"==m.action?i.create():i.update()},i.create=function(){m.club.item.club_id=m.club_id,p.Create(m.club.item).then(function(e){r.go("dashboard.manage_club.items")})},i.delete=function(e){confirm("Are you sure you would like to delete this item?")&&p.Delete(m.user.id,e.id).then(function(e){e.success?p.GetByClubId(m.club_id).then(function(e){m.club.items=e.items}):alert("An error occured when trying to delete this item.")})},i.update=function(){m.club.item.club_id=m.club_id,p.Update(m.club.item,m.user.id).then(function(e){r.go("dashboard.manage_club.items")})};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(m.user.id,t.id).then(function(){m.club.items=$.grep(m.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubLessonController(e,t,n,o,i,r,a,s,c,l){var d=this;d.user=null,d.allUsers=[],d.club={lesson:{}},d.page_title="",d.lesson_document={},d.lesson_documents=[];var u=[];switch(d.action=i.current.data.action,d.user=t.globals.currentUser,d.club_id=t.globals.currentUser.current_club_admin.id,d.user_id=d.user.id,d.lesson_certificate={},d.lesson_noise={},d.lesson_radio={},d.lesson_maintenance={},d.lesson_insurance={},d.club.lessons=[],d.club.lesson={},d.new_tem={threat:"",consequence:"",mitigation:""},d.new={preflight:{title:"",bullet_format:"0"},airex:{title:"",bullet_format:"0"},debrief:{title:"",bullet_format:"0"}},d.editing=!1,d.action){case"add":d.page_title="Add a New Course";break;case"edit":d.editing=!0,l.GetLessonById(r.lesson_id).then(function(e){d.club.lesson=e.item}),p(),_(),m()}function _(){l.GetBulletsByLessonId(r.lesson_id).then(function(e){d.bullets=e.bullets})}function p(){l.GetTemByLessonId(r.lesson_id).then(function(e){d.tem=e.items})}function m(){l.GetItemsByLessonId(r.lesson_id).then(function(e){d.items=e.items})}function f(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}d.add_tem=function(){d.new_tem.lesson_id=r.lesson_id,d.new_tem.organise=d.tem&&0<d.tem.length?d.tem.length:0,l.CreateTem(d.new_tem).then(function(e){e.success?(d.tem.push(e.item),d.new_tem={threat:"",consequence:"",mitigation:""}):alert("An error occurred...")})},d.update_tem=function(e,t){delete e.edit_me,l.UpdateTem(e).then(function(e){e.success?d.tem[t].edit_me=!1:alert("An error occurred...")})},d.update_cancel=function(e){p()},d.edit_tem=function(e){d.tem[e].edit_me=!0},d.delete_tem=function(e,t){l.DeleteTem(e.id).then(function(e){e.success?d.tem.splice(t,1):alert("An error occurred...")})},d.add_bullet=function(t){var e=d.bullets[t]&&0<d.bullets[t].length?d.bullets[t].length:0,e={title:d.new[t].title,bullet_format:d.new[t].bullet_format,lesson_id:r.lesson_id,bullet_type:t,organise:e};l.CreateBullet(e).then(function(e){e.success?(d.bullets[t]?d.bullets[t].push(e.item):d.bullets[t]=Array(e.item),d.new[t].title="",d.new[t].bullet_format="0"):alert("An error occurred...")})},d.update_bullet=function(t,e,n){delete e.edit_me,l.UpdateBullet(e).then(function(e){e.success?d.bullets[t][n].edit_me=!1:alert("An error occurred...")})},d.update_cancel_bullet=function(e){_()},d.edit_bullet=function(e,t){d.bullets[e][t].edit_me=!0},d.delete_bullet=function(t,e,n){l.DeleteBullet(e.id).then(function(e){e.success?d.bullets[t].splice(n,1):alert("An error occurred...")})},o.save_bullet_order=function(e){for(var t=[],n=0;n<d.bullets[e].length;n++){var o={id:d.bullets[e][n].id,organise:n};t.push(o)}l.UpdateBulletOrder({order:t}).then(function(e){})},o.save_items_order=function(){for(var e=[],t=0;t<d.items.length;t++){var n={id:d.items[t].id,organise:t};e.push(n)}l.UpdateItemsOrder({order:e}).then(function(e){})},o.save_tem_order=function(){for(var e=[],t=0;t<d.tem.length;t++){var n={id:d.tem[t].id,organise:t};e.push(n)}l.UpdateTemOrder({order:e}).then(function(e){})},d.add_item=function(){d.new_item.lesson_id=r.lesson_id,d.new_item.organise=d.items&&0<d.items.length?d.items.length:0,l.CreateItem(d.new_item).then(function(e){e.success?(d.items.push(e.item),d.new_item={title:""}):alert("An error occurred...")})},d.update_item=function(e,t){delete e.edit_me,l.UpdateItem(e).then(function(e){e.success?d.items[t].edit_me=!1:alert("An error occurred...")})},d.update_cancel_item=function(e){m()},d.edit_item=function(e){d.items[e].edit_me=!0},d.delete_item=function(e,t){l.DeleteItem(e.id).then(function(e){e.success?d.items.splice(t,1):alert("An error occurred...")})},o.back=function(){c.history.back()},o.save=function(){o.update()},o.create=function(){d.club.lesson.course_id=r.course_id,l.CreateLesson(d.club.lesson).then(function(e){i.go("dashboard.manage_club.edit_lesson",{course_id:d.club.lesson.course_id,lesson_id:e.id,reload:!0})})},o.delete=function(){alert("Are you sure you would like to delete this lesson?"),l.DeleteLesson(d.club.lesson.id).then(function(e){})},o.update=function(){l.UpdateLesson(d.club.lesson).then(function(e){i.go("dashboard.manage_club.edit_course",{course_id:d.club.lesson.course_id,reload:!0})})},o.add_item=function(e){switch(e){case"licence":var t;d.temporary.licence&&""!==d.temporary.licence&&d.temporary.rating&&""!==d.temporary.rating?(0==f(t={licence_id:d.temporary.licence.id,licence_title:d.temporary.licence.abbreviation,rating_title:d.temporary.rating.abbreviation,rating_id:d.temporary.rating.id},d.club.lesson.requirements.licence,new Array("licence_id","rating_id"))&&d.club.lesson.requirements.licence.push(t),delete d.temporary.licence,delete d.temporary.rating):alert("Please select a licence and rating that is required to book the lesson solo!");break;case"medical":d.temporary.medical_authority&&""!==d.temporary.medical_authority&&d.temporary.medical_component&&""!==d.temporary.medical_component?(0==f(n={authority_id:d.temporary.medical_authority.id,authority_title:d.temporary.medical_authority.abbreviation,medical_component_id:d.temporary.medical_component.id,medical_component_title:d.temporary.medical_component.title},d.club.lesson.requirements.medical,new Array("authority_id","medical_component_id"))&&d.club.lesson.requirements.medical.push(n),delete d.temporary.medical_authority,delete d.temporary.medical_component):alert("Please select a medical that is required to book the lesson solo!");break;case"differences":var n;d.temporary.difference&&""!==d.temporary.difference?(0==f(n={difference_id:d.temporary.difference.id,difference_title:d.temporary.difference.title},d.club.lesson.requirements.differences,new Array("difference_id","difference_title"))&&d.club.lesson.requirements.differences.push(n),delete d.temporary.difference):alert("Please select a difference that is required to book the lesson solo!")}},o.update_this_file=function(e){-1===u.indexOf(e.id)&&u.push(e.id)},o.remove_real_file=function(t){d.club.lesson.lesson_documents=$.grep(d.club.lesson.lesson_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(d.user_id,t.id).then(function(e){e.success&&(d.lesson_documents=[],o.processFiles(current_files))})},d.files={radio:[],cert:[],insurance:[],noise:[]},o.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,d.files[t].push(e[0].file)},o.set_title=function(e){return e.save_name},o.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(d.lesson_documents=[],o.processFiles(t))})},o.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,d.lesson_documents.push(e[t].file)}},o.set_title=function(e){return e.save_name},o.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},o.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function DashboardClubMaintenanceController(e,o,t,n,i,r,a,s,_,c,l,d,u,p,m,f){var g=this;g.user=null,g.allUsers=[],g.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},g.page_title="",g.plane_document={},g.plane_documents=[];var b=[];switch(g.currency_types=["class","type"],g.gear_types=["tricycle","tailwheel","monowheel","floats","skis"],g.charge_type=["brakes","tacho","hobbs"],g.surcharge_type=["none","flight","hour"],g.action=r.current.data.action,g.user=t.globals.currentUser,g.club_id=t.globals.currentUser.current_club_admin.id,g.user_id=g.user.id,g.show_overlay=!1,g.show_cert=!1,g.show_maintenance=!1,g.show_radio=!1,g.show_noise=!1,g.show_insurance=!1,g.show_offline=!1,g.obj={issues:[],issue_confirmation:!1},g.reported_defects=[],g.maintenance_types=["annual","25hours","50hours","100hours","interim","6months","extension"],g.action){case"add":g.page_title="Add a New Plane";break;case"edit":o.GetByIdMaintenance2(a.plane_id,g.club_id).then(function(e){g.club.plane=e,g.this_plane_id=a.plane_id,g.club.plane&&g.club.plane.maintenance&&(g.obj.hours_remaining=g.club.plane.maintenance.hours_remaining,g.obj.next_check=new Date(g.club.plane.maintenance.next_maintenance),g.obj.check_date=new Date,g.obj.extension_granted=new Date),g.page_title="Edit a Plane Maintenance - "+g.club.plane.registration}),o.GetOpenIssues(a.plane_id).then(function(e){g.reported_defects=e});break;case"list":o.GetAllByClubMaintenance(g.club_id).then(function(e){g.club.planes=e})}function h(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}g.reset_aeroplane=function(){g.this_plane_id&&0<g.this_plane_id?confirm("Are you sure you wish to override the logs?")&&m.ResetOneClubPlane(g.this_plane_id).then(function(e){console.log(e),e.success&&alert("Should be sorted!")}):alert("NO IDEA")},g.selected_type="",g.send_obj={},i.show_overlay=function(e){g.show_overlay=!0,"maintenance"==(g.selected_type=e)?(g.show_cert=!0,g.show_insurance=!0,g.show_radio=!0,g.show_maintenance=!0,g.show_noise=!0,g.show_offline=!1):"cert"==e?(g.show_cert=!0,g.show_insurance=!1,g.show_radio=!1,g.show_maintenance=!1,g.show_noise=!1,g.show_offline=!1):"insurance"==e?(g.show_cert=!1,g.show_insurance=!0,g.show_radio=!1,g.show_maintenance=!1,g.show_noise=!1,g.show_offline=!1):"radio"==e?(g.show_cert=!1,g.show_insurance=!1,g.show_radio=!0,g.show_maintenance=!1,g.show_noise=!1,g.show_offline=!1):"noise"==e?(g.show_cert=!1,g.show_insurance=!1,g.show_radio=!1,g.show_maintenance=!1,g.show_noise=!0,g.show_offline=!1):"offline"==e&&(g.show_cert=!1,g.show_insurance=!1,g.show_offline=!0,g.show_radio=!1,g.show_noise=!1,g.show_maintenance=!1)},i.close_overlay=function(){g.show_overlay=!1},i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},i.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},i.count_defects=function(e){for(var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,n=0,o=0;o<e.length;o++)(1==t||"open"==e[o].status)&&n++;return n},i.save_overlay=function(){var e=g.obj;e.files={radio:g.files.radio[0]?g.files.radio[0].file:{},cert:g.files.cert[0]?g.files.cert[0].file:{},noise_cert:g.files.noise_cert[0]?g.files.noise_cert[0].file:{},insurance:g.files.insurance[0]?g.files.insurance[0].file:{}};e.selected_type=g.selected_type;e={};if(g.one_ticked){for(var t=0;t<g.reported_defects.length;t++)g.reported_defects[t].resolved&&g.obj.issues.push(g.reported_defects[t]);e.issues=g.obj.issues,0<e.issues.length&&0}if(g.files.radio[0]&&null==g.obj.radio_expiry||!g.files.radio[0]&&g.obj.radio_expiry)return alert("The radio is not complete - please ensure to add both expiry date and the new certificate."),!1;if(g.files.radio[0]&&g.obj.radio_expiry&&(e.radio={file:g.files.radio[0]?g.files.radio[0].file:{},expiry:g.obj.radio_expiry},0),g.files.cert[0]&&null==g.obj.certificate_expiry||null==g.files.cert[0]&&g.obj.certificate_expiry)return alert("The certificate is not complete - please ensure to add both expiry date and the new certificate."),!1;if(g.files.cert[0]&&g.obj.certificate_expiry&&(e.cert={file:g.files.cert[0]?g.files.cert[0].file:{},expiry:g.obj.certificate_expiry,date_issued:g.obj.certificate_issue},0),g.files.insurance[0]&&!g.obj.insurance_expiry||null==g.files.insurance[0]&&g.obj.insurance_expiry)return alert("The insurance is not complete - please ensure to add both expiry date and the new certificate."),!1;if(g.files.insurance[0]&&g.obj.insurance_expiry&&(e.insurance={file:g.files.insurance[0]?g.files.insurance[0].file:{},expiry:g.obj.insurance_expiry},0),g.files.noise_cert[0]&&!g.obj.noise_date||null==g.files.noise_cert[0]&&g.obj.noise_date)return alert("The noise certificate is not complete - please ensure to add both date and the certificate - or keep them both empty."),!1;if(g.files.noise_cert[0]&&g.obj.noise_date&&(e.noise_cert={file:g.files.noise_cert[0]?g.files.noise_cert[0].file:{},noise_level:g.obj.noise_level,date_issued:g.obj.noise_date},0),void 0!==g.obj.maintenance_type&&"extension"!==g.obj.maintenance_type||void 0!==g.obj.hours_remaining||void 0!==g.obj.next_check){if(""===g.obj.maintenance_type&&void 0===g.obj.maintenance_type||void 0===g.obj.hours_remaining&&""===g.obj.hours_remaining||void 0===g.obj.next_check||""===g.obj.next_check)return alert("The maintenance is not complete - please ensure to add both check date, next check, and hours remaining"),!1;var n=moment(moment(g.obj.check_date).format("YYYY-MM-DD")+" "+moment(g.obj.check_time).format("HH:mm:ss")).format("YYYY-MM-DD HH:mm:ss");e.maintenance={maintenance_type:g.obj.maintenance_type,hours_remaining:g.obj.hours_remaining,check_date:n,expiry_date:g.obj.next_check,description:g.obj.description},0}if("extension"==g.obj.maintenance_type){if(""===g.obj.extension_hours&&""===g.obj.extension_days)return alert("The maintenance is not complete - please ensure to add both check date, next check, and hours remaining"),!1;n=moment(moment(g.obj.extension_granted).format("YYYY-MM-DD")+" "+moment(g.obj.check_time).format("HH:mm:ss")).format("YYYY-MM-DD HH:mm:ss");e.extension={maintenance_type:g.obj.maintenance_type,extension_hours:g.obj.extension_hours,extension_days:g.obj.extension_days,extension_granted:n,description:g.obj.description},0}if(""===g.obj.offline_until&&""===g.obj.offline_notes)return alert("Please ensure that offline date is set in the future!"),!1;e.offline={offline_until:g.obj.offline_until,offline_notes:g.obj.offline_notes,club_id:g.club_id},!0?(g.send_obj=e,o.AddMaintenance(g.this_plane_id,e).then(function(e){r.go("dashboard.manage_club.maintenance",{action:"list",reload:!0})})):alert("You haven't filled anything - this box will now close without saving any changes."),g.show_overlay=!1},i.check_ticked=function(){for(var e=0,t=0;t<g.reported_defects.length;t++)g.reported_defects[t].resolved&&e++;g.one_ticked=0<e},i.show_cert=function(){g.show_cert=!0},i.close_cert=function(){g.show_cert=!1},i.save_cert=function(){g.show_cert=!1},i.show_insurance=function(){g.show_insurance=!0},i.close_insurance=function(){g.show_insurance=!1},i.save_insurance=function(){g.show_insurance=!1},i.show_radio=function(){g.show_radio=!0},i.close_radio=function(){g.show_radio=!1},i.save_radio=function(){g.show_radio=!1},i.show_noise=function(){g.show_noise=!0},i.close_noise=function(){g.show_noise=!1},i.save_noise=function(){g.show_noise=!1},i.show_maintenance=function(){g.show_maintenance=!0},i.close_maintenance=function(){g.show_maintenance=!1},i.save_maintenance=function(){g.show_maintenance=!1},g.add_defect=function(){var e={club_id:g.club_id,user_id:g.user_id,plane_id:g.this_plane_id,defect:g.defect,severity:g.defect_severity.title,status:"open"};o.AddDefect(e).then(function(e){e.item.can_delete=!0,g.club.plane.defects.push(e.item),g.defect="",g.defect_severity=""})},g.delete_defect=function(e){o.DeleteDefect(e).then(function(e){o.GetOpenIssues(g.bookout.plane_id).then(function(e){g.reported_defects=e})})},i.back=function(){c.history.back()},i.save=function(){"add"==g.action?i.create():i.update()},i.create=function(){g.club.plane.club_id=g.club_id,g.club.plane.add_documents=g.plane_documents,o.Create(g.club.plane).then(function(e){r.go("dashboard.manage_club.planes",{reload:!0})})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),o.Update(g.club.plane).then(function(e){})},i.getColours=function(e){return e<1?"red":e<5?"warning":e<10?"amber":void 0},i.update=function(){g.club.plane.club_id=g.club_id,g.club.plane.add_documents=g.plane_documents,g.club.plane.update_documents=function(){for(var e=[],t=0;t<b.length;t++)for(var n=b[t],o=0;o<g.club.plane.plane_documents.length;o++)g.club.plane.plane_documents[o].id==n&&e.push(g.club.plane.plane_documents[o]);return e}(),o.Update(g.club.plane).then(function(e){r.go("dashboard.manage_club.planes")})},i.add_item=function(e){switch(e){case"licence":var t;g.temporary.licence&&""!==g.temporary.licence&&g.temporary.rating&&""!==g.temporary.rating?(0==h(t={licence_id:g.temporary.licence.id,licence_title:g.temporary.licence.abbreviation,rating_title:g.temporary.rating.abbreviation,rating_id:g.temporary.rating.id},g.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&g.club.plane.requirements.licence.push(t),delete g.temporary.licence,delete g.temporary.rating):alert("Please select a licence and rating that is required to book the plane solo!");break;case"medical":g.temporary.medical_authority&&""!==g.temporary.medical_authority&&g.temporary.medical_component&&""!==g.temporary.medical_component?(0==h(n={authority_id:g.temporary.medical_authority.id,authority_title:g.temporary.medical_authority.abbreviation,medical_component_id:g.temporary.medical_component.id,medical_component_title:g.temporary.medical_component.title},g.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&g.club.plane.requirements.medical.push(n),delete g.temporary.medical_authority,delete g.temporary.medical_component):alert("Please select a medical that is required to book the plane solo!");break;case"differences":var n;g.temporary.difference&&""!==g.temporary.difference?(0==h(n={difference_id:g.temporary.difference.id,difference_title:g.temporary.difference.title},g.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&g.club.plane.requirements.differences.push(n),delete g.temporary.difference):alert("Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){g.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===b.indexOf(e.id)&&b.push(e.id)},i.remove_real_file=function(t){g.club.plane.plane_documents=$.grep(g.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(g.user_id,t.id).then(function(e){e.success&&(g.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){JSON.parse(e.file_return)},g.files={radio:[],cert:[],noise_cert:[],insurance:[]},i.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,g.files[t].push(e[n].file)}},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,g.files[t].push(e[0])},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},g.defect_severity,g.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){g.plane_documents=$.grep(g.plane_documents,function(e){return e.temp_path!=t.temp_path}),g.plane_documents.push(t)};function y(e,t){var n,o="application/octet-stream",i=!1,r=(t=t())["x-filename"]||"download.zip",t=t["content-type"]||o;try{_.info("first try");var a=new Blob([e],{type:"application/pdf"}),s=URL.createObjectURL(a);c=s,n="Secure Documents",(l=window.open()).document.write("<html><head><title>"+n+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+c+'" type="application/pdf" internalinstanceid="21"></body></html>'),l.document.close(),i=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!i){var c=window.URL||window.webkitURL||window.mozURL||window.msURL;if(c){var l=document.createElement("a");if("download"in l)try{_.info("second try");var a=new Blob([e],{type:t}),d=c.createObjectURL(a);l.setAttribute("href",d),l.setAttribute("download",r);var u=document.createEvent("MouseEvents");u.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),l.dispatchEvent(u),i=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!i)try{_.info("third try");a=new Blob([e],{type:o}),d=c.createObjectURL(a);window.location=d,i=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}return i||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),r}i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;_.info("PRESSED GO: ",t),o.Delete(t).then(function(){g.club.planes=$.grep(g.club.planes,function(e){return e.id!=t})})},function(){_.info("Modal dismissed at: "+new Date)})},i.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");f.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){y(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");f.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){y(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function DashboardClubMemberRequestsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v){var k=this;function w(){n.GetRequestsByClub(k.club_id).then(function(e){e.success&&(k.requests=e.requests)})}k.user=s.globals.currentUser,k.user_id=k.user.id,k.club_id=s.globals.currentUser.current_club_admin.id,k.user=s.globals.currentUser,k.user_id=k.user.id,k.noks=[],k.requests=[],k.auto_renew=!1,w(),l.popup=[],l.open=function(e,t){l.popup[e]&&1==l.popup[e].opened?(t.preventDefault(),t.stopPropagation()):l.popup[e]={opened:!0}},l.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],l.format=l.formats[0],l.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},k.show_memberships=!1,l.accept_request=function(e){n.ClubAcceptRequest(e,{status:"Accepted"}).then(function(e){w()})},l.decline_request=function(){n.ClubDeclineRequest(k.this_req.id).then(function(e){w()})},l.delete_request=function(e){n.DeleteRequest(e).then(function(e){w()})},l.resend_request=function(e){n.ResendRequest({request_id:e}).then(function(e){e.success&&alert("Request re-sent. Please ask them to check their junk / spam folders if they do not see it within the next 5 minutes."),w()})}}function DashboardClubMembersController(e,n,o,r,i,t,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v){var k=this;k.user=null,k.allUsers=[],k.club={},k.page_title="",k.club.member={},k.club.member.payment_now=!0,k.imported_new_headers=[],k.test="Package valid until 12/03/2022<br /> To be used on:<br /> G-BOOF <br /> G-OARU",k.action=l.current.data.action,k.club_id=a.globals.currentUser.current_club_admin.id,k.user=a.globals.currentUser,k.user_id=k.user.id,k.no_show_cols=["membership_start","membership_id","selected"],k.show_loading=!0,c.sortType="Email",c.sortReverse=!1,c.searchTool="",k.show_pay_now=!1,k.show_loading=!1,k.last_invoice_opened={};switch(k.donConfirm=function(e,t){k.complete_invoice(e,t)},k.default_payment="direct-debit",k.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!1},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],k.savedCards=[],k.complete_invoice=function(e,t){e={user_id:k.last_invoice_opened.user_id,club_id:k.last_invoice_opened.club_id,paymentIntent:t,invoice_id:k.last_invoice_opened.id,method:e};n.ProcessPayment(e).then(function(e){e.success?o.GetInvoicesUserClub(k.club.member.user_id,k.club_id,k.current_invoice_offset,k.loaded_per_batch,0).then(function(e){k.invoices=e.invoices,k.upcoming=e.upcoming,k.add_credit_amount=0,k.add_credit_note="",k.show_add_credit=!1,k.show_loading=!1,k.show_pay_now=!1,alert("SUCCESS!")}):(alert("Something happened which was not supposed to happen... Please try again"),console.log("===== ERROR ====="),console.log(e),console.log("===== ERROR ====="))})},k.close_pay_now=function(){k.show_pay_now=!1,k.show_loading=!1},k.show_payment_option=function(e){e=e.status;return"pending_submission"==e||"issued"==e},k.info,k.show_payment=function(e){console.log("invoice details: ",e),k.last_invoice_opened=e,k.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.id},r.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(k.info=e.info,k.savedCards=e.cards,0<k.savedCards.length?k.methods[1].visible=!0:k.methods[1].visible=!1,k.machine=e.machine,k.machine.success?k.methods[3].visible=!0:k.methods[3].visible=!1,k.show_pay_now=!0)})},c.get_human_status=function(e){var t;switch(e){case"issued":t="Created";break;case"pending_submission":t="Requesting";break;case"submitted":t="Requested";break;case"confirmed":case"paid_out":t="Paid";break;case"failed":t="Failed";break;case"charged_back":t="Charged Back";break;default:t=e}return t},k.action){case"add":k.page_title="Add a New member",i.GetAllByClub(k.club_id).then(function(e){k.club.memberships=e});break;case"edit":r.GetById(d.member_id,k.club_id).then(function(e){k.club.member=e.member,k.club.member.is_manager=1==k.club.member.is_manager,k.club.member.approved=1==k.club.member.approved,m.GetByUserIdClub(k.club.member.user_id,k.club_id).then(function(e){e.success&&(k.poids=e.poids)}),g.GetByUserIdClub(k.club.member.user_id,k.club_id).then(function(e){e.success&&(k.medicals=e.medicals)}),f.GetByUserIdClub(k.club.member.user_id,k.club_id).then(function(e){e.success&&(k.licences=e.licences)}),b.GetByUserIdClub(k.club.member.user_id,k.club_id).then(function(e){for(var t=e.differences.differences,n=0;n<t.length;n++)"0000-00-00"==t[n].sign_off_date&&delete t[n].sign_off_date,t[n].sign_off_date=new Date(t[n].sign_off_date),t[n].day=1==t[n].day,t[n].night=1==t[n].night,t[n].vfr=1==t[n].vfr,t[n].ifr=1==t[n].ifr;e.differences.differences=t,k.differences=e.differences.differences,k.differences_images=e.differences.images}),v.GetPackagesByUserIdAndClubId(k.club.member.user_id,k.club_id).then(function(e){k.packages=e.items}),k.get_package_html=function(e){for(var t="",n=0;n<e.aircraft.length;n++)t=t+" "+e.aircraft[n].registration+" ("+e.aircraft[n].plane_type+") <br />";return(0==e.validity?"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package does not expire <br /> To be used on:<br />":"Package purchased on: "+moment(e.created_at).format("D MMM Y")+"<br /> Package expires on: "+moment(e.created_at).add(e.validity,"days").format("D MMM Y")+" <br /> To be used on:<br />")+t},k.get_pax_html=function(e){for(var t="",n=0;n<e.passengers.length;n++){var o="";if(0<e.passengers[n].nok.length)for(var i=0;i<e.passengers[n].nok.length;i++)o=o+"<br /><br />Emergency Contact ("+(i+1)+"): <br />"+e.passengers[n].nok[i].first_name+" "+e.passengers[n].nok[i].last_name+" <br />relationship: "+e.passengers[n].nok[i].relationship+"<br />t: "+e.passengers[n].nok[i].phone_number+" <br /> e: "+e.passengers[n].nok[i].email_address+"<br />";t=t+"<span class='bolder'><b>"+e.passengers[n].first_name+" "+e.passengers[n].last_name+"</b></span><br />e: "+e.passengers[n].email+"<br />t: "+(e.passengers[n].telephone_number||"unknown")+o+"  <br /> <br />"}if(e.passengers.length,0<e.instructor_id){var r="";if(0<k.club.member.nok.noks.length)for(i=0;i<k.club.member.nok.noks.length;i++)r=r+"<br />Emergency Contact ("+(i+1)+"): <br />"+k.club.member.nok.noks[i].first_name+" "+k.club.member.nok.noks[i].last_name+" <br />relationship: "+k.club.member.nok.noks[i].relationship+"<br />t: "+k.club.member.nok.noks[i].phone_number+" <br /> e: "+k.club.member.nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Instructor Present</span> <br /> "+e.booking.instructor.first_name+" "+e.booking.instructor.last_name+" <br /> "+r}if(0<e.user_id){var a="";if(0<k.club.member.nok.noks.length)for(i=0;i<k.club.member.nok.noks.length;i++)a=a+"<br />Emergency Contact ("+(i+1)+"): <br />"+k.club.member.nok.noks[i].first_name+" "+k.club.member.nok.noks[i].last_name+" <br />relationship: "+k.club.member.nok.noks[i].relationship+"<br />t: "+k.club.member.nok.noks[i].phone_number+" <br /> e: "+k.club.member.nok.noks[i].email_address+"<br />";t=t+"<br /><span class='bolder'>Member Present</span> <br />"+a}return t},k.change_package={},k.calculate_change=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=0<e?e:k.change_package.slider_value;k.change_package.dual_percent=e/100,k.change_package.dual_hours=k.change_package.dual_percent*k.change_package.remaining_price/k.change_package.initial_dual_price,k.change_package.dual_price=k.change_package.dual_percent*k.change_package.remaining_price,k.change_package.dual_price>=k.change_package.remaining_price&&(k.change_package.dual_price=k.change_package.remaining_price,k.change_package.dual_hours=k.change_package.dual_price/k.change_package.initial_dual_price),k.change_package.remaining_solo_hours=(k.change_package.remaining_price-k.change_package.dual_price)/k.change_package.initial_solo_price,console.log("CHANGE CALC??",k.change_package),k.change_package.solo_number=k.change_package.remaining_solo_hours,k.change_package.dual_number=k.change_package.dual_hours,k.change_package.solo_price=k.change_package.remaining_solo_hours*k.change_package.initial_solo_price},k.show_package_change=function(e){console.log(e),k.show_package_popup=!0;document.getElementById("myRange");k.change_package.id=e.id,k.change_package.price=e.price,k.change_package.hours_dual=e.remaining_hours_dual,k.change_package.hours_solo=e.remaining_hours_solo,k.change_package.dual_hours=e.remaining_hours_dual,k.change_package.solo_hours=e.remaining_hours_solo,k.change_package.difference=e.difference,k.change_package.hours_dual_remaining=e.remaining_hours_dual,k.change_package.hours_solo_remaining=e.remaining_hours_solo,k.change_package.solo_number=e.remaining_hours_solo,k.change_package.dual_number=e.remaining_hours_dual,k.change_package.base=(k.change_package.price-k.change_package.difference*k.change_package.hours_dual)/(k.change_package.hours_dual+k.change_package.hours_solo),k.change_package.initial_dual_price=k.change_package.base+k.change_package.difference,0<k.change_package.hours_solo?k.change_package.initial_solo_price=(k.change_package.price-k.change_package.initial_dual_price*k.change_package.hours_dual)/k.change_package.hours_solo:k.change_package.initial_solo_price=k.change_package.base,k.change_package.remaining_price=k.change_package.hours_dual_remaining*k.change_package.initial_dual_price+k.change_package.hours_solo_remaining*k.change_package.initial_solo_price,k.change_package.remaining_ratio=k.change_package.initial_dual_price*k.change_package.hours_dual_remaining/k.change_package.remaining_price,k.change_package.slider_value=100*k.change_package.remaining_ratio;k.calculate_change()},k.hide_package_change=function(){k.show_package_popup=!1},k.refund_package_to_credit=function(){if(k.show_loading=!0,!confirm("Are you sure you wish to refund this package? This is irreversible!"))return!1;v.RefundPackageToAccount(k.change_package.id).then(function(e){e.success?k.packages=e.items:alert("an error happened - please try again"),k.show_package_popup=!1,k.show_loading=!1})},k.save_package_change=function(){k.show_loading=!0;var e={remaining_hours_dual:k.change_package.dual_number,remaining_hours_solo:k.change_package.solo_number};v.SwapPackageHours(k.change_package.id,e).then(function(e){e.success?k.packages=e.items:alert("an error happened - please try again"),k.show_package_popup=!1,k.show_loading=!1})},k.change_numbers=function(e){console.log("CHANGE NUMBER"),val=0,val="solo"==e?k.change_package.solo_number>k.change_package.remaining_price/k.change_package.initial_solo_price?(k.change_package.solo_number=k.change_package.remaining_price/k.change_package.initial_solo_price,0):0<=k.change_package.solo_number?1-k.change_package.solo_number*k.change_package.initial_solo_price/k.change_package.remaining_price:1:k.change_package.dual_number>k.change_package.remaining_price/k.change_package.initial_dual_price?(k.change_package.dual_number=k.change_package.remaining_price/k.change_package.initial_dual_price,1):0<=k.change_package.dual_number?k.change_package.dual_number*k.change_package.initial_dual_price/k.change_package.remaining_price:0,k.change_package.percent=100*val,k.change_package.slider_value=k.change_package.percent,k.calculate_change(k.change_package.percent)},k.convert_decimal_to_hours=function(e){var t=0<=e?1:-1;e*=t;var n=Math.floor(e),e=e-n,e=1/60*Math.round(e/(1/60)),e=Math.floor(60*e)+"";return 60==(e=e.length<2?"0"+e:e)&&(n+=1,e="00"),(1==t?"":"-")+n+":"+e},k.show_add_credit=!1,k.add_credit=function(){k.show_add_credit=!0},k.close_credit=function(){k.show_add_credit=!1},k.apply_credit=function(){k.show_loading=!0;var e={items:[{quantity:1,price:-k.add_credit_amount,title:k.add_credit_note,vat:0,is_credit_from_admin:1}],user:{user_id:k.club.member.user_id},club_id:k.club_id,payment:{direct_debit:!0},credit_only:1};n.CreateCustom(e).then(function(e){e.success?o.GetInvoicesUserClub(k.club.member.user_id,k.club_id,k.current_invoice_offset,k.loaded_per_batch,0).then(function(e){k.invoices=e.invoices,k.upcoming=e.upcoming,k.add_credit_amount=0,k.add_credit_note="",k.show_add_credit=!1,k.show_loading=!1}):k.show_loading=!1})},k.current_offset=0,k.current_invoice_offset=0,k.loaded_per_batch=5,k.all_loaded=!1,k.all_invoices_loaded=!1,t.GetUserJourneyLogs(k.club.member.user_id,k.club_id,k.current_offset,k.loaded_per_batch).then(function(e){k.logs=e.logs}),o.GetInvoicesUserClub(k.club.member.user_id,k.club_id,k.current_invoice_offset,k.loaded_per_batch,0).then(function(e){k.invoices=e.invoices,k.upcoming=e.upcoming}),k.load_more=function(){k.current_offset=k.current_offset+k.loaded_per_batch,t.GetUserJourneyLogs(k.club.member.user_id,k.club_id,k.current_offset,k.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return k.logs.push(e)}):k.all_loaded=!0})},k.load_more_invoices=function(){k.current_invoice_offset=k.current_invoice_offset+k.loaded_per_batch,o.GetInvoicesUserClub(k.club.member.user_id,k.club_id,k.current_invoice_offset,k.loaded_per_batch,1).then(function(e){0<e.invoices.length?e.invoices.forEach(function(e){return k.invoices.push(e)}):k.all_invoices_loaded=!0})},k.get_initial=function(e){return e.charAt(0)},k.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},c.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.floor(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},k.club.member.instructor=1==k.club.member.instructor,k.page_title="Edit a Member - "+k.club.member.first_name+" "+k.club.member.last_name,k.club.member.membership_start=new Date(k.club.member.membership_start),r.GetMemberPlanes(k.club.member.user_id,k.club_id).then(function(e){k.club.planes=e})}),i.GetAllByClub(k.club_id).then(function(e){k.club.memberships=e});break;case"list":r.GetAllByClub(k.club_id).then(function(e){k.club.members=e}),i.GetAllByClub(k.club_id).then(function(e){k.club.memberships=e}),c.checkAll=function(){c.selectedAll?c.selectedAll=!0:c.selectedAll=!1,angular.forEach(k.club.members,function(e){e.selected=c.selectedAll})}}c.back=function(){p.history.back()},c.save=function(){"add"==k.action?c.create():c.update()},c.search=function(e){return-1!==angular.lowercase(e.invoice_number).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.club_title).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.created_at.toString()).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.total.toString()).indexOf(angular.lowercase(c.my_search)||"")||-1!==angular.lowercase(e.status).indexOf(angular.lowercase(c.my_search)||"")},c.show_more=function(e){k.invoices[e].show_more=!k.invoices[e].show_more},c.csvToJSON=function(e){var t=e.csv.split(/\r\n|\n/),n=[],o=0;t[0]+=",membership_id,membership_start,selected";for(var i=1;i<t.length;i++)t[i]+=",membership_id,membership_start,true";var r=t[0].split(e.separator).length,a=[];e.header&&(a=t[0].split(e.separator),k.imported_headers=a,o=1);for(var s=o;s<t.length;s++){var c={},l=t[s].split(new RegExp(e.separator+'(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)'));if(l.length===r){if(e.header)for(i=0;i<a.length;i++)c[a[i]]=l[i];else for(var d=0;d<l.length;d++)c[d]=l[d];n.push(c)}}return n},k.apply_default_memberships=function(){for(var e=0;e<k.imported_users.length;e++)k.imported_users[e].membership&&k.imported_users[e].membership!={}&&""!=k.imported_users[e].membership||(k.imported_users[e].membership_id=k.default_membership.id,k.imported_users[e].membership=k.default_membership)},k.change_header=function(e,t){if("membership_start"==k.imported_new_headers[e])for(var n=0;n<k.imported_users.length;n++)try{var o=function(e,t){var n=(t=t||{}).prefer||"DMY",o=!!t.utc;if(null==e)return null;if("[object Date]"===Object.prototype.toString.call(e))return isNaN(e.getTime())?null:new Date(e.getTime());if("number"==typeof e&&isFinite(e)){var i=new Date(e);return isNaN(i.getTime())?null:i}if(!(t=String(e).trim()))return null;if(!/^\d{1,2}[\/. -]\d{1,2}[\/. -]\d{2,4}(\s+.*)?$/.test(t)){var r=new Date(t);if(!isNaN(r.getTime()))return r}if(i=(t=t.replace(/[.\-]/g,"/").replace(/\s+/g," ").trim()).split(" "),e=i[0],r=i.slice(1).join(" ").trim(),3!==(t=e.split("/")).length)return null;var a,s,c,i=parseInt(t[0],10),e=parseInt(t[1],10),l=parseInt(t[2],10);if(![i,e,l].every(function(e){return isFinite(e)}))return null;if(4===t[0].length?(a=i,s=e,c=l):(a=4===t[2].length?l:0<=(l=l)&&l<=99?l<=69?2e3+l:1900+l:l,!(12<i&&e<=12)&&(12<e&&i<=12||"MDY"===n)?(s=i,c=e):(c=i,s=e)),!(1<=a&&a<=9999))return null;if(!(1<=s&&s<=12))return null;if(!(1<=c&&c<=31))return null;if(e=i=n=0,r){r=r.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);if(r&&(n=parseInt(r[1],10),i=parseInt(r[2],10),e=r[3]?parseInt(r[3],10):0,23<n||59<i||59<e))return null}return n=o?new Date(Date.UTC(a,s-1,c,n,i,e,0)):new Date(a,s-1,c,n,i,e,0),i=o?n.getUTCFullYear():n.getFullYear(),e=(o?n.getUTCMonth():n.getMonth())+1,o=o?n.getUTCDate():n.getDate(),i!==a||e!==s||o!==c?null:n}(k.imported_users[n][t]);k.imported_users[n].membership_start&&k.imported_users[n].membership_start!={}&&""!=k.imported_users[n].membership_start&&k.imported_users[n].membership_start.getTime()||(k.imported_users[n].membership_start=new Date(o.toISOString()))}catch(e){console.log("didnt parse, ",e)}},k.apply_default_start=function(){},c.processData=function(){var e={csv:k.import_users,separator:",",header:!0};k.imported_users=c.csvToJSON(e);for(var t=0;t<k.imported_users.length;t++)k.imported_users[t].matching=k.imported_users[t].email,k.imported_users[t].email="a"+t+"@toaviate.com",k.imported_users[t].membership_start?k.imported_users[t].membership_start=new Date(k.imported_users[t].membership_start):k.imported_users[t].membership_start=new Date},k.user_columns={first_name:"First Name",last_name:"Last Name",email:"Email Address",dob:"Date of Birth",membership_number:"Membership Number",membership_start:"Membership Start Date",membership_id:"Membership Name",matching_email:"Matching Email"},c.import_column=function(e){},k.member_check=[],c.update_verification=function(e,t,n){k.member_check.push({type:e,obj:t});n={check_type:e,user_id:k.club.member.user_id,club_id:k.club_id,check_id:t.id,verified:n};r.Verify(n).then(function(e){}),function(){for(var e=0,t=0,n=0,o=0;o<k.member_check.length;o++)switch(k.member_check[o].type){case"poid":e++;break;case"medical":t++;break;case"licence":n++;break;case"difference":difference++}0<e&&0<t&&0<n&&(k.club.member.approved=1)}()},c.import_users=function(){if(k.imported_users=$.grep(k.imported_users,function(e){return"false"!=e.selected}),-1<k.imported_new_headers.indexOf("first_name")&&-1<k.imported_new_headers.indexOf("last_name")&&-1<k.imported_new_headers.indexOf("email")){for(var e=0;e<k.imported_users.length;e++)k.imported_users[e].membership&&k.imported_users[e].membership.membership_id&&(k.imported_users[e].membership_id=k.imported_users[e].membership.id,delete k.imported_users[e].membership);k.imported_new_headers.push("membership_id"),k.imported_new_headers.push("membership_start");for(var t=[],n=0;n<k.imported_users.length;n++){for(var o={user:{},club_id:k.club_id},i=0;i<k.imported_new_headers.length;i++)k.imported_new_headers[i]&&("first_name"==k.imported_new_headers[i]||"last_name"==k.imported_new_headers[i]||"dob"==k.imported_new_headers[i]||"email"==k.imported_new_headers[i]?o.user[k.imported_new_headers[i]]=k.imported_users[n][Object.keys(k.imported_users[n])[i]]:"membership_start"==k.imported_new_headers[i]||"membership_id"==k.imported_new_headers[i]?o[k.imported_new_headers[i]]=k.imported_users[n][k.imported_new_headers[i]]:o[k.imported_new_headers[i]]=k.imported_users[n][Object.keys(k.imported_users[n])[i]]);t.push(o)}r.CreateMany(t).then(function(e){l.go("dashboard.manage_club.members")})}else alert("You must select the First Name, Last Name and Email Address to be able to add the user to the system!")},k.sa_dual=!1,k.sa_solo=!1,k.sa_instruct=!1,k.select_all=function(e){if("dual"==e)for(var t=0;t<k.club.planes.length;t++)k.club.planes[t].book_dual=1,k.sa_dual=!0;else if("solo"==e)for(t=0;t<k.club.planes.length;t++)k.club.planes[t].book_solo=1,k.sa_solo=!0;else if("instruct"==e)for(t=0;t<k.club.planes.length;t++)k.club.planes[t].instruct=1,k.sa_instruct=!0},k.deselect_all=function(e){if("dual"==e)for(var t=0;t<k.club.planes.length;t++)k.club.planes[t].book_dual=0,k.sa_dual=!1;else if("solo"==e)for(t=0;t<k.club.planes.length;t++)k.club.planes[t].book_solo=0,k.sa_solo=!1;else if("instruct"==e)for(t=0;t<k.club.planes.length;t++)k.club.planes[t].instruct=0,k.sa_instruct=!1},c.create=function(){k.club.member.club_id=k.club_id,r.Create(k.club.member).then(function(e){l.go("dashboard.manage_club.members")})},c.invite_member=function(){k.club.member.club_id=k.club_id,r.send_invite_by_club(k.club.member).then(function(e){l.go("dashboard.manage_club.members")})},c.delete=function(){alert("Are you sure you would like to delete this membership?"),r.Update(k.club.membership).then(function(e){})},c.update=function(){k.club.member.club_id=k.club_id;var e=new Date(k.club.member.membership_start);e.isValid||(e=new Date),k.club.member.membership_start=e,r.Update(k.club.member).then(function(e){l.go("dashboard.manage_club.members")}),r.SaveMemberPlanes(k.club.member.user_id,k.club.member.club_id,k.club.planes).then(function(e){})},k.select_member_approval=!1,c.selected_members=function(e){if(k.select_member_approval)return!1;k.show_loading=!0,k.select_member_approval=!0,k.selected_members=$.grep(k.club.members,function(e){return 1==e.selected}),console.log(k.selected_members);for(var t=0;t<k.selected_members.length;t++)k.selected_members[t].approved="approve"==e?1:0,r.Update(k.selected_members[t]).then(function(e){});console.log("refresh members"),setTimeout(function(){r.GetAllByClub(k.club_id).then(function(e){k.club.members=e,console.log(k.club.members),i.GetAllByClub(k.club_id).then(function(e){k.club.memberships=e,k.select_member_approval=!1,k.show_loading=!1})})},1e3)},c.update_membership=function(e,t){k.club.member.membership_id=e.membership_id,k.club.member.membership_name=e.membership_name};var w="By deleting this membership, you will also cancel all reservations that this membership currently has.";function C(e,t,o,i){u.open({animation:!0,templateUrl:"views/modals/check_documents.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return t},warning:function(){return w}}}).result.then(function(e){_.info("PRESSED GO: ",e);for(var t,n=0;n<k[o].length;n++)k[o][n].id==i&&1!=k[o][n].verified&&(k[o][n].verified=1,t="differences"==o?"differences":o.slice(0,-1),c.update_verification(t,k[o][n],1));switch(o){case"poids":case"medicals":case"licences":case"differences":break;default:alert("sorry - we didn't recognise the request...")}},function(){_.info("Modal dismissed at: "+new Date)})}k.show_temp_login=!1,k.show_loading=!1,c.re_login=function(){h.Login3(k.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(c.openDocument(k.maybe.doc_type,k.maybe.doc_id),k.show_temp_login=!1):alert("This is the wrong password - please try again...")})},c.openDocument=function(n,o){k.show_loading=!0;var i=o,r=[];switch(n){case"poids":m.GetById(o,0,1).then(function(e){var t;e.success?(r=e.poid.images,k.show_loading=!(t={document_type:n,document_id:o,images:r}),C(i,t,n,o)):("templogin"==e.fail&&(k.show_temp_login=!0,k.maybe={doc_type:"poids",doc_id:o}),k.show_loading=!1)});break;case"medicals":g.GetById(o,0,1).then(function(e){var t;e.success?(r=e.medical.images,k.show_loading=!(t={document_type:n,document_id:o,images:r}),C(i,t,n,o)):(k.show_loading=!1,k.maybe={doc_type:"medicals",doc_id:o},"templogin"==e.fail&&(k.show_temp_login=!0,k.maybe={doc_type:"medicals",doc_id:o}))});break;case"licences":f.GetById(o,0,1).then(function(e){var t;e.success?(r=e.licence.images,k.show_loading=!(t={document_type:n,document_id:o,images:r}),C(i,t,n,o)):(k.show_loading=!1,"templogin"==e.fail&&(k.show_temp_login=!0,k.maybe={doc_type:"licences",doc_id:o}))});break;case"differences":var e={document_type:n,document_id:o,images:k.differences_images};k.show_loading=!1,C(i,e,n,o);break;default:k.show_loading=!1,alert("sorry - we didn't recognise the request...")}},c.downloadInvoice=function(e){y.get("api/v1/invoice_pdf/get_ad_hoc_invoice/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){_.info("saveBlob method failed with the following exception:"),_.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){_.info("Download link method with simulated click failed with the following exception:"),_.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){_.info("Download link method with window.location failed with the following exception:"),_.info(e)}}}o||(_.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},c.open=function(e){u.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return w}}}).result.then(function(t){_.info("PRESSED GO: "+t),r.Delete(t).then(function(){k.club.members=$.grep(k.club.members,function(e){return e.id!=t})})},function(){_.info("Modal dismissed at: "+new Date)})}}function DashboardClubMembershipsController(e,i,t,n,o,r,a,s,c,l,d){var u=this;u.user=null,u.allUsers=[],u.club={},u.page_title="",u.action=a.current.data.action,u.club_id=n.globals.currentUser.current_club_admin.id,u.user=n.globals.currentUser,u.user_id=u.user.id,t.GetById(u.club_id).then(function(e){switch(console.log("DATA HERE",e),u.club=e,u.club.membership={},u.action){case"add":u.page_title="Add a New membership",u.club.membership.currency=u.club.account_currency,u.club.membership.passenger_only=0,u.club.membership.passenger_only_default=0,i.GetAllMembershipPlanes(u.club_id,1).then(function(e){u.club_planes=e.membership_planes});break;case"edit":i.GetById(s.membership_id,u.club_id).then(function(e){u.club.membership=e,u.page_title="Edit a membership - "+u.club.membership.membership_name}),i.GetAllMembershipPlanes(u.club_id,s.membership_id).then(function(e){u.club_planes=e.membership_planes});break;case"list":i.GetAllByClub(u.club_id).then(function(e){u.club.memberships=e,console.log("one",u.club.memberships)})}}),r.back=function(){d.history.back()},r.save=function(){"add"==u.action?r.create():r.update()},r.create=function(){u.club.membership.club_id=u.club_id,i.Create(u.club.membership).then(function(e){a.go("dashboard.manage_club.memberships")})},r.delete=function(){alert("Are you sure you would like to delete this membership?"),i.Update(u.club.membership).then(function(e){})},r.update=function(){u.club.membership.club_id=u.club_id,i.Update(u.club.membership).then(function(e){if(1==u.club.membership.plane_access){for(var t=[],n=0;n<u.club_planes.length;n++){var o={id:u.club_planes[n].id,tacho_hour_fee:u.club_planes[n].membership_tacho_hour_fee,landing_fee:u.club_planes[n].membership_landing_fee,touch_and_go_fee:u.club_planes[n].membership_touch_and_go_fee,access:u.club_planes[n].access,membership_id:e,plane_id:u.club_planes[n].plane_id};t.push(o)}i.UpdateMembershipPlanes(e,t).then(function(e){})}a.go("dashboard.manage_club.memberships")})},u.previous_price=0,u.update_price=function(){"free"==u.club.membership.payment_term?(u.previous_price=0<u.club.membership.price?u.club.membership.price:0,u.club.membership.price=0):u.club.membership.price=0<u.club.membership.price?u.club.membership.price:0<u.previous_price?u.previous_price:0};r.open=function(e){c.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this membership, you will also cancel all reservations that this membership currently has."}}}).result.then(function(t){l.info("PRESSED GO: "+t.id),i.Delete(t.id).then(function(){u.club.memberships=$.grep(u.club.memberships,function(e){return e.id!=t.id})})},function(){l.info("Modal dismissed at: "+new Date)})}}function DashboardClubPackagesController(e,t,n,o,i,r,a,s,c,l,d){var u=this;switch(u.charge_type=["brakes","session","plane"],u.page_title="",u.action=i.current.data.action,u.user=t.globals.currentUser,u.club_id=t.globals.currentUser.current_club_admin.id,u.user_id=u.user.id,u.packages=[],u.editing=!1,u.action){case"add":d.GetAllByClub(u.club_id).then(function(e){u.planes_original=e,u.planes=JSON.parse(JSON.stringify(u.planes_original))});break;case"edit":u.editing=!0,u.package_id=r.package_id,l.GetPackageById(r.package_id).then(function(e){u.package=e.item,u.package.available=1==u.package.available,u.page_title="Edit a Package - "+u.package.title}),l.GetPackagePlanesByPackageId(r.package_id).then(function(e){u.aircraft=e.items,d.GetAllByClub(u.club_id).then(function(e){u.planes_original=e,u.planes=JSON.parse(JSON.stringify(u.planes_original)),u.clean_aircraft_selection()})});break;case"list":l.GetPackagesByClubId(u.club_id).then(function(e){u.packages=e.items})}o.back=function(){c.history.back()},o.save=function(){"add"==u.action?o.create():o.update()},u.delete_aircraft=function(e,t){"add"==u.action?(u.aircraft.splice(t,1),u.clean_aircraft_selection()):confirm("Are you sure you wish to delete this aircraft for this package? This is irreversible.")&&l.DeletePackagePlane(e.id).then(function(e){e.success?(u.aircraft.splice(t,1),u.clean_aircraft_selection()):alert("An error occurred...")})},u.aircraft=[],u.new_aircraft2={},u.new_aircraft={},u.add_aircraft=function(){"add"==u.action?(u.aircraft.push(u.new_aircraft.plane),u.clean_aircraft_selection(),u.new_aircraft={},u.new_aircraft2={}):(u.new_aircraft2.package_id=u.package_id,u.new_aircraft2.club_id=u.club_id,u.new_aircraft2.plane_id=u.new_aircraft.plane.plane_id,l.CreatePackagePlane(u.new_aircraft2).then(function(e){e.success?(u.aircraft.push(e.item),u.clean_aircraft_selection(),u.new_aircraft={},u.new_aircraft2={}):alert("An error occurred...")}))},u.clean_aircraft_selection=function(){u.planes=JSON.parse(JSON.stringify(u.planes_original));for(var e=0;e<u.aircraft.length;e++)for(var t=0;t<u.planes.length;)u.planes[t].plane_id===u.aircraft[e].plane_id?u.planes.splice(t,1):++t},u.update_charge=function(e,t){delete e.edit_me,l.UpdateCharge(e).then(function(e){e.success?u.instructor_charges[t].edit_me=!1:alert("An error occurred...")})},u.update_cancel_charge=function(e){refresh_charges()},u.edit_charge=function(e){u.instructor_charges[e].edit_me=!0},u.delete_charge=function(e,t){confirm("Are you sure you wish to delete this instructor charge? This is irreversible.")&&l.DeleteCharge(e.id).then(function(e){e.success?u.instructor_charges.splice(t,1):alert("An error occurred...")})},u.add_charge=function(){u.new_charge.course_id=r.course_id,u.new_charge.club_id=u.club_id,l.CreateCharge(u.new_charge).then(function(e){e.success?(u.instructor_charges.push(e.item),u.new_charge={title:"",charge_type:"",price:""}):alert("An error occurred...")})},u.convert_decimal_to_hours=function(e){var t,n=new Array,e=(n=e.toString().split("."))[0];return e<10&&(e="0"+e),n[1]?(t=100/n[1],(t=Math.round(60/t))<10&&(t="0"+t)):t="00",e+":"+t},u.delete_course=function(e,t){confirm("Are you sure you wish to delete this course? This is irreversible.")&&l.DeletePackage(e).then(function(e){e.success?u.packages.splice(t,1):alert("An error occurred...")})},o.create=function(){u.package.club_id=u.club_id,u.package.aircraft=u.aircraft,l.CreatePackage(u.package).then(function(e){i.go("dashboard.manage_club.package",{reload:!0})})},o.delete=function(){alert("Are you sure you would like to delete this course?"),l.DeletePackage(u.package.id).then(function(e){})},o.update=function(){l.UpdatePackage(u.package).then(function(e){i.go("dashboard.manage_club.package")})}}function DashboardClubPaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,m.GetPaymentsByClub(f.club_id).then(function(e){f.payments=e.payments}),i.back=function(){l.history.back()},i.save=function(){"add"==f.action?i.create():i.update()},i.create=function(){f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,t.Create(f.club.plane).then(function(e){r.go("dashboard.manage_club.planes",{reload:!0})})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),t.Update(f.club.plane).then(function(e){})},i.update=function(){f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,f.club.plane.update_documents=function(){for(var e=[],t=0;t<g.length;t++)for(var n=g[t],o=0;o<f.club.plane.plane_documents.length;o++)f.club.plane.plane_documents[o].id==n&&e.push(f.club.plane.plane_documents[o]);return e}(),t.Update(f.club.plane).then(function(e){r.go("dashboard.manage_club.planes")})},i.get_payment_description=function(e){return"Stripe"==e?"This invoice was charged using the Stripe integration":"Equilibrium"==e?"This invoice amounted to 0 and hence no payment was taken":"GoCardless"==e?"This invoice was charged using the GoCardless integration":"GoCardless + Credit"==e?"This invoice was charged using the GoCardless integration as well as Credit on file.":"Credit"==e?"This invoice was charged using the Credit the user had on file.":void 0};var b="By deleting this plane, you will also cancel all reservations that this plane currently has.";i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/refundModal.html",controller:"RefundModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return e},warning:function(){return b}}}).result.then(function(e){e.id;if(c.info("PRESSED GO: ",e),e.to_refund>e.amount-e.amount_refunded)return alert("You are trying to refund more than the payment was for. You will need to first refund this amount in full, and then make a payment to the user for the remaining sum."),!1;0<e.to_refund&&"Stripe"==e.payment_method&&(e.to_refund,e.amount,m.Refund(e).then(function(e){}))},function(){c.info("Modal dismissed at: "+new Date)})},i.new_charge=function(e){s.open({animation:!0,templateUrl:"views/modals/newChargeModal.html",controller:"NewChargeModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return e},warning:function(){return b}}}).result.then(function(e){c.info("PRESSED GO: ",e)},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubPlanesController(e,r,t,n,o,i,a,s,c,l,d,u,_,p,m){var f=this;f.show_loading=!1,f.user=null,f.allUsers=[],f.club={plane:{requirements:{licence:[],medical:[],differences:[]},documents:[]}},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];switch(f.currency_types=["class","type"],f.gear_types=["tricycle","tailwheel","monowheel","floats","amphibian","skis"],f.certificates=[{id:1,title:"Certificate of Airworthiness",value:"cofa"},{id:2,title:"National Certificate of Airworthiness",value:"cofa"},{id:2,title:"LAA Permit to Fly",value:"ptf"}],f.classes=["SEP (land)","SEP (sea)","SET (land)","SET (sea)","MEP (land)","MEP (sea)","ME"],f.charge_type=["airborne","brakes","tacho","hobbs","flight","brakes_rounded"],f.surcharge_type=["none","flight","hour","taxi"],f.action=a.current.data.action,f.user=n.globals.currentUser,f.club_id=n.globals.currentUser.current_club_admin.id,f.user_id=f.user.id,f.plane_certificate={},f.plane_noise={},f.plane_radio={},f.plane_maintenance={},f.plane_insurance={},f.plane_engine_1={removed_date:""},f.plane_engine_1_replace={removed_date:""},f.plane_engine_2={removed_date:""},f.plane_engine_2_replace={removed_date:""},f.plane_propeller_1={removed_date:""},f.plane_propeller_1_replace={removed_date:""},f.plane_propeller_2={removed_date:""},f.plane_propeller_2_replace={removed_date:""},f.show_replace_engine_1=!1,f.show_replace_engine_2=!1,f.show_replace_prop_1=!1,f.show_replace_prop_2=!1,u.GetAll().then(function(e){f.licences=e.licences}),u.GetRatings().then(function(e){f.ratings=e}),_.GetAuthority().then(function(e){f.medical_authorities=e}),_.GetComponents().then(function(e){f.medical_components=e}),p.GetDifferences().then(function(e){f.differences=e}),f.editing=!1,f.action){case"add":f.page_title="Add a New Plane";break;case"edit":f.editing=!0,r.GetById(s.plane_id,f.club_id).then(function(e){f.club.plane=e,console.log(f.club.plane),f.club.plane.colour&&-1<f.club.plane.colour.indexOf("rgba")&&(f.club.plane.colour=b(f.club.plane.colour)),f.club.plane.bg_colour&&-1<f.club.plane.bg_colour.indexOf("rgba")&&(f.club.plane.bg_colour=b(f.club.plane.bg_colour)),f.club.plane.airframe_hours=parseFloat(f.club.plane.airframe_hours),f.club.plane.vp=1==f.club.plane.vp,f.club.plane.rg=1==f.club.plane.rg,f.club.plane.tb=1==f.club.plane.tb,f.plane_engine_1=f.club.plane.engine_1,f.plane_engine_2=f.club.plane.engine_2,f.plane_propeller_1=f.club.plane.propeller_1,f.plane_propeller_2=f.club.plane.propeller_2,f.page_title="Edit a Plane - "+f.club.plane.registration});break;case"list":r.GetAllByClub(f.club_id).then(function(e){f.club.planes=e})}function b(e){var t=e.substring(e.indexOf("(")).split(","),n=parseInt(h(t[0].substring(1)),10),e=parseInt(h(t[1]),10),t=parseInt(h(t[2]),10),o=[n.toString(16),e.toString(16),t.toString(16)];return o.forEach(function(e,t){1===e.length&&(o[t]="0"+e)}),"#"+o.join("")}function h(e){return e.replace(/^\s+|\s+$/gm,"")}function y(e,t){t=1<arguments.length&&void 0!==t?t:1;return"rgba("+parseInt(e.substring(1,3),16)+", "+parseInt(e.substring(3,5),16)+", "+parseInt(e.substring(5),16)+", "+t+")"}function v(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}i.back=function(){d.history.back()},i.save_planes_order=function(){for(var e=[],t=0;t<f.club.planes.length;t++){var n={id:f.club.planes[t].plane_id,display_order:t};e.push(n)}r.UpdateOrder({order:e}).then(function(e){})},i.set_aircraft_details=function(){r.GetAddAircraft(f.plane_search.registration).then(function(e){e?0==e.length||(f.plane_search=e,function(){f.club.plane.manufacturer=f.plane_search.manufacturer,f.club.plane.serial_no=f.plane_search.serial_number,f.club.plane.plane_type=f.plane_search.icao_type,f.club.plane.type_name=f.plane_search.type_name,f.club.plane.year_built=f.plane_search.year_built,f.club.plane.aircraft_id=f.plane_search.id,f.club.plane.mtow=parseInt(f.plane_search.mtow),f.club.plane.airframe_hours=f.plane_search.airframe_hours,f.plane_search.noise_level&&(f.plane_noise.noise_level=f.plane_search.noise_level.match(/[+-]?\d+(\.\d+)?/g).map(function(e){return parseFloat(e)}));f.plane_noise.noise_cert_issue=f.plane_search.noise_cert_issue?new Date(f.plane_search.noise_cert_issue):"",-1<f.plane_search.aircraft_class.indexOf("FIXED-WING")&&(0<f.plane_search.is_propeller&&-1==f.plane_search.engine_name.indexOf("PT6A-")?f.club.plane.plane_class=1<f.club.plane.number_of_engines?"MEP":"SEP":f.club.plane.plane_class=1<f.club.plane.number_of_engines?"ME":"SET",-1<f.plane_search.aircraft_class.indexOf("LANDPLANE")&&(f.club.plane.plane_class=f.club.plane.plane_class+" (land)",f.club.plane.gear_type=""),(-1<f.plane_search.aircraft_class.indexOf("AMPHIBIAN")||-1<f.plane_search.aircraft_class.indexOf("FLOAT"))&&(f.club.plane.plane_class=f.club.plane.plane_class+" (sea)",f.club.plane.gear_type=-1<f.plane_search.aircraft_class.indexOf("AMPHIBIAN")?"amphibian":"floats"));f.club.plane.seats=parseInt(f.plane_search.seats)+1,f.plane_maintenance&&f.plane_maintenance.cofa_category&&(f.plane_maintenance.cofa_category=-1<f.plane_search.cofa_category.indexOf("cofa")?"Certificate of Airworthiness":"Permit to Fly");f.plane_maintenance.certificate_expiry=new Date(f.plane_search.cofa_expiry),f.club.plane.cofa_category=f.plane_maintenance.cofa_category,f.club.plane.gear_type=f.plane_search.gear_type,f.plane_engine_1.make=f.plane_search.engine_name,f.plane_engine_1.model=f.plane_search.engine_name,f.plane_propeller_1.make=f.plane_search.propeller_manufacturer,f.plane_propeller_1.model=f.plane_search.propeller_name,1<f.plane_search.number_of_engines&&(f.number_of_engine=f.plane_search.number_of_engines,f.plane_engine_2.make=f.plane_search.engine_name,f.plane_engine_2.model=f.plane_search.engine_name,f.plane_propeller_2.make=f.plane_search.propeller_manufacturer,f.plane_propeller_2.model=f.plane_search.propeller_name)}()):console.log("WOOOPSIES... this aircraft isn't in our database?")})},i.save=function(){"add"==f.action?i.create():i.update()},f.disable_reset=!1,f.disable_reset2=!1,f.fix_uncombined=function(){confirm("Are you sure you wish to fix uncombined flight logs - this will also reset the aerolpane logbooks and cannot be undone.")&&!f.disable_reset2?(f.disable_reset2=!0,f.show_loading=!0,t.FixUncombinedLogs(f.club_id).then(function(e){a.go("dashboard.manage_club.planes",{reload:!0}),f.disable_reset2=!0,f.show_loading=!1})):(console.log("cancelled"),f.show_loading=!1)},f.reset_all_club_logs=function(){confirm("Are you sure you wish to reset this?")&&!f.disable_reset?(f.disable_reset=!0,f.show_loading=!0,t.ResetAllClubPlanes(f.club_id).then(function(e){a.go("dashboard.manage_club.planes",{reload:!0}),f.disable_reset=!0,f.show_loading=!1})):(console.log("cancelled"),f.show_loading=!1)},f.round_brake_times_start=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;if(e){if(-1<e.indexOf(":")){var n,o=e.split(":"),i=o[1],r=2.5<=i%5?5*parseInt(i/5)+5:5*parseInt(i/5);return r<10?r="0"+r:60==r?(o[0]++,r="00"):60<r&&(o[0]++,r-=60),t&&-1<t.indexOf(":")&&(i=(n=t.split(":"))[0],t=n[1],n=60*parseInt(i)+parseInt(t),i=o[0],t=r,n<60*parseInt(i)+parseInt(t)&&(60==(r=parseInt(r)-5)?(o[0]++,r="00"):60<r?(o[0]++,(r-=60)<10&&(r="0"+r)):r<0&&(o[0]--,r=60+parseInt(r)))),o[0]+":"+r}return e}return""},i.create=function(){f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,f.club.plane.registration=f.plane_search.registration,f.club.maintenance_type=f.plane_maintenance.cofa_category.value,console.log("vm.plane_maintenance.cofa_category ",f.club.maintenance_type),f.plane_maintenance.file=f.files.cert[0],f.plane_radio.file=f.files.radio[0],f.plane_noise.file=f.files.noise[0],f.plane_insurance.file=f.files.insurance[0],f.club.plane.maintenance=f.plane_maintenance,f.club.plane.insurance=f.plane_insurance,f.club.plane.noise_cert=f.plane_noise,f.club.plane.radio_licence=f.plane_radio,f.club.plane.vp=f.club.plane.vp?1:0,f.club.plane.rg=f.club.plane.rg?1:0,f.club.plane.tb=f.club.plane.tb?1:0,f.club.plane.engine_1=f.plane_engine_1,f.club.plane.engine_2=f.plane_engine_2,f.club.plane.propeller_1=f.plane_propeller_1,f.club.plane.propeller_2=f.plane_propeller_2,f.club.plane.colour&&""!==f.club.plane.colour&&-1==f.club.plane.colour.indexOf("rgba")&&(f.club.plane.colour=y(f.club.plane.colour,.75)),f.club.plane.bg_colour&&""!==f.club.plane.bg_colour&&-1==f.club.plane.bg_colour.indexOf("rgba")&&(f.club.plane.bg_colour=y(f.club.plane.bg_colour,.25)),r.Create(f.club.plane).then(function(e){a.go("dashboard.manage_club.planes",{reload:!0})})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),r.Update(f.club.plane).then(function(e){})},i.update=function(){f.club.plane.club_id=f.club_id,f.club.plane.add_documents=f.plane_documents,f.club.plane.update_documents=function(){for(var e=[],t=0;t<g.length;t++)for(var n=g[t],o=0;o<f.club.plane.plane_documents.length;o++)f.club.plane.plane_documents[o].id==n&&e.push(f.club.plane.plane_documents[o]);return e}(),f.club.plane.colour&&""!==f.club.plane.colour&&-1==f.club.plane.colour.indexOf("rgba")&&(f.club.plane.colour=y(f.club.plane.colour,.75)),f.club.plane.bg_colour&&""!==f.club.plane.bg_colour&&-1==f.club.plane.bg_colour.indexOf("rgba")&&(f.club.plane.bg_colour=y(f.club.plane.bg_colour,.25)),r.Update(f.club.plane).then(function(e){a.go("dashboard.manage_club.planes")})},f.save_new_aircraft_bit=function(e,t){var n="plane_"+e+"_"+t,o="plane_"+e+"_"+t+"_replace",i={},i=f[n]&&""!==f[n]?(f[n].removed_date=f[o].removed_date,delete f[o].removed_date,{old_item:f[n],new_item:f[o],plane_id:f.club.plane.id,item:e,no:t}):{old_item:{},new_item:f[o],plane_id:f.club.plane.id,item:e,no:t};console.log("LETS SEE WHAT WOULD BE SENT",i),r.UpdateAircraftBit(i).then(function(e){console.log(e),a.go("dashboard.manage_club.planes")})},i.add_item=function(e){switch(e){case"licence":var t;f.temporary.licence&&""!==f.temporary.licence&&f.temporary.rating&&""!==f.temporary.rating?(0==v(t={licence_id:f.temporary.licence.id,licence_title:f.temporary.licence.abbreviation,rating_title:f.temporary.rating.abbreviation,rating_id:f.temporary.rating.id},f.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&f.club.plane.requirements.licence.push(t),delete f.temporary.licence,delete f.temporary.rating):alert("Please select a licence and rating that is required to book the plane solo!");break;case"medical":f.temporary.medical_authority&&""!==f.temporary.medical_authority&&f.temporary.medical_component&&""!==f.temporary.medical_component?(0==v(n={authority_id:f.temporary.medical_authority.id,authority_title:f.temporary.medical_authority.abbreviation,medical_component_id:f.temporary.medical_component.id,medical_component_title:f.temporary.medical_component.title},f.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&f.club.plane.requirements.medical.push(n),delete f.temporary.medical_authority,delete f.temporary.medical_component):alert("Please select a medical that is required to book the plane solo!");break;case"differences":var n;f.temporary.difference&&""!==f.temporary.difference?(0==v(n={difference_id:f.temporary.difference.id,difference_title:f.temporary.difference.title},f.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&f.club.plane.requirements.differences.push(n),delete f.temporary.difference):alert("Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){f.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),m.Delete(f.user_id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},f.files={radio:[],cert:[],insurance:[],noise:[]},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,f.files[t].push(e[0].file)},i.set_title=function(e){return e.save_name},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){c.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(e){var t=e.id;l.info("PRESSED GO: ",t),r.Delete(t).then(function(){f.club.planes=$.grep(f.club.planes,function(e){return e.id!=t})})},function(){l.info("Modal dismissed at: "+new Date)})},f.aircraft,f.plane_search,f.plane_to_add,i.get_aircraft=function(t){3<t.length&&r.GetAddAircraft(t).then(function(e){!e||0==e.length?f.aircraft=[{icao_type:"not known",registration:t.toUpperCase()}]:f.aircraft=e})}}function DashboardClubPropellerLogbookController(e,n,t,o,i,r,a,s,d,c,l,u,_,p,m){var f=this;switch(f.action){case"add":f.page_title="Add a New Plane";break;case"edit":n.GetByIdMaintenance2(a.plane_id,f.club_id).then(function(e){f.club.plane=e,f.this_plane_id=a.plane_id,f.club.plane&&f.club.plane.maintenance&&(f.obj.hours_remaining=f.club.plane.maintenance.hours_remaining,f.obj.next_check=new Date(f.club.plane.maintenance.next_maintenance),f.obj.check_date=new Date,f.obj.extension_granted=new Date),f.page_title="Edit a Plane Maintenance - "+f.club.plane.registration}),n.GetOpenIssues(a.plane_id).then(function(e){f.reported_defects=e})}function g(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}return o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}i.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},f.prop_no="",n.GetPropLogs(a.prop_id,a.plane_id,0,25).then(function(e){f.logs=e.logs,f.propeller=e.propeller}),f.current_offset=0,f.loaded_per_batch=25,f.all_loaded=!1,f.load_more=function(){f.current_offset=f.current_offset+f.loaded_per_batch,n.GetPropLogs(a.prop_id,a.plane_id,f.current_offset,f.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return f.logs.push(e)}):f.all_loaded=!0,f.propeller=e.propeller})},f.get_initial=function(e){return e.charAt(0)},f.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},f.update_logbooks=function(){n.UpdateAircraftLogbooks(a.plane_id).then(function(e){e.success&&n.GetPropLogs(a.prop_id,a.plane_id,0,25).then(function(e){f.logs=e.logs,f.propeller=e.propeller})})},i.update_this_file=function(e){-1===update_this_file.indexOf(e.id)&&update_this_file.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),p.Delete(f.user_id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){JSON.parse(e.file_return)},f.files={radio:[],cert:[],insurance:[]},i.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();e[n].file.extension=o,f.files[t].push(e[n].file)}},i.processFile=function(e,t){var n=JSON.parse(e[0].file_return);e[0].file.temp_path=n.saved_url,e[0].file.save_name=n.files.file.name;n=n.files.file.name.split(".").pop();e[0].file.extension=n,f.files[t].push(e[0])},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},f.defect_severity,f.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)},i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return warning_msg}}}).result.then(function(e){var t=e.id;d.info("PRESSED GO: ",t),n.Delete(t).then(function(){f.club.planes=$.grep(f.club.planes,function(e){return e.id!=t})})},function(){d.info("Modal dismissed at: "+new Date)})},i.downloadDocument=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"docs",n=($.param({id:e}),"plane_documents");switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":n="plane_noise_certificate";break;case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){g(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");m.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){g(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},i.search2=function(e){return!i.my_search2||""==i.my_search2||!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(i.my_search2,e.entry_date)},i.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n},i.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)i.search(t[o])&&n++;return n}}function DashboardClubReceiptsApprovalController(e,n,t,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];function b(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}f.action=r.current.data.action,f.club_id=t.globals.currentUser.current_club_admin.id,f.user=t.globals.currentUser,f.user_id=f.user.id,n.GetCurrencies(f.club_id).then(function(e){f.currencies=e.currencies,f.club_currency=e.club_currency}),n.GetReceiptsApproval(f.club_id).then(function(e){f.receipts=e.receipts,f.receipts.forEach(function(e){f.verify_reimbursement(e)})}),i.get_currency=function(t){return $.grep(f.currencies,function(e){return e.iso_code==t})[0]},f.update_price=function(t){var e={modified_price:t.modified_price};n.UpdateReceipt(t.id,e).then(function(e){f.verify_reimbursement(t)})},f.verify_reimbursement=function(t){if(t.modified_price&&!t.modified_currency)t.modified_reimbursed_amount=t.modified_price,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount));else if(!t.modified_price||!t.modified_currency||0==t.reimbursement)return!1;var e={club_id:(t=$.grep(f.receipts,function(e){return e.id==t.id})[0]).club_id,currency:t.modified_currency||t.currency,price:t.modified_price||t.price,requested_at:t.created_at};n.CheckReimbursement(e).then(function(e){t.modified_reimbursed_amount=e.reimburse.reimbursed_amount,t.modified_reimbursed_rate=e.reimburse.rate,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount)),0==t.modified_reimbursed_difference&&(t.modified_reimbursed_difference=0)})},f.modified_reimbursement_tooltip=function(e){var t=e.modified_currency||e.currency,n=(e.modified_price?parseFloat(e.modified_price):parseFloat(e.price)).toFixed(2),t=t+""+parseFloat(n).toFixed(2);(e.modified_currency&&e.modified_currency!==e.reimbursed_currency||e.reimbursed_currency!==e.currency&&e.modified_reimbursed_rate)&&(t=t+" which on "+moment(e.created_at).format("DD MMM YYYY HH:mm")+" the Transferwise currency conversion of "+parseFloat(e.modified_reimbursed_rate).toFixed(5)+" gave a value of "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_amount).toFixed(2));n="<br /><br /> By approving this receipt, we will automatically adjust the reimbursement by "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_difference).toFixed(2)+" for this claim.";return 0==e.modified_reimbursed_difference&&(n="<br /><br /> By approving this receipt, there will be no financial charge for this change."),m.getTrustedHtml("<div>This is the amount that should have been removed from the associated invoice. <br /><br /> This is based on the receipt value of "+t+". "+n+"</div>")},f.update_currency=function(t){var e={modified_currency:t.modified_currency};n.UpdateReceipt(t.id,e).then(function(e){f.verify_reimbursement(t)})},f.update_invoice_no=function(e){var t={invoice_number:e.invoice_number};n.UpdateReceipt(e.id,t).then(function(e){})},f.update_qty=function(e){var t={modified_quantity:e.modified_quantity};n.UpdateReceipt(e.id,t).then(function(e){})},i.back=function(){l.history.back()},i.save=function(){"add"==f.action?i.create():i.update()},i.create=function(){f.club.item.club_id=f.club_id,p.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.items")})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),p.Delete(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,p.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.items")})},i.add_item=function(e){switch(e){case"licence":var t;f.temporary.licence&&""!==f.temporary.licence&&f.temporary.rating&&""!==f.temporary.rating?(0==b(t={licence_id:f.temporary.licence.id,licence_title:f.temporary.licence.abbreviation,rating_title:f.temporary.rating.abbreviation,rating_id:f.temporary.rating.id},f.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&f.club.plane.requirements.licence.push(t),delete f.temporary.licence,delete f.temporary.rating):alert("Please select a licence and rating that is required to book the plane solo!");break;case"medical":f.temporary.medical_authority&&""!==f.temporary.medical_authority&&f.temporary.medical_component&&""!==f.temporary.medical_component?(0==b(n={authority_id:f.temporary.medical_authority.id,authority_title:f.temporary.medical_authority.abbreviation,medical_component_id:f.temporary.medical_component.id,medical_component_title:f.temporary.medical_component.title},f.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&f.club.plane.requirements.medical.push(n),delete f.temporary.medical_authority,delete f.temporary.medical_component):alert("Please select a medical that is required to book the plane solo!");break;case"differences":var n;f.temporary.difference&&""!==f.temporary.difference?(0==b(n={difference_id:f.temporary.difference.id,difference_title:f.temporary.difference.title},f.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&f.club.plane.requirements.differences.push(n),delete f.temporary.difference):alert("Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){f.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon3=function(e){var e=e.split(";")[0],t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},f.approve_receipt_final=function(t){delete t.image,n.ApproveReceipt(t.id,t).then(function(e){e.success?f.receipts.splice(f.receipts.findIndex(function(e){return e.id===t.id}),1):alert("An error occurred: "+e.message),f.show_popup=!1,f.current_receipt={}})},f.reject_receipt_final=function(t){delete t.image,n.RejectReceipt(t.id,t).then(function(e){e.success?f.receipts.splice(f.receipts.findIndex(function(e){return e.id===t.id}),1):alert("An error occurred: "+e.message),f.show_popup=!1,f.current_receipt={}})},i.approve_receipt=function(e){f.current_receipt=e,0<f.current_receipt.modified_reimbursed_amount?f.show_popup="approve":f.approve_receipt_final(e)},i.reject_receipt=function(e){f.current_receipt=e,f.show_popup="reject"},i.close_popup=function(){f.show_popup=!1,f.current_receipt={}},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubReceiptsController(e,n,t,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];function b(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}f.action=r.current.data.action,f.club_id=t.globals.currentUser.current_club_admin.id,f.user=t.globals.currentUser,f.user_id=f.user.id,n.GetCurrencies(f.club_id).then(function(e){f.currencies=e.currencies,f.club_currency=e.club_currency}),f.current_offset=0,f.loaded_per_batch=10,f.all_loaded=!1,n.GetReceiptsClub(f.club_id,f.current_offset,f.loaded_per_batc).then(function(e){f.receipts=e.receipts,f.receipts.forEach(function(e){f.verify_reimbursement(e)})}),f.load_more=function(){f.current_offset=f.current_offset+f.loaded_per_batch,n.GetReceiptsClub(f.club_id,f.current_offset,f.loaded_per_batch).then(function(e){0<e.receipts.length?e.receipts.forEach(function(e){return f.receipts.push(e)}):f.all_loaded=!0})},f.show_receipt_image=function(e){f.show_receipt=!0,f.receipt_image=e.image},i.get_currency=function(t){return $.grep(f.currencies,function(e){return e.iso_code==t})[0]},f.update_price=function(t){var e={modified_price:t.modified_price};n.UpdateReceipt(t.id,e).then(function(e){f.verify_reimbursement(t)})},f.verify_reimbursement=function(t){if(t.modified_price&&!t.modified_currency)t.modified_reimbursed_amount=t.modified_price,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount));else if(!t.modified_price||!t.modified_currency||0==t.reimbursement)return!1;var e={club_id:(t=$.grep(f.receipts,function(e){return e.id==t.id})[0]).club_id,currency:t.modified_currency||t.currency,price:t.modified_price||t.price,requested_at:t.created_at};n.CheckReimbursement(e).then(function(e){t.modified_reimbursed_amount=e.reimburse.reimbursed_amount,t.modified_reimbursed_rate=e.reimburse.rate,t.modified_reimbursed_difference=parseFloat(parseFloat(t.modified_reimbursed_amount)-parseFloat(t.reimbursed_amount)),0==t.modified_reimbursed_difference&&(t.modified_reimbursed_difference=0)})},f.modified_reimbursement_tooltip=function(e){var t=e.modified_currency||e.currency,n=(e.modified_price?parseFloat(e.modified_price):parseFloat(e.price)).toFixed(2),t=t+""+parseFloat(n).toFixed(2);(e.modified_currency&&e.modified_currency!==e.reimbursed_currency||e.reimbursed_currency!==e.currency&&e.modified_reimbursed_rate)&&(t=t+" which on "+moment(e.created_at).format("DD MMM YYYY HH:mm")+" the Transferwise currency conversion of "+parseFloat(e.modified_reimbursed_rate).toFixed(5)+" gave a value of "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_amount).toFixed(2));n="<br /><br /> By approving this receipt, we will automatically adjust the reimbursement by "+e.reimbursed_currency+parseFloat(e.modified_reimbursed_difference).toFixed(2)+" for this claim.";return 0==e.modified_reimbursed_difference&&(n="<br /><br /> By approving this receipt, there will be no financial charge for this change."),m.getTrustedHtml("<div>This is the amount that should have been removed from the associated invoice. <br /><br /> This is based on the receipt value of "+t+". "+n+"</div>")},f.update_currency=function(t){var e={modified_currency:t.modified_currency};n.UpdateReceipt(t.id,e).then(function(e){f.verify_reimbursement(t)})},f.update_invoice_no=function(e){var t={invoice_number:e.invoice_number};n.UpdateReceipt(e.id,t).then(function(e){})},f.update_qty=function(e){var t={modified_quantity:e.modified_quantity};n.UpdateReceipt(e.id,t).then(function(e){})},i.back=function(){l.history.back()},i.save=function(){"add"==f.action?i.create():i.update()},i.create=function(){f.club.item.club_id=f.club_id,p.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.items")})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),p.Delete(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,p.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.items")})},i.add_item=function(e){switch(e){case"licence":var t;f.temporary.licence&&""!==f.temporary.licence&&f.temporary.rating&&""!==f.temporary.rating?(0==b(t={licence_id:f.temporary.licence.id,licence_title:f.temporary.licence.abbreviation,rating_title:f.temporary.rating.abbreviation,rating_id:f.temporary.rating.id},f.club.plane.requirements.licence,new Array("licence_id","rating_id"))&&f.club.plane.requirements.licence.push(t),delete f.temporary.licence,delete f.temporary.rating):alert("Please select a licence and rating that is required to book the plane solo!");break;case"medical":f.temporary.medical_authority&&""!==f.temporary.medical_authority&&f.temporary.medical_component&&""!==f.temporary.medical_component?(0==b(n={authority_id:f.temporary.medical_authority.id,authority_title:f.temporary.medical_authority.abbreviation,medical_component_id:f.temporary.medical_component.id,medical_component_title:f.temporary.medical_component.title},f.club.plane.requirements.medical,new Array("authority_id","medical_component_id"))&&f.club.plane.requirements.medical.push(n),delete f.temporary.medical_authority,delete f.temporary.medical_component):alert("Please select a medical that is required to book the plane solo!");break;case"differences":var n;f.temporary.difference&&""!==f.temporary.difference?(0==b(n={difference_id:f.temporary.difference.id,difference_title:f.temporary.difference.title},f.club.plane.requirements.differences,new Array("difference_id","difference_title"))&&f.club.plane.requirements.differences.push(n),delete f.temporary.difference):alert("Please select a difference that is required to book the plane solo!")}},i.remove_item=function(e,t){f.club.plane.requirements[e].splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon3=function(e){var e=e.split(";")[0],t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},f.approve_receipt_final=function(t){delete t.image,n.ApproveReceipt(t.id,t).then(function(e){e.success?f.receipts.splice(f.receipts.findIndex(function(e){return e.id===t.id}),1):alert("An error occurred: "+e.message),f.show_popup=!1,f.current_receipt={}})},f.reject_receipt_final=function(t){delete t.image,n.RejectReceipt(t.id,t).then(function(e){e.success?f.receipts.splice(f.receipts.findIndex(function(e){return e.id===t.id}),1):alert("An error occurred: "+e.message),f.show_popup=!1,f.current_receipt={}})},i.approve_receipt=function(e){f.current_receipt=e,0<f.current_receipt.modified_reimbursed_amount?f.show_popup="approve":f.approve_receipt_final(e)},i.reject_receipt=function(e){f.current_receipt=e,f.show_popup="reject"},i.close_popup=function(){f.show_popup=!1,f.current_receipt={}},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubSettingsController(e,t,n,o,i,r,a,s,c,l,d){var u=this;switch(u.user=null,u.allUsers=[],u.club={},u.club_id=o.globals.currentUser.current_club_admin.id,u.user=o.globals.currentUser,u.user_id=u.user.id,u.action=a.current.data.action,u.action){case"list":t.GetById(u.club_id).then(function(e){u.club.settings=e,u.club.settings.vat_registered=1==u.club.settings.vat_registered,u.club.settings.tpc_aircraft_surchages=1==u.club.settings.tpc_aircraft_surchages,u.club.settings.vat_rate=parseFloat(u.club.settings.vat_rate)});break;case"stripe_return":u.stripe_id=s.stripe_id,n.SaveStripeLink(u.club_id,u.stripe_id).then(function(e){console.log(e)});break;case"stripe_refresh":u.stripe_id=s.stripe_id,n.RefreshStripeLink(u.club_id,u.stripe_id).then(function(e){console.log(e)})}r.processFiles=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url;o="update_"+t;u.club.settings[t]=e[n].file,u.club.settings[t]=e[n].file.temp_path,u.club.settings[o]=!0}},r.save=function(){u.club.settings.update_logo||delete u.club.settings.logo,u.club.settings.update_invoice_logo||delete u.club.settings.invoice_logo,u.privacy_file?u.club.settings.privacy_terms=u.privacy_file:delete u.club.settings.privacy_terms,u.membership_file?u.club.settings.membership_terms=u.membership_file:delete u.club.settings.membership_terms,u.passenger_file?u.club.settings.passenger_terms=u.passenger_file:delete u.club.settings.passenger_terms,delete u.club.settings.membership_updated,delete u.club.settings.passenger_updated,delete u.club.settings.privacy_updated,delete u.club.settings.updated_at,delete u.club.settings.created_at,delete u.club.settings.gcl,delete u.club.settings.salt,delete u.club.settings.pepper,u.club.settings.vat_registered=u.club.settings.vat_registered?1:0,u.club.settings.tpc_aircraft_surchages=u.club.settings.tpc_aircraft_surchages?1:0,t.Update(u.club.settings).then(function(e){a.go("dashboard.manage_club")})},u.called_stripe_setup=!1,u.generate_stripe_link=function(){u.called_stripe_setup=!0,n.GenerateStripeLink(u.club.settings).then(function(e){console.log(e),e.success&&""!==e.onboarding_link?(alert("You will be redirected to Stripe - please complete the setup and you will be returned to ToAviate"),window.location=e.onboarding_link):(alert("Please try the link again! Stripe didn't seem to want to connect to ToAviate"),u.called_stripe_setup=!1)})},u.term_documents=[],r.processFiles2=function(e,t){for(var n=0;n<e.length;n++){var o=JSON.parse(e[n].file_return);e[n].file.temp_path=o.saved_url,e[n].file.save_name=o.files.file.name;o=(o=o.files.file.name).split(".").pop();switch(e[n].file.extension=o,t){case"privacy":u.privacy_file=e[n].file;break;case"membership":u.membership_file=e[n].file;break;case"passenger":u.passenger_file=e[n].file}}},r.delete_file=function(e){switch(e){case"privacy":u.club.settings.privacy_terms,u.club.settings.privacy_terms="";break;case"membership":u.club.settings.membership_terms,u.club.settings.membership_terms="";break;case"passenger":u.club.settings.passenger_terms,u.club.settings.passenger_terms=""}},r.remove_file=function(e,t){JSON.parse(e.file_return)},r.set_title=function(e){return e.save_name},r.back=function(){c.history.back()},r.get_icon=function(e){var e=e&&e.name?e.name:e,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},r.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");l.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){d.info("saveBlob method failed with the following exception:"),d.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){d.info("Download link method with simulated click failed with the following exception:"),d.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}function DashboardClubShopItemsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p){var m=this;m.user=null,m.allUsers=[],m.club={},m.page_title="",m.plane_document={},m.plane_documents=[];var f=[];switch(m.action=r.current.data.action,m.club_id=n.globals.currentUser.current_club_admin.id,m.user=n.globals.currentUser,m.user_id=m.user.id,m.action){case"add":m.page_title="Add a New Plane";break;case"edit":p.GetById(a.item_id).then(function(e){m.club.item=e.item,m.page_title="Edit an Item - "+m.club.item.title});break;case"list":p.GetByClubId(m.club_id).then(function(e){m.club.items=e.items})}i.back=function(){l.history.back()},i.save=function(){"add"==m.action?i.create():i.update()},i.create=function(){m.club.item.club_id=m.club_id,p.Create(m.club.item).then(function(e){r.go("dashboard.manage_club.shop_items")})},i.delete=function(e){confirm("Are you sure you would like to delete this item?")&&p.Delete(m.user.id,e.id).then(function(e){e.success?p.GetByClubId(m.club_id).then(function(e){m.club.items=e.items}):alert("An error occured when trying to delete this item.")})},i.update=function(){m.club.item.club_id=m.club_id,p.Update(m.club.item,m.user.id).then(function(e){r.go("dashboard.manage_club.shop_items")})},i.update_this_file=function(e){-1===f.indexOf(e.id)&&f.push(e.id)},i.remove_real_file=function(t){m.club.plane.plane_documents=$.grep(m.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(m.user.id,t.id).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(m.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,m.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.save_plane_documents=function(){},i.change_file_name=function(t){m.plane_documents=$.grep(m.plane_documents,function(e){return e.temp_path!=t.temp_path}),m.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),ItemService.Delete(m.user.id,t.id).then(function(){m.club.items=$.grep(m.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubShopSaleController(n,e,t,o,i,r,a,s,c,l,d){var u=this;i.to_refund=0,i.reason="",i.club_id=r.globals.currentUser.current_club_admin.id,u.club_id=i.club_id,i.club_settings={},i.new_client={first_name:"",last_name:"",email:""},i.items=[],i.item={title:"",quantity:1,vat:0,price:0},i.selected_client,i.selected_card,u.selected_voucher,i.members=[],i.show_direct_debit_details=!1,u.custom_item=!1;function _(){for(var e=0,t=0,n=0;n<i.items.length;n++)i.items[n].total=i.items[n].quantity*i.items[n].price,0<i.items[n].vat&&(this_vat=i.items[n].total*(i.items[n].vat/100),t+=this_vat),e+=i.items[n].total;i.the_vat=t,i.the_total=e}u.close_pay_now=function(){u.show_pay_now=!1,u.show_loading=!1},u.donConfirm=function(e,t){u.complete_now(e,t)},u.default_payment="new-card",u.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],u.savedCards=[],c.GetByClubId(u.club_id).then(function(e){u.shop_items=e.items}),s.GetById(i.club_id).then(function(e){i.club_settings=e,i.item.vat=parseFloat(i.club_settings.vat_rate),i.club_settings.vat_registered=1==i.club_settings.vat_registered}),t.GetByClubId(i.club_id).then(function(e){u.vouchers=e.items}),t.GetDiscountsByClubId(i.club_id).then(function(e){u.discounts=e.items}),d.GetPackagesByClubId(i.club_id).then(function(e){u.packages=e.items}),a.GetAllByClub(i.club_id).then(function(e){i.members=e,i.members.unshift({id:-12,first_name:"New",last_name:"Client"})}),i.delete_receipt=function(e){i.items.splice(e,1),_()},i.card_selected=function(e){(i.selected_card=e).id},i.member_selected=function(e){(i.selected_client=e)&&e.account_ending&&""!==e.account_ending?i.show_direct_debit_details=!0:i.show_direct_debit_details=!1,e&&e.id},i.selected_item,i.item_selected=function(e){i.selected_item=e},i.package_selected=function(e){i.selected_package=e},u.new_item_qty=1,u.add_selected_voucher=function(){var e;i.items.find(function(e){return e.voucher_id===u.selected_voucher.id})&&0<u.selected_voucher.id?i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).quantity=i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).quantity+1:0<u.selected_voucher.id&&((e=u.selected_voucher).quantity=1,e.item_id=u.selected_voucher.id,e.unit_price=u.selected_voucher.price,e.voucher_id=u.selected_voucher.id,u.selected_discount&&u.selected_discount.id&&0<u.selected_discount.id?e.discount_id=u.selected_discount.id:e.discount_id=0,e.vat_rate&&(e.vat=parseFloat(u.selected_voucher.vat_rate),delete e.vat_rate),i.items.push(e)),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},u.new_item_qty=1,_(),t.GetDiscountsByClubIdAndExperienceId(i.club_id,u.selected_voucher.id).then(function(e){u.discounts=e.items})},u.add_selected_discount=function(){var e=0,e=1==u.selected_discount.discount_type?u.selected_discount.discount.price:u.selected_voucher.price-u.selected_voucher.price*(u.selected_discount.percentage/100);i.items.find(function(e){return e.voucher_id===u.selected_voucher.id})&&0<u.selected_voucher.id&&(i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).price=e,i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).unit_price=e,i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).discount_id=u.selected_discount.id,i.items.find(function(e){return e.voucher_id===u.selected_voucher.id}).discount_code=u.selected_discount.discount_code),_()},i.add_selected_item=function(){var e;i.items.find(function(e){return e.item_id===i.selected_item.id})?i.items.find(function(e){return e.item_id===i.selected_item.id}).quantity=i.items.find(function(e){return e.item_id===i.selected_item.id}).quantity+u.new_item_qty:((e=i.selected_item).quantity=u.new_item_qty,e.item_id=i.selected_item.id,e.vat_rate&&(e.vat=parseFloat(i.selected_item.vat_rate),delete e.vat_rate),i.items.push(e)),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},u.new_item_qty=1,_()},i.selected_package,i.add_selected_package=function(){var e;i.items.find(function(e){return e.package_id===i.selected_package.id})?i.items.find(function(e){return e.package_id===i.selected_package.id}).quantity++:((e=i.selected_package).quantity=1,e.package_id=i.selected_package.id,e.vat_rate=parseFloat(i.club_settings.vat_rate),e.vat_rate&&(e.package_id=i.selected_package.id,e.vat=i.selected_package.vat_rate,delete e.vat_rate),i.items.push(e)),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},u.new_item_qty=1,_()},i.add_item=function(e){i.item=e,i.items.push(i.item),i.item={quantity:1,price:0,vat:parseFloat(i.club_settings.vat_rate),title:""},_()},u.complete_now=function(e,t){t={user_id:i.selected_client.user_id,club_id:i.club_id,user:i.selected_client,invoice_id:u.invoice_id,method:e,paymentIntent:t};o.CompleteCustom(t).then(function(e){e.success&&(console.log("complete",e),n(function(){l.go("dashboard.manage_club",{},{reload:!0})},2e3))})},u.invoice_id=0,i.ok=function(){u.show_loading=!0,-12==i.selected_client.id?(i.selected_client.first_name=i.new_client.first_name,i.selected_client.last_name=i.new_client.last_name,i.selected_client.email=i.new_client.email):(i.selected_client.first_name=i.selected_client.first_name,i.selected_client.last_name=i.selected_client.last_name,i.selected_client.email=i.selected_client.email);var e={items:i.items,user:i.selected_client,user_id:i.selected_client.user_id,club_id:i.club_id};o.CreateCustom(e).then(function(e){e.success?(u.invoice_id=e.invoice_id,u.send={club_id:e.club_id,user_id:e.user_id,invoice_id:e.invoice_id},a.GetMandate(e.user_id,e.club_id).then(function(e){e.success&&(u.info=e.info,u.savedCards=e.cards,0<u.savedCards.length?u.methods[1].visible=!0:u.methods[1].visible=!1,null==u.info?u.methods[0].visible=!1:u.methods[0].visible=!0,u.machine=e.machine,u.machine.success?u.methods[3].visible=!0:u.methods[3].visible=!1,u.show_pay_now=!0,u.show_loading=!1)})):u.show_loading=!1})},i.cancel=function(){l.go("dashboard.manage_club",{},{reload:!0})}}function DashboardClubVouchersAddController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={item:{}},f.page_title="",f.plane_document={},f.plane_documents=[];f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.charge_type=["brakes","session","plane"],f.discounts=[],f.planes=[],f.show_paid=!1,p.GetByClubId(f.club_id).then(function(e){f.experiences=e.items}),f.page_title="Add a Voucher",m.GetUniqueCode(f.club_id).then(function(e){f.club.item.code=e.code});var g,b=Stripe("pk_test_Ers4ZfdIMZ59ac4wKy6FDAH2"),h=b.elements().create("card",{hidePostalCode:!0,style:{base:{iconColor:"#666EE8",color:"#31325F",lineHeight:"40px",fontWeight:300,fontFamily:"Helvetica Neue",fontSize:"15px","::placeholder":{color:"#CFD7E0"}}}}),y=!1,v=!1;p.GetDiscountsByClubId(f.club_id).then(function(e){f.discounts=e.items}),i.$on("$viewContentLoaded",function(){clearTimeout(g),0==v&&(v=!0,g=setTimeout(function(){clearTimeout(g),0==y&&(y=!0,h.mount("#card-element"),document.getElementById("payment-form2").addEventListener("submit",function(e){e.preventDefault()}))},1500))}),i.check_code=function(){},i.back=function(){l.history.back()},i.save=function(){"add"==f.action?i.create():i.update()},i.create=function(){return f.club.item.experience&&f.club.item.experience.id?f.club.item.first_name&&f.club.item.last_name&&f.club.item.email?f.already_paid&&(f.club.item.price_paid<0||!f.club.item.payment_method)?(alert("Please fill in how much was paid and what payment method was used to complete the payment"),!1):(f.club.item.experience_title=f.club.item.experience.title,f.club.item.experience_id=f.club.item.experience.id,f.club.item.discount&&0<f.club.item.discount.id&&(f.club.item.discount_id=f.club.item.discount.id),f.club.item.club_id=f.club_id,void(f.already_paid?(e={payment_method:f.club.item.payment_method,amount:f.club.item.price_paid},f.club.item.price=f.club.item.price_paid,f.club.item.payment=e,delete f.club.item.payment_method,delete f.club.item.price_paid,m.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})):(e={name:document.getElementById("name").value,address_zip:document.getElementById("address-postcode").value},b.createToken(h,e).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={user_id:f.user.id,brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,exp_month:e.token.card.exp_month,exp_year:e.token.card.exp_year,funding:e.token.card.funding,name:e.token.card.name,address_postcode:e.token.card.address_zip,client_ip:e.token.client_ip},f.club.item.payment=e,delete f.club.item.experience,m.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})}))})))):(alert("You must enter the purchasor's first name, last name and email address."),!1):(alert("You must select an experience to issue this voucher..."),!1);var e},i.delete=function(){alert("Are you sure you would like to delete this plane?"),m.Delete(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,m.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.update_experience=function(){var e=f.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),f.club.item.expiry_date=new Date(e),f.club.item.price=f.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(f.club_id,f.club.item.experience.id).then(function(e){f.discounts=e.items})},i.update_discount=function(){1==f.club.item.discount.discount_type?f.club.item.price=f.club.item.discount.price:f.club.item.price=f.club.item.experience.price-f.club.item.experience.price*(f.club.item.discount.percentage/100)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubVouchersController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={item:{}},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.charge_type=["brakes","session","plane"],f.discounts=[],f.planes=[],p.GetByClubId(f.club_id).then(function(e){f.experiences=e.items}),m.GetByClubId(f.club_id).then(function(e){f.club.items=e.items}),i.check_code=function(){},i.back=function(){l.history.back()},i.save=function(){"add"==f.action?i.create():i.update()},i.create=function(){return f.club.item.experience&&f.club.item.experience.id?f.club.item.first_name&&f.club.item.last_name&&f.club.item.email?!f.already_paid||f.club.item.price_paid&&f.club.item.payment_method?(f.club.item.experience_title=f.club.item.experience.title,f.club.item.experience_id=f.club.item.experience.id,f.club.item.discount_id=f.club.item.discount.id,f.club.item.club_id=f.club_id,void(f.already_paid?(e={payment_method:f.club.item.payment_method,amount:f.club.item.price_paid},f.club.item.payment=e,delete f.club.item.payment_method,delete f.club.item.price_paid,m.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})):(e={name:document.getElementById("name").value,address_zip:document.getElementById("address-postcode").value},stripe.createToken(card,e).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={user_id:f.user.id,brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,exp_month:e.token.card.exp_month,exp_year:e.token.card.exp_year,funding:e.token.card.funding,name:e.token.card.name,address_postcode:e.token.card.address_zip,client_ip:e.token.client_ip},f.club.item.payment=e,delete f.club.item.experience,m.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})}))})))):(alert("Please fill in how much was paid and what payment method was used to complete the payment"),!1):(alert("You must enter the purchasor's first name, last name and email address."),!1):(alert("You must select an experience to issue this voucher..."),!1);var e},i.delete=function(){alert("Are you sure you would like to delete this plane?"),m.Delete(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,m.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.update_experience=function(){var e=f.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),f.club.item.expiry_date=new Date(e),f.club.item.price=f.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(f.club_id,f.club.item.experience.id).then(function(e){f.discounts=e.items})},i.update_discount=function(){1==f.club.item.discount.discount_type?f.club.item.price=f.club.item.discount.price:f.club.item.price=f.club.item.experience.price-f.club.item.experience.price*(f.club.item.discount.percentage/100)},i.add_item=function(e){"plane"===e&&(f.temporary.plane&&""!==f.temporary.plane?(f.club.item.planes||(f.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(f.temporary.plane,f.club.item.planes,new Array("plane_id"))&&f.club.item.planes.push(f.temporary.plane),delete f.temporary.plane):alert("Please select a plane that this activity be done on!"))},i.remove_item=function(e,t){f.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})},i.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,e[t].file.save_name=n.files.file.name;n=(n=n.files.file.name).split(".").pop();e[t].file.extension=n,f.plane_documents.push(e[t].file)}},i.set_title=function(e){return e.save_name},i.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},i.delete_poid=function(e){prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")},i.save_plane_documents=function(){},i.change_file_name=function(t){f.plane_documents=$.grep(f.plane_documents,function(e){return e.temp_path!=t.temp_path}),f.plane_documents.push(t)};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardClubVouchersEditController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m){var f=this;f.user=null,f.allUsers=[],f.club={item:{}},f.page_title="",f.plane_document={},f.plane_documents=[];var g=[];f.action=r.current.data.action,f.club_id=n.globals.currentUser.current_club_admin.id,f.user=n.globals.currentUser,f.user_id=f.user.id,f.charge_type=["brakes","session","plane"],f.discounts=[],f.planes=[],f.show_paid=!0,p.GetByClubId(f.club_id).then(function(e){f.experiences=e.items}),m.GetById(a.id).then(function(e){e.item.expiry_date=new Date(e.item.expiry_date),f.club.item=e.item}),i.update_experience=function(){var e=f.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),f.club.item.expiry_date=new Date(e),f.club.item.price=f.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(f.club_id,f.club.item.experience.id).then(function(e){f.discounts=e.items})},i.update_discount=function(){1==f.club.item.discount.discount_type?f.club.item.price=f.club.item.discount.price:f.club.item.price=f.club.item.experience.price-f.club.item.experience.price*(f.club.item.discount.percentage/100)},i.check_code=function(){},i.back=function(){l.history.back()},i.save=function(){"add"==f.action?i.create():i.update()},i.create=function(){return f.club.item.experience&&f.club.item.experience.id?f.club.item.first_name&&f.club.item.last_name&&f.club.item.email?!f.already_paid||f.club.item.price_paid&&f.club.item.payment_method?(f.club.item.experience_title=f.club.item.experience.title,f.club.item.experience_id=f.club.item.experience.id,f.club.item.discount_id=f.club.item.discount.id,f.club.item.club_id=f.club_id,void(f.already_paid?(e={payment_method:f.club.item.payment_method,amount:f.club.item.price_paid},f.club.item.payment=e,delete f.club.item.payment_method,delete f.club.item.price_paid,m.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})):(e={name:document.getElementById("name").value,address_zip:document.getElementById("address-postcode").value},stripe.createToken(card,e).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={user_id:f.user.id,brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,exp_month:e.token.card.exp_month,exp_year:e.token.card.exp_year,funding:e.token.card.funding,name:e.token.card.name,address_postcode:e.token.card.address_zip,client_ip:e.token.client_ip},f.club.item.payment=e,delete f.club.item.experience,m.Create(f.club.item).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})}))})))):(alert("Please fill in how much was paid and what payment method was used to complete the payment"),!1):(alert("You must enter the purchasor's first name, last name and email address."),!1):(alert("You must select an experience to issue this voucher..."),!1);var e},i.cancel=function(){m.CancelVoucher(f.user.id,f.club.item.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.delete=function(){alert("Are you sure you would like to delete this plane?"),m.CancelVoucher(f.user.id,f.club.item).then(function(e){})},i.update=function(){f.club.item.club_id=f.club_id,m.Update(f.club.item,f.user.id).then(function(e){r.go("dashboard.manage_club.vouchers",{},{reload:!0})})},i.update_experience=function(){var e=f.club.item.experience.valid_for;e=0<e?moment().day(+e):moment().year(2100),f.club.item.expiry_date=new Date(e),f.club.item.price=f.club.item.experience.price,p.GetDiscountsByClubIdAndExperienceId(f.club_id,f.club.item.experience.id).then(function(e){f.discounts=e.items})},i.update_discount=function(){1==f.club.item.discount.discount_type?f.club.item.price=f.club.item.discount.price:f.club.item.price=f.club.item.experience.price-f.club.item.experience.price*(f.club.item.discount.percentage/100)},i.add_item=function(e){"plane"===e&&(f.temporary.plane&&""!==f.temporary.plane?(f.club.item.planes||(f.club.item.planes=[]),0==function(e,t,n){for(var o=0;o<t.length;o++){for(var i=0,r=0;r<n.length;r++)t[o][n[r]]&&e[n[r]]&&t[o][n[r]]==e[n[r]]&&i++;if(i===n.length)return!0}return!1}(f.temporary.plane,f.club.item.planes,new Array("plane_id"))&&f.club.item.planes.push(f.temporary.plane),delete f.temporary.plane):alert("Please select a plane that this activity be done on!"))},i.remove_item=function(e,t){f.club.item.planes.splice(t,1)},i.update_this_file=function(e){-1===g.indexOf(e.id)&&g.push(e.id)},i.remove_real_file=function(t){f.club.plane.plane_documents=$.grep(f.club.plane.plane_documents,function(e){return e.id!=t.id}),PlaneDocumentService.Delete(f.user.id,t.id).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(current_files))})},i.remove_file=function(e,t){e=JSON.parse(e.file_return);PoidService.DeleteTmp(e.saved_url).then(function(e){e.success&&(f.plane_documents=[],i.processFiles(t))})};i.open=function(e){s.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},params:function(){return{id:e}},warning:function(){return"By deleting this plane, you will also cancel all reservations that this plane currently has."}}}).result.then(function(t){c.info("PRESSED GO: "+t.id),p.Delete(f.user.id,t.id).then(function(){f.club.items=$.grep(f.club.items,function(e){return e.id!=t.id})})},function(){c.info("Modal dismissed at: "+new Date)})}}function DashboardController(e,t,n,o,i,r,a){var s=this;if(!i.globals.currentUser&&0==a.CheckLoggedIn())return r.path("/login"),!1;function c(){n.GetTodayBookingsUser(s.user.id).then(function(e){s.bookings=e.bookings,s.to_pay=e.to_pay,s.to_complete_split=e.to_complete_split}),o.GetBookoutsToComplete(s.user.id).then(function(e){s.bookouts=e.bookouts})}s.user=i.globals.currentUser,s.bookings=[],s.bookouts=[],s.to_pay=[],s.to_complete_split=[],s.allUsers=[],s.clubs=[],s.force_show_admins=!1,(s.user&&s.user.access&&s.user.access.manager||s.user&&s.user.access&&s.user.access.instructor)&&(s.force_show_admins=!0),e.GetAdminClubs(s.user.id).then(function(e){e.success?(s.clubs=e.clubs,i.globals.currentUser.current_club_admin=s.clubs[0],t.put("globals",i.globals)):r.path("/login")}),c(),s.logout=function(){a.Logout(function(e){a.ClearCredentials(),t.remove("globals"),t.remove("session"),r.path("/login")})},s.cancel_bookout=function(e){if(!confirm("Are you sure you wish to cancel the bookout?"))return!1;o.CancelBookout(e).then(function(e){e.success?c():alert(e.message)})},s.cancel_booking=function(e){if(!confirm("Are you sure you wish to cancel the booking?"))return!1;o.DeleteBooking(s.user.id,e).then(function(e){e.success?c():alert(e.message)})}}function DashboardCourseSyllabusController(e,t,n,o,i,r,a,s,c,l){var d=this;switch(d.user=null,d.allUsers=[],d.action=i.current.data.action,d.user=t.globals.currentUser,d.club_id=t.globals.currentUser&&t.globals.currentUser.current_club_admin&&t.globals.currentUser.current_club_admin.id?t.globals.currentUser.current_club_admin.id:0,d.user_id=d.user.id,d.exams=[],d.action){case"add":d.page_title="Add a New Course";break;case"view":l.GetCourseById(r.course_id).then(function(e){d.course=e.item}),l.GetExamsByCourseId(r.course_id).then(function(e){d.course.exams=e.items}),l.GetLessonsByCourseId(r.course_id).then(function(e){d.course.lessons=e.items});break;case"view_lesson":l.GetLessonById(r.lesson_id).then(function(e){d.lesson=e.item}),l.GetBulletsByLessonId(r.lesson_id).then(function(e){d.lesson.bullets=e.bullets}),l.GetTemByLessonId(r.lesson_id).then(function(e){d.lesson.tem=e.items}),l.GetItemsByLessonId(r.lesson_id).then(function(e){d.lesson.items=e.items});break;case"list":l.GetCoursesByClubId(d.club_id).then(function(e){d.courses=e.items});break;case"list_member":l.GetCoursesByUserId(d.user.id).then(function(e){d.clubs=e.items})}o.back=function(){c.history.back()}}function DashboardCourseSyllabusViewController(e,t,n,o,i,r,a,s,c,l){var d=this;switch(d.user=null,d.allUsers=[],d.action=i.current.data.action,d.user=t.globals.currentUser,d.club_id=t.globals.currentUser&&t.globals.currentUser.current_club_admin&&t.globals.currentUser.current_club_admin.id?t.globals.currentUser.current_club_admin.id:0,d.user_id=d.user.id,d.exams=[],d.course={exams:[],lessons:[]},d.lesson={tem:[],bullets:{},items:[]},d.action){case"add":d.page_title="Add a New Course";break;case"view":d.course_id=r.course_id,l.GetCourseById(r.course_id).then(function(e){d.course=e.item,l.GetExamsByCourseId(r.course_id).then(function(e){d.course.exams=e.items}),l.GetLessonsByCourseId(r.course_id).then(function(e){d.course.lessons=e.items})});break;case"view_lesson":d.course_id=r.course_id,l.GetLessonById(r.lesson_id).then(function(e){d.lesson=e.item,l.GetBulletsByLessonId(r.lesson_id).then(function(e){d.lesson.bullets=e.bullets}),l.GetTemByLessonId(r.lesson_id).then(function(e){d.lesson.tem=e.items}),l.GetItemsByLessonId(r.lesson_id).then(function(e){d.lesson.items=e.items})});break;case"list":l.GetCoursesByClubId(d.club_id).then(function(e){d.courses=e.items})}o.back=function(){c.history.back()}}function DashboardInstructorBriefController(e,t,n,o,i,r,a,s,c,l,d){var u=this;switch(u.user=null,u.allUsers=[],u.action=i.current.data.action,u.user=t.globals.currentUser,u.club_id=t.globals.currentUser.current_club_instructor,u.user_id=u.user.id,u.exams=[],u.action){case"add":u.page_title="Add a New Course";break;case"view":l.GetCourseById(r.course_id).then(function(e){u.course=e.item,l.GetExamsByCourseId(r.course_id).then(function(e){u.course.exams=e.items}),l.GetLessonsByCourseId(r.course_id).then(function(e){u.course.lessons=e.items}),l.GetTagsByCourseId(r.course_id).then(function(e){u.all_tags=e.items})});break;case"view_lesson":u.selected_lesson=r.lesson_id,_();break;case"list":d.GetBookingsToBrief(u.user.id).then(function(e){u.briefings=e.briefings});break;case"debrief_list":d.GetBookingsToDebrief(u.user.id).then(function(e){u.briefings=e.briefings});break;case"debrief":u.plane_log_sheet_id=r.plane_log_sheet_id,u.booking_id=r.booking_id,console.log("STATEPARAMS: ",r),u.show_split=0,r.split_next_id&&0<r.split_next_id&&(u.split_next_id=r.split_next_id,u.show_split=1,console.log("SPLIT NEXT ID!!",u.split_next_id)),r.split_booking_id&&0<r.split_booking_id&&(u.split_booking_id=r.split_booking_id,u.show_split=1),0<u.plane_log_sheet_id?d.GetForForDebriefPls(u.plane_log_sheet_id).then(function(e){e.success?(u.competences=e.competences,u.course_id=e.course_id,u.record_club_id=e.club_id,u.lesson=e.lesson,u.all_items=e.all_items,u.my_search=u.lesson.id,u.student=e.student,u.instructor=e.instructor,u.plane_log_sheet=e.log_sheet,l.GetLessonsByCourseId(u.course_id).then(function(e){u.all_lessons=e.items}),l.GetTagsByCourseId(u.course_id).then(function(e){u.all_tags=e.items,u.selected_flight_tags=[]})):alert("We could not obtain the debriefing information for you...")}):d.GetForForDebrief(u.booking_id).then(function(e){e.success?(u.competences=e.competences,u.course_id=e.course_id,u.record_club_id=e.club_id,u.lesson=e.lesson,u.all_items=e.all_items,u.my_search=u.lesson.id,u.student=e.student,u.instructor=e.instructor,u.plane_log_sheet=e.log_sheet,l.GetLessonsByCourseId(u.course_id).then(function(e){u.all_lessons=e.items}),l.GetTagsByCourseId(u.course_id).then(function(e){u.all_tags=e.items,u.selected_flight_tags=[]})):alert("We could not obtain the debriefing information for you...")}),u.show_whole_lesson=!0}function _(){u.booking_id=r.booking_id,l.GetLessonById(u.selected_lesson).then(function(e){e.success&&(u.lesson=e.item,l.GetLessonsByCourseId(e.item.course_id).then(function(e){u.all_lessons=e.items}),l.GetBulletsByLessonId(u.selected_lesson).then(function(e){u.lesson.bullets=e.bullets}),l.GetTemByLessonId(u.selected_lesson).then(function(e){u.lesson.tem=e.items}),l.GetItemsByLessonId(u.selected_lesson).then(function(e){u.lesson.items=e.items}))})}u.show_all_lessons=!1,u.tag_full_flight=!0,u.update_flight_tag=function(){console.log(u.plane_log_sheet),u.tag_full_flight=!0},u.update_flight_full_flight=function(){5*Math.round(u.tag_flight_time/5)>60*u.plane_log_sheet.brakes_times_rounded&&(u.tag_flight_time=60*u.plane_log_sheet.brakes_times_rounded,u.tag_flight_time=5*Math.round(u.tag_flight_time/5)),5*Math.round(u.tag_flight_time/5)==0&&(u.tag_flight_time=5),u.tag_full_flight?(u.tag_flight_time=60*u.plane_log_sheet.brakes_times_rounded,u.tag_flight_time=5*Math.round(u.tag_flight_time/5)):(console.log("tag full flight"),console.log(u.plane_log_sheet))},u.show_whole_course=function(){u.show_all_lessons=!u.show_all_lessons,u.show_all_lessons?u.my_search="":u.my_search=u.lesson.id,u.my_search2=""},u.set_updated_search=function(){u.show_all_lessons||1<u.my_search2.length?u.my_search=u.my_search2:u.my_search=u.lesson.id},u.save_progress=function(){for(var e=[],t=0;t<u.all_items.length;t++)(u.all_items[t].result&&0<u.all_items[t].result||u.all_items[t].remarks&&""!==u.all_items[t].result)&&e.push(u.all_items[t]);if(e.length<1&&(!u.general_remarks||""==u.general_remarks))return alert("To save student records, you need to tick at least one student progress record item OR add a general remark"),!1;var n=u.lesson.id;1==u.lesson_completed&&u.next_lesson&&0<u.next_lesson.id&&(n=u.next_lesson.id),u.compiled_save={club_id:u.record_club_id,items:e,general_remarks:u.general_remarks,lesson_id:u.lesson.id,course_id:u.course_id,user_id:u.student.id,instructor_id:u.instructor.id,completed_by:u.user.id,plane_log_sheet_id:u.plane_log_sheet.id,next_lesson_id:n,completed:u.lesson_completed?1:0,booking_id:u.booking_id,flight_tags:u.selected_flight_tags},l.CreateTrainingRecord(u.compiled_save).then(function(e){e.success?(alert("THANK YOU!"),u.show_split&&u.split_next_id&&0<u.split_next_id?i.go("dashboard.my_account.book_in",{id:u.split_next_id}):i.go("dashboard.manage_user",{reload:!0})):alert("We could not save your training records...")})},u.tag_flight_time=0,u.add_tag=function(){if(u.selected_flight_tags.find(function(e){return e.id===u.flight_tag.id}))return alert("You already have this tag on this flight!"),!1;5*Math.round(u.tag_flight_time/5)>60*u.plane_log_sheet.brakes_times_rounded&&(u.tag_flight_time=60*u.plane_log_sheet.brakes_times_rounded,u.tag_flight_time=5*Math.round(u.tag_flight_time/5)),5*Math.round(u.tag_flight_time/5)==0&&(u.tag_flight_time=5),u.tag_full_flight&&(u.tag_flight_time=60*u.plane_log_sheet.brakes_times_rounded,u.tag_flight_time=5*Math.round(u.tag_flight_time/5)),u.flight_tag.logging_time=u.tag_flight_time,u.selected_flight_tags.push(u.flight_tag),u.flight_tag="",u.tag_flight_time=60*u.plane_log_sheet.brakes_times_rounded,u.tag_flight_time=5*Math.round(u.tag_flight_time/5),u.tag_full_flight=!0},u.delete_tag=function(e,t){u.selected_flight_tags.splice(t,1)},u.tag_time_to_five=function(){u.tag_flight_time%5!=0&&(u.tag_flight_time=5*Math.round(u.tag_flight_time/5))},u.save_edit_record=function(){console.log("SAVE THE UPDATE NOW!! WHOOP WHOOP!!"),console.log("FLIGHT TAGS : ",u.selected_flight_tags);for(var e=[],t=0;t<u.all_items.length;t++)(u.all_items[t].result&&0<u.all_items[t].result||u.all_items[t].remarks&&""!==u.all_items[t].result)&&e.push(u.all_items[t]);if(e.length<1&&(!u.general_remarks||""==u.general_remarks))return alert("To save student records, you need to tick at least one student progress record item OR add a general remark"),!1;var n=u.lesson.id;1==u.lesson_completed&&u.next_lesson&&0<u.next_lesson.id&&(n=u.next_lesson.id),u.compiled_save={club_id:u.record_club_id,items:e,general_remarks:u.general_remarks,lesson_id:u.lesson.id,course_id:u.course_id,user_id:u.student.id,instructor_id:u.instructor.id,completed_by:u.user.id,plane_log_sheet_id:u.plane_log_sheet.id,next_lesson_id:n,completed:u.lesson_completed?1:0,booking_id:u.booking_id,flight_tags:u.selected_flight_tags},console.log("COMPILED SAVE"),console.log(u.compiled_save),console.log("COMPILED SAVE")},u.lesson={},u.show_dropdown=!1,u.change_lesson=function(){_(),u.show_dropdown=!1},u.go_book_out=function(){u.booking_id;d.SetBookingToBriefed(u.booking_id).then(function(e){e.success?i.go("dashboard.my_account.bookout_with_booking",{booking_id:u.booking_id}):alert("Could not complete the briefing!")})},o.back=function(){c.history.back()}}function DashboardStudentRecordsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p){var m=this;switch(m.user=null,m.allUsers=[],m.action=r.current.data.action,m.user=n.globals.currentUser,m.user_id=m.user.id,m.exams=[],m.action){case"student_records":_.GetAllByClubStudents(m.club_id).then(function(e){m.courses=e.courses,m.members=e.members});break;case"student_record":console.log("view list of existing courses",m.user_id),m.student_id=m.user_id,e.GetAllForUser(m.user_id).then(function(e){m.clubs=e.clubs,m.clubs.length<2&&0<m.clubs.length&&(m.club_id=m.clubs[0].id,m.update_club_selector())})}function f(e,t,n){var o=n.toLowerCase(),t=(t=e+" "+t).toLowerCase();return 2<n.length&&-1<t.indexOf(o)}function g(e,t,n){t=t.toLowerCase(),n=n.toLowerCase(),e=e.toLowerCase();return 2<e.length&&-1<t.indexOf(e)||2<e.length&&-1<n.indexOf(e)}m.show_record=!1,m.show_add_exam=!1,m.update_club_selector=function(){d.GetCoursesByClubId(m.club_id).then(function(e){m.courses=e.items})},m.load_records=function(){m.member&&m.course?(m.student_id=m.member.user_id,m.course_id=m.course.id,d.GetStudentTrainingRecords(m.student_id,m.course_id).then(function(e){m.show_record=!0,m.all_items=e.all_items,m.student=e.student,m.training_records=e.training_records,m.exams=e.exams,m.exam_records=e.exam_records,m.course_totals=e.course_hours,m.log_sheets=e.log_sheets})):alert("You need to select a member and a course to see their training records")},m.get_initial=function(e){return e.charAt(0)},m.list_pilots=function(e){var t="",n="",t="PIC: "+m.get_pic(e),n=m.get_put(e);return p.getTrustedHtml("<div>"+(t=t&&""==t?"No PIC set yet!":t)+" "+(n=n&&""!==n?"<br />PUT: "+n:n)+"</div>")},m.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=m.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=m.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=m.get_initial(e.first_name)+". "+e.last_name),t},m.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=m.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=m.get_initial(e.first_name)+". "+e.last_name),t},m.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},m.clean_times=function(e){return e.substring(0,5)},m.search3=function(e){return!m.my_search3||""==m.my_search3||(!!function(e,t){if(e.length<2)return!1;{if(!(e&&e.length<=3)){var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return!0;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return!0}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return!0}return!1}if(-1<t.indexOf(e))return!0}}(m.my_search3,e.flight_date)||(!!f(e.first_name,e.last_name,m.my_search3)||(!!f(e.pic_first_name,e.pic_last_name,m.my_search3)||(!!f(e.instructor_first_name,e.instructor_last_name,m.my_search3)||(t=e.registration,n=m.my_search3,o=n.toLowerCase().replace("-",""),t=(t=t.replace("-","")).toLowerCase(),2<n.length&&-1<t.indexOf(o)||(!!g(m.my_search3,e.departure_airport,e.departure_airport_code)||!!g(m.my_search3,e.destination_airport,e.destination_airport_code)))))));var t,n,o},m.load_records_user=function(){m.course?(m.course_id=m.course.id,d.GetStudentTrainingRecords(m.student_id,m.course_id).then(function(e){m.show_record=!0,m.all_items=e.all_items,m.student=e.student,m.training_records=e.training_records,m.exams=e.exams,m.exam_records=e.exam_records,m.course_totals=e.course_hours,m.log_sheets=e.log_sheets})):alert("You need to select a course to see your training records")},m.load_selected_flight=function(e){},m.add_exam_record=function(){m.new_exam.user_id=m.student_id,m.new_exam.course_id=m.course_id,d.CreateExamRecord(m.new_exam).then(function(e){e.success?(m.load_records(),m.show_add_exam=!1):alert("The exam could not be added")})},m.get_remarks=function(t,e){e=e.items.find(function(e){return e.lesson_item_id===t});return e?e.remarks:""},m.get_result=function(t,e){e=e.items.find(function(e){return e.lesson_item_id===t});return e?e.grade_name:""},m.get_result3=function(t){var e=record.items.find(function(e){return e.lesson_item_id===t});return e?e.grade_name:""},m.get_competence=function(t,e){var n=e.items.find(function(e){return e.lesson_item_id===t}),e="";return n&&n.grade_colour&&n.grade_name&&(p.getTrustedHtml('<span style="color: '+n.grade_colour+'" ><i class="fa fa-'+n.grade_icon+'" style="color: '+n.grade_colour+'"></i></span>'),e=p.trustAsHtml('<span style="color: '+n.grade_colour+'" ><i class="fa fa-'+n.grade_icon+'" style="color: '+n.grade_colour+'"></i></span>')),n?e:""},m.get_competence2=function(e){var t="";return e&&e.grade_colour&&e.grade_name&&(p.getTrustedHtml('<span style="color: '+e.grade_colour+'" ><i class="fa fa-'+e.grade_icon+'" style="color: '+e.grade_colour+'"></i></span>'),t=p.trustAsHtml('<span style="color: '+e.grade_colour+'" ><i class="fa fa-'+e.grade_icon+'" style="color: '+e.grade_colour+'"></i></span>')),e?t:""},m.get_flight_date=function(t,e){e=e.items.find(function(e){return e.lesson_item_id===t});return e?e.flight_date:""},m.user_can_edit=!1,m.get_record_details=function(t,e){var n=e.items.find(function(e){return e.lesson_item_id===t});if(n){e="<h4>Training Record Details</h4><table class='inner_overlay_tble'>";return n.flight_date&&""!==n.flight_date&&(e+="<tr><td>Flight Date:</td><td>"+n.flight_date+"</td></tr>"),0<n.instructor_id&&""!==n.instructor_first_name&&(e+="<tr><td><span class='instructor'>Instructor:</span></td><td>"+m.get_initial(n.instructor_first_name)+" "+n.instructor_last_name+"</td></tr>"),0<n.completed_by&&""!==n.completed_by_first_name&&n.completed_by!==n.instructor_id&&(e+="<tr><td><span class='instructor'>Record By:</span></td><td>"+m.get_initial(n.completed_by_first_name)+" "+n.completed_by_last_name+"</td></tr>"),n.remarks&&""!==n.remarks&&(e+="<tr><td><span class='instructor'>Remarks:</td><td></td></tr><tr><td colspan='2'>"+n.remarks+"</td> </tr>"),e&&""!==e&&(e+="</table>"),p.getTrustedHtml(e)}return" "},m.get_record_details2=function(e){if(e){var t="<h4>Training Record Details</h4><table class='inner_overlay_tble'>";return e.flight_date&&""!==e.flight_date&&(t+="<tr><td>Flight Date:</td><td>"+e.flight_date+"</td></tr>"),e.registration&&""!==e.registration&&(t+="<tr><td>Aircraft:</td><td>"+e.registration+"</td></tr>",t+="<tr><td>Type:</td><td>"+e.plane_type+"</td></tr>"),0<e.instructor_id&&""!==e.instructor_first_name&&(t+="<tr><td><span class='instructor'>Instructor:</span></td><td>"+m.get_initial(e.instructor_first_name)+" "+e.instructor_last_name+"</td></tr>"),0<e.completed_by&&""!==e.completed_by_first_name&&e.completed_by!==e.instructor_id&&(t+="<tr><td><span class='instructor'>Record By:</span></td><td>"+m.get_initial(e.completed_by_first_name)+" "+e.completed_by_last_name+"</td></tr>"),e.remarks&&""!==e.remarks&&(t+="<tr><td><span class='instructor'>Remarks:</td><td></td></tr><tr><td colspan='2'>"+e.remarks+"</td> </tr>"),t&&""!==t&&(t+="</table>"),p.getTrustedHtml(t)}return"This objective has not yet been marked as complete by your instructor"},m.get_exam=function(t){var e=m.exam_records.find(function(e){return e.exam_id===t});return e||""},m.open_training_detail=function(e,t){m.show_popup=!0,show_edit_training_record=!1,m.show_popup_name="see_records",m.flight_detail_id=e,m.user_can_edit=m.user_can_edit_record(),m.selected_flight=t,m.selected_record={},m.selected_record_remarks="",d.GetStudentTrainingRecordsForFlight(m.student_id,m.course_id,m.flight_detail_id).then(function(e){m.competences=e.competences,m.selected_record=e.all_items,m.selected_record_remarks=e.general_remarks,m.this_entry=e.this_entry})},m.close_popup=function(){m.show_popup=!1,m.show_edit_training_record=!1,m.selected_record={},m.selected_record_remarks="",m.this_entry={}},i.back=function(){l.history.back()},m.set_updated_search=function(){m.show_all_lessons||1<m.my_search2.length?m.my_search=m.my_search2:m.my_search=m.lesson.id},m.all_tags=[],m.show_edit_training_record=!1,m.show_edit_record=function(){m.show_edit_training_record=!0,m.lesson=m.selected_record,m.plane_log_sheet=m.selected_flight,console.log("PLS : ",m.plane_log_sheet),console.log("TAGS : ",m.plane_log_sheet.flight_tags),d.GetTagsByCourseId(m.course_id).then(function(e){for(var t=0;t<e.items.length;t++)e.items.flight_tag_id=e.items.id;m.all_tags=e.items}),m.selected_flight_tags=m.plane_log_sheet.flight_tags;for(var e=0;e<m.selected_flight_tags.length;e++)m.selected_flight_tags[e].logging_time=5*Math.round(60*m.selected_flight_tags[e].tag_time/5);d.GetExamsByCourseId(m.course_id).then(function(e){m.course.exams=e.items}),d.GetLessonsByCourseId(m.course_id).then(function(e){m.course.lessons=e.items}),m.is_lesson_completed=1==m.this_entry.completed},m.tag_flight_time=0,m.add_tag=function(){if(m.selected_flight_tags.find(function(e){return e.flight_tag_id===m.flight_tag.id}))return alert("You already have this tag on this flight!"),!1;m.flight_tag.flight_tag_id=m.flight_tag.id,5*Math.round(m.tag_flight_time/5)>60*m.plane_log_sheet.brakes_times_rounded&&(m.tag_flight_time=60*m.plane_log_sheet.brakes_times_rounded,m.tag_flight_time=5*Math.round(m.tag_flight_time/5)),5*Math.round(m.tag_flight_time/5)==0&&(m.tag_flight_time=5),m.tag_full_flight&&(m.tag_flight_time=60*m.plane_log_sheet.brakes_times_rounded,m.tag_flight_time=5*Math.round(m.tag_flight_time/5)),m.flight_tag.logging_time=m.tag_flight_time,m.selected_flight_tags.push(m.flight_tag),m.flight_tag="",m.tag_flight_time=60*m.plane_log_sheet.brakes_times_rounded,m.tag_flight_time=5*Math.round(m.tag_flight_time/5),m.tag_full_flight=!0},m.delete_tag=function(e,t){m.selected_flight_tags.splice(t,1)},m.tag_time_to_five=function(){m.tag_flight_time%5!=0&&(m.tag_flight_time=5*Math.round(m.tag_flight_time/5))},m.save_edit_record=function(){console.log("SAVE THE UPDATE NOW!! WHOOP WHOOP!!"),console.log("THIS ENTRY : ",m.this_entry),console.log("FLIGHT TAGS : ",m.selected_flight_tags),console.log("SELECTED RECORD?? : ",m.selected_record);for(var e,t=[],n=0;n<m.selected_record.length;n++)m.selected_record[n].this_entry&&(m.selected_record[n].this_entry.result||m.selected_record[n].this_entry.remarks)&&(-1<m.selected_record[n].this_entry.result||""!==m.selected_record[n].this_entry.remarks)&&(e={remarks:m.selected_record[n].this_entry.remarks,result:m.selected_record[n].this_entry.result,lesson_item_id:m.selected_record[n].id},t.push(e));if(console.log("COMPILED ITEMS: ",t),t.length<1&&(!m.general_remarks||""==m.general_remarks))return alert("To save student records, you need to tick at least one student progress record item OR add a general remark"),!1;var o=m.this_entry.next_lesson_id;console.log("NEXT LESSON: ",o),1==m.lesson_completed&&m.next_lesson&&0<m.next_lesson.id&&(o=m.next_lesson.id),console.log("NEXT LESSON: ",o),console.log("vm.booking_id : ",m.booking_id),m.compiled_save={update_record_id:m.this_entry.id,club_id:m.this_entry.club_id,items:t,general_remarks:m.this_entry.general_remarks,lesson_id:m.this_entry.lesson_id,course_id:m.this_entry.course_id,user_id:m.this_entry.user_id,instructor_id:m.this_entry.instructor_id,completed_by:m.this_entry.completed_by,plane_log_sheet_id:m.selected_flight.id,next_lesson_id:o,edited_by:m.user.id,completed:m.lesson_completed?1:0,flight_tags:m.selected_flight_tags,edit_reason:m.edit_reason},console.log("COMPILED SAVE"),console.log(m.compiled_save),console.log("COMPILED SAVE"),d.UpdateTrainingRecord(m.compiled_save,m.this_entry.id).then(function(e){e.success?(alert("THANK YOU!"),d.GetStudentTrainingRecords(m.student_id,m.course_id).then(function(e){m.show_record=!0,m.all_items=e.all_items,m.student=e.student,m.training_records=e.training_records,m.exams=e.exams,m.exam_records=e.exam_records,m.course_totals=e.course_hours,m.log_sheets=e.log_sheets}),m.show_edit_training_record=!1,m.close_popup(),m.lesson={},m.plane_log_sheet={},m.compiled_save={},m.this_entry={}):alert("We could not save your training records...")})},m.tag_full_flight=!0,m.update_flight_tag=function(){console.log(m.plane_log_sheet),m.tag_full_flight=!0},m.update_flight_full_flight=function(){5*Math.round(m.tag_flight_time/5)>60*m.plane_log_sheet.brakes_times_rounded&&(m.tag_flight_time=60*m.plane_log_sheet.brakes_times_rounded,m.tag_flight_time=5*Math.round(m.tag_flight_time/5)),5*Math.round(m.tag_flight_time/5)==0&&(m.tag_flight_time=5),m.tag_full_flight?(m.tag_flight_time=60*m.plane_log_sheet.brakes_times_rounded,m.tag_flight_time=5*Math.round(m.tag_flight_time/5)):(console.log("tag full flight"),console.log(m.plane_log_sheet))},m.user_can_edit_record=function(){var e=!!m.user.access.manager.find(function(e){return e===m.training_records.club_id});return m.training_records.instructor_id==m.user_id||m.user_id==m.training_records.completed_by||e?console.log("should have access to edit this record"):console.log("should NOT have access to edit this record - tempo return true though"),!0}}function DashboardUserInstructorController(e,r,t,n,o,i,a,s,c,l,d,u,_){var p=this;p.user=null,p.allUsers=[],p.club={},p.page_title="",p.club.member={},p.imported_new_headers=[],p.action=c.current.data.action,p.user=i.globals.currentUser,p.user_id=p.user.id,p.no_show_cols=["membership_start","membership_id","selected"],s.sortType="Email",s.sortReverse=!1,s.searchTool="",s.mytime=new Date,s.hstep=1,s.mstep=15,p.days=[{day:"Monday",from_variable:"monday_from_time",to_variable:"monday_to_time",disabled_variable:"monday_disabled"},{day:"Tuesday",from_variable:"tuesday_from_time",to_variable:"tuesday_to_time",disabled_variable:"tuesday_disabled"},{day:"Wednesday",from_variable:"wednesday_from_time",to_variable:"wednesday_to_time",disabled_variable:"wednesday_disabled"},{day:"Thursday",from_variable:"thursday_from_time",to_variable:"thursday_to_time",disabled_variable:"thursday_disabled"},{day:"Friday",from_variable:"friday_from_time",to_variable:"friday_to_time",disabled_variable:"friday_disabled"},{day:"Saturday",from_variable:"saturday_from_time",to_variable:"saturday_to_time",disabled_variable:"saturday_disabled"},{day:"Sunday",from_variable:"sunday_from_time",to_variable:"sunday_to_time",disabled_variable:"sunday_disabled"}];var m=new Date;m.setHours(9),m.setMinutes(0);var f=moment.utc("2021-01-01T18:15:00Z").toISOString();switch(t.GetAvailability(p.user.id).then(function(e){p.available_times=e;for(var t=0;t<p.available_times.length;t++)p.available_times[t].monday_from_time==p.available_times[t].monday_to_time&&(p.available_times[t].monday_from_time=m,p.available_times[t].monday_to_time=f),p.available_times[t].tuesday_from_time==p.available_times[t].tuesday_to_time&&(p.available_times[t].tuesday_from_time=m,p.available_times[t].tuesday_to_time=f),p.available_times[t].wednesday_from_time==p.available_times[t].wednesday_to_time&&(p.available_times[t].wednesday_from_time=m,p.available_times[t].wednesday_to_time=f),p.available_times[t].thursday_from_time==p.available_times[t].thursday_to_time&&(p.available_times[t].thursday_from_time=m,p.available_times[t].thursday_to_time=f),p.available_times[t].friday_from_time==p.available_times[t].friday_to_time&&(p.available_times[t].friday_from_time=m,p.available_times[t].friday_to_time=f),p.available_times[t].saturday_from_time==p.available_times[t].saturday_to_time&&(p.available_times[t].saturday_from_time=m,p.available_times[t].saturday_to_time=f),p.available_times[t].sunday_from_time==p.available_times[t].sunday_to_time&&(p.available_times[t].sunday_from_time=m,p.available_times[t].sunday_to_time=f),p.available_times[t].monday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].monday_from_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].monday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].monday_to_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].monday_disabled=parseInt(p.available_times[t].monday_disabled),p.available_times[t].tuesday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].tuesday_from_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].tuesday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].tuesday_to_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].tuesday_disabled=parseInt(p.available_times[t].tuesday_disabled),p.available_times[t].wednesday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].wednesday_from_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].wednesday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].wednesday_to_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].wednesday_disabled=parseInt(p.available_times[t].wednesday_disabled),p.available_times[t].thursday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].thursday_from_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].thursday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].thursday_to_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].thursday_disabled=parseInt(p.available_times[t].thursday_disabled),p.available_times[t].friday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].friday_from_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].friday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].friday_to_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].friday_disabled=parseInt(p.available_times[t].friday_disabled),p.available_times[t].saturday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].saturday_from_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].saturday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].saturday_to_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].saturday_disabled=parseInt(p.available_times[t].saturday_disabled),p.available_times[t].sunday_from_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].sunday_from_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].sunday_to_time=new Date(luxon.DateTime.fromISO("2021-01-01T"+p.available_times[t].sunday_to_time+"Z").setZone("UTC").toHTTP()),p.available_times[t].sunday_disabled=parseInt(p.available_times[t].sunday_disabled);1==p.available_times.length&&(p.available_times[0].monday_from_time==p.available_times[0].monday_to_time&&(p.available_times[0].monday_from_time=m,p.available_times[0].monday_to_time=f),p.available_times[0].tuesday_from_time==p.available_times[0].tuesday_to_time&&(p.available_times[0].tuesday_from_time=m,p.available_times[0].tuesday_to_time=f),p.available_times[0].wednesday_from_time==p.available_times[0].wednesday_to_time&&(p.available_times[0].wednesday_from_time=m,p.available_times[0].wednesday_to_time=f),p.available_times[0].thursday_from_time==p.available_times[0].thursday_to_time&&(p.available_times[0].thursday_from_time=m,p.available_times[0].thursday_to_time=f),p.available_times[0].friday_from_time==p.available_times[0].friday_to_time&&(p.available_times[0].friday_from_time=m,p.available_times[0].friday_to_time=f),p.available_times[0].saturday_from_time==p.available_times[0].saturday_to_time&&(p.available_times[0].saturday_from_time=m,p.available_times[0].saturday_to_time=f),p.available_times[0].sunday_from_time==p.available_times[0].sunday_to_time&&(p.available_times[0].sunday_from_time=m,p.available_times[0].sunday_to_time=f),p.selected_club=p.available_times[0],p.selected_now=$.grep(p.available_times,function(e){return e.club_id==p.selected_club.club_id}),p.available_time=p.selected_now[0])}),s.ismeridian=!1,s.toggleMode=function(){s.ismeridian=!s.ismeridian},s.update_time=function(e){var t=new Date;t.setHours(14),t.setMinutes(0),p.available_time[e]=t},s.changed_time=function(e){console.log("Time changed to: "+p.available_time[e])},s.disable_time=function(e){p.available_time[e]=!p.available_time[e]},s.change_club=function(){p.selected_now=$.grep(p.available_times,function(e){return e.club_id==p.selected_club.club_id}),p.available_time=p.selected_now[0]},s.save_club_times=function(){t.SetAvailability(p.available_time).then(function(e){}),p.available_times=$.grep(p.available_times,function(e){return e.club_id!=p.available_time.club_id}),p.available_times.push(p.available_time),c.go("dashboard.manage_user.instructor_availability")},p.action){case"add":p.page_title="Add a New member";break;case"edit":r.GetMemberPlanes(l.member_id,p.club_id).then(function(e){p.club.planes=e}),r.GetById(l.member_id,p.club_id).then(function(e){p.club.member=e,p.club.member.is_manager=1==p.club.member.is_manager,p.club.member.approved=1==p.club.member.approved,p.club.member.instructor=1==p.club.member.instructor,p.club.member.membership_start=Date.parse(p.club.member.membership_start),p.page_title="Edit a Member - "+p.club.member.first_name+" "+p.club.member.last_name,p.club.member.membership_start=new Date(p.club.member.membership_start)}),n.GetAllByClub(p.club_id).then(function(e){p.club.memberships=e});break;case"list":r.GetAllByClub(p.club_id).then(function(e){p.club.members=e}),n.GetAllByClub(p.club_id).then(function(e){p.club.memberships=e}),s.checkAll=function(){s.selectedAll?s.selectedAll=!0:s.selectedAll=!1,angular.forEach(p.club.members,function(e){e.selected=s.selectedAll})}}s.back=function(){_.history.back()},s.save=function(){"add"==p.action?s.create():s.update()},s.csvToJSON=function(e){var t=e.csv.split(/\r\n|\n/),n=[],o=0;t[0]+=",membership_id,membership_start,selected";for(var i=1;i<t.length;i++)t[i]+=",membership_id,membership_start,true";var r=t[0].split(e.separator).length,a=[];e.header&&(a=t[0].split(e.separator),p.imported_headers=a,o=1);for(var s=o;s<t.length;s++){var c={},l=t[s].split(new RegExp(e.separator+'(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)'));if(l.length===r){if(e.header)for(i=0;i<a.length;i++)c[a[i]]=l[i];else for(var d=0;d<l.length;d++)c[d]=l[d];n.push(c)}}return n},s.processData=function(){allText=p.import_users;var e={csv:p.import_users,separator:",",header:!0};p.imported_users=s.csvToJSON(e);for(var t=0;t<p.imported_users.length;t++)p.imported_users[t].membership_start?p.imported_users[t].membership_start=new Date(p.imported_users[t].membership_start):p.imported_users[t].membership_start=new Date,p.imported_users[t].membership_id=4,p.imported_users[t].membership={membership_id:4,membership_name:"Annual Membership"}},p.user_columns={first_name:"First Name",last_name:"Last Name",email:"Email Address",dob:"Date of Birth",membership_number:"Membership Number",membership_start:"Membership Start Date",membership_id:"Membership Name"},s.import_column=function(e){},s.import_users=function(){if(p.imported_users=$.grep(p.imported_users,function(e){return"false"!=e.selected}),-1<p.imported_new_headers.indexOf("first_name")&&-1<p.imported_new_headers.indexOf("last_name")&&-1<p.imported_new_headers.indexOf("email")){for(var e=0;e<p.imported_users.length;e++)p.imported_users[e].membership&&p.imported_users[e].membership.membership_id&&(p.imported_users[e].membership_id=p.imported_users[e].membership.membership_id,delete p.imported_users[e].membership);p.imported_new_headers.push("membership_id"),p.imported_new_headers.push("membership_start");for(var t=[],n=0;n<p.imported_users.length;n++){for(var o={user:{},club_id:p.club_id},i=0;i<p.imported_new_headers.length;i++)p.imported_new_headers[i]&&("first_name"==p.imported_new_headers[i]||"last_name"==p.imported_new_headers[i]||"dob"==p.imported_new_headers[i]||"email"==p.imported_new_headers[i]?o.user[p.imported_new_headers[i]]=p.imported_users[n][Object.keys(p.imported_users[n])[i]]:"membership_start"==p.imported_new_headers[i]||"membership_id"==p.imported_new_headers[i]?o[p.imported_new_headers[i]]=p.imported_users[n][p.imported_new_headers[i]]:o[p.imported_new_headers[i]]=p.imported_users[n][Object.keys(p.imported_users[n])[i]]);t.push(o)}r.CreateMany(t).then(function(e){c.go("dashboard.manage_club.members")})}else alert("You must select the First Name, Last Name and Email Address to be able to add the user to the system!")},s.create=function(){p.club.member.club_id=p.club_id,r.Create(p.club.member).then(function(e){c.go("dashboard.manage_club.members")})},s.delete=function(){alert("Are you sure you would like to delete this membership?"),r.Update(p.club.membership).then(function(e){})},s.update=function(){p.club.member.club_id=p.club_id,r.Update(p.club.member).then(function(e){c.go("dashboard.manage_club.members")}),r.SaveMemberPlanes(p.club.member.id,p.club.member.club_id,p.club.planes).then(function(e){})},s.selected_members=function(e){p.selected_members=$.grep(p.club.members,function(e){return 1==e.selected});for(var t=0;t<p.selected_members.length;t++)p.selected_members[t].approved="approve"==e?1:0,r.Update(p.selected_members[t]).then(function(e){});c.go("dashboard.manage_club.members")},s.update_membership=function(e,t){p.club.member.membership_id=e.membership_id,p.club.member.membership_name=e.membership_name};s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return"By deleting this membership, you will also cancel all reservations that this membership currently has."}}}).result.then(function(t){u.info("PRESSED GO: "+t),r.Delete(t).then(function(){p.club.members=$.grep(p.club.members,function(e){return e.id!=t})})},function(){u.info("Modal dismissed at: "+new Date)})}}function DashboardUserInstructorHolidayController(e,r,t,n,a,o,i,s,c,l,d,u,_,p,m,f){var g=this;s.va1="123",g.user=null,g.allUsers=[],g.club={},g.page_title="",g.club.member={},g.imported_new_headers=[],g.action=c.current.data.action,g.user=o.globals.currentUser,g.user_id=g.user.id,g.no_show_cols=["membership_start","membership_id","selected"];var b=new Date,h=Math.floor(8),o=Math.floor(18),h=new Date(b.getFullYear(),b.getMonth(),b.getDate(),h,0,0),o=new Date(b.getFullYear(),b.getMonth(),b.getDate(),o,0,0);function y(e,t){var n=s.myDatetimeRange.date[t],o=n.getDate(),i=n.getMonth(),r=n.getFullYear(),e=e[t],t=e.slice(0,2),e="00"==(e=e.slice(3,5)).toString()?0:e;return n=new Date(r,i,o,t,e,0)}s.myDatetimeRange={date:{from:h,to:o},time:{from:480,to:1080,step:15,minRange:15,hours24:!0}},s.myDatetimeLabels={date:{from:"Start date",to:"End date"}},s.toggle=!0,s.toggleDirective=function(){s.toggle=!s.toggle},s.whentimechangedata={},s.overridePicker=!0,s.whenTimeChange=function(e){var t=y(e,"from"),n=y(e,"to");s.myDatetimeRange.date.from=t,s.myDatetimeRange.date.to=n,s.whentimechangedata=e},s.timeRangePicker={time:{from:480,to:1020,step:15,minRange:15,hours24:!0}},s.dateRangePicker={date:{from:new Date,to:new Date}};h=new Date,o=new Date(h.getTime()-864e6);s.datePickerWithRange={date:{from:new Date,to:new Date,max:h,min:o},time:{from:420,to:1020,step:15,minRange:15,hours24:!0}};o=new Date,o.getDate(),o.getMonth(),o.getFullYear();s.events=[],a.GetAll(g.user.id).then(function(e){for(var t=0;t<e.length;t++)s.events.push({id:e[t].id,title:e[t].title,start:new Date(e[t].from_date),end:new Date(e[t].to_date),allDay:e[t].allDay,className:["customFeed"]})}),s.alertOnEventClick=function(e,t,n){s.alertMessage=e.title+" was clicked "},s.alertOnDrop=function(e,t,n,o,i,r){a.Update(g.user.id,e).then(function(e){}),s.alertMessage="Event Updated"},s.alertOnResize=function(e,t,n,o,i,r){a.Update(g.user.id,e).then(function(e){}),s.alertMessage="Event Updated"},s.addRemoveEventSource=function(n,o){var i=0;angular.forEach(n,function(e,t){n[t]===o&&(n.splice(t,1),i=1)}),0===i&&n.push(o)},s.whole_day_booking=!1,s.wholeDay=function(){1==s.whole_day_booking?(s.whole_day_booking=!1,s.myDatetimeRange.time.from=480,s.myDatetimeRange.time.to=1080):(s.whole_day_booking=!0,s.myDatetimeRange.time.from=0,s.myDatetimeRange.time.to=1440)},s.addEvent=function(){var e={title:"Holiday",start:s.myDatetimeRange.date.from,end:s.myDatetimeRange.date.to,className:["openSesame"],allDay:s.whole_day_booking};s.events.push(e),a.Create(g.user.id,e).then(function(e){c.go("dashboard.manage_user.instructor_holidays")})},s.remove=function(t){var e=s.events[t].id;a.Delete(g.user.id,e).then(function(e){s.events.splice(t,1)})},s.changeView=function(e,t){f.calendars[t].fullCalendar("changeView",e)},s.renderCalender=function(e){m(function(){f.calendars[e]&&f.calendars[e].fullCalendar("render")})},s.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),p(t)(s)},s.uiConfig={schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",calendar:{height:650,editable:!0,header:{left:"title",center:"",right:"today prev,next"},firstDay:1,slotEventOverlap:!1,eventClick:s.alertOnEventClick,eventDrop:s.alertOnDrop,eventResize:s.alertOnResize,eventRender:s.eventRender}},s.changeLang=function(){s.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],s.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},s.eventSources=[s.events],"add"===g.action&&(g.page_title="Add a New member"),s.back=function(){_.history.back()},s.save=function(){"add"==g.action?s.create():s.update()},s.csvToJSON=function(e){var t=e.csv.split(/\r\n|\n/),n=[],o=0;t[0]+=",membership_id,membership_start,selected";for(var i=1;i<t.length;i++)t[i]+=",membership_id,membership_start,true";var r=t[0].split(e.separator).length,a=[];e.header&&(a=t[0].split(e.separator),g.imported_headers=a,o=1);for(var s=o;s<t.length;s++){var c={},l=t[s].split(new RegExp(e.separator+'(?![^"]*"(?:(?:[^"]*"){2})*[^"]*$)'));if(l.length===r){if(e.header)for(i=0;i<a.length;i++)c[a[i]]=l[i];else for(var d=0;d<l.length;d++)c[d]=l[d];n.push(c)}}return n},s.processData=function(){allText=g.import_users;var e={csv:g.import_users,separator:",",header:!0};g.imported_users=s.csvToJSON(e);for(var t=0;t<g.imported_users.length;t++)g.imported_users[t].membership_start?g.imported_users[t].membership_start=new Date(g.imported_users[t].membership_start):g.imported_users[t].membership_start=new Date,g.imported_users[t].membership_id=4,g.imported_users[t].membership={membership_id:4,membership_name:"Annual Membership"}},g.user_columns={first_name:"First Name",last_name:"Last Name",email:"Email Address",dob:"Date of Birth",membership_number:"Membership Number",membership_start:"Membership Start Date",membership_id:"Membership Name"},s.import_column=function(e){},s.import_users=function(){if(g.imported_users=$.grep(g.imported_users,function(e){return"false"!=e.selected}),-1<g.imported_new_headers.indexOf("first_name")&&-1<g.imported_new_headers.indexOf("last_name")&&-1<g.imported_new_headers.indexOf("email")){for(var e=0;e<g.imported_users.length;e++)g.imported_users[e].membership&&g.imported_users[e].membership.membership_id&&(g.imported_users[e].membership_id=g.imported_users[e].membership.membership_id,delete g.imported_users[e].membership);g.imported_new_headers.push("membership_id"),g.imported_new_headers.push("membership_start");for(var t=[],n=0;n<g.imported_users.length;n++){for(var o={user:{},club_id:6},i=0;i<g.imported_new_headers.length;i++)g.imported_new_headers[i]&&("first_name"==g.imported_new_headers[i]||"last_name"==g.imported_new_headers[i]||"dob"==g.imported_new_headers[i]||"email"==g.imported_new_headers[i]?o.user[g.imported_new_headers[i]]=g.imported_users[n][Object.keys(g.imported_users[n])[i]]:"membership_start"==g.imported_new_headers[i]||"membership_id"==g.imported_new_headers[i]?o[g.imported_new_headers[i]]=g.imported_users[n][g.imported_new_headers[i]]:o[g.imported_new_headers[i]]=g.imported_users[n][Object.keys(g.imported_users[n])[i]]);t.push(o)}r.CreateMany(t).then(function(e){c.go("dashboard.manage_club.members")})}else alert("You must select the First Name, Last Name and Email Address to be able to add the user to the system!")},s.create=function(){g.club.member.club_id=6,r.Create(g.club.member).then(function(e){c.go("dashboard.manage_club.members")})},s.delete=function(){alert("Are you sure you would like to delete this membership?"),r.Update(g.club.membership).then(function(e){})},s.update=function(){g.club.member.club_id=6,r.Update(g.club.member).then(function(e){c.go("dashboard.manage_club.members")}),r.SaveMemberPlanes(g.club.member.id,g.club.member.club_id,g.club.planes).then(function(e){})},s.selected_members=function(e){g.selected_members=$.grep(g.club.members,function(e){return 1==e.selected});for(var t=0;t<g.selected_members.length;t++)g.selected_members[t].approved="approve"==e?1:0,r.Update(g.selected_members[t]).then(function(e){});c.go("dashboard.manage_club.members")},s.update_membership=function(e,t){g.club.member.membership_id=e.membership_id,g.club.member.membership_name=e.membership_name};s.open=function(e){d.open({animation:!0,templateUrl:"views/modals/deleteModal.html",controller:"ModalInstanceCtrl",size:"lg",resolve:{id:function(){return e},warning:function(){return"By deleting this membership, you will also cancel all reservations that this membership currently has."}}}).result.then(function(t){u.info("PRESSED GO: "+t),r.Delete(t).then(function(){g.club.members=$.grep(g.club.members,function(e){return e.id!=t})})},function(){u.info("Modal dismissed at: "+new Date)})}}function FinishAndPayController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w,C,S,x){var O=this;O.user=a.globals.currentUser,O.user_id=O.user.id,O.show_loading=!1,O.club_id=6,O.booking={},O.wgs_n="51.51",O.wgs_e="0.12",O.change_booking={},O.show_change_plane=!1,O.bookout={start:!0,passengers:[],pic:{id:O.user_id},plane:{}},O.dateFormat="date:HH:mm 'on' dd/MM/yyyy",O.reported_defects=[],O.complete_flight=!0,O.previous_invoice,O.defect_severity,O.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}];O.donConfirm=function(e,t){console.log("confirmation is called",e),console.log("paymentIntent",t),O.book_in_flight(e,t)},O.default_payment="direct-debit",O.methods=[{id:"direct-debit",title:"Direct Debit",subtitle:"Use your BACS mandate",type:"direct-debit",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><path d="M3 10h18M4 10V8l8-5 8 5v2M5 10v8M9 10v8M15 10v8M19 10v8M3 18h18M2 20h20" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"saved-card",title:"Saved card",subtitle:"Use a card on file",type:"saved-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2" ry="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M2 9h20M6 14h6" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"new-card",title:"New card",subtitle:"Add a new debit/credit card",type:"new-card",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="none" stroke="#4f46e5" stroke-width="1.6"/><path d="M12 8v8M8 12h8" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0},{id:"card-machine",title:"Card Machine",subtitle:"Pay in person",type:"card-machine",iconSvg:e.trustAsHtml('<svg viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="14" rx="2" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="8" y="5" width="8" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/><rect x="9" y="10" width="6" height="3" fill="none" stroke="#4f46e5" stroke-width="1.6"/></svg>'),visible:!0}],O.savedCards=[],O.complete_flight=!1,O.complete_this_flight=function(){if(O.tacho_error_highlight)return alert("You cannot complete a fligth where the last meter reading is greater than the start meter reading!"),!1;O.bookout.club_id,O.bookout.user_id;n.GetMandate(O.bookout.user_id,O.bookout.club_id).then(function(e){e.success&&(O.info=e.info,O.savedCards=e.cards,0<O.savedCards.length?O.methods[1].visible=!0:O.methods[1].visible=!1,O.machine=e.machine,O.machine.success?O.methods[3].visible=!0:O.methods[3].visible=!1)}),O.complete_flight=!0},c.get_airfields=function(t){var e;2<t.length&&t.length<5&&v.GetAirfieldsByCode(t).then(function(e){e.success&&(O.airfields=e.airfields,0==O.airfields.length&&(O.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}),4<t.length&&(e=t.replace(/\s/g,"_"),v.GetAirfields(e).then(function(e){e.success&&(O.airfields=e.airfields,0==O.airfields.length&&(O.airfields=[{id:0,title:"NOT LISTED : "+t,code:"ZZZZ",wgs_n:"0",wgs_e:"0"}]))}))},c.update_pic=function(){O.bookout.pic.user_id==O.user.id&&0<O.bookout.instructor_id||0<O.bookout.instructor_id&&(O.bookout.pic.user_id,O.bookout.instructor_id)},"add"===l.current.data.action&&h.GetForBookout(O.user.id,d.id).then(function(t){t.success&&(1==t.booking.complete&&(alert("It appears that you have already completed this booking..."),l.go("dashboard.my_account",{},{reload:!0})),O.bookout=t.booking,O.bookout.start_date=new Date("2100/07/26"),O.bookout.end_date=new Date("2100/07/26"),n.GetAllByPics(t.booking.club_id,O.user.id).then(function(e){O.pics=e,function(o){O.bookout.booking_id=o.id,O.bookout.club_id=o.club_id,O.bookout.user_id=o.user_id,O.bookout.plane=o.plane,O.club_id=o.club_id,(-1<O.user.access.instructor.indexOf(O.club_id)||-1<O.user.access.manager.indexOf(O.club_id))&&O.bookout.user_id!==O.user.id&&(O.can_authorise=!0);O.invoices=[],O.previous_total=0,x.GetAllByBooking(o.id).then(function(e){if(e.success){for(var t in O.previous_invoice=e.invoice,e.invoices)for(var n in e.invoices[t].flights)e.invoices[t]&&e.invoices[t].status&&"paid"!==e.invoices[t].status.toLowerCase()&&(O.invoices.push(e.invoices[t].flights[n]),O.previous_total=Number.parseFloat(O.previous_total)+Number.parseFloat(e.invoices[t].flights[n].total));O.complete_this_flight(),O.invoice_totals=O.previous_total,O.send={club_id:O.bookout.club_id,user_id:O.user.id,booking_id:o.id},O.show_add_card=!0,0!=O.previous_total&&0!=O.invoices.length||(alert("It appears that you have already completed this flight!"),l.go("dashboard.my_account",{},{reload:!0}))}})}(t.booking)}))}),O.calculate_invoice_for_flight=function(){O.invoice_totals=O.previous_total,O.plane_charges={total:0}},O.instructor_charges=[],O.complete_flight=!0,O.book_in_flight=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n={user_id:O.bookout.user_id,club_id:O.bookout.club_id,plane_id:O.bookout.plane_id,booking_id:O.bookout.booking_id,paying_now:O.complete_flight,free_flight:0==O.invoice_totals};"new-card"==e||"saved-card"==e?(n.paymentIntent=t,n.method=e):"direct-debit"==e?n.method=e:"card-machine"==e&&(n.paymentIntent=t,n.method=e),v.PayBooking(O.bookout.id,n).then(function(e){e.success?(O.show_loading=!1,l.go("dashboard.my_account",{},{reload:!0})):(alert("an error occurred.... \n\n "+e.message),O.show_loading=!1)})},O.start_tacho_orig,c.popup=[],c.open=function(e,t){c.popup[e]&&1==c.popup[e].opened?(t.preventDefault(),t.stopPropagation()):c.popup[e]={opened:!0}},c.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],c.format=c.formats[0],c.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1}}function GalleriesController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;u.GetAll().then(function(e){_.galleries=e,d.SetAllGalleries(e),0<d.data.selecting_for&&(_.galleries.forEach(function(e){e.id==d.data.selecting_for&&(e.images=d.data.selected_images)}),$("#organise_images").fadeIn())}),_.images=d.data.selected_images,l.remove_image=function(t){_.images=$.grep(_.images,function(e){return e.id!=t.id}),d.SetSelectedImages(_.images)},l.check_link_unique=function(){for(var e=0;e<_.all_galleries.length;e++)if(_.all_galleries[e].link===_.gallery.link)return!1},l.edit_gallery_images=function(e){for(var t=_.galleries[e],n=0;n<t.images.length;n++)t.images[n].selected=!0;d.SetSelectedImages(t.images),d.SetSelectingFor(t.id),r.path("/select_images")},l.save_images=function(){var n=[];_.galleries.forEach(function(e){if(e.id==d.data.selecting_for){e.images=d.data.selected_images;for(var t=0;t<e.images.length;t++)e.images[t].organise=t;n=e.images}}),u.Update({id:d.data.selecting_for,images:n}).then(function(e){d.SetSelectingFor(0),$("#organise_images").fadeOut()})},l.save_gallery=function(e){var t=_.galleries[e];d.SetSelectedImages(t.images);for(var n=0;n<t.images.length;n++)t.images[n].organise=n;u.Update(_.galleries[e]).then(function(e){alert("saved")})};function p(e){var t;return t=e=e+"-COPY",_.galleries.forEach(function(e){if(e.gallery_link==t)return!1}),e}l.duplicate_gallery=function(e){e=JSON.parse(JSON.stringify(_.galleries[e]));delete e.id,e.opened=0,e.downloaded=0,e.gallery_link=p(e.gallery_link),u.Create(e).then(function(e){_.galleries.push(e)})},l.delete_gallery=function(e){var t=_.galleries[e];u.Delete(t.id).then(function(e){_.galleries=$.grep(_.galleries,function(e){return e.id!=t.id})})}}function HomeController(t,e,n){var o=this;o.user=e.globals.currentUser,o.allUsers=[],o.deleteUser=function(e){t.Delete(e).then(function(e){e.success&&n.path("/")})},t.GetById(e.globals.currentUser.id).then(function(e){o.user=e.user}),t.GetAll().then(function(e){o.allUsers=e.users})}function ImagesController(e,t,n,o,i,r,a,s,c,l,d){var u=this;l.filters="",u.selected_images=[],n.GetAll().then(function(e){u.images=e}),t.GetAll().then(function(e){u.all_artpieces=e,u.artpieces=e}),i.GetAll().then(function(e){u.categories=e}),c.imageId&&n.GetOne(c.imageId).then(function(e){u.one_image=e;var t=[];u.one_image.keywords.forEach(function(e){t.push({id:e.id,text:e.keyword})}),l.tags=t}),o.GetAll().then(function(e){u.all_keywords=e,u.all_tags=[],u.all_keywords.forEach(function(e){u.all_tags.push({id:e.id,text:e.keyword})})});function _(){var e,n,o=l.tags,t=l.filters;t&&t.indexOf(", ")?(e=t.split(", "),t="",n=[],e.forEach(function(e){var t=e;o&&o.forEach(function(e){t+="."+e.text}),n.push(t)}),t=n.join(", ")):o&&o.forEach(function(e){t+="."+e.text}),l.$emit("iso-option",{filter:t})}var p=0;l.change_category=function(e){if("all"==(p=e))u.artpieces=u.all_artpieces,l.filters="",_();else{if(u.artpieces=u.categories[e].artpieces||[],u.categories[e].artpieces&&0<u.categories[e].artpieces.length){var e=u.categories[e].artpieces,t=[];return e.forEach(function(e){t.push(".artpiece"+e.id)}),l.filters=t.join(", "),_(),l.filters}l.filters=".hideAllPossibleItems",_()}},l.artpiece_filter=function(e){l.filters="all"==e?0==p?"":l.change_category(p):".artpiece"+e,_()},l.update_list=function(){setTimeout(function(){_()},500)};var m=function(e,t){for(var n=0;n<u.images.length;n++)u.images[n].id===e&&(u.images[n].selected=t)};l.add_image=function(t){1==t.selected?(m(t.id,!1),u.selected_images=$.grep(u.selected_images,function(e){return e.id!=t.id})):(u.selected_images.push(t),m(t.id,!0)),d.SetSelectedImages(u.selected_images)},u.save_btn_text=0<d.data.selecting_for?"UPDATE GALLERY":"GENERATE GALLERY",l.save=function(){var e=0<d.data.selecting_for?"/galleries":"/create_gallery";r.path(e)},l.editImage=function(){u.one_image.keywords=l.tags,n.Update(u.one_image).then(function(e){r.path("/images"),u.one_image={}})},l.loadClasses=function(e){return"one two three"},l.loadTags=function(t){for(var e=$.grep(u.all_keywords,function(e){if(e.keyword.toLowerCase().startsWith(t.toLowerCase()))return!0}),n=[],o=0;o<e.length;o++){var i=(i=e[o].keyword).toLowerCase();n.push({id:e[o].id,text:i})}return n},l.deleteImage=function(t){n.Delete(t).then(function(e){u.images=$.grep(u.images,function(e){return e.id!=t})})},setTimeout(function(){u.selected_images=d.data.selected_images,0<u.selected_images.length&&u.selected_images.forEach(function(t){1==t.selected?m(t.id,!0):(m(t.id,!1),u.selected_images=$.grep(u.selected_images,function(e){return e.id!=t.id}))})},500)}function InvitationsSignupController(t,n,e,o,i,r,a,s,c,l,d){a.formData={},this.selected_phone,this.countries=[{CountryCode:"+247",CountryCodeISO:"SH",Country:"Ascension"},{CountryCode:"+246",CountryCodeISO:"DG",Country:"Diego Garcia"},{CountryCode:"+291",CountryCodeISO:"ER",Country:"Eritrea"},{CountryCode:"+500",CountryCodeISO:"FK",Country:"Falkland (Malvinas) Islands"},{CountryCode:"+692",CountryCodeISO:"MH",Country:"Marshall Islands"},{CountryCode:"+691",CountryCodeISO:"FM",Country:"Micronesia"},{CountryCode:"+683",CountryCodeISO:"NU",Country:"Niue Island"},{CountryCode:"+290",CountryCodeISO:"SH",Country:"Saint Helena"},{CountryCode:"+508",CountryCodeISO:"PM",Country:"Saint Pierre and Miquelon"},{CountryCode:"+690",CountryCodeISO:"TK",Country:"Tokelau"},{CountryCode:"+688",CountryCodeISO:"TV",Country:"Tuvalu"},{CountryCode:"+379",CountryCodeISO:"VA",Country:"Vatican City"},{CountryCode:"+681",CountryCodeISO:"WF",Country:"Wallis and Futuna"},{CountryCode:"+1",CountryCodeISO:"AS",Country:"American Samoa"},{CountryCode:"+1",CountryCodeISO:"CA",Country:"Canada"},{CountryCode:"+61",CountryCodeISO:"AU",Country:"Australia"},{CountryCode:"+93",CountryCodeISO:"AF",Country:"Afghanistan"},{CountryCode:"+355",CountryCodeISO:"AL",Country:"Albania"},{CountryCode:"+213",CountryCodeISO:"DZ",Country:"Algeria"},{CountryCode:"+376",CountryCodeISO:"AD",Country:"Andorra"},{CountryCode:"+244",CountryCodeISO:"AO",Country:"Angola"},{CountryCode:"+54",CountryCodeISO:"AR",Country:"Argentina"},{CountryCode:"+374",CountryCodeISO:"AM",Country:"Armenia"},{CountryCode:"+297",CountryCodeISO:"AW",Country:"Aruba"},{CountryCode:"+43",CountryCodeISO:"AT",Country:"Austria"},{CountryCode:"+994",CountryCodeISO:"AZ",Country:"Azerbaijan"},{CountryCode:"+973",CountryCodeISO:"BH",Country:"Bahrain"},{CountryCode:"+880",CountryCodeISO:"BD",Country:"Bangladesh"},{CountryCode:"+375",CountryCodeISO:"BY",Country:"Belarus"},{CountryCode:"+32",CountryCodeISO:"BE",Country:"Belgium"},{CountryCode:"+501",CountryCodeISO:"BZ",Country:"Belize"},{CountryCode:"+229",CountryCodeISO:"BJ",Country:"Benin"},{CountryCode:"+975",CountryCodeISO:"BT",Country:"Bhutan"},{CountryCode:"+591",CountryCodeISO:"BO",Country:"Bolivia"},{CountryCode:"+387",CountryCodeISO:"BA",Country:"Bosnia and Herzegovina"},{CountryCode:"+267",CountryCodeISO:"BW",Country:"Botswana"},{CountryCode:"+55",CountryCodeISO:"BR",Country:"Brazil"},{CountryCode:"+673",CountryCodeISO:"BN",Country:"Brunei"},{CountryCode:"+359",CountryCodeISO:"BG",Country:"Bulgaria"},{CountryCode:"+226",CountryCodeISO:"BF",Country:"Burkina Faso"},{CountryCode:"+257",CountryCodeISO:"BI",Country:"Burundi"},{CountryCode:"+855",CountryCodeISO:"KH",Country:"Cambodia"},{CountryCode:"+237",CountryCodeISO:"CM",Country:"Cameroon"},{CountryCode:"+238",CountryCodeISO:"CV",Country:"Cape Verde"},{CountryCode:"+236",CountryCodeISO:"CF",Country:"Central African Republic"},{CountryCode:"+235",CountryCodeISO:"TD",Country:"Chad"},{CountryCode:"+56",CountryCodeISO:"CL",Country:"Chile"},{CountryCode:"+86",CountryCodeISO:"CN",Country:"China"},{CountryCode:"+57",CountryCodeISO:"CO",Country:"Colombia"},{CountryCode:"+269",CountryCodeISO:"KM",Country:"Comoros"},{CountryCode:"+242",CountryCodeISO:"CG",Country:"Congo"},{CountryCode:"+682",CountryCodeISO:"CK",Country:"Cook Islands"},{CountryCode:"+506",CountryCodeISO:"CR",Country:"Costa Rica"},{CountryCode:"+385",CountryCodeISO:"HR",Country:"Croatia"},{CountryCode:"+53",CountryCodeISO:"CU",Country:"Cuba"},{CountryCode:"+357",CountryCodeISO:"CY",Country:"Cyprus"},{CountryCode:"+420",CountryCodeISO:"CZ",Country:"Czech Republic"},{CountryCode:"+243",CountryCodeISO:"CD",Country:"Democratic Republic of Congo"},{CountryCode:"+45",CountryCodeISO:"DK",Country:"Denmark"},{CountryCode:"+253",CountryCodeISO:"DJ",Country:"Djibouti"},{CountryCode:"+670",CountryCodeISO:"TL",Country:"East Timor"},{CountryCode:"+593",CountryCodeISO:"EC",Country:"Ecuador"},{CountryCode:"+20",CountryCodeISO:"EG",Country:"Egypt"},{CountryCode:"+503",CountryCodeISO:"SV",Country:"El Salvador"},{CountryCode:"+240",CountryCodeISO:"GQ",Country:"Equatorial Guinea"},{CountryCode:"+372",CountryCodeISO:"EE",Country:"Estonia"},{CountryCode:"+251",CountryCodeISO:"ET",Country:"Ethiopia"},{CountryCode:"+298",CountryCodeISO:"FO",Country:"Faroe Islands"},{CountryCode:"+679",CountryCodeISO:"FJ",Country:"Fiji"},{CountryCode:"+358",CountryCodeISO:"FI",Country:"Finland"},{CountryCode:"+33",CountryCodeISO:"FR",Country:"France"},{CountryCode:"+594",CountryCodeISO:"GF",Country:"French Guiana"},{CountryCode:"+689",CountryCodeISO:"PF",Country:"French Polynesia"},{CountryCode:"+241",CountryCodeISO:"GA",Country:"Gabon"},{CountryCode:"+220",CountryCodeISO:"GM",Country:"Gambia"},{CountryCode:"+995",CountryCodeISO:"GE",Country:"Georgia"},{CountryCode:"+49",CountryCodeISO:"DE",Country:"Germany"},{CountryCode:"+233",CountryCodeISO:"GH",Country:"Ghana"},{CountryCode:"+350",CountryCodeISO:"GI",Country:"Gibraltar"},{CountryCode:"+30",CountryCodeISO:"GR",Country:"Greece"},{CountryCode:"+299",CountryCodeISO:"GL",Country:"Greenland"},{CountryCode:"+590",CountryCodeISO:"GP",Country:"Guadeloupe"},{CountryCode:"+502",CountryCodeISO:"GT",Country:"Guatemala"},{CountryCode:"+224",CountryCodeISO:"GN",Country:"Guinea"},{CountryCode:"+245",CountryCodeISO:"GW",Country:"Guinea-Bissau"},{CountryCode:"+592",CountryCodeISO:"GY",Country:"Guyana"},{CountryCode:"+509",CountryCodeISO:"HT",Country:"Haiti"},{CountryCode:"+504",CountryCodeISO:"HN",Country:"Honduras"},{CountryCode:"+852",CountryCodeISO:"HK",Country:"Hong Kong"},{CountryCode:"+36",CountryCodeISO:"HU",Country:"Hungary"},{CountryCode:"+354",CountryCodeISO:"IS",Country:"Iceland"},{CountryCode:"+91",CountryCodeISO:"IN",Country:"India"},{CountryCode:"+62",CountryCodeISO:"ID",Country:"Indonesia"},{CountryCode:"+98",CountryCodeISO:"IR",Country:"Iran"},{CountryCode:"+964",CountryCodeISO:"IQ",Country:"Iraq"},{CountryCode:"+353",CountryCodeISO:"IE",Country:"Ireland"},{CountryCode:"+972",CountryCodeISO:"IL",Country:"Israel"},{CountryCode:"+39",CountryCodeISO:"IT",Country:"Italy"},{CountryCode:"+225",CountryCodeISO:"CI",Country:"Ivory Coast"},{CountryCode:"+81",CountryCodeISO:"JP",Country:"Japan"},{CountryCode:"+962",CountryCodeISO:"JO",Country:"Jordan"},{CountryCode:"+254",CountryCodeISO:"KE",Country:"Kenya"},{CountryCode:"+686",CountryCodeISO:"KI",Country:"Kiribati"},{CountryCode:"+965",CountryCodeISO:"KW",Country:"Kuwait"},{CountryCode:"+996",CountryCodeISO:"KG",Country:"Kyrgyzstan"},{CountryCode:"+856",CountryCodeISO:"LA",Country:"Laos"},{CountryCode:"+371",CountryCodeISO:"LV",Country:"Latvia"},{CountryCode:"+961",CountryCodeISO:"LB",Country:"Lebanon"},{CountryCode:"+266",CountryCodeISO:"LS",Country:"Lesotho"},{CountryCode:"+231",CountryCodeISO:"LR",Country:"Liberia"},{CountryCode:"+218",CountryCodeISO:"LY",Country:"Libya"},{CountryCode:"+423",CountryCodeISO:"LI",Country:"Liechtenstein"},{CountryCode:"+370",CountryCodeISO:"LT",Country:"Lithuania"},{CountryCode:"+352",CountryCodeISO:"LU",Country:"Luxembourg"},{CountryCode:"+853",CountryCodeISO:"MO",Country:"Macau"},{CountryCode:"+389",CountryCodeISO:"MK",Country:"Macedonia"},{CountryCode:"+261",CountryCodeISO:"MG",Country:"Madagascar"},{CountryCode:"+265",CountryCodeISO:"MW",Country:"Malawi"},{CountryCode:"+60",CountryCodeISO:"MY",Country:"Malaysia"},{CountryCode:"+960",CountryCodeISO:"MV",Country:"Maldives"},{CountryCode:"+223",CountryCodeISO:"ML",Country:"Mali"},{CountryCode:"+356",CountryCodeISO:"MT",Country:"Malta"},{CountryCode:"+596",CountryCodeISO:"MQ",Country:"Martinique"},{CountryCode:"+222",CountryCodeISO:"MR",Country:"Mauritania"},{CountryCode:"+230",CountryCodeISO:"MU",Country:"Mauritius"},{CountryCode:"+262",CountryCodeISO:"RE",Country:"Reunion"},{CountryCode:"+52",CountryCodeISO:"MX",Country:"Mexico"},{CountryCode:"+373",CountryCodeISO:"MD",Country:"Moldova"},{CountryCode:"+377",CountryCodeISO:"MC",Country:"Monaco"},{CountryCode:"+976",CountryCodeISO:"MN",Country:"Mongolia"},{CountryCode:"+382",CountryCodeISO:"ME",Country:"Montenegro"},{CountryCode:"+212",CountryCodeISO:"MA",Country:"Morocco"},{CountryCode:"+258",CountryCodeISO:"MZ",Country:"Mozambique"},{CountryCode:"+95",CountryCodeISO:"MM",Country:"Myanmar"},{CountryCode:"+264",CountryCodeISO:"NA",Country:"Namibia"},{CountryCode:"+674",CountryCodeISO:"NR",Country:"Nauru"},{CountryCode:"+977",CountryCodeISO:"NP",Country:"Nepal"},{CountryCode:"+31",CountryCodeISO:"NL",Country:"Netherlands"},{CountryCode:"+599",CountryCodeISO:"AN",Country:"Netherlands Antilles"},{CountryCode:"+687",CountryCodeISO:"NC",Country:"New Caledonia"},{CountryCode:"+64",CountryCodeISO:"NZ",Country:"New Zealand"},{CountryCode:"+505",CountryCodeISO:"NI",Country:"Nicaragua"},{CountryCode:"+227",CountryCodeISO:"NE",Country:"Niger"},{CountryCode:"+234",CountryCodeISO:"NG",Country:"Nigeria"},{CountryCode:"+850",CountryCodeISO:"KP",Country:"North Korea"},{CountryCode:"+47",CountryCodeISO:"NO",Country:"Norway"},{CountryCode:"+968",CountryCodeISO:"OM",Country:"Oman"},{CountryCode:"+92",CountryCodeISO:"PK",Country:"Pakistan"},{CountryCode:"+680",CountryCodeISO:"PW",Country:"Palau"},{CountryCode:"+507",CountryCodeISO:"PA",Country:"Panama"},{CountryCode:"+675",CountryCodeISO:"PG",Country:"Papua New Guinea"},{CountryCode:"+595",CountryCodeISO:"PY",Country:"Paraguay"},{CountryCode:"+51",CountryCodeISO:"PE",Country:"Peru"},{CountryCode:"+63",CountryCodeISO:"PH",Country:"Philippines"},{CountryCode:"+48",CountryCodeISO:"PL",Country:"Poland"},{CountryCode:"+351",CountryCodeISO:"PT",Country:"Portugal"},{CountryCode:"+974",CountryCodeISO:"QA",Country:"Qatar"},{CountryCode:"+40",CountryCodeISO:"RO",Country:"Romania"},{CountryCode:"+7",CountryCodeISO:"KZ",Country:"Kazakhstan"},{CountryCode:"+250",CountryCodeISO:"RW",Country:"Rwanda"},{CountryCode:"+685",CountryCodeISO:"WS",Country:"Samoa"},{CountryCode:"+378",CountryCodeISO:"SM",Country:"San Marino"},{CountryCode:"+239",CountryCodeISO:"ST",Country:"Sao Tome and Principe"},{CountryCode:"+966",CountryCodeISO:"SA",Country:"Saudi Arabia"},{CountryCode:"+221",CountryCodeISO:"SN",Country:"Senegal"},{CountryCode:"+381",CountryCodeISO:"RS",Country:"Serbia"},{CountryCode:"+248",CountryCodeISO:"SC",Country:"Seychelles"},{CountryCode:"+232",CountryCodeISO:"SL",Country:"Sierra Leone"},{CountryCode:"+65",CountryCodeISO:"SG",Country:"Singapore"},{CountryCode:"+421",CountryCodeISO:"SK",Country:"Slovakia"},{CountryCode:"+386",CountryCodeISO:"SI",Country:"Slovenia"},{CountryCode:"+677",CountryCodeISO:"SB",Country:"Solomon Islands"},{CountryCode:"+252",CountryCodeISO:"SO",Country:"Somalia"},{CountryCode:"+27",CountryCodeISO:"ZA",Country:"South Africa"},{CountryCode:"+82",CountryCodeISO:"KR",Country:"South Korea"},{CountryCode:"+34",CountryCodeISO:"ES",Country:"Spain"},{CountryCode:"+94",CountryCodeISO:"LK",Country:"Sri Lanka"},{CountryCode:"+249",CountryCodeISO:"SD",Country:"Sudan"},{CountryCode:"+597",CountryCodeISO:"SR",Country:"Suriname"},{CountryCode:"+268",CountryCodeISO:"SZ",Country:"Swaziland"},{CountryCode:"+46",CountryCodeISO:"SE",Country:"Sweden"},{CountryCode:"+41",CountryCodeISO:"CH",Country:"Switzerland"},{CountryCode:"+963",CountryCodeISO:"SY",Country:"Syria"},{CountryCode:"+886",CountryCodeISO:"TW",Country:"Taiwan"},{CountryCode:"+992",CountryCodeISO:"TJ",Country:"Tajikistan"},{CountryCode:"+255",CountryCodeISO:"TZ",Country:"Tanzania"},{CountryCode:"+66",CountryCodeISO:"TH",Country:"Thailand"},{CountryCode:"+228",CountryCodeISO:"TG",Country:"Togo"},{CountryCode:"+216",CountryCodeISO:"TN",Country:"Tunisia"},{CountryCode:"+90",CountryCodeISO:"TR",Country:"Turkey"},{CountryCode:"+993",CountryCodeISO:"TM",Country:"Turkmenistan"},{CountryCode:"+256",CountryCodeISO:"UG",Country:"Uganda"},{CountryCode:"+380",CountryCodeISO:"UA",Country:"Ukraine"},{CountryCode:"+971",CountryCodeISO:"AE",Country:"United Arab Emirates"},{CountryCode:"+44",CountryCodeISO:"GB",Country:"United Kingdom"},{CountryCode:"+1",CountryCodeISO:"VI",Country:"U.S. Virgin Islands"},{CountryCode:"+598",CountryCodeISO:"UY",Country:"Uruguay"},{CountryCode:"+998",CountryCodeISO:"UZ",Country:"Uzbekistan"},{CountryCode:"+678",CountryCodeISO:"VU",Country:"Vanuatu"},{CountryCode:"+58",CountryCodeISO:"VE",Country:"Venezuela"},{CountryCode:"+84",CountryCodeISO:"VN",Country:"Vietnam"},{CountryCode:"+967",CountryCodeISO:"YE",Country:"Yemen"},{CountryCode:"+260",CountryCodeISO:"ZM",Country:"Zambia"},{CountryCode:"+263",CountryCodeISO:"ZW",Country:"Zimbabwe"},{CountryCode:"+262",CountryCodeISO:"YT",Country:"Mayotte"},{CountryCode:"+7",CountryCodeISO:"RU",Country:"Russian Federation"},{CountryCode:"+1",CountryCodeISO:"AI",Country:"Anguilla"},{CountryCode:"+1",CountryCodeISO:"AG",Country:"Antigua and Barbuda"},{CountryCode:"+1",CountryCodeISO:"BS",Country:"Bahamas"},{CountryCode:"+1",CountryCodeISO:"BB",Country:"Barbados"},{CountryCode:"+1",CountryCodeISO:"BM",Country:"Bermuda"},{CountryCode:"+1",CountryCodeISO:"VG",Country:"British Virgin Islands"},{CountryCode:"+1",CountryCodeISO:"KY",Country:"Cayman Islands"},{CountryCode:"+1",CountryCodeISO:"DM",Country:"Dominica"},{CountryCode:"+1",CountryCodeISO:"DO",Country:"Dominican Republic"},{CountryCode:"+1",CountryCodeISO:"GD",Country:"Grenada"},{CountryCode:"+1",CountryCodeISO:"GU",Country:"Guam"},{CountryCode:"+1",CountryCodeISO:"JM",Country:"Jamaica"},{CountryCode:"+1",CountryCodeISO:"MS",Country:"Montserrat"},{CountryCode:"+1",CountryCodeISO:"MP",Country:"Northern Marianas"},{CountryCode:"+1",CountryCodeISO:"PR",Country:"Puerto Rico"},{CountryCode:"+1",CountryCodeISO:"KN",Country:"Saint Kitts and Nevis"},{CountryCode:"+1",CountryCodeISO:"LC",Country:"Saint Lucia"},{CountryCode:"+1",CountryCodeISO:"VC",Country:"Saint Vincent and the Grenadines"},{CountryCode:"+1",CountryCodeISO:"TT",Country:"Trinidad and Tobago"},{CountryCode:"+1",CountryCodeISO:"TC",Country:"Turks and Caicos Islands"},{CountryCode:"+676",CountryCodeISO:"TO",Country:"Tonga"},{CountryCode:"+1",CountryCodeISO:"US",Country:"United States of America"},{CountryCode:"+970",CountryCodeISO:"PS",Country:"Palestine"},{CountryCode:"+211",CountryCodeISO:"SS",Country:"South Sudan"},{CountryCode:"+44",CountryCodeISO:"IM",Country:"Isle of Man"}],s.params.verify&&(alert("VERIFY?"),t.Verify(s.params.user_id,s.params.verify).then(function(e){e.success?s.go("verified"):(alert(e.message),s.go("login"))}));var u,_=r.path().split("/");"verified"==_[_.length-1]&&(u=l.get("uid"),n.VerifyInvitedUser(u).then(function(e){e.success?s.go("invitations.verified"):alert("Your verification code is incorrect...")})),c.token?t.GetInvite(c.token).then(function(e){e?(a.total_invite=e,a.formData.first_name=e.first_name,a.formData.last_name=e.last_name,a.formData.email=e.email,a.formData.membership_id=e.membership_id,a.formData.club_id=e.club_id,a.formData.to_pay=e.to_pay,a.formData.token=e.invitation_token,a.formData.invited_by=e.invited_by,0<e.user_id&&l.put("uid",e.user_id),a.payment_now=e.payment_now,a.first_payment=e.first_payment,a.club=e.club,a.membership=e.membership,a.all=e):(alert("Sorry we were unable to find this invitation... Please try clicking the link again."),s.go("login"))}):s.go("login"),""!==l.get("session")&&r.search().redirect_flow_id&&(r={mandate:r.search().redirect_flow_id,session:l.get("session"),member_accepted:!0},e.SetupMandate(r).then(function(e){e.success})),a.add_element=function(t){a[t][t]=$.grep(a[t][t],function(e){return e.id!=a.formData.license.add_to[t].id}),"differences"==t&&(a.formData.license.add_to[t].day=!0,a.formData.license.add_to[t].vfr=!0),a.formData.license[t].push(a.formData.license.add_to[t]),delete a.formData.license.add_to[t]},a.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");o.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",o.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){console.info("saveBlob method failed with the following exception:"),console.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){console.info("Download link method with simulated click failed with the following exception:"),console.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){d.info("Download link method with window.location failed with the following exception:"),d.info(e)}}}o||(d.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},a.remove_element=function(e,t){a[e][e].push(a.formData.license[e][t]),a.formData.license[e].splice(t,1),a.formData.license[e]=a.formData.license[e].filter(Boolean)},a.setup_direct_debit=function(){var e;a.checkValid("verify_account",1)?((e=a.formData).request_id=a.all.membership_request_id,e.invitation=c.token,e.payment_now=a.payment_now,e.first_payment=a.first_payment,t.InviteSignup(e).then(function(e){return e.success?(l.put("session",e.mandate.session),void(window.location=e.mandate.link)):(alert("An error - occurred : "+e.error),!1)})):alert("Please ensure that all fields are complete")},a.checkValid=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(e&&""!=e||(e=$(".btn-info").attr("one-ui-sref")),!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),$("input:checkbox:not(:checked):required").addClass("ng-checkbox-unchecked"),!1;if(!function(){if(a.formData.first_name&&a.formData.last_name&&a.formData.email&&a.formData.dob&&a.formData.password&&a.formData.password2)if(a.formData.password.length<7)alert("Password must be more than 7 characters long");else{if(a.formData.password===a.formData.password2)return 1;alert("Your passwords do not match...")}else alert("All form fields are required.")}())return s.go("invitations.your_details"),!1;if(!a.formData.nok)return s.go("invitations.next_of_kin"),!1;if(a.formData.tnc?$("input:checkbox:not(:checked)").removeClass("ng-checkbox-unchecked"):$("input:checkbox:not(:checked)").addClass("ng-checkbox-unchecked"),a.formData.password!=a.formData.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1;if(0!=t)return!0;"verify_account"==e?a.processForm():s.go(e)},a.sendVerification=function(){var e=l.get("uid");n.VerifyInvitedUser(e).then(function(e){e.success?s.go("invitations.verified"):alert("Your verification code is incorrect...")})},a.verify_mobile=function(e){e=e.text_verification;6==e.length&&n.VerifyPhoneInvite(e,l.get("uid")).then(function(e){e&&e.success?a.verified_mobile=!0:(alert("Your verification code is incorrect..."),a.verified_mobile=!1)})},a.processForm=function(){t.InviteSignup(a.formData).then(function(e){e?(alert("ALL GOOD TO GO"),s.go("invitations.verified")):(alert("Sorry we were unable to find this invitation... Please try clicking the link again."),s.go("login"))})}}function KeywordController(e,t,n,o){o.tags=new n,o.jsTagOptions={tags:o.tags};n=new Bloodhound({datumTokenizer:function(e){return Bloodhound.tokenizers.whitespace(e.keyword)},identify:function(e){return e.keyword},queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:"/api/v1/keywords"});n.initialize(),o.exampleData={displayKey:"keyword",source:n.ttAdapter()},o.exampleOptions={hint:!1,highlight:!0},o.CheckContent=function(){}}function KeywordsController(e,n,t,o,i,r,a){var s=this;n.GetAll().then(function(e){s.keywords=e}),s.id=1,s.myModel="Click here and delete me",a.myUpdateHandler=function(e,t){n.Update({id:e,keyword:t}).then(function(e){})},a.addKeyword=function(){var e={keyword:s.new_keyword};n.Create(e).then(function(e){s.keywords.push(e),s.new_keyword=""})},a.deleteKeyword=function(t){n.Delete(t).then(function(e){s.keywords=$.grep(s.keywords,function(e){return e.id!=t})})}}function LoginController(n,o,e){var i=this;i.login=function(){i.dataLoading=!0,o.Login1(i.email,i.login_session,function(e){var t;e.success?(t=e.login_key,o.Login2(i.password,t,function(e){e.success?o.SetCredentials2(i.email,i.password,e.user,e.session,function(e){e&&(0<e.access.instructor.length||0<e.access.manager.length)?n.path("/dashboard"):n.path("/dashboard/my_account")}):(i.error=e.error,i.dataLoading=!1)})):(i.error=e.error,i.dataLoading=!1)})},i.login_session,i.login_key,o.CheckLoggedIn()?n.path("/dashboard"):o.ClearCredentials(),o.Login0(function(e){e.success&&(i.login_session=e.login_session)})}function ManageAccountController(t,e,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b){var h=this;h.user=r.globals.currentUser,h.avatar="",h.address="Please choose address...",h.user.address_line1="Please choose",h.addresses={},h.show_addresses=!1,h.show_address=!1,h.show_search=!1,t.GetById(h.user.id).then(function(e){e.success&&(e.user.dob=new Date(e.user.dob),h.user=e.user,""!==h.user.address_line1&&(h.show_address=!0,h.show_search=!1,h.show_addresses=!1))}),s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,h.avatar=e[t].file,h.user.avatar=h.avatar.temp_path,h.user.update_avatar=!0}},s.show_form=function(){h.show_address=!0},s.set_address=function(){h.user.address_line1=h.address.line1,h.user.address_line2=h.address.line2,h.user.address_line3=h.address.line3,h.user.address_line4=h.address.line4,h.user.address_postcode=h.address.postcode,h.user.address_locality=h.address.locality,h.user.address_city=h.address.city,h.user.address_county=h.address.county,h.user.address_country=h.address.country,h.show_address=!0},s.get_addresses=function(){h.address={},b.GetAddresses(h.postcode).then(function(e){e.success?(h.addresses=e.addresses,h.addresses&&0<h.addresses.length?h.show_addresses=!0:(alert("We couldn't find your address from your postcode, please enter it manually"),h.show_addresses=!1,h.show_address=!0)):(alert("We couldn't find your address from your postcode, please enter it manually"),h.show_addresses=!1,h.show_address=!0)})},s.save_user=function(e){if(e){if(h.user.update_avatar||delete h.user.avatar,!h.user.phone_number||""==h.user.phone_number)return alert("Please enter a mobile phone number"),!1;if(h.user.new_password){if(h.user.new_password!==h.user.new_password2)return alert("Please ensure your updated passwords match"),!1;e=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!e.test(h.user.new_password))return h.show_error=!0,alert("Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1}if(!h.user.password)return alert("Please enter your current password to ensure that these changes are made by you."),!1;t.Update(h.user).then(function(e){e.success?(alert("Changes updated successfully."),c.go("dashboard.my_account",{},{reload:!0})):"Password entered failed"==e.message?alert("The password entered was incorrect"):alert("something horrible happened!")})}}}function ManageDifferencesController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b){var h=this;b.GetDifferences().then(function(e){h.all_differences=e}),h.user=r.globals.currentUser,h.user_id=h.user.id,b.GetByUserId(h.user.id).then(function(e){for(var t=e.differences.differences,n=0;n<t.length;n++)"0000-00-00"==t[n].sign_off_date&&delete t[n].sign_off_date,t[n].sign_off_date=new Date(t[n].sign_off_date),t[n].day=1==t[n].day,t[n].night=1==t[n].night,t[n].vfr=1==t[n].vfr,t[n].ifr=1==t[n].ifr;e.differences.differences=t,h.differences=e.differences,function(){if(0<h.differences.differences.length)for(var t=0;t<h.differences.differences.length;t++)h.all_differences=$.grep(h.all_differences,function(e){return e.id!=h.differences.differences[t].differences_id})}()}),h.differences={images:[],differences:[],user_id:h.user.id},h.differences_images=[],s.add_differences=function(){h.selected_differences&&(h.all_differences=$.grep(h.all_differences,function(e){return e.id!=h.selected_differences.id}),h.selected_differences.day=!0,h.selected_differences.vfr=!0,h.differences.differences.push(h.selected_differences),delete h.selected_differences)},s.remove_differences=function(e){h.all_differences.push(h.differences.differences[e]),h.differences.differences.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){h.differences.images=$.grep(h.differences.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);LicenceService.DeleteTmp(e.saved_url).then(function(e){e.success&&(h.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,h.differences_images.push(e[t].file)}},s.save_differences=function(){if(h.differences_images.length<1&&h.differences.images.length<1)return $(".drop").focus(),alert("You must at least have 1 image of the differences page of your log book!"),!1;if(h.differences.differences.length<1)return $("#differences").focus(),alert("You must at least have 1 differences to be able to save the image(s) above!"),!1;for(var e=0;e<h.differences.images.length;e++)delete h.differences.images[e].data_uri;h.differences.user_id=h.user.id,h.differences.images=h.differences.images.concat(h.differences_images),b.Update(h.differences).then(function(e){e.success?(alert("Differences Saved!"),c.go("dashboard.my_account",{},{reload:!0})):alert("Something went terribly wrong... \n\n "+e.message)})}}function ManageLicenceController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var y=this;switch(y.licence_images=[],y.licence={images:[],ratings:[]},y.user=r.globals.currentUser,y.user_id=y.user.id,b.GetLicenceTypes().then(function(e){y.licence_types=e}),b.GetRatings().then(function(e){y.ratings=e,"add"==c.current.data.action&&(y.selected_rating=$.grep(y.ratings,function(e){return 7==e.id})[0],s.add_rating())}),b.GetAuthority().then(function(e){y.authority=e}),c.current.data.action){case"add":break;case"edit":b.GetById(l.licence_id,1,0).then(function(e){if(e.success){y.licence=e.licence,y.licence.licence_issue_date=new Date(y.licence.licence_issue_date),y.licence.licence_expiry_date=new Date(y.licence.licence_expiry_date),y.licence.licence_type=$.grep(y.licence_types,function(e){return e.id==y.licence.licence_id})[0],y.licence.state_of_issue=$.grep(y.authority,function(e){return e.id==y.licence.authority_id})[0];for(var t=0;t<y.licence.ratings.length;t++)delete y.licence.ratings[t].id,y.licence.ratings[t].id=y.licence.ratings[t].rating_id,delete y.licence.ratings[t].rating_id,y.licence.ratings[t].test_date=new Date(y.licence.ratings[t].test_date),y.licence.ratings[t].expiry_date=new Date(y.licence.ratings[t].expiry_date),y.ratings=$.grep(y.ratings,function(e){return e.id!=y.licence.ratings[t].id})}});break;case"list":b.GetByUserId(y.user.id).then(function(e){e.success&&(y.user_licences=e.licences)})}s.add_rating=function(){y.ratings=$.grep(y.ratings,function(e){return e.id!=y.selected_rating.id}),y.licence.ratings.push(y.selected_rating),delete y.selected_rating},s.remove_rating=function(e){y.ratings.push(y.licence.ratings[e]),y.licence.ratings.splice(e,1)},s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){y.licence.images=$.grep(y.licence.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(y.licence_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,y.licence_images.push(e[t].file)}},s.delete_licence=function(t){"YES"==prompt("Are you sure you wish to delete this licence? \n\n This change is irreversible! To confirm please type YES in the box below.")&&b.Delete(y.user.id,t).then(function(e){e.success?(y.user_licences=$.grep(y.user_licences,function(e){return e.id!=t}),c.reload(),c.go("dashboard.my_account.licence")):alert("Something went terribly wrong... \n\n "+e.message)})},y.show_loading=!1,y.blurred=!0,y.show_temp_login=!1,s.getDecrypted=function(){y.show_loading=!0,b.GetById(l.licence_id,1,1).then(function(e){if(e.success){y.licence=e.licence,y.licence.licence_issue_date=new Date(y.licence.licence_issue_date),y.licence.licence_expiry_date=new Date(y.licence.licence_expiry_date),y.licence.licence_type=$.grep(y.licence_types,function(e){return e.id==y.licence.licence_id})[0],y.licence.state_of_issue=$.grep(y.authority,function(e){return e.id==y.licence.authority_id})[0];for(var t=0;t<y.licence.ratings.length;t++)delete y.licence.ratings[t].id,y.licence.ratings[t].id=y.licence.ratings[t].rating_id,delete y.licence.ratings[t].rating_id,y.licence.ratings[t].test_date=new Date(y.licence.ratings[t].test_date),y.licence.ratings[t].expiry_date=new Date(y.licence.ratings[t].expiry_date),y.ratings=$.grep(y.ratings,function(e){return e.id!=y.licence.ratings[t].id});y.show_loading=!1,y.blurred=!1}else"templogin"==e.fail&&(y.show_temp_login=!0),y.show_loading=!1})},s.re_login=function(){h.Login3(y.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(s.getDecrypted(),y.show_temp_login=!1):alert("This is the wrong password - please try again...")})},s.save_licence=function(e){if(y.show_loading=!0,y.licence_images.length<1&&y.licence.images.length<1)return $(".drop").focus(),alert("You must at least have 1 image of your licence!"),!1;if(!y.licence.licence_type)return $("#licence_type").focus(),alert("You must select a licence type"),!1;if(!y.licence.state_of_issue)return $("#state_of_issue").focus(),alert("You must select a licence state of issue"),!1;if(y.licence.ratings.length<1)return $("#ratings").focus(),alert("You must at least have 1 rating!"),!1;for(var t=0;t<y.licence.images.length;t++)delete y.licence.images[t].data_uri;y.licence.images=y.licence.images.concat(y.licence_images),y.licence.licence_id=y.licence.licence_type.id,y.licence.authority_id=y.licence.state_of_issue.id,y.licence.user_id=y.user.id,delete y.licence.licence_type,delete y.licence.state_of_issue,y.licence.id?b.Update(y.licence).then(function(e){e.success?c.go("dashboard.my_account.licence",{},{reload:!0}):alert("Something went terribly wrong... \n\n "+e.message),y.show_loading=!1}):b.Create(y.licence).then(function(e){e.success?(c.reload(),y.show_loading=!1,c.go("dashboard.my_account.licence",{},{reload:!0})):(alert("Something went terribly wrong... \n\n "+e.message),y.show_loading=!1)})}}function ManageMedicalController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var y=this;switch(y.medical_images=[],y.medical={images:[],components:[]},y.user=a.globals.currentUser,y.user_id=y.user.id,h.GetMedicalTypes().then(function(e){y.medical_types=e}),h.GetAuthority().then(function(e){y.authority=e}),h.GetComponents().then(function(e){y.components=e}),l.current.data.action){case"add":break;case"edit":h.GetById(d.medical_id,1,0).then(function(e){if(e.success){y.medical=e.medical,y.medical.examination_date=new Date(y.medical.examination_date),y.medical.state_of_issue=$.grep(y.authority,function(e){return e.id==y.medical.authority_id})[0];for(var t=0;t<y.medical.components.length;t++)delete y.medical.components[t].id,y.medical.components[t].id=y.medical.components[t].component_id,delete y.medical.components[t].component_id,y.medical.components[t].expiry_date=new Date(y.medical.components[t].expiry_date),y.components=$.grep(y.components,function(e){return e.id!=y.medical.components[t].id})}});break;case"list":h.GetByUserId(y.user.id).then(function(e){e.success&&(y.user_medicals=e.medicals)})}c.add_component=function(){y.components=$.grep(y.components,function(e){return e.id!=y.selected_component.id}),y.medical.components.push(y.selected_component),delete y.selected_component},c.remove_component=function(e){y.components.push(y.medical.components[e]),y.medical.components.splice(e,1)},c.popup=[],c.open=function(e,t){c.popup[e]&&1==c.popup[e].opened?(t.preventDefault(),t.stopPropagation()):c.popup[e]={opened:!0}},c.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],c.format=c.formats[0],c.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},c.remove_real_file=function(t){y.medical.images=$.grep(y.medical.images,function(e){return e.id!=t.id})},y.show_loading=!1,y.blurred=!0,y.show_temp_login=!1,c.getDecrypted=function(){y.show_loading=!0,h.GetById(d.medical_id,1,1).then(function(e){if(e.success){y.medical=e.medical,y.medical.examination_date=new Date(y.medical.examination_date),y.medical.state_of_issue=$.grep(y.authority,function(e){return e.id==y.medical.authority_id})[0];for(var t=0;t<y.medical.components.length;t++)delete y.medical.components[t].id,y.medical.components[t].id=y.medical.components[t].component_id,delete y.medical.components[t].component_id,y.medical.components[t].expiry_date=new Date(y.medical.components[t].expiry_date),y.components=$.grep(y.components,function(e){return e.id!=y.medical.components[t].id});y.blurred=!1,y.show_loading=!1}else"templogin"==e.fail&&(y.show_temp_login=!0),y.show_loading=!1})},c.re_login=function(){n.Login3(y.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(c.getDecrypted(),y.show_temp_login=!1):alert("This is the wrong password - please try again...")})},c.remove_file=function(e,t){e=JSON.parse(e.file_return);h.DeleteTmp(e.saved_url).then(function(e){e.success&&(y.medical_images=[],c.processFiles(t))})},c.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,y.medical_images.push(e[t].file)}},c.delete_medical=function(t){"YES"==prompt("Are you sure you wish to delete this medical? \n\n This change is irreversible! To confirm please type YES in the box below.")&&h.Delete(y.user.id,t).then(function(e){e.success?(y.user_medicals=$.grep(y.user_medicals,function(e){return e.id!=t}),l.reload(),l.go("dashboard.my_account.medical")):alert("Something went terribly wrong... \n\n "+e.message)})},c.save_medical=function(e){if(y.show_loading=!0,y.medical_images.length<1&&y.medical.images.length<1)return $(".drop").focus(),alert("You must at least have 1 image of your medical!"),y.show_loading=!1;if(!y.medical.state_of_issue)return $("#state_of_issue").focus(),alert("You must select a medical state of issue"),y.show_loading=!1;if(y.medical.components.length<1)return $("#components").focus(),alert("You must at least have 1 component!"),y.show_loading=!1;for(var t=0;t<y.medical.images.length;t++)delete y.medical.images[t].data_uri;y.medical.images=y.medical.images.concat(y.medical_images),y.medical.authority_id=y.medical.state_of_issue.id,y.medical.user_id=y.user.id,delete y.medical.medical_type,delete y.medical.state_of_issue,y.medical.id?h.Update(y.medical).then(function(e){e.success?l.go("dashboard.my_account.medical",{},{reload:!0}):alert("Something went terribly wrong... \n\n "+e.message),y.show_loading=!1}):h.Create(y.medical).then(function(e){e.success?(y.show_loading=!1,l.go("dashboard.my_account.medical",{},{reload:!0})):(alert("Something went terribly wrong... \n\n "+e.message),y.show_loading=!1)})}}function ManageMyMembershipsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w){var C=this;switch(C.user=s.globals.currentUser,C.user_id=C.user.id,C.noks=[],C.requests=[],C.auto_renew=!1,d.current.data.action){case"add":a.GetAll().then(function(e){C.clubs=e});break;case"edit":t.GetOneForUser(u.membership_id).then(function(e){e.success&&(C.membership_now=e.membership,C.auto_renew=1==e.membership.auto_renew,e={user_id:C.user.id,club_id:C.membership_now.club_id,membership_id:u.membership_id},o.GetMemberCards(e).then(function(e){console.log(e),C.membership_now.cards=e.cards,C.membership_now.default_card=e.default_card}))});break;case"accept":n.GetRequestsById(u.request_id).then(function(e){e.success&&(C.this_req=e.request)});break;case"list":t.GetUserMemberships(C.user.id).then(function(e){e.success&&(C.memberships=e.memberships)}),S()}function S(){n.GetRequestsByUser(C.user.id).then(function(e){e.success&&(C.requests=e.requests)})}l.popup=[],l.open=function(e,t){l.popup[e]&&1==l.popup[e].opened?(t.preventDefault(),t.stopPropagation()):l.popup[e]={opened:!0}},l.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],l.format=l.formats[0],l.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},C.show_memberships=!1,l.set_club=function(){C.show_memberships=!0,n.GetAllByClubAvailable(C.club.id).then(function(e){C.memberships=e})},l.set_default_payment_method=function(e){t.UpdateOneByUser(u.membership_id,{default_payment_method:e}).then(function(e){t.GetOneForUser(u.membership_id).then(function(e){e.success&&(C.membership_now=e.membership,C.auto_renew=1==e.membership.auto_renew,e={user_id:C.user.id,club_id:C.membership_now.club_id,membership_id:u.membership_id},o.GetMemberCards(e).then(function(e){console.log(e),C.membership_now.cards=e.cards,C.membership_now.default_card=e.default_card}))})})},l.make_default_card=function(e){confirm("Are you sure you wish to make this card the default card?")&&(e={user_id:C.user.id,club_id:C.membership_now.club_id,card_id:e.stripe_id},o.UpdateDefaultCard(e).then(function(e){console.log("DATA HERE",e),e.success&&(C.membership_now.cards=e.cards,C.membership_now.default_card=e.default_card)}))},l.delete_member_card=function(e){var t;confirm("Are you sure you wish to delete this card?")&&(t={user_id:C.user.id,club_id:C.membership_now.club_id,card_id:e.stripe_id},o.DeleteMemberCard(t).then(function(e){console.log("DATA HERE",e),e.success&&o.GetMemberCards(t).then(function(e){C.membership_now.cards=e.cards})}))},l.delete_request=function(e){n.DeleteRequest(e).then(function(e){S()})},l.set_membership=function(){C.show_confirmation=!0,o.GetByUserId(C.user.id).then(function(e){C.cards=e.cards})},l.set_card=function(){},l.accept_it=function(){if(!C.club_tnc)return alert("You need to access the terms of the flight organisation prior to continuing!"),!1;var e={club_id:C.this_req.club_id,user_id:C.user_id,request_id:C.this_req.id};n.AcceptRequest(C.this_req.id,e).then(function(e){v.put("gcl_sess",e.mandate.session),v.put("gcl_member_accepted",!0),window.location=e.mandate.link})},l.update_it=function(){var e={auto_renew:1==C.auto_renew?1:0};t.UpdateOneByUser(u.membership_id,e).then(function(e){})},l.edit_membership=function(e){d.go("dashboard.my_account.memberships.edit",{membership_id:e})};l.create_direct_debit=function(){};C.change_direct_debit=function(){var e={user_id:C.user.id,club_id:C.membership_now.club_id,membership_id:u.membership_id};k.GenerateUpdateLink(e).then(function(e){e.success?(v.put("gcl_sess",e.session),v.put("gcl_member_accepted",!0),window.location=e.link):alert("An error occurred when generating the link to update your direct debit instructions - please contact support@toaviate.com")})},C.show_add_card=!1,l.add_card=function(){console.log("ADD A CARD HERE!!");var e={club_id:C.membership_now.club_id,user_id:C.user.id};C.show_add_card=!0,o.CreateNewCustomer(e).then(function(e){console.log("DATA HERE",e);var o=Stripe("pk_test_51QttFFG8WiGSRCORyxkdZTO8oajcqz9OUsvcDJFpr9FB2PAdbzJc0tS7WNnfzKYsTiqHN1YDZi5UtXk4K52SeD4h00YWXuChNd"),e={clientSecret:e.secret,appearance:{}},i=o.elements(e);i.create("payment",{layout:"tabs"}).mount("#payment-element"),document.getElementById("payment-form").addEventListener("submit",function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.preventDefault(),e.next=3,o.confirmSetup({elements:i,confirmParams:{return_url:window.location.href}});case 3:n=e.sent,(n=n.error)&&(document.querySelector("#error-message").textContent=n.message);case 6:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}())})},C.try_charge_default_card=function(){alert("GO TIME",C.membership_now.cards[1].stripe_id);var e={invoice_id:55,card_id:C.membership_now.cards[1].stripe_id,last4:C.membership_now.cards[1].last4};o.CreatePaymentIntent(e).then(function(e){console.log("DATA IS : ",e)})},l.save_added_card=function(){C.user.id,C.membership_now.club_id,u.membership_id;C.show_add_card=!1},l.get_icon=function(e){var e=e&&e.name?e.name:e,t="";switch(!0){case-1<(e=(e=e||"other.other").split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},l.downloadClubDocument=function(e){$.param({id:e});if(!e)return alert("Sorry - it looks like this flight organisation hasn't yet uploaded their document - please contact them to upload it to ToAviate."),!1;e=e.replace(/^.*[\\\/]/,"");w.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",w.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){p.info("saveBlob method failed with the following exception:"),p.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){p.info("Download link method with simulated click failed with the following exception:"),p.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){p.info("Download link method with window.location failed with the following exception:"),p.info(e)}}}o||(p.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("This file is not available at the moment - please contact the flight organisation.")})},l.request=function(){var e;C.club_tnc&&C.card_tnc&&C.club.id&&C.membership.id?(alert("THANK YOU"),e={user_id:C.user.id,club_id:C.club.id,membership_id:C.membership.id,requested_by:"user",paid:0},n.SendRequest(e).then(function(e){e.success&&(v.put("gcl_sess",e.mandate.session),window.location=e.mandate.link)})):alert("Please fill all fields...")}}function ManageMyMembershipsDirectDebitController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k){var w=this;w.user=s.globals.currentUser,w.user_id=w.user.id,w.success=!0,"direct_debit"===d.current.data.action&&(c={mandate:c.search().redirect_flow_id,session:k.get("gcl_sess"),member_accepted:!1},k.get("gcl_member_accepted")&&(c.member_accepted=!0),v.SetupMandate(c).then(function(e){e.success?(w.club=e.club,w.success=!0):w.success=!1}))}function ManageNokController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b){var h=this;switch(h.user=r.globals.currentUser,h.user_id=h.user.id,h.noks=[],c.current.data.action){case"add":break;case"edit":b.GetById(l.nok_id).then(function(e){e.success&&(h.nok=e.nok)});break;case"list":b.GetByUserId(h.user.id).then(function(e){e.success&&(h.noks=e.noks)})}s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.delete_nok=function(e){"YES"==prompt("Are you sure you wish to delete this nok? \n\n This change is irreversible! To confirm please type YES in the box below.")&&b.Delete(h.user.id,e).then(function(e){e.success?c.go("dashboard.my_account.nok",{},{reload:!0}):alert("Something went terribly wrong... \n\n "+e.message)})},s.save_nok=function(e){h.nok.user_id=h.user.id,h.nok.id?b.Update(h.nok).then(function(e){e.success?c.go("dashboard.my_account.nok",{},{reload:!0}):alert("Something went terribly wrong... \n\n "+e.message)}):b.Create(h.nok).then(function(e){e.success?c.go("dashboard.my_account.nok",{},{reload:!0}):alert("Something went terribly wrong... \n\n "+e.message)})}}function ManagePaymentsAddController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var y=this;function v(){b.GetUserForPayment(y.user.id).then(function(e){e.success&&(y.cards=e.cards,y.customer_token=e.token,c.iframe_url=t.trustAsResourceUrl("https://hosted.sandbox.paybase.io/card?t="+y.customer_token))})}y.poid_images=[],y.poid={images:[]},y.user=a.globals.currentUser,y.user_id=y.user.id,y.customer_token="",c.iframe_url="",c.get_addresses=function(){b.GetAddresses(y.postcode).then(function(e){e.success&&(y.addresses=e.addresses)})},c.add_card=function(){createToken()},c.delete_card=function(e){"YES"==prompt("Please write YES to confirm you wish to delete the card")&&b.Delete(e,y.user.id).then(function(e){b.GetByUserId(y.user.id).then(function(e){e.success&&(y.cards=e.cards)})})};document.querySelector(".errors"),document.querySelector(".success");window.addEventListener("message",function(e){var t=e.data;switch(t.type){case"success":b.Create2(y.user.id,t.id).then(function(e){e.success&&l.go("dashboard.my_account.payment_methods",{},{reload:!0})});break;case"error":switch(t.code){case"5002":alert("Your card was declined, please verify your details or contact your card provider. Should this problem persist, please contact: info@toaviate.com");break;case"4060":alert("It appears that you are adding a card that has already been added to your account");break;default:alert("Please check your card details are correct and match your billing address.")}v()}}),v()}function ManagePaymentsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var y=this;y.poid_images=[],y.poid={images:[]},y.user=a.globals.currentUser,y.user_id=y.user.id,y.customer_token="",c.iframe_url="",y.change_address=!1,y.billing_address={flatNumber:"",houseNameNumber:"",townCity:"",region:"",postalCode:"",countryISO:""},y.change_address_for="",c.change_address=function(e){y.change_address_for=e,b.GetCardDetails(e).then(function(e){e&&(y.billing_address=e.billingAddress,y.change_address=!0)})},c.save_address=function(){b.UpdateCard(y.change_address_for,y.billing_address).then(function(e){e&&(y.billing_address={flatNumber:"",houseNameNumber:"",townCity:"",region:"",postalCode:"",countryISO:""},alert("address saved"),y.change_address=!1)})},c.decline_change=function(){y.change_address=!1},c.get_addresses=function(){},c.changePrimary=function(e){b.ChangePrimary(y.user.id,e).then(function(e){e.success&&alert("Changed primary card!")})},c.add_card=function(){createToken()},c.delete_card=function(e){"YES"==prompt("Please write YES to confirm you wish to delete the card")&&b.Delete(e,y.user.id).then(function(e){b.GetByUserId(y.user.id).then(function(e){e.success&&(y.cards=e.cards)})})},b.GetByUserId(y.user.id).then(function(e){e.success&&(y.cards=e.cards)})}function ManagePoidController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h){var y=this;switch(y.poid_images=[],y.poid={images:[]},y.user=r.globals.currentUser,y.user_id=y.user.id,c.current.data.action){case"add":break;case"edit":b.GetById(l.poid_id,1,0).then(function(e){e.success&&(y.poid=e.poid,y.poid.expiry_date=new Date(y.poid.expiry_date))});break;case"list":b.GetByUserId(y.user.id).then(function(e){e.success&&(y.user_poids=e.poids)})}s.popup=[],s.open=function(e,t){s.popup[e]&&1==s.popup[e].opened?(t.preventDefault(),t.stopPropagation()):s.popup[e]={opened:!0}},s.formats=["dd/MM/yyyy","yyyy/MM/dd","dd.MM.yyyy","shortDate"],s.format=s.formats[0],s.datePickerOptions={format:"dd/MM/yyyy",showWeeks:!1},s.remove_real_file=function(t){y.poid.images=$.grep(y.poid.images,function(e){return e.id!=t.id})},s.remove_file=function(e,t){e=JSON.parse(e.file_return);b.DeleteTmp(e.saved_url).then(function(e){e.success&&(y.poid_images=[],s.processFiles(t))})},s.processFiles=function(e){for(var t=0;t<e.length;t++){var n=JSON.parse(e[t].file_return);e[t].file.temp_path=n.saved_url,y.poid_images.push(e[t].file)}},y.show_loading=!1,y.blurred=!0,y.show_temp_login=!1,s.getDecrypted=function(){y.show_loading=!0,b.GetById(l.poid_id,1,1).then(function(e){e.success?(y.poid=e.poid,y.poid.expiry_date=new Date(y.poid.expiry_date),y.blurred=!1):"templogin"==e.fail&&(y.show_temp_login=!0),y.show_loading=!1})},s.re_login=function(){h.Login3(y.re_login_pass,function(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=n.length,i=0;i<e;i++)t+=n.charAt(Math.floor(Math.random()*o));return t}(120),function(e){e.success?(s.getDecrypted(),y.show_temp_login=!1):alert("This is the wrong password - please try again...")})},s.delete_poid=function(t){"YES"==prompt("Are you sure you wish to delete this poid? \n\n This change is irreversible! To confirm please type YES in the box below.")&&b.Delete(y.user.id,t).then(function(e){e.success?(y.user_poids=$.grep(y.user_poids,function(e){return e.id!=t}),c.reload(),c.go("dashboard.my_account.poid")):alert("Something went terribly wrong... \n\n "+e.message)})},s.save_poid=function(){if(y.show_loading=!0,y.poid_images.length<1&&y.poid.images.length<1)return $(".drop").focus(),alert("You must at least have 1 image of your poid!"),!1;if(!y.poid.expiry_date)return $("#expiry_date").focus(),alert("You must enter an expiry date for your ID"),!1;if(!y.poid.title)return $("#title").focus(),alert("You must enter an ID Type"),!1;for(var e=0;e<y.poid.images.length;e++)delete y.poid.images[e].data_uri;y.poid.images=y.poid.images.concat(y.poid_images),y.poid.user_id=y.user.id,y.poid.id?b.Update(y.poid).then(function(e){e.success?(y.show_loading=!1,alert("Saved!"),c.go("dashboard.my_account.poid",{},{reload:!0})):(alert("Something went terribly wrong... \n\n "+e.message),y.show_loading=!1)}):b.Create(y.poid).then(function(e){e.success?(y.show_loading=!1,c.go("dashboard.my_account.poid",{},{reload:!0})):(alert("Something went terribly wrong... \n\n "+e.message),y.show_loading=!1)})}}function ModalInstanceCtrl(e,t,n,o){var i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;e.warning=o,e.params=i,e.images=i.images,e.ok=function(){t.close(i)},e.cancel=function(){t.dismiss("cancel")},e.params=function(e){return e}}function MyAccountController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g){this.user=r.globals.currentUser}function MyJourneyLogsController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k,w){var C=this;function S(e,t,n){t=t.toLowerCase(),n=n.toLowerCase(),e=e.toLowerCase();return 2<e.length&&-1<t.indexOf(e)||2<e.length&&-1<n.indexOf(e)}function x(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:r});if(navigator.msSaveBlob)navigator.msSaveBlob(a,i);else{var s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;if(void 0===s)throw"Not supported";s(a,i)}o=!0}catch(e){u.info("saveBlob method failed with the following exception:"),u.info(e)}if(!o){t=window.URL||window.webkitURL||window.mozURL||window.msURL;if(t){s=document.createElement("a");if("download"in s)try{var a=new Blob([e],{type:r}),c=t.createObjectURL(a);s.setAttribute("href",c),s.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(l),o=!0}catch(e){u.info("Download link method with simulated click failed with the following exception:"),u.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=t.createObjectURL(a);window.location=c,o=!0}catch(e){u.info("Download link method with window.location failed with the following exception:"),u.info(e)}}}return o||(u.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank","")),i}C.clubs=[],C.user=r.globals.currentUser,C.user_id=C.user.id,C.looking_for=l.registration,C.looking_for&&(s.my_search2=C.looking_for),C.defect_severity,C.defect_severities=[{title:"No Fly Item - Ground the plane"},{title:"Flyable - needs to be checked at next maintenance"},{title:"Not urgent - but needs noting"},{title:"Unsure of severity"}],k.GetMyJourneyLogs(l.plane_id,0,25).then(function(e){C.logs=e.logs,C.user_totals=e.user_totals,C.aircraft=e.aircraft}),C.current_offset=0,C.loaded_per_batch=25,C.all_loaded=!1,C.load_more=function(){C.current_offset=C.current_offset+C.loaded_per_batch,k.GetMyJourneyLogs(l.plane_id,C.current_offset,C.loaded_per_batch).then(function(e){0<e.logs.length?e.logs.forEach(function(e){return C.logs.push(e)}):C.all_loaded=!0})},C.get_initial=function(e){return e.charAt(0)},C.clean_times=function(e){return"00:00:00"==e?" - ":e.substring(0,5)},C.list_pilots=function(e){var t="",n="",t="PIC: "+C.get_pic(e),n=C.get_put(e);return w.getTrustedHtml("<div>"+(t=t&&""==t?"No PIC set yet!":t)+" "+(n=n&&""!==n?"<br />PUT: "+n:n)+"</div>")},C.get_pic=function(e){var t="";return e.pic_first_name&&null!==e.pic_first_name?t=C.get_initial(e.pic_first_name)+". "+e.pic_last_name:e.instructor_first_name&&""!==e.instructor_first_name?t=C.get_initial(e.instructor_first_name)+". "+e.instructor_last_name:0==e.instructor_id&&e.first_name&&""!==e.first_name&&(t=C.get_initial(e.first_name)+". "+e.last_name),t},C.get_put=function(e){var t="";return e.put_first_name&&null!==e.put_first_name?t=C.get_initial(e.put_first_name)+". "+e.put_last_name:0<e.instructor_id&&e.first_name&&""!==e.first_name&&(t=C.get_initial(e.first_name)+". "+e.last_name),t},s.filter_detail=function(){return 0==(0<arguments.length&&void 0!==arguments[0]?arguments[0]:0)?{status:"open"}:{}},s.get_icon=function(e){var e=e.name,t="";switch(!0){case-1<(e=e.split(".").pop()).indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},C.get_icon2=function(e){var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t},s.search=function(e){return-1!==angular.lowercase(e.title).indexOf(angular.lowercase(s.my_search)||"")},s.search2=function(e){return!s.my_search2||""==s.my_search2||(!!function(e,t){if(!(e.length<2)){if(e&&e.length<=3)return-1<t.indexOf(e);var n="",o=moment(e);o.isValid()&&"2001"!=o.format("YYYY")?n=o.format("YYYY-MM-DD"):o.isValid()&&(n=o.format("MM-DD"));var i;if(""!==n&&-1<t.indexOf(n))return 1;if(e.length<=5&&4<=e.length){if((i=moment(e,"DDMM")).isValid()){var r=i.format("MM-DD");if(-1<t.indexOf(r))return 1}}else if(8==e.length||10==e.length)if((i=moment(e,"DDMMYYYY")).isValid()){r=i.format("YYYY-MM-DD");if(-1<t.indexOf(r))return 1}}}(s.my_search2,e.flight_date)||(t=e.first_name,n=e.last_name,o=s.my_search2,i=o.toLowerCase(),n=(n=t+" "+n).toLowerCase(),2<o.length&&-1<n.indexOf(i)||(o=e.aircraft.registration,n=s.my_search2,i=n.toLowerCase().replace("-",""),o=(o=o.replace("-","")).toLowerCase(),2<n.length&&-1<o.indexOf(i)||(!!S(s.my_search2,e.departure_airport,e.departure_airport_code)||!!S(s.my_search2,e.destination_airport,e.destination_airport_code)))));var t,n,o,i},s.getMySearchCount=function(e){for(var t=e.documents,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.getMySearchCount2=function(e){for(var t=e.charges,n=0,o=0;o<t.length;o++)s.search(t[o])&&n++;return n},s.get_hours_from_decimal=function(e){if(e){var t=e<0?"-":"",n=Math.floor(Math.abs(e)),e=Math.round(60*Math.abs(e)%60);return 60==e&&(n++,e=0),t+(n<10?"0":"")+n+":"+(e<10?"0":"")+e}return"N/A"},s.downloadDocument=function(e,t){$.param({id:e});var n="plane_documents";switch(t){case"radio":n="plane_radio_licence";break;case"insurance":n="plane_insurance";break;case"certificate":n="plane_certificate";break;case"noise":case"docs":default:n="plane_documents"}e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/"+n+"/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){x(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");v.get("api/v1/club_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){x(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.get_icon2=function(e){if(!e||""==e)return"";var e=e.split(".").pop(),t="";switch(!0){case-1<e.indexOf("pdf"):t="pdf.png";break;case-1<e.indexOf("doc"):case-1<e.indexOf("docx"):t="doc.png";break;case-1<e.indexOf("xls"):case-1<e.indexOf("xlsx"):t="xls.png";break;case-1<e.indexOf("ppt"):case-1<e.indexOf("pptx"):t="ppt.png";break;case-1<e.indexOf("jpg"):case-1<e.indexOf("jpeg"):t="jpg.png";break;case-1<e.indexOf("png"):t="png.png";break;case-1<e.indexOf("gif"):t="gif.png";break;case-1<e.indexOf("zip"):t="zip.png";break;case-1<e.indexOf("avi"):t="avi.png";break;case-1<e.indexOf("mp4"):t="mp4.png";break;default:t="file.png"}return"images/file_icons/"+t}}function NewChargeModalInstanceCtrl(o,t,e,n,i,r,a,s){var c=8<arguments.length&&void 0!==arguments[8]?arguments[8]:null;function l(){for(var e=0,t=0,n=0;n<o.items.length;n++)o.items[n].total=o.items[n].quantity*o.items[n].price,0<o.items[n].vat&&(this_vat=o.items[n].total*(o.items[n].vat/100),t+=this_vat),e+=o.items[n].total;o.the_vat=t,o.the_total=e}o.warning=n,o.params=c,o.to_refund=0,o.reason="",o.club_id=a.globals.currentUser.current_club_admin.id,o.club_settings={},o.new_client={first_name:"",last_name:"",email:""},o.items=[],o.item={title:"",quantity:0,vat:0,price:0},o.selected_client,o.selected_card,o.members=[],o.show_direct_debit_details=!1,r.GetById(o.club_id).then(function(e){o.club_settings=e,o.item.vat=o.club_settings.vat_rate,o.club_settings.vat_registered=1==o.club_settings.vat_registered}),i.GetAllByClub(o.club_id).then(function(e){o.members=e,o.members.unshift({id:-12,first_name:"New",last_name:"Client"})}),o.delete_receipt=function(e){o.items.splice(e,1),l()},o.card_selected=function(e){-12==(o.selected_card=e).id&&setTimeout(function(){p()},1e3)},o.member_selected=function(e){(o.selected_client=e)&&e.account_ending&&""!==e.account_ending?o.show_direct_debit_details=!0:(o.show_direct_debit_details=!1,setTimeout(function(){p()},1e3)),e&&-12==e.id&&setTimeout(function(){p()},1e3)},o.add_item=function(e){o.item=e,o.items.push(o.item),o.item={quantity:0,price:0,vat:o.club_settings.vat_rate,title:""},l()},o.ok=function(){var e;-12==o.selected_client.id?(o.selected_client.first_name=o.new_client.first_name,o.selected_client.last_name=o.new_client.last_name,o.selected_client.email=o.new_client.email):(o.selected_client.first_name=o.selected_client.first_name,o.selected_client.last_name=o.selected_client.last_name,o.selected_client.email=o.selected_client.email),-12!=o.selected_client.id&&o.show_direct_debit_details?(e={payment:{},items:o.items,user:o.selected_client,club_id:o.club_id},""!==o.selected_client.account_ending&&(e.payment.direct_debit=!0),s.CreateCustom(e).then(function(e){e.success&&t.close(e)})):d.createToken(u,{}).then(function(e){e.error?document.getElementById("card-errors").textContent=e.error.message:e.token.id&&(e={payment:{brand:e.token.card.brand,last4:e.token.card.last4,hash:e.token.card.id,token:e.token.id,funding:e.token.card.funding,name:e.token.card.name,client_ip:e.token.client_ip},items:o.items,user:o.selected_client,club_id:o.club_id},s.CreateCustom(e).then(function(e){e.success&&t.close(e)}))})},o.cancel=function(){t.dismiss("cancel")},o.params=function(e){return e};var d=Stripe("pk_test_Ers4ZfdIMZ59ac4wKy6FDAH2"),u=d.elements().create("card",{hidePostalCode:!0,style:{base:{iconColor:"#666EE8",color:"#31325F",lineHeight:"40px",fontWeight:300,fontFamily:"Helvetica Neue",fontSize:"15px","::placeholder":{color:"#CFD7E0"}}}}),_=!1;function p(){clearTimeout(void 0),0==_&&(_=!0,u.mount("#card-element"),form=document.getElementById("payment-form"),form.addEventListener("submit",function(e){e.preventDefault(),createToken()}))}}function PassengerSignupCompleteController(a,e,t,s,c,l){s.checked_identity=!1,s.is_already_user=!1,s.submit_button="SUBMIT INFORMATION",s.formData={},s.formData.password&&""!==s.formData.password&&s.formData.password==s.formData.password2&&(s.submit_button="SUBMIT INFORMATION & CREATE YOUR ACCOUNT"),l.token?s.checked_identity||"/check"===c.current.url||c.go("passenger_signup_complete.check"):c.go("login"),s.gotologin=function(){c.go("login")},s.formcode=[],s.checkedcode=0,s.goToNextInput=function(e,t){var n=document.getElementById("index"+(t-1)).value;if(1!=t||91!=e.keyCode&&17!=e.keyCode||6!=n.toString().length){if(37==e.keyCode&&0<t)return document.getElementById("index"+(t-2)).focus(),!1;if(39==e.keyCode&&t<6)return document.getElementById("index"+t).focus(),!1;if(8==e.keyCode&&1<t&&""==document.getElementById("index"+(t-1)).value)return document.getElementById("index"+(t-2)).focus(),!1}else{for(var o=Array.from(n.toString()),i=0;i<6;i++)s.formcode.push(parseInt(o[i]));document.getElementById("index5").focus(),t=6}if(6==t&&6==s.formcode.length){var r=s.formcode.join("");return(s.checkedcode++,4<s.checkedcode)?(alert("Sorry - you have tried too many times, this code is now invalid and a new invitation will be sent to you."),!1):(a.GetPaxSecureInvite2(l.token,r).then(function(e){return e.success?e.invitation.is_already_user?(s.formData.user_id=e.invitation.user_id,s.formData.token=l.token,s.checked_identity=!0,void c.go("passenger_signup_complete.your_profile")):(alert("We couldn't match your invitation with our records - if you think you have an account, please go to the login screen and click the forgotten password link."),!1):(alert(e.message),!1)}),!1)}r=document.getElementById("index"+(t-1)).value;if(!(-1<r&&r<10&&""!==r))return document.getElementById("index"+(t-1)).value="",document.getElementById("index"+(t-1)).focus(),!1;document.getElementById("index"+t).focus()},s.submit_user_for_signup=function(){if(s.formData.password!==s.formData.password2||s.formData.password.length<8)return alert("Please ensure your password is at least 8 character and both of these match"),!1;var e={user_id:s.formData.user_id,token:s.formData.token,password:s.formData.password};a.SignupUserFromPassenger(l.token,e).then(function(e){return e.success?(s.formData={},s.checked_identity=!1,void c.go("passenger_signup_complete.thank_you")):(alert(e.message),!1)})}}function PassengerSignupController(a,e,t,s,c,l,n){s.checked_identity=!1,s.is_already_user=!1,s.submit_button="SUBMIT INFORMATION",s.formData={},s.formData.password&&""!==s.formData.password&&s.formData.password==s.formData.password2&&(s.submit_button="SUBMIT INFORMATION & CREATE YOUR ACCOUNT"),l.token?s.checked_identity||"/check"===c.current.url||c.go("passenger_signup.check"):c.go("login");function o(e){return e=Date.now()-e.getTime(),e=new Date(e),Math.abs(e.getUTCFullYear()-1970)}s.guardian=!1,s.validate_age=function(){var e;i()&&(e=o(s.formData.dob),s.guardian=e<18)},s.next_of_kin=function(){if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),!1;c.go("passenger_signup.next_of_kin")};var i=function(){return!0};s.check_nok=function(){if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),!1;c.go("passenger_signup.tnc")},s.checkValid=function(e){return e=e||$(".btn-info").attr("one-ui-sref"),!!i()&&(s.formData.password!=s.formData.password2?($("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1):void c.go(e))},s.submit_passenger=function(){if(!(s.formData.first_name&&s.formData.last_name&&s.formData.email&&s.formData.dob))return alert("Please complete your personal details"),c.go("passenger_signup.your_profile"),!1;if(o(s.formData.dob)<18){if(!(s.formData.guardian&&s.formData.guardian.first_name&&s.formData.guardian.last_name&&s.formData.guardian.dob&&s.formData.guardian.guardianship))return alert("As you are under the age of 18, your guardian needs to complete their details."),c.go("passenger_signup.your_profile"),!1;if(o(s.formData.guardian.dob)<18)return alert("Your guardian needs to be over the age of 18 to legally enable you to go flying."),c.go("passenger_signup.your_profile"),!1}if(!(s.formData.nok&&s.formData.nok.first_name&&s.formData.nok.last_name&&s.formData.nok.email_address&&s.formData.nok.relationship&&s.formData.nok.phone_number&&s.formData.nok.address))return alert("Your next of kin information needs to be complete - in case of an emergency, or an accident, we must be able to contact them."),c.go("passenger_signup.next_of_kin"),!1;if(!s.formData.tnc||!s.formData.club_tnc)return alert("Please tick to confirm that you have read, understood and agreed to the terms and conditions of both the software and the flight organisation."),!1;new Date(s.formData.dob);s.formData.guardian&&(s.formData.guardian.dob=s.formData.guardian.dob.format("yyyy-MM-dd"));var e={user_id:s.formData.user_id,first_name:s.formData.first_name,last_name:s.formData.last_name,email:s.formData.email,dob:s.formData.dob.format("yyyy-MM-dd"),club_id:s.formData.club_id,club_tnc:s.formData.club_tnc,tnc:s.formData.tnc,nok:s.formData.nok,guardian:s.formData.guardian,booking_id:s.formData.booking_id,token:s.formData.token,membership_id:0,invited_by:s.formData.invited_by};a.ConfirmPaxInvite(l.token,e).then(function(e){return e.success?(s.formData={},void(s.checked_identity=!1)):(alert(e.message),!1)}),c.go("passenger_signup.thank_you")},s.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");n.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",n.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){$log.info("saveBlob method failed with the following exception:"),$log.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){$log.info("Download link method with simulated click failed with the following exception:"),$log.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){$log.info("Download link method with window.location failed with the following exception:"),$log.info(e)}}}o||($log.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})},s.formcode=[],s.checkedcode=0,s.goToNextInput=function(e,t){var n=document.getElementById("index"+(t-1)).value;if(1!=t||91!=e.keyCode&&17!=e.keyCode||6!=n.toString().length){if(37==e.keyCode&&0<t)return document.getElementById("index"+(t-2)).focus(),!1;if(39==e.keyCode&&t<6)return document.getElementById("index"+t).focus(),!1;if(8==e.keyCode&&1<t&&""==document.getElementById("index"+(t-1)).value)return document.getElementById("index"+(t-2)).focus(),!1}else{for(var o=Array.from(n.toString()),i=0;i<6;i++)s.formcode.push(parseInt(o[i]));document.getElementById("index5").focus(),t=6}if(6==t&&6==s.formcode.length){var r=s.formcode.join("");return(s.checkedcode++,4<s.checkedcode)?(alert("Sorry - you have tried too many times, this code is now invalid and a new invitation will be sent to you."),!1):(a.GetPaxSecureInvite(l.token,r).then(function(e){return e.success?(e.invitation.is_already_user?(s.is_already_user=!0,s.formData.user_id=e.invitation.user_id,s.formData.first_name=e.invitation.user.first_name,s.formData.last_name=e.invitation.user.last_name,s.formData.email=e.invitation.user.email,s.formData.dob=new Date(e.invitation.user.dob),s.formData.club=e.invitation.club,s.formData.guardian=e.invitation.user.guardian,s.formData.nok=e.invitation.user.nok,s.formData.membership_id=e.invitation.membership_id,s.formData.club_id=e.invitation.club_id,s.formData.token=e.invitation.invitation_token,s.formData.status=e.invitation.status,s.formData.invited_by=e.invitation.invited_by,s.formData.booking_id=e.invitation.booking_id,e.invitation.user.guardian&&""!==e.invitation.user.guardian.first_name&&(s.guardian=!0)):(s.formData.first_name=e.invitation.first_name,s.formData.last_name=e.invitation.last_name,s.formData.email=e.invitation.email,s.formData.membership_id=e.invitation.membership_id,s.formData.club_id=e.invitation.club_id,s.formData.token=e.invitation.invitation_token,s.formData.status=e.invitation.status,s.formData.invited_by=e.invitation.invited_by,s.formData.booking_id=e.invitation.booking_id,s.formData.club=e.invitation.club),s.checked_identity=!0,void c.go("passenger_signup.your_profile")):(alert(e.message),!1)}),!1)}r=document.getElementById("index"+(t-1)).value;if(!(-1<r&&r<10&&""!==r))return document.getElementById("index"+(t-1)).value="",document.getElementById("index"+(t-1)).focus(),!1;document.getElementById("index"+t).focus()}}function PasswordResetController(e,t,n,o,i,r,a,s,c,l,d,u,_,p){var m=this;m.show_error=!1,m.show_error2=!1,m.show_thankyou=!1,o.password_reset=function(){/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(m.email)?p.ResetPassword(m.email,function(e){m.show_thankyou=!0,m.show_error=!1}):m.show_error=!0},o.go_login=function(){n.path("/login")},o.password_reset2=function(){if(""==m.password)return!(m.show_error=!0);if(m.password.length<8)return!(m.show_error2=!0);var e=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!e.test(m.password))return m.show_error=!0,alert("Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1;p.ResetPassword2(m.password,r.token,function(e){m.show_thankyou=!0,m.show_error=!1,m.show_error2=!1,m.thank_you=e.message})}}function RefundModalInstanceCtrl(t,n,e,o){var i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;t.warning=o,t.params=i,t.to_refund=0,t.reason="",t.remaining=i.amount-i.amount_refunded,t.ok=function(){var e=i;e.reason=t.reason,e.to_refund=t.to_refund,n.close(e)},t.cancel=function(){n.dismiss("cancel")},t.params=function(e){return e}}function RegisterController(e,t,n,o,i){var r=this;r.verify_status="",r.register=function(){r.dataLoading=!0,e.Create(r.user).then(function(e){e.success?(o.Success("Registration successful",!0),t.path("/registration_success")):(o.Error(e.error),r.dataLoading=!1)})},i.token&&i.userId&&e.Verify(i.userId,i.token).then(function(e){e.success?(r.title="Thank You!",r.verify_status="Your email address has been verified."):(r.title="Sorry!",r.verify_status="Sorry - something went wrong here! Please try clicking the link your email again. Should this still be a problem, please contact support.")})}function ReviewBookingsController(e,t,i,n,o,r,a,s){var c=this;o.globals.currentUser||s.CheckLoggedIn().then(function(e){}),c.user=o.globals.currentUser,c.bookings=[],c.allUsers=[],c.clubs=[];var l=new Date,s=Math.floor(8),o=Math.floor(18);new Date(l.getFullYear(),l.getMonth(),l.getDate(),s,0,0),new Date(l.getFullYear(),l.getMonth(),l.getDate(),o,0,0);function d(){i.GetBookingsToReview(c.user.id).then(function(e){c.bookings=e.bookings})}function u(e){var n=jQuery.extend({},e);n.plane_id=e.resourceId,""!==e.instructor_id?(n.instructor_id=e.instructor_id,e.tuition_required&&(n.tuition_id=e.tuition_required.id)):n.instructor_id="0",delete n._start,delete n._end,delete n._id,delete n.source,delete n._allDay,delete n.allDay,delete n.className,delete n.plane,delete n.title,delete n.editable,delete n.resourceIds,n.update_rental_items=!0,i.updateBooking(n,c.user.id).then(function(e){var t;return 1==e.success?(1==n.edit_booking&&r.$parent.updateEvents(n.start,n.end),alert("Your changes were saved successfully")):(t=[],!0!==e.instructor?t.push({type:"instructor",message:"It looks like your instructor is not available on the updated date and time",api:e.instructor,override:"instructor_override"}):!0!==e.check_user?t.push({type:"check_user",message:"It looks like your user account does not allow this booking to happen",api:e.check_user,override:"currency_override"}):!0!==e.rental_items&&t.push({type:"rental_items",message:"It looks like some of the rental items are not available",api:e.rental_items,override:"update_rental_items"}),alert("ERROR FOUND IN ALTERING THE BOOKING"),c.booking_errors=t,c.error_event=n),e})}c.default_date=new Date,d(),r.all_events=[],r.all_resources=[],r.approve_booking=function(e){i.AcceptBooking(e,c.user.id).then(function(e){d()})},r.decline_booking=function(e){i.DeclineBooking(e,c.user.id,{}).then(function(e){d()})},r.view_booking=function(n,e){i.GetAllInstructor(c.user.id,e,"").then(function(e){$("#calendar").fullCalendar("gotoDate",c.default_date);var t=parseInt($("a.fc-timeline-event.booking"+n).css("left"))+parseInt($("a.fc-timeline-event.booking"+n).width())/2-$("tbody .fc-time-area .fc-scroller").width()/2;return $("tbody .fc-time-area .fc-scroller").animate({scrollLeft:t},600),r.all_events=e.events,r.all_resources=e.resources,$("a.fc-timeline-event.booking"+n).removeClass("highlight_item"),setTimeout(function(){$("a.fc-timeline-event.booking"+n).addClass("highlight_item")},200),e})},r.updateEvents=function(e,t){i.GetAllInstructor(c.user.id,e,t).then(function(e){return r.all_events=e.events,r.all_resources=e.resources,e})},r.eventRender=function(e,t,n){t.attr({tooltip:e.title,"tooltip-append-to-body":!0}),$compile(t)(r)},r.alertOnClicked=function(e,t,n){c.see_booking=e,c.see_booking.start_date=moment(c.see_booking.start).format("DD/MM/YYYY"),c.see_booking.end_date=moment(c.see_booking.end).format("DD/MM/YYYY"),c.see_booking.start_time=moment(c.see_booking.start).format("HH:mm"),c.see_booking.end_time=moment(c.see_booking.end).format("HH:mm"),c.see_booking.start_datetime=new Date(new Date(c.see_booking.start).toUTCString()),c.see_booking.end_datetime=new Date(c.see_booking.end),c.see_booking.visible=1,c.see_booking.can_be_edited=moment().isAfter(moment(c.see_booking.end)),r.$apply()},r.changeLang=function(){r.uiConfig.calendar.dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],r.uiConfig.calendar.dayNamesShort=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},r.changed=function(){$log.log("Time changed to: "+r.mytime),r.check_plane_availability()},r.check_plane_availability=function(){generate_datetimes();var o=1==c.new_booking.edit_booking?1:0,e=0<c.new_booking.plane_id?c.new_booking.plane_id:0;c.new_booking.plane&&c.new_booking.plane.id&&(e=c.new_booking.plane.id),console.log("START REVIEWBOOKINGS",new Date(c.new_booking.start_datetime).toIsoString()),i.GetAllPlanes(c.user.id,c.new_booking.start_datetime,c.new_booking.end_datetime,0,e).then(function(e){if(c.planes=e,1==o)for(var t=0;t<c.planes.length;t++)c.planes[t].id==c.new_booking.plane.id&&(n=0,c.new_booking.plane=c.planes[t],r.check_rental_items());else{var n=1;if(c.new_booking.plane){for(t=0;t<c.planes.length;t++)c.planes[t].id==c.new_booking.plane.id&&(n=0,r.check_rental_items());1==n&&(c.new_booking.plane={},delete c.new_booking.plane)}}})},r.events=[],r.addOne=function(){$state.go("dashboard.bookings.add")},r.cancel_changes=function(){},r.check_rental_items=function(){var e;generate_datetimes(),c.rental_items=[],c.new_booking.plane&&(e=(1==c.new_booking.edit_booking?c.new_booking:c.new_booking.plane).club_id,i.GetRentalItems(e,moment(c.new_booking.start_datetime).format("Y-M-D HH:mm"),moment(c.new_booking.end_datetime).format("Y-M-D HH:mm"),0).then(function(e){if(c.rental_items=e,c.new_booking.rental_items)for(var t=0;t<c.new_booking.rental_items;t++){for(var n=0,o=0;o<c.rental_items.length;o++)if(c.rental_items[o].id==c.new_booking.rental_items[t].id){parseInt(c.new_booking.rental_items[t].number_to_book)>parseInt(c.rental_items[o].number_available)&&(c.new_booking.rental_items[t].number_to_book=parseInt(c.rental_items[o].number_available)),c.new_booking.rental_items[t].number_available=parseInt(c.rental_items[o].number_available),n=1;break}0==n&&delete c.new_booking.rental_items[t]}for(var i=0;i<c.rental_items.length;i++)c.rental_items[i].number=0;if(c.new_booking.rental_items)for(o=0;o<c.new_booking.rental_items;o++){for(var r=1,t=0;t<c.rental_items.length;t++)c.rental_items[t].id==c.new_booking.rental_items[o].id&&(r=0);1==r&&delete c.new_booking.rental_items[o]}}))},r.update_booking=function(e){generate_datetimes(),e&&(e={},delete(e=jQuery.extend(!0,{},c.new_booking)).options,delete e.instructor,delete e.plane,delete e.start_date,delete e.start_time,delete e.end_date,delete e.end_time,delete e.start_datetime,delete e.end_datetime,delete e.tuition_required,e.free_seats=c.new_booking.free_seats.constructor===Array?0:c.new_booking.free_seats,e.start=c.new_booking.start_datetime,e.end=c.new_booking.end_datetime,e.tuition_id=c.new_booking.tuition_required.id,e.user_id=c.user.id,e.instructor_id=c.new_booking.instructor?c.new_booking.instructor.id:0,e.plane_id=c.new_booking.plane.id,e.override=c.new_booking.override||0,e.club_id=c.new_booking.plane.club_id,u(e))},r.update_club=function(){c.club_id=c.change_club.id,i.GetAllUserClub(c.user.id,c.club_id,moment().format("Y-M-D"),"").then(function(e){r.all_events=e.events,r.all_resources=e.resources})},r.alertOnEventClick=function(e,t,n){r.alertMessage=e.title+" was clicked "},r.alertOnDrop=function(e,t,n,o,i,r){u(e)},r.alertOnResize=function(e,t,n,o,i,r){u(e)},r.override_booking_change=function(e){c.error_event[e]=!0,u(c.error_event)},r.decline_booking_change=function(){c.booking_errors={},c.error_event={},$("#calendar").fullCalendar("removeEvents"),$("#calendar").fullCalendar("addEventSource",all_events)},r.wholeDay=function(){1==r.whole_day_booking?(r.whole_day_booking=!1,r.myDatetimeRange.time.from=480,r.myDatetimeRange.time.to=1080):(r.whole_day_booking=!0,r.myDatetimeRange.time.from=0,r.myDatetimeRange.time.to=1440)},r.changeView=function(e,t){uiCalendarConfig.calendars[t].fullCalendar("changeView",e)},r.renderCalender=function(e){$timeout(function(){uiCalendarConfig.calendars[e]&&uiCalendarConfig.calendars[e].fullCalendar("render")})}}function ShowGalleryController(e,t,n,o,i,r,a,s,c,l,d,u){var _=this;_.gallery={is_protected:"false",download_low:"false",download_medium:"false",download_high:"false",gallery_link:"",fullscreen:"false"},_.current={image:{link:"",description:"hi"},artpiece:{title:"",description:""},index:0},u.GetByUrl({gallery_link:c.gallery_link}).then(function(e){0<(_.gallery=e).images.length?("true"==e.is_disabled&&r.path("/disabled"),_.current.image.link=_.gallery.images[0].link,_.current.image.description=_.gallery.images[0].description,_.current.artpiece.title=_.gallery.images[0].artpiece.title,_.current.artpiece.description=_.gallery.images[0].artpiece.description,_.current.index=0):r.path("/disabled")}),l.login=function(){if(_.password_protected!=_.gallery.password)return!1;_.gallery.is_protected="false"};function p(e){_.current.image.link=_.gallery.images[e].link,_.current.image.description=_.gallery.images[e].description,_.current.artpiece.title=_.gallery.images[e].artpiece.title,_.current.artpiece.description=_.gallery.images[e].artpiece.description,_.current.index=e}l.change_image=function(e){p(e)},l.show_fullscreen=function(){$("#fullscreen").fadeIn(),$("p.viewport").hide()},l.hide_fullscreen=function(){$("#fullscreen").fadeOut(),$("p.viewport").show()},l.fullscreen_next=function(){var e=_.current.index+1;e>_.gallery.images.length-1&&(e=0),p(e)},l.fullscreen_previous=function(){var e=_.current.index-1;e<0&&(e=_.gallery.images.length-1),p(e)},l.download=function(e){u.DownloadZip({gallery_id:_.gallery.id,quality:e}).then(function(e){var t=document.createElement("a");t.download=e.zip_url,t.href=e.zip_url,t.click()})},l.remove_image=function(t){_.images=$.grep(_.images,function(e){return e.id!=t.id}),d.SetSelectedImages(_.images)},l.check_link_unique=function(){for(var e=0;e<_.all_galleries.length;e++)if(_.all_galleries[e].link===_.gallery.link)return!1},l.generate_gallery=function(){for(var e=0;e<_.images.length;e++)_.images[e].organise=e;_.gallery.images=_.images,u.Create(_.gallery).then(function(e){})}}function UpdateMyMembershipDirectDebitController(e,t,n,o,i,r,a,s,c,l,d,u,_,p,m,f,g,b,h,y,v,k){var w=this;w.user=s.globals.currentUser,w.user_id=w.user.id,w.success=!0,w.return_id=u.membership_id,"direct_debit2"===d.current.data.action&&(u={mandate:c.search().redirect_flow_id,session:k.get("gcl_sess"),membership_id:u.membership_id},k.get("gcl_member_accepted")&&(u.member_accepted=!0),v.UpdateMandate(u).then(function(e){e.error?w.success=!1:(w.success=!0,d.go("dashboard.my_account.memberships.edit",{membership_id:w.return_id},{reload:!0}))}))}function UploadController(e,t,r,a,n,s){var c=this;a.tags=[],e.GetAll().then(function(e){c.all_keywords=e}),t.GetAll().then(function(e){c.artpieces=e}),a.loadTags=function(t){for(var e=$.grep(c.all_keywords,function(e){if(e.keyword.toLowerCase().startsWith(t.toLowerCase()))return!0}),n=[],o=0;o<e.length;o++){var i=(i=e[o].keyword).toLowerCase();n.push({id:e[o].id,text:i})}return n},a.CheckData=function(e){for(var t=[],n=e,o=0;o<n.length;o++){var i=n[o].file_return,i=JSON.parse(i);t.push(i.files.file.tmp_name)}e={images:t,keywords:a.tags,artpiece_id:c.artme};r.Create(e).then(function(e){s.path("/")})}}function UsersController(t,n,e,o,i){var r=this;r.update=function(e){"password"==r.user.password&&(r.user.password="");t.Update(r.user).then(function(e){e.success?(o.Success("Update successful",!0),n.path("/")):(console.log("response"),console.log(e),"Password entered failed"==e.message?alert("The password entered was incorrect"):o.Error(e.error),r.dataLoading=!1)})},r.dataLoading=!1,r.default_pwd="password",t.GetById(i.userId).then(function(e){r.user=e.user})}function UserSignupController(e,t,n,o,i,r,a){r.params.verify&&e.Verify(r.params.user_id,r.params.verify).then(function(e){e.success?r.go("verified"):(alert(e.message),r.go("login"))}),i.clubs={clubs:[{id:1,title:"Alouette Flying Club"},{id:2,title:"EFG Flying Club"},{id:3,title:"Surrey & Kent Flying Club"},{id:4,title:"Arrow Flight Club"},{id:5,title:"Cirrus Flying Club"}]},i.memberships={memberships:[{id:1,title:"honory membership"},{id:2,title:"day membership"},{id:3,title:"social membership"},{id:4,title:"full flying membership"},{id:5,title:"temporary flying membership"}]},i.state={state:[{id:2,title:"France"},{id:3,title:"Netherlands"},{id:4,title:"Germany"},{id:5,title:"Spain"}]},i.licenses={licenses:[{id:1,title:"EASA PPL"},{id:2,title:"EASA CPL"},{id:3,title:"EASA ATPL"},{id:4,title:"UK NPPL"},{id:5,title:"FAA SPL"}]},i.medicals={medicals:[{id:1,title:"EASA MEDICAL"},{id:2,title:"UK MEDICAL EXAMINATION"},{id:3,title:"FAA MEDICAL"},{id:4,title:"NZ CAA MEDICAL"},{id:5,title:"FAA SPL MEDICAL"}]},i.person={},i.person.selectedSingle="Samantha",i.person.selectedSingleKey="5",i.people=[{name:"Adam",email:"adam@email.com",age:12,country:"United States"},{name:"Amalie",email:"amalie@email.com",age:12,country:"Argentina"},{name:"Estefana",email:"estefania@email.com",age:21,country:"Argentina"},{name:"Adrian",email:"adrian@email.com",age:21,country:"Ecuador"},{name:"Wladimir",email:"wladimir@email.com",age:30,country:"Ecuador"},{name:"Samantha",email:"samantha@email.com",age:30,country:"United States"},{name:"Nicole",email:"nicole@email.com",age:43,country:"Colombia"},{name:"Natasha",email:"natasha@email.com",age:54,country:"Ecuador"},{name:"Michael",email:"michael@email.com",age:15,country:"Colombia"},{name:"Nicols",email:"nicolas@email.com",age:43,country:"Colombia"}],i.ratings={ratings:[{id:1,title:"SEP (land)"},{id:2,title:"SEP (sea)"},{id:3,title:"MEP (land)"},{id:4,title:"MEP (sea)"},{id:1,title:"Night Rating"},{id:2,title:"Instrument Rating Restricted IR(r)"},{id:3,title:"Instrument Rating"},{id:4,title:"Aerobatics Rating"},{id:5,title:"High Performance Aircraft Rating"}]},i.differences={differences:[{id:1,title:"Variable Pitch"},{id:2,title:"Retractable Gear"},{id:3,title:"Turbo Differences Training"},{id:4,title:"EFIS Differences Training"}]},i.formData={license:{differences:[],ratings:[i.ratings.ratings[0]],add_to:{}},medical:{}},i.add_element=function(t){i[t][t]=$.grep(i[t][t],function(e){return e.id!=i.formData.license.add_to[t].id}),"differences"==t&&(i.formData.license.add_to[t].day=!0,i.formData.license.add_to[t].vfr=!0),i.formData.license[t].push(i.formData.license.add_to[t]),delete i.formData.license.add_to[t]},i.remove_element=function(e,t){i[e][e].push(i.formData.license[e][t]),i.formData.license[e].splice(t,1),i.formData.license[e]=i.formData.license[e].filter(Boolean)},i.checkValid=function(e){if(e&&""!=e||(e=$(".btn-info").attr("one-ui-sref")),i.formData.user.password!==i.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),alert("Your passwords do not match"),!1;var t=new RegExp("(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[^A-Za-z0-9])(?=.{8,})");if(!t.test(i.formData.user.password))return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),alert("Your password must be at least 8 characters in length, contain 1 uppercase, 1 lowercase, 1 number, and 1 special character"),!1;if(!$("#signup-form")[0].checkValidity())return $(".ng-pristine").not(".ng-valid").removeClass("ng-pristine").addClass("ng-invalid"),$("input:checkbox:not(:checked):required").addClass("ng-checkbox-unchecked"),!1;if(!i.formData.user)return r.go("user_signup.your_details"),!1;if(!i.formData.user.nok)return r.go("user_signup.next_of_kin"),!1;if(!i.formData.club)return r.go("user_signup.your_club"),!1;if(i.formData.tnc?$("input:checkbox:not(:checked)").removeClass("ng-checkbox-unchecked"):$("input:checkbox:not(:checked)").addClass("ng-checkbox-unchecked"),i.formData.user.password!=i.formData.user.password2)return $("input[type='password']").removeClass("ng-pristine").addClass("ng-invalid"),!1;"verify_account"==e?i.processForm():r.go(e)},i.processForm=function(){i.formData.$valid&&alert("our form is valid")},i.downloadClubDocument=function(e){$.param({id:e});e=e.replace(/^.*[\\\/]/,"");t.defaults.headers.common["Api-Key"]="eW91a25vd25vdGhpbmdqb25zbm93",t.get("api/v1/term_documents/show_file/"+e,{responseType:"arraybuffer"}).success(function(e,t,n){!function(e,t){var n="application/octet-stream",o=!1,i=(t=t())["x-filename"]||"download.zip",r=t["content-type"]||n;try{var a=new Blob([e],{type:"application/pdf"});!function(e,t){var n=window.open();n.document.write("<html><head><title>"+t+'</title></head><body><embed width="100%" height="100%" name="plugin" src="'+e+'" type="application/pdf" internalinstanceid="21"></body></html>'),n.document.close()}(URL.createObjectURL(a),"Secure Documents"),o=!0}catch(e){$log.info("saveBlob method failed with the following exception:"),$log.info(e)}if(!o){var s=window.URL||window.webkitURL||window.mozURL||window.msURL;if(s){t=document.createElement("a");if("download"in t)try{var a=new Blob([e],{type:r}),c=s.createObjectURL(a);t.setAttribute("href",c),t.setAttribute("download",i);var l=document.createEvent("MouseEvents");l.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),t.dispatchEvent(l),o=!0}catch(e){$log.info("Download link method with simulated click failed with the following exception:"),$log.info(e)}if(!o)try{a=new Blob([e],{type:n}),c=s.createObjectURL(a);window.location=c,o=!0}catch(e){$log.info("Download link method with window.location failed with the following exception:"),$log.info(e)}}}o||($log.info("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}(e,n)}).error(function(e,t){alert("There was an error downloading the selected document(s).")})}}UserSignupController.$inject=["UserService","$http","$rootScope","$location","$scope","$state","$stateParams"],UsersController.$inject=["UserService","$location","$rootScope","FlashService","$routeParams"],UploadController.$inject=["KeywordsService","ArtpiecesService","ImageUploadService","$scope","$http","$location"],UpdateMyMembershipDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],ShowGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],ReviewBookingsController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$scope","$location","AuthenticationService"],RegisterController.$inject=["UserService","$location","$rootScope","FlashService","$stateParams"],RefundModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning"],PasswordResetController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService"],PassengerSignupController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$http"],PassengerSignupCompleteController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams"],NewChargeModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","MemberService","ClubService","$rootScope","PaymentService"],MyJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce"],MyAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService"],ModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning"],ManagePoidController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","PoidService","AuthenticationService"],ManagePaymentsController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],ManagePaymentsAddController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],ManageNokController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService"],ManageMyMembershipsDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],ManageMyMembershipsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies","GoCardService","$http"],ManageMedicalController.$inject=["UserService","MemberService","AuthenticationService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","MedicalService"],ManageLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","AuthenticationService"],ManageDifferencesController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","DifferencesService"],ManageAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","PaymentService"],LoginController.$inject=["$location","AuthenticationService","FlashService"],KeywordsController.$inject=["UserService","KeywordsService","$location","$rootScope","FlashService","$routeParams","$scope"],KeywordController.$inject=["KeywordsService","UserService","JSTagsCollection","$scope"],InvitationsSignupController.$inject=["UserService","MemberService","GoCardService","$http","$rootScope","$location","$scope","$state","$stateParams","$cookies","$log"],ImagesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService"],HomeController.$inject=["UserService","$rootScope","$location"],GalleriesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],FinishAndPayController.$inject=["$sce","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService"],DashboardUserInstructorHolidayController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig"],DashboardUserInstructorController.$inject=["UserService","MemberService","InstructorService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window"],DashboardStudentRecordsController.$inject=["ClubService","UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService","MemberService","$sce"],DashboardInstructorBriefController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService"],DashboardCourseSyllabusViewController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],DashboardCourseSyllabusController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],DashboardController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$location","AuthenticationService"],DashboardClubVouchersEditController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService"],DashboardClubVouchersController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService"],DashboardClubVouchersAddController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService"],DashboardClubShopSaleController.$inject=["$timeout","$sce","ExperiencesService","PaymentService","$scope","$rootScope","MemberService","ClubService","ShopItemService","$state","PackageService"],DashboardClubShopItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ShopItemService"],DashboardClubSettingsController.$inject=["UserService","ClubService","PaymentService","$rootScope","$location","$scope","$state","$stateParams","$window","$http","$log"],DashboardClubReceiptsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce"],DashboardClubReceiptsApprovalController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce"],DashboardClubPropellerLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http"],DashboardClubPlanesController.$inject=["UserService","PlaneService","FoxService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService"],DashboardClubPaymentsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ClubPaymentService"],DashboardClubPackagesController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PackageService","PlaneService"],DashboardClubMembershipsController.$inject=["UserService","MembershipService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window"],DashboardClubMembersController.$inject=["$sce","PaymentService","UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PackageService"],DashboardClubMemberRequestsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies"],DashboardClubMaintenanceController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","FoxService","$http"],DashboardClubLessonController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],DashboardClubItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService"],DashboardClubInvoicesController.$inject=["$sce","PaymentService","UserService","ClubService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],DashboardClubInstructorChargesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorCharges"],DashboardClubInstructorBookings.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorService"],DashboardClubFlyingController.$inject=["UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PaymentService","PackageService","BookoutService"],DashboardClubFlightsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService"],DashboardClubExperiencesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService"],DashboardClubExperienceDiscountsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService"],DashboardClubEngineLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http"],DashboardClubCourseController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],DashboardClubAirframeLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http"],CreateGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],ClubSignupController.$inject=["ClubService","MemberService","UserService","GoCardService","$rootScope","$location","$scope","$state","$stateParams","$cookies","$http"],ClubPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],ClubDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","$http"],ClaimAFlightController.$inject=["UserService","FoxService","$rootScope","$scope","$stateParams","$location"],CategoriesController.$inject=["UserService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope"],BookoutController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","InstructorCharges","PlaneService","$http","$cookieStore","AuthenticationService","CourseService"],BookingsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService"],Bookings2Controller.$inject=["UserService","BookoutService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService"],BookinController.$inject=["$sce","UserService","MemberService","FoxService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService","PackageService","CourseService","$anchorScroll","smoothScroll"],ArtpiecesController.$inject=["UserService","CategoryService","ArtpiecesService","$location","$rootScope","FlashService","$routeParams","$scope"],AllPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],AllInvoicesController.$inject=["$sce","PaymentService","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],AllDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],AircraftStatusController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService"],AircraftJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce"],AddLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService"],AccountController.$inject=["UserService","$rootScope","$location"],app.controller("AccountController",AccountController),AccountController.$inject=["UserService","$rootScope","$location"],app.controller("AddLicenceController",AddLicenceController),AddLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService"],app.controller("AircraftJourneyLogsController",AircraftJourneyLogsController),AircraftJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce"],app.controller("AircraftStatusController",AircraftStatusController),AircraftStatusController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService"],app.controller("AllDocumentsController",AllDocumentsController),AllDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],app.controller("AllInvoicesController",AllInvoicesController),AllInvoicesController.$inject=["$sce","PaymentService","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],app.controller("AllPaymentsController",AllPaymentsController),AllPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],app.controller("ArtpiecesController",ArtpiecesController),ArtpiecesController.$inject=["UserService","CategoryService","ArtpiecesService","$location","$rootScope","FlashService","$routeParams","$scope"],app.controller("BookinController",BookinController),BookinController.$inject=["$sce","UserService","MemberService","FoxService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService","PackageService","CourseService","$anchorScroll","smoothScroll"],app.controller("Bookings2Controller",Bookings2Controller),Bookings2Controller.$inject=["UserService","BookoutService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService"],app.controller("BookingsController",BookingsController),BookingsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","InstructorCharges","CourseService"],app.controller("BookoutController",BookoutController),BookoutController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","InstructorCharges","PlaneService","$http","$cookieStore","AuthenticationService","CourseService"],app.controller("CategoriesController",CategoriesController),CategoriesController.$inject=["UserService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope"],app.controller("ClaimAFlightController",ClaimAFlightController),ClaimAFlightController.$inject=["UserService","FoxService","$rootScope","$scope","$stateParams","$location"],app.controller("ClubDocumentsController",ClubDocumentsController),ClubDocumentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","$http"],app.controller("ClubPaymentsController",ClubPaymentsController),ClubPaymentsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],app.controller("ClubSignupController",ClubSignupController),ClubSignupController.$inject=["ClubService","MemberService","UserService","GoCardService","$rootScope","$location","$scope","$state","$stateParams","$cookies","$http"],app.controller("CreateGalleryController",CreateGalleryController),CreateGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],app.controller("DashboardClubAirframeLogbookController",DashboardClubAirframeLogbookController),DashboardClubAirframeLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http"],app.controller("DashboardClubCourseController",DashboardClubCourseController),DashboardClubCourseController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],app.controller("DashboardClubEngineLogbookController",DashboardClubEngineLogbookController),DashboardClubEngineLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http"],app.controller("DashboardClubExperienceDiscountsController",DashboardClubExperienceDiscountsController),DashboardClubExperienceDiscountsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService"],app.controller("DashboardClubExperiencesController",DashboardClubExperiencesController),DashboardClubExperiencesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService"],app.controller("DashboardClubFlightsController",DashboardClubFlightsController),DashboardClubFlightsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService"],app.controller("DashboardClubFlyingController",DashboardClubFlyingController),DashboardClubFlyingController.$inject=["UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PaymentService","PackageService","BookoutService"],app.controller("DashboardClubInstructorBookings",DashboardClubInstructorBookings),DashboardClubInstructorBookings.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorService"],app.controller("DashboardClubInstructorChargesController",DashboardClubInstructorChargesController),DashboardClubInstructorChargesController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","InstructorCharges"],app.controller("DashboardClubInvoicesController",DashboardClubInvoicesController),DashboardClubInvoicesController.$inject=["$sce","PaymentService","UserService","ClubService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http"],app.controller("DashboardClubItemsController",DashboardClubItemsController),DashboardClubItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService"],app.controller("DashboardClubLessonController",DashboardClubLessonController),DashboardClubLessonController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],app.controller("DashboardClubMaintenanceController",DashboardClubMaintenanceController),DashboardClubMaintenanceController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","FoxService","$http"],app.controller("DashboardClubMemberRequestsController",DashboardClubMemberRequestsController),DashboardClubMemberRequestsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies"],app.controller("DashboardClubMembersController",DashboardClubMembersController),DashboardClubMembersController.$inject=["$sce","PaymentService","UserService","MemberService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService","$http","PackageService"],app.controller("DashboardClubMembershipsController",DashboardClubMembershipsController),DashboardClubMembershipsController.$inject=["UserService","MembershipService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window"],app.controller("DashboardClubPackagesController",DashboardClubPackagesController),DashboardClubPackagesController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PackageService","PlaneService"],app.controller("DashboardClubPaymentsController",DashboardClubPaymentsController),DashboardClubPaymentsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","ClubPaymentService"],app.controller("DashboardClubPlanesController",DashboardClubPlanesController),DashboardClubPlanesController.$inject=["UserService","PlaneService","FoxService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService"],app.controller("DashboardClubPropellerLogbookController",DashboardClubPropellerLogbookController),DashboardClubPropellerLogbookController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","PlaneDocumentService","$http"],app.controller("DashboardClubReceiptsApprovalController",DashboardClubReceiptsApprovalController),DashboardClubReceiptsApprovalController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce"],app.controller("DashboardClubReceiptsController",DashboardClubReceiptsController),DashboardClubReceiptsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ItemService","$sce"],app.controller("DashboardClubSettingsController",DashboardClubSettingsController),DashboardClubSettingsController.$inject=["UserService","ClubService","PaymentService","$rootScope","$location","$scope","$state","$stateParams","$window","$http","$log"],app.controller("DashboardClubShopItemsController",DashboardClubShopItemsController),DashboardClubShopItemsController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ShopItemService"],app.controller("DashboardClubShopSaleController",DashboardClubShopSaleController),DashboardClubShopSaleController.$inject=["$timeout","$sce","ExperiencesService","PaymentService","$scope","$rootScope","MemberService","ClubService","ShopItemService","$state","PackageService"],app.controller("DashboardClubVouchersAddController",DashboardClubVouchersAddController),DashboardClubVouchersAddController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService"],app.controller("DashboardClubVouchersController",DashboardClubVouchersController),DashboardClubVouchersController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService"],app.controller("DashboardClubVouchersEditController",DashboardClubVouchersEditController),DashboardClubVouchersEditController.$inject=["UserService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","LicenceService","MedicalService","DifferencesService","ExperiencesService","VoucherService"],app.filter("asDate",function(){return function(e){return e&&""!==e?moment(e).toDate():""}}),app.controller("DashboardController",DashboardController),DashboardController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$location","AuthenticationService"],app.controller("DashboardCourseSyllabusController",DashboardCourseSyllabusController),DashboardCourseSyllabusController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],app.controller("DashboardCourseSyllabusViewController",DashboardCourseSyllabusViewController),DashboardCourseSyllabusViewController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService"],app.controller("DashboardInstructorBriefController",DashboardInstructorBriefController),DashboardInstructorBriefController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService"],app.controller("DashboardStudentRecordsController",DashboardStudentRecordsController),DashboardStudentRecordsController.$inject=["ClubService","UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","CourseService","BookingService","MemberService","$sce"],app.controller("DashboardUserInstructorController",DashboardUserInstructorController),DashboardUserInstructorController.$inject=["UserService","MemberService","InstructorService","MembershipService","PlaneService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window"],app.controller("DashboardUserInstructorHolidayController",DashboardUserInstructorHolidayController),DashboardUserInstructorHolidayController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig"],app.controller("FinishAndPayController",FinishAndPayController),FinishAndPayController.$inject=["$sce","UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$interval","$timeout","uiCalendarConfig","BookingService","LicenceService","BookoutService","$filter","PlaneService","InstructorCharges","PaymentService","InvoicesService"],app.controller("GalleriesController",GalleriesController),GalleriesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],app.controller("HomeController",HomeController),HomeController.$inject=["UserService","$rootScope","$location"],app.controller("ImagesController",ImagesController),ImagesController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService"],app.controller("InvitationsSignupController",InvitationsSignupController),InvitationsSignupController.$inject=["UserService","MemberService","GoCardService","$http","$rootScope","$location","$scope","$state","$stateParams","$cookies","$log"],app.controller("KeywordController",KeywordController),KeywordController.$inject=["KeywordsService","UserService","JSTagsCollection","$scope"],app.controller("KeywordsController",KeywordsController),KeywordsController.$inject=["UserService","KeywordsService","$location","$rootScope","FlashService","$routeParams","$scope"],app.controller("LoginController",LoginController),LoginController.$inject=["$location","AuthenticationService","FlashService"],app.controller("ManageAccountController",ManageAccountController),ManageAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","PaymentService"],app.controller("ManageDifferencesController",ManageDifferencesController),ManageDifferencesController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","DifferencesService"],app.controller("ManageLicenceController",ManageLicenceController),ManageLicenceController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","AuthenticationService"],app.controller("ManageMedicalController",ManageMedicalController),ManageMedicalController.$inject=["UserService","MemberService","AuthenticationService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","MedicalService"],app.controller("ManageMyMembershipsController",ManageMyMembershipsController),ManageMyMembershipsController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","$cookies","GoCardService","$http"],app.controller("ManageMyMembershipsDirectDebitController",ManageMyMembershipsDirectDebitController),ManageMyMembershipsDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],app.controller("ManageNokController",ManageNokController),ManageNokController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService"],app.controller("ManagePaymentsAddController",ManagePaymentsAddController),ManagePaymentsAddController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],app.controller("ManagePaymentsController",ManagePaymentsController),ManagePaymentsController.$inject=["UserService","$sce","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","PaymentService","PoidService"],app.controller("ManagePoidController",ManagePoidController),ManagePoidController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","PoidService","AuthenticationService"],app.controller("ModalInstanceCtrl",ModalInstanceCtrl),ModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","params"],app.controller("MyAccountController",MyAccountController),MyAccountController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService"],app.controller("MyJourneyLogsController",MyJourneyLogsController),MyJourneyLogsController.$inject=["UserService","MemberService","InstructorService","MembershipService","HolidayService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","BookingService","LicenceService","ClubDocumentService","PlaneDocumentService","$http","PlaneService","$sce"],app.controller("NewChargeModalInstanceCtrl",NewChargeModalInstanceCtrl),NewChargeModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","MemberService","ClubService","$rootScope","PaymentService","params"],app.controller("PassengerSignupCompleteController",PassengerSignupCompleteController),PassengerSignupCompleteController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams"],app.controller("PassengerSignupController",PassengerSignupController),PassengerSignupController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$http"],app.controller("PasswordResetController",PasswordResetController),PasswordResetController.$inject=["UserService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","PoidService","LicenceService","MedicalService","DifferencesService","AuthenticationService"],app.controller("RefundModalInstanceCtrl",RefundModalInstanceCtrl),RefundModalInstanceCtrl.$inject=["$scope","$uibModalInstance","id","warning","params"],app.controller("RegisterController",RegisterController),RegisterController.$inject=["UserService","$location","$rootScope","FlashService","$stateParams"],app.controller("ReviewBookingsController",ReviewBookingsController),ReviewBookingsController.$inject=["UserService","$cookieStore","BookingService","BookoutService","$rootScope","$scope","$location","AuthenticationService"],app.controller("ShowGalleryController",ShowGalleryController),ShowGalleryController.$inject=["UserService","ArtpiecesService","ImagesService","KeywordsService","CategoryService","$location","$rootScope","FlashService","$routeParams","$scope","LocalDataService","GalleryService"],app.controller("UpdateMyMembershipDirectDebitController",UpdateMyMembershipDirectDebitController),UpdateMyMembershipDirectDebitController.$inject=["UserService","MemberService","MembershipService","PaymentService","InstructorService","HolidayService","ClubService","$rootScope","$location","$scope","$state","$stateParams","$uibModal","$log","$window","$compile","$timeout","uiCalendarConfig","LicenceService","NokService","GoCardService","$cookies"],app.controller("UploadController",UploadController),UploadController.$inject=["KeywordsService","ArtpiecesService","ImageUploadService","$scope","$http","$location"],app.controller("UsersController",UsersController),UsersController.$inject=["UserService","$location","$rootScope","FlashService","$routeParams"],app.controller("UserSignupController",UserSignupController),UserSignupController.$inject=["UserService","$http","$rootScope","$location","$scope","$state","$stateParams"];